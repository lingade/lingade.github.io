

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
  <title>android开机后都发生了什么? - Cola&#39;S Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.11","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Cola'S Blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="android开机后都发生了什么?">
              
                android开机后都发生了什么?
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-08-23 00:32" pubdate>
        2021年8月23日 凌晨
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      29.1k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      438
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">android开机后都发生了什么?</h1>
            
            <div class="markdown-body">
              <h2 id="1-启动流程"><a href="#1-启动流程" class="headerlink" title="1. 启动流程"></a>1. 启动流程</h2><p>Android系统启动过程往细了说可以分为5步：</p>
<p>Loader –&gt; Kernel –&gt; Native –&gt; Framework –&gt; Application</p>
 <img src="/2021/08/23/android%E5%BC%80%E6%9C%BA%E5%90%8E%E9%83%BD%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/images/android%E6%9E%B6%E6%9E%84.png" srcset="/img/loading.gif" lazyload class="">



<h3 id="1-1-Loader"><a href="#1-1-Loader" class="headerlink" title="1.1 Loader"></a>1.1 Loader</h3><ul>
<li><p>Boot ROM: 当手机处于关机状态时，长按Power键开机，引导芯片开始从固化在ROM里的预设出代码开始执行，然后加载引导程序到RAM</p>
</li>
<li><p>Boot Loader: 这是启动Android系统之前的引导程序，主要是检查RAM，初始化硬件参数等功能</p>
</li>
</ul>
<h3 id="1-2-Kernel"><a href="#1-2-Kernel" class="headerlink" title="1.2 Kernel"></a>1.2 Kernel</h3><p>Kernel层是指Android内核层，到这里才刚刚开始进入Android系统</p>
<ul>
<li><p>启动Kernel的swapper进程(pid=0)：该进程又称为idle进程, 系统初始化过程Kernel由无到有开创的第一个进程, 用于初始化进程管理、内存管理，加载Display,Camera Driver，Binder Driver等相关工作</p>
</li>
<li><p>启动kthreadd进程（pid=2）：是Linux系统的内核进程，会创建内核工作线程kworkder，软中断线程ksoftirqd，thermal等内核守护进程。kthreadd进程是所有内核进程的鼻祖</p>
</li>
</ul>
<h3 id="1-3-Native"><a href="#1-3-Native" class="headerlink" title="1.3 Native"></a>1.3 Native</h3><p>这里的Native层主要包括init孵化来的用户空间的守护进程、HAL层以及开机动画等。启动init进程(pid=1),是Linux系统的用户进程，init进程是所有用户进程的鼻祖</p>
<ul>
<li>init进程会孵化出ueventd、logd、healthd、installd、adbd、lmkd等用户守护进程</li>
<li>init进程还启动servicemanager(binder服务管家)、bootanim(开机动画)等重要服务</li>
<li>init进程孵化出Zygote进程，Zygote进程是Android系统的第一个Java进程(即虚拟机进程)，Zygote是所有Java进程的父进程</li>
</ul>
<h3 id="1-4-Framework"><a href="#1-4-Framework" class="headerlink" title="1.4 Framework"></a>1.4 Framework</h3><ul>
<li>Zygote进程启动后，加载ZygoteInit类，注册Zygote Socket服务端套接字；加载虚拟机；加载类，加载系统资源</li>
<li>System Server进程，是由Zygote进程fork而来，System Server是Zygote孵化的第一个进程，System Server负责启动和管理整个Java framework，包含ActivityManager，PowerManager等服务</li>
<li>Media Server进程，是由init进程fork而来，负责启动和管理整个C++ framework，包含AudioFlinger，Camera Service等服务</li>
</ul>
<h3 id="1-5-Application"><a href="#1-5-Application" class="headerlink" title="1.5 Application"></a>1.5 Application</h3><ul>
<li>Zygote进程孵化出的第一个App进程是Launcher，即手机桌面APP，没错，手机桌面就是跟我们平时使用的APP一样，它也是一个应用</li>
<li>所有APP进程都是由zygote进程fork出来的</li>
</ul>
<p>这些层之间，有的并不能直接交流，比如Native与Kernel之间要经过系统调用才能访问，Java层和Native层需要通过JNI进行调用</p>
<p>严格来说，Android系统实际上是运行于Linux内核上的一系列服务进程，这些进程是维持设备正常运行的关键，而这些进程的老祖宗就是init进程</p>
<h2 id="2-启动流程-以Zygote启动流程为例"><a href="#2-启动流程-以Zygote启动流程为例" class="headerlink" title="2. 启动流程(以Zygote启动流程为例)"></a>2. 启动流程(以Zygote启动流程为例)</h2><p>当内核启动完成后，就会创建用户空间的第一个进程，即init进程；后面所有的进程，比如Binder机制中的ServiceManager，Zygote都是由init进程孵化出来的</p>
<h3 id="对比老版本差异"><a href="#对比老版本差异" class="headerlink" title="对比老版本差异"></a>对比老版本差异</h3><p>在Android Q中，对该机制做了一些改变 </p>
<p>单一的init.rc，被拆分，服务根据其二进制文件的位置（/system，/vendor，/odm）定义到对应分区的etc/init目录中，每个服务一个rc文件。与该服务相关的触发器、操作等也定义在同一rc文件中。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/system/</span>etc/init，包含系统核心服务的定义，如SurfaceFlinger、MediaServer、Logcatd等。<br><span class="hljs-regexp">/vendor/</span>etc/init， SOC厂商针对SOC核心功能定义的一些服务。比如高通、MTK某一款SOC的相关的服务。<br><span class="hljs-regexp">/odm/</span>etc<span class="hljs-regexp">/init，OEM/</span>ODM厂商如小米、华为、OPP其产品所使用的外设以及差异化功能相关的服务。<br></code></pre></td></tr></table></figure>

<p>下图为Android Q 中定义的所有服务</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><code class="hljs gradle">.<span class="hljs-regexp">/recovery/</span>root/init.rc<br>.<span class="hljs-regexp">/recovery/</span>root/ueventd.rc<br>.<span class="hljs-regexp">/recovery/</span>root/init.recovery.mt6762.rc<br>.<span class="hljs-regexp">/recovery/</span>root/init.recovery.mt6765.rc<br>.<span class="hljs-regexp">/vendor/u</span>eventd.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.wmt_drv.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.volte_imsm_93.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/m</span>tk_agpsd_p.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>bootperf.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>audiocmdservice_atci.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.graphics.composer@<span class="hljs-number">2.1</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>vendor.mediatek.hardware.gpu@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.volte_stack.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit_connectivity.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.fmradio_drv.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>netdagent.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>atcid_eng.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.vtservice_hidl.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/m</span>tkrild.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.health@<span class="hljs-number">2.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.wfca.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/m</span>odemdbfilter_service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.bt_drv.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.gps_drv.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>aee_aedv64.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.secure_element@<span class="hljs-number">1.0</span>-service-mediatek.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.drm@<span class="hljs-number">1.2</span>-service.clearkey.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>vendor.mediatek.hardware.log@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.thermal_manager.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.bip.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.cccimdinit.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/m</span>d_monitor.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/mu</span>xreport.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.drm@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.wlan_drv.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.drm@<span class="hljs-number">1.2</span>-service.widevine.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>wlan_assistant.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>camerahalserver.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>atci_service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.cas@<span class="hljs-number">1.1</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>psec_mon.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.thermal@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.gatekeeper@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.keymaster@<span class="hljs-number">4.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.thermalloadalgod.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.graphics.allocator@<span class="hljs-number">2.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>vendor.mediatek.hardware.mtkpower@<span class="hljs-number">1.0</span>-init.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>lbs_hidl_service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.sensors@<span class="hljs-number">2.0</span>-service-mediatek.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hostapd.android.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.thermal.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>fuelgauged_nvram_init.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>em_hidl_eng.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>vendor.mediatek.hardware.mtkpower@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.cccirpcd.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.volte_md_status.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.light@<span class="hljs-number">2.0</span>-service-mediatek.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>aee_aedv.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.cccifsd.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/g</span>sm0710muxd.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>loghidlvendorservice.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>fuelgauged_init.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.wifi@<span class="hljs-number">1.0</span>-service-lazy-mediatek.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.bluetooth@<span class="hljs-number">1.0</span>-service-mediatek.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>ppl_agent.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/init.<span class="hljs-keyword">project</span>.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/init.sensor_1_0.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/init.mt6765.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/meta_init.connectivity.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/meta_init.<span class="hljs-keyword">project</span>.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/multi_init.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/factory_init.<span class="hljs-keyword">project</span>.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/factory_init.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/init.mt6762.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/init.mt6765.usb.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/factory_init.connectivity.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/init.connectivity.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/init.aee.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/init.modem.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/init.ago.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/meta_init.modem.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>hw/meta_init.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.md_apps.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.media.omx@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.volte_ua.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>nvram_daemon.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.wod.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>vendor.mediatek.hardware.nvram@<span class="hljs-number">1.1</span>-sevice.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.memtrack@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.configstore@<span class="hljs-number">1.1</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.usb@<span class="hljs-number">1.1</span>-service-mediatek.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>vendor.mediatek.hardware.mtkcodecservice@<span class="hljs-number">1.1</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/i</span>nit.volte_imcb.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.audio@<span class="hljs-number">5.0</span>-service-mediatek.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.vibrator@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>vendor.mediatek.hardware.mms@<span class="hljs-number">1.3</span>-service.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>vndservicemanager.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>android.hardware.gnss@<span class="hljs-number">2.0</span>-service-mediatek.rc<br>.<span class="hljs-regexp">/vendor/</span>etc<span class="hljs-regexp">/init/</span>vendor.mediatek.hardware.pq@<span class="hljs-number">2.2</span>-service.rc<br>.<span class="hljs-regexp">/system/</span>apex<span class="hljs-regexp">/com.android.media.swcodec/</span>etc/init.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/m</span>dlogger.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>atrace.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/m</span>ediaextractor.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>surfaceflinger.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>ashmemd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>android.system.suspend@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/u</span>ncrypt.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>camerapostalgo.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>bootlogoupdater.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>art_apex_boot_integrity.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/u</span>sbd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/m</span>odemdbfilter_client.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>atci_service_sys.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>drmserver.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>recovery-persist.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>aee_aed64.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>keystore.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>wait_for_keymaster.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/m</span>obile_log_d.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/m</span>ediaserver.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>hwservicemanager.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/i</span>nit-debug.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/g</span>puservice.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>logd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/i</span>ncidentd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>servicemanager.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>lpdumpd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/i</span>dmap2d.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>bootstat.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>blank_screen.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>bootstat-debug.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>storaged.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>netd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/m</span>ediametrics.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/m</span>ediadrmserver.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>wificond.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>vdc.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>cameraserver.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/g</span>sid.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>consyslogger.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>logtagd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/m</span>alloc_debug_option.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>bootanim.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>logcatd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>batterywarning.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>statsd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>perfetto.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/i</span>nit.connectivity.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>flags_health_check.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/m</span>tpd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/i</span>nit.thermald.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/m</span>dnsd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>duraspeed.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>emdlogger3.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>audioserver.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>terserver.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>heapprofd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>netdiag.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>bpfloader.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/i</span>nit.vtservice.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>hw/init.aee.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>hw/vendor_init_as_system.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>emdlogger5.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/i</span>orapd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>wifi-events.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>tombstoned.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>kpoc_charger.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>apexd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>traceur.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>android.hidl.allocator@<span class="hljs-number">1.0</span>-service.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/g</span>atekeeperd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>atrace_userdebug.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>lmkd.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>rss_hwm_reset.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/i</span>nstalld.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>racoon.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>emdlogger2.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>emdlogger1.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>em_svr.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>dumpstate.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>aee_aed.rc<br>.<span class="hljs-regexp">/system/</span>etc<span class="hljs-regexp">/init/</span>vold.rc<br>.<span class="hljs-regexp">/root/i</span>nit.rc<br>.<span class="hljs-regexp">/root/i</span>nit.zygote32.rc<br>.<span class="hljs-regexp">/root/i</span>nit.environ.rc<br>.<span class="hljs-regexp">/root/u</span>eventd.rc<br>.<span class="hljs-regexp">/root/i</span>nit.zygote64_32.rc<br>.<span class="hljs-regexp">/root/i</span>nit.preload.rc<br>.<span class="hljs-regexp">/root/i</span>nit.usb.configfs.rc<br>.<span class="hljs-regexp">/root/i</span>nit.usb.rc<br></code></pre></td></tr></table></figure>


<h3 id="2-1-启动"><a href="#2-1-启动" class="headerlink" title="2.1 启动"></a>2.1 启动</h3><p>当init进程启动后会调用/system/core/init/main.cpp的main()方法</p>
 <figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"> <span class="hljs-built_in">int</span> main(<span class="hljs-built_in">int</span> argc, <span class="hljs-built_in">char</span>** argv) &#123;<br>#<span class="hljs-keyword">if</span> <span class="hljs-constructor">__has_feature(<span class="hljs-params">address_sanitizer</span>)</span><br>    <span class="hljs-constructor">__asan_set_error_report_callback(AsanReportCallback)</span>;<br>#endif<br><br>    <span class="hljs-keyword">if</span> (!strcmp(basename(argv<span class="hljs-literal">[<span class="hljs-number">0</span>]</span>), <span class="hljs-string">&quot;ueventd&quot;</span>)) &#123;<br>        return ueventd<span class="hljs-constructor">_main(<span class="hljs-params">argc</span>, <span class="hljs-params">argv</span>)</span>;   <span class="hljs-comment">//ueventd.cpp入口函数，初始化uevent</span><br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (argc &gt; <span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-keyword">if</span> (!strcmp(argv<span class="hljs-literal">[<span class="hljs-number">1</span>]</span>, <span class="hljs-string">&quot;subcontext&quot;</span>)) &#123;<br>            android::base::<span class="hljs-constructor">InitLogging(<span class="hljs-params">argv</span>, &amp;<span class="hljs-params">android</span>::<span class="hljs-params">base</span>::KernelLogger)</span>;<br>            const BuiltinFunctionMap function_map;<br><br>            return <span class="hljs-constructor">SubcontextMain(<span class="hljs-params">argc</span>, <span class="hljs-params">argv</span>, &amp;<span class="hljs-params">function_map</span>)</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!strcmp(argv<span class="hljs-literal">[<span class="hljs-number">1</span>]</span>, <span class="hljs-string">&quot;selinux_setup&quot;</span>)) &#123;<br>            <span class="hljs-comment">// This function initializes SELinux then execs init to run in the init SELinux context.</span><br>            return <span class="hljs-constructor">SetupSelinux(<span class="hljs-params">argv</span>)</span>; <span class="hljs-comment">//对SELinux进行初始化，并通过execs的系统调用开启init进程</span><br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (!strcmp(argv<span class="hljs-literal">[<span class="hljs-number">1</span>]</span>, <span class="hljs-string">&quot;second_stage&quot;</span>)) &#123;<br>            return <span class="hljs-constructor">SecondStageMain(<span class="hljs-params">argc</span>, <span class="hljs-params">argv</span>)</span>;  <span class="hljs-comment">//第二阶段 init.cpp入口函数</span><br>        &#125;<br>    &#125;<br><br>    return <span class="hljs-constructor">FirstStageMain(<span class="hljs-params">argc</span>, <span class="hljs-params">argv</span>)</span>;   <span class="hljs-comment">//第一阶段</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>注:<strong>Android10中并不只是调用init::main，而是把部分流程性的判断放到的mian.cpp中来做，如果直接去找init.cpp中的main函数，其实是找不到入口的</strong></p>
<h3 id="2-2-一阶段启动"><a href="#2-2-一阶段启动" class="headerlink" title="2.2 一阶段启动"></a>2.2 一阶段启动</h3><p>第一阶段init位于 system/core/init/first_stage_init.cpp的FirstStageMain方法,主要是设置umask，部分代码如下</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-built_in">int</span> <span class="hljs-constructor">FirstStageMain(<span class="hljs-params">int</span> <span class="hljs-params">argc</span>, <span class="hljs-params">char</span><span class="hljs-operator">**</span> <span class="hljs-params">argv</span>)</span> &#123;<br>    <span class="hljs-keyword">if</span> (REBOOT_BOOTLOADER_ON_PANIC) &#123;<br>        <span class="hljs-constructor">InstallRebootSignalHandlers()</span>;<br>    &#125;<br><br>    boot_clock::time_point start_time = boot_clock::now<span class="hljs-literal">()</span>;<br><br>    std::vector&lt;std::pair&lt;std::<span class="hljs-built_in">string</span>, <span class="hljs-built_in">int</span>&gt;&gt; errors;<br>#define <span class="hljs-constructor">CHECKCALL(<span class="hljs-params">x</span>)</span> \<br>    <span class="hljs-keyword">if</span> (x != <span class="hljs-number">0</span>) errors.emplace<span class="hljs-constructor">_back(#<span class="hljs-params">x</span> <span class="hljs-string">&quot; failed&quot;</span>, <span class="hljs-params">errno</span>)</span>;<br><br>    <span class="hljs-comment">// Clear the umask.</span><br>    umask(<span class="hljs-number">0</span>);<br><br>    <span class="hljs-constructor">CHECKCALL(<span class="hljs-params">clearenv</span>()</span>);<br>    <span class="hljs-constructor">CHECKCALL(<span class="hljs-params">setenv</span>(<span class="hljs-string">&quot;PATH&quot;</span>, <span class="hljs-params">_PATH_DEFPATH</span>, 1)</span>);<br>    <span class="hljs-comment">// Get the basic filesystem setup we need put together in the initramdisk</span><br>    <span class="hljs-comment">// on / and then we&#x27;ll let the rc file figure out the rest.</span><br>    <span class="hljs-constructor">CHECKCALL(<span class="hljs-params">mount</span>(<span class="hljs-string">&quot;tmpfs&quot;</span>, <span class="hljs-string">&quot;/dev&quot;</span>, <span class="hljs-string">&quot;tmpfs&quot;</span>, MS_NOSUID, <span class="hljs-string">&quot;mode=0755&quot;</span>)</span>);<br>    <span class="hljs-constructor">CHECKCALL(<span class="hljs-params">mkdir</span>(<span class="hljs-string">&quot;/dev/pts&quot;</span>, 0755)</span>);<br>    <span class="hljs-constructor">CHECKCALL(<span class="hljs-params">mkdir</span>(<span class="hljs-string">&quot;/dev/socket&quot;</span>, 0755)</span>);<br>    <span class="hljs-constructor">CHECKCALL(<span class="hljs-params">mount</span>(<span class="hljs-string">&quot;devpts&quot;</span>, <span class="hljs-string">&quot;/dev/pts&quot;</span>, <span class="hljs-string">&quot;devpts&quot;</span>, 0, NULL)</span>);<br>    <br> ....<br><br>    return <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-3-二阶段启动"><a href="#2-3-二阶段启动" class="headerlink" title="2.3 二阶段启动"></a>2.3 二阶段启动</h3><p>第二阶段init位于system/core/init/init.cpp的SecondStageMain方法,该部分负责加载.rc文件,部分代码如下</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">SecondStageMain</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span>** argv)</span> </span>&#123;<br>    <span class="hljs-comment">/* </span><br><span class="hljs-comment">    *init crash时重启引导加载程序</span><br><span class="hljs-comment">    *这个函数主要作用将各种信号量，如SIGABRT,SIGBUS等的行为设置为SA_RESTART,一旦监听到这些信号即执行重启系统</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">if</span> (REBOOT_BOOTLOADER_ON_PANIC) &#123;<br>        <span class="hljs-built_in">InstallRebootSignalHandlers</span>();<br>    &#125;<br> <br>    <span class="hljs-comment">//把标准输入、标准输出和标准错误重定向到空设备文件&quot;/dev/null&quot;</span><br>    <span class="hljs-built_in">SetStdioToDevNull</span>(argv);<br>    <span class="hljs-comment">//在/dev目录下挂载好 tmpfs 以及 kmsg </span><br>    <span class="hljs-comment">//这样就可以初始化 /kernel Log 系统，供用户打印log</span><br>    <span class="hljs-built_in">InitKernelLogging</span>(argv);<br>    <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">&quot;init second stage started!&quot;</span>;<br> <br>    <span class="hljs-comment">// 01. 创建进程会话密钥并初始化属性系统</span><br>    <span class="hljs-built_in">keyctl_get_keyring_ID</span>(KEY_SPEC_SESSION_KEYRING, <span class="hljs-number">1</span>);<br> <br>    <span class="hljs-comment">//创建 /dev/.booting 文件，就是个标记，表示booting进行中</span><br>    <span class="hljs-built_in">close</span>(<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/dev/.booting&quot;</span>, O_WRONLY | O_CREAT | O_CLOEXEC, <span class="hljs-number">0000</span>));<br> <br>    <span class="hljs-comment">// 初始化属性系统，并从指定文件读取属性</span><br>    <span class="hljs-built_in">property_init</span>();<br> <br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 1.如果参数同时从命令行和DT传过来，DT的优先级总是大于命令行的</span><br><span class="hljs-comment">     * 2.DT即device-tree，中文意思是设备树，这里面记录自己的硬件配置和系统运行参数，</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">process_kernel_dt</span>(); <span class="hljs-comment">// 处理 DT属性</span><br>    <span class="hljs-built_in">process_kernel_cmdline</span>(); <span class="hljs-comment">// 处理命令行属性</span><br> <br>    <span class="hljs-comment">// 处理一些其他的属性</span><br>    <span class="hljs-built_in">export_kernel_boot_props</span>();<br> <br>    <span class="hljs-comment">// Make the time that init started available for bootstat to log.</span><br>    <span class="hljs-built_in">property_set</span>(<span class="hljs-string">&quot;ro.boottime.init&quot;</span>, <span class="hljs-built_in">getenv</span>(<span class="hljs-string">&quot;INIT_STARTED_AT&quot;</span>));<br>    <span class="hljs-built_in">property_set</span>(<span class="hljs-string">&quot;ro.boottime.init.selinux&quot;</span>, <span class="hljs-built_in">getenv</span>(<span class="hljs-string">&quot;INIT_SELINUX_TOOK&quot;</span>));<br> <br>    <span class="hljs-comment">// Set libavb version for Framework-only OTA match in Treble build.</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* avb_version = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">&quot;INIT_AVB_VERSION&quot;</span>);<br>    <span class="hljs-keyword">if</span> (avb_version) <span class="hljs-built_in">property_set</span>(<span class="hljs-string">&quot;ro.boot.avb_version&quot;</span>, avb_version);<br> <br>    <span class="hljs-comment">// See if need to load debug props to allow adb root, when the device is unlocked.</span><br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* force_debuggable_env = <span class="hljs-built_in">getenv</span>(<span class="hljs-string">&quot;INIT_FORCE_DEBUGGABLE&quot;</span>);<br>    <span class="hljs-keyword">if</span> (force_debuggable_env &amp;&amp; AvbHandle::<span class="hljs-built_in">IsDeviceUnlocked</span>()) &#123;<br>        load_debug_prop = <span class="hljs-string">&quot;true&quot;</span>s == force_debuggable_env;<br>    &#125;<br> <br>    <span class="hljs-comment">// 基于cmdline设置memcg属性</span><br>    <span class="hljs-keyword">bool</span> memcg_enabled = android::base::<span class="hljs-built_in">GetBoolProperty</span>(<span class="hljs-string">&quot;ro.boot.memcg&quot;</span>,<span class="hljs-literal">false</span>);<br>    <span class="hljs-keyword">if</span> (memcg_enabled) &#123;<br>       <span class="hljs-comment">// root memory control cgroup</span><br>       <span class="hljs-built_in">mkdir</span>(<span class="hljs-string">&quot;/dev/memcg&quot;</span>, <span class="hljs-number">0700</span>);<br>       <span class="hljs-built_in">chown</span>(<span class="hljs-string">&quot;/dev/memcg&quot;</span>,AID_ROOT,AID_SYSTEM);<br>       <span class="hljs-built_in">mount</span>(<span class="hljs-string">&quot;none&quot;</span>, <span class="hljs-string">&quot;/dev/memcg&quot;</span>, <span class="hljs-string">&quot;cgroup&quot;</span>, <span class="hljs-number">0</span>, <span class="hljs-string">&quot;memory&quot;</span>);<br>       <span class="hljs-comment">// app mem cgroups, used by activity manager, lmkd and zygote</span><br>       <span class="hljs-built_in">mkdir</span>(<span class="hljs-string">&quot;/dev/memcg/apps/&quot;</span>,<span class="hljs-number">0755</span>);<br>       <span class="hljs-built_in">chown</span>(<span class="hljs-string">&quot;/dev/memcg/apps/&quot;</span>,AID_SYSTEM,AID_SYSTEM);<br>       <span class="hljs-built_in">mkdir</span>(<span class="hljs-string">&quot;/dev/memcg/system&quot;</span>,<span class="hljs-number">0550</span>);<br>       <span class="hljs-built_in">chown</span>(<span class="hljs-string">&quot;/dev/memcg/system&quot;</span>,AID_SYSTEM,AID_SYSTEM);<br>    &#125;<br> <br>    <span class="hljs-comment">// 清空这些环境变量，之前已经存到了系统属性中去了</span><br>    <span class="hljs-built_in">unsetenv</span>(<span class="hljs-string">&quot;INIT_STARTED_AT&quot;</span>);<br>    <span class="hljs-built_in">unsetenv</span>(<span class="hljs-string">&quot;INIT_SELINUX_TOOK&quot;</span>);<br>    <span class="hljs-built_in">unsetenv</span>(<span class="hljs-string">&quot;INIT_AVB_VERSION&quot;</span>);<br>    <span class="hljs-built_in">unsetenv</span>(<span class="hljs-string">&quot;INIT_FORCE_DEBUGGABLE&quot;</span>);<br> <br>    <span class="hljs-comment">// Now set up SELinux for second stage.</span><br>    <span class="hljs-built_in">SelinuxSetupKernelLogging</span>();<br>    <span class="hljs-built_in">SelabelInitialize</span>();<br> <br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     * 02. 进行SELinux第二阶段并恢复一些文件安全上下文 </span><br><span class="hljs-comment">     * 恢复相关文件的安全上下文,因为这些文件是在SELinux安全机制初始化前创建的，</span><br><span class="hljs-comment">     * 所以需要重新恢复上下文</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">SelinuxRestoreContext</span>();<br> <br>   <span class="hljs-comment">/*</span><br><span class="hljs-comment">    * 03. 新建epoll并初始化子进程终止信号处理函数</span><br><span class="hljs-comment">    *  创建epoll实例，并返回epoll的文件描述符</span><br><span class="hljs-comment">    */</span><br>    Epoll epoll;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> result = epoll.<span class="hljs-built_in">Open</span>(); !result) &#123;<br>        <span class="hljs-built_in">PLOG</span>(FATAL) &lt;&lt; result.<span class="hljs-built_in">error</span>();<br>    &#125;<br> <br>    <span class="hljs-comment">/* </span><br><span class="hljs-comment">     *主要是创建handler处理子进程终止信号，注册一个signal到epoll进行监听</span><br><span class="hljs-comment">     *进行子继承处理</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">InstallSignalFdHandler</span>(&amp;epoll);<br> <br>    <span class="hljs-comment">// 进行默认属性配置相关的工作</span><br>    <span class="hljs-built_in">property_load_boot_defaults</span>(load_debug_prop);<br>    <span class="hljs-built_in">UmountDebugRamdisk</span>();<br>    <span class="hljs-built_in">fs_mgr_vendor_overlay_mount_all</span>();<br>    <span class="hljs-built_in">export_oem_lock_status</span>();<br> <br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">     *04. 设置其他系统属性并开启系统属性服务</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-built_in">StartPropertyService</span>(&amp;epoll);<br>    <span class="hljs-function">MountHandler <span class="hljs-title">mount_handler</span><span class="hljs-params">(&amp;epoll)</span></span>;<br> <br>    <span class="hljs-comment">//为USB存储设置udc Contorller, sys/class/udc</span><br>    <span class="hljs-built_in">set_usb_controller</span>();<br> <br>    <span class="hljs-comment">// 匹配命令和函数之间的对应关系</span><br>    <span class="hljs-keyword">const</span> BuiltinFunctionMap function_map;<br>    Action::<span class="hljs-built_in">set_function_map</span>(&amp;function_map);<br> <br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">SetupMountNamespaces</span>()) &#123;<br>        <span class="hljs-built_in">PLOG</span>(FATAL) &lt;&lt; <span class="hljs-string">&quot;SetupMountNamespaces failed&quot;</span>;<br>    &#125;<br> <br>    <span class="hljs-comment">// 初始化文件上下文</span><br>    subcontexts = <span class="hljs-built_in">InitializeSubcontexts</span>();<br> <br>   <span class="hljs-comment">/*</span><br><span class="hljs-comment">     *05 解析init.rc等文件，建立rc文件的action 、service，启动其他进程</span><br><span class="hljs-comment">     */</span><br>    ActionManager&amp; am = ActionManager::<span class="hljs-built_in">GetInstance</span>();<br>    ServiceList&amp; sm = ServiceList::<span class="hljs-built_in">GetInstance</span>();<br> <br>    <span class="hljs-comment">//加载.rc文件</span><br>    <span class="hljs-built_in">LoadBootScripts</span>(am, sm);<br> <br>    <span class="hljs-comment">// Turning this on and letting the INFO logging be discarded adds 0.2s to</span><br>    <span class="hljs-comment">// Nexus 9 boot time, so it&#x27;s disabled by default.</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-literal">false</span>) <span class="hljs-built_in">DumpState</span>();<br> <br>    <span class="hljs-comment">// 当GSI脚本running时，确保GSI状态可用.</span><br>    <span class="hljs-keyword">if</span> (android::gsi::<span class="hljs-built_in">IsGsiRunning</span>()) &#123;<br>        <span class="hljs-built_in">property_set</span>(<span class="hljs-string">&quot;ro.gsid.image_running&quot;</span>, <span class="hljs-string">&quot;1&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">property_set</span>(<span class="hljs-string">&quot;ro.gsid.image_running&quot;</span>, <span class="hljs-string">&quot;0&quot;</span>);<br>    &#125;<br> <br> <br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(SetupCgroupsAction, <span class="hljs-string">&quot;SetupCgroups&quot;</span>);<br> <br>    <span class="hljs-comment">// 执行rc文件中触发器为 on early-init 的语句</span><br>    am.<span class="hljs-built_in">QueueEventTrigger</span>(<span class="hljs-string">&quot;early-init&quot;</span>);<br> <br>    <span class="hljs-comment">// 等冷插拔设备初始化完成</span><br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(wait_for_coldboot_done_action, <span class="hljs-string">&quot;wait_for_coldboot_done&quot;</span>);<br> <br>    <span class="hljs-comment">// 开始查询来自 /dev的 action</span><br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(MixHwrngIntoLinuxRngAction, <span class="hljs-string">&quot;MixHwrngIntoLinuxRng&quot;</span>);<br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(SetMmapRndBitsAction, <span class="hljs-string">&quot;SetMmapRndBits&quot;</span>);<br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(SetKptrRestrictAction, <span class="hljs-string">&quot;SetKptrRestrict&quot;</span>);<br> <br>    <span class="hljs-comment">// 设备组合键的初始化操作</span><br>    Keychords keychords;<br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(<br>        [&amp;epoll, &amp;keychords](<span class="hljs-keyword">const</span> BuiltinArguments&amp; args) -&gt; Result&lt;Success&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span>&amp; svc : ServiceList::<span class="hljs-built_in">GetInstance</span>()) &#123;<br>                keychords.<span class="hljs-built_in">Register</span>(svc-&gt;<span class="hljs-built_in">keycodes</span>());<br>            &#125;<br>            keychords.<span class="hljs-built_in">Start</span>(&amp;epoll, HandleKeychord);<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">Success</span>();<br>        &#125;,<br>        <span class="hljs-string">&quot;KeychordInit&quot;</span>);<br> <br>    <span class="hljs-comment">//在屏幕上显示Android 静态LOGO</span><br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(console_init_action, <span class="hljs-string">&quot;console_init&quot;</span>);<br> <br>    <span class="hljs-comment">// 执行rc文件中触发器为on init的语句</span><br>    am.<span class="hljs-built_in">QueueEventTrigger</span>(<span class="hljs-string">&quot;init&quot;</span>);<br> <br>    <span class="hljs-comment">// Starting the BoringSSL self test, for NIAP certification compliance.</span><br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(StartBoringSslSelfTest, <span class="hljs-string">&quot;StartBoringSslSelfTest&quot;</span>);<br> <br>    <span class="hljs-comment">// Repeat mix_hwrng_into_linux_rng in case /dev/hw_random or /dev/random</span><br>    <span class="hljs-comment">// wasn&#x27;t ready immediately after wait_for_coldboot_done</span><br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(MixHwrngIntoLinuxRngAction, <span class="hljs-string">&quot;MixHwrngIntoLinuxRng&quot;</span>);<br> <br>    <span class="hljs-comment">// Initialize binder before bringing up other system services</span><br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(InitBinder, <span class="hljs-string">&quot;InitBinder&quot;</span>);<br> <br>    <span class="hljs-comment">// 当设备处于充电模式时，不需要mount文件系统或者启动系统服务</span><br>    <span class="hljs-comment">// 充电模式下，将charger假如执行队列，否则把late-init假如执行队列</span><br>    std::string bootmode = <span class="hljs-built_in">GetProperty</span>(<span class="hljs-string">&quot;ro.bootmode&quot;</span>, <span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-keyword">if</span> (bootmode == <span class="hljs-string">&quot;charger&quot;</span>) &#123;<br>        am.<span class="hljs-built_in">QueueEventTrigger</span>(<span class="hljs-string">&quot;charger&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        am.<span class="hljs-built_in">QueueEventTrigger</span>(<span class="hljs-string">&quot;late-init&quot;</span>);<br>    &#125;<br> <br>    <span class="hljs-comment">// 基于属性当前状态 运行所有的属性触发器.</span><br>    am.<span class="hljs-built_in">QueueBuiltinAction</span>(queue_property_triggers_action, <span class="hljs-string">&quot;queue_property_triggers&quot;</span>);<br> <br>    <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>        <span class="hljs-comment">// By default, sleep until something happens.</span><br>        <span class="hljs-keyword">auto</span> epoll_timeout = std::optional&lt;std::chrono::milliseconds&gt;&#123;&#125;;<br> <br>        <span class="hljs-keyword">if</span> (do_shutdown &amp;&amp; !shutting_down) &#123;<br>            do_shutdown = <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">HandlePowerctlMessage</span>(shutdown_command)) &#123;<br>                shutting_down = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br> <br><span class="hljs-comment">//依次执行每个action中携带command对应的执行函数</span><br>        <span class="hljs-keyword">if</span> (!(waiting_for_prop || Service::<span class="hljs-built_in">is_exec_service_running</span>())) &#123;<br>            am.<span class="hljs-built_in">ExecuteOneCommand</span>();<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!(waiting_for_prop || Service::<span class="hljs-built_in">is_exec_service_running</span>())) &#123;<br>            <span class="hljs-keyword">if</span> (!shutting_down) &#123;<br>                <span class="hljs-keyword">auto</span> next_process_action_time = <span class="hljs-built_in">HandleProcessActions</span>();<br> <br>                <span class="hljs-comment">// If there&#x27;s a process that needs restarting, wake up in time for that.</span><br>                <span class="hljs-keyword">if</span> (next_process_action_time) &#123;<br>                    epoll_timeout = std::chrono::ceil&lt;std::chrono::milliseconds&gt;(<br>                            *next_process_action_time - boot_clock::<span class="hljs-built_in">now</span>());<br>                    <span class="hljs-keyword">if</span> (*epoll_timeout &lt; <span class="hljs-number">0</span>ms) epoll_timeout = <span class="hljs-number">0</span>ms;<br>                &#125;<br>            &#125;<br> <br>            <span class="hljs-comment">// If there&#x27;s more work to do, wake up again immediately.</span><br>            <span class="hljs-keyword">if</span> (am.<span class="hljs-built_in">HasMoreCommands</span>()) epoll_timeout = <span class="hljs-number">0</span>ms;<br>        &#125;<br> <br>        <span class="hljs-comment">// 循环等待事件发生</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">auto</span> result = epoll.<span class="hljs-built_in">Wait</span>(epoll_timeout); !result) &#123;<br>            <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; result.<span class="hljs-built_in">error</span>();<br>        &#125;<br>    &#125;<br> <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<p>LoadBootScripts方法：</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">static void <span class="hljs-constructor">LoadBootScripts(ActionManager&amp; <span class="hljs-params">action_manager</span>, ServiceList&amp; <span class="hljs-params">service_list</span>)</span> &#123;<br>    Parser parser = <span class="hljs-constructor">CreateParser(<span class="hljs-params">action_manager</span>, <span class="hljs-params">service_list</span>)</span>;<br><br>    std::<span class="hljs-built_in">string</span> bootscript = <span class="hljs-constructor">GetProperty(<span class="hljs-string">&quot;ro.boot.init_rc&quot;</span>, <span class="hljs-string">&quot;&quot;</span>)</span>;<br>    <span class="hljs-keyword">if</span> (bootscript.empty<span class="hljs-literal">()</span>) &#123;<br>        parser.<span class="hljs-constructor">ParseConfig(<span class="hljs-string">&quot;/init.rc&quot;</span>)</span>;<br>        <span class="hljs-keyword">if</span> (!parser.<span class="hljs-constructor">ParseConfig(<span class="hljs-string">&quot;/system/etc/init&quot;</span>)</span>) &#123;<br>            late_import_paths.emplace<span class="hljs-constructor">_back(<span class="hljs-string">&quot;/system/etc/init&quot;</span>)</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!parser.<span class="hljs-constructor">ParseConfig(<span class="hljs-string">&quot;/product/etc/init&quot;</span>)</span>) &#123;<br>            late_import_paths.emplace<span class="hljs-constructor">_back(<span class="hljs-string">&quot;/product/etc/init&quot;</span>)</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!parser.<span class="hljs-constructor">ParseConfig(<span class="hljs-string">&quot;/product_services/etc/init&quot;</span>)</span>) &#123;<br>            late_import_paths.emplace<span class="hljs-constructor">_back(<span class="hljs-string">&quot;/product_services/etc/init&quot;</span>)</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!parser.<span class="hljs-constructor">ParseConfig(<span class="hljs-string">&quot;/odm/etc/init&quot;</span>)</span>) &#123;<br>            late_import_paths.emplace<span class="hljs-constructor">_back(<span class="hljs-string">&quot;/odm/etc/init&quot;</span>)</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!parser.<span class="hljs-constructor">ParseConfig(<span class="hljs-string">&quot;/vendor/etc/init&quot;</span>)</span>) &#123;<br>            late_import_paths.emplace<span class="hljs-constructor">_back(<span class="hljs-string">&quot;/vendor/etc/init&quot;</span>)</span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        parser.<span class="hljs-constructor">ParseConfig(<span class="hljs-params">bootscript</span>)</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-4-三阶段启动init-rc"><a href="#2-4-三阶段启动init-rc" class="headerlink" title="2.4 三阶段启动init.rc"></a>2.4 三阶段启动init.rc</h3><p>当属性服务建立完成后，init的自身功能基本就告一段落，接下来需要来启动其他的进程。但是init进程如何其他其他进程呢？其他进程都是一个二进制文件，我们可以直接通过exec的命令方式来启动，例如 ./system/bin/init second_stage，来启动init进程的第二阶段。但是Android系统有那么多的Native进程，如果都通过传exec在代码中一个个的来执行进程，那无疑是一个灾难性的设计。</p>
<p>在这个基础上Android推出了一个init.rc的机制，即类似通过读取配置文件的方式，来启动不同的进程。接下来我们就来看看init.rc是如何工作的。</p>
<p>init.rc是一个配置文件，内部由Android初始化语言编写（Android Init Language）编写的脚本。</p>
<p>init.rc在手机的目录：./init.rc</p>
<p>启动zygote的.rc文件位于system/core/rootdir/init.rc</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs awk"><br>.....<br><br><span class="hljs-regexp">//</span>根据系统ro.zygote属性来启动对应位数(<span class="hljs-number">32</span>/<span class="hljs-number">64</span>)进程<br><span class="hljs-regexp">//</span>ro.zygote 为zygote32<span class="hljs-regexp">/zygote32_64/</span>zygote64_32/zygote64<br>import /init.<span class="hljs-variable">$&#123;ro.zygote&#125;</span>.rc<br><br><br>on zygote-start &amp;&amp; property:ro.crypto.state=unencrypted<br>    <br>    start netd  <span class="hljs-regexp">//</span>启动网络相关守护进程<br>    start zygote    <span class="hljs-regexp">//</span>启动zygote<br>    start zygote_secondary <span class="hljs-regexp">//</span>启动zygote_secondary<br>.....<br><br></code></pre></td></tr></table></figure>

<p>android10 ro.zygote系统默认为zygote64_32，当 ro.zygote为zygote32</p>
<p>import /init.zygote32.rc,对应rc文件为 system/core/rootdir/init.zygote32.rc</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs gradle"><span class="hljs-comment">//通过system/bin/app_process命令启动zygote</span><br>service zygote <span class="hljs-regexp">/system/</span>bin<span class="hljs-regexp">/app_process -Xzygote /</span>system/bin --zygote --start-system-server<br>    <span class="hljs-keyword">class</span> main<br>    priority -<span class="hljs-number">20</span><br>    user root<br>    <span class="hljs-keyword">group</span> root readproc reserved_disk<br>    socket zygote stream <span class="hljs-number">660</span> root system <span class="hljs-comment">//注册socks服务</span><br>    socket usap_pool_primary stream <span class="hljs-number">660</span> root system<br>    onrestart <span class="hljs-keyword">write</span> <span class="hljs-regexp">/sys/</span>android_power/request_state wake<br>    onrestart <span class="hljs-keyword">write</span> <span class="hljs-regexp">/sys/</span><span class="hljs-keyword">power</span>/state on<br>    onrestart restart audioserver<br>    onrestart restart cameraserver<br>    onrestart restart media<br>    onrestart restart netd<br>    onrestart restart wificond<br>    writepid <span class="hljs-regexp">/dev/</span>cpuset<span class="hljs-regexp">/foreground/</span>tasks<br></code></pre></td></tr></table></figure>


<p>当 ro.zygote 为zygote64_32</p>
<p>import /init.zygote64_32.rc,对应rc文件为 system/core/rootdir/init.zygote64_32.rc,为了兼容32位应用会同时开启64位和32位两个zygote进程，且优先使用64位。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">//</span>通过system<span class="hljs-regexp">/bin/</span>app_process64命令启动zygote<br>service zygote <span class="hljs-regexp">/system/</span>bin<span class="hljs-regexp">/app_process64 -Xzygote /</span>system/bin --zygote --start-system-server --socket-name=zygote<br>    class main<br>    priority -<span class="hljs-number">20</span><br>    user root<br>    group root readproc reserved_disk<br>    socket zygote stream <span class="hljs-number">660</span> root system <span class="hljs-regexp">//</span>注册socks服务<br>    socket usap_pool_primary stream <span class="hljs-number">660</span> root system<br>    onrestart write <span class="hljs-regexp">/sys/</span>android_power/request_state wake<br>    onrestart write <span class="hljs-regexp">/sys/</span>power/state on<br>    onrestart restart audioserver<br>    onrestart restart cameraserver<br>    onrestart restart media<br>    onrestart restart netd<br>    onrestart restart wificond<br>    writepid <span class="hljs-regexp">/dev/</span>cpuset<span class="hljs-regexp">/foreground/</span>tasks<br><br><span class="hljs-regexp">//</span>通过system<span class="hljs-regexp">/bin/</span>app_process32命令启动zygote<br>service zygote_secondary <span class="hljs-regexp">/system/</span>bin<span class="hljs-regexp">/app_process32 -Xzygote /</span>system/bin --zygote --socket-name=zygote_secondary --enable-lazy-preload<br>    class main<br>    priority -<span class="hljs-number">20</span><br>    user root<br>    group root readproc reserved_disk<br>    socket zygote_secondary stream <span class="hljs-number">660</span> root system <span class="hljs-regexp">//</span>注册socks服务<br>    socket usap_pool_secondary stream <span class="hljs-number">660</span> root system<br>    onrestart restart zygote<br>    writepid <span class="hljs-regexp">/dev/</span>cpuset<span class="hljs-regexp">/foreground/</span>tasks<br></code></pre></td></tr></table></figure>

<p>如上，可以看到服务名（进程名）是zygote，对应的可执行程序是app_processXX，而且还创建了一个名为zygote的unix domain socket，类型是stream，这个socket是为了后面IPC所用；上面可以看到还有一个zygote_secondary的进程，其实这是为了适配不同的abi型号</p>
<p>其中Zygote进程能够重启的地方有,以下进程杀死，Zygote重启</p>
<p>servicemanager进程被杀<br>surfaceflinger进程被杀<br>Zygote进程自己被杀<br>system_server进程被杀</p>
<h3 id="2-5-运行-system-bin-app-processXX"><a href="#2-5-运行-system-bin-app-processXX" class="headerlink" title="2.5 运行/system/bin/app_processXX"></a>2.5 运行/system/bin/app_processXX</h3><p>接下来看看zygote启动过程，zygote对应的可执行文件就是/system/bin/app_processXX，也就是说系统启动时会执行到这个可执行文件的main()函数里</p>
<p>源码位于 frameworks/base/cmds/app_process/app_main.cpp,部分代码如下:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span>* <span class="hljs-keyword">const</span> argv[])</span></span><br><span class="hljs-function"></span>&#123;<br>  ......<br>  <br>  <span class="hljs-comment">// 创建 AppRuntime的成员变量</span><br>  <br>    <span class="hljs-function">AppRuntime <span class="hljs-title">runtime</span><span class="hljs-params">(argv[<span class="hljs-number">0</span>], computeArgBlockSize(argc, argv))</span></span>;<br> <br>    argc--;<br>    argv++;<br><br>   <br>    <span class="hljs-keyword">int</span> i;<br>    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; argc; i++) &#123;<br>        <span class="hljs-keyword">if</span> (argv[i][<span class="hljs-number">0</span>] != <span class="hljs-string">&#x27;-&#x27;</span>) &#123;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (argv[i][<span class="hljs-number">1</span>] == <span class="hljs-string">&#x27;-&#x27;</span> &amp;&amp; argv[i][<span class="hljs-number">2</span>] == <span class="hljs-number">0</span>) &#123;<br>            ++i; <span class="hljs-comment">// Skip --.</span><br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        runtime.<span class="hljs-built_in">addOption</span>(<span class="hljs-built_in">strdup</span>(argv[i]));<br>    &#125;<br><br>  <span class="hljs-comment">// 解析运行时参数，赋值zygote和startSystemServer</span><br>  <br>    <span class="hljs-keyword">bool</span> zygote = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">bool</span> startSystemServer = <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">bool</span> application = <span class="hljs-literal">false</span>;<br>    String8 niceName;<br>    String8 className;<br><br>    ++i;  <span class="hljs-comment">// Skip unused &quot;parent dir&quot; argument.</span><br>    <span class="hljs-keyword">while</span> (i &lt; argc) &#123;<br>        <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* arg = argv[i++];<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(arg, <span class="hljs-string">&quot;--zygote&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>            zygote = <span class="hljs-literal">true</span>;<br>            niceName = ZYGOTE_NICE_NAME;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(arg, <span class="hljs-string">&quot;--start-system-server&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>            startSystemServer = <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(arg, <span class="hljs-string">&quot;--application&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>            application = <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(arg, <span class="hljs-string">&quot;--nice-name=&quot;</span>, <span class="hljs-number">12</span>) == <span class="hljs-number">0</span>) &#123;<br>            niceName.<span class="hljs-built_in">setTo</span>(arg + <span class="hljs-number">12</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(arg, <span class="hljs-string">&quot;--&quot;</span>, <span class="hljs-number">2</span>) != <span class="hljs-number">0</span>) &#123;<br>            className.<span class="hljs-built_in">setTo</span>(arg);<br>            <span class="hljs-keyword">break</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            --i;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>    &#125;<br><br>    .......<br>     <br>    <span class="hljs-keyword">if</span> (zygote) &#123;<br>     <span class="hljs-comment">// 调用 ZygoteInit#main()</span><br>        runtime.<span class="hljs-built_in">start</span>(<span class="hljs-string">&quot;com.android.internal.os.ZygoteInit&quot;</span>, args, zygote);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (className) &#123;<br>        runtime.<span class="hljs-built_in">start</span>(<span class="hljs-string">&quot;com.android.internal.os.RuntimeInit&quot;</span>, args, zygote);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">&quot;Error: no class name or --zygote supplied.\n&quot;</span>);<br>        <span class="hljs-built_in">app_usage</span>();<br>        <span class="hljs-built_in">LOG_ALWAYS_FATAL</span>(<span class="hljs-string">&quot;app_process: no class name or --zygote supplied.&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">10</span>;<br>    &#125;<br><br><br></code></pre></td></tr></table></figure>

<p>上述代码，首先创建了一个AppRuntime的局部成员变量，然后对入参进行了解析，根据对init.zygote64_32.rc传入参数的分析，这里的zygote变量和startSystemServer的值均为true，因此在最后调用AppRuntime#start()函数时走了,而AppRuntime继承了AndroidRuntime，而子类里没有start方法，所以此处调用了AndroidRuntime::start()</p>
<h3 id="2-6-AndroidRuntime-start"><a href="#2-6-AndroidRuntime-start" class="headerlink" title="2.6 AndroidRuntime::start()"></a>2.6 AndroidRuntime::start()</h3><p>AndroidRuntime类位于frameworks/base/core/jni/AndroidRuntime.cpp</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">void</span> AndroidRuntime::start(<span class="hljs-keyword">const</span> char* className, <span class="hljs-keyword">const</span> Vector&lt;String8&gt;&amp; options, <span class="hljs-keyword">bool</span> zygote)<br>&#123;<br>    <br>    <span class="hljs-comment">/* start the virtual machine */</span><br>    JniInvocation jni_invocation;<br>    jni_invocation.Init(<span class="hljs-literal">NULL</span>);  <span class="hljs-comment">//加载libart.so、导出三个主要jni方法(JNI_GetDefaultJavaVMInitArgs、JNI_CreateJavaVM、JNI_GetCreatedJavaVMs)</span><br>    JNIEnv* env;<br>     <span class="hljs-comment">// 虚拟机创建，主要篇幅是关于虚拟机参数的设置</span><br>    <span class="hljs-keyword">if</span> (startVm(&amp;mJavaVM, &amp;env, zygote) != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    onVmCreated(env);<br><br>    <span class="hljs-comment">// JNI方法注册</span><br>    <span class="hljs-keyword">if</span> (startReg(env) &lt; <span class="hljs-number">0</span>) &#123;<br>        ALOGE(<span class="hljs-string">&quot;Unable to register all android natives\n&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    jclass stringClass;<br>    jobjectArray strArray;<br>    jstring classNameStr;<br><br>    <span class="hljs-comment">//等价 strArray= new String[options.size() + 1];</span><br>    stringClass = env-&gt;FindClass(<span class="hljs-string">&quot;java/lang/String&quot;</span>);<br>    assert(stringClass != <span class="hljs-literal">NULL</span>);<br>    <br>    <span class="hljs-comment">//等价 strArray[0] = &quot;com.android.internal.os.ZygoteInit&quot;</span><br>    strArray = env-&gt;NewObjectArray(options.size() + <span class="hljs-number">1</span>, stringClass, <span class="hljs-literal">NULL</span>);<br>    assert(strArray != <span class="hljs-literal">NULL</span>);<br>    classNameStr = env-&gt;NewStringUTF(className);<br>    assert(classNameStr != <span class="hljs-literal">NULL</span>);<br>    env-&gt;SetObjectArrayElement(strArray, <span class="hljs-number">0</span>, classNameStr);<br><br>    <span class="hljs-comment">//等价 strArray[1] = &quot;start-system-server&quot;；</span><br>    <span class="hljs-comment">//    strArray[2] = &quot;--abi-list=xxx&quot;；</span><br>    <span class="hljs-comment">//其中xxx为系统响应的cpu架构类型，比如arm64-v8a.</span><br>    <span class="hljs-keyword">for</span> (size_t i = <span class="hljs-number">0</span>; i &lt; options.size(); ++i) &#123;<br>        jstring optionsStr = env-&gt;NewStringUTF(options.itemAt(i).<span class="hljs-keyword">string</span>());<br>        assert(optionsStr != <span class="hljs-literal">NULL</span>);<br>        env-&gt;SetObjectArrayElement(strArray, i + <span class="hljs-number">1</span>, optionsStr);<br>    &#125;<br><br>   <br>     <span class="hljs-comment">//将&quot;com.android.internal.os.ZygoteInit&quot;转换为&quot;com/android/internal/os/ZygoteInit&quot;</span><br>    char* slashClassName = toSlashClassName(className);<br>    <span class="hljs-comment">//找到Zygoteinit类</span><br>    jclass startClass = env-&gt;FindClass(slashClassName);<br>    <span class="hljs-keyword">if</span> (startClass == <span class="hljs-literal">NULL</span>) &#123;<br>        ALOGE(<span class="hljs-string">&quot;JavaVM unable to locate class &#x27;%s&#x27;\n&quot;</span>, slashClassName);<br><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//找到这个类后就继续找成员函数main方法的Mehtod ID</span><br>        jmethodID startMeth = env-&gt;GetStaticMethodID(startClass, <span class="hljs-string">&quot;main&quot;</span>,<br>            <span class="hljs-string">&quot;([Ljava/lang/String;)V&quot;</span>);<br>        <span class="hljs-keyword">if</span> (startMeth == <span class="hljs-literal">NULL</span>) &#123;<br>            ALOGE(<span class="hljs-string">&quot;JavaVM unable to find main() in &#x27;%s&#x27;\n&quot;</span>, className);<br> <br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 通过反射调用ZygoteInit.main()方法</span><br>            env-&gt;CallStaticVoidMethod(startClass, startMeth, strArray);<br><br>        &#125;<br>    &#125;<br>     <span class="hljs-comment">//释放相应对象的内存空间</span><br>    free(slashClassName);<br><br>   .....<br>&#125;<br></code></pre></td></tr></table></figure>

<p>该函数启动了 Android 系统运行时库，其中它主要做了三件事：</p>
<ol>
<li>调用startVmVM()函数启动虚拟机</li>
<li>调用startReg()函数注册 Android 的 Java 方法，其实在这里就是 JNI 方法</li>
<li>反射调用 Java 类com.android.internal.os.ZygoteInit#main()方法，并把 fork zygote进程时的参数传入用来辅助初始化zygote进程</li>
</ol>
<h3 id="2-7-AndroidRuntime-startVm"><a href="#2-7-AndroidRuntime-startVm" class="headerlink" title="2.7 AndroidRuntime::startVm()"></a>2.7 AndroidRuntime::startVm()</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">AndroidRuntime::startVm</span><span class="hljs-params">(JavaVM** pJavaVM, JNIEnv** pEnv, <span class="hljs-keyword">bool</span> zygote)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-comment">// JNI检测功能，用于native层调用jni函数时进行常规检测，比较弱字符串格式是否符合要求，资源是否正确释放。该功能一般用于早期系统调试或手机Eng版，对于User版往往不会开启，引用该功能比较消耗系统CPU资源，降低系统性能。</span><br>    <span class="hljs-keyword">bool</span> checkJni = <span class="hljs-literal">false</span>;<br>    <span class="hljs-built_in">property_get</span>(<span class="hljs-string">&quot;dalvik.vm.checkjni&quot;</span>, propBuf, <span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(propBuf, <span class="hljs-string">&quot;true&quot;</span>) == <span class="hljs-number">0</span>) &#123;<br>        checkJni = <span class="hljs-literal">true</span>;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(propBuf, <span class="hljs-string">&quot;false&quot;</span>) != <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">property_get</span>(<span class="hljs-string">&quot;ro.kernel.android.checkjni&quot;</span>, propBuf, <span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-keyword">if</span> (propBuf[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;1&#x27;</span>) &#123;<br>            checkJni = <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (checkJni) &#123;<br>        <span class="hljs-built_in">addOption</span>(<span class="hljs-string">&quot;-Xcheck:jni&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">//虚拟机产生的trace文件，主要用于分析系统问题，路径默认为/data/anr/traces.txt</span><br>    <span class="hljs-built_in">parseRuntimeOption</span>(<span class="hljs-string">&quot;dalvik.vm.stack-trace-file&quot;</span>, stackTraceFileBuf, <span class="hljs-string">&quot;-Xstacktracefile:&quot;</span>);<br><br>    <span class="hljs-comment">//对于不同的软硬件环境，这些参数往往需要调整、优化，从而使系统达到最佳性能</span><br>    <span class="hljs-built_in">parseRuntimeOption</span>(<span class="hljs-string">&quot;dalvik.vm.heapstartsize&quot;</span>, heapstartsizeOptsBuf, <span class="hljs-string">&quot;-Xms&quot;</span>, <span class="hljs-string">&quot;4m&quot;</span>);<br>    <span class="hljs-built_in">parseRuntimeOption</span>(<span class="hljs-string">&quot;dalvik.vm.heapsize&quot;</span>, heapsizeOptsBuf, <span class="hljs-string">&quot;-Xmx&quot;</span>, <span class="hljs-string">&quot;16m&quot;</span>);<br>    <span class="hljs-built_in">parseRuntimeOption</span>(<span class="hljs-string">&quot;dalvik.vm.heapgrowthlimit&quot;</span>, heapgrowthlimitOptsBuf, <span class="hljs-string">&quot;-XX:HeapGrowthLimit=&quot;</span>);<br>    <span class="hljs-built_in">parseRuntimeOption</span>(<span class="hljs-string">&quot;dalvik.vm.heapminfree&quot;</span>, heapminfreeOptsBuf, <span class="hljs-string">&quot;-XX:HeapMinFree=&quot;</span>);<br>    <span class="hljs-built_in">parseRuntimeOption</span>(<span class="hljs-string">&quot;dalvik.vm.heapmaxfree&quot;</span>, heapmaxfreeOptsBuf, <span class="hljs-string">&quot;-XX:HeapMaxFree=&quot;</span>);<br>    <span class="hljs-built_in">parseRuntimeOption</span>(<span class="hljs-string">&quot;dalvik.vm.heaptargetutilization&quot;</span>,<br>                       heaptargetutilizationOptsBuf, <span class="hljs-string">&quot;-XX:HeapTargetUtilization=&quot;</span>);<br>    ...<br><br>    <span class="hljs-comment">//preloaded-classes文件内容是由WritePreloadedClassFile.java生成的，</span><br>    <span class="hljs-comment">//在ZygoteInit类中会预加载工作将其中的classes提前加载到内存，以提高系统性能</span><br>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">hasFile</span>(<span class="hljs-string">&quot;/system/etc/preloaded-classes&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br><br>    <span class="hljs-comment">//初始化虚拟机</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">JNI_CreateJavaVM</span>(pJavaVM, pEnv, &amp;initArgs) &lt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">&quot;JNI_CreateJavaVM failed\n&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-8-AndroidRuntime-startReg"><a href="#2-8-AndroidRuntime-startReg" class="headerlink" title="2.8 AndroidRuntime::startReg()"></a>2.8 AndroidRuntime::startReg()</h3><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-built_in">int</span> AndroidRuntime::start<span class="hljs-constructor">Reg(JNIEnv<span class="hljs-operator">*</span> <span class="hljs-params">env</span>)</span><br>&#123;<br>    <span class="hljs-comment">//设置线程创建方法为javaCreateThreadEtc </span><br>    android<span class="hljs-constructor">SetCreateThreadFunc((<span class="hljs-params">android_create_thread_fn</span>)</span> javaCreateThreadEtc);<br><br>    env-&gt;<span class="hljs-constructor">PushLocalFrame(200)</span>;<br>    <span class="hljs-comment">//进程JNI方法的注册</span><br>    <span class="hljs-keyword">if</span> (register<span class="hljs-constructor">_jni_procs(<span class="hljs-params">gRegJNI</span>, NELEM(<span class="hljs-params">gRegJNI</span>)</span>, env) &lt; <span class="hljs-number">0</span>) &#123;<br>        env-&gt;<span class="hljs-constructor">PopLocalFrame(NULL)</span>;<br>        return -<span class="hljs-number">1</span>;<br>    &#125;<br>    env-&gt;<span class="hljs-constructor">PopLocalFrame(NULL)</span>;<br>    return <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-9-进入java世界，com-android-internal-os-ZygoteInit-main"><a href="#2-9-进入java世界，com-android-internal-os-ZygoteInit-main" class="headerlink" title="2.9 进入java世界，com.android.internal.os.ZygoteInit#main()"></a>2.9 进入java世界，com.android.internal.os.ZygoteInit#main()</h3><p>源码位于frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-keyword">void</span> main(<span class="hljs-keyword">String</span> argv[]) &#123;<br>    <span class="hljs-comment">// 标记Zygote开始初始化，并Hook确保不创建其他线程</span><br>    ZygoteHooks.startZygoteNoThreadCreation();<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="hljs-string">&quot;ZygoteInit&quot;</span>);<br>        <span class="hljs-comment">//开启DDMS功能</span><br>        RuntimeInit.enableDdms();<br>        <span class="hljs-comment">// Start profiling the zygote initialization.</span><br>        SamplingProfilerIntegration.start();<br><br>        <span class="hljs-keyword">boolean</span> startSystemServer = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">String</span> socketName = <span class="hljs-string">&quot;zygote&quot;</span>;<br>        <span class="hljs-keyword">String</span> abiList = <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">// 解析参数，初始化局部变量</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt; argv.length; i++) &#123;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;start-system-server&quot;</span>.equals(argv[i])) &#123;<br>                startSystemServer = <span class="hljs-literal">true</span>;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (argv[i].startsWith(ABI_LIST_ARG)) &#123;<br>                abiList = argv[i].substring(ABI_LIST_ARG.length());<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (argv[i].startsWith(SOCKET_NAME_ARG)) &#123;<br>                socketName = argv[i].substring(SOCKET_NAME_ARG.length());<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">&quot;Unknown command line argument: &quot;</span> + argv[i]);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (abiList == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">&quot;No ABI list supplied.&quot;</span>);<br>        &#125;<br>        <span class="hljs-comment">//为Zygote注册socket</span><br>        registerZygoteSocket(socketName);<br>        Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="hljs-string">&quot;ZygotePreload&quot;</span>);<br>        EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START,<br>            SystemClock.uptimeMillis());<br>        <span class="hljs-comment">// 预加载类和资源</span><br>        preload(); <br>        EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END,<br>            SystemClock.uptimeMillis());<br>        Trace.traceEnd(Trace.TRACE_TAG_DALVIK);<br><br>        <span class="hljs-comment">// Finish profiling the zygote initialization.</span><br>        SamplingProfilerIntegration.writeZygoteSnapshot();<br><br>        <span class="hljs-comment">// Do an initial gc to clean up after startup</span><br>        Trace.traceBegin(Trace.TRACE_TAG_DALVIK, <span class="hljs-string">&quot;PostZygoteInitGC&quot;</span>);<br>        gcAndFinalize();<br>        Trace.traceEnd(Trace.TRACE_TAG_DALVIK);<br><br>        Trace.traceEnd(Trace.TRACE_TAG_DALVIK);<br><br>        <span class="hljs-comment">// Disable tracing so that forked processes do not inherit stale tracing tags from</span><br>        <span class="hljs-comment">// Zygote.</span><br>        Trace.setTracingEnabled(<span class="hljs-literal">false</span>);<br><br>        <span class="hljs-comment">// Zygote process unmounts root storage spaces.</span><br>        Zygote.nativeUnmountStorageOnInit();<br>        <span class="hljs-comment">// 停止Hook不创建其他线程，也就是说允许创建其他线程</span><br>        ZygoteHooks.stopZygoteNoThreadCreation();<br>        <span class="hljs-comment">// 这里一定是true，启动SystemServer</span><br>        <span class="hljs-keyword">if</span> (startSystemServer) &#123;<br>            startSystemServer(abiList, socketName);<br>        &#125;<br><br>        Log.i(TAG, <span class="hljs-string">&quot;Accepting command socket connections&quot;</span>);<br>        <span class="hljs-comment">// 运行zygote进程的select循环</span><br>        runSelectLoop(abiList);<br><br>        closeServerSocket();<br>    &#125; <span class="hljs-keyword">catch</span> (MethodAndArgsCaller caller) &#123;<br>        <span class="hljs-comment">//捕获异常,并运行run方法</span><br>        caller.run();<br>    &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Throwable</span> ex) &#123;<br>        Log.e(TAG, <span class="hljs-string">&quot;Zygote died with exception&quot;</span>, ex);<br>        closeServerSocket();<br>        <span class="hljs-keyword">throw</span> ex;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在这个初始化过程中，做了不少准备工作，更加详细的过程请阅读上述代码注释和源码，我们这里总结以下我们需要着重关注的几件事：</p>
<ol>
<li>调用ZygoteServer#registerServerSocket()方法创建一个名为zygote的 Socket 资源</li>
<li>调用preload预加载资源</li>
<li>调用ZygoteInit#starSystemServer()方法启动system_server进程</li>
<li>调用ZygoteInit#runSelectLoop()方法循环接受 Socket 连接，在这里开始和 AMS 搭上边，其实这里就是循环等待 AMS 的连接和命令，更加详细的过程在下文中分析。</li>
</ol>
<h3 id="2-10-ZygoteInit-registerZygoteSocket"><a href="#2-10-ZygoteInit-registerZygoteSocket" class="headerlink" title="2.10 ZygoteInit.registerZygoteSocket()"></a>2.10 ZygoteInit.registerZygoteSocket()</h3><p>Socket 是 IPC 通信的一种方式，该 Socket 资源在后期被用在和 AMS 等服务进行进程间通信</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">private</span> <span class="hljs-built_in">static</span> <span class="hljs-keyword">void</span> registerZygoteSocket(<span class="hljs-keyword">String</span> socketName) &#123;<br>        <span class="hljs-keyword">if</span> (sServerSocket == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">int</span> fileDesc;<br>            <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> fullSocketName = ANDROID_SOCKET_PREFIX + socketName;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">String</span> env = System.getenv(fullSocketName);<br>                fileDesc = <span class="hljs-keyword">Integer</span>.parseInt(env);<br>            &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">RuntimeException</span> ex) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(fullSocketName + <span class="hljs-string">&quot; unset or invalid&quot;</span>, ex);<br>            &#125;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                FileDescriptor fd = <span class="hljs-keyword">new</span> FileDescriptor();<br>                <span class="hljs-comment">//设置文件描述符</span><br>                fd.setInt$(fileDesc); <br>                <span class="hljs-comment">//创建Socket的本地服务端</span><br>                sServerSocket = <span class="hljs-keyword">new</span> LocalServerSocket(fd);<br>            &#125; <span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<br>                        <span class="hljs-string">&quot;Error binding to local socket &#x27;&quot;</span> + fileDesc + <span class="hljs-string">&quot;&#x27;&quot;</span>, ex);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-11-ZygoteInit-preload"><a href="#2-11-ZygoteInit-preload" class="headerlink" title="2.11 ZygoteInit.preload()"></a>2.11 ZygoteInit.preload()</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs awk">static void preload() &#123;<br>   <br>    <br>    <span class="hljs-regexp">//</span>预加载位于<span class="hljs-regexp">/system/</span>etc/preloaded-classes文件中的类<br>    preloadClasses();<br>   <br>    <span class="hljs-regexp">//</span>预加载资源，包含drawable和color资源<br>    preloadResources();<br>   <br>    <span class="hljs-regexp">//</span>预加载OpenGL<br>    preloadOpenGL();<br>  <br>    <span class="hljs-regexp">//</span>通过System.loadLibrary()方法，<br>    <span class="hljs-regexp">//</span>预加载<span class="hljs-string">&quot;android&quot;</span>,<span class="hljs-string">&quot;compiler_rt&quot;</span>,<span class="hljs-string">&quot;jnigraphics&quot;</span>这<span class="hljs-number">3</span>个共享库<br>    preloadSharedLibraries();<br>    <span class="hljs-regexp">//</span>预加载  文本连接符资源<br>    preloadTextResources();<br>   <br>    <span class="hljs-regexp">//</span>仅用于zygote进程，用于内存共享的进程<br>    WebViewFactory.prepareWebViewInZygote();<br> <br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>执行Zygote进程的初始化,对于类加载，采用反射机制Class.forName()方法来加载。对于资源加载，主要是 com.android.internal.R.array.preloaded_drawables和com.android.internal.R.array.preloaded_color_state_lists，在应用程序中以com.android.internal.R.xxx开头的资源，便是此时由Zygote加载到内存的</p>
<h3 id="2-11-ZygoteInit-startSystemServer"><a href="#2-11-ZygoteInit-startSystemServer" class="headerlink" title="2.11 ZygoteInit.startSystemServer()"></a>2.11 ZygoteInit.startSystemServer()</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">private</span> <span class="hljs-built_in">static</span> <span class="hljs-keyword">boolean</span> startSystemServer(<span class="hljs-keyword">String</span> abiList, <span class="hljs-keyword">String</span> socketName)<br>        throws MethodAndArgsCaller, <span class="hljs-built_in">RuntimeException</span> &#123;<br>    <span class="hljs-comment">//参数准备</span><br>    <span class="hljs-keyword">String</span> args[] = &#123;<br>        <span class="hljs-string">&quot;--setuid=1000&quot;</span>,<br>        <span class="hljs-string">&quot;--setgid=1000&quot;</span>,<br>        <span class="hljs-string">&quot;--setgroups=1001,1002,1003,1004,1005,1006,1007,1008,1009,1010,1018,1021,1032,3001,3002,3003,3006,3007,3009,3010&quot;</span>,<br>        <span class="hljs-string">&quot;--capabilities=&quot;</span> + capabilities + <span class="hljs-string">&quot;,&quot;</span> + capabilities,<br>        <span class="hljs-string">&quot;--nice-name=system_server&quot;</span>,  <span class="hljs-comment">// 指定进程名字 system_server</span><br>        <span class="hljs-string">&quot;--runtime-args&quot;</span>,<br>        <span class="hljs-string">&quot;com.android.server.SystemServer&quot;</span>,<br>    &#125;;<br>    ZygoteConnection.Arguments parsedArgs = <span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">int</span> pid;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//用于解析参数，生成目标格式</span><br>        parsedArgs = <span class="hljs-keyword">new</span> ZygoteConnection.Arguments(args);<br>        ZygoteConnection.applyDebuggerSystemProperty(parsedArgs);<br>        ZygoteConnection.applyInvokeWithSystemProperty(parsedArgs);<br><br>      <br>        <span class="hljs-comment">// 从zygote进程fork system_server进程</span><br>        pid = Zygote.forkSystemServer(<br>                parsedArgs.uid, parsedArgs.gid,<br>                parsedArgs.gids,<br>                parsedArgs.debugFlags,<br>                <span class="hljs-literal">null</span>,<br>                parsedArgs.permittedCapabilities,<br>                parsedArgs.effectiveCapabilities);<br>    &#125; <span class="hljs-keyword">catch</span> (IllegalArgumentException ex) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(ex);<br>    &#125;<br><br>    <span class="hljs-comment">//进入子进程system_server</span><br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">//第二个zygote进程</span><br>        <span class="hljs-keyword">if</span> (hasSecondZygote(abiList)) &#123;<br>            waitForSecondaryZygote(socketName);<br>        &#125;<br>        <span class="hljs-comment">// 完成system_server进程剩余的工作</span><br>        handleSystemServerProcess(parsedArgs);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个方法先准备参数，然后fork新进程，对于有两个zygote进程情况，需等待第2个zygote创建完成</p>
<h3 id="2-12-Zygote-forkSystemServer"><a href="#2-12-Zygote-forkSystemServer" class="headerlink" title="2.12 Zygote.forkSystemServer()"></a>2.12 Zygote.forkSystemServer()</h3><p>源码位于frameworks/base/core/java/com/android/internal/os/Zygote.java</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">forkSystemServer</span><span class="hljs-params">(<span class="hljs-keyword">int</span> uid, <span class="hljs-keyword">int</span> gid, <span class="hljs-keyword">int</span>[] gids, <span class="hljs-keyword">int</span> debugFlags,</span></span><br><span class="hljs-params"><span class="hljs-function">            <span class="hljs-keyword">int</span>[][] rlimits, <span class="hljs-keyword">long</span> permittedCapabilities, <span class="hljs-keyword">long</span> effectiveCapabilities)</span> </span>&#123;<br>        VM_HOOKS.<span class="hljs-built_in">preFork</span>();<br>        <span class="hljs-comment">// 调用native方法fork system_server进程</span><br>        <span class="hljs-keyword">int</span> pid = <span class="hljs-built_in">nativeForkSystemServer</span>(<br>                uid, gid, gids, debugFlags, rlimits, permittedCapabilities, effectiveCapabilities);<br>        <span class="hljs-comment">// Enable tracing as soon as we enter the system_server.</span><br>        <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>            Trace.<span class="hljs-built_in">setTracingEnabled</span>(<span class="hljs-literal">true</span>);<br>        &#125;<br>        VM_HOOKS.<span class="hljs-built_in">postForkCommon</span>();<br>        <span class="hljs-keyword">return</span> pid;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>nativeForkSystemServer()方法在AndroidRuntime.cpp中注册的，调用com_android_internal_os_Zygote.cpp中的register_com_android_internal_os_Zygote()方法建立native方法的映射关系，所以接下来进入如下方法<br>com_android_internal_os_Zygote.nativeForkSystemServer</p>
<h3 id="2-13-com-android-internal-os-Zygote-nativeForkSystemServer"><a href="#2-13-com-android-internal-os-Zygote-nativeForkSystemServer" class="headerlink" title="2.13 com_android_internal_os_Zygote.nativeForkSystemServer()"></a>2.13 com_android_internal_os_Zygote.nativeForkSystemServer()</h3><p>源码位于 frameworks/base/core/jni/com_android_internal_os_Zygote.cpp</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">static</span> jint <span class="hljs-title">com_android_internal_os_Zygote_nativeForkSystemServer</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">        JNIEnv* env, jclass, <span class="hljs-keyword">uid_t</span> uid, <span class="hljs-keyword">gid_t</span> gid, jintArray gids,</span></span><br><span class="hljs-params"><span class="hljs-function">        jint debug_flags, jobjectArray rlimits, jlong permittedCapabilities,</span></span><br><span class="hljs-params"><span class="hljs-function">        jlong effectiveCapabilities)</span> </span>&#123;<br>  <span class="hljs-comment">//fork子进程</span><br>  <span class="hljs-keyword">pid_t</span> pid = <span class="hljs-built_in">ForkAndSpecializeCommon</span>(env, uid, gid, gids,<br>                                      debug_flags, rlimits,<br>                                      permittedCapabilities, effectiveCapabilities,<br>                                      MOUNT_EXTERNAL_DEFAULT, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">NULL</span>,<br>                                      <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);<br>  <span class="hljs-keyword">if</span> (pid &gt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-comment">// zygote进程，检测system_server进程是否创建</span><br>      gSystemServerPid = pid;<br>    <br>      <span class="hljs-keyword">int</span> status;<br>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">waitpid</span>(pid, &amp;status, WNOHANG) == pid) &#123;<br>          <span class="hljs-comment">//当system_server进程死亡后，重启zygote进程</span><br>          <span class="hljs-built_in">RuntimeAbort</span>(env, __LINE__, <span class="hljs-string">&quot;System server process has died. Restarting Zygote!&quot;</span>);<br>      &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> pid;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>当system_server进程创建失败时，将会重启zygote进程。这里需要注意，对于Android 5.0以上系统，有两个zygote进程，分别是zygote、zygote64两个进程，system_server的父进程，一般来说64位系统其父进程是zygote64进程</p>
<ul>
<li>当kill system_server进程后，只重启zygote64和system_server，不重启zygote;</li>
<li>当kill zygote64进程后，只重启zygote64和system_server，也不重启zygote；</li>
<li>当kill zygote进程，则重启zygote、zygote64以及system_server。</li>
</ul>
<h3 id="2-14-com-android-internal-os-Zygote-ForkAndSpecializeCommon"><a href="#2-14-com-android-internal-os-Zygote-ForkAndSpecializeCommon" class="headerlink" title="2.14 com_android_internal_os_Zygote.ForkAndSpecializeCommon()"></a>2.14 com_android_internal_os_Zygote.ForkAndSpecializeCommon()</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-built_in">static</span> pid_t ForkAndSpecializeCommon(JNIEnv* env, uid_t uid, gid_t gid, jintArray javaGids,<br>                                     jint debug_flags, jobjectArray javaRlimits,<br>                                     jlong permittedCapabilities, jlong effectiveCapabilities,<br>                                     jint mount_external,<br>                                     jstring java_se_info, jstring java_se_name,<br>                                     <span class="hljs-keyword">bool</span> is_system_server, jintArray fdsToClose,<br>                                     jstring instructionSet, jstring dataDir) &#123;<br>  SetSigChldHandler(); <span class="hljs-comment">//设置子进程的signal信号处理函数</span><br>  pid_t pid = fork(); <span class="hljs-comment">//fork子进程</span><br>  <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">//进入子进程</span><br>    DetachDescriptors(env, fdsToClose); <span class="hljs-comment">//关闭并清除文件描述符</span><br><br>    <span class="hljs-keyword">if</span> (!is_system_server) &#123;<br>        <span class="hljs-comment">//对于非system_server子进程，则创建进程组</span><br>        <span class="hljs-keyword">int</span> rc = createProcessGroup(uid, getpid());<br>    &#125;<br>    SetGids(env, javaGids); <span class="hljs-comment">//设置设置group</span><br>    SetRLimits(env, javaRlimits); <span class="hljs-comment">//设置资源limit</span><br><br>    <span class="hljs-keyword">int</span> rc = setresgid(gid, gid, gid);<br>    rc = setresuid(uid, uid, uid);<br><br>    SetCapabilities(env, permittedCapabilities, effectiveCapabilities);<br>    SetSchedulerPolicy(env); <span class="hljs-comment">//设置调度策略</span><br><br>     <span class="hljs-comment">//selinux上下文</span><br>    rc = selinux_android_setcontext(uid, is_system_server, se_info_c_str, se_name_c_str);<br><br>    <span class="hljs-keyword">if</span> (se_info_c_str == <span class="hljs-literal">NULL</span> &amp;&amp; is_system_server) &#123;<br>      se_name_c_str = <span class="hljs-string">&quot;system_server&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (se_info_c_str != <span class="hljs-literal">NULL</span>) &#123;<br>      SetThreadName(se_name_c_str); <span class="hljs-comment">//设置线程名为system_server，方便调试</span><br>    &#125;<br>    UnsetSigChldHandler(); <span class="hljs-comment">//设置子进程的signal信号处理函数为默认函数</span><br>    <span class="hljs-comment">//等价于调用zygote.callPostForkChildHooks()</span><br>    env-&gt;CallStaticVoidMethod(gZygoteClass, gCallPostForkChildHooks, debug_flags,<br>                              is_system_server ? <span class="hljs-literal">NULL</span> : instructionSet);<br>    ...<br><br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">//进入父进程，即zygote进程</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> pid;<br>&#125;<br><br><span class="hljs-keyword">int</span> fork() &#123;<br>  __bionic_atfork_run_prepare(); <br><br>  pthread_internal_t* <span class="hljs-built_in">self</span> = __get_thread();<br><br>  <span class="hljs-comment">//fork期间，获取父进程pid，并使其缓存值无效</span><br>  pid_t parent_pid = <span class="hljs-built_in">self</span>-&gt;invalidate_cached_pid();<br>  <span class="hljs-comment">//系统调用</span><br>  <span class="hljs-keyword">int</span> result = syscall(__NR_clone, FORK_FLAGS, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;(<span class="hljs-built_in">self</span>-&gt;tid));<br>  <span class="hljs-keyword">if</span> (result == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-built_in">self</span>-&gt;set_cached_pid(gettid());<br>    __bionic_atfork_run_child(); <span class="hljs-comment">//fork完成执行子进程回调方法</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">self</span>-&gt;set_cached_pid(parent_pid);<br>    __bionic_atfork_run_parent(); <span class="hljs-comment">//fork完成执行父进程回调方法</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>到此system_server进程已完成了创建的所有工作，接下来开始了system_server进程的真正工作。在前面startSystemServer()方法中，zygote进程执行完forkSystemServer()后，新创建出来的system_server进程便进入handleSystemServerProcess()方法</p>
<h3 id="2-15-ZygoteInit-handleSystemServerProcess"><a href="#2-15-ZygoteInit-handleSystemServerProcess" class="headerlink" title="2.15 ZygoteInit.handleSystemServerProcess()"></a>2.15 ZygoteInit.handleSystemServerProcess()</h3><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> handleSystemServerProcess(<br>        ZygoteConnection.Arguments parsedArgs)<br>        <span class="hljs-keyword">throws</span> ZygoteInit.MethodAndArgsCaller &#123;<br><br>    closeServerSocket(); <span class="hljs-comment">//关闭父进程zygote复制而来的Socket</span><br><br>    Os.umask(S_IRWXG | S_IRWXO);<br><br>    <span class="hljs-keyword">if</span> (parsedArgs.niceName != <span class="hljs-keyword">null</span>) &#123;<br>        Process.setArgV0(parsedArgs.niceName); <span class="hljs-comment">//设置当前进程名为&quot;system_server&quot;</span><br>    &#125;<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> systemServerClasspath = Os.getenv(<span class="hljs-string">&quot;SYSTEMSERVERCLASSPATH&quot;</span>);<br>    <span class="hljs-keyword">if</span> (systemServerClasspath != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-comment">//执行dex优化操作</span><br>        performSystemServerDexOpt(systemServerClasspath);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (parsedArgs.invokeWith != <span class="hljs-keyword">null</span>) &#123;<br>        <span class="hljs-keyword">String</span>[] args = parsedArgs.remainingArgs;<br><br>        <span class="hljs-keyword">if</span> (systemServerClasspath != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">String</span>[] amendedArgs = <span class="hljs-keyword">new</span> <span class="hljs-keyword">String</span>[args.length + <span class="hljs-number">2</span>];<br>            amendedArgs[<span class="hljs-number">0</span>] = <span class="hljs-string">&quot;-cp&quot;</span>;<br>            amendedArgs[<span class="hljs-number">1</span>] = systemServerClasspath;<br>            System.arraycopy(parsedArgs.remainingArgs, <span class="hljs-number">0</span>, amendedArgs, <span class="hljs-number">2</span>, parsedArgs.remainingArgs.length);<br>        &#125;<br>        <span class="hljs-comment">//启动应用进程</span><br>        WrapperInit.execApplication(parsedArgs.invokeWith,<br>                parsedArgs.niceName, parsedArgs.targetSdkVersion,<br>                VMRuntime.getCurrentInstructionSet(), <span class="hljs-keyword">null</span>, args);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        ClassLoader cl = <span class="hljs-keyword">null</span>;<br>        <span class="hljs-keyword">if</span> (systemServerClasspath != <span class="hljs-keyword">null</span>) &#123;<br>            创建类加载器，并赋予当前线程<br>            cl = <span class="hljs-keyword">new</span> PathClassLoader(systemServerClasspath, ClassLoader.getSystemClassLoader());<br>            Thread.currentThread().setContextClassLoader(cl);<br>        &#125;<br><br>        <span class="hljs-comment">//system_server故进入此分支</span><br>        RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion, parsedArgs.remainingArgs, cl);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="2-16-RuntimeInit-zygoteInit"><a href="#2-16-RuntimeInit-zygoteInit" class="headerlink" title="2.16 RuntimeInit.zygoteInit()"></a>2.16 RuntimeInit.zygoteInit()</h3><p>源码位于frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public static final void zygote<span class="hljs-constructor">Init(<span class="hljs-params">int</span> <span class="hljs-params">targetSdkVersion</span>, String[] <span class="hljs-params">argv</span>, ClassLoader <span class="hljs-params">classLoader</span>)</span><br>        throws ZygoteInit.MethodAndArgsCaller &#123;<br><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Trace</span>.</span></span>trace<span class="hljs-constructor">Begin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">&quot;RuntimeInit&quot;</span>)</span>;<br>    redirect<span class="hljs-constructor">LogStreams()</span>; <span class="hljs-comment">//重定向log输出</span><br><br>    common<span class="hljs-constructor">Init()</span>; <span class="hljs-comment">// 通用的一些初始化</span><br>    native<span class="hljs-constructor">ZygoteInit()</span>; <span class="hljs-comment">// zygote初始化 </span><br>    application<span class="hljs-constructor">Init(<span class="hljs-params">targetSdkVersion</span>, <span class="hljs-params">argv</span>, <span class="hljs-params">classLoader</span>)</span>; <span class="hljs-comment">// 应用初始化</span><br>&#125;<br><br><span class="hljs-keyword">private</span> static final void common<span class="hljs-constructor">Init()</span> &#123;<br>    <span class="hljs-comment">// 设置默认的未捕捉异常处理方法</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Thread</span>.</span></span>set<span class="hljs-constructor">DefaultUncaughtExceptionHandler(<span class="hljs-params">new</span> UncaughtHandler()</span>);<br><br>    <span class="hljs-comment">// 设置市区，中国时区为&quot;Asia/Shanghai&quot;</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TimezoneGetter</span>.</span></span>set<span class="hljs-constructor">Instance(<span class="hljs-params">new</span> TimezoneGetter()</span> &#123;<br>        @Override<br>        public String get<span class="hljs-constructor">Id()</span> &#123;<br>            return <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SystemProperties</span>.</span></span>get(<span class="hljs-string">&quot;persist.sys.timezone&quot;</span>);<br>        &#125;<br>    &#125;);<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TimeZone</span>.</span></span>set<span class="hljs-constructor">Default(<span class="hljs-params">null</span>)</span>;<br><br>    <span class="hljs-comment">//重置log配置</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LogManager</span>.</span></span>get<span class="hljs-constructor">LogManager()</span>.reset<span class="hljs-literal">()</span>;<br>    <span class="hljs-keyword">new</span> <span class="hljs-constructor">AndroidConfig()</span>;<br><br>    <span class="hljs-comment">// 设置默认的HTTP User-agent格式( &quot;Dalvik/1.1.0 (Linux; U; Android 6.0.1；LenovoX3c70 Build/LMY47V)&quot;),用于 HttpURLConnection</span><br>    String userAgent = get<span class="hljs-constructor">DefaultUserAgent()</span>;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>set<span class="hljs-constructor">Property(<span class="hljs-string">&quot;http.agent&quot;</span>, <span class="hljs-params">userAgent</span>)</span>;<br><br>    <span class="hljs-comment">// 设置socket的tag，用于网络流量统计</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NetworkManagementSocketTagger</span>.</span></span>install<span class="hljs-literal">()</span>;<br>&#125;<br><br><span class="hljs-keyword">private</span> static void application<span class="hljs-constructor">Init(<span class="hljs-params">int</span> <span class="hljs-params">targetSdkVersion</span>, String[] <span class="hljs-params">argv</span>, ClassLoader <span class="hljs-params">classLoader</span>)</span><br>        throws ZygoteInit.MethodAndArgsCaller &#123;<br>    <span class="hljs-comment">//true代表应用程序退出时不调用AppRuntime.onExit()，否则会在退出前调用</span><br>    native<span class="hljs-constructor">SetExitWithoutCleanup(<span class="hljs-params">true</span>)</span>;<br><br>    <span class="hljs-comment">//设置虚拟机的内存利用率参数值为0.75</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">VMRuntime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span>.set<span class="hljs-constructor">TargetHeapUtilization(0.75f)</span>;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">VMRuntime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span>.set<span class="hljs-constructor">TargetSdkVersion(<span class="hljs-params">targetSdkVersion</span>)</span>;<br><br>    final Arguments args;<br>    <span class="hljs-keyword">try</span> &#123;<br>        args = <span class="hljs-keyword">new</span> <span class="hljs-constructor">Arguments(<span class="hljs-params">argv</span>)</span>; <span class="hljs-comment">//解析参数</span><br>    &#125; catch (IllegalArgumentException ex) &#123;<br>        return;<br>    &#125;<br><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Trace</span>.</span></span>trace<span class="hljs-constructor">End(Trace.TRACE_TAG_ACTIVITY_MANAGER)</span>;<br><br>    <span class="hljs-comment">//调用startClass的static方法 main() 此处args.startClass为”com.android.server.SystemServer”</span><br>    invoke<span class="hljs-constructor">StaticMain(<span class="hljs-params">args</span>.<span class="hljs-params">startClass</span>, <span class="hljs-params">args</span>.<span class="hljs-params">startArgs</span>, <span class="hljs-params">classLoader</span>)</span>;<br>&#125;<br><br><span class="hljs-keyword">private</span> static void invoke<span class="hljs-constructor">StaticMain(String <span class="hljs-params">className</span>, String[] <span class="hljs-params">argv</span>, ClassLoader <span class="hljs-params">classLoader</span>)</span><br>        throws ZygoteInit.MethodAndArgsCaller &#123;<br>    Class&lt;?&gt; cl = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span><span class="hljs-keyword">for</span><span class="hljs-constructor">Name(<span class="hljs-params">className</span>, <span class="hljs-params">true</span>, <span class="hljs-params">classLoader</span>)</span>;<span class="hljs-operator"></span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator"></span><br><span class="hljs-operator">    </span>Method m;<br>    <span class="hljs-keyword">try</span> &#123;<br>        m = cl.get<span class="hljs-constructor">Method(<span class="hljs-string">&quot;main&quot;</span>, <span class="hljs-params">new</span> Class[] &#123; String[].<span class="hljs-params">class</span> &#125;)</span>;<br>    &#125; catch (NoSuchMethodException ex) &#123;<span class="hljs-operator"></span><br><span class="hljs-operator">        ...</span><br><span class="hljs-operator">    </span>&#125; catch (SecurityException ex) &#123;<span class="hljs-operator"></span><br><span class="hljs-operator">        ...</span><br><span class="hljs-operator">    </span>&#125;<br><br>    <span class="hljs-comment">//通过抛出异常，回到ZygoteInit.main()。这样做好处是能清空栈帧，提高栈帧利用率</span><br>    throw <span class="hljs-keyword">new</span> ZygoteInit.<span class="hljs-constructor">MethodAndArgsCaller(<span class="hljs-params">m</span>, <span class="hljs-params">argv</span>)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>重点看最后一个方法，通过反射获取SystemServer类的main方法参数，然后抛出MethodAndArgsCaller异常；但是抛出异常后怎么弄呢，我们知道一个方法抛异常，会一直走到调用方法，直到一个方法捕获了异常，这里就是开头讲的，在ZygoteInit.main方法捕获了异常然后去执行</p>
<h3 id="2-17-ZygoteInit-main"><a href="#2-17-ZygoteInit-main" class="headerlink" title="2.17 ZygoteInit.main()"></a>2.17 ZygoteInit.main()</h3><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">String</span> argv[])</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (startSystemServer) &#123;<br>            <span class="hljs-built_in">startSystemServer</span>(abiList, socketName);<span class="hljs-comment">//启动system_server</span><br>        &#125;<br>    &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (MethodAndArgsCaller caller) &#123;<br>        caller.<span class="hljs-built_in">run</span>();<br>    &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (RuntimeException ex) &#123;<br>        <span class="hljs-built_in">closeServerSocket</span>();<br>        <span class="hljs-keyword">throw</span> ex;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>但是为啥没有直接在startSystemServer()或者上面的方法中直接调用SystemServer类的main方法，而是通过抛异常的方式处理呢？</p>
<p>我们知道，当一个函数抛出异常后，这个异常会依次传递给调用它的函数，直到这个异常被捕获，如果这个异常一直没有被处理，最终就会引起程序的崩溃。</p>
<p>程序都是由一个个函数组成的(除了汇编程序)，c/c++/java/…等高级语言编写的应用程序，在执行的时候，他们都拥有自己的栈空间（是一种先进后出的内存区域），用于存放函数的返回地址和函数的临时数据，每调用一个函数时，就会把函数的返回地址和相关数据压入栈中，当一个函数执行完后，就会从栈中弹出，cpu会根据函数的返回地址，执行上一个调用函数的下一条指令。</p>
<p>所以，在抛出异常后，如果异常没有在当前的函数中捕获，那么当前的函数执行就会异常的退出，从应用程序的栈弹出，并将这个异常传递给上一个函数，直到异常被捕获处理，否则，就会引起程序的崩溃。</p>
<p>因此，这里通过抛异常的方式启动主要是清理应用程序栈中ZygoteInit.main以上的函数栈帧，以实现当相应的main函数退出时，能直接退出整个应用程序</p>
<h3 id="2-18-ZygoteInit-MethodAndArgsCaller-run"><a href="#2-18-ZygoteInit-MethodAndArgsCaller-run" class="headerlink" title="2.18 ZygoteInit.MethodAndArgsCaller.run()"></a>2.18 ZygoteInit.MethodAndArgsCaller.run()</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MethodAndArgsCaller</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Exception</span></span><br><span class="hljs-class">            <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;<br>        <span class="hljs-comment">/** 调用的方法 在上面的方法可知是main方法 */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Method mMethod;<br><br>        <span class="hljs-comment">/** 参数列表 */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span>[] mArgs;<br><br>        <span class="hljs-keyword">public</span> MethodAndArgsCaller(Method method, <span class="hljs-keyword">String</span>[] args) &#123;<br>            mMethod = method;<br>            mArgs = args;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> run() &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                mMethod.invoke(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-keyword">Object</span>[] &#123; mArgs &#125;);<br>            &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException ex) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(ex);<br>            &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException ex) &#123;<br>                <span class="hljs-built_in">Throwable</span> cause = ex.getCause();<br>                <span class="hljs-keyword">if</span> (cause <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">RuntimeException</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> (<span class="hljs-built_in">RuntimeException</span>) cause;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cause <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Error</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> (<span class="hljs-built_in">Error</span>) cause;<br>                &#125;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(ex);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>可以看到这里根据传递过来的参数，可知此处通过反射机制调用的是SystemServer.main()方法；到此，总算是进入到了SystemServer类的main()方法</p>
<h3 id="2-19-SystemServer-main"><a href="#2-19-SystemServer-main" class="headerlink" title="2.19 SystemServer.main()"></a>2.19 SystemServer.main()</h3><p>源码位于 frameworks/base/services/java/com/android/server/SystemServer.java </p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">String</span>[] args)</span> </span>&#123;<br>        <span class="hljs-keyword">new</span> <span class="hljs-built_in">SystemServer</span>().<span class="hljs-built_in">run</span>();<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>           	<span class="hljs-comment">//如果系统时间比1970年早，那就设置为1970</span><br>            <span class="hljs-keyword">if</span> (System.<span class="hljs-built_in">currentTimeMillis</span>() &lt; EARLIEST_SUPPORTED_TIME) &#123;<br>                SystemClock.<span class="hljs-built_in">setCurrentTimeMillis</span>(EARLIEST_SUPPORTED_TIME);<br>            &#125;<br><br>            <span class="hljs-comment">//变更虚拟机的库文件，对于Android 6.0默认采用的是libart.so</span><br>            SystemProperties.<span class="hljs-built_in">set</span>(<span class="hljs-string">&quot;persist.sys.dalvik.vm.lib.2&quot;</span>, VMRuntime.<span class="hljs-built_in">getRuntime</span>().<span class="hljs-built_in">vmLibrary</span>());<br><br>            <span class="hljs-comment">//清除vm内存增长上限，由于启动过程需要较多的虚拟机内存空间</span><br>            VMRuntime.<span class="hljs-built_in">getRuntime</span>().<span class="hljs-built_in">clearGrowthLimit</span>();<br><br>            <span class="hljs-comment">//设置内存的可能有效使用率为0.8</span><br>            VMRuntime.<span class="hljs-built_in">getRuntime</span>().<span class="hljs-built_in">setTargetHeapUtilization</span>(<span class="hljs-number">0.8f</span>);<br><br>            <span class="hljs-comment">// 针对部分设备依赖于运行时就产生指纹信息，因此需要在开机完成前已经定义</span><br>            Build.<span class="hljs-built_in">ensureFingerprintProperty</span>();<br><br>            <span class="hljs-comment">//访问环境变量前，需要明确地指定用户</span><br>            Environment.<span class="hljs-built_in">setUserRequired</span>(<span class="hljs-literal">true</span>);<br><br>            <span class="hljs-comment">// Within the system server, any incoming Bundles should be defused</span><br>            <span class="hljs-comment">// to avoid throwing BadParcelableException.</span><br>            BaseBundle.<span class="hljs-built_in">setShouldDefuse</span>(<span class="hljs-literal">true</span>);<br><br>            <span class="hljs-comment">//确保当前系统进程的binder调用，总是运行在前台优先级(foreground priority)</span><br>            BinderInternal.<span class="hljs-built_in">disableBackgroundScheduling</span>(<span class="hljs-literal">true</span>);<br><br>            <span class="hljs-comment">// 增加system_server中的binder线程数</span><br>            BinderInternal.<span class="hljs-built_in">setMaxThreads</span>(sMaxBinderThreads);<br><br>            <span class="hljs-comment">// 创建主线程looper 在当前线程运行</span><br>            android.os.<span class="hljs-built_in">Process</span>.<span class="hljs-built_in">setThreadPriority</span>(<br>                android.os.<span class="hljs-built_in">Process</span>.THREAD_PRIORITY_FOREGROUND);<br>            android.os.<span class="hljs-built_in">Process</span>.<span class="hljs-built_in">setCanSelfBackground</span>(<span class="hljs-literal">false</span>);<br>            Looper.<span class="hljs-built_in">prepareMainLooper</span>();<br><br>            <span class="hljs-comment">//初始化android_servers库</span><br>            System.<span class="hljs-built_in">loadLibrary</span>(<span class="hljs-string">&quot;android_servers&quot;</span>);<br><br>            <span class="hljs-comment">//检测上次关机过程是否失败</span><br>            <span class="hljs-built_in">performPendingShutdown</span>();<br><br>            <span class="hljs-comment">//初始化系统上下文</span><br>            <span class="hljs-comment">//初始化系统上下文对象mSystemContext，并设置默认的主题,mSystemContext实际上是一个ContextImpl对象。</span><br>            <span class="hljs-comment">//调用ActivityThread.systemMain()的时候，会调用ActivityThread.attach(true)，而在attach()里面，则创建了Application对象，并调用了Application.onCreate()。</span><br>            <span class="hljs-built_in">createSystemContext</span>();<br><br>            <span class="hljs-comment">//创建系统服务管理</span><br>            mSystemServiceManager = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SystemServiceManager</span>(mSystemContext);<br>            LocalServices.<span class="hljs-built_in">addService</span>(SystemServiceManager.class, mSystemServiceManager);<br>        &#125; finally &#123;<br>            Trace.<span class="hljs-built_in">traceEnd</span>(Trace.TRACE_TAG_SYSTEM_SERVER);<br>        &#125;<br><br>        <span class="hljs-comment">//启动各种系统服务</span><br>        <span class="hljs-keyword">try</span> &#123;<br>	        <span class="hljs-comment">//引导服务</span><br>            <span class="hljs-built_in">startBootstrapServices</span>();<br>            <span class="hljs-comment">//核心服务</span><br>            <span class="hljs-built_in">startCoreServices</span>();<br>            <span class="hljs-comment">//其它服务</span><br>            <span class="hljs-built_in">startOtherServices</span>();<br>        &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (Throwable ex) &#123;<br>            <span class="hljs-keyword">throw</span> ex;<br>        &#125; finally &#123;<br>            Trace.<span class="hljs-built_in">traceEnd</span>(Trace.TRACE_TAG_SYSTEM_SERVER);<br>        &#125;<br><br>        <span class="hljs-comment">//开启消息循环</span><br>        Looper.<span class="hljs-built_in">loop</span>();<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">&quot;Main thread loop unexpectedly exited&quot;</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>至此system_server已启动完成,大致流程如下:</p>
<ol>
<li>zygote进程通过Zygote.forkSystemServer —&gt; fork.fork()创建system server进程</li>
<li>调用ZygoteInit.handleSystemServerProcess方法设置当前进程名为”system_server”，执行dex优化操作，一些属性的初始化，设置binder线程</li>
<li>通过抛出MethodAndArgsCaller异常，回到ZygoteInit.main()，在try catch中执行MethodAndArgsCaller.run；在这里通过反射执行SystemServer.main()方法</li>
<li>在SystemServer.run方法中做一些设置，比如初始化系统上下文 ，创建SystemServiceManager，启动引导服务，启动核心服务，启动其他服务</li>
<li>最后调用Looper.loop()，不断的从消息队列取出消息处理(Looper#loop()方法中调用的是MessageQueue#next()，该方法中使用死循环 + Linuxepoll机制持续运行程序)</li>
</ol>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs mipsasm">system server进程和zygote进程可以说是<span class="hljs-keyword">Android世界中的两大最重要的进程，离开其中之一基本上系统就玩完了；基本上在Java </span>Framework中的大多数服务都是在system server进程中一个线程的方式存在的，如下：<br><br>EntropyService 提供伪随机数<br>PowerManagerService 电源管理服务<br>ActivityManagerService 最核心的服务之一，管理 四大组件<br>TelephonyRegistry 通过该服务注册电话模块的事件响应，比如重启、关闭、启动等<br>PackageManagerService 程序包管理服务<br>AccountManagerService 账户管理服务，是指联系人账户，而不是 Linux 系统的账户<br>ContentService ContentProvider 服务，提供跨进程数据交换<br><span class="hljs-keyword">BatteryService </span>电池管理服务<br>LightsService 自然光强度感应传感器服务<br>VibratorService 震动器服务<br>AlarmManagerService 定时器管理服务，提供定时提醒服务<br>WindowManagerService Framework 最核心的服务之一，负责窗口管理<br><span class="hljs-keyword">BluetoothService </span>蓝牙服务<br>DevicePolicyManagerService 提供一些系统级别的设置及属性<br>StatusBarManagerService 状态栏管理服务<br>ClipboardService 系统剪切板服务<br>InputMethodManagerService 输入法管理服务<br>NetStatService 网络状态服务<br>NetworkManagementService 网络管理服务<br>ConnectivityService 网络连接管理服务<br>ThrottleService 暂不清楚其作用<br>AccessibilityManagerService 辅助管理程序截获所有的用户输入，并根据这些输入给用户一些额外的反馈，起到辅助的效果<br>MountService 挂载服务，可通过该服务调用 Linux 层面的 mount 程序<br>NotificationManagerService 通知栏管理服务， <span class="hljs-keyword">Android </span>中的通知栏和状态栏在一起，只是界面上前者在左边，后者在右边<br>DeviceStorageMonitorService 磁盘空间状态检测服务<br>LocationManagerService 地理位置服务<br>SearchManagerService 搜索管理服务<br>DropBoxManagerService 通过该服务访问 Linux 层面的 Dropbox 程序<br>WallpaperManagerService 墙纸管理服务，墙纸不等同于桌面背景，在 View 系统内部，墙纸可以作为任何窗口的背景<br>AudioService 音频管理服务<br><span class="hljs-keyword">BackupManagerService </span>系统备份服务<br>AppWidgetService Widget 服务<br>RecognitionManagerService 身份识别服务<br><span class="hljs-keyword">DiskStatsService </span>磁盘统计服务<br></code></pre></td></tr></table></figure>



<h3 id="2-20-ZygoteInit-runSelectLoop"><a href="#2-20-ZygoteInit-runSelectLoop" class="headerlink" title="2.20 ZygoteInit.runSelectLoop()"></a>2.20 ZygoteInit.runSelectLoop()</h3><p>在2.9中ZygoteInit.main()方法开启system_server后，执行runSelectLoop()方法，进入循环监听事件</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> runSelectLoop(<span class="hljs-keyword">String</span> abiList) <span class="hljs-keyword">throws</span> MethodAndArgsCaller &#123;<br>    ArrayList&lt;FileDescriptor&gt; fds = <span class="hljs-keyword">new</span> ArrayList&lt;FileDescriptor&gt;();<br>    ArrayList&lt;ZygoteConnection&gt; peers = <span class="hljs-keyword">new</span> ArrayList&lt;ZygoteConnection&gt;();<br>    <span class="hljs-comment">//sServerSocket是socket通信中的服务端，即zygote进程。保存到fds[0]</span><br>    fds.<span class="hljs-built_in">add</span>(sServerSocket.getFileDescriptor());<br>    peers.<span class="hljs-built_in">add</span>(<span class="hljs-keyword">null</span>);<br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>        StructPollfd[] pollFds = <span class="hljs-keyword">new</span> StructPollfd[fds.<span class="hljs-built_in">size</span>()];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; pollFds.length; ++i) &#123;<br>            pollFds[i] = <span class="hljs-keyword">new</span> StructPollfd();<br>            pollFds[i].fd = fds.<span class="hljs-built_in">get</span>(i);<br>            pollFds[i].events = (<span class="hljs-keyword">short</span>) POLLIN;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>             <span class="hljs-comment">//处理轮询状态，当pollFds有事件到来则往下执行，否则阻塞在这里</span><br>            Os.poll(pollFds, <span class="hljs-number">-1</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ErrnoException ex) &#123;<br>            ...<br>        &#125;<br>        <br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = pollFds.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; --i) &#123;<br>            <span class="hljs-comment">//采用I/O多路复用机制，当接收到客户端发出连接请求 或者数据处理请求到来，则往下执行；</span><br>            <span class="hljs-comment">// 否则进入continue，跳出本次循环。</span><br>            <span class="hljs-keyword">if</span> ((pollFds[i].revents &amp; POLLIN) == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">//即fds[0]，代表的是sServerSocket，则意味着有客户端连接请求；</span><br>                <span class="hljs-comment">// 则创建ZygoteConnection对象,并添加到fds。</span><br>                ZygoteConnection newPeer = acceptCommandPeer(abiList);<br>                peers.<span class="hljs-built_in">add</span>(newPeer);<br>                fds.<span class="hljs-built_in">add</span>(newPeer.getFileDesciptor()); <span class="hljs-comment">//添加到fds.</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//i&gt;0，则代表通过socket接收来自对端的数据，并执行相应操作</span><br>                <span class="hljs-built_in">boolean</span> done = peers.<span class="hljs-built_in">get</span>(i).runOnce();<br>                <span class="hljs-keyword">if</span> (done) &#123;<br>                    peers.remove(i);<br>                    fds.remove(i); <span class="hljs-comment">//处理完则从fds中移除该文件描述符</span><br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>


<h3 id="2-21-ZygoteInit-acceptCommandPeer"><a href="#2-21-ZygoteInit-acceptCommandPeer" class="headerlink" title="2.21 ZygoteInit.acceptCommandPeer"></a>2.21 ZygoteInit.acceptCommandPeer</h3><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ZygoteConnection <span class="hljs-function"><span class="hljs-title">acceptCommandPeer</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> abiList</span>)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ZygoteConnection(sServerSocket.accept(), abiList);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>        ...<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="2-22-ZygoteConnection-runOnce"><a href="#2-22-ZygoteConnection-runOnce" class="headerlink" title="2.22 ZygoteConnection.runOnce"></a>2.22 ZygoteConnection.runOnce</h3><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">boolean</span> runOnce() <span class="hljs-keyword">throws</span> ZygoteInit.MethodAndArgsCaller &#123;<br><br>    String args[];<br>    Arguments parsedArgs = <span class="hljs-keyword">null</span>;<br>    FileDescriptor[] descriptors;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//读取socket客户端发送过来的参数列表</span><br>        args = readArgumentList();<br>        descriptors = mSocket.getAncillaryFileDescriptors();<br>    &#125; <span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>        ...<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>    &#125;<br>    ...<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//将binder客户端传递过来的参数，解析成Arguments对象格式</span><br>        parsedArgs = <span class="hljs-keyword">new</span> Arguments(args);<br>        ...<br>        pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids,<br>                parsedArgs.debugFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo,<br>                parsedArgs.niceName, fdsToClose, parsedArgs.instructionSet,<br>                parsedArgs.appDataDir);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">//子进程执行</span><br>            IoUtils.closeQuietly(serverPipeFd);<br>            serverPipeFd = <span class="hljs-keyword">null</span>;<br>            <span class="hljs-comment">//进入子进程流程</span><br>            handleChildProc(parsedArgs, descriptors, childPipeFd, newStderr);<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//父进程执行</span><br>            IoUtils.closeQuietly(childPipeFd);<br>            childPipeFd = <span class="hljs-keyword">null</span>;<br>            <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">handleParentProc</span><span class="hljs-params">(pid, descriptors, serverPipeFd, parsedArgs)</span></span>;<br>        &#125;<br>    &#125; <span class="hljs-keyword">finally</span> &#123;<br>        IoUtils.closeQuietly(childPipeFd);<br>        IoUtils.closeQuietly(serverPipeFd);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>至此Zygote启动完成，开启循环<br>接收客户端发送过来的connect()操作，Zygote作为服务端执行accept()操作。 再后面客户端调用write()写数据，Zygote进程调用read()读数据。</p>
<p>没有连接请求时会进入休眠状态，当有创建新进程的连接请求时，唤醒Zygote进程，创建Socket通道ZygoteConnection，然后执行ZygoteConnection的runOnce()方法。</p>
<p>Zygote启动流程如下:</p>
<ol>
<li>解析init.zygote64_32.rc中的参数，创建AppRuntime并调用AppRuntime.start()方法</li>
<li>调用AndroidRuntime的startVM()方法创建虚拟机，再调用startReg()注册JNI函数</li>
<li>通过JNI方式调用ZygoteInit.main()，第一次进入Java世界</li>
<li>registerZygoteSocket()建立socket通道，zygote作为通信的服务端，用于响应客户端请求</li>
<li>preload()预加载通用类、drawable和color资源、openGL以及共享库以及WebView，用于提高app启动效率</li>
<li>通过startSystemServer()，fork得力帮手system_server进程，也是Java Framework的运行载体</li>
<li>调用runSelectLoop()，随时待命，当接收到请求创建新进程请求时立即唤醒并执行相应工作</li>
</ol>
<h2 id="3-Zygote进程是如何fork一个APP进程的"><a href="#3-Zygote进程是如何fork一个APP进程的" class="headerlink" title="3. Zygote进程是如何fork一个APP进程的"></a>3. Zygote进程是如何fork一个APP进程的</h2><p>创建一个线程大家肯定非常熟悉了，继承Thread，实现Runnable接口或者Callable接口；但是线程没有独立的地址空间，而是与所在进程共享内存，其实从Linux角度看，进程线程都是一个task_struct结构体，除了是否共享资源外，并没有其他本质的区别。</p>
<p>但是创建进程可能就没有那么熟悉了，每个APP可能运行在一个进程，也可能在多个进程，这些进程拥有自己独立的资源；然而这些进程都是由Zygote进程fork出来的，再往前一步其实是system server进程使用LocalSocket去通知zygote进程，然后zygote去fork一个子进程，也就是APP进程（更往前一步就是APP进程使用Binder机制去通知system server进程中的ActivityManagerService），注意这里是子进程，不是子线程</p>
<p>大体流程：</p>
<ol>
<li><p>app_process作为zygote server通过local socket处理进程创建请求，zygote server是在ZygoteInit.main函数里调用ZygoteInit.runSelectLoop监听。</p>
</li>
<li><p>接收到zygote client的fork请求之后，调用ZygoteConnection.runOnce，调用Zygote.forkAndSpecialize创建新进程</p>
</li>
<li><p>进程创建之后，由ZygoteConnection.handleParentProc来初始化进程，最终会调用ActivityThread.main函数</p>
</li>
<li><p>ActivityThread.main -&gt; ActivityThread.attach -&gt;  ActivityThread.bindApplication -&gt; Activity.handleBindApplication，handleBindApplication会初始化BaseDexClassLoader。</p>
</li>
<li><p>类的加载经过了ClassLoader.loadClass-&gt;BaseDexClassLoader.findClass-&gt;DexPathList.findClass-&gt;DexFile.loadClassBinaryName-&gt;DexFile.defineClassNative-&gt;DexFile_defineClassNative(art/runtime/native/dalvik_system_DexFile.cc)<br>这个初始化过程，art和dalvik都是一样的。art的DexFile_defineClassNative由ClassLinker的DefineClass来加载类。</p>
</li>
</ol>
<h3 id="3-1-APP进程创建流程"><a href="#3-1-APP进程创建流程" class="headerlink" title="3.1 APP进程创建流程"></a>3.1 APP进程创建流程</h3><ol>
<li>不管从桌面启动应用还是应用内启动其它应用，如果这个应用所在进程不存在的话，都需要发起进程通过Binder机制告诉system server进程的AMS</li>
<li>system server进程的AMS调用Process.start()方法，通过socket向zygote进程发送创建新进程的请求</li>
<li>在zygote进程的ZygoteInit.main方法中，有一个runSelectLoop循环体，通过acceptCommandPeer方法获取链接过来的客户端，再通过runOnce方法去创建进程</li>
<li>新的进程执行handleChildProc方法，最后通过反射调用ActivityThread.main()方法，这样一个新的APP进程就创建完成了</li>
</ol>
 <img src="/2021/08/23/android%E5%BC%80%E6%9C%BA%E5%90%8E%E9%83%BD%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/images/APP%E8%BF%9B%E7%A8%8B%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B.png" srcset="/img/loading.gif" lazyload class="">

<h3 id="3-2-APP启动第三方应用"><a href="#3-2-APP启动第三方应用" class="headerlink" title="3.2 APP启动第三方应用"></a>3.2 APP启动第三方应用</h3><h4 id="3-2-1-startActivity"><a href="#3-2-1-startActivity" class="headerlink" title="3.2.1 startActivity"></a>3.2.1 startActivity</h4><p>当你在桌面启动一个应用或者在一个APP内启动一个应用，本质都是一样的，因为Android手机桌面其实就是一个APP（这点可参考Android之Activity启动流程源码深入解析），两种方式经过层层调用之后都会走到ActivityStackSupervisor.startSpecificActivityLocked方法，判断如果对方进程不存在，就需要去创建一个进程</p>
<h4 id="3-2-2-startService"><a href="#3-2-2-startService" class="headerlink" title="3.2.2 startService"></a>3.2.2 startService</h4><p>调用startService启动一个服务，该方法经过层层调用最终会走到ActiveServices.bringUpServiceLocked方法，如果判断对方进程不存在也会去创建一个新进程</p>
<h4 id="3-2-3-sendBroadcast"><a href="#3-2-3-sendBroadcast" class="headerlink" title="3.2.3 sendBroadcast"></a>3.2.3 sendBroadcast</h4><p>调用sendBroadcast方法去发送一个广播，经过层层调用后走到BroadcastQueue.processNextBroadcast方法，也会判断BroadcastReceiver所在进程不存在就需要去创建进程</p>
<h4 id="3-2-4-ContentResolver-query"><a href="#3-2-4-ContentResolver-query" class="headerlink" title="3.2.4 ContentResolver.query"></a>3.2.4 ContentResolver.query</h4><p>在ContentProvider的处理过程中，ContentResolver.query方法经过层层调用会走到ActivityManagerService.getContentProviderImpl方法，判断ContentProvider所在的进程不存在就会创建新进程</p>
<h3 id="3-3-System-Server请求创建进程"><a href="#3-3-System-Server请求创建进程" class="headerlink" title="3.3 System Server请求创建进程"></a>3.3 System Server请求创建进程</h3><p>ActivityManagerService简称为AMS</p>
<p>上述四种途径最终都会走到AMS.startProcessLocked()方法</p>
<h4 id="3-3-1-AMS-startProcessLocked"><a href="#3-3-1-AMS-startProcessLocked" class="headerlink" title="3.3.1 AMS.startProcessLocked()"></a>3.3.1 AMS.startProcessLocked()</h4><p>源码位于frameworks/base/services/core/java/com/android/server/am/ActivityManagerService.java</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">final</span> ProcessRecord startProcessLocked(<span class="hljs-keyword">String</span> processName,<br>            ApplicationInfo info, <span class="hljs-built_in">boolean</span> knownToBeDead, <span class="hljs-built_in">int</span> intentFlags,<br>            <span class="hljs-keyword">String</span> hostingType, ComponentName hostingName, <span class="hljs-built_in">boolean</span> allowWhileBooting,<br>            <span class="hljs-built_in">boolean</span> isolated, <span class="hljs-built_in">boolean</span> keepIfLarge) &#123;<br>        <span class="hljs-keyword">return</span> startProcessLocked(processName, info, knownToBeDead, intentFlags, hostingType,<br>                hostingName, allowWhileBooting, isolated, <span class="hljs-number">0</span> <span class="hljs-comment">/* isolatedUid */</span>, keepIfLarge,<br>                <span class="hljs-keyword">null</span> <span class="hljs-comment">/* ABI override */</span>, <span class="hljs-keyword">null</span> <span class="hljs-comment">/* entryPoint */</span>, <span class="hljs-keyword">null</span> <span class="hljs-comment">/* entryPointArgs */</span>,<br>                <span class="hljs-keyword">null</span> <span class="hljs-comment">/* crashHandler */</span>);<br>&#125;<br>    <br><span class="hljs-keyword">final</span> ProcessRecord startProcessLocked(<span class="hljs-keyword">String</span> processName, ApplicationInfo info,<br>            <span class="hljs-built_in">boolean</span> knownToBeDead, <span class="hljs-built_in">int</span> intentFlags, <span class="hljs-keyword">String</span> hostingType, ComponentName hostingName,<br>            <span class="hljs-built_in">boolean</span> allowWhileBooting, <span class="hljs-built_in">boolean</span> isolated, <span class="hljs-built_in">int</span> isolatedUid, <span class="hljs-built_in">boolean</span> keepIfLarge,<br>            <span class="hljs-keyword">String</span> abiOverride, <span class="hljs-keyword">String</span> entryPoint, <span class="hljs-keyword">String</span>[] entryPointArgs, Runnable crashHandler) &#123;<br>        <span class="hljs-keyword">long</span> startTime = SystemClock.elapsedRealtime();<br>        ProcessRecord app;<br>        <span class="hljs-comment">//不处于孤立进程</span><br>        <span class="hljs-keyword">if</span> (!isolated) &#123;<br>        	<span class="hljs-comment">//根据进程名和进程uid获取进程对应的ProcessRecord</span><br>        	<span class="hljs-comment">//ProcessRecord封装了正在运行的进程的完整信息</span><br>            app = getProcessRecordLocked(processName, info.uid, keepIfLarge);<br>            checkTime(startTime, <span class="hljs-string">&quot;startProcess: after getProcessRecord&quot;</span>);<br><br>            <span class="hljs-keyword">if</span> ((intentFlags &amp; Intent.FLAG_FROM_BACKGROUND) != <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// 如果当前进程处于后台进程，就判断是否在Bad进程列表</span><br>                <span class="hljs-keyword">if</span> (mAppErrors.isBadProcessLocked(info)) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// 如果用户明确启动该进程，则清除其crash计数，保证其不处于Bad进程列表，直到下次再弹出crash框</span><br>                mAppErrors.resetProcessCrashTimeLocked(info);<br>                <span class="hljs-keyword">if</span> (mAppErrors.isBadProcessLocked(info)) &#123;<br>                    EventLog.writeEvent(EventLogTags.AM_PROC_GOOD,<br>                            UserHandle.getUserId(info.uid), info.uid,<br>                            info.processName);<br>                    mAppErrors.clearBadProcessLocked(info);<br>                    <span class="hljs-keyword">if</span> (app != <span class="hljs-keyword">null</span>) &#123;<br>                        app.bad = <span class="hljs-keyword">false</span>;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 如果是孤立进程，就没办法重用已存在的进程</span><br>            app = <span class="hljs-keyword">null</span>;<br>        &#125;<br><br>		......<br><br>		<span class="hljs-comment">//当ProcessRecord已经存在；</span><br>		<span class="hljs-comment">//并且调用者不认为进程已经死亡，或者没有thread对象依附到该进程，这样我们就知道他不会crash；</span><br>		<span class="hljs-comment">//该进程已经分配了pid，说明它正在启动或正在运行</span><br>		<span class="hljs-comment">//这些情况下我们不需要做什么，直接返回</span><br>        <span class="hljs-keyword">if</span> (app != <span class="hljs-keyword">null</span> &amp;&amp; app.pid &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">if</span> ((!knownToBeDead &amp;&amp; !app.killed) || app.thread == <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-comment">//我们已经启动了这个app，或者正在等待它启动（分配了pid但是没有thread依附），就keep it</span><br>                <span class="hljs-comment">// 如果这是该进程中的一个新的package，那就添加到package列表</span><br>                app.addPackage(info.packageName, info.versionCode, mProcessStats);<br>                checkTime(startTime, <span class="hljs-string">&quot;startProcess: done, added package to proc&quot;</span>);<br>                <span class="hljs-keyword">return</span> app;<br>            &#125;<br><br>            <span class="hljs-comment">// 如果ProcessRecord已经attach到先前的进程，那就清除它</span><br>            checkTime(startTime, <span class="hljs-string">&quot;startProcess: bad proc running, killing&quot;</span>);<br>            killProcessGroup(app.uid, app.pid);<br>            handleAppDiedLocked(app, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">true</span>);<br>            checkTime(startTime, <span class="hljs-string">&quot;startProcess: done killing old proc&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-keyword">String</span> hostingNameStr = hostingName != <span class="hljs-keyword">null</span><br>                ? hostingName.flattenToShortString() : <span class="hljs-keyword">null</span>;<br><br>        <span class="hljs-keyword">if</span> (app == <span class="hljs-keyword">null</span>) &#123;<br>            checkTime(startTime, <span class="hljs-string">&quot;startProcess: creating new process record&quot;</span>);<br>            <span class="hljs-comment">// 创建新的Process Record对象</span><br>            app = newProcessRecordLocked(info, processName, isolated, isolatedUid);<br>            <span class="hljs-keyword">if</span> (app == <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>            &#125;<br>            app.crashHandler = crashHandler;<br>            checkTime(startTime, <span class="hljs-string">&quot;startProcess: done creating new process record&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 如果这是该进程中的一个新的package，那就添加到package列表</span><br>            app.addPackage(info.packageName, info.versionCode, mProcessStats);<br>            checkTime(startTime, <span class="hljs-string">&quot;startProcess: added package to existing proc&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 如果系统还没有准备就绪，那就暂停该进程启动，将当前进程加入到mProcessesOnHold，直到准备就绪</span><br>        <span class="hljs-keyword">if</span> (!mProcessesReady<br>                &amp;&amp; !isAllowedWhileBooting(info)<br>                &amp;&amp; !allowWhileBooting) &#123;<br>            <span class="hljs-keyword">if</span> (!mProcessesOnHold.contains(app)) &#123;<br>                mProcessesOnHold.<span class="hljs-built_in">add</span>(app);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (DEBUG_PROCESSES) Slog.v(TAG_PROCESSES,<br>                    <span class="hljs-string">&quot;System not ready, putting on hold: &quot;</span> + app);<br>            checkTime(startTime, <span class="hljs-string">&quot;startProcess: returning with proc on hold&quot;</span>);<br>            <span class="hljs-keyword">return</span> app;<br>        &#125;<br><br>        checkTime(startTime, <span class="hljs-string">&quot;startProcess: stepping in to startProcess&quot;</span>);<br>        startProcessLocked(<br>                app, hostingType, hostingNameStr, abiOverride, entryPoint, entryPointArgs);<br>        checkTime(startTime, <span class="hljs-string">&quot;startProcess: done starting proc!&quot;</span>);<br>        <span class="hljs-keyword">return</span> (app.pid != <span class="hljs-number">0</span>) ? app : <span class="hljs-keyword">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>经过上面重重判断后决定需要创建进程，继续走到startProcessLocked方法，这个方法在AMS里有4个重载的方法</p>
<p>其中的hostingType参数有”activity”,”service”,”broadcast”,”content provider”四个值<br>hostingNameStr数据类型为ComponentName,封装了组件的包名和自己的路径</p>
<h4 id="3-3-2-继续调用AMS-startProcessLocked"><a href="#3-3-2-继续调用AMS-startProcessLocked" class="headerlink" title="3.3.2 继续调用AMS.startProcessLocked()"></a>3.3.2 继续调用AMS.startProcessLocked()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">startProcessLocked</span><span class="hljs-params">(ProcessRecord app, <span class="hljs-keyword">String</span> hostingType,</span></span><br><span class="hljs-params"><span class="hljs-function">            <span class="hljs-keyword">String</span> hostingNameStr, <span class="hljs-keyword">String</span> abiOverride, <span class="hljs-keyword">String</span> entryPoint, <span class="hljs-keyword">String</span>[] entryPointArgs)</span> </span>&#123;<br>        <span class="hljs-keyword">long</span> startTime = SystemClock.<span class="hljs-built_in">elapsedRealtime</span>();<br>        <span class="hljs-comment">//当app的pid大于0且不是当前进程的pid，则从mPidsSelfLocked中移除该app.pid</span><br>        <span class="hljs-keyword">if</span> (app.pid &gt; <span class="hljs-number">0</span> &amp;&amp; app.pid != MY_PID) &#123;<br>            <span class="hljs-built_in">checkTime</span>(startTime, <span class="hljs-string">&quot;startProcess: removing from pids map&quot;</span>);<br>            <span class="hljs-built_in">synchronized</span> (mPidsSelfLocked) &#123;<br>                mPidsSelfLocked.<span class="hljs-built_in">remove</span>(app.pid);<br>                mHandler.<span class="hljs-built_in">removeMessages</span>(PROC_START_TIMEOUT_MSG, app);<br>            &#125;<br>            <span class="hljs-built_in">checkTime</span>(startTime, <span class="hljs-string">&quot;startProcess: done removing from pids map&quot;</span>);<br>            app.<span class="hljs-built_in">setPid</span>(<span class="hljs-number">0</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//从mProcessesOnHold移除该app</span><br>        mProcessesOnHold.<span class="hljs-built_in">remove</span>(app);<br><br>        <span class="hljs-built_in">checkTime</span>(startTime, <span class="hljs-string">&quot;startProcess: starting to update cpu stats&quot;</span>);<br>        <span class="hljs-built_in">updateCpuStats</span>();<br>        <span class="hljs-built_in">checkTime</span>(startTime, <span class="hljs-string">&quot;startProcess: done updating cpu stats&quot;</span>);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> userId = UserHandle.<span class="hljs-built_in">getUserId</span>(app.uid);<br>                AppGlobals.<span class="hljs-built_in">getPackageManager</span>().<span class="hljs-built_in">checkPackageStartable</span>(app.info.packageName, userId);<br>                <span class="hljs-comment">//当前package已被冻结,则抛出异常</span><br>            &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (RemoteException e) &#123;<br>                <span class="hljs-keyword">throw</span> e.<span class="hljs-built_in">rethrowAsRuntimeException</span>();<br>            &#125;<br><br>            <span class="hljs-keyword">int</span> uid = app.uid;<br>            <span class="hljs-keyword">int</span>[] gids = null;<br>            <span class="hljs-keyword">int</span> mountExternal = Zygote.MOUNT_EXTERNAL_NONE;<br>            <span class="hljs-keyword">if</span> (!app.isolated) &#123;<br>                <span class="hljs-keyword">int</span>[] permGids = null;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-built_in">checkTime</span>(startTime, <span class="hljs-string">&quot;startProcess: getting gids from package manager&quot;</span>);<br>                    <span class="hljs-comment">//通过Package Manager获取gids</span><br>                    <span class="hljs-keyword">final</span> IPackageManager pm = AppGlobals.<span class="hljs-built_in">getPackageManager</span>();<br>                    permGids = pm.<span class="hljs-built_in">getPackageGids</span>(app.info.packageName,<br>                            MATCH_DEBUG_TRIAGED_MISSING, app.userId);<br>                    MountServiceInternal mountServiceInternal = LocalServices.<span class="hljs-built_in">getService</span>(<br>                            MountServiceInternal.class);<br>                    mountExternal = mountServiceInternal.<span class="hljs-built_in">getExternalStorageMountMode</span>(uid,<br>                            app.info.packageName);<br>                &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (RemoteException e) &#123;<br>                    <span class="hljs-keyword">throw</span> e.<span class="hljs-built_in">rethrowAsRuntimeException</span>();<br>                &#125;<br><br>      <br>                 <span class="hljs-comment">//添加APP和配置文件GID，以便app可以共享某些资源</span><br>                <span class="hljs-keyword">if</span> (ArrayUtils.<span class="hljs-built_in">isEmpty</span>(permGids)) &#123;<br>                    gids = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[<span class="hljs-number">2</span>];<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    gids = <span class="hljs-keyword">new</span> <span class="hljs-keyword">int</span>[permGids.length + <span class="hljs-number">2</span>];<br>                    System.<span class="hljs-built_in">arraycopy</span>(permGids, <span class="hljs-number">0</span>, gids, <span class="hljs-number">2</span>, permGids.length);<br>                &#125;<br>                gids[<span class="hljs-number">0</span>] = UserHandle.<span class="hljs-built_in">getSharedAppGid</span>(UserHandle.<span class="hljs-built_in">getAppId</span>(uid));<br>                gids[<span class="hljs-number">1</span>] = UserHandle.<span class="hljs-built_in">getUserGid</span>(UserHandle.<span class="hljs-built_in">getUserId</span>(uid));<br>            &#125;<br>            <span class="hljs-built_in">checkTime</span>(startTime, <span class="hljs-string">&quot;startProcess: building args&quot;</span>);<br>            <br>            ......<br><br>            app.gids = gids;<br>            app.requiredAbi = requiredAbi;<br>            app.instructionSet = instructionSet;<br>            <br>			......<br>						<br>            <span class="hljs-comment">// 请求zygote创建进程，成功后会返回新进程的pid，否则会抛出异常</span><br>            <span class="hljs-comment">//ProcessStartResult是Process内部类，封装了启动进程的结果</span><br>            <span class="hljs-comment">//这是一个阻塞过程</span><br>            <span class="hljs-built_in">Process</span>.ProcessStartResult startResult = <span class="hljs-built_in">Process</span>.<span class="hljs-built_in">start</span>(entryPoint,<br>                    app.processName, uid, uid, gids, debugFlags, mountExternal,<br>                    app.info.targetSdkVersion, app.info.seinfo, requiredAbi, instructionSet,<br>                    app.info.dataDir, entryPointArgs);<br>            <span class="hljs-built_in">checkTime</span>(startTime, <span class="hljs-string">&quot;startProcess: returned from zygote!&quot;</span>);<br>            Trace.<span class="hljs-built_in">traceEnd</span>(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br><br>            ......<br>            <br>            <span class="hljs-comment">//重置ProcessRecord的成员变量</span><br>            app.<span class="hljs-built_in">setPid</span>(startResult.pid);<br>            app.usingWrapper = startResult.usingWrapper;<br>            app.removed = <span class="hljs-literal">false</span>;<br>            app.killed = <span class="hljs-literal">false</span>;<br>            app.killedByAm = <span class="hljs-literal">false</span>;<br>            <span class="hljs-built_in">checkTime</span>(startTime, <span class="hljs-string">&quot;startProcess: starting to update pids map&quot;</span>);<br>            <br>            <span class="hljs-built_in">synchronized</span> (mPidsSelfLocked) &#123;<br>                ProcessRecord oldApp;<br>                <span class="hljs-comment">// 如果已经有一个app占用了这个尚未清理的pid</span><br>                <span class="hljs-keyword">if</span> ((oldApp = mPidsSelfLocked.<span class="hljs-built_in">get</span>(startResult.pid)) != null &amp;&amp; !app.isolated) &#123;<br>                    <span class="hljs-comment">// 清理与此pid相关联的内容   </span><br>                    <span class="hljs-built_in">cleanUpApplicationRecordLocked</span>(oldApp, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, <span class="hljs-number">-1</span>,<br>                            <span class="hljs-literal">true</span> <span class="hljs-comment">/*replacingPid*/</span>);<br>                &#125;<br>                <span class="hljs-comment">//将新创建的进程添加到mPidsSelfLocked</span><br>                <span class="hljs-keyword">this</span>.mPidsSelfLocked.<span class="hljs-built_in">put</span>(startResult.pid, app);<br>                <span class="hljs-keyword">if</span> (isActivityProcess) &#123;<br>                    Message msg = mHandler.<span class="hljs-built_in">obtainMessage</span>(PROC_START_TIMEOUT_MSG);<br>                    msg.obj = app;<br>                    mHandler.<span class="hljs-built_in">sendMessageDelayed</span>(msg, startResult.usingWrapper<br>                            ? PROC_START_TIMEOUT_WITH_WRAPPER : PROC_START_TIMEOUT);<br>                &#125;<br>            &#125;<br>            <span class="hljs-built_in">checkTime</span>(startTime, <span class="hljs-string">&quot;startProcess: done updating pids map&quot;</span>);<br>        &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (RuntimeException e) &#123;<br>            <span class="hljs-comment">// 创建进程失败了，一个常见的情况是由于主动升级导致包被冻结</span><br>            forceStopPackageLocked(app.info.packageName, UserHandle.<span class="hljs-built_in">getAppId</span>(app.uid), <span class="hljs-literal">false</span>,<br>                    <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>, UserHandle.<span class="hljs-built_in">getUserId</span>(app.userId), <span class="hljs-string">&quot;start failure&quot;</span>);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>这个方法中最重要的就是通过Process.start来创建应用进程；原理是通过socket向Zygote进程发送创建新进程的请求；Zygote进程启动后有一个runSelectLoop循环，当收到客户端请求便会执行ZygoteConnection.runOnce()方法，再经过层层调用后fork出新的应用进程，创建新进程后将ActivityThread类加载到新进程，并调用ActivityThread.main()方法</p>
<h4 id="3-3-3-Process-start"><a href="#3-3-3-Process-start" class="headerlink" title="3.3.3 Process.start()"></a>3.3.3 Process.start()</h4><p>源码位于frameworks/base/core/java/android/os/Process.java</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">//开启一个新的进程</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ProcessStartResult <span class="hljs-title">start</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> processClass,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> niceName,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">int</span> uid, <span class="hljs-keyword">int</span> gid, <span class="hljs-keyword">int</span>[] gids,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">int</span> debugFlags, <span class="hljs-keyword">int</span> mountExternal,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">int</span> targetSdkVersion,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">String</span> seInfo,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">String</span> abi,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">String</span> instructionSet,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">String</span> appDataDir,</span></span><br><span class="hljs-params"><span class="hljs-function">                                  <span class="hljs-keyword">String</span>[] zygoteArgs)</span> </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">startViaZygote</span>(processClass, niceName, uid, gid, gids,<br>                    debugFlags, mountExternal, targetSdkVersion, seInfo,<br>                    abi, instructionSet, appDataDir, zygoteArgs);<br>        &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (ZygoteStartFailedEx ex) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<br>                    <span class="hljs-string">&quot;Starting VM process through Zygote failed&quot;</span>, ex);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-3-4-Process-startViaZygote"><a href="#3-3-4-Process-startViaZygote" class="headerlink" title="3.3.4 Process.startViaZygote()"></a>3.3.4 Process.startViaZygote()</h4><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-comment">//通过zygote机制启动新进程</span><br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ProcessStartResult startViaZygote(<span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> processClass,<br>                                 <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> niceName,<br>                                 <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> uid, <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> gid,<br>                                 <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span>[] gids,<br>                                 <span class="hljs-built_in">int</span> debugFlags, <span class="hljs-built_in">int</span> mountExternal,<br>                                 <span class="hljs-built_in">int</span> targetSdkVersion,<br>                                 <span class="hljs-keyword">String</span> seInfo,<br>                                 <span class="hljs-keyword">String</span> abi,<br>                                 <span class="hljs-keyword">String</span> instructionSet,<br>                                 <span class="hljs-keyword">String</span> appDataDir,<br>                                 <span class="hljs-keyword">String</span>[] extraArgs)<br>                                 <span class="hljs-keyword">throws</span> ZygoteStartFailedEx &#123;<br>       <span class="hljs-keyword">synchronized</span>(Process.class) &#123;<br>           ArrayList&lt;<span class="hljs-keyword">String</span>&gt; argsForZygote = <span class="hljs-keyword">new</span> ArrayList&lt;<span class="hljs-keyword">String</span>&gt;();<br><br>           <span class="hljs-comment">// 主要工作是生成argsForZygote数组，该数组保存了进程的uid、gid、groups、target-sdk、nice-name等一系列的参数</span><br>           argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--runtime-args&quot;</span>);<br>           argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--setuid=&quot;</span> + uid);<br>           argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--setgid=&quot;</span> + gid);<br>           <span class="hljs-keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_ENABLE_JNI_LOGGING) != <span class="hljs-number">0</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--enable-jni-logging&quot;</span>);<br>           &#125;<br>           <span class="hljs-keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_ENABLE_SAFEMODE) != <span class="hljs-number">0</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--enable-safemode&quot;</span>);<br>           &#125;<br>           <span class="hljs-keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_ENABLE_DEBUGGER) != <span class="hljs-number">0</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--enable-debugger&quot;</span>);<br>           &#125;<br>           <span class="hljs-keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_ENABLE_CHECKJNI) != <span class="hljs-number">0</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--enable-checkjni&quot;</span>);<br>           &#125;<br>           <span class="hljs-keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_GENERATE_DEBUG_INFO) != <span class="hljs-number">0</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--generate-debug-info&quot;</span>);<br>           &#125;<br>           <span class="hljs-keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_ALWAYS_JIT) != <span class="hljs-number">0</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--always-jit&quot;</span>);<br>           &#125;<br>           <span class="hljs-keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_NATIVE_DEBUGGABLE) != <span class="hljs-number">0</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--native-debuggable&quot;</span>);<br>           &#125;<br>           <span class="hljs-keyword">if</span> ((debugFlags &amp; Zygote.DEBUG_ENABLE_ASSERT) != <span class="hljs-number">0</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--enable-assert&quot;</span>);<br>           &#125;<br>           <span class="hljs-keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_DEFAULT) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--mount-external-default&quot;</span>);<br>           &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_READ) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--mount-external-read&quot;</span>);<br>           &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mountExternal == Zygote.MOUNT_EXTERNAL_WRITE) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--mount-external-write&quot;</span>);<br>           &#125;<br>           argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--target-sdk-version=&quot;</span> + targetSdkVersion);<br><br>           <span class="hljs-comment">//TODO optionally enable debuger</span><br>           <span class="hljs-comment">//argsForZygote.add(&quot;--enable-debugger&quot;);</span><br><br>           <span class="hljs-comment">// --setgroups is a comma-separated list</span><br>           <span class="hljs-keyword">if</span> (gids != <span class="hljs-keyword">null</span> &amp;&amp; gids.length &gt; <span class="hljs-number">0</span>) &#123;<br>               StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder();<br>               sb.<span class="hljs-built_in">append</span>(<span class="hljs-string">&quot;--setgroups=&quot;</span>);<br><br>               <span class="hljs-built_in">int</span> sz = gids.length;<br>               <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; sz; i++) &#123;<br>                   <span class="hljs-keyword">if</span> (i != <span class="hljs-number">0</span>) &#123;<br>                       sb.<span class="hljs-built_in">append</span>(<span class="hljs-string">&#x27;,&#x27;</span>);<br>                   &#125;<br>                   sb.<span class="hljs-built_in">append</span>(gids[i]);<br>               &#125;<br><br>               argsForZygote.<span class="hljs-built_in">add</span>(sb.toString());<br>           &#125;<br><br>           <span class="hljs-keyword">if</span> (niceName != <span class="hljs-keyword">null</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--nice-name=&quot;</span> + niceName);<br>           &#125;<br><br>           <span class="hljs-keyword">if</span> (seInfo != <span class="hljs-keyword">null</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--seinfo=&quot;</span> + seInfo);<br>           &#125;<br><br>           <span class="hljs-keyword">if</span> (instructionSet != <span class="hljs-keyword">null</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--instruction-set=&quot;</span> + instructionSet);<br>           &#125;<br><br>           <span class="hljs-keyword">if</span> (appDataDir != <span class="hljs-keyword">null</span>) &#123;<br>               argsForZygote.<span class="hljs-built_in">add</span>(<span class="hljs-string">&quot;--app-data-dir=&quot;</span> + appDataDir);<br>           &#125;<br><br>           argsForZygote.<span class="hljs-built_in">add</span>(processClass);<br><br>           <span class="hljs-keyword">if</span> (extraArgs != <span class="hljs-keyword">null</span>) &#123;<br>               <span class="hljs-keyword">for</span> (<span class="hljs-keyword">String</span> arg : extraArgs) &#123;<br>                   argsForZygote.<span class="hljs-built_in">add</span>(arg);<br>               &#125;<br>           &#125;<br><br>           <span class="hljs-keyword">return</span> zygoteSendArgsAndGetResult(openZygoteSocketIfNeeded(abi), argsForZygote);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-3-5-Process-zygoteSendArgsAndGetResult"><a href="#3-3-5-Process-zygoteSendArgsAndGetResult" class="headerlink" title="3.3.5 Process.zygoteSendArgsAndGetResult()"></a>3.3.5 Process.zygoteSendArgsAndGetResult()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ProcessStartResult <span class="hljs-title">zygoteSendArgsAndGetResult</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">            ZygoteState zygoteState, ArrayList&lt;<span class="hljs-keyword">String</span>&gt; args)</span></span><br><span class="hljs-function">            throws ZygoteStartFailedEx </span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 如果参数格式错误，就尽早抛出异常.</span><br>            <span class="hljs-keyword">int</span> sz = args.<span class="hljs-built_in">size</span>();<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; sz; i++) &#123;<br>                <span class="hljs-keyword">if</span> (args.<span class="hljs-built_in">get</span>(i).<span class="hljs-built_in">indexOf</span>(<span class="hljs-string">&#x27;\n&#x27;</span>) &gt;= <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">ZygoteStartFailedEx</span>(<span class="hljs-string">&quot;embedded newlines not allowed&quot;</span>);<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * 这里就是通过输出流将参数列表写出去</span><br><span class="hljs-comment">             * 获取输入流得到创建进程结果</span><br><span class="hljs-comment">             */</span><br>            <span class="hljs-keyword">final</span> BufferedWriter writer = zygoteState.writer;<br>            <span class="hljs-keyword">final</span> DataInputStream inputStream = zygoteState.inputStream;<br><br>            writer.<span class="hljs-built_in">write</span>(Integer.<span class="hljs-built_in">toString</span>(args.<span class="hljs-built_in">size</span>()));<br>            writer.<span class="hljs-built_in">newLine</span>();<br><br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; sz; i++) &#123;<br>                <span class="hljs-keyword">String</span> arg = args.<span class="hljs-built_in">get</span>(i);<br>                writer.<span class="hljs-built_in">write</span>(arg);<br>                writer.<span class="hljs-built_in">newLine</span>();<br>            &#125;<br><br>            writer.<span class="hljs-built_in">flush</span>();<br><br>            <span class="hljs-comment">// 等待socket返回，这里是否需要设置超时时间，google也在考虑，但是暂时没有加</span><br>            ProcessStartResult result = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ProcessStartResult</span>();<br>            result.pid = inputStream.<span class="hljs-built_in">readInt</span>();<br>            result.usingWrapper = inputStream.<span class="hljs-built_in">readBoolean</span>();<br><br>            <span class="hljs-keyword">if</span> (result.pid &lt; <span class="hljs-number">0</span>) &#123;<br>	            <span class="hljs-comment">//创建进程失败，抛出异常</span><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">ZygoteStartFailedEx</span>(<span class="hljs-string">&quot;fork() failed&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">return</span> result;<br>        &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (IOException ex) &#123;<br>            zygoteState.<span class="hljs-built_in">close</span>();<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">ZygoteStartFailedEx</span>(ex);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>这个方法作用就是通过Socket向zygote进程发送一个参数列表，然后就进入阻塞状态，直到远程Socket服务端返回新创建的进程pid</p>
<p>说到这里我们好像没有见到Socket的影子，只见到了ZygoteState这么一个东西，那它怎么来的呢，可以看见它是上一个方法startViaZygote调用zygoteSendArgsAndGetResult方法传过来的参数，就是这么一句话</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> ProcessStartResult <span class="hljs-title">startViaZygote</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> processClass,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> niceName,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> uid, <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span> gid,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-keyword">final</span> <span class="hljs-keyword">int</span>[] gids,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-keyword">int</span> debugFlags, <span class="hljs-keyword">int</span> mountExternal,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-keyword">int</span> targetSdkVersion,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-keyword">String</span> seInfo,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-keyword">String</span> abi,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-keyword">String</span> instructionSet,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-keyword">String</span> appDataDir,</span></span><br><span class="hljs-params"><span class="hljs-function">                                 <span class="hljs-keyword">String</span>[] extraArgs)</span></span><br><span class="hljs-function">                                 throws ZygoteStartFailedEx </span>&#123;<br>       <span class="hljs-built_in">synchronized</span>(<span class="hljs-built_in">Process</span>.class) &#123;   <br>        ......<br>           <span class="hljs-keyword">return</span> <span class="hljs-built_in">zygoteSendArgsAndGetResult</span>(<span class="hljs-built_in">openZygoteSocketIfNeeded</span>(abi), argsForZygote);<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>


<h4 id="3-3-6-Process-openZygoteSocketIfNeeded"><a href="#3-3-6-Process-openZygoteSocketIfNeeded" class="headerlink" title="3.3.6 Process.openZygoteSocketIfNeeded()"></a>3.3.6 Process.openZygoteSocketIfNeeded()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-comment">//如果zygote的socket没有打开，那就尝试打开，可能会阻塞或者重连</span><br><span class="hljs-keyword">private</span> static ZygoteState <span class="hljs-keyword">open</span><span class="hljs-constructor">ZygoteSocketIfNeeded(String <span class="hljs-params">abi</span>)</span> throws ZygoteStartFailedEx &#123;<br>        <span class="hljs-keyword">if</span> (primaryZygoteState<span class="hljs-operator"> == </span>null<span class="hljs-operator"> || </span>primaryZygoteState.is<span class="hljs-constructor">Closed()</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>            	<span class="hljs-comment">//向zygote进程发起连接</span><br>                primaryZygoteState = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ZygoteState</span>.</span></span>connect(ZYGOTE_SOCKET);<br>            &#125; catch (IOException ioe) &#123;<br>                throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">ZygoteStartFailedEx(<span class="hljs-string">&quot;Error connecting to primary zygote&quot;</span>, <span class="hljs-params">ioe</span>)</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (primaryZygoteState.matches(abi)) &#123;<br>            return primaryZygoteState;<br>        &#125;<br><br>        <span class="hljs-comment">//当主zygote没能匹配成功，则采用第二个zygote，发起connect()操作</span><br>        <span class="hljs-keyword">if</span> (secondaryZygoteState<span class="hljs-operator"> == </span>null<span class="hljs-operator"> || </span>secondaryZygoteState.is<span class="hljs-constructor">Closed()</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>            secondaryZygoteState = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ZygoteState</span>.</span></span>connect(SECONDARY_ZYGOTE_SOCKET);<br>            &#125; catch (IOException ioe) &#123;<br>                throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">ZygoteStartFailedEx(<span class="hljs-string">&quot;Error connecting to secondary zygote&quot;</span>, <span class="hljs-params">ioe</span>)</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (secondaryZygoteState.matches(abi)) &#123;<br>            return secondaryZygoteState;<br>        &#125;<br><br>        throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">ZygoteStartFailedEx(<span class="hljs-string">&quot;Unsupported zygote ABI: &quot;</span> + <span class="hljs-params">abi</span>)</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>这个方法会根据当前的abi来选择与zygote还是zygote64进行通信，在init进程解析rc文件的时候，会根据abi型号创建两个zygote；该方法最终会返回一个ZygoteState，它是Process的静态内部类，具体连接实现在ZygoteState.connect方法中</p>
<h4 id="3-3-7-Process-ZygoteState"><a href="#3-3-7-Process-ZygoteState" class="headerlink" title="3.3.7 Process.ZygoteState()"></a>3.3.7 Process.ZygoteState()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * 与zygote进程通信的状态</span><br><span class="hljs-comment">    *</span><br><span class="hljs-comment">    * @hide 仅限内部使用</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ZygoteState</span> &#123;</span><br>       <span class="hljs-keyword">final</span> LocalSocket socket;<br>       <span class="hljs-keyword">final</span> DataInputStream inputStream;<br>       <span class="hljs-keyword">final</span> BufferedWriter writer;<br>       <span class="hljs-keyword">final</span> List&lt;<span class="hljs-keyword">String</span>&gt; abiList;<br><br>       <span class="hljs-keyword">boolean</span> mClosed;<br><br>       <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">ZygoteState</span><span class="hljs-params">(LocalSocket socket, DataInputStream inputStream,</span></span><br><span class="hljs-params"><span class="hljs-function">               BufferedWriter writer, List&lt;<span class="hljs-keyword">String</span>&gt; abiList)</span> </span>&#123;<br>           <span class="hljs-keyword">this</span>.socket = socket;<br>           <span class="hljs-keyword">this</span>.inputStream = inputStream;<br>           <span class="hljs-keyword">this</span>.writer = writer;<br>           <span class="hljs-keyword">this</span>.abiList = abiList;<br>       &#125;<br><br>       <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> ZygoteState <span class="hljs-title">connect</span><span class="hljs-params">(<span class="hljs-keyword">String</span> socketAddress)</span> throws IOException </span>&#123;<br>           DataInputStream zygoteInputStream = null;<br>           BufferedWriter zygoteWriter = null;<br>           <span class="hljs-keyword">final</span> LocalSocket zygoteSocket = <span class="hljs-keyword">new</span> <span class="hljs-built_in">LocalSocket</span>();<br><br>           <span class="hljs-keyword">try</span> &#123;<br>               zygoteSocket.<span class="hljs-built_in">connect</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">LocalSocketAddress</span>(socketAddress,<br>                       LocalSocketAddress.Namespace.RESERVED));<br><br>               zygoteInputStream = <span class="hljs-keyword">new</span> <span class="hljs-built_in">DataInputStream</span>(zygoteSocket.<span class="hljs-built_in">getInputStream</span>());<br><br>               zygoteWriter = <span class="hljs-keyword">new</span> <span class="hljs-built_in">BufferedWriter</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">OutputStreamWriter</span>(<br>                       zygoteSocket.<span class="hljs-built_in">getOutputStream</span>()), <span class="hljs-number">256</span>);<br>           &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (IOException ex) &#123;<br>               <span class="hljs-keyword">try</span> &#123;<br>                   zygoteSocket.<span class="hljs-built_in">close</span>();<br>               &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (IOException ignore) &#123;<br>               &#125;<br><br>               <span class="hljs-keyword">throw</span> ex;<br>           &#125;<br><br>           <span class="hljs-keyword">String</span> abiListString = <span class="hljs-built_in">getAbiList</span>(zygoteWriter, zygoteInputStream);<br>           Log.<span class="hljs-built_in">i</span>(<span class="hljs-string">&quot;Zygote&quot;</span>, <span class="hljs-string">&quot;Process: zygote socket opened, supported ABIS: &quot;</span> + abiListString);<br><br>           <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">ZygoteState</span>(zygoteSocket, zygoteInputStream, zygoteWriter,<br>                   Arrays.<span class="hljs-built_in">asList</span>(abiListString.<span class="hljs-built_in">split</span>(<span class="hljs-string">&quot;,&quot;</span>)));<br>       &#125;<br><br>       <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">matches</span><span class="hljs-params">(<span class="hljs-keyword">String</span> abi)</span> </span>&#123;<br>           <span class="hljs-keyword">return</span> abiList.<span class="hljs-built_in">contains</span>(abi);<br>       &#125;<br><br>       <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">close</span><span class="hljs-params">()</span> </span>&#123;<br>           <span class="hljs-keyword">try</span> &#123;<br>               socket.<span class="hljs-built_in">close</span>();<br>           &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (IOException ex) &#123;<br>               Log.<span class="hljs-built_in">e</span>(LOG_TAG,<span class="hljs-string">&quot;I/O exception on routine close&quot;</span>, ex);<br>           &#125;<br><br>           mClosed = <span class="hljs-literal">true</span>;<br>       &#125;<br><br>       <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isClosed</span><span class="hljs-params">()</span> </span>&#123;<br>           <span class="hljs-keyword">return</span> mClosed;<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>

<p>可以看到这里是通过LocalSocket进行进程间通信；这种通信的双方一般是Native层的server端，Framework层的Client端，中间涉及到jni调用。</p>
<p>而Android中的LocalSocket是基于UNIX-domain Socket的，UNIX-domain Socket是在Socket的基础上衍生出来的一种IPC通信机制，因此LocalSocket解决的是同一台主机上不同进程间互相通信的问题。其相对于网络通信使用的socket不需要经过网络协议栈，不需要打包拆包、计算校验，自然的执行效率也高。与大名鼎鼎的binder机制作用一样，都在Android系统中作为IPC通信手段被广泛使用；一般由LocalSocket（Client）和LocalServerSocket（Server）组成通信双方。</p>
<p>那么在本文中AMS所在的system-server进程就充当了Client，zygote进程充当Server，因为zygote进程在创建的时候会在ZygoteInit.main方法中调用ZygoteInit.registerZygoteSocket方法，会实例化一个LocalServerSocket，并且在ZygoteInit.runSelectLoop方法中不停的获取客户端的请求</p>
<h3 id="3-4-Zygote接收到请求"><a href="#3-4-Zygote接收到请求" class="headerlink" title="3.4 Zygote接收到请求"></a>3.4 Zygote接收到请求</h3><h4 id="3-4-1-ZygoteInit-main"><a href="#3-4-1-ZygoteInit-main" class="headerlink" title="3.4.1 ZygoteInit.main()"></a>3.4.1 ZygoteInit.main()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">String</span> argv[])</span> </span>&#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>    	<span class="hljs-built_in">registerZygoteSocket</span>(socketName); <span class="hljs-comment">//为Zygote注册socket</span><br>        <span class="hljs-built_in">runSelectLoop</span>(abiList); <span class="hljs-comment">//进入循环模式，获取客户端连接并处理</span><br>        ....<br>    &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (MethodAndArgsCaller caller) &#123;<br>        caller.<span class="hljs-built_in">run</span>();<br>    &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (RuntimeException ex) &#123;<br>        <span class="hljs-built_in">closeServerSocket</span>();<br>        <span class="hljs-keyword">throw</span> ex;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-4-2-ZygoteInit-runSelectLoop"><a href="#3-4-2-ZygoteInit-runSelectLoop" class="headerlink" title="3.4.2 ZygoteInit.runSelectLoop()"></a>3.4.2 ZygoteInit.runSelectLoop()</h4><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> runSelectLoop(<span class="hljs-keyword">String</span> abiList) <span class="hljs-keyword">throws</span> MethodAndArgsCaller &#123;<br>    ArrayList&lt;FileDescriptor&gt; fds = <span class="hljs-keyword">new</span> ArrayList&lt;FileDescriptor&gt;();<br>    ArrayList&lt;ZygoteConnection&gt; peers = <span class="hljs-keyword">new</span> ArrayList&lt;ZygoteConnection&gt;();<br>    <span class="hljs-comment">//sServerSocket是socket通信中的服务端，即zygote进程。保存到fds[0]</span><br>    fds.<span class="hljs-built_in">add</span>(sServerSocket.getFileDescriptor());<br>    peers.<span class="hljs-built_in">add</span>(<span class="hljs-keyword">null</span>);<br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) &#123;<br>        StructPollfd[] pollFds = <span class="hljs-keyword">new</span> StructPollfd[fds.<span class="hljs-built_in">size</span>()];<br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; pollFds.length; ++i) &#123;<br>            pollFds[i] = <span class="hljs-keyword">new</span> StructPollfd();<br>            pollFds[i].fd = fds.<span class="hljs-built_in">get</span>(i);<br>            pollFds[i].events = (<span class="hljs-keyword">short</span>) POLLIN;<br>        &#125;<br>        <span class="hljs-keyword">try</span> &#123;<br>             <span class="hljs-comment">//处理轮询状态，当pollFds有事件到来则往下执行，否则阻塞在这里</span><br>            Os.poll(pollFds, <span class="hljs-number">-1</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (ErrnoException ex) &#123;<br>            ...<br>        &#125;<br>        <br>        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = pollFds.length - <span class="hljs-number">1</span>; i &gt;= <span class="hljs-number">0</span>; --i) &#123;<br>            <span class="hljs-comment">//采用I/O多路复用机制，当接收到客户端发出连接请求 或者数据处理请求到来，则往下执行；</span><br>            <span class="hljs-comment">// 否则进入continue，跳出本次循环。</span><br>            <span class="hljs-keyword">if</span> ((pollFds[i].revents &amp; POLLIN) == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">//即fds[0]，代表的是sServerSocket，则意味着有客户端连接请求；</span><br>                <span class="hljs-comment">// 则创建ZygoteConnection对象,并添加到fds。</span><br>                ZygoteConnection newPeer = acceptCommandPeer(abiList);<br>                peers.<span class="hljs-built_in">add</span>(newPeer);<br>                fds.<span class="hljs-built_in">add</span>(newPeer.getFileDesciptor()); <span class="hljs-comment">//添加到fds.</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//i&gt;0，则代表通过socket接收来自对端的数据，并执行相应操作</span><br>                <span class="hljs-built_in">boolean</span> done = peers.<span class="hljs-built_in">get</span>(i).runOnce();<br>                <span class="hljs-keyword">if</span> (done) &#123;<br>                    peers.remove(i);<br>                    fds.remove(i); <span class="hljs-comment">//处理完则从fds中移除该文件描述符</span><br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>这里通过acceptCommandPeer方法获取连接过来的客户端，然后执行ZygoteConnection.runOnce方法处理请求</p>
<h4 id="3-4-3-ZygoteConnection-runOnce"><a href="#3-4-3-ZygoteConnection-runOnce" class="headerlink" title="3.4.3 ZygoteConnection.runOnce()"></a>3.4.3 ZygoteConnection.runOnce()</h4><p>源码位于 frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 从socket读取一个启动命令；如果有就fork一个子进程</span><br><span class="hljs-comment">     * 如果fork成功，就会抛出 ZygoteInit.MethodAndArgsCaller异常</span><br><span class="hljs-comment">     */</span><br>boolean runOnce() throws ZygoteInit.MethodAndArgsCaller &#123;<br><br>    <span class="hljs-keyword">String</span> args[];<br>    Arguments parsedArgs = <span class="hljs-literal">null</span>;<br>    FileDescriptor[] descriptors;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//读取socket客户端发送过来的参数列表</span><br>        args = readArgumentList();<br>        descriptors = mSocket.getAncillaryFileDescriptors();<br>    &#125; <span class="hljs-keyword">catch</span> (IOException ex) &#123;<br>        ...<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>    ...<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">//将binder客户端传递过来的参数，解析成Arguments对象格式</span><br>        parsedArgs = <span class="hljs-keyword">new</span> <span class="hljs-type">Arguments</span>(args);<br>        ...<br>        pid = Zygote.forkAndSpecialize(parsedArgs.uid, parsedArgs.gid, parsedArgs.gids,<br>                parsedArgs.debugFlags, rlimits, parsedArgs.mountExternal, parsedArgs.seInfo,<br>                parsedArgs.niceName, fdsToClose, parsedArgs.instructionSet,<br>                parsedArgs.appDataDir);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        ...<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-comment">//子进程执行</span><br>            IoUtils.closeQuietly(serverPipeFd);<br>            serverPipeFd = <span class="hljs-literal">null</span>;<br>            <span class="hljs-comment">//进入子进程流程</span><br>            handleChildProc(parsedArgs, descriptors, childPipeFd, <span class="hljs-keyword">new</span><span class="hljs-type">Stderr</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//父进程执行</span><br>            IoUtils.closeQuietly(childPipeFd);<br>            childPipeFd = <span class="hljs-literal">null</span>;<br>            <span class="hljs-keyword">return</span> handleParentProc(pid, descriptors, serverPipeFd, parsedArgs);<br>        &#125;<br>    &#125; finally &#123;<br>        IoUtils.closeQuietly(childPipeFd);<br>        IoUtils.closeQuietly(serverPipeFd);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里先解析客户端发送过来的参数列表，然后调用Zygote.forkAndSpecialize方法</p>
<h4 id="3-4-4-Zygote-forkAndSpecialize"><a href="#3-4-4-Zygote-forkAndSpecialize" class="headerlink" title="3.4.4 Zygote.forkAndSpecialize()"></a>3.4.4 Zygote.forkAndSpecialize()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ZygoteHooks VM_HOOKS = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ZygoteHooks</span>();<br><span class="hljs-comment">/**</span><br><span class="hljs-comment">    * fork一个新的vm实例， 必须使用-Xzygote标志启动当前VM</span><br><span class="hljs-comment">    * 新实例保留所有root功能</span><br><span class="hljs-comment">    */</span><br>   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">forkAndSpecialize</span><span class="hljs-params">(<span class="hljs-keyword">int</span> uid, <span class="hljs-keyword">int</span> gid, <span class="hljs-keyword">int</span>[] gids, <span class="hljs-keyword">int</span> debugFlags,</span></span><br><span class="hljs-params"><span class="hljs-function">         <span class="hljs-keyword">int</span>[][] rlimits, <span class="hljs-keyword">int</span> mountExternal, <span class="hljs-keyword">String</span> seInfo, <span class="hljs-keyword">String</span> niceName, <span class="hljs-keyword">int</span>[] fdsToClose,</span></span><br><span class="hljs-params"><span class="hljs-function">         <span class="hljs-keyword">String</span> instructionSet, <span class="hljs-keyword">String</span> appDataDir)</span> </span>&#123;<br>       VM_HOOKS.<span class="hljs-built_in">preFork</span>();<br>       <span class="hljs-keyword">int</span> pid = <span class="hljs-built_in">nativeForkAndSpecialize</span>(<br>                 uid, gid, gids, debugFlags, rlimits, mountExternal, seInfo, niceName, fdsToClose,<br>                 instructionSet, appDataDir);<br><br>       VM_HOOKS.<span class="hljs-built_in">postForkCommon</span>();<br>       <span class="hljs-keyword">return</span> pid;<br>   &#125;<br></code></pre></td></tr></table></figure>

<p>这里在fork新进程的时候会先调用 VM_HOOKS.preFork()</p>
<h4 id="3-4-5-ZygoteHooks-preFork"><a href="#3-4-5-ZygoteHooks-preFork" class="headerlink" title="3.4.5 ZygoteHooks.preFork()"></a>3.4.5 ZygoteHooks.preFork()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public void pre<span class="hljs-constructor">Fork()</span> &#123;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Daemons</span>.</span></span>stop<span class="hljs-literal">()</span>; <span class="hljs-comment">//停止4个Daemon子线程</span><br>    wait<span class="hljs-constructor">UntilAllThreadsStopped()</span>; <span class="hljs-comment">//等待所有子线程结束</span><br>    token = native<span class="hljs-constructor">PreFork()</span>; <span class="hljs-comment">//完成gc堆的初始化工作</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>这个方法的主要目的是停止zygote进程的四个daemon子线程，分别是ReferenceQueueDaemon，FinalizerDaemon，FinalizerWatchdogDaemon，HeapTaskDaemon；直到zygote是是单线程，以便于提高fork效率；</p>
<p>fork新进程是调用native方法，经过jni调用</p>
<h4 id="3-4-6-com-android-internal-os-Zygote-nativeForkAndSpecialize"><a href="#3-4-6-com-android-internal-os-Zygote-nativeForkAndSpecialize" class="headerlink" title="3.4.6 com_android_internal_os_Zygote.nativeForkAndSpecialize()"></a>3.4.6 com_android_internal_os_Zygote.nativeForkAndSpecialize()</h4><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">static</span> <span class="hljs-function">jint <span class="hljs-title">com_android_internal_os_Zygote_nativeForkAndSpecialize</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    JNIEnv* env, jclass, jint uid, jint gid, jintArray gids,</span></span><br><span class="hljs-params"><span class="hljs-function">    jint debug_flags, jobjectArray rlimits,</span></span><br><span class="hljs-params"><span class="hljs-function">    jint mount_external, jstring se_info, jstring se_name,</span></span><br><span class="hljs-params"><span class="hljs-function">    jintArray fdsToClose, jstring instructionSet, jstring appDataDir)</span> </span>&#123;<br>    <span class="hljs-comment">// 将CAP_WAKE_ALARM赋予蓝牙进程</span><br>    jlong capabilities = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (uid == AID_BLUETOOTH) &#123;<br>        capabilities |= (<span class="hljs-number">1</span>LL &lt;&lt; CAP_WAKE_ALARM);<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">ForkAndSpecializeCommon</span><span class="hljs-params">(env, uid, gid, gids, debug_flags,</span></span><br><span class="hljs-params"><span class="hljs-function">            rlimits, capabilities, capabilities, mount_external, se_info,</span></span><br><span class="hljs-params"><span class="hljs-function">            se_name, <span class="hljs-keyword">false</span>, fdsToClose, instructionSet, appDataDir)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-4-7-com-android-internal-os-Zygote-ForkAndSpecializeCommone"><a href="#3-4-7-com-android-internal-os-Zygote-ForkAndSpecializeCommone" class="headerlink" title="3.4.7 com_android_internal_os_Zygote.ForkAndSpecializeCommone()"></a>3.4.7 com_android_internal_os_Zygote.ForkAndSpecializeCommone()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">pid_t</span> <span class="hljs-title">ForkAndSpecializeCommon</span><span class="hljs-params">(JNIEnv* env, <span class="hljs-keyword">uid_t</span> uid, <span class="hljs-keyword">gid_t</span> gid, jintArray javaGids,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     jint debug_flags, jobjectArray javaRlimits,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     jlong permittedCapabilities, jlong effectiveCapabilities,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     jint mount_external,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     jstring java_se_info, jstring java_se_name,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     <span class="hljs-keyword">bool</span> is_system_server, jintArray fdsToClose,</span></span><br><span class="hljs-params"><span class="hljs-function">                                     jstring instructionSet, jstring dataDir)</span> </span>&#123;<br>  <span class="hljs-comment">//设置子进程的signal信号处理函数</span><br>  <span class="hljs-built_in">SetSigChldHandler</span>();<br>  <span class="hljs-comment">//fork子进程 </span><br>  <span class="hljs-keyword">pid_t</span> pid = fork();<br>  <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">//进入子进程</span><br>    <span class="hljs-built_in">DetachDescriptors</span>(env, fdsToClose); <span class="hljs-comment">//关闭并清除文件描述符</span><br><br>    <span class="hljs-keyword">if</span> (!is_system_server) &#123;<br>        <span class="hljs-comment">//对于非system_server子进程，则创建进程组</span><br>        <span class="hljs-keyword">int</span> rc = <span class="hljs-built_in">createProcessGroup</span>(uid, <span class="hljs-built_in">getpid</span>());<br>    &#125;<br>    <span class="hljs-built_in">SetGids</span>(env, javaGids); <span class="hljs-comment">//设置设置group</span><br>    <span class="hljs-built_in">SetRLimits</span>(env, javaRlimits); <span class="hljs-comment">//设置资源limit</span><br><br>    <span class="hljs-keyword">int</span> rc = <span class="hljs-built_in">setresgid</span>(gid, gid, gid);<br>    rc = <span class="hljs-built_in">setresuid</span>(uid, uid, uid);<br><br>    <span class="hljs-built_in">SetCapabilities</span>(env, permittedCapabilities, effectiveCapabilities);<br>    <span class="hljs-built_in">SetSchedulerPolicy</span>(env); <span class="hljs-comment">//设置调度策略</span><br><br>     <span class="hljs-comment">//selinux上下文</span><br>    rc = <span class="hljs-built_in">selinux_android_setcontext</span>(uid, is_system_server, se_info_c_str, se_name_c_str);<br><br>    <span class="hljs-keyword">if</span> (se_info_c_str == <span class="hljs-literal">NULL</span> &amp;&amp; is_system_server) &#123;<br>      se_name_c_str = <span class="hljs-string">&quot;system_server&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (se_info_c_str != <span class="hljs-literal">NULL</span>) &#123;<br>      <span class="hljs-built_in">SetThreadName</span>(se_name_c_str); <span class="hljs-comment">//设置线程名为，方便调试</span><br>    &#125;<br>    <span class="hljs-comment">//在Zygote子进程中，设置信号SIGCHLD的处理器恢复为默认行为</span><br>    <span class="hljs-built_in">UnsetSigChldHandler</span>();<br>    <span class="hljs-comment">//等价于调用zygote.callPostForkChildHooks() </span><br>    env-&gt;<span class="hljs-built_in">CallStaticVoidMethod</span>(gZygoteClass, gCallPostForkChildHooks, debug_flags,<br>                              is_system_server ? <span class="hljs-literal">NULL</span> : instructionSet);<br>    ...<br><br>  &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid &gt; <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-comment">//进入父进程，即Zygote进程</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> pid;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里会通过fork()方法创建进程</p>
<h4 id="3-4-8-fork-fork"><a href="#3-4-8-fork-fork" class="headerlink" title="3.4.8 fork.fork()"></a>3.4.8 fork.fork()</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">int</span> fork() &#123;<br>  __bionic_atfork_run_prepare(); <span class="hljs-comment">// fork完成前，父进程回调方法</span><br><br>  pthread_internal_t* <span class="hljs-built_in">self</span> = __get_thread();<br><br>  <span class="hljs-comment">//fork期间，获取父进程pid，并使其缓存值无效</span><br>  pid_t parent_pid = <span class="hljs-built_in">self</span>-&gt;invalidate_cached_pid();<br>  <span class="hljs-comment">//系统调用</span><br>  <span class="hljs-keyword">int</span> result = syscall(__NR_clone, FORK_FLAGS, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>, &amp;(<span class="hljs-built_in">self</span>-&gt;tid));<br>  <span class="hljs-keyword">if</span> (result == <span class="hljs-number">0</span>) &#123;<br>    <span class="hljs-built_in">self</span>-&gt;set_cached_pid(gettid());<br>    __bionic_atfork_run_child(); <span class="hljs-comment">//fork完成执行子进程回调方法</span><br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-built_in">self</span>-&gt;set_cached_pid(parent_pid);<br>    __bionic_atfork_run_parent(); <span class="hljs-comment">//fork完成执行父进程回调方法</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>fork进程结束后会在ForkAndSpecializeCommon函数中调用CallStaticVoidMethod。这就是反射调用zygote.callPostForkChildHooks()</p>
<h4 id="3-4-9-zygote-callPostForkChildHooks"><a href="#3-4-9-zygote-callPostForkChildHooks" class="headerlink" title="3.4.9 zygote.callPostForkChildHooks()"></a>3.4.9 zygote.callPostForkChildHooks()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">callPostForkChildHooks</span><span class="hljs-params">(<span class="hljs-keyword">int</span> debugFlags, <span class="hljs-keyword">boolean</span> isSystemServer,</span></span><br><span class="hljs-params"><span class="hljs-function">            <span class="hljs-keyword">String</span> instructionSet)</span> </span>&#123;<br>        VM_HOOKS.<span class="hljs-built_in">postForkChild</span>(debugFlags, isSystemServer, instructionSet);<br>    &#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-4-10-ZygoteHooks-postForkChild"><a href="#3-4-10-ZygoteHooks-postForkChild" class="headerlink" title="3.4.10 ZygoteHooks.postForkChild()"></a>3.4.10 ZygoteHooks.postForkChild()</h4><p>源码位于libcore/dalvik/src/main/java/dalvik/system/ZygoteHooks.java</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public void post<span class="hljs-constructor">ForkChild(<span class="hljs-params">int</span> <span class="hljs-params">debugFlags</span>, String <span class="hljs-params">instructionSet</span>)</span> &#123;<br>    native<span class="hljs-constructor">PostForkChild(<span class="hljs-params">token</span>, <span class="hljs-params">debugFlags</span>, <span class="hljs-params">instructionSet</span>)</span>;<br>    <span class="hljs-comment">//将当前时间设置为新进程随机数种子</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Math</span>.</span></span>set<span class="hljs-constructor">RandomSeedInternal(System.<span class="hljs-params">currentTimeMillis</span>()</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>nativePostForkChild又通过jni调用dalvik_system_ZygoteHooks.ZygoteHooks_nativePostForkChild方法</p>
<h4 id="3-4-11-dalvik-system-ZygoteHooks-ZygoteHooks-nativePostForkChild"><a href="#3-4-11-dalvik-system-ZygoteHooks-ZygoteHooks-nativePostForkChild" class="headerlink" title="3.4.11 dalvik_system_ZygoteHooks.ZygoteHooks_nativePostForkChild()"></a>3.4.11 dalvik_system_ZygoteHooks.ZygoteHooks_nativePostForkChild()</h4><p>源码位于art/runtime/native/dalvik_system_ZygoteHooks.cc</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">ZygoteHooks_nativePostForkChild</span><span class="hljs-params">(JNIEnv* env,</span></span><br><span class="hljs-params"><span class="hljs-function">                                            jclass,</span></span><br><span class="hljs-params"><span class="hljs-function">                                            jlong token,</span></span><br><span class="hljs-params"><span class="hljs-function">                                            jint debug_flags,</span></span><br><span class="hljs-params"><span class="hljs-function">                                            jboolean is_system_server,</span></span><br><span class="hljs-params"><span class="hljs-function">                                            jstring instruction_set)</span> </span>&#123;<br>                                <br>                                <br>  <span class="hljs-comment">//此处token是由nativePreFork()创建的，记录着当前线程</span><br>  Thread* thread = <span class="hljs-keyword">reinterpret_cast</span>&lt;Thread*&gt;(token);<br>  <span class="hljs-comment">// Our system thread ID, etc, has changed so reset Thread state.</span><br>  <span class="hljs-comment">//设置新进程的主线程id</span><br>  thread-&gt;<span class="hljs-built_in">InitAfterFork</span>();<br>  <span class="hljs-built_in">EnableDebugFeatures</span>(debug_flags);<br><br>  <span class="hljs-comment">// Update tracing.</span><br>  <span class="hljs-keyword">if</span> (Trace::<span class="hljs-built_in">GetMethodTracingMode</span>() != TracingMode::kTracingInactive) &#123;<br>    Trace::TraceOutputMode output_mode = Trace::<span class="hljs-built_in">GetOutputMode</span>();<br>    Trace::TraceMode trace_mode = Trace::<span class="hljs-built_in">GetMode</span>();<br>    <span class="hljs-keyword">size_t</span> buffer_size = Trace::<span class="hljs-built_in">GetBufferSize</span>();<br><br>    <span class="hljs-comment">// Just drop it.</span><br>    Trace::<span class="hljs-built_in">Abort</span>();<br><br>    <span class="hljs-comment">// Only restart if it was streaming mode.</span><br>    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Expose buffer size, so we can also do file mode.</span><br>    <span class="hljs-keyword">if</span> (output_mode == Trace::TraceOutputMode::kStreaming) &#123;<br>      <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* proc_name_cutils = <span class="hljs-built_in">get_process_name</span>();<br>      std::string proc_name;<br>      <span class="hljs-keyword">if</span> (proc_name_cutils != <span class="hljs-literal">nullptr</span>) &#123;<br>        proc_name = proc_name_cutils;<br>      &#125;<br>      <span class="hljs-keyword">if</span> (proc_name_cutils == <span class="hljs-literal">nullptr</span> || proc_name == <span class="hljs-string">&quot;zygote&quot;</span> || proc_name == <span class="hljs-string">&quot;zygote64&quot;</span>) &#123;<br>        <span class="hljs-comment">// Either no process name, or the name hasn&#x27;t been changed, yet. Just use pid.</span><br>        <span class="hljs-keyword">pid_t</span> pid = <span class="hljs-built_in">getpid</span>();<br>        proc_name = <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">&quot;%u&quot;</span>, <span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">uint32_t</span>&gt;(pid));<br>      &#125;<br><br>      std::string trace_file = <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">&quot;/data/misc/trace/%s.trace.bin&quot;</span>, proc_name.<span class="hljs-built_in">c_str</span>());<br>      Trace::<span class="hljs-built_in">Start</span>(trace_file.<span class="hljs-built_in">c_str</span>(),<br>                   <span class="hljs-number">-1</span>,<br>                   buffer_size,<br>                   <span class="hljs-number">0</span>,   <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Expose flags.</span><br>                   output_mode,<br>                   trace_mode,<br>                   <span class="hljs-number">0</span>);  <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Expose interval.</span><br>      <span class="hljs-keyword">if</span> (thread-&gt;<span class="hljs-built_in">IsExceptionPending</span>()) &#123;<br>        <span class="hljs-function">ScopedObjectAccess <span class="hljs-title">soa</span><span class="hljs-params">(env)</span></span>;<br>        thread-&gt;<span class="hljs-built_in">ClearException</span>();<br>      &#125;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-keyword">if</span> (instruction_set != <span class="hljs-literal">nullptr</span> &amp;&amp; !is_system_server) &#123;<br>    <span class="hljs-function">ScopedUtfChars <span class="hljs-title">isa_string</span><span class="hljs-params">(env, instruction_set)</span></span>;<br>    InstructionSet isa = <span class="hljs-built_in">GetInstructionSetFromString</span>(isa_string.<span class="hljs-built_in">c_str</span>());<br>    Runtime::NativeBridgeAction action = Runtime::NativeBridgeAction::kUnload;<br>    <span class="hljs-keyword">if</span> (isa != kNone &amp;&amp; isa != kRuntimeISA) &#123;<br>      action = Runtime::NativeBridgeAction::kInitialize;<br>    &#125;<br>    Runtime::<span class="hljs-built_in">Current</span>()-&gt;<span class="hljs-built_in">InitNonZygoteOrPostFork</span>(<br>        env, is_system_server, action, isa_string.<span class="hljs-built_in">c_str</span>());<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    Runtime::<span class="hljs-built_in">Current</span>()-&gt;<span class="hljs-built_in">InitNonZygoteOrPostFork</span>(<br>        env, is_system_server, Runtime::NativeBridgeAction::kUnload, <span class="hljs-literal">nullptr</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-4-12-Runtime-InitNonZygoteOrPostFork"><a href="#3-4-12-Runtime-InitNonZygoteOrPostFork" class="headerlink" title="3.4.12 Runtime::InitNonZygoteOrPostFork()"></a>3.4.12 Runtime::InitNonZygoteOrPostFork()</h4><p>源码位于art/runtime/runtime.cc</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">void</span> Runtime::InitNonZygoteOrPostFork(<br>    JNIEnv* env, <span class="hljs-keyword">bool</span> is_system_server, NativeBridgeAction action, <span class="hljs-keyword">const</span> char* isa) &#123;<br>  is_zygote_ = <span class="hljs-literal">false</span>;<br><br>  <span class="hljs-keyword">if</span> (is_native_bridge_loaded_) &#123;<br>    <span class="hljs-keyword">switch</span> (action) &#123;<br>      <span class="hljs-keyword">case</span> NativeBridgeAction::kUnload:<br>        <span class="hljs-comment">//卸载用于跨平台的桥连库</span><br>        UnloadNativeBridge(); <br>        is_native_bridge_loaded_ = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">break</span>;<br><br>      <span class="hljs-keyword">case</span> NativeBridgeAction::kInitialize:<br>        InitializeNativeBridge(env, isa);<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-comment">// Create the thread pools.</span><br>  <span class="hljs-comment">//创建Java堆处理的线程池</span><br>  heap_-&gt;CreateThreadPool();<br>  <span class="hljs-comment">// Reset the gc performance data at zygote fork so that the GCs</span><br>  <span class="hljs-comment">// before fork aren&#x27;t attributed to an app.</span><br>  <span class="hljs-comment">//重置gc性能数据，以保证进程在创建之前的GCs不会计算到当前app上。</span><br>  heap_-&gt;ResetGcPerformanceInfo();<br><br><br>  <span class="hljs-keyword">if</span> (!is_system_server &amp;&amp;<br>      !safe_mode_ &amp;&amp;<br>      (jit_options_-&gt;UseJitCompilation() || jit_options_-&gt;GetSaveProfilingInfo()) &amp;&amp;<br>      jit_.get() == nullptr) &#123;<br>    <span class="hljs-comment">// Note that when running ART standalone (not zygote, nor zygote fork),</span><br>    <span class="hljs-comment">// the jit may have already been created.</span><br>    <span class="hljs-comment">//当flag被设置，并且还没有创建JIT时，则创建JIT</span><br>    CreateJit();<br>  &#125;<br>  <span class="hljs-comment">//设置信号处理函数</span><br>  StartSignalCatcher();<br><br>  <span class="hljs-comment">// Start the JDWP thread. If the command-line debugger flags specified &quot;suspend=y&quot;,</span><br>  <span class="hljs-comment">// this will pause the runtime, so we probably want this to come last.</span><br>  <span class="hljs-comment">//启动JDWP线程，当命令debuger的flags指定&quot;suspend=y&quot;时，则暂停runtime</span><br>  Dbg::StartJdwp();<br>&#125;<br></code></pre></td></tr></table></figure>
<p>fork完成后继续Zygote.forkAndSpecialize方法第三步</p>
<h4 id="3-4-12-ZygoteHooks-postForkCommon"><a href="#3-4-12-ZygoteHooks-postForkCommon" class="headerlink" title="3.4.12  ZygoteHooks.postForkCommon()"></a>3.4.12  ZygoteHooks.postForkCommon()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public void post<span class="hljs-constructor">ForkCommon()</span> &#123;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Daemons</span>.</span></span>start<span class="hljs-literal">()</span>;<br>&#125;<br><br>public static void start<span class="hljs-literal">()</span> &#123;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ReferenceQueueDaemon</span>.</span><span class="hljs-module"><span class="hljs-identifier">INSTANCE</span>.</span></span>start<span class="hljs-literal">()</span>;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">FinalizerDaemon</span>.</span><span class="hljs-module"><span class="hljs-identifier">INSTANCE</span>.</span></span>start<span class="hljs-literal">()</span>;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">FinalizerWatchdogDaemon</span>.</span><span class="hljs-module"><span class="hljs-identifier">INSTANCE</span>.</span></span>start<span class="hljs-literal">()</span>;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">HeapTaskDaemon</span>.</span><span class="hljs-module"><span class="hljs-identifier">INSTANCE</span>.</span></span>start<span class="hljs-literal">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>主要作用是在fork新进程后将之前停掉的四个Daemon线程启动起来</p>
<p>forkAndSpecialize 总结</p>
<ul>
<li>preFork：停止4个Daemon子线程，初始化GC</li>
<li>nativeForkAndSpecialize：调用Linux的fork()子进程，设置新进程的主线程id，重置gc性能数据，设置信号处理函数等功能</li>
<li>postForkCommon：重新启动四个daemon子线程</li>
<li>forkAndSpecialize执行结束，即创建新进程后，会有两次返回，第一次回到ZygoteConnection.runOnce方法，执行子进程handleChildProc方法；第二次回到该方法，执行zygote进程的handleParentProc方法</li>
</ul>
<h4 id="3-4-13-回调子进程ZygoteConnection-handleChildProc"><a href="#3-4-13-回调子进程ZygoteConnection-handleChildProc" class="headerlink" title="3.4.13 回调子进程ZygoteConnection.handleChildProc()"></a>3.4.13 回调子进程ZygoteConnection.handleChildProc()</h4><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 处理子进程的post-fork设置，并根据需要关闭套接字，根据需要重新打开stdio，</span><br><span class="hljs-comment">     * 如果成功则最终抛出MethodAndArgsCaller，如果失败则返回。</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> void handleChildProc(Arguments parsedArgs,<br>            FileDescriptor[] descriptors, FileDescriptor pipeFd, PrintStream <span class="hljs-keyword">new</span><span class="hljs-type">Stderr</span>)<br>            throws ZygoteInit.MethodAndArgsCaller &#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 当执行到达这里时，native code关闭了两个实际的Zygote socket连接，</span><br><span class="hljs-comment">         * 并在它们的位置替换了/ dev / null。 LocalSocket对象仍需要正确关闭。</span><br><span class="hljs-comment">         */</span><br><br>        closeSocket();<br>        ZygoteInit.closeServerSocket();<br><br>        <span class="hljs-keyword">if</span> (descriptors != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                Os.dup2(descriptors[<span class="hljs-number">0</span>], STDIN_FILENO);<br>                Os.dup2(descriptors[<span class="hljs-number">1</span>], STDOUT_FILENO);<br>                Os.dup2(descriptors[<span class="hljs-number">2</span>], STDERR_FILENO);<br><br>                <span class="hljs-keyword">for</span> (FileDescriptor fd: <span class="hljs-type">descriptors</span>) &#123;<br>                    IoUtils.closeQuietly(fd);<br>                &#125;<br>                <span class="hljs-keyword">new</span><span class="hljs-type">Stderr</span> = System.err;<br>            &#125; <span class="hljs-keyword">catch</span> (ErrnoException ex) &#123;<br>                Log.e(TAG, <span class="hljs-string">&quot;Error reopening stdio&quot;</span>, ex);<br>            &#125;<br>        &#125;<br><br>				 <span class="hljs-comment">//设置进程名</span><br>        <span class="hljs-keyword">if</span> (parsedArgs.niceName != <span class="hljs-literal">null</span>) &#123;<br>            Process.setArgV0(parsedArgs.niceName);<br>        &#125;<br><br><br>        <span class="hljs-keyword">if</span> (parsedArgs.invokeWith != <span class="hljs-literal">null</span>) &#123;<br>            WrapperInit.execApplication(parsedArgs.invokeWith,<br>                    parsedArgs.niceName, parsedArgs.targetSdkVersion,<br>                    VMRuntime.getCurrentInstructionSet(),<br>                    pipeFd, parsedArgs.remainingArgs);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            RuntimeInit.zygoteInit(parsedArgs.targetSdkVersion,<br>                    parsedArgs.remainingArgs, <span class="hljs-literal">null</span> <span class="hljs-comment">/* classLoader */</span>);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-4-14-RuntimeInit-zygoteInit"><a href="#3-4-14-RuntimeInit-zygoteInit" class="headerlink" title="3.4.14 RuntimeInit.zygoteInit()"></a>3.4.14 RuntimeInit.zygoteInit()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public static final void zygote<span class="hljs-constructor">Init(<span class="hljs-params">int</span> <span class="hljs-params">targetSdkVersion</span>, String[] <span class="hljs-params">argv</span>, ClassLoader <span class="hljs-params">classLoader</span>)</span><br>        throws ZygoteInit.MethodAndArgsCaller &#123;<br><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Trace</span>.</span></span>trace<span class="hljs-constructor">Begin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">&quot;RuntimeInit&quot;</span>)</span>;<br>    redirect<span class="hljs-constructor">LogStreams()</span>; <span class="hljs-comment">//重定向log输出</span><br><br>    common<span class="hljs-constructor">Init()</span>; <span class="hljs-comment">// 通用的一些初始化</span><br>    native<span class="hljs-constructor">ZygoteInit()</span>; <span class="hljs-comment">// zygote初始化 </span><br>    application<span class="hljs-constructor">Init(<span class="hljs-params">targetSdkVersion</span>, <span class="hljs-params">argv</span>, <span class="hljs-params">classLoader</span>)</span>; <span class="hljs-comment">// 应用初始化</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-4-15-RuntimeInit-commonInit"><a href="#3-4-15-RuntimeInit-commonInit" class="headerlink" title="3.4.15  RuntimeInit.commonInit()"></a>3.4.15  RuntimeInit.commonInit()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> static final void common<span class="hljs-constructor">Init()</span> &#123;<br>    <span class="hljs-comment">// 设置默认的未捕捉异常处理方法</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Thread</span>.</span></span>set<span class="hljs-constructor">DefaultUncaughtExceptionHandler(<span class="hljs-params">new</span> UncaughtHandler()</span>);<br><br>    <span class="hljs-comment">// 设置市区，中国时区为&quot;Asia/Shanghai&quot;</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TimezoneGetter</span>.</span></span>set<span class="hljs-constructor">Instance(<span class="hljs-params">new</span> TimezoneGetter()</span> &#123;<br>        @Override<br>        public String get<span class="hljs-constructor">Id()</span> &#123;<br>            return <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">SystemProperties</span>.</span></span>get(<span class="hljs-string">&quot;persist.sys.timezone&quot;</span>);<br>        &#125;<br>    &#125;);<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TimeZone</span>.</span></span>set<span class="hljs-constructor">Default(<span class="hljs-params">null</span>)</span>;<br><br>    <span class="hljs-comment">//重置log配置</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">LogManager</span>.</span></span>get<span class="hljs-constructor">LogManager()</span>.reset<span class="hljs-literal">()</span>;<br>    <span class="hljs-keyword">new</span> <span class="hljs-constructor">AndroidConfig()</span>;<br><br>    <span class="hljs-comment">// 设置默认的HTTP User-agent格式( &quot;Dalvik/1.1.0 (Linux; U; Android 6.0.1；LenovoX3c70 Build/LMY47V)&quot;),用于 HttpURLConnection</span><br>    String userAgent = get<span class="hljs-constructor">DefaultUserAgent()</span>;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">System</span>.</span></span>set<span class="hljs-constructor">Property(<span class="hljs-string">&quot;http.agent&quot;</span>, <span class="hljs-params">userAgent</span>)</span>;<br><br>    <span class="hljs-comment">// 设置socket的tag，用于网络流量统计</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">NetworkManagementSocketTagger</span>.</span></span>install<span class="hljs-literal">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-4-16-RuntimeInit-nativeZygoteInit"><a href="#3-4-16-RuntimeInit-nativeZygoteInit" class="headerlink" title="3.4.16 RuntimeInit.nativeZygoteInit()"></a>3.4.16 RuntimeInit.nativeZygoteInit()</h4><p>nativeZygoteInit()所对应的jni方法如下,源码位于frameworks/base/core/jni/AndroidRuntime.cpp</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">static void com<span class="hljs-constructor">_android_internal_os_RuntimeInit_nativeZygoteInit(JNIEnv<span class="hljs-operator">*</span> <span class="hljs-params">env</span>, <span class="hljs-params">jobject</span> <span class="hljs-params">clazz</span>)</span><br>&#123;<br>    <span class="hljs-comment">//此处的gCurRuntime为AppRuntime，是在AndroidRuntime.cpp中定义的</span><br>    gCurRuntime-&gt;on<span class="hljs-constructor">ZygoteInit()</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-4-17-app-main-onZygoteInit"><a href="#3-4-17-app-main-onZygoteInit" class="headerlink" title="3.4.17 app_main.onZygoteInit()"></a>3.4.17 app_main.onZygoteInit()</h4><p>源码位于 frameworks/base/cmds/app_process/app_main.cpp</p>
<figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs ruby">virtual void onZygoteInit()<br>&#123;<br>    sp&lt;ProcessState&gt; <span class="hljs-built_in">proc</span> = ProcessState::<span class="hljs-keyword">self</span>();<br>    <span class="hljs-built_in">proc</span>-&gt;startThreadPool(); <span class="hljs-regexp">//</span>启动新binder线程<br>&#125;<br></code></pre></td></tr></table></figure>

<p>ProcessState::self():主要工作是调用open()打开/dev/binder驱动设备，再利用mmap()映射内核的地址空间，将Binder驱动的fd赋值ProcessState对象中的变量mDriverFD，用于交互操作。startThreadPool()是创建一个新的binder线程，不断进行talkWithDriver()，与Binder驱动交流</p>
<p>继续执行zygoteInit方法中的最后一个方法</p>
<h4 id="3-4-18-RuntimeInit-applicationInit"><a href="#3-4-18-RuntimeInit-applicationInit" class="headerlink" title="3.4.18 RuntimeInit.applicationInit()"></a>3.4.18 RuntimeInit.applicationInit()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> static void application<span class="hljs-constructor">Init(<span class="hljs-params">int</span> <span class="hljs-params">targetSdkVersion</span>, String[] <span class="hljs-params">argv</span>, ClassLoader <span class="hljs-params">classLoader</span>)</span><br>        throws ZygoteInit.MethodAndArgsCaller &#123;<br>    <span class="hljs-comment">//true代表应用程序退出时不调用AppRuntime.onExit()，否则会在退出前调用</span><br>    native<span class="hljs-constructor">SetExitWithoutCleanup(<span class="hljs-params">true</span>)</span>;<br><br>    <span class="hljs-comment">//设置虚拟机的内存利用率参数值为0.75</span><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">VMRuntime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span>.set<span class="hljs-constructor">TargetHeapUtilization(0.75f)</span>;<br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">VMRuntime</span>.</span></span>get<span class="hljs-constructor">Runtime()</span>.set<span class="hljs-constructor">TargetSdkVersion(<span class="hljs-params">targetSdkVersion</span>)</span>;<br><br>    final Arguments args;<br>    <span class="hljs-keyword">try</span> &#123;<br>        args = <span class="hljs-keyword">new</span> <span class="hljs-constructor">Arguments(<span class="hljs-params">argv</span>)</span>; <span class="hljs-comment">//解析参数</span><br>    &#125; catch (IllegalArgumentException ex) &#123;<br>        return;<br>    &#125;<br><br>    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Trace</span>.</span></span>trace<span class="hljs-constructor">End(Trace.TRACE_TAG_ACTIVITY_MANAGER)</span>;<br><br>    <span class="hljs-comment">//调用startClass的static方法 main() 此处args.startClass为”android.app.ActivityThread”</span><br>    invoke<span class="hljs-constructor">StaticMain(<span class="hljs-params">args</span>.<span class="hljs-params">startClass</span>, <span class="hljs-params">args</span>.<span class="hljs-params">startArgs</span>, <span class="hljs-params">classLoader</span>)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-4-19-RuntimeInit-invokeStaticMain"><a href="#3-4-19-RuntimeInit-invokeStaticMain" class="headerlink" title="3.4.19 RuntimeInit.invokeStaticMain()"></a>3.4.19 RuntimeInit.invokeStaticMain()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> static void invoke<span class="hljs-constructor">StaticMain(String <span class="hljs-params">className</span>, String[] <span class="hljs-params">argv</span>, ClassLoader <span class="hljs-params">classLoader</span>)</span><br>        throws ZygoteInit.MethodAndArgsCaller &#123;<br>    Class&lt;?&gt; cl = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Class</span>.</span></span><span class="hljs-keyword">for</span><span class="hljs-constructor">Name(<span class="hljs-params">className</span>, <span class="hljs-params">true</span>, <span class="hljs-params">classLoader</span>)</span>;<span class="hljs-operator"></span><br><span class="hljs-operator">    ...</span><br><span class="hljs-operator"></span><br><span class="hljs-operator">    </span>Method m;<br>    <span class="hljs-keyword">try</span> &#123;<br>        m = cl.get<span class="hljs-constructor">Method(<span class="hljs-string">&quot;main&quot;</span>, <span class="hljs-params">new</span> Class[] &#123; String[].<span class="hljs-params">class</span> &#125;)</span>;<br>    &#125; catch (NoSuchMethodException ex) &#123;<span class="hljs-operator"></span><br><span class="hljs-operator">        ...</span><br><span class="hljs-operator">    </span>&#125; catch (SecurityException ex) &#123;<span class="hljs-operator"></span><br><span class="hljs-operator">        ...</span><br><span class="hljs-operator">    </span>&#125;<br><br>    <span class="hljs-comment">//通过抛出异常，回到ZygoteInit.main()。这样做好处是能清空栈帧，提高栈帧利用率</span><br>    throw <span class="hljs-keyword">new</span> ZygoteInit.<span class="hljs-constructor">MethodAndArgsCaller(<span class="hljs-params">m</span>, <span class="hljs-params">argv</span>)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>重点看最后一个方法，通过反射获取ActivityThread类的main方法参数，然后抛出MethodAndArgsCaller异常，其中构造方法中m是指main方法，argv是AMS发送过来的参数列表；但是抛出异常后怎么弄呢，我们知道一个方法抛异常，会一直往上走到调用方法，直到一个方法捕获了异常。在这里就会一直抛到ZygoteInit.main方法才捕获了异常，然后去执行MethodAndArgsCaller.run方法</p>
<h4 id="3-4-20-MethodAndArgsCaller-run"><a href="#3-4-20-MethodAndArgsCaller-run" class="headerlink" title="3.4.20 MethodAndArgsCaller.run()"></a>3.4.20 MethodAndArgsCaller.run()</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-built_in">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MethodAndArgsCaller</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Exception</span></span><br><span class="hljs-class">            <span class="hljs-keyword">implements</span> <span class="hljs-title">Runnable</span> </span>&#123;<br>        <span class="hljs-comment">/** 调用的方法 在上面的方法可知是main方法 */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Method mMethod;<br><br>        <span class="hljs-comment">/** 参数列表 */</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span>[] mArgs;<br><br>        <span class="hljs-keyword">public</span> MethodAndArgsCaller(Method method, <span class="hljs-keyword">String</span>[] args) &#123;<br>            mMethod = method;<br>            mArgs = args;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> run() &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>	            <span class="hljs-comment">//反射调用，由上面可知这里会调用到ActivityThread.main()方法</span><br>                mMethod.invoke(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-keyword">Object</span>[] &#123; mArgs &#125;);<br>            &#125; <span class="hljs-keyword">catch</span> (IllegalAccessException ex) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(ex);<br>            &#125; <span class="hljs-keyword">catch</span> (InvocationTargetException ex) &#123;<br>                <span class="hljs-built_in">Throwable</span> cause = ex.getCause();<br>                <span class="hljs-keyword">if</span> (cause <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">RuntimeException</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> (<span class="hljs-built_in">RuntimeException</span>) cause;<br>                &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cause <span class="hljs-keyword">instanceof</span> <span class="hljs-built_in">Error</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> (<span class="hljs-built_in">Error</span>) cause;<br>                &#125;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(ex);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>走到这里就要进入ActivityThread了，它管理着应用程序进程中主线程的执行，在ActivityManager请求时调度和执行Activity，Service，Broadcast和其它操作</p>
<h4 id="3-4-21-ActivityThread-main"><a href="#3-4-21-ActivityThread-main" class="headerlink" title="3.4.21 ActivityThread.main()"></a>3.4.21 ActivityThread.main()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">String</span>[] args)</span> </span>&#123;<br>				<br>		......<br>		<span class="hljs-comment">//创建主线程的Looper</span><br>        Looper.<span class="hljs-built_in">prepareMainLooper</span>();<br>		<span class="hljs-comment">//关联AMS</span><br>        ActivityThread thread = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ActivityThread</span>();<br>        thread.<span class="hljs-built_in">attach</span>(<span class="hljs-literal">false</span>);<br><br>		<span class="hljs-comment">//初始化主线程Handler</span><br>        <span class="hljs-keyword">if</span> (sMainThreadHandler == null) &#123;<br>            sMainThreadHandler = thread.<span class="hljs-built_in">getHandler</span>();<br>        &#125;<br><br>        <span class="hljs-comment">// 进行主线程消息循环</span><br>        Looper.<span class="hljs-built_in">loop</span>();<br><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">&quot;Main thread loop unexpectedly exited&quot;</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>主要工作：设置进程名，打开binder驱动，启动新的binder线程；然后设置art虚拟机参数，再反射调用目标类的main()方法，即ActivityThread.main()方法</p>
<p>至此，进程创建完毕，并且也有了主线程，剩下的便是启动Activity和关联context等初始化操作了</p>
<h4 id="3-4-22-回调zygote进程ZygoteConnection-handleParentProc"><a href="#3-4-22-回调zygote进程ZygoteConnection-handleParentProc" class="headerlink" title="3.4.22 回调zygote进程ZygoteConnection.handleParentProc()"></a>3.4.22 回调zygote进程ZygoteConnection.handleParentProc()</h4><p>子进程fork方法执行完成回调第一次给子进程后，还会回调一次给zygote进程</p>
<p>具体是在ZygoteConnection.runOnce中调用handleParentProc</p>
<figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">handleParentProc</span><span class="hljs-params">(<span class="hljs-keyword">int</span> pid,</span></span><br><span class="hljs-params"><span class="hljs-function">            FileDescriptor[] descriptors, FileDescriptor pipeFd, Arguments parsedArgs)</span> </span>&#123;<br><br>        <span class="hljs-keyword">if</span> (pid &gt; <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-built_in">setChildPgid</span>(pid);<br>        &#125;<br>       ....<br>        <span class="hljs-keyword">try</span> &#123;<br>        <br>            mSocketOutStream.<span class="hljs-built_in">writeInt</span>(pid);<br>            mSocketOutStream.<span class="hljs-built_in">writeBoolean</span>(usingWrapper);<br>        &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (IOException ex) &#123;<br>            Log.<span class="hljs-built_in">e</span>(TAG, <span class="hljs-string">&quot;Error writing to command socket&quot;</span>, ex);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>这个方法主要是为了通知system server进程，新进程已经创建完成</p>
 <img src="/2021/08/23/android%E5%BC%80%E6%9C%BA%E5%90%8E%E9%83%BD%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/images/systemserver.png" srcset="/img/loading.gif" lazyload class="">


<h5 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h5><ul>
<li>APP或者桌面启动，需要使用Binder机制告诉AMS（因为启动方有自己的进程，AMS在system server进程），AMS请求zygote进程是通过Socket</li>
<li>Process.start方法是阻塞的，只有等进程创建完成才会返回</li>
<li>zygote进程fork进程一次，会有两次返回，在zygote进程和子进程分别返回一次，这样子线程就能执行ZygoteConnection.handleChildProc及以后的逻辑；zygote进程通过ZygoteConnection.handleParentProc通知system server进程新进程已经创建完成</li>
</ul>
<h5 id="fork解释"><a href="#fork解释" class="headerlink" title="fork解释"></a>fork解释</h5><p>可能你会疑虑，明明是在zygote进程中的ZygoteConnection.runOnce方法中去执行fork操作，那么fork结束后返回不应该还是在zygote进程中吗？</p>
<p>这里需要了解下fork的逻辑：</p>
<p>fork()采用copy on write技术，这是linux创建进程的标准方法，调用一次，返回两次。当父子进程任一方修改内存数据时（这是on-write时机），才发生缺页中断，从而分配新的物理内存（这是copy操作）。<br>copy-on-write原理：写时拷贝是指子进程与父进程的页表都所指向同一个块物理内存，fork过程只拷贝父进程的页表，并标记这些页表是只读的。父子进程共用同一份物理内存，如果父子进程任一方想要修改这块物理内存，那么会触发缺页异常(page fault)，Linux收到该中断便会创建新的物理内存，并将两个物理内存标记设置为可写状态，从而父子进程都有各自独立的物理内存。</p>
<p>其实就是fork之后，操作系统会复制一个与父进程完全相同的子进程，虽说是父子关系，但是在操作系统看来，他们更像兄弟关系，这2个进程共享代码空间，但是数据空间是互相独立的，子进程数据空间中的内容是父进程的完整拷贝，指令指针也完全相同，子进程拥有父进程当前运行到的位置（两进程的程序计数器pc值相同，也就是说，子进程是从fork返回处开始执行的）</p>
<p>可以这样想象，子进程就是把zygote进程复制了一遍，两个进程都阻塞在这里；但在fork之后，他们就开始分别作不同的工作，正如fork原意【分支】一样，在zygote进程的ZygoteConnection.runOnce方法中，fork返回子进程id，然后执行ZygoteConnection.handleParentProc；但是在子进程的ZygoteConnection.runOnce方法中，fork返回是0，就会去执行ZygoteConnection.handleChildProc；这样父子进程从此分家</p>
<h2 id="4-ActivityThrad的工作逻辑"><a href="#4-ActivityThrad的工作逻辑" class="headerlink" title="4. ActivityThrad的工作逻辑"></a>4. ActivityThrad的工作逻辑</h2><h3 id="4-1-前言"><a href="#4-1-前言" class="headerlink" title="4.1 前言"></a>4.1 前言</h3><p>我们知道在Sun的Java体系中和C语言中的类或者程序入口点都是main方法，那我们的Android程序入口是不是也是某个类的main方法呢？</p>
<p>有一点很奇怪的是，我们平时开发中好像没接触过main方法，基本上都是与四大组件（还有一个Fragment）和Application打交道；要想弄清楚这是怎么回事，就必须要了解下当你点击手机桌面上某个APP的icon后，它是怎么从无到有运行在你的眼前的呢？</p>
<p>当一个应用进程被创建之后，会把ActivityThread这个类加载到新的进程中来，接下来这个应用的一切操作（比如Activity的创建启动）就从ActivityThread这个类开始展开</p>
<h3 id="4-2-类简称"><a href="#4-2-类简称" class="headerlink" title="4.2 类简称"></a>4.2 类简称</h3><ul>
<li>ActivityManagerService：AMS</li>
<li>ActivityManagerNative：AMN</li>
<li>ActivityManagerProxy：AMP</li>
<li>ActivityThread ：AT</li>
<li>ApplicationThread：APT</li>
<li>ApplicationThreadNative：ATN</li>
<li>ApplicationThreadProxy：ATP</li>
<li>ActivityStackSupervisor：ASS</li>
</ul>
<h3 id="4-3-类简介"><a href="#4-3-类简介" class="headerlink" title="4.3 类简介"></a>4.3 类简介</h3><p>这个章节的分析将会接触到大量跨进程通信，需要用到AIDL，其中涉及到的类及Activity启动相关类如下，AIDL的实现模式都是固定的</p>
<h4 id="4-3-1"><a href="#4-3-1" class="headerlink" title="4.3.1"></a>4.3.1</h4><ul>
<li>IActivityManager：作为应用进程请求系统进程的接口，这时候应用进程是客户端进程，系统进程是服务端进程，客户端和服务端进程都实现且遵循这个接口规则</li>
<li>ActivityManagerNative：作为服务端的“桩(Stub)”，其主要职责就是对远程（客户端进程）传递过来的数据进行”反序列化(unparcel)”</li>
<li>ActivityManagerProxy：作为服务的“代理(Proxy)”,运行在客户端进程，其主要职责就是将数据进行“序列化(parcel)”，再传递给远程的“桩(Stub)”</li>
<li>ActivityManagerService：IActivityManager接口中定义的业务的具体实现，运行在服务端，对“桩(Stub)”做了继承扩展</li>
</ul>
<h4 id="4-3-2"><a href="#4-3-2" class="headerlink" title="4.3.2"></a>4.3.2</h4><ul>
<li>IApplicationThread: 作为系统进程请求应用进程的接口，这时候应用进程是服务端进程，系统进程是客户端进程，客户端和服务端进程都实现且遵循这个接口规则</li>
<li>ApplicationThreadNative：同理于ActivityManagerNative</li>
<li>ApplicationThreadProxy：同理于ActivityManagerProxy</li>
<li>ApplicationThread：同理于ActivityManagerService，负责响应系统进程发起的请求，帮助AMS管理相关Application中的Activity的生命周期，是ActivityThread内部类（ActivityThread是应用进程的主线程），接收到系统进程请求后通过Handler往主线程发消息，这样ApplicationThread就轻松将具体执行任务的工作转交给了主线程，用来实现AMS和AT之间的交互</li>
</ul>
<h4 id="4-3-3"><a href="#4-3-3" class="headerlink" title="4.3.3"></a>4.3.3</h4><ul>
<li>ProcessRecord：保存了进程运行时的信息，AMS通过ProcessRecord来维护进程运行时的状态信息，需要将应用进程绑定到ProcessRecord才能开始一个Application的构建（每个应用进程在AMS对应一个ProcessRecord）</li>
<li>ActivityRecord：保存Activity运行时的信息，AMS通过ActivityRecord来维护Activity运行时的状态信息，需要将Activity绑定到AMS中的ActivityRecord才能开始Activity的生命周期（每个Activity在AMS对应一个ActivityRecord，其实就是服务器端的Activity对象的映像）</li>
<li>TaskRecord：AMS抽象出来的一个Task的概念，是记录ActivityRecord的栈，一个“Task”包含若干个ActivityRecord。AMS用TaskRecord确保Activity启动和退出的顺序，如果了解过Activity的启动模式就知道这个用处了</li>
<li>ActivityStack：AMS对Activity设计的一种堆栈机制用于管理Activity，为了让这许多Activity协同工作而不至于产生混乱，其遵循先进后出的原则，系统总是显示位于栈顶的Activity</li>
</ul>
<h4 id="4-3-4"><a href="#4-3-4" class="headerlink" title="4.3.4"></a>4.3.4</h4><ul>
<li>ActivityThread：APP的入口类，从main方法开始执行，就是大家口中的UI线程或者主线程，与AMS一起完成四大组件的工作</li>
<li>Instrumentation：每一个应用程序只有一个Instrumentation实例，在BindApplication创建的，每个Activity内部拥有一个该对象的引用，ActivityThread对组件的操作最后都是交给它去做具体的执行</li>
</ul>
<h4 id="4-3-5"><a href="#4-3-5" class="headerlink" title="4.3.5"></a>4.3.5</h4><ul>
<li>ApplicationInfo：保存了应用程序的信息，包括AndroidManifest.xml中检索的信息</li>
<li>Context：Activity的上下文</li>
<li>ContextWrapper：继承Context，为了使用方便，对Context进行包装，而无需修改Context，内部包含一个真正的Context引用，调用ContextWrapper的方法都会被转向其所包含的真正的Context对象，即ContextImpl对象</li>
<li>Application：继承ContextWrapper，ActivityThread的上下文，用户可以继承它自定义自己的Application类，用于维护全局应用程序状态的基类</li>
<li>ContextImpl：继承Context，真正实现了Context中所有函数，应用程序中调用的各种Context类的方法，其实现均来自于该类；它为Activity和其他应用程序组件提供基本上下文对象</li>
</ul>
 <img src="/2021/08/23/android%E5%BC%80%E6%9C%BA%E5%90%8E%E9%83%BD%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/images/Context.png" srcset="/img/loading.gif" lazyload class="">

<h4 id="4-3-6-代理和桩的理解"><a href="#4-3-6-代理和桩的理解" class="headerlink" title="4.3.6 代理和桩的理解"></a>4.3.6 代理和桩的理解</h4><p>“代理(Proxy)”和“桩(Stub)”是Binder接口实现时成对出现的概念。可以对应到一个生活中的例子：银行的取款机就像是银行的业务代理(Proxy)，客户只需要通过取款机，就能方便地完成存、取款等业务。对于客户来说，不用关心银行是什么样，钱到哪去了，只要通过代理能完成自己的业务就行了；对于取款机这个代理而言，它需要连接银行的服务器(Stub)，完成数据传递，将客户的操作反馈到中心</p>
<h3 id="4-4-ActivityThread入口"><a href="#4-4-ActivityThread入口" class="headerlink" title="4.4 ActivityThread入口"></a>4.4 ActivityThread入口</h3><p>源码位于frameworks/base/core/java/android/app/ActivityThread.java</p>
<figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public static void main(String<span class="hljs-literal">[]</span> args) &#123;<br><br>		......<br>				<br>		<span class="hljs-comment">//实例化了UserEnvironment，便于访问存储路径</span><br>		<span class="hljs-comment">//像平时使用的Environment.getExternalStorageDirectory出自UserEnvironment类</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Environment</span>.</span></span>init<span class="hljs-constructor">ForCurrentUser()</span>;<br><br>        <span class="hljs-comment">// 设置路径 确保用户能正确访问CA证书</span><br>        final File configDir = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Environment</span>.</span></span>get<span class="hljs-constructor">UserConfigDirectory(UserHandle.<span class="hljs-params">myUserId</span>()</span>);<br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">TrustedCertificateStore</span>.</span></span>set<span class="hljs-constructor">DefaultUserDirectory(<span class="hljs-params">configDir</span>)</span>;<br><br>		<span class="hljs-comment">//设置进程名，Process类是进程管理器</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Process</span>.</span></span>set<span class="hljs-constructor">ArgV0(<span class="hljs-string">&quot;&lt;pre-initialized&gt;&quot;</span>)</span>;<br><br>		<span class="hljs-comment">//创建主线程的Looper</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Looper</span>.</span></span>prepare<span class="hljs-constructor">MainLooper()</span>;<br><br>		<span class="hljs-comment">//创建ActivityThread 对象，并关联到AMS</span><br>        ActivityThread thread = <span class="hljs-keyword">new</span> <span class="hljs-constructor">ActivityThread()</span>;<br>        thread.attach(<span class="hljs-literal">false</span>);<br><br>		<span class="hljs-comment">//对主线程Handler赋值</span><br>        <span class="hljs-keyword">if</span> (sMainThreadHandler<span class="hljs-operator"> == </span>null) &#123;<br>            sMainThreadHandler = thread.get<span class="hljs-constructor">Handler()</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 开启主线程循环器，不断的读取消息 派发处理消息</span><br>        <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Looper</span>.</span></span>loop<span class="hljs-literal">()</span>;<br><br>        throw <span class="hljs-keyword">new</span> <span class="hljs-constructor">RuntimeException(<span class="hljs-string">&quot;Main thread loop unexpectedly exited&quot;</span>)</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>这个方法三处比较重要</p>
<ul>
<li><p>创建主线程的Looper，并调用Loop方法，这样主线程就有了自己的消息队列并不停的从中取消息，然后处理</p>
</li>
<li><p>创建ActivityThread 对象，这个过程中会实例化几个重要的成员变量</p>
<ul>
<li>ApplicationThread mAppThread = new ApplicationThread()</li>
<li>Looper mLooper = Looper.myLooper() 获取主线程的Looper</li>
<li>H mH = new H() H继承Handler，用来处理组件的生命周期</li>
</ul>
</li>
<li><p>调用attach方法，这个方法很重要，看下方</p>
</li>
</ul>
<h4 id="4-4-1-AT-attach"><a href="#4-4-1-AT-attach" class="headerlink" title="4.4.1 AT.attach()"></a>4.4.1 AT.attach()</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-function"><span class="hljs-title">attach</span>(<span class="hljs-params"><span class="hljs-built_in">boolean</span> system</span>)</span> &#123;<br>        sCurrentActivityThread = <span class="hljs-built_in">this</span>;<br>        mSystemThread = system;<span class="hljs-comment">//mSystemThread表明是system app 还是普通app</span><br>        <span class="hljs-keyword">if</span> (!system) &#123; <span class="hljs-comment">//main方法传入的是false</span><br>            ViewRootImpl.addFirstDrawHandler(<span class="hljs-keyword">new</span> <span class="hljs-function"><span class="hljs-title">Runnable</span>(<span class="hljs-params"></span>)</span> &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-function"><span class="hljs-title">run</span>(<span class="hljs-params"></span>)</span> &#123;<br>                	<span class="hljs-comment">//开启JIT</span><br>                    ensureJitEnabled();<br>                &#125;<br>            &#125;);<br>            android.ddm.DdmHandleAppName.setAppName(<span class="hljs-string">&quot;&lt;pre-initialized&gt;&quot;</span>,<br>                                                    UserHandle.myUserId());<br>            <span class="hljs-comment">//设置标识此应用程序/进程的对象，以报告VM错误。</span><br>            RuntimeInit.setApplicationObject(mAppThread.asBinder());<br>            <span class="hljs-comment">//创建ActivityManagerProxy对象</span><br>            final IActivityManager mgr = ActivityManagerNative.getDefault();<br>            <span class="hljs-keyword">try</span> &#123;<br>            	<span class="hljs-comment">//通过Binder跨进程调用AMS中的attachApplication</span><br>                mgr.attachApplication(mAppThread);<br>            &#125; <span class="hljs-keyword">catch</span> (RemoteException ex) &#123;<br>                <span class="hljs-keyword">throw</span> ex.rethrowFromSystemServer();<br>            &#125;<br>            <span class="hljs-comment">//观察是否到heap内存上限</span><br>            BinderInternal.addGcWatcher(<span class="hljs-keyword">new</span> <span class="hljs-function"><span class="hljs-title">Runnable</span>(<span class="hljs-params"></span>)</span> &#123;<br>                <span class="hljs-meta">@Override</span> <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-function"><span class="hljs-title">run</span>(<span class="hljs-params"></span>)</span> &#123;<br>                    <span class="hljs-keyword">if</span> (!mSomeActivitiesChanged) &#123;<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                    Runtime runtime = Runtime.getRuntime();<br>                    long dalvikMax = runtime.maxMemory();<br>                    long dalvikUsed = runtime.totalMemory() - runtime.freeMemory();<br>                    <span class="hljs-keyword">if</span> (dalvikUsed &gt; ((<span class="hljs-number">3</span>*dalvikMax)/<span class="hljs-number">4</span>)) &#123;<br>                        <span class="hljs-keyword">if</span> (DEBUG_MEMORY_TRIM) Slog.d(TAG, <span class="hljs-string">&quot;Dalvik max=&quot;</span> + (dalvikMax/<span class="hljs-number">1024</span>)<br>                                + <span class="hljs-string">&quot; total=&quot;</span> + (runtime.totalMemory()/<span class="hljs-number">1024</span>)<br>                                + <span class="hljs-string">&quot; used=&quot;</span> + (dalvikUsed/<span class="hljs-number">1024</span>));<br>                        mSomeActivitiesChanged = <span class="hljs-literal">false</span>;<br>                        <span class="hljs-keyword">try</span> &#123;<br>                        		<span class="hljs-comment">//当已使用内存超过虚拟机总内存的3/4，就请求释放内存</span><br>                            mgr.releaseSomeActivities(mAppThread);<br>                        &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>                            <span class="hljs-keyword">throw</span> e.rethrowFromSystemServer();<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 不要在这里设置application，如果系统崩溃，我们没办法显示警告信息</span><br>            android.ddm.DdmHandleAppName.setAppName(<span class="hljs-string">&quot;system_process&quot;</span>,<br>                    UserHandle.myUserId());<br>            <span class="hljs-keyword">try</span> &#123;<br>                mInstrumentation = <span class="hljs-keyword">new</span> Instrumentation();<br>                ContextImpl context = ContextImpl.createAppContext(<br>                        <span class="hljs-built_in">this</span>, getSystemContext().mPackageInfo);<br>                mInitialApplication = context.mPackageInfo.makeApplication(<span class="hljs-literal">true</span>, <span class="hljs-literal">null</span>);<br>                mInitialApplication.onCreate();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<br>                        <span class="hljs-string">&quot;Unable to instantiate Application():&quot;</span> + e.toString(), e);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//添加dropbox日志到libcore</span><br>        DropBox.setReporter(<span class="hljs-keyword">new</span> DropBoxReporter());<br>		<span class="hljs-comment">//添加Config回调接口</span><br>        ViewRootImpl.addConfigCallback(<span class="hljs-keyword">new</span> <span class="hljs-function"><span class="hljs-title">ComponentCallbacks2</span>(<span class="hljs-params"></span>)</span> &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-function"><span class="hljs-title">onConfigurationChanged</span>(<span class="hljs-params">Configuration newConfig</span>)</span> &#123;<br>                synchronized (mResourcesManager) &#123;<br>                    <span class="hljs-comment">// We need to apply this change to the resources</span><br>                    <span class="hljs-comment">// immediately, because upon returning the view</span><br>                    <span class="hljs-comment">// hierarchy will be informed about it.</span><br>                    <span class="hljs-keyword">if</span> (mResourcesManager.applyConfigurationToResourcesLocked(newConfig, <span class="hljs-literal">null</span>)) &#123;<br>                        updateLocaleListFromAppContext(mInitialApplication.getApplicationContext(),<br>                                mResourcesManager.getConfiguration().getLocales());<br><br>                        <span class="hljs-comment">// This actually changed the resources!  Tell</span><br>                        <span class="hljs-comment">// everyone about it.</span><br>                        <span class="hljs-keyword">if</span> (mPendingConfiguration == <span class="hljs-literal">null</span> ||<br>                                mPendingConfiguration.isOtherSeqNewer(newConfig)) &#123;<br>                            mPendingConfiguration = newConfig;<br><br>                            sendMessage(H.CONFIGURATION_CHANGED, newConfig);<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-function"><span class="hljs-title">onLowMemory</span>(<span class="hljs-params"></span>)</span> &#123;<br>            &#125;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-function"><span class="hljs-title">onTrimMemory</span>(<span class="hljs-params">int level</span>)</span> &#123;<br>            &#125;<br>        &#125;);<br>    &#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>该方法的参数表明是否是system app调用，然后赋值mSystemThread；显然这里是普通app，进入第一个分支</li>
<li>接下来调用ensureJitEnabled()方法，目的是开启虚拟机即时编译功能，Jit全称Just-In-Time，JIT 是一种在运行时同步将字节码转化成机器码的编译器，Dalvik 直接运行转化后的机器码</li>
<li>通过ActivityManagerNative.getDefault()获取AMS的Binder代理对象，然后将APT对象发送给AMS，因为APT继承ATN，这样间接继承了IBinder接口，具备跨进程传输能力</li>
<li>通过BinderInternal类去观察虚拟机内存使用情况</li>
<li>添加dropbox日志到libcore</li>
<li>添加Config回调接口</li>
<li>接下来从ActivityManagerNative.getDefault()开始分析</li>
</ul>
<h4 id="4-4-2-AMN-getDefault"><a href="#4-4-2-AMN-getDefault" class="headerlink" title="4.4.2 AMN.getDefault()"></a>4.4.2 AMN.getDefault()</h4><p>源码位于frameworks/base/core/java/android/app/ActivityManagerNative.java</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 获取系统中全局的ActivityManager，这是与远程AMS通信的接口</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">public</span> IActivityManager <span class="hljs-title">getDefault</span>(<span class="hljs-params"></span>)</span> &#123;<br>        <span class="hljs-keyword">return</span> gDefault.<span class="hljs-keyword">get</span>();<br>    &#125;<br>	<br>	<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title">Singleton</span>&lt;<span class="hljs-title">IActivityManager</span>&gt; gDefault</span> = <span class="hljs-keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;<br>        <span class="hljs-function"><span class="hljs-keyword">protected</span> IActivityManager <span class="hljs-title">create</span>(<span class="hljs-params"></span>)</span> &#123;<br>            IBinder b = ServiceManager.getService(<span class="hljs-string">&quot;activity&quot;</span>);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">false</span>) &#123;<br>                Log.v(<span class="hljs-string">&quot;ActivityManager&quot;</span>, <span class="hljs-string">&quot;default service binder = &quot;</span> + b);<br>            &#125;<br>            IActivityManager am = asInterface(b);<br>            <span class="hljs-keyword">if</span> (<span class="hljs-literal">false</span>) &#123;<br>                Log.v(<span class="hljs-string">&quot;ActivityManager&quot;</span>, <span class="hljs-string">&quot;default service = &quot;</span> + am);<br>            &#125;<br>            <span class="hljs-keyword">return</span> am;<br>        &#125;<br>    &#125;;<br>    <span class="hljs-comment">//将Binder对象转换成activity manager接口，并在需要时生成代理对象</span><br>	<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">public</span> IActivityManager <span class="hljs-title">asInterface</span>(<span class="hljs-params">IBinder obj</span>)</span> &#123;<br>        <span class="hljs-keyword">if</span> (obj == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>        IActivityManager <span class="hljs-keyword">in</span> =<br>            (IActivityManager)obj.queryLocalInterface(descriptor);<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">in</span> != <span class="hljs-literal">null</span>) &#123;<br>	        <span class="hljs-comment">//如果是同一个进程，那就直接返回ActivityManagerNative自己</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">in</span>;<br>        &#125;<br>		<span class="hljs-comment">//如果跨进程，那就将这个IBinder构建成代理对象返回</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> ActivityManagerProxy(obj);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>当前应用所在进程与AMS所在的system server进程不是一个进程，如果想要与AMS通信，就必须要使用Binder机制，这里跨进程通信的过程就是一个典型的AIDL实现</p>
<p>这里是把ActivityThread当做Client，AMS当做Server，这里是跨进程，就需要获取AMS在Client的Binder代理对象，即构建AMP返回，所以这里的IActivityManager实质上是AMP对象，接下来进入AMP</p>
<h4 id="4-4-3-AMP-attachApplication"><a href="#4-4-3-AMP-attachApplication" class="headerlink" title="4.4.3 AMP.attachApplication()"></a>4.4.3 AMP.attachApplication()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public void attach<span class="hljs-constructor">Application(IApplicationThread <span class="hljs-params">app</span>)</span> throws RemoteException<br>    &#123;<br>    	<span class="hljs-comment">//从Parcel池中获取Parcel对象（通讯载体），装载传递给AMS的数据</span><br>        Parcel data = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Parcel</span>.</span></span>obtain<span class="hljs-literal">()</span>;<br>        <span class="hljs-comment">//同上，不过是装载AMS返回的数据</span><br>        Parcel reply = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Parcel</span>.</span></span>obtain<span class="hljs-literal">()</span>;<br>        <span class="hljs-comment">//Binder唯一标志</span><br>        data.write<span class="hljs-constructor">InterfaceToken(IActivityManager.<span class="hljs-params">descriptor</span>)</span>;<br>        <span class="hljs-comment">//asBinder()方法是返回与IApplicationThread 接口相关联的Binder对象（Binder对象实际类型是ATN）</span><br>        data.write<span class="hljs-constructor">StrongBinder(<span class="hljs-params">app</span>.<span class="hljs-params">asBinder</span>()</span>);<br>        mRemote.transact(ATTACH_APPLICATION_TRANSACTION, data, reply, <span class="hljs-number">0</span>);<br>        reply.read<span class="hljs-constructor">Exception()</span>;<br>        data.recycle<span class="hljs-literal">()</span>;<br>        reply.recycle<span class="hljs-literal">()</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>因为是Binder代理对象，所以这里的mRemote是BinderProxy类型，进入看看</p>
<h4 id="4-4-4-BinderProxy-transact"><a href="#4-4-4-BinderProxy-transact" class="headerlink" title="4.4.4 BinderProxy.transact()"></a>4.4.4 BinderProxy.transact()</h4><p>源码位于 frameworks/base/core/java/android/os/Binder.java</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> code 每个AIDL函数都有一个编号，在跨进程的时候，不会传递函数，而是传递编号告诉Server调用哪个函数</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> data Client要发送的数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> reply Server返回的数据</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> flags</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     * <span class="hljs-doctag">@throws</span> RemoteException</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">transact</span><span class="hljs-params">(<span class="hljs-keyword">int</span> code, Parcel data, Parcel reply, <span class="hljs-keyword">int</span> flags)</span> <span class="hljs-keyword">throws</span> RemoteException </span>&#123;<br>        Binder.checkParcel(<span class="hljs-keyword">this</span>, code, data, <span class="hljs-string">&quot;Unreasonably large binder buffer&quot;</span>);<br>        <span class="hljs-keyword">if</span> (Binder.isTracingEnabled()) &#123; Binder.getTransactionTracker().addTrace(); &#125;<br>        <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">transactNative</span><span class="hljs-params">(code, data, reply, flags)</span></span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">boolean</span> transactNative(<span class="hljs-keyword">int</span> code, Parcel data, Parcel reply,<br>            <span class="hljs-keyword">int</span> flags) <span class="hljs-keyword">throws</span> RemoteException<br></code></pre></td></tr></table></figure>

<p>这里最终调用到了native层，接下来经过一系列函数调用，最终调用到了**talkWithDriver()*跟驱动交互，这个函数最后通过ioctl系统调用，Client进程陷入内核态，Client调用attachApplication方法的线程挂起等待返回；驱动完成一系列的操作之后唤醒AMS所在进程，调用了AMS所在进程本地对象的onTransact函数（实际上由Server端线程池完成），这里就调用了AMN的onTransact方法（AMN即Binder本地对象）</p>
<h4 id="4-4-5-AMN-onTransact"><a href="#4-4-5-AMN-onTransact" class="headerlink" title="4.4.5 AMN.onTransact()"></a>4.4.5 AMN.onTransact()</h4><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">onTransact</span><span class="hljs-params">(<span class="hljs-keyword">int</span> code, Parcel data, Parcel reply, <span class="hljs-keyword">int</span> flags)</span></span><br><span class="hljs-function">            <span class="hljs-keyword">throws</span> RemoteException </span>&#123;<br>        <span class="hljs-keyword">switch</span> (code) &#123;<br>				<span class="hljs-keyword">case</span> ATTACH_APPLICATION_TRANSACTION: &#123;<br>            data.enforceInterface(IActivityManager.descriptor);<br>            <span class="hljs-comment">//再将binder对象转换成接口(实际类型是ATP)</span><br>            IApplicationThread app = ApplicationThreadNative.asInterface(<br>                    data.readStrongBinder());<br>            <span class="hljs-keyword">if</span> (app != <span class="hljs-keyword">null</span>) &#123;<br>                attachApplication(app);<br>            &#125;<br>            reply.writeNoException();<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;<br>        &#125;<br>        &#125;<br><br>        <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.<span class="hljs-title">onTransact</span><span class="hljs-params">(code, data, reply, flags)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在AMS所在进程里面，onTransact根据编号调用相关函数；在这个例子里面，由AMS的Binder本地对象（AMN）调用了Server端的attachApplication方法，从这里开始就正式进入AMS了</p>
<p>这边很重要的一点是：<br>虽然在APP进程中是将APT作为参数发送给AMS所在进程，但是因为是跨进程，经过Binder驱动处理后，AMS接收到的是APT的代理对象，即ATP，然后作为参数传给了AMS.attachApplication</p>
<h4 id="4-4-6-AMS-attachApplication"><a href="#4-4-6-AMS-attachApplication" class="headerlink" title="4.4.6 AMS.attachApplication()"></a>4.4.6 AMS.attachApplication()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">@Override<br>   public final void attach<span class="hljs-constructor">Application(IApplicationThread <span class="hljs-params">thread</span>)</span> &#123;<br>       synchronized (this) &#123;<br>       	<span class="hljs-comment">//获取正在attach的应用进程id</span><br>           <span class="hljs-built_in">int</span> callingPid = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Binder</span>.</span></span>get<span class="hljs-constructor">CallingPid()</span>;<br>           final long origId = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Binder</span>.</span></span>clear<span class="hljs-constructor">CallingIdentity()</span>;<br>           attach<span class="hljs-constructor">ApplicationLocked(<span class="hljs-params">thread</span>, <span class="hljs-params">callingPid</span>)</span>;<br>           <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Binder</span>.</span></span>restore<span class="hljs-constructor">CallingIdentity(<span class="hljs-params">origId</span>)</span>;<br>       &#125;<br>   &#125;<br></code></pre></td></tr></table></figure>

<p>这里的thread就是ATP了，AMS就用这个跟APP进程的APT通信<br>注意：这时候AMS所在进程作为Client，APP进程作为Server，记住一点，谁主动发起调用，谁就是Client端，你会发现这又是一个AIDL典型的实现</p>
<h4 id="4-4-7-AMS-attachApplicationLocked"><a href="#4-4-7-AMS-attachApplicationLocked" class="headerlink" title="4.4.7 AMS.attachApplicationLocked()"></a>4.4.7 AMS.attachApplicationLocked()</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><code class="hljs php">		<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> attachApplicationLocked(IApplicationThread thread,<br>            <span class="hljs-keyword">int</span> pid) &#123;<br><br>        <span class="hljs-comment">// 通过pid查找正在attach的application record</span><br>        ProcessRecord app;<br>        <span class="hljs-keyword">if</span> (pid != MY_PID &amp;&amp; pid &gt;= <span class="hljs-number">0</span>) &#123;<br>            synchronized (mPidsSelfLocked) &#123;<br>                app = mPidsSelfLocked.get(pid);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            app = <span class="hljs-literal">null</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (app == <span class="hljs-literal">null</span>) &#123;<br>			<span class="hljs-comment">//找不到对应的ProcessRecord，就杀掉pid对应的进程</span><br>            <span class="hljs-keyword">if</span> (pid &gt; <span class="hljs-number">0</span> &amp;&amp; pid != MY_PID) &#123;<br>                Process.killProcessQuiet(pid);<br>                <span class="hljs-comment">//<span class="hljs-doctag">TODO:</span> killProcessGroup(app.info.uid, pid);</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                	<span class="hljs-comment">//退出这个应用进程的Looper</span><br>                    thread.scheduleExit();<br>                &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> e) &#123;<br>                    <span class="hljs-comment">// Ignore exceptions.</span><br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 第一次attach，app.thread应该为null</span><br>        <span class="hljs-comment">//如果不为null，说明attach在之前的进程，那就清除它</span><br>        <span class="hljs-keyword">if</span> (app.thread != <span class="hljs-literal">null</span>) &#123;<br>            handleAppDiedLocked(app, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 述说整个进程</span><br>        <br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> processName = app.processName;<br>        <span class="hljs-keyword">try</span> &#123;<br>        	<span class="hljs-comment">//注册该进程的死亡回调</span><br>            AppDeathRecipient adr = <span class="hljs-keyword">new</span> AppDeathRecipient(<br>                    app, pid, thread);<br>            thread.asBinder().linkToDeath(adr, <span class="hljs-number">0</span>);<br>            app.deathRecipient = adr;<br>        &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>            app.resetPackageList(mProcessStats);<br>            startProcessLocked(app, <span class="hljs-string">&quot;link fail&quot;</span>, processName);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        EventLog.writeEvent(EventLogTags.AM_PROC_BOUND, app.userId, app.pid, app.processName);<br><br>		<span class="hljs-comment">//设置应用进程信息</span><br>				<br>		<span class="hljs-comment">//这一步结束，app.thread就不会为null</span><br>        app.makeActive(thread, mProcessStats);<br>        app.curAdj = app.setAdj = app.verifiedAdj = ProcessList.INVALID_ADJ;<br>        app.curSchedGroup = app.setSchedGroup = ProcessList.SCHED_GROUP_DEFAULT;<br>        app.forcingToForeground = <span class="hljs-literal">null</span>;<br>        updateProcessForegroundLocked(app, <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>        app.hasShownUi = <span class="hljs-literal">false</span>;<br>        app.debugging = <span class="hljs-literal">false</span>;<br>        app.cached = <span class="hljs-literal">false</span>;<br>        app.killedByAm = <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-comment">// 使用此标志来决定当用户在稍后解锁时是否需要安装provider</span><br>        app.unlocked = StorageManager.isUserKeyUnlocked(app.userId);<br>		<span class="hljs-comment">//移出进程启动超时消息</span><br>        mHandler.removeMessages(PROC_START_TIMEOUT_MSG, app);<br><br>        <span class="hljs-keyword">boolean</span> normalMode = mProcessesReady || isAllowedWhileBooting(app.info);<br>        <span class="hljs-keyword">List</span>&lt;ProviderInfo&gt; providers = normalMode ? generateApplicationProvidersLocked(app) : <span class="hljs-literal">null</span>;<br>				<br>		<span class="hljs-comment">//如果应用程序中存在正在启动的providers，那就延迟10s发送Contentprovider超时消息</span><br>        <span class="hljs-keyword">if</span> (providers != <span class="hljs-literal">null</span> &amp;&amp; checkAppInLaunchingProvidersLocked(app)) &#123;<br>            Message msg = mHandler.obtainMessage(CONTENT_PROVIDER_PUBLISH_TIMEOUT_MSG);<br>            msg.obj = app;<br>            mHandler.sendMessageDelayed(msg, CONTENT_PROVIDER_PUBLISH_TIMEOUT);<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br><br>			<span class="hljs-comment">//获取ApplicationInfo。它保存了从AndroidManifest.xml中检索出的application标签下的信息</span><br>            ApplicationInfo appInfo = app.instrumentationInfo != <span class="hljs-literal">null</span><br>                    ? app.instrumentationInfo : app.info;<br>            app.compat = compatibilityInfoForPackageLocked(appInfo);<br>            <span class="hljs-keyword">if</span> (profileFd != <span class="hljs-literal">null</span>) &#123;<br>                profileFd = profileFd.dup();<br>            &#125;<br>            <span class="hljs-comment">//用于传递profiler设置的系统私有api</span><br>            ProfilerInfo profilerInfo = profileFile == <span class="hljs-literal">null</span> ? <span class="hljs-literal">null</span><br>                    : <span class="hljs-keyword">new</span> ProfilerInfo(profileFile, profileFd, samplingInterval, profileAutoStop);<br>            <span class="hljs-comment">//绑定应用</span><br>            thread.bindApplication(processName, appInfo, providers, app.instrumentationClass,<br>                    profilerInfo, app.instrumentationArguments, app.instrumentationWatcher,<br>                    app.instrumentationUiAutomationConnection, testMode,<br>                    mBinderTransactionTrackingEnabled, enableTrackAllocation,<br>                    isRestrictedBackupMode || !normalMode, app.persistent,<br>                    <span class="hljs-keyword">new</span> Configuration(mConfiguration), app.compat,<br>                    getCommonServicesLocked(app.isolated),<br>                    mCoreSettingsObserver.getCoreSettingsLocked());<br>            <span class="hljs-comment">//更新进程lru列表</span><br>            updateLruProcessLocked(app, <span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>);<br>            app.lastRequestedGc = app.lastLowMemory = SystemClock.uptimeMillis();<br>        &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> e) &#123;<br>            <span class="hljs-comment">// 如果bind失败，那就重启app进程，有可能会无限循环</span><br>            app.resetPackageList(mProcessStats);<br>            app.unlinkDeathRecipient();<br>            startProcessLocked(app, <span class="hljs-string">&quot;bind fail&quot;</span>, processName);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 从待启动应用列表清除这个ProcessRecord</span><br>        mPersistentStartingProcesses.remove(app);<br>        mProcessesOnHold.remove(app);<br><br>        <span class="hljs-keyword">boolean</span> badApp = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">boolean</span> didSomething = <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-comment">// 检测最顶层的可见activity是否正在等待运行在这个进程（启动activity）</span><br>        <span class="hljs-keyword">if</span> (normalMode) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">if</span> (mStackSupervisor.attachApplicationLocked(app)) &#123;<br>                    didSomething = <span class="hljs-literal">true</span>;<span class="hljs-comment">//didSomething表示是否有启动四大组件</span><br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> e) &#123;<br>                badApp = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// 查找所有要运行在这个进程中的sevice</span><br>        <span class="hljs-keyword">if</span> (!badApp) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                didSomething |= mServices.attachApplicationLocked(app, processName);<br>            &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> e) &#123;<br>                badApp = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// 检测这个进程是否有下一个Broadcast receiver</span><br>        <span class="hljs-keyword">if</span> (!badApp &amp;&amp; isPendingBroadcastProcessLocked(pid)) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                didSomething |= sendPendingBroadcastsLocked(app);<br>            &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> e) &#123;<br>                <span class="hljs-comment">// 如果app因为尝试启动Broadcast receiver而死亡，就设置badApp = true</span><br>                badApp = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">//检查下一个backup代理是否在此过程中</span><br>        <span class="hljs-keyword">if</span> (!badApp &amp;&amp; mBackupTarget != <span class="hljs-literal">null</span> &amp;&amp; mBackupTarget.appInfo.uid == app.uid) &#123;<br>            notifyPackageUse(mBackupTarget.appInfo.packageName,<br>                             PackageManager.NOTIFY_PACKAGE_USE_BACKUP);<br>            <span class="hljs-keyword">try</span> &#123;<br>                thread.scheduleCreateBackupAgent(mBackupTarget.appInfo,<br>                        compatibilityInfoForPackageLocked(mBackupTarget.appInfo),<br>                        mBackupTarget.backupMode);<br>            &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> e) &#123;<br>                badApp = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br><br>		<span class="hljs-comment">//如果以上组件启动出错，则需要杀死进程并移除记录</span><br>        <span class="hljs-keyword">if</span> (badApp) &#123;<br>            app.kill(<span class="hljs-string">&quot;error during init&quot;</span>, <span class="hljs-literal">true</span>);<br>            handleAppDiedLocked(app, <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br>		<br>		<span class="hljs-comment">//如果没有启动任何组件，那么didSomething为false</span><br>		<span class="hljs-comment">//调整进程的oom_adj值， oom_adj相当于一种优先级</span><br>        <span class="hljs-comment">//当内存出现不足时，该进程是最先被系统“杀死”</span><br>        <span class="hljs-keyword">if</span> (!didSomething) &#123;<br>            updateOomAdjLocked();<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h4 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h4><ol>
<li>通过pid查找当前进程对应的ProcessRecord</li>
<li>如果ProcessRecord == null，说明正在attach的进程不存在，如果pid有效就杀掉pid对应的进程；反之让刚创建的activitythread退出looper循环；最后直接return</li>
<li>如果查找出来的ProcessRecord 中保存的IApplicationThread不为空，说明它是上个进程的，那就需要清除它</li>
<li>注册该进程的死亡回调，当进程死亡时会通过binder回调,来通知system_server进程死亡的消息</li>
<li>重新设置ProcessRecord信息</li>
<li>调用thread.bindApplication绑定Application到ActivityThread</li>
<li>处理activity，service，Broadcast receiver</li>
<li>kill掉bad应用</li>
</ol>
<p>我们先看第二步，退出looper循环</p>
<p>thread.scheduleExit()</p>
<p>这里的thread是入参IApplicationThread，由上面分析可知，传过来的是APT在客户端的代理ATP，那就走到ATP.scheduleExit</p>
<h4 id="4-4-8-ATP-scheduleExit"><a href="#4-4-8-ATP-scheduleExit" class="headerlink" title="4.4.8 ATP.scheduleExit()"></a>4.4.8 ATP.scheduleExit()</h4><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-title">public</span> final void scheduleExit() throws <span class="hljs-type">RemoteException</span> &#123;<br>        <span class="hljs-type">Parcel</span> <span class="hljs-class"><span class="hljs-keyword">data</span> = <span class="hljs-type">Parcel</span>.obtain();</span><br>        <span class="hljs-class"><span class="hljs-keyword">data</span>.writeInterfaceToken(<span class="hljs-type">IApplicationThread</span>.<span class="hljs-title">descriptor</span>);</span><br>        mRemote.transact(<span class="hljs-type">SCHEDULE_EXIT_TRANSACTION</span>, <span class="hljs-class"><span class="hljs-keyword">data</span>, null,</span><br>                <span class="hljs-type">IBinder</span>.<span class="hljs-type">FLAG_ONEWAY</span>);<br>        <span class="hljs-class"><span class="hljs-keyword">data</span>.recycle();</span><br>    &#125;<br></code></pre></td></tr></table></figure>
<p>因为是代理对象，所以这里的mRemote是BinderProxy类型，调用后经过底层Binder调用会走到服务端的ATN.onTransact<br>（跟上面的AT调用AMS是一样的流程）</p>
<h4 id="4-4-9-ATN-onTransact"><a href="#4-4-9-ATN-onTransact" class="headerlink" title="4.4.9 ATN.onTransact()"></a>4.4.9 ATN.onTransact()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public boolean on<span class="hljs-constructor">Transact(<span class="hljs-params">int</span> <span class="hljs-params">code</span>, Parcel <span class="hljs-params">data</span>, Parcel <span class="hljs-params">reply</span>, <span class="hljs-params">int</span> <span class="hljs-params">flags</span>)</span><br>            throws RemoteException &#123;<br>        switch (code) &#123;<br>				case SCHEDULE_EXIT_TRANSACTION:<br>        &#123;<br>            data.enforce<span class="hljs-constructor">Interface(IApplicationThread.<span class="hljs-params">descriptor</span>)</span>;<br>            schedule<span class="hljs-constructor">Exit()</span>;<br>            return <span class="hljs-literal">true</span>;<br>        &#125;<br>        &#125;<br><br>        return super.on<span class="hljs-constructor">Transact(<span class="hljs-params">code</span>, <span class="hljs-params">data</span>, <span class="hljs-params">reply</span>, <span class="hljs-params">flags</span>)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>scheduleExit()具体实现在APT</p>
<h4 id="4-4-10-APT-scheduleExit"><a href="#4-4-10-APT-scheduleExit" class="headerlink" title="4.4.10 APT.scheduleExit()"></a>4.4.10 APT.scheduleExit()</h4><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">scheduleExit</span><span class="hljs-params">()</span> </span>&#123;<br>        sendMessage(H.EXIT_APPLICATION, <span class="hljs-keyword">null</span>);<br> &#125;<br></code></pre></td></tr></table></figure>

<p>继续调用到AT</p>
<h4 id="4-4-11-AT-sendMessage"><a href="#4-4-11-AT-sendMessage" class="headerlink" title="4.4.11 AT.sendMessage()"></a>4.4.11 AT.sendMessage()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">	<span class="hljs-keyword">private</span> void send<span class="hljs-constructor">Message(<span class="hljs-params">int</span> <span class="hljs-params">what</span>, Object <span class="hljs-params">obj</span>)</span> &#123;<br>        send<span class="hljs-constructor">Message(<span class="hljs-params">what</span>, <span class="hljs-params">obj</span>, 0, 0, <span class="hljs-params">false</span>)</span>;<br>    &#125;<br>    <span class="hljs-keyword">private</span> void send<span class="hljs-constructor">Message(<span class="hljs-params">int</span> <span class="hljs-params">what</span>, Object <span class="hljs-params">obj</span>, <span class="hljs-params">int</span> <span class="hljs-params">arg1</span>, <span class="hljs-params">int</span> <span class="hljs-params">arg2</span>, <span class="hljs-params">boolean</span> <span class="hljs-params">async</span>)</span> &#123;<br>        <span class="hljs-keyword">if</span> (DEBUG_MESSAGES) <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Slog</span>.</span></span>v(<br>            TAG, <span class="hljs-string">&quot;SCHEDULE &quot;</span> + what + <span class="hljs-string">&quot; &quot;</span> + mH.code<span class="hljs-constructor">ToString(<span class="hljs-params">what</span>)</span><br>            + <span class="hljs-string">&quot;: &quot;</span> + arg1 + <span class="hljs-string">&quot; / &quot;</span> + obj);<br>        Message msg = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Message</span>.</span></span>obtain<span class="hljs-literal">()</span>;<br>        msg.what = what;<br>        msg.obj = obj;<br>        msg.arg1 = arg1;<br>        msg.arg2 = arg2;<br>        <span class="hljs-keyword">if</span> (async) &#123;<br>            msg.set<span class="hljs-constructor">Asynchronous(<span class="hljs-params">true</span>)</span>;<br>        &#125;<br>        mH.send<span class="hljs-constructor">Message(<span class="hljs-params">msg</span>)</span>;<br>    &#125;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> H extends Handler &#123;<br><br>			public void handle<span class="hljs-constructor">Message(Message <span class="hljs-params">msg</span>)</span> &#123;<br><br>            switch (msg.what) &#123;<br>            case EXIT_APPLICATION:<br>                    <span class="hljs-keyword">if</span> (mInitialApplication != null) &#123;<br>                        mInitialApplication.on<span class="hljs-constructor">Terminate()</span>;<br>                    &#125;<br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Looper</span>.</span></span>my<span class="hljs-constructor">Looper()</span>.quit<span class="hljs-literal">()</span>;<br>                    break;<br>            <br>            &#125;<br>      &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>最终会将主线程的消息队列清空并退出looper；这一系列调用就是一个AIDL的实现</p>
<p>再看第四步，注册APP进程的死亡通知</p>
<p>thread.asBinder().linkToDeath</p>
<p>上面说了thread是代理对象，调用的是ATP.asBinder()，通过adBinder获取到的Binder类型是BinderProxy</p>
<h4 id="4-4-12-BinderProxy-linkToDeath"><a href="#4-4-12-BinderProxy-linkToDeath" class="headerlink" title="4.4.12 BinderProxy.linkToDeath()"></a>4.4.12 BinderProxy.linkToDeath()</h4><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">public</span> <span class="hljs-keyword">native</span> <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">linkToDeath</span><span class="hljs-params">(DeathRecipient recipient, <span class="hljs-keyword">int</span> flags)</span></span><br><span class="hljs-function">            <span class="hljs-keyword">throws</span> RemoteException</span>;<br></code></pre></td></tr></table></figure>

<p>这是一个native方法，经过jni调用后</p>
<h4 id="4-4-13-android-util-Binder-linkToDeath"><a href="#4-4-13-android-util-Binder-linkToDeath" class="headerlink" title="4.4.13 android_util_Binder.linkToDeath()"></a>4.4.13 android_util_Binder.linkToDeath()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> JNINativeMethod gBinderProxyMethods[] = &#123;<br>     &#123;<span class="hljs-string">&quot;linkToDeath&quot;</span>, <span class="hljs-string">&quot;(Landroid/os/IBinder$DeathRecipient;I)V&quot;</span>, (<span class="hljs-keyword">void</span>*)android_os_BinderProxy_linkToDeath&#125;<br> &#125;;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">android_os_BinderProxy_linkToDeath</span><span class="hljs-params">(JNIEnv* env, jobject obj,</span></span><br><span class="hljs-params"><span class="hljs-function">        jobject recipient, jint flags)</span> <span class="hljs-comment">// throws RemoteException</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (recipient == <span class="hljs-literal">NULL</span>) &#123;<br>    		<span class="hljs-comment">//jni抛异常</span><br>        <span class="hljs-built_in">jniThrowNullPointerException</span>(env, <span class="hljs-literal">NULL</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>		<span class="hljs-comment">//获取BpBinder</span><br>    BinderProxyNativeData *nd = <span class="hljs-built_in">getBPNativeData</span>(env, obj);<br>    IBinder* target = nd-&gt;mObject.<span class="hljs-built_in">get</span>();<br><br>    <span class="hljs-built_in">LOGDEATH</span>(<span class="hljs-string">&quot;linkToDeath: binder=%p recipient=%p\n&quot;</span>, target, recipient);<br><br>    <span class="hljs-keyword">if</span> (!target-&gt;<span class="hljs-built_in">localBinder</span>()) &#123;<br>        DeathRecipientList* list = nd-&gt;mOrgue.<span class="hljs-built_in">get</span>();<br>        sp&lt;JavaDeathRecipient&gt; jdr = <span class="hljs-keyword">new</span> <span class="hljs-built_in">JavaDeathRecipient</span>(env, recipient, list);<br>        <span class="hljs-comment">//在这里建立死亡回调</span><br>        <span class="hljs-keyword">status_t</span> err = target-&gt;<span class="hljs-built_in">linkToDeath</span>(jdr, <span class="hljs-literal">NULL</span>, flags);<br>        <span class="hljs-keyword">if</span> (err != NO_ERROR) &#123;<br>            <span class="hljs-comment">// 添加到death recipient失败, 那清除引用</span><br>            jdr-&gt;<span class="hljs-built_in">clearReference</span>();<br>            <span class="hljs-built_in">signalExceptionForError</span>(env, obj, err, <span class="hljs-literal">true</span> <span class="hljs-comment">/*canThrowRemoteException*/</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">status_t</span> <span class="hljs-title">BpBinder::linkToDeath</span><span class="hljs-params">(</span></span><br><span class="hljs-params"><span class="hljs-function">    <span class="hljs-keyword">const</span> sp&lt;DeathRecipient&gt;&amp; recipient, <span class="hljs-keyword">void</span>* cookie, <span class="hljs-keyword">uint32_t</span> flags)</span></span><br><span class="hljs-function"></span>&#123;<br>    Obituary ob;<br>    ob.recipient = recipient; <span class="hljs-comment">//该对象为JavaDeathRecipient</span><br>    ob.cookie = cookie; <span class="hljs-comment">// cookie=NULL</span><br>    ob.flags = flags; <span class="hljs-comment">// flags=0</span><br>    &#123;<br>        AutoMutex _l(mLock);<br>        <span class="hljs-keyword">if</span> (!mObitsSent) &#123; <span class="hljs-comment">//没有执行过sendObituary，则进入该方法</span><br>            <span class="hljs-keyword">if</span> (!mObituaries) &#123;<br>                mObituaries = <span class="hljs-keyword">new</span> Vector&lt;Obituary&gt;;<br>                <span class="hljs-keyword">if</span> (!mObituaries) &#123;<br>                    <span class="hljs-keyword">return</span> NO_MEMORY;<br>                &#125;<br>                <span class="hljs-built_in">getWeakRefs</span>()-&gt;<span class="hljs-built_in">incWeak</span>(<span class="hljs-keyword">this</span>);<br>                IPCThreadState* self = IPCThreadState::<span class="hljs-built_in">self</span>();<br>                <span class="hljs-comment">//向Binder驱动写命令</span><br>                self-&gt;<span class="hljs-built_in">requestDeathNotification</span>(mHandle, <span class="hljs-keyword">this</span>);<br>                <span class="hljs-comment">//给驱动发消息</span><br>                self-&gt;<span class="hljs-built_in">flushCommands</span>();<br>            &#125;<br>            <span class="hljs-comment">//将新创建的Obituary添加到mObituaries</span><br>            <span class="hljs-keyword">ssize_t</span> res = mObituaries-&gt;<span class="hljs-built_in">add</span>(ob);<br>            <span class="hljs-keyword">return</span> res &gt;= (<span class="hljs-keyword">ssize_t</span>)NO_ERROR ? (<span class="hljs-keyword">status_t</span>)NO_ERROR : res;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> DEAD_OBJECT;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">status_t</span> <span class="hljs-title">IPCThreadState::requestDeathNotification</span><span class="hljs-params">(<span class="hljs-keyword">int32_t</span> handle, BpBinder* proxy)</span></span><br><span class="hljs-function"></span>&#123;<br>    mOut.<span class="hljs-built_in">writeInt32</span>(BC_REQUEST_DEATH_NOTIFICATION);<br>    mOut.<span class="hljs-built_in">writeInt32</span>((<span class="hljs-keyword">int32_t</span>)handle);<br>    mOut.<span class="hljs-built_in">writePointer</span>((<span class="hljs-keyword">uintptr_t</span>)proxy);<br>    <span class="hljs-keyword">return</span> NO_ERROR;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">IPCThreadState::flushCommands</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (mProcess-&gt;mDriverFD &lt;= <span class="hljs-number">0</span>)<br>        <span class="hljs-keyword">return</span>;<br>    <span class="hljs-built_in">talkWithDriver</span>(<span class="hljs-literal">false</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里最终会调用talkWithDriver告诉Binder驱动</p>
<h4 id="4-4-14-IPCThreadState-talkWithDriver"><a href="#4-4-14-IPCThreadState-talkWithDriver" class="headerlink" title="4.4.14 IPCThreadState::talkWithDriver()"></a>4.4.14 IPCThreadState::talkWithDriver()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">status_t</span> <span class="hljs-title">IPCThreadState::talkWithDriver</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> doReceive)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">if</span> (mProcess-&gt;mDriverFD &lt;= <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">return</span> -EBADF;<br>    &#125;<br><br>    binder_write_read bwr;<br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">bool</span> needRead = mIn.<span class="hljs-built_in">dataPosition</span>() &gt;= mIn.<span class="hljs-built_in">dataSize</span>();<br>    <span class="hljs-keyword">const</span> <span class="hljs-keyword">size_t</span> outAvail = (!doReceive || needRead) ? mOut.<span class="hljs-built_in">dataSize</span>() : <span class="hljs-number">0</span>;<br><br>    bwr.write_size = outAvail;<br>    bwr.write_buffer = (<span class="hljs-keyword">uintptr_t</span>)mOut.<span class="hljs-built_in">data</span>();<br><br>    <span class="hljs-comment">// This is what we&#x27;ll read.</span><br>    <span class="hljs-keyword">if</span> (doReceive &amp;&amp; needRead) &#123;<br>        bwr.read_size = mIn.<span class="hljs-built_in">dataCapacity</span>();<br>        bwr.read_buffer = (<span class="hljs-keyword">uintptr_t</span>)mIn.<span class="hljs-built_in">data</span>();<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        bwr.read_size = <span class="hljs-number">0</span>;<br>        bwr.read_buffer = <span class="hljs-number">0</span>;<br>    &#125;<br><br>    bwr.write_consumed = <span class="hljs-number">0</span>;<br>    bwr.read_consumed = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">status_t</span> err;<br>    <span class="hljs-keyword">do</span> &#123;<br><br>		<span class="hljs-comment">//将命令发送给Binder驱动</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(mProcess-&gt;mDriverFD, BINDER_WRITE_READ, &amp;bwr) &gt;= <span class="hljs-number">0</span>)<br>            err = NO_ERROR;<br>        <span class="hljs-keyword">else</span><br>            err = -errno;<br><br>        err = INVALID_OPERATION;<br><br>        <span class="hljs-keyword">if</span> (mProcess-&gt;mDriverFD &lt;= <span class="hljs-number">0</span>) &#123;<br>            err = -EBADF;<br>        &#125;<br>    &#125; <span class="hljs-keyword">while</span> (err == -EINTR);<br>		<br>		......<br>    <span class="hljs-keyword">return</span> err;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">long</span> <span class="hljs-title">binder_ioctl</span><span class="hljs-params">(struct file *filp, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> cmd, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> arg)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> ret;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_proc</span> *<span class="hljs-title">proc</span> =</span> filp-&gt;private_data;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_thread</span> *<span class="hljs-title">thread</span>;</span><br>    ret = <span class="hljs-built_in">wait_event_interruptible</span>(binder_user_error_wait, binder_stop_on_user_error &lt; <span class="hljs-number">2</span>);<br>    ...<br><br>    <span class="hljs-built_in">binder_lock</span>(__func__);<br>    thread = <span class="hljs-built_in">binder_get_thread</span>(proc); <span class="hljs-comment">//获取binder_thread</span><br>    <span class="hljs-built_in"><span class="hljs-keyword">switch</span></span> (cmd) &#123;<br>      <span class="hljs-keyword">case</span> BINDER_WRITE_READ:  <span class="hljs-comment">//进行binder的读写操作</span><br>          ret = <span class="hljs-built_in">binder_ioctl_write_read</span>(filp, cmd, arg, thread); <br>          <span class="hljs-keyword">if</span> (ret)<br>              <span class="hljs-keyword">goto</span> err;<br>          <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> ...<br>    &#125;<br>    ret = <span class="hljs-number">0</span>;<br><br>err:<br>    <span class="hljs-keyword">if</span> (thread)<br>        thread-&gt;looper &amp;= ~BINDER_LOOPER_STATE_NEED_RETURN;<br>    <span class="hljs-built_in">binder_unlock</span>(__func__);<br>     ...<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">binder_ioctl_write_read</span><span class="hljs-params">(struct file *filp,</span></span><br><span class="hljs-params"><span class="hljs-function">                <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> cmd, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> arg,</span></span><br><span class="hljs-params"><span class="hljs-function">                struct binder_thread *thread)</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">int</span> ret = <span class="hljs-number">0</span>;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_proc</span> *<span class="hljs-title">proc</span> =</span> filp-&gt;private_data;<br>    <span class="hljs-keyword">void</span> __user *ubuf = (<span class="hljs-keyword">void</span> __user *)arg;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">binder_write_read</span> <span class="hljs-title">bwr</span>;</span><br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">copy_from_user</span>(&amp;bwr, ubuf, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(bwr))) &#123; <span class="hljs-comment">//把用户空间数据ubuf拷贝到bwr</span><br>        ret = -EFAULT;<br>        <span class="hljs-keyword">goto</span> out;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (bwr.write_size &gt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">//此时写缓存有数据</span><br>        ret = <span class="hljs-built_in">binder_thread_write</span>(proc, thread,<br>                  bwr.write_buffer, bwr.write_size, &amp;bwr.write_consumed);<br>        ...<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (bwr.read_size &gt; <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">//此时读缓存无数据</span><br>        ...<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">copy_to_user</span>(ubuf, &amp;bwr, <span class="hljs-built_in"><span class="hljs-keyword">sizeof</span></span>(bwr))) &#123; <span class="hljs-comment">//将内核数据bwr拷贝到用户空间ubuf</span><br>        ret = -EFAULT;<br>        <span class="hljs-keyword">goto</span> out;<br>    &#125;<br>out:<br>    <span class="hljs-keyword">return</span> ret;<br>&#125;<br><br><span class="hljs-comment">//处理进程发送给Binder驱动的请求</span><br><span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> <span class="hljs-title">binder_thread_write</span><span class="hljs-params">(struct binder_proc *proc, struct binder_thread *thread, <span class="hljs-keyword">binder_uintptr_t</span> binder_buffer, <span class="hljs-keyword">size_t</span> size, <span class="hljs-keyword">binder_size_t</span> *consumed)</span> </span>&#123;<br>  <span class="hljs-keyword">uint32_t</span> cmd;<br>  <span class="hljs-keyword">void</span> __user *buffer = (<span class="hljs-keyword">void</span> __user *)(<span class="hljs-keyword">uintptr_t</span>)binder_buffer;<br>  <span class="hljs-keyword">void</span> __user *ptr = buffer + *consumed;<br>  <span class="hljs-keyword">void</span> __user *end = buffer + size;<br><br>  <span class="hljs-keyword">while</span> (ptr &lt; end &amp;&amp; thread-&gt;return_error == BR_OK) &#123;<br>    <span class="hljs-built_in">get_user</span>(cmd, (<span class="hljs-keyword">uint32_t</span> __user *)ptr); <span class="hljs-comment">//获取命令</span><br>    <span class="hljs-built_in"><span class="hljs-keyword">switch</span></span> (cmd) &#123;<br>      <span class="hljs-keyword">case</span> BC_REQUEST_DEATH_NOTIFICATION:<br>          <span class="hljs-comment">//添加到当前线程的todo队列</span><br>          <span class="hljs-built_in">list_add_tail</span>(&amp;ref-&gt;death-&gt;work.entry, &amp;thread-&gt;todo);<br>          <span class="hljs-keyword">break</span>;<br>      <span class="hljs-keyword">case</span> ...;<br>    &#125;<br>  &#125;    <br>&#125;<br></code></pre></td></tr></table></figure>

<p>最后一步表明只要对端进程挂掉，Binder是在底层可以从todo链表中拿出来client的信息，然后调用对应的回调方法</p>
<p>接下来看第六步，绑定应用</p>
<p>thread.bindApplication</p>
<p>调用原理跟上面一样，这里就不在继续阐述了，最终会调用到APT.bindApplication</p>
<h4 id="4-4-15-APT-bindApplication"><a href="#4-4-15-APT-bindApplication" class="headerlink" title="4.4.15 APT.bindApplication()"></a>4.4.15 APT.bindApplication()</h4><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs haskell"><span class="hljs-title">public</span> final void bindApplication(<span class="hljs-type">String</span> processName, <span class="hljs-type">ApplicationInfo</span> appInfo,<br>                <span class="hljs-type">List</span>&lt;<span class="hljs-type">ProviderInfo</span>&gt; providers, <span class="hljs-type">ComponentName</span> instrumentationName,<br>                <span class="hljs-type">ProfilerInfo</span> profilerInfo, <span class="hljs-type">Bundle</span> instrumentationArgs,<br>                <span class="hljs-type">IInstrumentationWatcher</span> instrumentationWatcher,<br>                <span class="hljs-type">IUiAutomationConnection</span> instrumentationUiConnection, int debugMode,<br>                boolean enableBinderTracking, boolean trackAllocation,<br>                boolean isRestrictedBackupMode, boolean persistent, <span class="hljs-type">Configuration</span> config,<br>                <span class="hljs-type">CompatibilityInfo</span> compatInfo, <span class="hljs-type">Map</span>&lt;<span class="hljs-type">String</span>, <span class="hljs-type">IBinder</span>&gt; services, <span class="hljs-type">Bundle</span> coreSettings) &#123;<br><br>            <span class="hljs-keyword">if</span> (services != null) &#123;<br>                // <span class="hljs-type">Setup</span> the service cache <span class="hljs-keyword">in</span> the <span class="hljs-type">ServiceManager</span><br>                <span class="hljs-type">ServiceManager</span>.initServiceCache(services);<br>            &#125;<br><br>            setCoreSettings(coreSettings);<br><br>            <span class="hljs-type">AppBindData</span> <span class="hljs-class"><span class="hljs-keyword">data</span> = new <span class="hljs-type">AppBindData</span>();</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.processName = processName;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.appInfo = appInfo;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.providers = providers;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.instrumentationName = instrumentationName;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.instrumentationArgs = instrumentationArgs;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.instrumentationWatcher = instrumentationWatcher;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.instrumentationUiAutomationConnection = instrumentationUiConnection;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.debugMode = debugMode;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.enableBinderTracking = enableBinderTracking;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.trackAllocation = trackAllocation;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.restrictedBackupMode = isRestrictedBackupMode;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.persistent = persistent;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.config = config;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.compatInfo = compatInfo;</span><br>            <span class="hljs-class"><span class="hljs-keyword">data</span>.initProfilerInfo = profilerInfo;</span><br>            sendMessage(<span class="hljs-type">H</span>.<span class="hljs-type">BIND_APPLICATION</span>, <span class="hljs-class"><span class="hljs-keyword">data</span>);</span><br>        &#125;<br>        <br>        public void setCoreSettings(<span class="hljs-type">Bundle</span> coreSettings) &#123;<br>            sendMessage(<span class="hljs-type">H</span>.<span class="hljs-type">SET_CORE_SETTINGS</span>, coreSettings);<br>        &#125;<br></code></pre></td></tr></table></figure>

<p>这里通过handler向主线程（AT）发送了两条消息SET_CORE_SETTINGS，BIND_APPLICATION</p>
<h4 id="4-4-16-AT-H-SET-CORE-SETTINGS、AT-H-BIND-APPLICATION"><a href="#4-4-16-AT-H-SET-CORE-SETTINGS、AT-H-BIND-APPLICATION" class="headerlink" title="4.4.16 AT.H.SET_CORE_SETTINGS、AT.H.BIND_APPLICATION"></a>4.4.16 AT.H.SET_CORE_SETTINGS、AT.H.BIND_APPLICATION</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> <span class="hljs-keyword">class</span> H extends Handler &#123;<br><br>			public void handle<span class="hljs-constructor">Message(Message <span class="hljs-params">msg</span>)</span> &#123;<br><br>            switch (msg.what) &#123;<br>            case SET_CORE_SETTINGS:<br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Trace</span>.</span></span>trace<span class="hljs-constructor">Begin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">&quot;setCoreSettings&quot;</span>)</span>;<br>                    handle<span class="hljs-constructor">SetCoreSettings((Bundle)</span> msg.obj);<br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Trace</span>.</span></span>trace<span class="hljs-constructor">End(Trace.TRACE_TAG_ACTIVITY_MANAGER)</span>;<br>                    break;<br>            case BIND_APPLICATION:<br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Trace</span>.</span></span>trace<span class="hljs-constructor">Begin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">&quot;bindApplication&quot;</span>)</span>;<br>                    AppBindData data = (AppBindData)msg.obj;<br>                    handle<span class="hljs-constructor">BindApplication(<span class="hljs-params">data</span>)</span>;<br>                    <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">Trace</span>.</span></span>trace<span class="hljs-constructor">End(Trace.TRACE_TAG_ACTIVITY_MANAGER)</span>;<br>                    break;<br>            &#125;<br>      &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-4-17-AT-handleSetCoreSettings"><a href="#4-4-17-AT-handleSetCoreSettings" class="headerlink" title="4.4.17 AT.handleSetCoreSettings()"></a>4.4.17 AT.handleSetCoreSettings()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs reasonml"><span class="hljs-keyword">private</span> void handle<span class="hljs-constructor">SetCoreSettings(Bundle <span class="hljs-params">coreSettings</span>)</span> &#123;<br>        synchronized (mResourcesManager) &#123;<br>            mCoreSettings = coreSettings;<br>        &#125;<br>        on<span class="hljs-constructor">CoreSettingsChange()</span>;<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> void on<span class="hljs-constructor">CoreSettingsChange()</span> &#123;<br>        boolean debugViewAttributes =<br>                mCoreSettings.get<span class="hljs-constructor">Int(Settings.Global.DEBUG_VIEW_ATTRIBUTES, 0)</span> != <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> (debugViewAttributes != <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">View</span>.</span></span>mDebugViewAttributes) &#123;<br>            <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">View</span>.</span></span>mDebugViewAttributes = debugViewAttributes;<br><br>            <span class="hljs-comment">// 要求所有activity重启以进行更改</span><br>            <span class="hljs-keyword">for</span> (Map.Entry&lt;IBinder, ActivityClientRecord&gt; entry : mActivities.entry<span class="hljs-constructor">Set()</span>) &#123;<br>                request<span class="hljs-constructor">RelaunchActivity(<span class="hljs-params">entry</span>.<span class="hljs-params">getKey</span>()</span>, null, null, <span class="hljs-number">0</span>, <span class="hljs-literal">false</span>, null, null, <span class="hljs-literal">false</span>,<br>                        <span class="hljs-literal">false</span> <span class="hljs-comment">/* preserveWindow */</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-4-18-AT-handleBindApplication"><a href="#4-4-18-AT-handleBindApplication" class="headerlink" title="4.4.18 AT.handleBindApplication()"></a>4.4.18 AT.handleBindApplication()</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">private</span> void handleBindApplication(AppBindData <span class="hljs-keyword">data</span>) &#123;<br><br>        <span class="hljs-comment">// 将UI线程作为sensitive thread 注册到虚拟机.</span><br>        VMRuntime.registerSensitiveThread();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.trackAllocation) &#123;<br>            DdmVmInternal.enableRecentAllocations(<span class="hljs-literal">true</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 设置进程启动时间</span><br>        Process.setStartTimes(SystemClock.elapsedRealtime(), SystemClock.uptimeMillis());<br><br>        mBoundApplication = <span class="hljs-keyword">data</span>;<br>        mConfiguration = new Configuration(<span class="hljs-keyword">data</span>.config);<br>        mCompatConfiguration = new Configuration(<span class="hljs-keyword">data</span>.config);<br><br>        mProfiler = new Profiler();<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.initProfilerInfo != <span class="hljs-literal">null</span>) &#123;<br>            mProfiler.profileFile = <span class="hljs-keyword">data</span>.initProfilerInfo.profileFile;<br>            mProfiler.profileFd = <span class="hljs-keyword">data</span>.initProfilerInfo.profileFd;<br>            mProfiler.samplingInterval = <span class="hljs-keyword">data</span>.initProfilerInfo.samplingInterval;<br>            mProfiler.autoStopProfiler = <span class="hljs-keyword">data</span>.initProfilerInfo.autoStopProfiler;<br>        &#125;<br><br>        <span class="hljs-comment">// 设置进程名, 也就是说进程名是在进程真正创建以后的BIND_APPLICATION过程中才取名</span><br>        Process.setArgV0(<span class="hljs-keyword">data</span>.processName);<br>        android.ddm.DdmHandleAppName.setAppName(<span class="hljs-keyword">data</span>.processName,<br>                                                UserHandle.myUserId());<br><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.persistent) &#123;<br>            <span class="hljs-comment">// Persistent processes on 在低内存设备上无法使用硬件加速绘图，禁用以节省内存</span><br>            <span class="hljs-keyword">if</span> (!ActivityManager.isHighEndGfx()) &#123;<br>                ThreadedRenderer.disable(<span class="hljs-literal">false</span>);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (mProfiler.profileFd != <span class="hljs-literal">null</span>) &#123;<br>            mProfiler.startProfiling();<br>        &#125;<br><br>        <span class="hljs-comment">// 如果sdk版本在Android3.1.x(API12)或更早版本，需要设置Asynctask中使用的线程池，这样任务是并行执行，在高版本是串行执行</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.appInfo.targetSdkVersion &lt;= android.os.Build.VERSION_CODES.HONEYCOMB_MR1) &#123;<br>            AsyncTask.setDefaultExecutor(AsyncTask.THREAD_POOL_EXECUTOR);<br>        &#125;<br><br>		<span class="hljs-comment">//如果版本大于LOLLIPOP，就不支持回收正在使用的Message</span><br>        Message.updateCheckRecycle(<span class="hljs-keyword">data</span>.appInfo.targetSdkVersion);<br><br>        <span class="hljs-comment">/*</span><br><span class="hljs-comment">         * 重置时区</span><br><span class="hljs-comment">         */</span><br>        TimeZone.setDefault(<span class="hljs-literal">null</span>);<br>        LocaleList.setDefault(<span class="hljs-keyword">data</span>.config.getLocales());<br><br>        synchronized (mResourcesManager) &#123;<br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">             * 更新系统配置</span><br><span class="hljs-comment">             */</span><br>            mResourcesManager.applyConfigurationToResourcesLocked(<span class="hljs-keyword">data</span>.config, <span class="hljs-keyword">data</span>.compatInfo);<br>            mCurDefaultDisplayDpi = <span class="hljs-keyword">data</span>.config.densityDpi;<br>            applyCompatConfiguration(mCurDefaultDisplayDpi);<br>        &#125;<br><br>		<span class="hljs-comment">//获取LoadedApk对象</span><br>        <span class="hljs-keyword">data</span>.info = getPackageInfoNoCheck(<span class="hljs-keyword">data</span>.appInfo, <span class="hljs-keyword">data</span>.compatInfo);<br>        <br>		<span class="hljs-comment">//api11以后禁止在主线程使用网络</span><br>		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.appInfo.targetSdkVersion &gt;= Build.VERSION_CODES.HONEYCOMB) &#123;<br>            StrictMode.enableDeathOnNetwork();<br>        &#125;<br>        <br>		<span class="hljs-comment">//api24及以后禁止使用file://这种格式的Uri；引入Fileprovide</span><br>		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.appInfo.targetSdkVersion &gt;= Build.VERSION_CODES.N) &#123;<br>            StrictMode.enableDeathOnFileUriExposure();<br>        &#125;<br>       ......<br><br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">         * 因为前面重置了时区，所以这里需要初始化http代理.</span><br><span class="hljs-comment">         * 这里也是AIDL的运用</span><br><span class="hljs-comment">         */</span><br>        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">&quot;Setup proxies&quot;</span>);<br>        <span class="hljs-keyword">final</span> IBinder b = ServiceManager.getService(Context.CONNECTIVITY_SERVICE);<br>        <span class="hljs-keyword">if</span> (b != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">final</span> IConnectivityManager service = IConnectivityManager.Stub.asInterface(b);<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">final</span> ProxyInfo proxyInfo = service.getProxyForNetwork(<span class="hljs-literal">null</span>);<br>                Proxy.setHttpProxySystemProperty(proxyInfo);<br>            &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br>                <span class="hljs-keyword">throw</span> e.rethrowFromSystemServer();<br>            &#125;<br>        &#125;<br>        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br><br>        <span class="hljs-comment">// Instrumentation会影响类加载器，所以在设置app的context之前初始化.</span><br>        <span class="hljs-keyword">final</span> InstrumentationInfo ii;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.instrumentationName != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                ii = new ApplicationPackageManager(<span class="hljs-literal">null</span>, getPackageManager())<br>                        .getInstrumentationInfo(<span class="hljs-keyword">data</span>.instrumentationName, <span class="hljs-number">0</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;<br>                <span class="hljs-keyword">throw</span> new RuntimeException(<br>                        <span class="hljs-string">&quot;Unable to find instrumentation info for: &quot;</span> + <span class="hljs-keyword">data</span>.instrumentationName);<br>            &#125;<br><br>            mInstrumentationPackageName = ii.packageName;<br>            mInstrumentationAppDir = ii.sourceDir;<br>            mInstrumentationSplitAppDirs = ii.splitSourceDirs;<br>            mInstrumentationLibDir = getInstrumentationLibrary(<span class="hljs-keyword">data</span>.appInfo, ii);<br>            mInstrumentedAppDir = <span class="hljs-keyword">data</span>.info.getAppDir();<br>            mInstrumentedSplitAppDirs = <span class="hljs-keyword">data</span>.info.getSplitAppDirs();<br>            mInstrumentedLibDir = <span class="hljs-keyword">data</span>.info.getLibDir();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            ii = <span class="hljs-literal">null</span>;<br>        &#125;<br>        <br>		<span class="hljs-comment">//创建ContextImpl上下文</span><br>        <span class="hljs-keyword">final</span> ContextImpl appContext = ContextImpl.createAppContext(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">data</span>.info);<br>        updateLocaleListFromAppContext(appContext,<br>                mResourcesManager.getConfiguration().getLocales());<br><br>        <span class="hljs-keyword">if</span> (!Process.isIsolated() &amp;&amp; !<span class="hljs-string">&quot;android&quot;</span>.equals(appContext.getPackageName())) &#123;<br>            <span class="hljs-keyword">final</span> File cacheDir = appContext.getCacheDir();<br>            <span class="hljs-keyword">if</span> (cacheDir != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// 设置临时文件缓存目录</span><br>                System.setProperty(<span class="hljs-string">&quot;java.io.tmpdir&quot;</span>, cacheDir.getAbsolutePath());<br>            &#125; <br>            <span class="hljs-comment">// 设置 generated/compiled graphics code 的缓存位置.</span><br>            <span class="hljs-keyword">final</span> Context deviceContext = appContext.createDeviceProtectedStorageContext();<br>            <span class="hljs-keyword">final</span> File codeCacheDir = deviceContext.getCodeCacheDir();<br>            <span class="hljs-keyword">if</span> (codeCacheDir != <span class="hljs-literal">null</span>) &#123;<br>                setupGraphicsSupport(<span class="hljs-keyword">data</span>.info, codeCacheDir);<br>            &#125; <br>        &#125;<br><br>        <span class="hljs-comment">// 安装 Network Security Config Provider. 必须在应用程序代码加载前安装</span><br>        NetworkSecurityConfigProvider.install(appContext);<br><br>        <span class="hljs-comment">// 继续实例化instrumentation.</span><br>        <span class="hljs-keyword">if</span> (ii != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">final</span> ApplicationInfo instrApp = new ApplicationInfo();<br>            ii.copyTo(instrApp);<br>            instrApp.initForUser(UserHandle.myUserId());<br>            <span class="hljs-keyword">final</span> LoadedApk pi = getPackageInfo(instrApp, <span class="hljs-keyword">data</span>.compatInfo,<br>                    appContext.getClassLoader(), <span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);<br>            <span class="hljs-keyword">final</span> ContextImpl instrContext = ContextImpl.createAppContext(<span class="hljs-keyword">this</span>, pi);<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-keyword">final</span> ClassLoader cl = instrContext.getClassLoader();<br>                mInstrumentation = (Instrumentation)<br>                    cl.loadClass(<span class="hljs-keyword">data</span>.instrumentationName.getClassName()).newInstance();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                <span class="hljs-keyword">throw</span> new RuntimeException(<br>                    <span class="hljs-string">&quot;Unable to instantiate instrumentation &quot;</span><br>                    + <span class="hljs-keyword">data</span>.instrumentationName + <span class="hljs-string">&quot;: &quot;</span> + e.toString(), e);<br>            &#125;<br><br>            <span class="hljs-keyword">final</span> ComponentName component = new ComponentName(ii.packageName, ii.name);<br>            mInstrumentation.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>, instrContext, appContext, component,<br>                    <span class="hljs-keyword">data</span>.instrumentationWatcher, <span class="hljs-keyword">data</span>.instrumentationUiAutomationConnection);<br><br>            <span class="hljs-keyword">if</span> (mProfiler.profileFile != <span class="hljs-literal">null</span> &amp;&amp; !ii.handleProfiling<br>                    &amp;&amp; mProfiler.profileFd == <span class="hljs-literal">null</span>) &#123;<br>                mProfiler.handlingProfiling = <span class="hljs-literal">true</span>;<br>                <span class="hljs-keyword">final</span> File file = new File(mProfiler.profileFile);<br>                file.getParentFile().mkdirs();<br>                Debug.startMethodTracing(file.toString(), <span class="hljs-number">8</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>        	<span class="hljs-comment">//第一次进来肯定是null，在这里实例化，所有activity的生命周期方法回调前都会调用该对象相关方法</span><br>            mInstrumentation = new Instrumentation();<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">data</span>.appInfo.flags&amp;ApplicationInfo.FLAG_LARGE_HEAP) != <span class="hljs-number">0</span>) &#123;<br>        	<span class="hljs-comment">//清除内存增长上限</span><br>            dalvik.system.VMRuntime.getRuntime().clearGrowthLimit();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// Small heap, clamp to the current growth limit and let the heap release</span><br>            <span class="hljs-comment">// pages after the growth limit to the non growth limit capacity. b/18387825</span><br>            dalvik.system.VMRuntime.getRuntime().clampGrowthLimit();<br>        &#125;<br><br>        <span class="hljs-comment">// 应用程序和provider在设置期间允许磁盘访问，这有可能会阻塞ordered broadcasts的处理</span><br>        <span class="hljs-keyword">final</span> StrictMode.ThreadPolicy savedPolicy = StrictMode.allowThreadDiskWrites();<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 此处data.info是指LoadedApk, 通过反射创建目标应用Application对象</span><br>            Application app = <span class="hljs-keyword">data</span>.info.makeApplication(<span class="hljs-keyword">data</span>.restrictedBackupMode, <span class="hljs-literal">null</span>);<br>            mInitialApplication = app;<br><br>            <span class="hljs-comment">// 不要在 restricted 模式中提供provider; 他们可能依赖于APP自定义的类</span><br>            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">data</span>.restrictedBackupMode) &#123;<br>                <span class="hljs-keyword">if</span> (!ArrayUtils.isEmpty(<span class="hljs-keyword">data</span>.providers)) &#123;<br>                    installContentProviders(app, <span class="hljs-keyword">data</span>.providers);<br>                    <span class="hljs-comment">// 对于包含content provider的进程，我们希望在某个时刻启用JIT</span><br>                    mH.sendEmptyMessageDelayed(H.ENABLE_JIT, <span class="hljs-number">10</span>*<span class="hljs-number">1000</span>);<br>                &#125;<br>            &#125;<br><br>			<span class="hljs-comment">//在mInstrumentation启动时，在加载任何应用程序代码之前调用。 </span><br>			<span class="hljs-comment">//通常会被重写调用&#123;@link #start&#125;来开始检测线程，然后将继续在&#123;@link #onStart&#125;中执行。</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                mInstrumentation.onCreate(<span class="hljs-keyword">data</span>.instrumentationArgs);<br>            &#125;<br>            <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                <span class="hljs-keyword">throw</span> new RuntimeException(<br>                    <span class="hljs-string">&quot;Exception thrown in onCreate() of &quot;</span><br>                    + <span class="hljs-keyword">data</span>.instrumentationName + <span class="hljs-string">&quot;: &quot;</span> + e.toString(), e);<br>            &#125;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>            	<span class="hljs-comment">//调用Application.onCreate()回调方法</span><br>                mInstrumentation.callApplicationOnCreate(app);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                <span class="hljs-keyword">if</span> (!mInstrumentation.onException(app, e)) &#123;<br>                    <span class="hljs-keyword">throw</span> new RuntimeException(<br>                        <span class="hljs-string">&quot;Unable to create application &quot;</span> + app.getClass().getName()<br>                        + <span class="hljs-string">&quot;: &quot;</span> + e.toString(), e);<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            StrictMode.setThreadPolicy(savedPolicy);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>这个方法很长，工作内容如下：</p>
<ul>
<li>对进程基本参数的设置，比如进程名，时区，资源及兼容性设置；同时添加了对开发者的限制，如不能在主线程使用网络</li>
<li>通过getPackageInfoNoCheck获取LoadedApk对象</li>
<li>实例化ContextImpl，Instrumentation等对象</li>
<li>通过LoadedApk.makeApplication创建应用Application对象</li>
<li>调用Instrumentation.callApplicationOnCreate</li>
</ul>
<h4 id="4-4-19-AT-getPackageInfoNoCheck"><a href="#4-4-19-AT-getPackageInfoNoCheck" class="headerlink" title="4.4.19 AT.getPackageInfoNoCheck()"></a>4.4.19 AT.getPackageInfoNoCheck()</h4><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs aspectj"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-function">LoadedApk <span class="hljs-title">getPackageInfoNoCheck</span><span class="hljs-params">(ApplicationInfo ai,</span></span><br><span class="hljs-params"><span class="hljs-function">            CompatibilityInfo compatInfo)</span> </span>&#123;<br>        <span class="hljs-function"><span class="hljs-keyword">return</span> <span class="hljs-title">getPackageInfo</span><span class="hljs-params">(ai, compatInfo, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>)</span></span>;<br>    &#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-function">LoadedApk <span class="hljs-title">getPackageInfo</span><span class="hljs-params">(ApplicationInfo aInfo, CompatibilityInfo compatInfo,</span></span><br><span class="hljs-params"><span class="hljs-function">            ClassLoader baseLoader, <span class="hljs-keyword">boolean</span> securityViolation, <span class="hljs-keyword">boolean</span> includeCode,</span></span><br><span class="hljs-params"><span class="hljs-function">            <span class="hljs-keyword">boolean</span> registerPackage)</span> </span>&#123;<br>         <span class="hljs-comment">//判断调用方和应用程序是不是同一个用户，如果不是，就不允许跨用户访问</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">boolean</span> differentUser = (UserHandle.myUserId() != UserHandle.getUserId(aInfo.uid));<br>        <span class="hljs-keyword">synchronized</span> (mResourcesManager) &#123;<br>            WeakReference&lt;LoadedApk&gt; ref;<br>            <span class="hljs-keyword">if</span> (differentUser) &#123;<br>                <span class="hljs-comment">// 不支持跨用户访问缓存</span><br>                ref = <span class="hljs-keyword">null</span>;<br>            &#125; <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(includeCode)</span> </span>&#123;<br>            	<span class="hljs-comment">//进入到这个分支，根据应用包名从mPackages获取，也就是说每个app都会拥有唯一的LoadedApk对象</span><br>                ref = mPackages.get(aInfo.packageName);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                ref = mResourcePackages.get(aInfo.packageName);<br>            &#125;<br><br>            LoadedApk packageInfo = ref != <span class="hljs-keyword">null</span> ? ref.get() : <span class="hljs-keyword">null</span>;<br>            <span class="hljs-comment">//刚进来这个为null</span><br>            <span class="hljs-keyword">if</span> (packageInfo == <span class="hljs-keyword">null</span> || (packageInfo.mResources != <span class="hljs-keyword">null</span><br>                    &amp;&amp; !packageInfo.mResources.getAssets().isUpToDate())) &#123;<br><br>				<span class="hljs-comment">//创建LoadedApk对象</span><br>                packageInfo = <span class="hljs-keyword">new</span> LoadedApk(<span class="hljs-keyword">this</span>, aInfo, compatInfo, baseLoader,<br>                            		securityViolation, includeCode &amp;&amp;<br>                            			(aInfo.flags&amp;ApplicationInfo.FLAG_HAS_CODE) != <span class="hljs-number">0</span>, registerPackage);<br><br>                <span class="hljs-keyword">if</span> (mSystemThread &amp;&amp; <span class="hljs-string">&quot;android&quot;</span>.equals(aInfo.packageName)) &#123;<br>                    packageInfo.installSystemApplicationInfo(aInfo,<br>                            getSystemContext().mPackageInfo.getClassLoader());<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (differentUser) &#123;<br>                    <span class="hljs-comment">// Caching not supported across users</span><br>                &#125; <span class="hljs-function"><span class="hljs-keyword">else</span> <span class="hljs-title">if</span> <span class="hljs-params">(includeCode)</span> </span>&#123;<br>                	<span class="hljs-comment">//将新创建的LoadedApk加入到mPackages</span><br>                    mPackages.put(aInfo.packageName,<br>                            <span class="hljs-keyword">new</span> WeakReference&lt;LoadedApk&gt;(packageInfo));<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    mResourcePackages.put(aInfo.packageName,<br>                            <span class="hljs-keyword">new</span> WeakReference&lt;LoadedApk&gt;(packageInfo));<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">return</span> packageInfo;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>这里返回一个LoadedApk对象，这个对象有什么作用呢？</p>
<p>注意：LoadedApk对象是APK文件在内存中的表示，包含apk文件的相关信息，比如应用代码，资源文件，app里的activity和service等都可以从这获取，在使用类加载器的时候需要用到这个对象</p>
<h4 id="4-4-20-LoadedApk-makeApplication"><a href="#4-4-20-LoadedApk-makeApplication" class="headerlink" title="4.4.20  LoadedApk.makeApplication()"></a>4.4.20  LoadedApk.makeApplication()</h4><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs processing"><span class="hljs-keyword">public</span> Application makeApplication(<span class="hljs-built_in">boolean</span> forceDefaultAppClass,<br>            Instrumentation instrumentation) &#123;<br>        <span class="hljs-keyword">if</span> (mApplication != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> mApplication;<br>        &#125;<br><br>        Application app = <span class="hljs-keyword">null</span>;<br><br>        <span class="hljs-keyword">String</span> appClass = mApplicationInfo.className;<br>        <span class="hljs-keyword">if</span> (forceDefaultAppClass || (appClass == <span class="hljs-keyword">null</span>)) &#123;<br>            appClass = <span class="hljs-string">&quot;android.app.Application&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>        	<span class="hljs-comment">//类加载器</span><br>            java.lang.ClassLoader cl = getClassLoader();<br>            <span class="hljs-keyword">if</span> (!mPackageName.equals(<span class="hljs-string">&quot;android&quot;</span>)) &#123;<br>                initializeJavaContextClassLoader();<br>            &#125;<br>            <span class="hljs-comment">//创建ContextImpl，在组件中对Context的操作都会转移到这个类</span><br>            ContextImpl appContext = ContextImpl.createAppContext(mActivityThread, <span class="hljs-keyword">this</span>);<br>            <span class="hljs-comment">//创建Application</span><br>            app = mActivityThread.mInstrumentation.newApplication(<br>                    cl, appClass, appContext);<br>            appContext.setOuterContext(app);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">if</span> (!mActivityThread.mInstrumentation.onException(app, e)) &#123;<br>                Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(<br>                    <span class="hljs-string">&quot;Unable to instantiate application &quot;</span> + appClass<br>                    + <span class="hljs-string">&quot;: &quot;</span> + e.toString(), e);<br>            &#125;<br>        &#125;<br>        mActivityThread.mAllApplications.<span class="hljs-built_in">add</span>(app);<br>        <span class="hljs-comment">//给mApplication赋值</span><br>        mApplication = app;<br><br>        ......<br>        <br>        SparseArray&lt;<span class="hljs-keyword">String</span>&gt; packageIdentifiers = getAssets(mActivityThread)<br>            .getAssignedPackageIdentifiers();<br>    		<span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> N = packageIdentifiers.<span class="hljs-built_in">size</span>();<br>    		<span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; N; i++) &#123;<br>	        <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> id = packageIdentifiers.keyAt(i);<br>	        <span class="hljs-keyword">if</span> (id == <span class="hljs-number">0x01</span> || id == <span class="hljs-number">0x7f</span>) &#123;<br>	            <span class="hljs-keyword">continue</span>;<br>        	&#125;<br>        	<span class="hljs-comment">//重写所有apk库中的R常量</span><br>        	rewriteRValues(getClassLoader(), packageIdentifiers.valueAt(i), id);<br>    	  &#125;<br><br>        <span class="hljs-keyword">return</span> app;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-4-21-Instrumentation-newApplication"><a href="#4-4-21-Instrumentation-newApplication" class="headerlink" title="4.4.21 Instrumentation.newApplication()"></a>4.4.21 Instrumentation.newApplication()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">public Application <span class="hljs-keyword">new</span><span class="hljs-constructor">Application(ClassLoader <span class="hljs-params">cl</span>, String <span class="hljs-params">className</span>, Context <span class="hljs-params">context</span>)</span><br>            throws InstantiationException, IllegalAccessException, <br>            ClassNotFoundException &#123;<br>        return <span class="hljs-keyword">new</span><span class="hljs-constructor">Application(<span class="hljs-params">cl</span>.<span class="hljs-params">loadClass</span>(<span class="hljs-params">className</span>)</span>, context);<br>    &#125;<br>static public Application <span class="hljs-keyword">new</span><span class="hljs-constructor">Application(Class&lt;?&gt; <span class="hljs-params">clazz</span>, Context <span class="hljs-params">context</span>)</span><br>            throws InstantiationException, IllegalAccessException, <br>            ClassNotFoundException &#123;<br>        Application app = (Application)clazz.<span class="hljs-keyword">new</span><span class="hljs-constructor">Instance()</span>;<br>        app.attach(context);<br>        return app;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>这里通过反射实例化Application ，然后调用attach</p>
<h4 id="4-4-22-Application-attach"><a href="#4-4-22-Application-attach" class="headerlink" title="4.4.22 Application.attach()"></a>4.4.22 Application.attach()</h4><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs reasonml">final void attach(Context context) &#123;<br>		<span class="hljs-comment">//给ContextWrapper对象中指定真正的Context（这里的Context实际类型是ContextImpl ）对象</span><br>        attach<span class="hljs-constructor">BaseContext(<span class="hljs-params">context</span>)</span>;<br>        mLoadedApk = <span class="hljs-module-access"><span class="hljs-module"><span class="hljs-identifier">ContextImpl</span>.</span></span>get<span class="hljs-constructor">Impl(<span class="hljs-params">context</span>)</span>.mPackageInfo;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-4-23-ContextWrapper-attachBaseContext"><a href="#4-4-23-ContextWrapper-attachBaseContext" class="headerlink" title="4.4.23 ContextWrapper.attachBaseContext()"></a>4.4.23 ContextWrapper.attachBaseContext()</h4><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs csharp"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">attachBaseContext</span>(<span class="hljs-params">Context <span class="hljs-keyword">base</span></span>)</span> &#123;<br>        <span class="hljs-keyword">if</span> (mBase != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;Base context already set&quot;</span>);<br>        &#125;<br>        mBase = <span class="hljs-keyword">base</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>这里对mBase 进行赋值，实际类型是ContextImpl</p>
<h4 id="4-4-24-Instrumentation-callApplicationOnCreate"><a href="#4-4-24-Instrumentation-callApplicationOnCreate" class="headerlink" title="4.4.24  Instrumentation.callApplicationOnCreate()"></a>4.4.24  Instrumentation.callApplicationOnCreate()</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-function"><span class="hljs-title">callApplicationOnCreate</span>(<span class="hljs-params">Application app</span>)</span> &#123;<br>        app.onCreate();<br>    &#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-4-25-Application-onCreate"><a href="#4-4-25-Application-onCreate" class="headerlink" title="4.4.25 Application.onCreate()"></a>4.4.25 Application.onCreate()</h4><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-comment">/**</span><br><span class="hljs-comment">     * 在应用启动时调用 ，在创建任何activity, service,receiver，content providers之前调用</span><br><span class="hljs-comment">     * 在此方法里操作要尽可能快（比如状态的延迟初始化），因为在这里花费太长时间将会直接影响第一个</span><br><span class="hljs-comment">     * activity, service,receiver，content providers的性能</span><br><span class="hljs-comment">     * 如果重写这个方法，请务必调用super.onCreate（）</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-meta">@CallSuper</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-function"><span class="hljs-title">onCreate</span>(<span class="hljs-params"></span>)</span> &#123;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>这里就会回调Application的onCreate方法，我们通常会继承这个类，重写这个方法，做一些APP的初始化操作，但是切记不要做耗时复杂操作，因为这里应用才刚创建，还在初始化，可能会导致应用启动黑屏一段时间的情况</p>
<p>AMS.attachApplicationLocked方法执行完bindApplication后，对照着顶部目录看，接下来就是该方法第七步，启动Activity等操作了</p>
<h4 id="4-4-26-ActivityStackSupervisor-attachApplicationLocked"><a href="#4-4-26-ActivityStackSupervisor-attachApplicationLocked" class="headerlink" title="4.4.26 ActivityStackSupervisor.attachApplicationLocked()"></a>4.4.26 ActivityStackSupervisor.attachApplicationLocked()</h4><figure class="highlight arduino"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs arduino"><span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">attachApplicationLocked</span><span class="hljs-params">(ProcessRecord app)</span> throws RemoteException </span>&#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-keyword">String</span> processName = app.processName;<br>        <span class="hljs-keyword">boolean</span> didSomething = <span class="hljs-literal">false</span>;<br>        <span class="hljs-comment">//这里维护着这台设备上所有应用的activitystack，即app的任务栈</span><br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> displayNdx = mActivityDisplays.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>; displayNdx &gt;= <span class="hljs-number">0</span>; --displayNdx) &#123;<br>        	<span class="hljs-comment">//取出其中一个任务栈</span><br>            ArrayList&lt;ActivityStack&gt; stacks = mActivityDisplays.<span class="hljs-built_in">valueAt</span>(displayNdx).mStacks;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> stackNdx = stacks.<span class="hljs-built_in">size</span>() - <span class="hljs-number">1</span>; stackNdx &gt;= <span class="hljs-number">0</span>; --stackNdx) &#123;<br>                <span class="hljs-keyword">final</span> ActivityStack stack = stacks.<span class="hljs-built_in">get</span>(stackNdx);<br>                <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">isFocusedStack</span>(stack)) &#123;<br>                    <span class="hljs-keyword">continue</span>;<br>                &#125;<br>                <span class="hljs-comment">//取出当前任务栈中处于栈顶且运行的activity</span><br>                ActivityRecord hr = stack.<span class="hljs-built_in">topRunningActivityLocked</span>();<br>                <span class="hljs-keyword">if</span> (hr != null) &#123;<br>                	<span class="hljs-comment">//判断这个activity所在进程是否与当前调用的进程信息是否一致</span><br>                    <span class="hljs-keyword">if</span> (hr.app == null &amp;&amp; app.uid == hr.info.applicationInfo.uid<br>                            &amp;&amp; processName.<span class="hljs-built_in">equals</span>(hr.processName)) &#123;<br>                        <span class="hljs-keyword">try</span> &#123;<br>                        	<span class="hljs-comment">//真正启动activity</span><br>                            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">realStartActivityLocked</span>(hr, app, <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>)) &#123;<br>                                didSomething = <span class="hljs-literal">true</span>;<br>                            &#125;<br>                        &#125; <span class="hljs-built_in"><span class="hljs-keyword">catch</span></span> (RemoteException e) &#123;<br>                            <span class="hljs-keyword">throw</span> e;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!didSomething) &#123;<br>        		<span class="hljs-comment">//启动失败，需要确保一个可显示的activity</span><br>            <span class="hljs-built_in">ensureActivitiesVisibleLocked</span>(null, <span class="hljs-number">0</span>, !PRESERVE_WINDOWS);<br>        &#125;<br>        <span class="hljs-keyword">return</span> didSomething;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>接下来就要真正启动activity了，到这里也快接近尾声了</p>
<h4 id="4-4-27-ActivityStackSupervisor-realStartActivityLocked"><a href="#4-4-27-ActivityStackSupervisor-realStartActivityLocked" class="headerlink" title="4.4.27 ActivityStackSupervisor.realStartActivityLocked()"></a>4.4.27 ActivityStackSupervisor.realStartActivityLocked()</h4><figure class="highlight lasso"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs lasso">final <span class="hljs-built_in">boolean</span> realStartActivityLocked(ActivityRecord r, ProcessRecord app,<br>            <span class="hljs-built_in">boolean</span> andResume, <span class="hljs-built_in">boolean</span> checkConfig) throws RemoteException &#123;<br>				<br>				<span class="hljs-comment">//如果activity正在pausing，那就跳过</span><br>        <span class="hljs-keyword">if</span> (!allPausedActivitiesComplete()) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (andResume) &#123;<br>            r.startFreezingScreenLocked(app, <span class="hljs-number">0</span>);<br>            mWindowManager.setAppVisibility(r.appToken, <span class="hljs-literal">true</span>);<br>            <span class="hljs-comment">// 启动ticks以收集有关慢速APP的信息。</span><br>            r.startLaunchTickingLocked();<br>        &#125;<br><br>        <span class="hljs-comment">// 让window manager根据新的activity顺序重新评估屏幕方向</span><br>        <span class="hljs-keyword">if</span> (checkConfig) &#123;<br>            Configuration config = mWindowManager.updateOrientationFromAppTokens(<br>                    mService.mConfiguration,<br>                    r.mayFreezeScreenLocked(app) ? r.appToken : <span class="hljs-built_in">null</span>);<br>            mService.updateConfigurationLocked(config, r, <span class="hljs-literal">false</span>);<br>        &#125;<br><br>				<span class="hljs-params">...</span><span class="hljs-params">...</span><br><br>        final ActivityStack <span class="hljs-built_in">stack</span> = task.<span class="hljs-built_in">stack</span>;<br>        try &#123;<br>            <span class="hljs-params">...</span><span class="hljs-params">...</span><br>            <br>            <span class="hljs-comment">//将该进程设置为前台进程PROCESS_STATE_TOP</span><br>            app.forceProcessStateUpTo(mService.mTopProcessState);<br>            <span class="hljs-comment">//启动activity</span><br>            app.<span class="hljs-keyword">thread</span>.scheduleLaunchActivity(<span class="hljs-literal">new</span> Intent(r.intent), r.appToken,<br>                    System.identityHashCode(r), r.info, <span class="hljs-literal">new</span> Configuration(mService.mConfiguration),<br>                    <span class="hljs-literal">new</span> Configuration(task.mOverrideConfig), r.compat, r.launchedFromPackage,<br>                    task.voiceInteractor, app.repProcState, r.icicle, r.persistentState, results,<br>                    newIntents, !andResume, mService.isNextTransitionForward(), profilerInfo);<br><br>            <span class="hljs-keyword">if</span> ((app.info.privateFlags&amp;ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE) != <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// 处理heavy-weight process</span><br>                <span class="hljs-keyword">if</span> (app.processName.<span class="hljs-keyword">equals</span>(app.info.packageName)) &#123;<br>                    <span class="hljs-keyword">if</span> (mService.mHeavyWeightProcess != <span class="hljs-built_in">null</span><br>                            &amp;&amp; mService.mHeavyWeightProcess != app) &#123;<br>                        Slog.w(<span class="hljs-built_in">TAG</span>, <span class="hljs-string">&quot;Starting new heavy weight process &quot;</span> + app<br>                                + <span class="hljs-string">&quot; when already running &quot;</span><br>                                + mService.mHeavyWeightProcess);<br>                    &#125;<br>                    mService.mHeavyWeightProcess = app;<br>                    Message msg = mService.mHandler.obtainMessage(<br>                            ActivityManagerService.POST_HEAVY_NOTIFICATION_MSG);<br>                    msg.obj = r;<br>                    mService.mHandler.sendMessage(msg);<br>                &#125;<br>            &#125;<br><br>        &#125; catch (RemoteException e) &#123;<br>            <span class="hljs-keyword">if</span> (r.launchFailed) &#123;<br>                <span class="hljs-comment">// 第二次启动失败就放弃 并finish该activity</span><br>                mService.appDiedLocked(app);<br>                <span class="hljs-built_in">stack</span>.requestFinishActivityLocked(r.appToken, Activity.RESULT_CANCELED, <span class="hljs-built_in">null</span>,<br>                        <span class="hljs-string">&quot;2nd-crash&quot;</span>, <span class="hljs-literal">false</span>);<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// 第一次启动失败就重启该进程</span><br>            app.activities.remove(r);<br>            throw e;<br>        &#125;<br><br>        r.launchFailed = <span class="hljs-literal">false</span>;<br>        <span class="hljs-comment">//将该进程加入到mLRUActivities队列顶部</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">stack</span>.updateLRUListLocked(r)) &#123;<br>        &#125;<br><br>				<span class="hljs-params">...</span><span class="hljs-params">...</span><br><br>        <span class="hljs-comment">//更新所有与该Activity具有绑定关系的Service连接</span><br>        <span class="hljs-keyword">if</span> (r.app != <span class="hljs-built_in">null</span>) &#123;<br>            mService.mServices.updateServiceConnectionActivitiesLocked(r.app);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>这个方法里这最重要的一步就是app.thread.scheduleLaunchActivity，这里又是一个AIDL实现，app.thread的实际类型是客户端进程在AMS端进程的代理，即ATP；接下来具体过程跟上面分析thread.scheduleExit()的时候一样，这里就不在具体阐述了，直接到ActivityThread</p>
<h4 id="4-4-28-AT-handleLaunchActivity"><a href="#4-4-28-AT-handleLaunchActivity" class="headerlink" title="4.4.28 AT.handleLaunchActivity()"></a>4.4.28 AT.handleLaunchActivity()</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><code class="hljs scala"><span class="hljs-keyword">private</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">H</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Handler</span> </span>&#123;<br>			public void handleMessage(<span class="hljs-type">Message</span> msg) &#123;<br>            switch (msg.what) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-type">LAUNCH_ACTIVITY</span>: &#123;<br>                    <span class="hljs-keyword">final</span> <span class="hljs-type">ActivityClientRecord</span> r = (<span class="hljs-type">ActivityClientRecord</span>) msg.obj;<br>                    <span class="hljs-comment">//获取LoadedApk对象</span><br>                    r.packageInfo = getPackageInfoNoCheck(<br>                            r.activityInfo.applicationInfo, r.compatInfo);<br>                    handleLaunchActivity(r, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;LAUNCH_ACTIVITY&quot;</span>);<br>                &#125; <span class="hljs-keyword">break</span>;<br>            &#125;<br>      &#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> void handleLaunchActivity(<span class="hljs-type">ActivityClientRecord</span> r, <span class="hljs-type">Intent</span> customIntent, <span class="hljs-type">String</span> reason) &#123;<br><br>        unscheduleGcIdler();<br>        mSomeActivitiesChanged = <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-keyword">if</span> (r.profilerInfo != <span class="hljs-literal">null</span>) &#123;<br>            mProfiler.setProfiler(r.profilerInfo);<br>            mProfiler.startProfiling();<br>        &#125;<br><br>        <span class="hljs-comment">//最终回调目标Activity的onConfigurationChanged()</span><br>        handleConfigurationChanged(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br><br>        <span class="hljs-comment">// 在创建activity之前初始化wms</span><br>        <span class="hljs-type">WindowManagerGlobal</span>.initialize();<br>		<span class="hljs-comment">//最终回调目标Activity的onCreate</span><br>        <span class="hljs-type">Activity</span> a = performLaunchActivity(r, customIntent);<br><br>        <span class="hljs-keyword">if</span> (a != <span class="hljs-literal">null</span>) &#123;<br>            r.createdConfig = <span class="hljs-keyword">new</span> <span class="hljs-type">Configuration</span>(mConfiguration);<br>            reportSizeConfigurations(r);<br>            <span class="hljs-type">Bundle</span> oldState = r.state;<br>            <span class="hljs-comment">//最终回调目标Activity的onStart,onResume</span><br>            handleResumeActivity(r.token, <span class="hljs-literal">false</span>, r.isForward,<br>                    !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);<br><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 如果失败或者其它原因就通知 activity manager 去stop activity.</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">ActivityManagerNative</span>.getDefault()<br>                    .finishActivity(r.token, <span class="hljs-type">Activity</span>.<span class="hljs-type">RESULT_CANCELED</span>, <span class="hljs-literal">null</span>,<br>                            <span class="hljs-type">Activity</span>.<span class="hljs-type">DONT_FINISH_TASK_WITH_ACTIVITY</span>);<br>            &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-type">RemoteException</span> ex) &#123;<br>                <span class="hljs-keyword">throw</span> ex.rethrowFromSystemServer();<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>这里调用了两个关键方法</p>
<ul>
<li>performLaunchActivity</li>
<li>handleResumeActivity</li>
</ul>
<h4 id="4-4-29-AT-performLaunchActivity"><a href="#4-4-29-AT-performLaunchActivity" class="headerlink" title="4.4.29 AT.performLaunchActivity()"></a>4.4.29 AT.performLaunchActivity()</h4><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><code class="hljs haxe"><span class="hljs-keyword">private</span> Activity performLaunchActivity(ActivityClientRecord r, Intent customIntent) &#123;<br><br>		<span class="hljs-comment">//获取待启动的Activity的组件信息</span><br>        ActivityInfo aInfo = r.activityInfo;<br>        <span class="hljs-keyword">if</span> (r.packageInfo == <span class="hljs-literal">null</span>) &#123;<br>            r.packageInfo = getPackageInfo(aInfo.applicationInfo, r.compatInfo,<br>                    Context.CONTEXT_INCLUDE_CODE);<br>        &#125;<br>        ComponentName component = r.intent.getComponent();<br>        <span class="hljs-keyword">if</span> (component == <span class="hljs-literal">null</span>) &#123;<br>            component = r.intent.resolveActivity(<br>                mInitialApplication.getPackageManager());<br>            r.intent.setComponent(component);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (r.activityInfo.targetActivity != <span class="hljs-literal">null</span>) &#123;<br>            component = <span class="hljs-keyword">new</span> <span class="hljs-type">ComponentName</span>(r.activityInfo.packageName,<br>                    r.activityInfo.targetActivity);<br>        &#125;<br><br>        Activity activity = <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>        	<span class="hljs-comment">//通过类加载器加载activity实例</span><br>            java.lang.ClassLoader cl = r.packageInfo.getClassLoader();<br>            activity = mInstrumentation.<span class="hljs-keyword">new</span><span class="hljs-type">Activity</span>(<br>                    cl, component.getClassName(), r.intent);<br>            StrictMode.incrementExpectedActivityCount(activity.getClass());<br>            r.intent.setExtrasClassLoader(cl);<br>            r.intent.prepareToEnterProcess();<br>            <span class="hljs-keyword">if</span> (r.state != <span class="hljs-literal">null</span>) &#123;<br>                r.state.setClassLoader(cl);<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">RuntimeException</span>(<br>                    <span class="hljs-string">&quot;Unable to instantiate activity &quot;</span> + component<br>                    + <span class="hljs-string">&quot;: &quot;</span> + e.toString(), e);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            Application app = r.packageInfo.makeApplication(<span class="hljs-literal">false</span>, mInstrumentation);<br><br>            <span class="hljs-keyword">if</span> (activity != <span class="hljs-literal">null</span>) &#123;<br>            	<span class="hljs-comment">//创建该activity的context实例，实际类型是ContextImpl</span><br>                Context appContext = createBaseContextForActivity(r, activity);<br>                CharSequence title = r.activityInfo.loadLabel(appContext.getPackageManager());<br>                Configuration config = <span class="hljs-keyword">new</span> <span class="hljs-type">Configuration</span>(mCompatConfiguration);<br>                <span class="hljs-keyword">if</span> (r.overrideConfig != <span class="hljs-literal">null</span>) &#123;<br>                    config.updateFrom(r.overrideConfig);<br>                &#125;<br>                <br>                Window window = <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">if</span> (r.mPendingRemoveWindow != <span class="hljs-literal">null</span> &amp;&amp; r.mPreserveWindow) &#123;<br>                    window = r.mPendingRemoveWindow;<br>                    r.mPendingRemoveWindow = <span class="hljs-literal">null</span>;<br>                    r.mPendingRemoveWindowManager = <span class="hljs-literal">null</span>;<br>                &#125;<br>                <span class="hljs-comment">//在这个方法里关联context，并进行Activity一些初始化操作,</span><br>                <span class="hljs-comment">//比如完成Window的创建并建立自己和Window的关联</span><br>                <span class="hljs-comment">//这样当Window接收到外部输入事件后就可以将事件传递给Activity；</span><br>                <span class="hljs-comment">//维护一个Instrumentation引用</span><br>                activity.attach(appContext, <span class="hljs-built_in">this</span>, getInstrumentation(), r.token,<br>                        r.ident, app, r.intent, r.activityInfo, title, r.parent,<br>                        r.embeddedID, r.lastNonConfigurationInstances, config,<br>                        r.referrer, r.voiceInteractor, window);<br><br>                <span class="hljs-keyword">if</span> (customIntent != <span class="hljs-literal">null</span>) &#123;<br>                    activity.mIntent = customIntent;<br>                &#125;<br>                r.lastNonConfigurationInstances = <span class="hljs-literal">null</span>;<br>                activity.mStartedActivity = <span class="hljs-literal">false</span>;<br>                <span class="hljs-comment">//获取主题并设置</span><br>                int theme = r.activityInfo.getThemeResource();<br>                <span class="hljs-keyword">if</span> (theme != <span class="hljs-number">0</span>) &#123;<br>                    activity.setTheme(theme);<br>                &#125;<br><br>				<span class="hljs-comment">//回调activity的onCreate</span><br>                activity.mCalled = <span class="hljs-literal">false</span>;<br>                <span class="hljs-keyword">if</span> (r.isPersistable()) &#123;<br>                    mInstrumentation.callActivityOnCreate(activity, r.state, r.persistentState);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    mInstrumentation.callActivityOnCreate(activity, r.state);<br>                &#125;<br>                <span class="hljs-keyword">if</span> (!activity.mCalled) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">SuperNotCalledException</span>(<br>                        <span class="hljs-string">&quot;Activity &quot;</span> + r.intent.getComponent().toShortString() +<br>                        <span class="hljs-string">&quot; did not call through to super.onCreate()&quot;</span>);<br>                &#125;<br>                r.activity = activity;<br>                r.stopped = <span class="hljs-literal">true</span>;<br>                <span class="hljs-keyword">if</span> (!r.activity.mFinished) &#123;<br>                    activity.performStart();<br>                    r.stopped = <span class="hljs-literal">false</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (!r.activity.mFinished) &#123;<br>                		<span class="hljs-comment">//如果之前有保存数据，这里回调OnRestoreInstance</span><br>                    <span class="hljs-keyword">if</span> (r.isPersistable()) &#123;<br>                        <span class="hljs-keyword">if</span> (r.state != <span class="hljs-literal">null</span> || r.persistentState != <span class="hljs-literal">null</span>) &#123;<br>                            mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state,<br>                                    r.persistentState);<br>                        &#125;<br>                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (r.state != <span class="hljs-literal">null</span>) &#123;<br>                        mInstrumentation.callActivityOnRestoreInstanceState(activity, r.state);<br>                    &#125;<br>                &#125;<br>                <br>            &#125;<br>            r.paused = <span class="hljs-literal">true</span>;<br><br>            mActivities.put(r.token, r);<br><br>        &#125; <span class="hljs-keyword">catch</span> (SuperNotCalledException e) &#123;<br>            <span class="hljs-keyword">throw</span> e;<br><br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">if</span> (!mInstrumentation.onException(activity, e)) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-type">RuntimeException</span>(<br>                    <span class="hljs-string">&quot;Unable to start activity &quot;</span> + component<br>                    + <span class="hljs-string">&quot;: &quot;</span> + e.toString(), e);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> activity;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-4-30-AT-handleResumeActivity"><a href="#4-4-30-AT-handleResumeActivity" class="headerlink" title="4.4.30 AT.handleResumeActivity()"></a>4.4.30 AT.handleResumeActivity()</h4><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs dart"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> handleResumeActivity(IBinder token,<br>            boolean clearHide, boolean isForward, boolean reallyResume, <span class="hljs-built_in">int</span> seq, <span class="hljs-built_in">String</span> reason) &#123;<br>        ActivityClientRecord r = mActivities.<span class="hljs-keyword">get</span>(token);<br>        <br>        ......<br>        <span class="hljs-comment">//见下方</span><br>        r = performResumeActivity(token, clearHide, reason);<br><br>        <span class="hljs-keyword">if</span> (r != <span class="hljs-keyword">null</span>) &#123;<br>            <span class="hljs-keyword">final</span> Activity a = r.activity;<br><br>            <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> forwardBit = isForward ?<br>                    WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION : <span class="hljs-number">0</span>;<br><br>            <span class="hljs-comment">// 如果当前窗口没有添加到 window manager,并且它没有finished或者启动其它activity</span><br>            <span class="hljs-comment">// 那就继续添加到 window manager</span><br>            boolean willBeVisible = !a.mStartedActivity;<br>            <span class="hljs-keyword">if</span> (!willBeVisible) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    willBeVisible = ActivityManagerNative.getDefault().willActivityBeVisible(<br>                            a.getActivityToken());<br>                &#125; <span class="hljs-keyword">catch</span> (RemoteException e) &#123;<br>                    <span class="hljs-keyword">throw</span> e.rethrowFromSystemServer();<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (r.<span class="hljs-built_in">window</span> == <span class="hljs-keyword">null</span> &amp;&amp; !a.mFinished &amp;&amp; willBeVisible) &#123;<br>                r.<span class="hljs-built_in">window</span> = r.activity.getWindow();<br>                View decor = r.<span class="hljs-built_in">window</span>.getDecorView();<br>                decor.setVisibility(View.INVISIBLE);<br>                ViewManager wm = a.getWindowManager();<br>                WindowManager.LayoutParams l = r.<span class="hljs-built_in">window</span>.getAttributes();<br>                a.mDecor = decor;<br>                l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;<br>                l.softInputMode |= forwardBit;<br>                <span class="hljs-keyword">if</span> (r.mPreserveWindow) &#123;<br>                    a.mWindowAdded = <span class="hljs-keyword">true</span>;<br>                    r.mPreserveWindow = <span class="hljs-keyword">false</span>;<br>                    ViewRootImpl impl = decor.getViewRootImpl();<br>                    <span class="hljs-keyword">if</span> (impl != <span class="hljs-keyword">null</span>) &#123;<br>                        impl.notifyChildRebuilt();<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (a.mVisibleFromClient &amp;&amp; !a.mWindowAdded) &#123;<br>                    a.mWindowAdded = <span class="hljs-keyword">true</span>;<br>                    wm.addView(decor, l);<br>                &#125;<br><br>            <span class="hljs-comment">// 如果该窗口已经添加到了window manager，但是在resume期间，又启动了了一个activity</span><br>            <span class="hljs-comment">//那就设置窗口不可见</span><br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!willBeVisible) &#123;<br>                r.hideForNow = <span class="hljs-keyword">true</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// Get rid of anything left hanging around.</span><br>            cleanUpPendingRemoveWindows(r, <span class="hljs-keyword">false</span> <span class="hljs-comment">/* force */</span>);<br><br>            <span class="hljs-comment">// 如果窗口已经添加，没有finish，没有启动其它activity，那窗口可见</span><br>            <span class="hljs-keyword">if</span> (!r.activity.mFinished &amp;&amp; willBeVisible<br>                    &amp;&amp; r.activity.mDecor != <span class="hljs-keyword">null</span> &amp;&amp; !r.hideForNow) &#123;<br>                <span class="hljs-keyword">if</span> (r.newConfig != <span class="hljs-keyword">null</span>) &#123;<br>                    performConfigurationChangedForActivity(r, r.newConfig, REPORT_TO_ACTIVITY);<br>                    r.newConfig = <span class="hljs-keyword">null</span>;<br>                &#125;<br>               <br>               <span class="hljs-comment">//设置输入框显示模式</span><br>                WindowManager.LayoutParams l = r.<span class="hljs-built_in">window</span>.getAttributes();<br>                <span class="hljs-keyword">if</span> ((l.softInputMode<br>                        &amp; WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION)<br>                        != forwardBit) &#123;<br>                    l.softInputMode = (l.softInputMode<br>                            &amp; (~WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION))<br>                            | forwardBit;<br>                    <span class="hljs-keyword">if</span> (r.activity.mVisibleFromClient) &#123;<br>                        ViewManager wm = a.getWindowManager();<br>                        View decor = r.<span class="hljs-built_in">window</span>.getDecorView();<br>                        wm.updateViewLayout(decor, l);<br>                    &#125;<br>                &#125;<br>                r.activity.mVisibleFromServer = <span class="hljs-keyword">true</span>;<br>                mNumVisibleActivities++;<br>                <span class="hljs-comment">//将当前activity视图设置可见</span><br>                <span class="hljs-keyword">if</span> (r.activity.mVisibleFromClient) &#123;<br>                    r.activity.makeVisible();<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">// 告诉 activity manager 该activity已经 resumed.</span><br>            <span class="hljs-keyword">if</span> (reallyResume) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    ActivityManagerNative.getDefault().activityResumed(token);<br>                &#125; <span class="hljs-keyword">catch</span> (RemoteException ex) &#123;<br>                    <span class="hljs-keyword">throw</span> ex.rethrowFromSystemServer();<br>                &#125;<br>            &#125;<br><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 当 resume 失败, 就结束这个activity</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                ActivityManagerNative.getDefault()<br>                    .finishActivity(token, Activity.RESULT_CANCELED, <span class="hljs-keyword">null</span>,<br>                            Activity.DONT_FINISH_TASK_WITH_ACTIVITY);<br>            &#125; <span class="hljs-keyword">catch</span> (RemoteException ex) &#123;<br>                <span class="hljs-keyword">throw</span> ex.rethrowFromSystemServer();<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-4-31-AT-performResumeActivity"><a href="#4-4-31-AT-performResumeActivity" class="headerlink" title="4.4.31 AT.performResumeActivity()"></a>4.4.31 AT.performResumeActivity()</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> ActivityClientRecord performResumeActivity(IBinder token,<br>            <span class="hljs-keyword">boolean</span> clearHide, <span class="hljs-keyword">String</span> reason) &#123;<br>        ActivityClientRecord r = mActivities.get(token);<br>        <br>        <span class="hljs-keyword">if</span> (r != <span class="hljs-literal">null</span> &amp;&amp; !r.activity.mFinished) &#123;<br>            <span class="hljs-keyword">if</span> (clearHide) &#123;<br>                r.hideForNow = <span class="hljs-literal">false</span>;<br>                r.activity.mStartedActivity = <span class="hljs-literal">false</span>;<br>            &#125;<br>            <span class="hljs-keyword">try</span> &#123;<br>                r.activity.onStateNotSaved();<br>                r.activity.mFragments.noteStateNotSaved();<br>                <span class="hljs-keyword">if</span> (r.pendingIntents != <span class="hljs-literal">null</span>) &#123;<br>                	<span class="hljs-comment">//回调onNewIntent</span><br>                    deliverNewIntents(r, r.pendingIntents);<br>                    r.pendingIntents = <span class="hljs-literal">null</span>;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (r.pendingResults != <span class="hljs-literal">null</span>) &#123;<br>                	<span class="hljs-comment">//回调onActivityResult</span><br>                    deliverResults(r, r.pendingResults);<br>                    r.pendingResults = <span class="hljs-literal">null</span>;<br>                &#125;<br>                <span class="hljs-comment">//在这里相继回调onStart onResume</span><br>                r.activity.performResume();<br>				......<br><br>                r.paused = <span class="hljs-literal">false</span>;<br>                r.stopped = <span class="hljs-literal">false</span>;<br>                r.state = <span class="hljs-literal">null</span>;<br>                r.persistentState = <span class="hljs-literal">null</span>;<br>            &#125; <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Exception</span> e) &#123;<br>                <span class="hljs-keyword">if</span> (!mInstrumentation.onException(r.activity, e)) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<br>                        <span class="hljs-string">&quot;Unable to resume activity &quot;</span><br>                        + r.intent.getComponent().toShortString()<br>                        + <span class="hljs-string">&quot;: &quot;</span> + e.toString(), e);<br>                &#125;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> r;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>到这里一个Activity就从无到有被启动且可见了</p>
<h3 id="4-5-流程图"><a href="#4-5-流程图" class="headerlink" title="4.5 流程图"></a>4.5 流程图</h3> <img src="/2021/08/23/android%E5%BC%80%E6%9C%BA%E5%90%8E%E9%83%BD%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88/images/%E6%B5%81%E7%A8%8B%E5%9B%BE.png" srcset="/img/loading.gif" lazyload class="">




















<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_30993595/article/details/82747738">从源码解析Android中Zygote进程是如何fork一个APP进程的</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/yiranfeng/article/details/103549394/">Android 10.0系统启动之init进程-[Android取经之路]</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_30993595/article/details/82714409#t12">从源码解析-Android系统启动流程概述 init进程zygote进程SystemServer进程启动流程</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/yanzhenjie1003/article/details/95539904/">Android zygote 进程的启动过程分析</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/8a19c9ea2304">APP启动流程解析</a></p>
<p><a target="_blank" rel="noopener" href="https://xyang.blog.csdn.net/article/details/82771691">ActivityThrad的工作逻辑</a></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/android/">android</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/android/">android</a>
                    
                  </div>
                
              </div>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/08/22/%E8%BD%A6%E8%81%94%E7%BD%91%E6%95%B4%E8%BD%A6%E6%9E%B6%E6%9E%84/">
                        <span class="hidden-mobile">车联网整车架构</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>




















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
