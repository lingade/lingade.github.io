

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="John Doe">
  <meta name="keywords" content="">
  
  <title>frida教程 - Cola&#39;S Blog</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/styles/github-gist.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  



<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.8.11","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Cola'S Blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="frida教程">
              
                frida教程
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2021-08-25 19:24" pubdate>
        2021年8月25日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      13.5k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      200
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">frida教程</h1>
            
            <div class="markdown-body">
              <h2 id="frida环境搭建"><a href="#frida环境搭建" class="headerlink" title="frida环境搭建"></a>frida环境搭建</h2><ol>
<li><p>根据机器cpu架构选择下载frida: <a target="_blank" rel="noopener" href="https://github.com/frida/frida/releases">frida sever</a></p>
</li>
<li><p>解压获得frida-server-x.x.x-x，将该文件上传至Android /data/local/tmp下</p>
</li>
<li><p>赋予该文件执行权限，chmod 777 frida-server-x.x.x-x</p>
</li>
<li><p>运行该文件， ./frida-server-x.x.x-x</p>
</li>
<li><p>python安装frida，安装的版本一定与下载的文件版本对应</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Java">pip3 install frida-tools  <span class="hljs-comment">//最好挂个梯子,要不容易一直卡在setup</span><br></code></pre></td></tr></table></figure></li>
</ol>
<h2 id="frida工具介绍"><a href="#frida工具介绍" class="headerlink" title="frida工具介绍"></a>frida工具介绍</h2><p>安装完成后在python的Scripts目录下会有frida ，frida-trace，frida-ps，frida-discover ，frida-kill ，frida-ls-devices，6个EXE可执行文件。</p>
<h3 id="frida"><a href="#frida" class="headerlink" title="frida"></a>frida</h3><pre><code>1. frida -U     包名                     ---调试连接到电脑上设备中的应用
2. frida  进程名                        ---打开本地进程
3. frida -U -f 进程名 -l 脚本   --- 进程注入js脚本
</code></pre>
<h3 id="frida–ps"><a href="#frida–ps" class="headerlink" title="frida–ps"></a>frida–ps</h3><pre><code>用于列出进程的命令行工具
1. frida-ps -U    ---列出设备上的所有进程
2. frida-ps -Ua   ---列出设备上的所有应用名称
3. frida-ps -Uai  ---列举出来设备上的所有已安装应用程序和对应的名字
4. frida-ps -D PID ---连接指定设备
5. frida-ps -D &lt;DEVICE-ID&gt; -a ---检查进程是否被杀死
</code></pre>
<h3 id="frida-trace"><a href="#frida-trace" class="headerlink" title="frida-trace"></a>frida-trace</h3><pre><code> 动态跟踪函数调用的工具
 1. frida-trace -i &quot;recv&quot; 包名  跟踪recv方法
 2. frida-trace -m &quot;-[NSString isEqualToString]&quot; 包名   ---追踪oc isEqualToString方法
</code></pre>
<h3 id="frida-discover"><a href="#frida-discover" class="headerlink" title="frida-discover"></a>frida-discover</h3><pre><code> 1. frida-discover -n 包名/frida-discover -p pid ---发现程序内部函数
</code></pre>
<h3 id="frida-kill"><a href="#frida-kill" class="headerlink" title="frida-kill"></a>frida-kill</h3><pre><code> 终止进程的命令行工具
 1. frida-kill -D &lt;DEVICE-ID&gt; &lt;PID&gt; ---杀死进程
</code></pre>
<h3 id="frida-ls-devices"><a href="#frida-ls-devices" class="headerlink" title="frida-ls-devices"></a>frida-ls-devices</h3><ol>
<li>列出所有连接到电脑上的设备 注：<ol>
<li>frida-ps -Uai  查看所有安装的应用。</li>
<li>frida-ps -D cca1b9055 -a -i 可以指定查看某个设备的进程。</li>
<li>frida-trace 用于跟踪函数或者 Objective-C 方法的调用-i 跟踪某个函数，-x 排除某个函数。-m 跟踪某个 Objective-C 方法，-M 排除某个 Objective-C 方法。-a 跟踪某一个地址，需要指名模块的名称。</li>
</ol>
</li>
</ol>
<h2 id="frida编译"><a href="#frida编译" class="headerlink" title="frida编译"></a>frida编译</h2><p>用于学习frida原理及去特征</p>
<h3 id="编译环境"><a href="#编译环境" class="headerlink" title="编译环境"></a>编译环境</h3><ul>
<li>ubuntu</li>
<li>python3</li>
<li>node(v14.14.0)</li>
<li>NDK</li>
</ul>
<h3 id="编译过程"><a href="#编译过程" class="headerlink" title="编译过程"></a>编译过程</h3><ol>
<li><p>安装依赖</p>
<p>以下是编译需要的环境，如果有则不需要在安装，node推荐去官网下载（<a target="_blank" rel="noopener" href="https://nodejs.org)/">https://nodejs.org）</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs shell">sudo apt-get install build-essential curl git lib32stdc++-9-dev libc6-dev-i386 nodejs npm python3-dev python3-pip<br></code></pre></td></tr></table></figure></li>
<li><p>拉源码</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">git clone --recurse-submodules https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/frida/</span>frida.git<br></code></pre></td></tr></table></figure></li>
<li><p>设置环境变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">androidNdk=<span class="hljs-string">&quot;/Users/cola/Library/Android/sdk/ndk/android-ndk-r22b&quot;</span><br><span class="hljs-built_in">export</span> PATH=<span class="hljs-variable">$androidNdk</span>:<span class="hljs-variable">$PATH</span><br><span class="hljs-built_in">export</span> ANDROID_NDK_ROOT=<span class="hljs-variable">$androidNdk</span><br><span class="hljs-built_in">export</span> NDK_HOME=<span class="hljs-variable">$androidNdk</span><br></code></pre></td></tr></table></figure></li>
<li><p>编译（第一次编译会下载编译工具,用梯子快一些不会出现奇怪的问题）</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs apache"><span class="hljs-attribute">make</span> core-android-arm<span class="hljs-number">64</span><br></code></pre></td></tr></table></figure></li>
<li><p>编译完成</p>
<p>编译后的文件在build目录下</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs tex">build/frida-android-arm64/bin/frida-server<br>build/frida-android-arm64/lib/frida-gadget.so<br>.......<br></code></pre></td></tr></table></figure></li>
</ol>
<h2 id="API"><a href="#API" class="headerlink" title="API"></a>API</h2><h3 id="hexdump"><a href="#hexdump" class="headerlink" title="hexdump"></a>hexdump</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> libc = Module.findBaseAddress(<span class="hljs-string">&#x27;libc.so&#x27;</span>);<br><span class="hljs-built_in">console</span>.log(hexdump(libc, &#123;<br>  <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-attr">length</span>: <span class="hljs-number">64</span>,<br>  <span class="hljs-attr">header</span>: <span class="hljs-literal">true</span>,<br>  <span class="hljs-attr">ansi</span>: <span class="hljs-literal">true</span><br>&#125;));<br>           <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span>  A  B  C  D  E  F  0123456789ABCDEF<br><span class="hljs-number">00000000</span>  7f <span class="hljs-number">45</span> 4c <span class="hljs-number">46</span> <span class="hljs-number">01</span> <span class="hljs-number">01</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  .ELF............<br><span class="hljs-number">00000010</span>  <span class="hljs-number">03</span> <span class="hljs-number">00</span> <span class="hljs-number">28</span> <span class="hljs-number">00</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">34</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  ..(........<span class="hljs-number">.4</span>...<br><span class="hljs-number">00000020</span>  <span class="hljs-number">34</span> a8 <span class="hljs-number">04</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">05</span> <span class="hljs-number">34</span> <span class="hljs-number">00</span> <span class="hljs-number">20</span> <span class="hljs-number">00</span> <span class="hljs-number">08</span> <span class="hljs-number">00</span> <span class="hljs-number">28</span> <span class="hljs-number">00</span>  <span class="hljs-number">4.</span>.....<span class="hljs-number">.4</span>. ...(.<br><span class="hljs-number">00000030</span>  1e <span class="hljs-number">00</span> 1d <span class="hljs-number">00</span> <span class="hljs-number">06</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">34</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">34</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  .......<span class="hljs-number">.4</span>..<span class="hljs-number">.4</span>...<br><br></code></pre></td></tr></table></figure>

<h3 id="send"><a href="#send" class="headerlink" title="send"></a>send</h3><p>send是在python层定义的on_message回调函数，jscode内所有的信息都被监控script.on(‘message’, on_message)，当输出信息的时候on_message函数会拿到其数据再通过format转换， 其最重要的功能也是最核心的是能够直接将数据以json格式输出，当然数据是二进制的时候也依然是可以使用send，十分方便.</p>
<h3 id="声明变量类型"><a href="#声明变量类型" class="headerlink" title="声明变量类型"></a>声明变量类型</h3><table>
<thead>
<tr>
<th>索引</th>
<th>API</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>new Int64(v)</td>
<td>定义一个有符号Int64类型的变量值为v，参数v可以是字符串或者以0x开头的的十六进制值</td>
</tr>
<tr>
<td>2</td>
<td>new UInt64(v)</td>
<td>定义一个无符号Int64类型的变量值为v，参数v可以是字符串或者以0x开头的的十六进制值</td>
</tr>
<tr>
<td>3</td>
<td>new NativePointer(s)</td>
<td>定义一个指针，指针地址为s</td>
</tr>
<tr>
<td>4</td>
<td>ptr(“0”)</td>
<td>定义一个指针</td>
</tr>
</tbody></table>
<p> example:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js">Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;new Int64(1):&quot;</span>+<span class="hljs-keyword">new</span> Int64(<span class="hljs-number">1</span>));<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;new UInt64(1):&quot;</span>+<span class="hljs-keyword">new</span> UInt64(<span class="hljs-number">1</span>));<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;new NativePointer(0xEC644071):&quot;</span>+<span class="hljs-keyword">new</span> NativePointer(<span class="hljs-number">0xEC644071</span>));<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;new ptr(&#x27;0xEC644071&#x27;):&quot;</span>+<span class="hljs-keyword">new</span> ptr(<span class="hljs-number">0xEC644071</span>));<br>&#125;);<br>    输出效果如下：<br>    <span class="hljs-keyword">new</span> Int64(<span class="hljs-number">1</span>):<span class="hljs-number">1</span><br>    <span class="hljs-keyword">new</span> UInt64(<span class="hljs-number">1</span>):<span class="hljs-number">1</span><br>    <span class="hljs-keyword">new</span> NativePointer(<span class="hljs-number">0xEC644071</span>):<span class="hljs-number">0xec644071</span><br>    <span class="hljs-keyword">new</span> ptr(<span class="hljs-string">&#x27;0xEC644071&#x27;</span>):<span class="hljs-number">0xec644071</span><br><br></code></pre></td></tr></table></figure>


<table>
<thead>
<tr>
<th>索引</th>
<th>API</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>add(rhs)、sub(rhs)、and(rhs)、or(rhs)、xor(rhs)</td>
<td>加、减、逻辑运算</td>
</tr>
<tr>
<td>2</td>
<td>shr(N)、shl(n)</td>
<td>向右/向左移位n位生成新的Int64</td>
</tr>
<tr>
<td>3</td>
<td>Compare(Rhs)</td>
<td>返回整数比较结果</td>
</tr>
<tr>
<td>4</td>
<td>toNumber()</td>
<td>转换为数字</td>
</tr>
<tr>
<td>5</td>
<td>toString([radix=10])</td>
<td>转换为可选基数的字符串(默认为10)</td>
</tr>
</tbody></table>
<p> example:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"> Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;&quot;</span>);<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;new Int64(1):&quot;</span>+<span class="hljs-keyword">new</span> Int64(<span class="hljs-number">1</span>));<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;new UInt64(1):&quot;</span>+<span class="hljs-keyword">new</span> UInt64(<span class="hljs-number">1</span>));<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;new NativePointer(0xEC644071):&quot;</span>+<span class="hljs-keyword">new</span> NativePointer(<span class="hljs-number">0xEC644071</span>));<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;new ptr(&#x27;0xEC644071&#x27;):&quot;</span>+<span class="hljs-keyword">new</span> ptr(<span class="hljs-number">0xEC644071</span>));<br>&#125;);<br>    输出效果如下：<br>    <span class="hljs-keyword">new</span> Int64(<span class="hljs-number">1</span>):<span class="hljs-number">1</span><br>    <span class="hljs-keyword">new</span> UInt64(<span class="hljs-number">1</span>):<span class="hljs-number">1</span><br>    <span class="hljs-keyword">new</span> NativePointer(<span class="hljs-number">0xEC644071</span>):<span class="hljs-number">0xec644071</span><br>    <span class="hljs-keyword">new</span> ptr(<span class="hljs-string">&#x27;0xEC644071&#x27;</span>):<span class="hljs-number">0xec644071</span><br><br></code></pre></td></tr></table></figure>

<h3 id="Process对象"><a href="#Process对象" class="headerlink" title="Process对象"></a>Process对象</h3><h4 id="Process-id"><a href="#Process-id" class="headerlink" title="Process.id"></a>Process.id</h4><p>返回附加目标进程的PID</p>
<h4 id="Process-isDebuggerAttached"><a href="#Process-isDebuggerAttached" class="headerlink" title="Process.isDebuggerAttached()"></a>Process.isDebuggerAttached()</h4><p>检测当前是否对目标程序已经附加</p>
<h4 id="Process-enumerateModules"><a href="#Process-enumerateModules" class="headerlink" title="Process.enumerateModules()"></a>Process.enumerateModules()</h4><p>枚举当前加载的模块，返回模块对象的数组。</p>
<p>Process.enumerateModules()会枚举当前所有已加载的so模块，并且返回了数组Module对象.</p>
<p>example:</p>
<p>在js中能够直接使用Process对象的所有api，调用了Process.enumerateModules()方法之后会返回一个数组，数组中存储N个叫Module的对象,for循环遍历，使用下标的方式调用了Module对象的name属性，name是so模块的名称</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">function</span> frida_Process() &#123;<br>    Java.<span class="hljs-keyword">perform</span>(<span class="hljs-keyword">function</span> () &#123;<br>        var process_Obj_Module_Arr = Process.enumerateModules();<br>        <span class="hljs-keyword">for</span>(var i = <span class="hljs-number">0</span>; i &lt; process_Obj_Module_Arr.length; i++) &#123;<br>            console.log(&quot;&quot;,process_Obj_Module_Arr[i].name);<br>        &#125;<br>    &#125;);<br>&#125;<br>setImmediate(frida_Process,<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure>

<h4 id="Process-enumerateThreads"><a href="#Process-enumerateThreads" class="headerlink" title="Process.enumerateThreads()"></a>Process.enumerateThreads()</h4><p>枚举当前所有的线程，返回包含以下属性的对象数组：</p>
<table>
<thead>
<tr>
<th>索引</th>
<th>属性</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>id</td>
<td>线程id</td>
</tr>
<tr>
<td>2</td>
<td>state</td>
<td>当前运行状态有running, stopped, waiting, uninterruptible or halted</td>
</tr>
<tr>
<td>3</td>
<td>context</td>
<td>带有键pc和sp的对象，它们是分别为ia32/x64/arm指定EIP/RIP/PC和ESP/RSP/SP的NativePointer对象。也可以使用其他处理器特定的密钥，例如eax、rax、r0、x0等。</td>
</tr>
</tbody></table>
<p>examlpe:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Process</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>       <span class="hljs-keyword">var</span> enumerateThreads =  Process.enumerateThreads();<br>       <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; enumerateThreads.length; i++) &#123;<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;id:&quot;</span>,enumerateThreads[i].id);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;state:&quot;</span>,enumerateThreads[i].state);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;context:&quot;</span>,<span class="hljs-built_in">JSON</span>.stringify(enumerateThreads[i].context));<br>        &#125;<br>    &#125;);<br>&#125;<br>setImmediate(frida_Process,<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure>

<h4 id="Process-getCurrentThreadId"><a href="#Process-getCurrentThreadId" class="headerlink" title="Process.getCurrentThreadId()"></a>Process.getCurrentThreadId()</h4><p>获取此线程的操作系统特定 ID 作为数字</p>
<h3 id="Module对象"><a href="#Module对象" class="headerlink" title="Module对象"></a>Module对象</h3><h4 id="Module对象的属性"><a href="#Module对象的属性" class="headerlink" title="Module对象的属性"></a>Module对象的属性</h4><table>
<thead>
<tr>
<th>索引</th>
<th>属性</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>name</td>
<td>模块名称</td>
</tr>
<tr>
<td>2</td>
<td>base</td>
<td>模块地址，其变量类型为NativePointer</td>
</tr>
<tr>
<td>3</td>
<td>size</td>
<td>大小</td>
</tr>
<tr>
<td>4</td>
<td>path</td>
<td>完整文件系统路径</td>
</tr>
</tbody></table>
<h4 id="Module对象的API"><a href="#Module对象的API" class="headerlink" title="Module对象的API"></a>Module对象的API</h4><table>
<thead>
<tr>
<th>索引</th>
<th>API</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Module.load()</td>
<td>加载指定so文件，返回一个Module对象</td>
</tr>
<tr>
<td>2</td>
<td>enumerateImports()</td>
<td>枚举所有Import库函数，返回Module数组对象</td>
</tr>
<tr>
<td>3</td>
<td>enumerateExports()</td>
<td>枚举所有Export库函数，返回Module数组对象</td>
</tr>
<tr>
<td>4</td>
<td>enumerateSymbols()</td>
<td>枚举所有Symbol库函数，返回Module数组对象</td>
</tr>
<tr>
<td>5</td>
<td>Module.findExportByName(exportName)、Module.getExportByName(exportName)</td>
<td>寻找指定so中export库中的函数地址</td>
</tr>
<tr>
<td>6</td>
<td>Module.findBaseAddress(name)、Module.getBaseAddress(name)</td>
<td>返回so的基地址</td>
</tr>
</tbody></table>
<h4 id="Module-load"><a href="#Module-load" class="headerlink" title="Module.load()"></a>Module.load()</h4><p>主要用于加载指定so文件，返回一个Module对象。</p>
<p>example:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Module</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>         <span class="hljs-comment">//参数为so的名称 返回一个Module对象</span><br>         <span class="hljs-keyword">const</span> hooks = Module.load(<span class="hljs-string">&#x27;libhello.so&#x27;</span>);<br>         <span class="hljs-comment">//输出</span><br>         <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;模块名称:&quot;</span>,hooks.name);<br>         <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;模块地址:&quot;</span>,hooks.base);<br>         <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;大小:&quot;</span>,hooks.size);<br>         <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;文件系统路径&quot;</span>,hooks.path);<br>    &#125;);<br>&#125;<br>setImmediate(frida_Module,<span class="hljs-number">0</span>);<br><br>输出如下：<br>模块名称: libhello.so<br>模块地址: <span class="hljs-number">0xdf2d3000</span><br>大小: <span class="hljs-number">24576</span><br>文件系统路径 /data/app/com.roysue.roysueapplication-7adQZoYIyp5t3G5Ef5wevQ==<span class="hljs-regexp">/lib/</span>arm/libhello.so<br></code></pre></td></tr></table></figure>

<h4 id="Process-EnumererateModules"><a href="#Process-EnumererateModules" class="headerlink" title="Process.EnumererateModules()"></a>Process.EnumererateModules()</h4><p>对上面的的Process.EnumererateModules()对象输出进行补全，代码如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Module</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br><br>        <span class="hljs-keyword">var</span> process_Obj_Module_Arr = Process.enumerateModules();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; process_Obj_Module_Arr.length; i++) &#123;<br>            <span class="hljs-keyword">if</span>(process_Obj_Module_Arr[i].path.indexOf(<span class="hljs-string">&quot;hello&quot;</span>)!=-<span class="hljs-number">1</span>)<br>            &#123;<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;模块名称:&quot;</span>,process_Obj_Module_Arr[i].name);<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;模块地址:&quot;</span>,process_Obj_Module_Arr[i].base);<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;大小:&quot;</span>,process_Obj_Module_Arr[i].size);<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;文件系统路径&quot;</span>,process_Obj_Module_Arr[i].path);<br>            &#125;<br>         &#125;<br>    &#125;);<br>&#125;<br>setImmediate(frida_Module,<span class="hljs-number">0</span>);<br><br>输出如下：<br>模块名称: libhello.so<br>模块地址: <span class="hljs-number">0xdf2d3000</span><br>大小: <span class="hljs-number">24576</span><br>文件系统路径 /data/app/com.roysue.roysueapplication-7adQZoYIyp5t3G5Ef5wevQ==<span class="hljs-regexp">/lib/</span>arm/libhello.so<br></code></pre></td></tr></table></figure>

<h4 id="enumerateImports"><a href="#enumerateImports" class="headerlink" title="enumerateImports()"></a>enumerateImports()</h4><p>该API会枚举模块中所有中的所有Import函数，示例代码如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Module</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">const</span> hooks = Module.load(<span class="hljs-string">&#x27;libhello.so&#x27;</span>);<br>        <span class="hljs-keyword">var</span> Imports = hooks.enumerateImports();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; Imports.length; i++) &#123;<br>            <span class="hljs-comment">//函数类型</span><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;type:&quot;</span>,Imports[i].type);<br>            <span class="hljs-comment">//函数名称</span><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;name:&quot;</span>,Imports[i].name);<br>            <span class="hljs-comment">//属于的模块</span><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;module:&quot;</span>,Imports[i].module);<br>            <span class="hljs-comment">//函数地址</span><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;address:&quot;</span>,Imports[i].address);<br>         &#125;<br>    &#125;);<br>&#125;<br>setImmediate(frida_Module,<span class="hljs-number">0</span>);<br><br>输出如下：<br>[Google Pixel::com.roysue.roysueapplication]-&gt; type: <span class="hljs-function"><span class="hljs-keyword">function</span></span><br><span class="hljs-function"><span class="hljs-title">name</span>: <span class="hljs-title">__cxa_atexit</span></span><br><span class="hljs-function"><span class="hljs-title">module</span>: /<span class="hljs-title">system</span>/<span class="hljs-title">lib</span>/<span class="hljs-title">libc</span>.<span class="hljs-title">so</span></span><br><span class="hljs-function"><span class="hljs-title">address</span>: 0<span class="hljs-title">xf58f4521</span></span><br><span class="hljs-function"><span class="hljs-title">type</span>: <span class="hljs-function"><span class="hljs-keyword">function</span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">name</span>: <span class="hljs-title">__cxa_finalize</span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">module</span>: /<span class="hljs-title">system</span>/<span class="hljs-title">lib</span>/<span class="hljs-title">libc</span>.<span class="hljs-title">so</span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">address</span>: 0<span class="hljs-title">xf58f462d</span>                                                                                                                                           </span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">type</span>: <span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">name</span>: <span class="hljs-title">__stack_chk_fail</span></span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">module</span>: /<span class="hljs-title">system</span>/<span class="hljs-title">lib</span>/<span class="hljs-title">libc</span>.<span class="hljs-title">so</span></span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">address</span>: 0<span class="hljs-title">xf58e2681</span></span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-function">...</span></span></span><br></code></pre></td></tr></table></figure>

<h4 id="enumerateExports"><a href="#enumerateExports" class="headerlink" title="enumerateExports()"></a>enumerateExports()</h4><p>该API会枚举模块中所有中的所有Export函数，示例代码如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Module</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">const</span> hooks = Module.load(<span class="hljs-string">&#x27;libhello.so&#x27;</span>);<br>        <span class="hljs-keyword">var</span> Exports = hooks.enumerateExports();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; Exports.length; i++) &#123;<br>            <span class="hljs-comment">//函数类型</span><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;type:&quot;</span>,Exports[i].type);<br>            <span class="hljs-comment">//函数名称</span><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;name:&quot;</span>,Exports[i].name);<br>            <span class="hljs-comment">//函数地址</span><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;address:&quot;</span>,Exports[i].address);<br>         &#125;<br>    &#125;);<br>&#125;<br>setImmediate(frida_Module,<span class="hljs-number">0</span>);<br><br>输出如下：<br>[Google Pixel::com.roysue.roysueapplication]-&gt; type: <span class="hljs-function"><span class="hljs-keyword">function</span></span><br><span class="hljs-function"><span class="hljs-title">name</span>: <span class="hljs-title">Java_com_roysue_roysueapplication_hellojni_getSum</span></span><br><span class="hljs-function"><span class="hljs-title">address</span>: 0<span class="hljs-title">xdf2d411b</span></span><br><span class="hljs-function"><span class="hljs-title">type</span>: <span class="hljs-function"><span class="hljs-keyword">function</span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">name</span>: <span class="hljs-title">unw_save_vfp_as_X</span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">address</span>: 0<span class="hljs-title">xdf2d4c43</span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">type</span>: <span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">address</span>: 0<span class="hljs-title">xdf2d4209</span></span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-function"><span class="hljs-title">type</span>: <span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span></span><br><span class="hljs-function"><span class="hljs-function"><span class="hljs-function"><span class="hljs-function">...</span></span></span></span><br></code></pre></td></tr></table></figure>

<h4 id="enumerateSymbols"><a href="#enumerateSymbols" class="headerlink" title="enumerateSymbols()"></a>enumerateSymbols()</h4><p>该API会枚举模块中所有中的符号表，示例代码如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Module</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">const</span> hooks = Module.load(<span class="hljs-string">&#x27;libc.so&#x27;</span>);<br>        <span class="hljs-keyword">var</span> <span class="hljs-built_in">Symbol</span> = hooks.enumerateSymbols();<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-built_in">Symbol</span>.length; i++) &#123;<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;isGlobal:&quot;</span>,<span class="hljs-built_in">Symbol</span>[i].isGlobal);<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;type:&quot;</span>,<span class="hljs-built_in">Symbol</span>[i].type);<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;section:&quot;</span>,<span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-built_in">Symbol</span>[i].section));<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;name:&quot;</span>,<span class="hljs-built_in">Symbol</span>[i].name);<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;address:&quot;</span>,<span class="hljs-built_in">Symbol</span>[i].address);<br>         &#125;<br>    &#125;);<br>&#125;<br>setImmediate(frida_Module,<span class="hljs-number">0</span>);<br><br>输出如下：<br><span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span><br><span class="hljs-attr">type</span>: <span class="hljs-function"><span class="hljs-keyword">function</span></span><br><span class="hljs-function"><span class="hljs-title">section</span>: </span>&#123;<span class="hljs-string">&quot;id&quot;</span>:<span class="hljs-string">&quot;13.text&quot;</span>,<span class="hljs-string">&quot;protection&quot;</span>:<span class="hljs-string">&quot;r-x&quot;</span>&#125;<br><span class="hljs-attr">name</span>: _Unwind_GetRegionStart<br><span class="hljs-attr">address</span>: <span class="hljs-number">0xf591c798</span><br><span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span><br><span class="hljs-attr">type</span>: <span class="hljs-function"><span class="hljs-keyword">function</span></span><br><span class="hljs-function"><span class="hljs-title">section</span>: </span>&#123;<span class="hljs-string">&quot;id&quot;</span>:<span class="hljs-string">&quot;13.text&quot;</span>,<span class="hljs-string">&quot;protection&quot;</span>:<span class="hljs-string">&quot;r-x&quot;</span>&#125;<br><span class="hljs-attr">name</span>: _Unwind_GetTextRelBase<br><span class="hljs-attr">address</span>: <span class="hljs-number">0xf591c7cc</span><br>...<br></code></pre></td></tr></table></figure>

<h4 id="Module-findExportByName-exportName-Module-getExportByName-exportName"><a href="#Module-findExportByName-exportName-Module-getExportByName-exportName" class="headerlink" title="Module.findExportByName(exportName),Module.getExportByName(exportName)"></a>Module.findExportByName(exportName),Module.getExportByName(exportName)</h4><p>返回so文件中Export函数库中函数名称为exportName函数的绝对地址。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Module</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        Module.getExportByName(<span class="hljs-string">&#x27;libhello.so&#x27;</span>, <span class="hljs-string">&#x27;c_getStr&#x27;</span>)<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;Java_com_roysue_roysueapplication_hellojni_getStr address:&quot;</span>,Module.findExportByName(<span class="hljs-string">&#x27;libhello.so&#x27;</span>, <span class="hljs-string">&#x27;Java_com_roysue_roysueapplication_hellojni_getStr&#x27;</span>));<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;Java_com_roysue_roysueapplication_hellojni_getStr address:&quot;</span>,Module.getExportByName(<span class="hljs-string">&#x27;libhello.so&#x27;</span>, <span class="hljs-string">&#x27;Java_com_roysue_roysueapplication_hellojni_getStr&#x27;</span>));<br>    &#125;);<br>&#125;<br>setImmediate(frida_Module,<span class="hljs-number">0</span>);<br><br>输出如下：<br>Java_com_roysue_roysueapplication_hellojni_getStr address: <span class="hljs-number">0xdf2d413d</span><br>Java_com_roysue_roysueapplication_hellojni_getStr address: <span class="hljs-number">0xdf2d413d</span><br><br></code></pre></td></tr></table></figure>

<h4 id="Module-findBaseAddress-name-、Module-getBaseAddress-name"><a href="#Module-findBaseAddress-name-、Module-getBaseAddress-name" class="headerlink" title="Module.findBaseAddress(name)、Module.getBaseAddress(name)"></a>Module.findBaseAddress(name)、Module.getBaseAddress(name)</h4><p>返回name模块的基地址。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Module</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> name = <span class="hljs-string">&quot;libhello.so&quot;</span>;<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;so address:&quot;</span>,Module.findBaseAddress(name));<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;so address:&quot;</span>,Module.getBaseAddress(name));<br>    &#125;);<br>&#125;<br>setImmediate(frida_Module,<span class="hljs-number">0</span>);<br><br>输出如下：<br>so address: <span class="hljs-number">0xdf2d3000</span><br>so address: <span class="hljs-number">0xdf2d3000</span><br><br></code></pre></td></tr></table></figure>

<h3 id="Memory对象"><a href="#Memory对象" class="headerlink" title="Memory对象"></a>Memory对象</h3><p>Memory的一些API通常是对内存处理</p>
<h4 id="Memory-scan搜索内存数据"><a href="#Memory-scan搜索内存数据" class="headerlink" title="Memory.scan搜索内存数据"></a>Memory.scan搜索内存数据</h4><p>其主要功能是搜索内存中以address地址开始，搜索长度为size，需要搜是条件是pattern，callbacks搜索之后的回调函数；此函数相当于搜索内存的功能。</p>
<p>我们来直接看例子，然后结合例子讲解，如下图。</p>
 <img src="/2021/08/25/frida%E6%95%99%E7%A8%8B/images/scan%E6%90%9C%E7%B4%A2%E5%86%85%E5%AD%98%E6%95%B0%E6%8D%AE.png" srcset="/img/loading.gif" lazyload class="">

<p>如果我想搜索在内存中112A地址的起始数据要怎么做，代码示例如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Memory</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">//先获取so的module对象</span><br>        <span class="hljs-keyword">var</span> <span class="hljs-built_in">module</span> = Process.findModuleByName(<span class="hljs-string">&quot;libhello.so&quot;</span>); <br>        <span class="hljs-comment">//??是通配符</span><br>        <span class="hljs-keyword">var</span> pattern = <span class="hljs-string">&quot;03 49 ?? 50 20 44&quot;</span>;<br>        <span class="hljs-comment">//基址</span><br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;base:&quot;</span>+<span class="hljs-built_in">module</span>.base)<br>        <span class="hljs-comment">//从so的基址开始搜索，搜索大小为so文件的大小，搜指定条件03 49 ?? 50 20 44的数据</span><br>        <span class="hljs-keyword">var</span> res = Memory.scan(<span class="hljs-built_in">module</span>.base, <span class="hljs-built_in">module</span>.size, pattern, &#123;<br>            <span class="hljs-attr">onMatch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">address, size</span>)</span>&#123;<br>                <span class="hljs-comment">//搜索成功</span><br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;搜索到 &#x27;</span> +pattern +<span class="hljs-string">&quot; 地址是:&quot;</span>+ address.toString());  <br>            &#125;, <br>            <span class="hljs-attr">onError</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">reason</span>)</span>&#123;<br>                <span class="hljs-comment">//搜索失败</span><br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;搜索失败&#x27;</span>);<br>            &#125;,<br>            <span class="hljs-attr">onComplete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span><br><span class="hljs-function">            </span>&#123;<br>                <span class="hljs-comment">//搜索完毕</span><br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;搜索完毕&quot;</span>)<br>            &#125;<br>          &#125;);<br>    &#125;);<br>&#125;<br>setImmediate(frida_Memory,<span class="hljs-number">0</span>);<br><br></code></pre></td></tr></table></figure>

<p>onMatch：function(address，size)：使用包含作为NativePointer的实例地址的address和指定大小为数字的size调用，此函数可能会返回字符串STOP以提前取消内存扫描。</p>
<p>onError：Function(Reason)：当扫描时出现内存访问错误时使用原因调用。</p>
<p>onComplete：function()：当内存范围已完全扫描时调用。</p>
<p>执行流程:搜索libhello.so文件在内存中的数据，搜索以pattern条件的在内存中能匹配的数据。搜索到之后根据回调函数返回数据。</p>
<p>我们来看看执行结果如下：</p>
<figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs tap">搜索到<span class="hljs-number"> 03 </span>49 ??<span class="hljs-number"> 50 </span>20<span class="hljs-number"> 44 </span>地址是:0xdf2d412a<br>搜索完毕<br></code></pre></td></tr></table></figure>


<p>我们要如何验证搜索到底是不是图1-5中112A地址，其实很简单。so的基址是0xdf2d3000，而搜到的地址是0xdf2d412a，我们只要df2d412a-df2d3000=112A。就是说我们已经搜索到了！</p>
<h4 id="搜索内存数据Memory-scanSync"><a href="#搜索内存数据Memory-scanSync" class="headerlink" title="搜索内存数据Memory.scanSync"></a>搜索内存数据Memory.scanSync</h4><p>功能与Memory.scan一样，只不过它是返回多个匹配到条件的数据。<br>代码示例如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Memory</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> <span class="hljs-built_in">module</span> = Process.findModuleByName(<span class="hljs-string">&quot;libhello.so&quot;</span>); <br>        <span class="hljs-keyword">var</span> pattern = <span class="hljs-string">&quot;03 49 ?? 50 20 44&quot;</span>;<br>        <span class="hljs-keyword">var</span> scanSync = Memory.scanSync(<span class="hljs-built_in">module</span>.base, <span class="hljs-built_in">module</span>.size, pattern);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;scanSync:&quot;</span>+<span class="hljs-built_in">JSON</span>.stringify(scanSync));<br>    &#125;);<br>&#125;<br>setImmediate(frida_Memory,<span class="hljs-number">0</span>);<br><br>输出如下，可以看到地址搜索出来是一样的<br><span class="hljs-attr">scanSync</span>:[&#123;<span class="hljs-string">&quot;address&quot;</span>:<span class="hljs-string">&quot;0xdf2d412a&quot;</span>,<span class="hljs-string">&quot;size&quot;</span>:<span class="hljs-number">6</span>&#125;]<br></code></pre></td></tr></table></figure>

<h4 id="内存分配Memory-alloc"><a href="#内存分配Memory-alloc" class="headerlink" title="内存分配Memory.alloc"></a>内存分配Memory.alloc</h4><p>在目标进程中的堆上申请size大小的内存，并且会按照Process.pageSize对齐，返回一个NativePointer，并且申请的内存如果在JavaScript里面没有对这个内存的使用的时候会自动释放的。也就是说，如果你不想要这个内存被释放，你需要自己保存一份对这个内存块的引用。</p>
<p>使用案例如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Memory</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">const</span> r = Memory.alloc(<span class="hljs-number">10</span>);<br>        <span class="hljs-built_in">console</span>.log(hexdump(r, &#123;<br>            <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">length</span>: <span class="hljs-number">10</span>,<br>            <span class="hljs-attr">header</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-attr">ansi</span>: <span class="hljs-literal">false</span><br>        &#125;));<br>    &#125;);<br>&#125;<br>setImmediate(frida_Memory,<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure>

<p>以上代码在目标进程中申请了10字节的空间~输出如下</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs apache">           <span class="hljs-attribute">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span>  A  B  C  D  E  F  <span class="hljs-number">0123456789</span>ABCDEF<br><span class="hljs-attribute">e8142070</span>  <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>                    .ELF......<br><br></code></pre></td></tr></table></figure>


<p>可以看到在0xdfe4cd40处申请了10个字节内存空间~</p>
<p>也可以使用：</p>
<p><code>Memory.allocUtf8String(str) 分配utf字符串</code></p>
<p><code>Memory.allocUtf16String 分配utf16字符串</code></p>
<p><code>Memory.allocAnsiString 分配ansi字符串</code></p>
<h4 id="Memory-copy内存复制"><a href="#Memory-copy内存复制" class="headerlink" title="Memory.copy内存复制"></a>Memory.copy内存复制</h4><p>如同c api memcp一样调用，使用案例如下。</p>
<p>从module.base中复制10个字节的内存到新年申请的r内</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Memory</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">//获取so模块的Module对象</span><br>        <span class="hljs-keyword">var</span> <span class="hljs-built_in">module</span> = Process.findModuleByName(<span class="hljs-string">&quot;libhello.so&quot;</span>); <br>        <span class="hljs-comment">//条件</span><br>        <span class="hljs-keyword">var</span> pattern = <span class="hljs-string">&quot;03 49 ?? 50 20 44&quot;</span>;<br>        <span class="hljs-comment">//搜字符串 只是为了将so的内存数据复制出来 方便演示~</span><br>        <span class="hljs-keyword">var</span> scanSync = Memory.scanSync(<span class="hljs-built_in">module</span>.base, <span class="hljs-built_in">module</span>.size, pattern);<br>        <span class="hljs-comment">//申请一个内存空间大小为10个字节</span><br>        <span class="hljs-keyword">const</span> r = Memory.alloc(<span class="hljs-number">10</span>);<br>        <span class="hljs-comment">//复制以module.base地址开始的10个字节 那肯定会是7F 45 4C 46...因为一个ELF文件的Magic属性如此。</span><br>        Memory.copy(r,<span class="hljs-built_in">module</span>.base,<span class="hljs-number">10</span>);<br>        <span class="hljs-built_in">console</span>.log(hexdump(r, &#123;<br>            <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">length</span>: <span class="hljs-number">10</span>,<br>            <span class="hljs-attr">header</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-attr">ansi</span>: <span class="hljs-literal">false</span><br>        &#125;));<br>    &#125;);<br>&#125;<br>setImmediate(frida_Memory,<span class="hljs-number">0</span>);<br><br>输出如下。<br>           <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span>  A  B  C  D  E  F  0123456789ABCDEF<br>e8142070  7f <span class="hljs-number">45</span> 4c <span class="hljs-number">46</span> <span class="hljs-number">01</span> <span class="hljs-number">01</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>                    .ELF......<br><br></code></pre></td></tr></table></figure>

<h4 id="写入内存Memory-writeByteArray"><a href="#写入内存Memory-writeByteArray" class="headerlink" title="写入内存Memory.writeByteArray"></a>写入内存Memory.writeByteArray</h4><p>将字节数组写入一个指定内存，代码示例如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Memory</span>(<span class="hljs-params"></span>) </span>&#123;     <br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">//定义需要写入的字节数组 这个字节数组是字符串&quot;roysue&quot;的十六进制</span><br>        <span class="hljs-keyword">var</span> arr = [ <span class="hljs-number">0x72</span>, <span class="hljs-number">0x6F</span>, <span class="hljs-number">0x79</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x75</span>, <span class="hljs-number">0x65</span>];<br>        <span class="hljs-comment">//申请一个新的内存空间 返回指针 大小是arr.length</span><br>        <span class="hljs-keyword">const</span> r = Memory.alloc(arr.length);<br>        <span class="hljs-comment">//将arr数组写入R地址中</span><br>        Memory.writeByteArray(r,arr);<br>        <span class="hljs-comment">//输出</span><br>        <span class="hljs-built_in">console</span>.log(hexdump(r, &#123;<br>            <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">length</span>: arr.length,<br>            <span class="hljs-attr">header</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-attr">ansi</span>: <span class="hljs-literal">false</span><br>        &#125;));  <br>    &#125;);<br>&#125;<br>setImmediate(frida_Memory,<span class="hljs-number">0</span>);<br><br>输出如下。<br>           <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span>  A  B  C  D  E  F  0123456789ABCDEF<br><span class="hljs-number">00000000</span>  <span class="hljs-number">72</span> 6f <span class="hljs-number">79</span> <span class="hljs-number">73</span> <span class="hljs-number">75</span> <span class="hljs-number">65</span>                                roysue<br><br></code></pre></td></tr></table></figure>

<h4 id="读取内存Memory-readByteArray"><a href="#读取内存Memory-readByteArray" class="headerlink" title="读取内存Memory.readByteArray"></a>读取内存Memory.readByteArray</h4><p>将一个指定地址的数据，代码示例如下:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Memory</span>(<span class="hljs-params"></span>) </span>&#123;     <br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">//定义需要写入的字节数组 这个字节数组是字符串&quot;roysue&quot;的十六进制</span><br>        <span class="hljs-keyword">var</span> arr = [ <span class="hljs-number">0x72</span>, <span class="hljs-number">0x6F</span>, <span class="hljs-number">0x79</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x75</span>, <span class="hljs-number">0x65</span>];<br>        <span class="hljs-comment">//申请一个新的内存空间 返回指针 大小是arr.length</span><br>        <span class="hljs-keyword">const</span> r = Memory.alloc(arr.length);<br>        <span class="hljs-comment">//将arr数组写入R地址中</span><br>        Memory.writeByteArray(r,arr);<br>        <span class="hljs-comment">//读取r指针，长度是arr.length 也就是会打印上面一样的值</span><br>        <span class="hljs-keyword">var</span> buffer = Memory.readByteArray(r, arr.length);<br>        <span class="hljs-comment">//输出</span><br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;Memory.readByteArray:&quot;</span>);<br>        <span class="hljs-built_in">console</span>.log(hexdump(buffer, &#123;<br>            <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">length</span>: arr.length,<br>            <span class="hljs-attr">header</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-attr">ansi</span>: <span class="hljs-literal">false</span><br>        &#125;));<br>      &#125;);  <br>    &#125;);<br>&#125;<br>setImmediate(frida_Memory,<span class="hljs-number">0</span>);<br><br>输出如下。<br>[Google Pixel::com.roysue.roysueapplication]-&gt; Memory.readByteArray:<br>           <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span>  A  B  C  D  E  F  0123456789ABCDEF<br><span class="hljs-number">00000000</span>  <span class="hljs-number">72</span> 6f <span class="hljs-number">79</span> <span class="hljs-number">73</span> <span class="hljs-number">75</span> <span class="hljs-number">65</span>                                roysue<br><br></code></pre></td></tr></table></figure>

<h3 id="Java对象"><a href="#Java对象" class="headerlink" title="Java对象"></a>Java对象</h3><h4 id="Java-available"><a href="#Java-available" class="headerlink" title="Java.available"></a>Java.available</h4><p>该函数一般用来判断当前进程是否加载了JavaVM，Dalvik或ART虚拟机</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Java</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">//作为判断用</span><br>        <span class="hljs-keyword">if</span>(Java.available)<br>        &#123;<br>            <span class="hljs-comment">//注入的逻辑代码</span><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;hello java vm&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-comment">//未能正常加载JAVA VM</span><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;error&quot;</span>);<br>        &#125;<br>    &#125;);<br>&#125;       <br>setImmediate(frida_Java,<span class="hljs-number">0</span>);<br><br>输出如下。<br>hello java vm<br></code></pre></td></tr></table></figure>

<h4 id="Java-androidVersion"><a href="#Java-androidVersion" class="headerlink" title="Java.androidVersion"></a>Java.androidVersion</h4><p>显示android系统版本号</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">function</span> frida_Java() &#123;<br>    Java.<span class="hljs-keyword">perform</span>(<span class="hljs-keyword">function</span> () &#123;<br>        //作为判断用<br>        <span class="hljs-keyword">if</span>(Java.available)<br>        &#123;<br>            //注入的逻辑代码<br>            console.log(&quot;&quot;,Java.androidVersion);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            //未能正常加载JAVA VM<br>            console.log(&quot;error&quot;);<br>        &#125;<br>    &#125;);<br>&#125;       <br>setImmediate(frida_Java,<span class="hljs-number">0</span>);<br><br>输出如下。<br><span class="hljs-number">9</span><br>因为我的系统版本是<span class="hljs-number">9</span>版本~<br></code></pre></td></tr></table></figure>


<h4 id="枚举类Java-enumerateLoadedClasses"><a href="#枚举类Java-enumerateLoadedClasses" class="headerlink" title="枚举类Java.enumerateLoadedClasses"></a>枚举类Java.enumerateLoadedClasses</h4><p>该API枚举当前加载的所有类信息，它有一个回调函数分别是onMatch、onComplete函数，我们来看看代码示例以及效果！</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs pgsql"><span class="hljs-keyword">function</span> frida_Java() &#123;<br>    Java.<span class="hljs-keyword">perform</span>(<span class="hljs-keyword">function</span> () &#123;<br>        <span class="hljs-keyword">if</span>(Java.available)<br>        &#123;<br>            //console.log(&quot;&quot;,Java.androidVersion);<br>            //枚举当前加载的所有类<br>            Java.enumerateLoadedClasses(&#123;<br>                //每一次回调此函数时其参数className就是类的信息<br>                onMatch: <span class="hljs-keyword">function</span> (className)<br>                &#123;<br>                    //输出类字符串<br>                    console.log(&quot;&quot;,className);<br>                &#125;,<br>                //枚举完毕所有类之后的回调函数<br>                onComplete: <span class="hljs-keyword">function</span> ()<br>                &#123;<br>                    //输出类字符串<br>                    console.log(&quot;输出完毕&quot;);<br>                &#125;<br>            &#125;);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            console.log(&quot;error&quot;);<br>        &#125;<br>    &#125;);<br>&#125;       <br>setImmediate(frida_Java,<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure>

<h4 id="枚举类加载器Java-enumerateLoadedClasses"><a href="#枚举类加载器Java-enumerateLoadedClasses" class="headerlink" title="枚举类加载器Java.enumerateLoadedClasses"></a>枚举类加载器Java.enumerateLoadedClasses</h4><p>该api枚举Java VM中存在的类加载器，其有一个回调函数，分别是onMatch: function (loader)与onComplete: function ()<br>它也有一个好兄弟叫Java.enumerateClassLoadersSync()也是返回的数组</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Java</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-keyword">if</span>(Java.available)<br>        &#123;<br>            <span class="hljs-comment">//枚举当前加载的Java VM类加载器</span><br>            Java.enumerateClassLoaders(&#123;<br>                <span class="hljs-comment">//回调函数，参数loader是类加载的信息</span><br>                <span class="hljs-attr">onMatch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">loader</span>)</span><br><span class="hljs-function">                </span>&#123;<br>                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;&quot;</span>,loader);<br>                &#125;,<br>                <span class="hljs-comment">//枚举完毕所有类加载器之后的回调函数</span><br>                <span class="hljs-attr">onComplete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>)</span><br><span class="hljs-function">                </span>&#123;<br>                    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;end&quot;</span>);<br>                &#125;<br>            &#125;);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;error&quot;</span>);<br>        &#125;<br>    &#125;);<br>&#125;       <br>setImmediate(frida_Java,<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure>

<h4 id="附加调用Java-perform"><a href="#附加调用Java-perform" class="headerlink" title="附加调用Java.perform"></a>附加调用Java.perform</h4><p>Java.perform（fn）主要用于当前线程附加到Java VM并且调用fn方法<br>它也有一个好兄弟。Java.performNow(fn)~</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Java</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">//运行当前js脚本时会对当前线程附加到Java VM虚拟机，并且执行function方法</span><br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">//判断是否Java VM正常运行</span><br>        <span class="hljs-keyword">if</span>(Java.available)<br>        &#123;<br>            <span class="hljs-comment">//如不意外会直接输出 hello</span><br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;hello&quot;</span>);<br>        &#125;<span class="hljs-keyword">else</span>&#123;<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;error&quot;</span>);<br>        &#125;<br>    &#125;);<br>&#125;       <br>setImmediate(frida_Java,<span class="hljs-number">0</span>);<br><br>输出如下。<br>[Google Pixel::com.roysue.roysueapplication]-&gt; hello<br></code></pre></td></tr></table></figure>

<h4 id="获取类Java-use"><a href="#获取类Java-use" class="headerlink" title="获取类Java.use"></a>获取类Java.use</h4><p>Java.use(className)，动态获取className的类定义，通过对其调用$new()来调用构造函数，可以从中实例化对象。当想要回收类时可以调用$Dispose()方法显式释放，当然也可以等待JavaScript的垃圾回收机制，当实例化一个对象之后，可以通过其实例对象调用类中的静态或非静态的方法，官方代码示例定义如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js">Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>  <span class="hljs-comment">//获取android.app.Activity类</span><br>  <span class="hljs-keyword">var</span> Activity = Java.use(<span class="hljs-string">&#x27;android.app.Activity&#x27;</span>);<br>  <span class="hljs-comment">//获取java.lang.Exception类</span><br>  <span class="hljs-keyword">var</span> Exception = Java.use(<span class="hljs-string">&#x27;java.lang.Exception&#x27;</span>);<br>  <span class="hljs-comment">//拦截Activity类的onResume方法</span><br>  Activity.onResume.implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">//调用onResume方法的时候，会在此处被拦截并且调用以下代码抛出异常！</span><br>    <span class="hljs-keyword">throw</span> Exception.$new(<span class="hljs-string">&#x27;Oh noes!&#x27;</span>);<br>  &#125;;<br>&#125;);<br></code></pre></td></tr></table></figure>

<h4 id="扫描实例类Java-choose"><a href="#扫描实例类Java-choose" class="headerlink" title="扫描实例类Java.choose"></a>扫描实例类Java.choose</h4><p>在堆上查找实例化的对象，示例代码如下！</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs js">Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">//查找android.view.View类在堆上的实例化对象</span><br>    Java.choose(<span class="hljs-string">&quot;android.view.View&quot;</span>, &#123;<br>        <span class="hljs-comment">//枚举时调用</span><br>        <span class="hljs-attr">onMatch</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">instance</span>)</span>&#123;<br>            <span class="hljs-comment">//打印实例</span><br>            <span class="hljs-built_in">console</span>.log(instance);<br>        &#125;,<br>        <span class="hljs-comment">//枚举完成后调用</span><br>        <span class="hljs-attr">onComplete</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;end&quot;</span>)<br>        &#125;&#125;);<br>&#125;);<br><br>输出如下：<br>android.view.View&#123;<span class="hljs-number">2292774</span> V.ED..... ......ID <span class="hljs-number">0</span>,<span class="hljs-number">1794</span>-<span class="hljs-number">1080</span>,<span class="hljs-number">1920</span> #<span class="hljs-number">1020030</span> android:id/navigationBarBackground&#125;<br>android.view.View&#123;d43549d V.ED..... ......ID <span class="hljs-number">0</span>,<span class="hljs-number">0</span>-<span class="hljs-number">1080</span>,<span class="hljs-number">63</span> #102002f android:id/statusBarBackground&#125;<br>end<br></code></pre></td></tr></table></figure>

<h4 id="类型转换器Java-cast"><a href="#类型转换器Java-cast" class="headerlink" title="类型转换器Java.cast"></a>类型转换器Java.cast</h4><p>Java.cast(handle, klass)，就是将指定变量或者数据强制转换成你所有需要的类型；创建一个 JavaScript 包装器，给定从 Java.use（） 返回的给定类klas的句柄的现有实例。此类包装器还具有用于获取其类的包装器的类属性，以及用于获取其类名的字符串表示的$className属性，通常在拦截so层时会使用此函数将jstring、jarray等等转换之后查看其值。</p>
<h4 id="定义任意数组类型Java-array"><a href="#定义任意数组类型Java-array" class="headerlink" title="定义任意数组类型Java.array"></a>定义任意数组类型Java.array</h4><p>frida提供了在js代码中定义java数组的api，该数组可以用于传递给java API，代码示例如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js">Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">//定义一个int数组、值是1003, 1005, 1007</span><br>        <span class="hljs-keyword">var</span> intarr = Java.array(<span class="hljs-string">&#x27;int&#x27;</span>, [ <span class="hljs-number">1003</span>, <span class="hljs-number">1005</span>, <span class="hljs-number">1007</span> ]);<br>        <span class="hljs-comment">//定义一个byte数组、值是0x48, 0x65, 0x69</span><br>        <span class="hljs-keyword">var</span> bytearr = Java.array(<span class="hljs-string">&#x27;byte&#x27;</span>, [ <span class="hljs-number">0x48</span>, <span class="hljs-number">0x65</span>, <span class="hljs-number">0x69</span> ]);<br>        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;bytearr.length;i++)<br>        &#123;<br>            <span class="hljs-comment">//输出每个byte元素</span><br>            <span class="hljs-built_in">console</span>.log(bytearr[i])<br>        &#125;<br>&#125;);<br></code></pre></td></tr></table></figure>

<p>我们通过上面定义int数组和byte的例子可以知道其定义格式为Java.array(‘type’,[value1,value2,….]);那它都支持type呢?</p>
<p>|</p>
<table>
<thead>
<tr>
<th>索引</th>
<th>type</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>Z</td>
<td>boolean</td>
</tr>
<tr>
<td>2</td>
<td>B</td>
<td>byte</td>
</tr>
<tr>
<td>3</td>
<td>C</td>
<td>char</td>
</tr>
<tr>
<td>4</td>
<td>S</td>
<td>short</td>
</tr>
<tr>
<td>5</td>
<td>I</td>
<td>int</td>
</tr>
<tr>
<td>6</td>
<td>J</td>
<td>long</td>
</tr>
<tr>
<td>7</td>
<td>F</td>
<td>float</td>
</tr>
<tr>
<td>8</td>
<td>D</td>
<td>double</td>
</tr>
<tr>
<td>9</td>
<td>V</td>
<td>void</td>
</tr>
</tbody></table>
<h4 id="注册类Java-registerClass-spec"><a href="#注册类Java-registerClass-spec" class="headerlink" title="注册类Java.registerClass(spec)"></a>注册类Java.registerClass(spec)</h4><p>Java.registerClass：创建一个新的Java类并返回一个包装器，其中规范是一个包含：</p>
<p>name：指定类名称的字符串。</p>
<p>superClass：（可选）父类。要从 java.lang.Object 继承的省略。</p>
<p>implements：（可选）由此类实现的接口数组。</p>
<p>fields：（可选）对象，指定要公开的每个字段的名称和类型。</p>
<p>methods：（可选）对象，指定要实现的方法。</p>
<p>注册一个类，返回类的实例，实例化目标类对象并且调用类中的方法代码如下</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js">Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>          <span class="hljs-comment">//注册一个目标进程中的类，返回的是一个类对象</span><br>          <span class="hljs-keyword">var</span> hellojni = Java.registerClass(&#123;<br>            <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;com.roysue.roysueapplication.hellojni&#x27;</span><br>          &#125;);<br>          <span class="hljs-built_in">console</span>.log(hellojni.addInt(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>));<br>&#125;);<br></code></pre></td></tr></table></figure>

<p>官方案例:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//获取目标进程的SomeBaseClass类</span><br><span class="hljs-keyword">var</span> SomeBaseClass = Java.use(<span class="hljs-string">&#x27;com.example.SomeBaseClass&#x27;</span>);<br><span class="hljs-comment">//获取目标进程的X509TrustManager类</span><br><span class="hljs-keyword">var</span> X509TrustManager = Java.use(<span class="hljs-string">&#x27;javax.net.ssl.X509TrustManager&#x27;</span>);<br><br><span class="hljs-keyword">var</span> MyWeirdTrustManager = Java.registerClass(&#123;<br>  <span class="hljs-comment">//注册一个类是进程中的MyWeirdTrustManager类</span><br>  <span class="hljs-attr">name</span>: <span class="hljs-string">&#x27;com.example.MyWeirdTrustManager&#x27;</span>,<br>  <span class="hljs-comment">//父类是SomeBaseClass类</span><br>  <span class="hljs-attr">superClass</span>: SomeBaseClass,<br>  <span class="hljs-comment">//实现了MyWeirdTrustManager接口类</span><br>  <span class="hljs-attr">implements</span>: [X509TrustManager],<br>  <span class="hljs-comment">//类中的属性</span><br>  <span class="hljs-attr">fields</span>: &#123;<br>    <span class="hljs-attr">description</span>: <span class="hljs-string">&#x27;java.lang.String&#x27;</span>,<br>    <span class="hljs-attr">limit</span>: <span class="hljs-string">&#x27;int&#x27;</span>,<br>  &#125;,<br>  <span class="hljs-comment">//定义的方法</span><br>  <span class="hljs-attr">methods</span>: &#123;<br>    <span class="hljs-comment">//类的构造函数</span><br>    <span class="hljs-attr">$init</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Constructor called&#x27;</span>);<br>    &#125;,<br>    <span class="hljs-comment">//X509TrustManager接口中方法之一，该方法作用是检查客户端的证书</span><br>    <span class="hljs-attr">checkClientTrusted</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chain, authType</span>) </span>&#123;<br>      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;checkClientTrusted&#x27;</span>);<br>    &#125;,<br>    <span class="hljs-comment">//该方法检查服务器的证书，不信任时。在这里通过自己实现该方法，可以使之信任我们指定的任何证书。在实现该方法时，也可以简单的不做任何处理，即一个空的函数体，由于不会抛出异常，它就会信任任何证书。</span><br>    <span class="hljs-attr">checkServerTrusted</span>: [&#123;<br>      <span class="hljs-comment">//返回值类型</span><br>      <span class="hljs-attr">returnType</span>: <span class="hljs-string">&#x27;void&#x27;</span>,<br>      <span class="hljs-comment">//参数列表</span><br>      <span class="hljs-attr">argumentTypes</span>: [<span class="hljs-string">&#x27;[Ljava.security.cert.X509Certificate;&#x27;</span>, <span class="hljs-string">&#x27;java.lang.String&#x27;</span>],<br>      <span class="hljs-comment">//实现方法</span><br>      <span class="hljs-attr">implementation</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chain, authType</span>) </span>&#123;<br>         <span class="hljs-comment">//输出</span><br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;checkServerTrusted A&#x27;</span>);<br>      &#125;<br>    &#125;, &#123;<br>      <span class="hljs-attr">returnType</span>: <span class="hljs-string">&#x27;java.util.List&#x27;</span>,<br>      <span class="hljs-attr">argumentTypes</span>: [<span class="hljs-string">&#x27;[Ljava.security.cert.X509Certificate;&#x27;</span>, <span class="hljs-string">&#x27;java.lang.String&#x27;</span>, <span class="hljs-string">&#x27;java.lang.String&#x27;</span>],<br>      <span class="hljs-attr">implementation</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">chain, authType, host</span>) </span>&#123;<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;checkServerTrusted B&#x27;</span>);<br>        <span class="hljs-comment">//返回null会信任所有证书</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>      &#125;<br>    &#125;],<br>    <span class="hljs-comment">//　返回受信任的X509证书数组。</span><br>    <span class="hljs-attr">getAcceptedIssuers</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;getAcceptedIssuers&#x27;</span>);<br>      <span class="hljs-keyword">return</span> [];<br>    &#125;,<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure>

<p>主要实现了证书类的javax.net.ssl.X509TrustManager类，，这里就是相当于自己在目标进程中重新创建了一个类，实现了自己想要实现的类构造，重构造了其中的三个接口函数、从而绕过证书校验</p>
<h4 id="Java-vm对象"><a href="#Java-vm对象" class="headerlink" title="Java.vm对象"></a>Java.vm对象</h4><p>Java.vm对象十分常用，比如想要拿到JNI层的JNIEnv对象，可以使用getEnv()；</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Java</span>(<span class="hljs-params"></span>) </span>&#123;     <br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>         <span class="hljs-comment">//拦截getStr函数</span><br>         Interceptor.attach(Module.findExportByName(<span class="hljs-string">&quot;libhello.so&quot;</span> , <span class="hljs-string">&quot;Java_com_roysue_roysueapplication_hellojni_getStr&quot;</span>), &#123;<br>            <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>) </span>&#123;<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;getStr&quot;</span>);<br>            &#125;,<br>            <span class="hljs-attr">onLeave</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>)</span>&#123;<br>                <span class="hljs-comment">//它的返回值的是retval 在jni层getStr的返回值的jstring </span><br>                <span class="hljs-comment">//我们在这里做的事情就是替换掉结果</span><br>                <span class="hljs-comment">//先获取一个Env对象</span><br>                <span class="hljs-keyword">var</span> env = Java.vm.getEnv();<br>                <span class="hljs-comment">//通过newStringUtf方法构建一个jstirng字符串</span><br>                <span class="hljs-keyword">var</span> jstring = env.newStringUtf(<span class="hljs-string">&#x27;roysue&#x27;</span>);<br>                <span class="hljs-comment">//replace替换掉结果</span><br>                retval.replace(jstring);<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;getSum方法返回值为:roysue&quot;</span>)<br>            &#125;<br>    &#125;);<br>&#125;<br>setImmediate(frida_Java,<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure>


<h3 id="Interceptor对象"><a href="#Interceptor对象" class="headerlink" title="Interceptor对象"></a>Interceptor对象</h3><p>该对象功能十分强大，函数原型是Interceptor.attach(target, callbacks):</p>
<p>参数target是需要拦截的位置的函数地址，也就是填某个so层函数的地址即可对其拦截</p>
<p>target是一个NativePointer参数，用来指定你想要拦截的函数的地址，NativePointer我们也学过是一个指针。</p>
<p>需要注意的是对于Thumb函数需要对函数地址+1，callbacks则是它的回调函数，分别是以下两个回调函数：</p>
<h4 id="Interceptor-attach"><a href="#Interceptor-attach" class="headerlink" title="Interceptor.attach"></a>Interceptor.attach</h4><p>onEnter：函数（args）：回调函数，给定一个参数args，可用于读取或写入参数作为 NativePointer 对象的数组。</p>
<p>onLeave：函数（retval）：回调函数给定一个参数 retval，该参数是包含原始返回值的 NativePointer 派生对象。可以调用 retval.replace（0） 以整数 0 替换返回值，或者调用 retval.replace（ptr（”0x1234”））以替换为指针。</p>
<p>请注意，此对象在 OnLeave调用中回收，因此不要将其存储在回调之外并使用它。如果需要存储包含的值，请制作深副本，例如：ptr（retval.toString（））。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//使用Module对象getExportByNameAPI直接获取libc.so中的导出函数read的地址，对read函数进行附加拦截</span><br>Interceptor.attach(Module.getExportByName(<span class="hljs-string">&#x27;libc.so&#x27;</span>, <span class="hljs-string">&#x27;read&#x27;</span>), &#123;<br>  <span class="hljs-comment">//每次read函数调用的时候会执行onEnter回调函数</span><br>  <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>&#123;<br>    <span class="hljs-built_in">this</span>.fileDescriptor = args[<span class="hljs-number">0</span>].toInt32();<br>  &#125;,<br>  <span class="hljs-comment">//read函数执行完成之后会执行onLeave回调函数</span><br>  <span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">retval</span>) </span>&#123;<br>    <span class="hljs-keyword">if</span> (retval.toInt32() &gt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-comment">/* do something with this.fileDescriptor */</span><br>    &#125;<br>  &#125;<br>&#125;);<br></code></pre></td></tr></table></figure>

<h4 id="通过我们对Interceptor-attach函数有一些基本了解了-它还包含一些属性。"><a href="#通过我们对Interceptor-attach函数有一些基本了解了-它还包含一些属性。" class="headerlink" title="通过我们对Interceptor.attach函数有一些基本了解了~它还包含一些属性。"></a>通过我们对Interceptor.attach函数有一些基本了解了~它还包含一些属性。</h4><table>
<thead>
<tr>
<th>索引</th>
<th>属性</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>returnAddress</td>
<td>返回地址，类型是NativePointer</td>
</tr>
<tr>
<td>2</td>
<td>context</td>
<td>上下文：具有键pc和sp的对象，它们是分别为ia32/x64/arm指定EIP/RIP/PC和ESP/RSP/SP的NativePointer对象。其他处理器特定的键也可用，例如eax、rax、r0、x0等。也可以通过分配给这些键来更新寄存器值。</td>
</tr>
<tr>
<td>3</td>
<td>errno</td>
<td>当前errno值</td>
</tr>
<tr>
<td>4</td>
<td>lastError</td>
<td>当前操作系统错误值</td>
</tr>
<tr>
<td>5</td>
<td>threadId</td>
<td>操作系统线程ID</td>
</tr>
<tr>
<td>6</td>
<td>depth</td>
<td>相对于其他调用的调用深度</td>
</tr>
<tr>
<td>我们来看看示例代码。</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Interceptor</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">//对So层的导出函数getSum进行拦截</span><br>        Interceptor.attach(Module.findExportByName(<span class="hljs-string">&quot;libhello.so&quot;</span> , <span class="hljs-string">&quot;Java_com_roysue_roysueapplication_hellojni_getSum&quot;</span>), &#123;<br>            <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>) </span>&#123;<br>                <span class="hljs-comment">//输出</span><br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Context information:&#x27;</span>);<br>                <span class="hljs-comment">//输出上下文因其是一个Objection对象，需要它进行接送、转换才能正常看到值</span><br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Context  : &#x27;</span> + <span class="hljs-built_in">JSON</span>.stringify(<span class="hljs-built_in">this</span>.context));<br>                <span class="hljs-comment">//输出返回地址</span><br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Return   : &#x27;</span> + <span class="hljs-built_in">this</span>.returnAddress);<br>                <span class="hljs-comment">//输出线程id</span><br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;ThreadId : &#x27;</span> + <span class="hljs-built_in">this</span>.threadId);<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Depth    : &#x27;</span> + <span class="hljs-built_in">this</span>.depth);<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;Errornr  : &#x27;</span> + <span class="hljs-built_in">this</span>.err);<br>            &#125;,<br>            <span class="hljs-attr">onLeave</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>)</span>&#123;<br>            &#125;<br>        &#125;);<br>    &#125;);<br>&#125;<br>setImmediate(frida_Interceptor,<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure>

<h4 id="Interceptor-detachAll"><a href="#Interceptor-detachAll" class="headerlink" title="Interceptor.detachAll"></a>Interceptor.detachAll</h4><p>作用就是让之前所有的Interceptor.attach附加拦截的回调函数失效。</p>
<h4 id="Interceptor-replace"><a href="#Interceptor-replace" class="headerlink" title="Interceptor.replace"></a>Interceptor.replace</h4><p>相当于替换掉原本的函数，用替换时的实现替换目标处的函数。如果想要完全或部分替换现有函数的实现，则通常使用此函数。，我们也看例子，例子是最直观的！代码如下。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_Interceptor</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>       <span class="hljs-comment">//这个c_getSum方法有两个int参数、返回结果为两个参数相加</span><br>       <span class="hljs-comment">//这里用NativeFunction函数自己定义了一个c_getSum函数</span><br>       <span class="hljs-keyword">var</span> add_method = <span class="hljs-keyword">new</span> NativeFunction(Module.findExportByName(<span class="hljs-string">&#x27;libhello.so&#x27;</span>, <span class="hljs-string">&#x27;c_getSum&#x27;</span>), <br>       <span class="hljs-string">&#x27;int&#x27;</span>,[<span class="hljs-string">&#x27;int&#x27;</span>,<span class="hljs-string">&#x27;int&#x27;</span>]);<br>       <span class="hljs-comment">//输出结果 那结果肯定就是 3</span><br>       <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;result:&quot;</span>,add_method(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>));<br>       <span class="hljs-comment">//这里对原函数的功能进行替换实现</span><br>       Interceptor.replace(add_method, <span class="hljs-keyword">new</span> NativeCallback(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">a, b</span>) </span>&#123;<br>           <span class="hljs-comment">//h不论是什么参数都返回123</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-number">123</span>;<br>       &#125;, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]));<br>       <span class="hljs-comment">//再次调用 则返回123</span><br>       <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;result:&quot;</span>,add_method(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>));<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="NativePointer对象"><a href="#NativePointer对象" class="headerlink" title="NativePointer对象"></a>NativePointer对象</h3><p>同等与C语言中的指针</p>
<h4 id="new-NativePointer-s"><a href="#new-NativePointer-s" class="headerlink" title="new NativePointer(s)"></a>new NativePointer(s)</h4><p>声明定义NativePointer类型</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_NativePointer</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        <span class="hljs-comment">//第一种字符串定义方式 十进制的100 输出为十六进制0x64</span><br>        <span class="hljs-keyword">const</span> ptr1 = <span class="hljs-keyword">new</span> NativePointer(<span class="hljs-string">&quot;100&quot;</span>);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;ptr1:&quot;</span>,ptr1);<br>        <span class="hljs-comment">//第二种字符串定义方式 直接定义0x64 同等与定义十六进制的64</span><br>        <span class="hljs-keyword">const</span> ptr2 = <span class="hljs-keyword">new</span> NativePointer(<span class="hljs-string">&quot;0x64&quot;</span>);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;ptr2:&quot;</span>,ptr2);        <br>        <span class="hljs-comment">//第三种定数值义方式 定义数字int类型 十进制的100 是0x64</span><br>        <span class="hljs-keyword">const</span> ptr3 = <span class="hljs-keyword">new</span> NativePointer(<span class="hljs-number">100</span>);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;ptr3:&quot;</span>,ptr3);<br>    &#125;);<br>&#125;     <br>setImmediate(frida_NativePointer,<span class="hljs-number">0</span>);<br><br>输出如下，都会自动转为十六进制的<span class="hljs-number">0x64</span><br><span class="hljs-attr">ptr1</span>: <span class="hljs-number">0x64</span><br><span class="hljs-attr">ptr2</span>: <span class="hljs-number">0x64</span><br><span class="hljs-attr">ptr3</span>: <span class="hljs-number">0x64</span><br></code></pre></td></tr></table></figure>

<h4 id="运算符以及指针读写API"><a href="#运算符以及指针读写API" class="headerlink" title="运算符以及指针读写API"></a>运算符以及指针读写API</h4><p>它也能调用以下运算符</p>
 <img src="/2021/08/25/frida%E6%95%99%E7%A8%8B/images/%E6%8C%87%E9%92%88%E8%AF%BB%E5%86%99API.png" srcset="/img/loading.gif" lazyload class="">

<p>看完API含义之后，我们来使用他们，下面该脚本是readByteArray()示例~</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">frida_NativePointer</span>(<span class="hljs-params"></span>) </span>&#123;<br>    Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>       <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;&quot;</span>);<br>        <span class="hljs-comment">//拿到libc.so在内存中的地址</span><br>        <span class="hljs-keyword">var</span> pointer = Process.findModuleByName(<span class="hljs-string">&quot;libc.so&quot;</span>).base;<br>        <span class="hljs-comment">//读取从pointer地址开始的16个字节</span><br>        <span class="hljs-built_in">console</span>.log(pointer.readByteArray(<span class="hljs-number">0x10</span>));<br>    &#125;);<br>&#125;     <br>setImmediate(frida_NativePointer,<span class="hljs-number">0</span>);<br>输出如下：<br>           <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span>  A  B  C  D  E  F  0123456789ABCDEF<br><span class="hljs-number">00000000</span>  7f <span class="hljs-number">45</span> 4c <span class="hljs-number">46</span> <span class="hljs-number">01</span> <span class="hljs-number">01</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  .ELF............<br></code></pre></td></tr></table></figure>

<p>首先我先来用readByteArray函数来读取libc.so文件在内存中的数据，这样我们方便测试，我们从libc文件读取0x10个字节的长度，肯定会是7F 45 4C 46…因为ELF文件头部信息中的Magic属性。</p>
<h4 id="readPointer"><a href="#readPointer" class="headerlink" title="readPointer()"></a>readPointer()</h4><p>从此内存位置读取NativePointer，示例代码如下。省略function以及Java.perform~</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> pointer = Process.findModuleByName(<span class="hljs-string">&quot;libc.so&quot;</span>).base;<br>    <span class="hljs-built_in">console</span>.log(pointer.readByteArray(<span class="hljs-number">0x10</span>));<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;readPointer():&quot;</span>+pointer.readPointer());<br>    输出如下。<br>    readPointer():<span class="hljs-number">0x464c457f</span><br></code></pre></td></tr></table></figure>

<p>也就是将readPointer的前四个字节的内容转成地址产生一个新的NativePointer。</p>
<h4 id="writePointer-ptr"><a href="#writePointer-ptr" class="headerlink" title="writePointer(ptr)"></a>writePointer(ptr)</h4><p>读取ptr指针地址到当前指针</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs js">     <span class="hljs-comment">//先打印pointer指针地址</span><br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;pointer :&quot;</span>+pointer);<br>        <span class="hljs-comment">//分配四个字节的空间地址</span><br>        <span class="hljs-keyword">const</span> r = Memory.alloc(<span class="hljs-number">4</span>);<br>        <span class="hljs-comment">//将pointer指针写入刚刚申请的r内</span><br>        r.writePointer(pointer);<br>        <span class="hljs-comment">//读取r指针的数据</span><br>        <span class="hljs-keyword">var</span> buffer = Memory.readByteArray(r, <span class="hljs-number">4</span>);<br>        <span class="hljs-comment">//r指针内放的pointer指针地址</span><br>        <span class="hljs-built_in">console</span>.log(buffer);<br>        <br>        输出如下。<br><span class="hljs-comment">//console.log(&quot;pointer :&quot;+pointer); 这句打印的地址 也就是libc的地址</span><br><span class="hljs-attr">pointer</span> :<span class="hljs-number">0xf588f000</span><br><span class="hljs-comment">//console.log(buffer); 输出buffer 0xf588f000在内存数据会以00 f0 88 f5方式显示</span><br>           <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span>  A  B  C  D  E  F  0123456789ABCDEF<br><span class="hljs-number">00000000</span>  <span class="hljs-number">00</span> f0 <span class="hljs-number">88</span> f5                                      ....<br></code></pre></td></tr></table></figure>

<h4 id="readS32-、readU32"><a href="#readS32-、readU32" class="headerlink" title="readS32()、readU32()"></a>readS32()、readU32()</h4><p>从该内存位置读取有符号或无符号8/16/32/etc或浮点数/双精度值，并将其作为数字返回。这里拿readS32()、readU32()作为演示.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js">   <span class="hljs-comment">//从pointer地址读4个字节 有符号</span><br>    <span class="hljs-built_in">console</span>.log(pointer.readS32());<br>    <span class="hljs-comment">//从pointer地址读4个字节 无符号</span><br>    <span class="hljs-built_in">console</span>.log(pointer.readU32());<br><br><br>输出如下。<br>           <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span>  A  B  C  D  E  F  0123456789ABCDEF<br><span class="hljs-number">00000000</span>  7f <span class="hljs-number">45</span> 4c <span class="hljs-number">46</span> <span class="hljs-number">01</span> <span class="hljs-number">01</span> <span class="hljs-number">01</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  .ELF............<br><span class="hljs-number">1179403647</span> == <span class="hljs-number">0x464c457f</span><br><span class="hljs-number">1179403647</span> == <span class="hljs-number">0x464c457f</span><br></code></pre></td></tr></table></figure>

<h4 id="writeS32-、writeU32"><a href="#writeS32-、writeU32" class="headerlink" title="writeS32()、writeU32()"></a>writeS32()、writeU32()</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js">    <span class="hljs-comment">//申请四个字节的内存空间</span><br>    <span class="hljs-keyword">const</span> r = Memory.alloc(<span class="hljs-number">4</span>);<br>    <span class="hljs-comment">//将0x12345678写入r地址中</span><br>    r.writeS32(<span class="hljs-number">0x12345678</span>);<br>    <span class="hljs-comment">//输出</span><br>    <span class="hljs-built_in">console</span>.log(r.readByteArray(<span class="hljs-number">0x10</span>));<br><span class="hljs-comment">// writeS32()、writeU32()输出的也是一样的，只是区别是有符号和无符号</span><br>输出如下。<br>           <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span>  A  B  C  D  E  F  0123456789ABCDEF<br><span class="hljs-number">00000000</span>  <span class="hljs-number">78</span> <span class="hljs-number">56</span> <span class="hljs-number">34</span> <span class="hljs-number">12</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span> <span class="hljs-number">00</span>  xV4.............<br></code></pre></td></tr></table></figure>

<h4 id="readByteArray-length-、writeByteArray-bytes"><a href="#readByteArray-length-、writeByteArray-bytes" class="headerlink" title="readByteArray(length))、writeByteArray(bytes)"></a>readByteArray(length))、writeByteArray(bytes)</h4><p>readByteArray(length))连续读取内存length个字节，、writeByteArray连续写入内存bytes。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs js">    <span class="hljs-comment">//先定义一个需要写入的字节数组</span><br>       <span class="hljs-keyword">var</span> arr = [ <span class="hljs-number">0x72</span>, <span class="hljs-number">0x6F</span>, <span class="hljs-number">0x79</span>, <span class="hljs-number">0x73</span>, <span class="hljs-number">0x75</span>, <span class="hljs-number">0x65</span>];<br>       <span class="hljs-comment">//这里申请以arr大小的内存空间</span><br>       <span class="hljs-keyword">const</span> r = Memory.alloc(arr.length);<br>       <span class="hljs-comment">//将arr数组字节写入r</span><br>       Memory.writeByteArray(r,arr);<br>       <span class="hljs-comment">//读取arr.length大小的数组</span><br>       <span class="hljs-keyword">var</span> buffer = Memory.readByteArray(r, arr.length);<br>       <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;Memory.readByteArray:&quot;</span>);<br>       <span class="hljs-built_in">console</span>.log(hexdump(buffer, &#123;<br>            <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span>,<br>            <span class="hljs-attr">length</span>: arr.length,<br>            <span class="hljs-attr">header</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-attr">ansi</span>: <span class="hljs-literal">false</span><br>        &#125;));<br><br>输出如下。       <br>Memory.readByteArray:<br>           <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span>  A  B  C  D  E  F  0123456789ABCDEF<br><span class="hljs-number">00000000</span>  <span class="hljs-number">72</span> 6f <span class="hljs-number">79</span> <span class="hljs-number">73</span> <span class="hljs-number">75</span> <span class="hljs-number">65</span>                                roysue<br></code></pre></td></tr></table></figure>


<h4 id="readCString-size-1-、writeUtf8String-str"><a href="#readCString-size-1-、writeUtf8String-str" class="headerlink" title="readCString([size = -1])、writeUtf8String(str)"></a>readCString([size = -1])、writeUtf8String(str)</h4><p>readCString功能是读取指针地址位置的字节字符串，对应的writeUtf8String是写入指针地址位置的字符串处。（这里的r是接着上面的代码的变量）。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//在这里直接使用readCString读取会把上面的&#x27;roysue&#x27;字符串读取出来</span><br>       <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;readCString():&quot;</span>+r.readCString());<br>       <span class="hljs-comment">//这里是写入字符串 也就是 roysue起始位置开始被替换为haha</span><br>       <span class="hljs-keyword">const</span> newPtrstr = r.writeUtf8String(<span class="hljs-string">&quot;haha&quot;</span>);<br>       <span class="hljs-comment">//替换完了之后再继续输出 必然是haha</span><br>       <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;readCString():&quot;</span>+newPtrstr.readCString());<br></code></pre></td></tr></table></figure>

<h3 id="NativeFunction对象"><a href="#NativeFunction对象" class="headerlink" title="NativeFunction对象"></a>NativeFunction对象</h3><p>创建新的NativeFunction以调用address处的函数(用NativePointer指定)，其中rereturn Type指定返回类型，argTypes数组指定参数类型。如果不是系统默认值，还可以选择指定ABI。对于可变函数，添加一个‘.’固定参数和可变参数之间的argTypes条目，我们来看看官方的例子。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// LargeObject HandyClass::friendlyFunctionName();</span><br><span class="hljs-comment">//创建friendlyFunctionPtr地址的函数</span><br><span class="hljs-keyword">var</span> friendlyFunctionName = <span class="hljs-keyword">new</span> NativeFunction(friendlyFunctionPtr,<br>    <span class="hljs-string">&#x27;void&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;pointer&#x27;</span>]);<br><span class="hljs-comment">//申请内存空间    </span><br><span class="hljs-keyword">var</span> returnValue = Memory.alloc(sizeOfLargeObject);<br><span class="hljs-comment">//调用friendlyFunctionName函数</span><br>friendlyFunctionName(returnValue, thisPtr);<br></code></pre></td></tr></table></figure>

<p>我来看看它的格式，函数定义格式为new NativeFunction(address, returnType, argTypes[, options])，参照这个格式能够创建函数并且调用！returnType和argTypes[，]分别可以填void、pointer、int、uint、long、ulong、char、uchar、float、double、int8、uint8、int16、uint16、int32、uint32、int64、uint64这些类型，根据函数的所需要的type来定义即可。</p>
<p>在定义的时候必须要将参数类型个数和参数类型以及返回值完全匹配，假设有三个参数都是int，则new NativeFunction(address, returnType, [‘int’, ‘int’, ‘int’])，而返回值是int则new NativeFunction(address, ‘int’, argTypes[, options])，必须要全部匹配，并且第一个参数一定要是函数地址指针。</p>
<h3 id="NativeCallback对象"><a href="#NativeCallback对象" class="headerlink" title="NativeCallback对象"></a>NativeCallback对象</h3><p>new NativeCallback(func，rereturn Type，argTypes[，ABI])：创建一个由JavaScript函数func实现的新NativeCallback，其中rereturn Type指定返回类型，argTypes数组指定参数类型。</p>
<p>您还可以指定ABI(如果不是系统默认值)。</p>
<p>有关支持的类型和Abis的详细信息，请参见NativeFunction。注意，返回的对象也是一个NativePointer，因此可以传递给Interceptor#replace。当将产生的回调与Interceptor.replace()一起使用时，将调用func，并将其绑定到具有一些有用属性的对象，就像Interceptor.Attach()中的那样。我们来看一个例子。如下，利用NativeCallback做一个函数替换。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs js">Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> add_method = <span class="hljs-keyword">new</span> NativeFunction(Module.findExportByName(<span class="hljs-string">&#x27;libhello.so&#x27;</span>, <span class="hljs-string">&#x27;c_getSum&#x27;</span>), <br>    <span class="hljs-string">&#x27;int&#x27;</span>,[<span class="hljs-string">&#x27;int&#x27;</span>,<span class="hljs-string">&#x27;int&#x27;</span>]);<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;result:&quot;</span>,add_method(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>));<br>    <span class="hljs-comment">//在这里new一个新的函数，但是参数的个数和返回值必须对应</span><br>    Interceptor.replace(add_method, <span class="hljs-keyword">new</span> NativeCallback(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">a, b</span>) </span>&#123;<br>         <span class="hljs-keyword">return</span> <span class="hljs-number">123</span>;<br>    &#125;, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;int&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]));<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;result:&quot;</span>,add_method(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>));<br> &#125;);<br></code></pre></td></tr></table></figure>





<h2 id="HOOK"><a href="#HOOK" class="headerlink" title="HOOK"></a>HOOK</h2><h3 id="HOOK-java层方法模版"><a href="#HOOK-java层方法模版" class="headerlink" title="HOOK java层方法模版"></a>HOOK java层方法模版</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> frida, sys<br><br><span class="hljs-comment">#接收js脚本send方法传入的数据</span><br><span class="hljs-comment">#@message数据类型为字典</span><br><span class="hljs-comment">#&#123;&#x27;type&#x27;:&#x27;send&#x27;,&#x27;payload&#x27;:&#x27;js脚本发送的数据&#x27;&#125;</span><br><span class="hljs-comment">#@data数据类型为byte</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_message</span>(<span class="hljs-params">message, data</span>):</span><br>    <span class="hljs-keyword">if</span> message[<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;send&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] &#123;0&#125;&quot;</span>.<span class="hljs-built_in">format</span>(message[<span class="hljs-string">&#x27;payload&#x27;</span>]))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(message)<br><br>jscode = <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">Java.perform(function () &#123;</span><br><span class="hljs-string">  var MainActivity = Java.use(&#x27;类名&#x27;);</span><br><span class="hljs-string">  MainActivity.方法.implementation = function (入参) &#123;</span><br><span class="hljs-string">    //打印入参数据</span><br><span class="hljs-string">	console.log(入参)</span><br><span class="hljs-string">    var result=this.方法(入参)</span><br><span class="hljs-string">    //打印出参</span><br><span class="hljs-string">	console.log(出参)</span><br><span class="hljs-string">    //数据返回</span><br><span class="hljs-string">    return result</span><br><span class="hljs-string">  &#125;;</span><br><span class="hljs-string">&#125;);</span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-comment">#重启应用并附加到运行中的应用的进程中</span><br><span class="hljs-comment">#pid=frida.get_usb_device().spawn([&#x27;包名&#x27;])</span><br><span class="hljs-comment">#process = frida.get_usb_device().attach(pid)</span><br><br><span class="hljs-comment">#附加到运行中的应用的进程中</span><br>process = frida.get_usb_device().attach(<span class="hljs-string">&quot;HOOK包名&quot;</span>)<br><span class="hljs-comment">#创建js脚本</span><br>script = process.create_script(jscode)<br><span class="hljs-comment">#注入js脚本</span><br>script.on(<span class="hljs-string">&#x27;message&#x27;</span>, on_message)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*] Running&#x27;</span>)<br>script.load()<br>sys.stdin.read()<br><br></code></pre></td></tr></table></figure>

<h3 id="HOOK-native层方法模版"><a href="#HOOK-native层方法模版" class="headerlink" title="HOOK native层方法模版"></a>HOOK native层方法模版</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">import</span> frida, sys<br><br><span class="hljs-comment">#接收js脚本send方法传入的数据</span><br><span class="hljs-comment">#@message数据类型为字典</span><br><span class="hljs-comment">#&#123;&#x27;type&#x27;:&#x27;send&#x27;,&#x27;payload&#x27;:&#x27;js脚本发送的数据&#x27;&#125;</span><br><span class="hljs-comment">#@data数据类型为byte</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">on_message</span>(<span class="hljs-params">message, data</span>):</span><br>    <span class="hljs-keyword">if</span> message[<span class="hljs-string">&#x27;type&#x27;</span>] == <span class="hljs-string">&#x27;send&#x27;</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;[*] &#123;0&#125;&quot;</span>.<span class="hljs-built_in">format</span>(message[<span class="hljs-string">&#x27;payload&#x27;</span>]))<br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(message)<br><br>jscode = <span class="hljs-string">&quot;&quot;&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">setImmediate(function() &#123;</span><br><span class="hljs-string">#Interceptor.attach方法需要两个参数 1.NativePointer指针 2.回调方</span><br><span class="hljs-string">Interceptor.attach(Module.findExportByName(&quot;.so文件&quot; , &quot;导出方法&quot;), &#123;</span><br><span class="hljs-string">    onEnter: function(args) &#123;</span><br><span class="hljs-string"></span><br><span class="hljs-string">        send(&#x27;此消息发送给on_message方法&#x27;);</span><br><span class="hljs-string">    &#125;,</span><br><span class="hljs-string">    onLeave:function(retval)&#123;</span><br><span class="hljs-string">    </span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#125;);</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#125;);</span><br><span class="hljs-string"></span><br><span class="hljs-string">&quot;&quot;&quot;</span><br><br><span class="hljs-comment">#重启应用并附加到运行中的应用的进程中</span><br><span class="hljs-comment">#pid=frida.get_usb_device().spawn([&#x27;包名&#x27;])</span><br><span class="hljs-comment">#process = frida.get_usb_device().attach(pid)</span><br><br><span class="hljs-comment">#附加到运行中的应用的进程中</span><br>process = frida.get_usb_device().attach(<span class="hljs-string">&quot;HOOK包名&quot;</span>)<br><span class="hljs-comment">#创建js脚本</span><br>script = process.create_script(jscode)<br><span class="hljs-comment">#注入js脚本</span><br>script.on(<span class="hljs-string">&#x27;message&#x27;</span>, on_message)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;[*] Running&#x27;</span>)<br>script.load()<br>sys.stdin.read()<br><br></code></pre></td></tr></table></figure>

<h3 id="HOOK重载方法"><a href="#HOOK重载方法" class="headerlink" title="HOOK重载方法"></a>HOOK重载方法</h3><h4 id="1-apply-arguments"><a href="#1-apply-arguments" class="headerlink" title="1. apply arguments"></a>1. apply arguments</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js">MyClass.MyFunc.overload(<span class="hljs-string">&quot;java.util.List&quot;</span>).implementation = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-built_in">this</span>.MyFunc.overload(<span class="hljs-string">&quot;java.util.List&quot;</span>).apply(<span class="hljs-built_in">this</span>, <span class="hljs-built_in">arguments</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="2-argments下标"><a href="#2-argments下标" class="headerlink" title="2. argments下标"></a>2. argments下标</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js">MyClass.MyFunc.overload(<span class="hljs-string">&quot;java.util.List&quot;</span>).implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-built_in">this</span>.MyFunc(<span class="hljs-built_in">arguments</span>[<span class="hljs-number">0</span>]);<br>&#125;;<br></code></pre></td></tr></table></figure>

<h4 id="3-使用具体参数"><a href="#3-使用具体参数" class="headerlink" title="3. 使用具体参数"></a>3. 使用具体参数</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js">MyClass.MyFuncs.overload(<span class="hljs-string">&quot;int&quot;</span>, <span class="hljs-string">&quot;int&quot;</span>).implementation = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">s1, s2</span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> ret = <span class="hljs-built_in">this</span>.MyFuncs(s1, s2);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="4-call"><a href="#4-call" class="headerlink" title="4. call"></a>4. call</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> Handler = classFactory.use(<span class="hljs-string">&quot;android.os.Handler&quot;</span>);<br><span class="hljs-keyword">var</span> Looper = classFactory.use(<span class="hljs-string">&quot;android.os.Looper&quot;</span>);<br><br><span class="hljs-keyword">var</span> looper = Looper.getMainLooper();<br><span class="hljs-keyword">var</span> handler = Handler.$new.overload(<span class="hljs-string">&quot;android.os.Looper&quot;</span>).call(Handler, looper);<br><br><br>MyClass.MyFunc.overload(<span class="hljs-string">&quot;java.lang.String;&quot;</span>).implementation = &#123;<br>     <span class="hljs-built_in">this</span>.MyFunc.overload(<span class="hljs-string">&quot;java.lang.String&quot;</span>).call(<span class="hljs-built_in">this</span>, args[<span class="hljs-number">1</span>])<br>     MyClass.MyFunc.overload(<span class="hljs-string">&quot;java.lang.String&quot;</span>).call()<br>&#125;<br><br><br></code></pre></td></tr></table></figure>



<h3 id="拦截系统fopen函数"><a href="#拦截系统fopen函数" class="headerlink" title="拦截系统fopen函数"></a>拦截系统fopen函数</h3><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs stata"><span class="hljs-keyword">FILE</span> *fopen(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *filename, <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *mode)<br></code></pre></td></tr></table></figure>

<p>使用给定的模式 mode 打开 filename 所指向的文件。文件如果打开成功，会返回一个指针，相当于句柄，如果文件打开失败则返回 0。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js">Interceptor.attach(Module.findExportByName(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;fopen&quot;</span>), &#123;<br>    <br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>) </span>&#123;<br>            <span class="hljs-keyword">if</span> (!args[<span class="hljs-number">0</span>].isNull())&#123;<br>               <span class="hljs-keyword">var</span> path = args[<span class="hljs-number">0</span>].readUtf8String();<br>           		 <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;fopen &quot;</span> + path); <br>            &#125;<br>           <br>        &#125;,<br>            <span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>) </span>&#123;<br>  <br>                    retval.replace(<span class="hljs-number">0</span>);  <span class="hljs-comment">//将返回值替换成0</span><br>           <br>            &#125;,<br>    &#125;)<br></code></pre></td></tr></table></figure>



<h3 id="拦截自定义函数"><a href="#拦截自定义函数" class="headerlink" title="拦截自定义函数"></a>拦截自定义函数</h3><p>自定义一个 getEncryptKey 函数，返回的参数是一个字符串指针，我们在 onLeave 函数中添加下面的代码，分配内存并填充字符串 123456，最终替换返回值</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js">Interceptor.attach(Module.findExportByName(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;getEncryptKey&quot;</span>), &#123;<br><br>        <span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>) </span>&#123;<br>                <br>          		  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;getEncryptKey onLeave&quot;</span>); <br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] retval:&quot;</span> + retval.readUtf8String());<br>                <span class="hljs-keyword">var</span> string = Memory.allocUtf8String(<span class="hljs-string">&quot;1234567&quot;</span>); <span class="hljs-comment">//分配内存并填充数据</span><br>                retval.replace(string); <span class="hljs-comment">//替换</span><br><br>        &#125;,<br>&#125;)<br></code></pre></td></tr></table></figure>



<h3 id="修改C函数执行流程"><a href="#修改C函数执行流程" class="headerlink" title="修改C函数执行流程"></a>修改C函数执行流程</h3><p>以修改open方法为例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> openPtr = Module.getExportByName(<span class="hljs-literal">null</span>, <span class="hljs-string">&#x27;open&#x27;</span>);  <span class="hljs-comment">//获取open方法地址</span><br><span class="hljs-keyword">var</span> open = <span class="hljs-keyword">new</span> NativeFunction(openPtr, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]); <span class="hljs-comment">//创建方法</span><br>Interceptor.replace(openPtr, <span class="hljs-keyword">new</span> NativeCallback(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">pathPtr, flags</span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> path = pathPtr.readUtf8String();<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;[*]path: &#x27;</span> + path);<br>    <span class="hljs-keyword">var</span> fd = open(pathPtr, flags);<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;[*]fd:&#x27;</span> + fd);<br>    <span class="hljs-keyword">return</span> fd;<br>&#125;, <span class="hljs-string">&#x27;int&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>])); <span class="hljs-comment">//替换方法</span><br></code></pre></td></tr></table></figure>

<p>以修改fopen方法为例</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> fopenAddr = Module.findExportByName(<span class="hljs-string">&quot;libc.so&quot;</span>,<span class="hljs-string">&quot;fopen&quot;</span>);<br><br><span class="hljs-comment">//FILE* fopen(const char* __path, const char* __mode);</span><br><br><span class="hljs-keyword">var</span> func_c_fopen = <span class="hljs-keyword">new</span> NativeFunction(fopenAddr,<span class="hljs-string">&quot;pointer&quot;</span>,[<span class="hljs-string">&quot;pointer&quot;</span>,<span class="hljs-string">&quot;pointer&quot;</span>]);<br><br>Interceptor.replace(fopenAddr,<span class="hljs-keyword">new</span> NativeCallback(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">path,mode</span>) </span>&#123;<br><br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;替换&quot;</span>);<br>    <span class="hljs-built_in">console</span>.error(path,Memory.readCString(path),<span class="hljs-string">&quot;mode:&quot;</span>,Memory.readCString(mode));<br><br>    <span class="hljs-keyword">var</span> newPtr = Memory.allocUtf8String(<span class="hljs-string">&quot;/data/local/tmp/js/app.js&quot;</span>);<br><br>    <span class="hljs-keyword">return</span> func_c_fopen(newPtr,mode)<br><br>&#125;,<span class="hljs-string">&quot;pointer&quot;</span>,[<span class="hljs-string">&quot;pointer&quot;</span>,<span class="hljs-string">&quot;pointer&quot;</span>]));<br></code></pre></td></tr></table></figure>



<h3 id="拦截-sub-xxxx-函数"><a href="#拦截-sub-xxxx-函数" class="headerlink" title="拦截 sub_xxxx 函数"></a>拦截 sub_xxxx 函数</h3><p>通过指针去HOOK，首先通过IDA获取到方法的偏移地址，也就是sub后面的十六进制</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">//如果thumb指令需要将偏移地址+1</span><br>Interceptor.attach(Module.findBaseAddress(<span class="hljs-string">&quot;libc.so&quot;</span>).add(<span class="hljs-number">0x1A45</span>), &#123;<br>                <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">args</span>) </span>&#123;<br>          &#125;<br> &#125;);<br></code></pre></td></tr></table></figure>



<h3 id="HOOK-OC"><a href="#HOOK-OC" class="headerlink" title="HOOK OC"></a>HOOK OC</h3><h4 id="1-拦截自定义方法"><a href="#1-拦截自定义方法" class="headerlink" title="1. 拦截自定义方法"></a>1. 拦截自定义方法</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> method = ObjC.classes.类[<span class="hljs-string">&#x27;+/- 方法名&#x27;</span>];<br><span class="hljs-keyword">var</span> origImp = method.implementation; <br>method.implementation = ObjC.implement(method, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">self,selector</span>)</span>&#123;  <br> <br>      <span class="hljs-keyword">return</span> origImp(self,selector);    <br>    <br>&#125;);<br></code></pre></td></tr></table></figure>

<h4 id="2-拦截NSString"><a href="#2-拦截NSString" class="headerlink" title="2. 拦截NSString"></a>2. 拦截NSString</h4><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs haxe">frida-<span class="hljs-built_in">trace</span> -U -m <span class="hljs-string">&quot;+[NSURL URLWithString:]&quot;</span> xxx<br></code></pre></td></tr></table></figure>

<p>frida会自动在当前文件夹<code>__handlers__    </code>下生成js脚本，编辑并填写以下代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js">onEnter: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">log, args, state</span>) </span>&#123;<br>    log(<span class="hljs-string">&quot;+[NSURL URLWithString:&quot;</span> + args[<span class="hljs-number">2</span>] + <span class="hljs-string">&quot;]&quot;</span>);<br>    <span class="hljs-keyword">var</span> objcNSString = ObjC.Object(args[<span class="hljs-number">2</span>]);  <span class="hljs-comment">//将指针转为Objective-C 对象 NSString</span><br>    <span class="hljs-keyword">var</span> strObjcNSString = objcNSString.UTF8String(); <br>    log(<span class="hljs-string">&quot;+[NSURL URLWithString] str: &quot;</span> + strObjcNSString);    <br>  &#125;<br></code></pre></td></tr></table></figure>





<h4 id="3-拦截NSMutableURLRequest"><a href="#3-拦截NSMutableURLRequest" class="headerlink" title="3.拦截NSMutableURLRequest"></a>3.拦截NSMutableURLRequest</h4><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs haxe">frida-<span class="hljs-built_in">trace</span> -U -m <span class="hljs-string">&quot;-[NSURLRequest setHTTPBody:]&quot;</span> -m <span class="hljs-string">&quot;-[NSMutableURLRequest setHTTPBody:]&quot;</span> xxx<br></code></pre></td></tr></table></figure>

<p>找到 NSMutableURLRequest_setHTTPBody.js 修改成如下代码，可以看到调用 NSData 的 bytes 函数得到内存地址，然后再调用 readUtf8String 读取内存中的数据，即可得到字符串。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js">onEnter: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">log, args, state</span>) </span>&#123;<br>    log(<span class="hljs-string">&quot;-[NSMutableURLRequest setHTTPBody:&quot;</span> + args[<span class="hljs-number">2</span>] + <span class="hljs-string">&quot;]&quot;</span>);<br>    <span class="hljs-keyword">var</span> objcData = ObjC.Object(args[<span class="hljs-number">2</span>]); <span class="hljs-comment">//NSData</span><br>    <span class="hljs-keyword">var</span> strBody = objcData.bytes().readUtf8String(objcData.length()); <span class="hljs-comment">//NSData 转换成 string</span><br>    log(<span class="hljs-string">&quot;[NSMutableURLRequest setHTTPBody data: &quot;</span> + strBody);<br>  &#125;,<br></code></pre></td></tr></table></figure>

<h4 id="4-遍历-NSArray"><a href="#4-遍历-NSArray" class="headerlink" title="4. 遍历 NSArray"></a>4. 遍历 NSArray</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> array = <span class="hljs-keyword">new</span> ObjC.Object(args[<span class="hljs-number">2</span>]);<br><span class="hljs-keyword">var</span> count = array.count().valueOf();<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i !== count; i++) &#123;<br>  <span class="hljs-keyword">var</span> element = array.objectAtIndex_(i);<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="5-遍历-NSDictionary"><a href="#5-遍历-NSDictionary" class="headerlink" title="5. 遍历 NSDictionary"></a>5. 遍历 NSDictionary</h4><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> dict = <span class="hljs-keyword">new</span> ObjC.Object(args[<span class="hljs-number">2</span>]);<br><span class="hljs-keyword">var</span> enumerator = dict.keyEnumerator();<br><span class="hljs-keyword">var</span> key;<br><span class="hljs-keyword">while</span> ((key = enumerator.nextObject()) !== <span class="hljs-literal">null</span>) &#123;<br>  <span class="hljs-keyword">var</span> value = dict.objectForKey_(key);<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="6-通配符跟踪方法"><a href="#6-通配符跟踪方法" class="headerlink" title="6. 通配符跟踪方法"></a>6. 通配符跟踪方法</h4><figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs haxe">frida-<span class="hljs-built_in">trace</span> -U -m <span class="hljs-string">&quot;-[Home* *]&quot;</span> Twitter<br></code></pre></td></tr></table></figure>

<h4 id="7-跟踪CCCrypt"><a href="#7-跟踪CCCrypt" class="headerlink" title="7. 跟踪CCCrypt"></a>7. 跟踪CCCrypt</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs css">frida-trace -U -<span class="hljs-selector-tag">i</span> CCCrypt xxx<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs js">&#123;<br>  <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">log, args, state</span>) </span>&#123;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     operation   = args[0]</span><br><span class="hljs-comment">     CCAlgorithm = args[1]</span><br><span class="hljs-comment">     CCOptions   = args[2]</span><br><span class="hljs-comment">     keyBytes    = args[3]</span><br><span class="hljs-comment">     keyLength   = args[4]</span><br><span class="hljs-comment">  	 ivBuffer    = args[5]</span><br><span class="hljs-comment">     inBuffer    = args[6]</span><br><span class="hljs-comment">     inLength    = args[7]</span><br><span class="hljs-comment"> 	   outBuffer   = args[8]</span><br><span class="hljs-comment">     outLength   = args[9]</span><br><span class="hljs-comment">     outCountPtr = args[10]    </span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.operation == <span class="hljs-number">0</span>) &#123;  <span class="hljs-comment">//0代表加密</span><br>       <span class="hljs-comment">//解密前明文</span><br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;input:&quot;</span>)<br>        <span class="hljs-built_in">console</span>.log(hexdump(ptr(args[<span class="hljs-number">6</span>]), &#123;<br>            <span class="hljs-attr">length</span>: args[<span class="hljs-number">7</span>].toInt32(),<br>            <span class="hljs-attr">header</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-attr">ansi</span>: <span class="hljs-literal">true</span><br>        &#125;))<br>        <span class="hljs-comment">//密钥</span><br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;Key: &quot;</span>)<br>        <span class="hljs-built_in">console</span>.log(hexdump(ptr(args[<span class="hljs-number">3</span>]), &#123;<br>            <span class="hljs-attr">length</span>: args[<span class="hljs-number">4</span>].toInt32(),<br>            <span class="hljs-attr">header</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-attr">ansi</span>: <span class="hljs-literal">true</span><br>        &#125;))<br>        <span class="hljs-comment">//IV</span><br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;IV: &quot;</span>)<br>        <span class="hljs-built_in">console</span>.log(hexdump(ptr( args[<span class="hljs-number">5</span>]), &#123;<br>            <span class="hljs-attr">length</span>: args[<span class="hljs-number">4</span>].toInt32(),<br>            <span class="hljs-attr">header</span>: <span class="hljs-literal">true</span>,<br>            <span class="hljs-attr">ansi</span>: <span class="hljs-literal">true</span><br>        &#125;))<br>    &#125;<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>拦截URWithString</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> className = <span class="hljs-string">&quot;NSURL&quot;</span>;<br><span class="hljs-keyword">var</span> funcName = <span class="hljs-string">&quot;+ URLWithString:&quot;</span>;<br><span class="hljs-keyword">var</span> hook = <span class="hljs-built_in">eval</span>(<span class="hljs-string">&#x27;ObjC.classes.&#x27;</span> + className + <span class="hljs-string">&#x27;[&quot;&#x27;</span> + funcName + <span class="hljs-string">&#x27;&quot;]&#x27;</span>);<br>Interceptor.attach(hook.implementation, &#123;<br>   <br><br>        <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>)</span>&#123;<br><br>                <span class="hljs-keyword">var</span> className = ObjC.Object(args[<span class="hljs-number">0</span>]);<br>                <span class="hljs-keyword">var</span> methodName = args[<span class="hljs-number">1</span>];<br>                <span class="hljs-keyword">var</span> urlString = ObjC.Object(args[<span class="hljs-number">2</span>]);<br><br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;className: &quot;</span> + className.toString());<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;methodName: &quot;</span> + methodName.readUtf8String());<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;urlString: &quot;</span> + urlString.toString());<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;-----------------------------------------&quot;</span>);<br><br>                urlString = ObjC.classes.NSString.stringWithString_(<span class="hljs-string">&quot;http://www.baidu.com&quot;</span>)<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;newUrlString: &quot;</span> + urlString.toString());<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;-----------------------------------------&quot;</span>);<br><br>        &#125;,<br><br>     <span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>) </span>&#123;<br><br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] Class Name: &quot;</span> + className);<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[*] Method Name: &quot;</span> + funcName);<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;\t[-] Type of return value: &quot;</span> + <span class="hljs-keyword">typeof</span> retval);<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;\t[-] Original Return Value: &quot;</span> + retval);<br>        &#125;<br>&#125;);<br></code></pre></td></tr></table></figure>

<p>有时候被拦截的函数调用的次数较多，打印的信息也会较多，我们需要保存成文件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> file = <span class="hljs-keyword">new</span> File(<span class="hljs-string">&quot;/var/mobile/log.txt&quot;</span>,<span class="hljs-string">&quot;a+&quot;</span>);<span class="hljs-comment">//a+表示追加内容，和c语言的fopen函数模式类似</span><br>file.write(<span class="hljs-string">&quot;logInfo&quot;</span>);<br>file.flush();<br>file.close();<br></code></pre></td></tr></table></figure>

<h4 id="8-API查找器和拦截器的组合使用实现批量HOOK"><a href="#8-API查找器和拦截器的组合使用实现批量HOOK" class="headerlink" title="8. API查找器和拦截器的组合使用实现批量HOOK"></a>8. API查找器和拦截器的组合使用实现批量HOOK</h4><p>API查找器支持对 Objective-C 方法和 C 函数的查找，比如我们来写一个找到 NSFileManager 这个类名下的所有方法。新建一个 ApiResolver，如果查找 Objective-C，ApiResolver 参数中填写 objc，如果是查找 C 函数，ApiResolver 参数中填写 module，然后调用 enumerateMatches 枚举函数，每次枚举到一个函数会调用一次 onMatch，回调参数 match 包含 name 和 address 两个属性，分别代表名称和地址。整个枚举过程完成之后会调用 onComplete，代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> resolver = <span class="hljs-keyword">new</span> ApiResolver(<span class="hljs-string">&#x27;objc&#x27;</span>);<br>resolver.enumerateMatches(<span class="hljs-string">&#x27;*[NSFileManager *]&#x27;</span>, &#123;<br>   <span class="hljs-attr">onMatch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">match</span>) </span>&#123;<br>      <span class="hljs-built_in">console</span>.log(match[<span class="hljs-string">&#x27;name&#x27;</span>] + <span class="hljs-string">&quot;:&quot;</span> + match[<span class="hljs-string">&#x27;address&#x27;</span>]);<br>   &#125;,<br>   <span class="hljs-attr">onComplete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;&#125;<br>&#125;);<br><br></code></pre></td></tr></table></figure>

<p>附加 Safari 浏览器并加载脚本，会打印出 NSFileManager 所有的方法。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs js">frida -U -l hook_objc.js <span class="hljs-string">&quot;Safari 浏览器&quot;</span><br>-[NSFileManager dealloc]:<span class="hljs-number">0x1e2324034</span><br>-[NSFileManager setDelegate:]:<span class="hljs-number">0x1e23b2744</span><br>-[NSFileManager delegate]:<span class="hljs-number">0x1e2333ab8</span><br>-[NSFileManager _info]:<span class="hljs-number">0x1e2333ae0</span><br>-[NSFileManager removeItemAtURL:error:]:<span class="hljs-number">0x1e235583c</span><br>-[NSFileManager copyItemAtURL:toURL:error:]:<span class="hljs-number">0x1e23b2ab0</span><br>-[NSFileManager fileExistsAtPath:isDirectory:]:<span class="hljs-number">0x1e2301d50</span><br>-[NSFileManager fileExistsAtPath:]:<span class="hljs-number">0x1e22e5398</span><br>-[NSFileManager setAttributes:ofItemAtPath:error:]:<span class="hljs-number">0x1e23180bc</span><br>-[NSFileManager removeItemAtPath:error:]:<span class="hljs-number">0x1e23336bc</span><br>-[NSFileManager enumeratorAtPath:]:<span class="hljs-number">0x1e2326024</span><br>-[NSFileManager isWritableFileAtPath:]:<span class="hljs-number">0x1e23240dc</span><br>-[NSFileManager moveItemAtPath:toPath:uniquePath:error:]:<span class="hljs-number">0x1ec6f4ec4</span><br>-[NSFileManager copyItemAtPath:toPath:uniquePath:error:]:<span class="hljs-number">0x1ec6f4ed4</span><br>......<br></code></pre></td></tr></table></figure>

<p>得到方法名称之后，我们可以把感兴趣的找出来，然后调用拦截器（Interceptor）进行 Hook ，比如我们需要做一个简易的文件监控的功能，监控某个进程操作了哪些文件，文件操作的相关的方法会调用 removeItemAtPath、moveItemAtPath、copyItemAtPath、createFileAtPath、createDirectoryAtPath、enumeratorAtPath、contentsOfDirectoryAtPath，分别代表删除文件、移动文件、复制文件、创建文件、创建目录、枚举目录（包括子目录），枚举目录（不包括子目录），具体代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> resolver = <span class="hljs-keyword">new</span> ApiResolver(<span class="hljs-string">&#x27;objc&#x27;</span>);<br>resolver.enumerateMatches(<span class="hljs-string">&#x27;*[NSFileManager *]&#x27;</span>, &#123;<br>   <span class="hljs-attr">onMatch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">match</span>) </span>&#123;<br>      <span class="hljs-keyword">var</span> method = match[<span class="hljs-string">&#x27;name&#x27;</span>];<br>      <span class="hljs-keyword">var</span> implementation = match[<span class="hljs-string">&#x27;address&#x27;</span>];<br><br>      <span class="hljs-comment">// 过滤需要拦截的方法</span><br>      <span class="hljs-keyword">if</span> (<span class="hljs-comment">//(method.indexOf(&quot;fileExistsAtPath&quot;) != -1) </span><br>         (method.indexOf(<span class="hljs-string">&quot;removeItemAtPath&quot;</span>) != -<span class="hljs-number">1</span>)<br>        || (method.indexOf(<span class="hljs-string">&quot;moveItemAtPath&quot;</span>) != -<span class="hljs-number">1</span>)<br>        || (method.indexOf(<span class="hljs-string">&quot;copyItemAtPath&quot;</span>) != -<span class="hljs-number">1</span>)<br>        || (method.indexOf(<span class="hljs-string">&quot;createFileAtPath&quot;</span>) != -<span class="hljs-number">1</span>)<br>        || (method.indexOf(<span class="hljs-string">&quot;createDirectoryAtPath&quot;</span>) != -<span class="hljs-number">1</span>)<br>        || (method.indexOf(<span class="hljs-string">&quot;enumeratorAtPath&quot;</span>) != -<span class="hljs-number">1</span>)<br>        || (method.indexOf(<span class="hljs-string">&quot;contentsOfDirectoryAtPath&quot;</span>) != -<span class="hljs-number">1</span>)) &#123;<br><br>         <span class="hljs-built_in">console</span>.log(match[<span class="hljs-string">&#x27;name&#x27;</span>] + <span class="hljs-string">&quot;:&quot;</span> + match[<span class="hljs-string">&#x27;address&#x27;</span>]);<br>         <span class="hljs-keyword">try</span> &#123;<br>            Interceptor.attach(implementation, &#123;<br>               <span class="hljs-attr">onEnter</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">args</span>) </span>&#123;<br><br>                  <span class="hljs-keyword">var</span> className = ObjC.Object(args[<span class="hljs-number">0</span>]);<br>                  <span class="hljs-keyword">var</span> methodName = args[<span class="hljs-number">1</span>];<br>                  <span class="hljs-keyword">var</span> filePath = ObjC.Object(args[<span class="hljs-number">2</span>]);<br><br>                  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;className: &quot;</span> + className.toString());<br>                  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;methodName: &quot;</span> + methodName.readUtf8String());<br>                  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;filePath: &quot;</span> + filePath.toString());<br>                 <br>               &#125;,<br>               <span class="hljs-attr">onLeave</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">retval</span>) </span>&#123;<br>                  <br>               &#125;<br>            &#125;);<br>         &#125; <span class="hljs-keyword">catch</span> (err) &#123;<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;[!] Exception: &quot;</span> + err.message);<br>         &#125;<br>      &#125;<br><br>   &#125;,<br>   <span class="hljs-attr">onComplete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;<br>   &#125;<br>&#125;);<br></code></pre></td></tr></table></figure>

<p>附加 SpringBoard 并加载脚本，然后我们操作卸载某个应用，此时会打印出相关的文件操作的路径，从下面打印的信息中我们可以看到卸载某个应用时，SpringBoard 进程对文件的操作过程，会删除 /var/mobile/Library/UserNotifications 和应用的沙盒目录。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs js">frida -U -l hook_objc.js SpringBoard<br>[iPhone::SpringBoard]-&gt; <br>className: &lt;NSFileManager: 0x282954250&gt;<br>methodName: removeItemAtPath:error:<br>filePath: /var/mobile/Library/UserNotifications/com.360buy.jdmobile/Attachments<br>className: &lt;NSFileManager: 0x282954250&gt;<br>methodName: filesystemItemRemoveOperation:shouldRemoveItemAtPath:<br>filePath: &lt;NSFilesystemItemRemoveOperation: 0x283674f40&gt;<br>className: &lt;NSFileManager: 0x282954250&gt;<br>methodName: enumeratorAtPath:<br>filePath: /private/var/mobile/Containers/Data/Application/C8A23CD4-6857-4BF4-876E-7FD104B0E799/Library/Caches/Snapshots/com.360buy.jdmobile<br>className: &lt;NSFileManager: 0x282954250&gt;<br>methodName: removeItemAtPath:error:<br>filePath: /private/var/mobile/Containers/Data/Application/C8A23CD4-6857-4BF4-876E-7FD104B0E799/Library/Caches/Snapshots/com.360buy.jdmobile<br>className: &lt;NSFileManager: 0x282954250&gt;<br>methodName: filesystemItemRemoveOperation:shouldRemoveItemAtPath:<br>filePath: &lt;NSFilesystemItemRemoveOperation: 0x283677e80&gt;<br>className: &lt;NSFileManager: 0x282954250&gt;<br>methodName: removeItemAtPath:error:<br>filePath: /private/var/mobile/Containers/Data/Application/C8A23CD4-6857-4BF4-876E-7FD104B0E799/Library/Caches/Snapshots<br>className: &lt;NSFileManager: 0x282954250&gt;<br>methodName: filesystemItemRemoveOperation:shouldRemoveItemAtPath:<br>filePath: &lt;NSFilesystemItemRemoveOperation: 0x283677e80&gt;<br>.......<br></code></pre></td></tr></table></figure>

<p>比如需要拦截 NSFileManager 类的所有方法，但是排除某些方法，代码可以这样写</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> resolver = <span class="hljs-keyword">new</span> ApiResolver(<span class="hljs-string">&#x27;objc&#x27;</span>);<br>resolver.enumerateMatches(<span class="hljs-string">&#x27;*[NSFileManager *]&#x27;</span>, &#123;<br>   <span class="hljs-attr">onMatch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">match</span>) </span>&#123;<br>      <span class="hljs-keyword">var</span> method = match[<span class="hljs-string">&#x27;name&#x27;</span>];<br>      <span class="hljs-keyword">var</span> implementation = match[<span class="hljs-string">&#x27;address&#x27;</span>];<br><br>      <span class="hljs-comment">// 过滤不需要拦截的方法，其他方法全部拦截</span><br>      <span class="hljs-keyword">if</span> (method.indexOf(<span class="hljs-string">&quot;dealloc&quot;</span>) == -<span class="hljs-number">1</span>) &#123;<br>         <span class="hljs-comment">//进行 Hook</span><br>         <span class="hljs-comment">//......</span><br>      &#125;<br>   &#125;,<br>&#125;);<br></code></pre></td></tr></table></figure>

<p>接下来我们来学习 API 查找器如何查找 C 函数，有 3 种方式，格式参考如下：</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim">format i<span class="hljs-variable">s:</span> export<span class="hljs-variable">s:</span>*!open*, export<span class="hljs-variable">s:libc</span>.so!* <span class="hljs-built_in">or</span> import<span class="hljs-variable">s:notepad</span>.exe!*<br></code></pre></td></tr></table></figure>

<p>比如我们查找 fopen 函数，代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> resolver = <span class="hljs-keyword">new</span> ApiResolver(<span class="hljs-string">&#x27;module&#x27;</span>);<br>resolver.enumerateMatches(<span class="hljs-string">&#x27;exports:*!fopen*&#x27;</span>, &#123;<br>    <span class="hljs-attr">onMatch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">match</span>) </span>&#123;<br><br>         <span class="hljs-keyword">var</span> name = match[<span class="hljs-string">&#x27;name&#x27;</span>];<br>         <span class="hljs-keyword">var</span> address = match[<span class="hljs-string">&#x27;address&#x27;</span>];<br>         <span class="hljs-built_in">console</span>.log(name + <span class="hljs-string">&quot;:&quot;</span> + address);<br><br>    &#125;,<br>    <span class="hljs-attr">onComplete</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;&#125;<br>&#125;);<br></code></pre></td></tr></table></figure>

<p>附加 SpringBoard 加载脚本之后，打印如下信息，名称包括了动态库的路径，此时得到函数地址，就可以调用拦截器进行 Hook。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs js">frida -U -l hook_objc.js SpringBoard<br>[iPhone::SpringBoard]-&gt; <br><span class="hljs-regexp">/usr/</span>lib/libSystem.B.dylib!fopen:<span class="hljs-number">0x1e145d4d0</span><br>/usr/lib/libSystem.B.dylib!fopen$DARWIN_EXTSN:<span class="hljs-number">0x1e1495d04</span><br>/usr/lib/system/libsystem_c.dylib!fopen$DARWIN_EXTSN:<span class="hljs-number">0x1e1495d04</span><br>/usr/lib/system/libsystem_c.dylib!fopen:<span class="hljs-number">0x1e145d4d0</span><br>/usr/lib/libSystem.B.dylib!fopen:<span class="hljs-number">0x1e145d4d0</span><br>/usr/lib/libSystem.B.dylib!fopen$DARWIN_EXTSN:<span class="hljs-number">0x1e1495d04</span><br></code></pre></td></tr></table></figure>

<p>Objective-C 除了调用拦截器进行 Hook，还可以使用替换 implementation 的方式，类似于苹果提供的一套  Method Swizzling Hook 的方式，比如 Hook +[NSURL URLWithString:] 的例子如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> method = ObjC.classes.NSURL[<span class="hljs-string">&#x27;+ URLWithString:&#x27;</span>];<br><span class="hljs-keyword">var</span> origImp = method.implementation; <br>method.implementation = ObjC.implement(method, <span class="hljs-function"><span class="hljs-keyword">function</span>  (<span class="hljs-params">self, sel, url</span>)</span>&#123;  <br><br>      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;+ [NSURL URLWithString:]&quot;</span>);<br>      <span class="hljs-keyword">var</span> urlString = ObjC.Object(url);<br>      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;url: &quot;</span> + urlString.toString());<br><br>      <span class="hljs-keyword">return</span> origImp(self, sel, url);   <span class="hljs-comment">//调用原方法，如果不调用则原方法得不到执行</span><br><br>                        <span class="hljs-comment">//替换参数，将 URL 替换成 http://www.ioshacker.net</span><br>      <span class="hljs-comment">//var newUrl = ObjC.classes.NSString.stringWithString_(&quot;http://www.ioshacker.net&quot;);</span><br>      <span class="hljs-comment">//return origImp(self, sel, newUrl);  </span><br><br>&#125;); <br></code></pre></td></tr></table></figure>





<h2 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h2><p>远程过程调用（RPC）对于应用逆向起到了很便捷的作用，比如目标应用有一个加解密的函数内部实现非常复杂，想分析整个加解密的实现过程的工作量较大，此时可以使用 frida 的 RPC 功能，只要知道加解密函数的名称或地址，还有相应的参数，即可直接调用得到加解密后的结果。<br>下面我们来做一个实例，编写一个 CrackMe 程序，定义一个 coreClass 类，里面有 4 个比较重要的方法，分别是 getDeviceId、httpPost、encrypt、decrypt，从它们的名称可以看出大概的意思，具体的定义如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs js">@interface coreClass : NSObject<br>@end<br><br>@implementation coreClass<br><br>- (NSString*)getDeviceId&#123;<br>    <span class="hljs-keyword">return</span> @<span class="hljs-string">&quot;e10adc3949ba59abbe56e057f20f883e&quot;</span>;<br>&#125;<br><br>+(NSString*)httpPost:(NSString*)url&#123;<br>    NSLog(@<span class="hljs-string">&quot;URL: %@&quot;</span>, url);<br>    <span class="hljs-keyword">return</span> @<span class="hljs-string">&quot;test&quot;</span>;<br>&#125;<br><br>- (NSString*)encrypt:(NSData*)data :(NSString*)key&#123;<br>    <br>    NSLog(@<span class="hljs-string">&quot;data: %@&quot;</span>, data);<br>    NSLog(@<span class="hljs-string">&quot;key: %@&quot;</span>, key);<br>    <span class="hljs-keyword">return</span> @<span class="hljs-string">&quot;encrypt successed!&quot;</span>;<br>&#125;<br><br>- (NSString*)decrypt:(NSString*)str :(NSString*)key&#123;<br>    NSLog(@<span class="hljs-string">&quot;str: %@&quot;</span>, str);<br>    NSLog(@<span class="hljs-string">&quot;key: %@&quot;</span>, key);<br>    <span class="hljs-keyword">return</span> @<span class="hljs-string">&quot;decrypt successed!&quot;</span>;<br>&#125;<br>@end<br></code></pre></td></tr></table></figure>

<p>下面我们要做的事情是在 JS 脚本里去调用这 4 个方法。Objective-C 方法有两种，一种是 - 号开头，称为对象方法，还有一种是 + 号开头，称为类方法，前者需要初始化一个实例才能调用，后者不需要初始化实例，可以直接调用。先来看看对象方法在 JS 脚本里如何调用，比如我们要调用 -[coreClass getDeviceId] 方法，调用的代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> coreClass = ObjC.classes.coreClass.alloc();<br><span class="hljs-keyword">var</span> deviceId = coreClass[<span class="hljs-string">&#x27;- getDeviceId&#x27;</span>].call(coreClass);<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;deviceId: &quot;</span> + deviceId.toString());<br></code></pre></td></tr></table></figure>

<p>再来看看 +[coreClass httpPost:] 方法的调用，从下面的代码可以看出，类方法是不需要初始化实例，在方法名称后面加上一个 _ 号就可以调用了</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> coreClass = ObjC.classes.coreClass;<br><span class="hljs-keyword">var</span> url = ObjC.classes.NSURL.URLWithString_(<span class="hljs-string">&quot;http://www.ioshacker.net&quot;</span>);<br><span class="hljs-keyword">var</span> retString =  coreClass.httpPost_(url);<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;retString: &quot;</span> + retString);<br></code></pre></td></tr></table></figure>

<p>-[coreClass encrypt::] 的调用代码如下，输入的参数有两个，一个参数是 NSData 类型的，一个是 NSString 类型。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> coreClass = ObjC.classes.coreClass.alloc();<br><span class="hljs-keyword">var</span> str = ObjC.classes.NSString.stringWithString_(<span class="hljs-string">&quot;test&quot;</span>);<br><br><span class="hljs-comment">//NSData *data = [@&quot;data&quot; dataUsingEncoding:NSUTF8StringEncoding];</span><br><span class="hljs-keyword">var</span> data = str.dataUsingEncoding_(<span class="hljs-number">4</span>);<br><span class="hljs-keyword">var</span> key = ObjC.classes.NSString.stringWithString_(<span class="hljs-string">&quot;key&quot;</span>);<br><br><span class="hljs-keyword">var</span> encryptString = coreClass[<span class="hljs-string">&#x27;- encrypt::&#x27;</span>].call(coreClass, data, key);<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;encryptString: &quot;</span> + encryptString);<br></code></pre></td></tr></table></figure>

<p>-[coreClass decrypt::] 的调用代码如下，两个参数都是 NSString 类型。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> coreClass = ObjC.classes.coreClass.alloc();<br><span class="hljs-keyword">var</span> str = ObjC.classes.NSString.stringWithString_(<span class="hljs-string">&quot;test&quot;</span>);<br><span class="hljs-keyword">var</span> key = ObjC.classes.NSString.stringWithString_(<span class="hljs-string">&quot;key&quot;</span>);<br><span class="hljs-keyword">var</span> decryptString = coreClass[<span class="hljs-string">&#x27;- decrypt::&#x27;</span>].call(coreClass, str, key);<br><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;decryptString: &quot;</span> + decryptString);<br></code></pre></td></tr></table></figure>

<p>在上面我们已经学会如何在 JS 脚本里调用目标应用的 Objective-C 方法，接下面要做的就是将功能代码导出提供给 Python 使用。在 JS 代码里定义4个函数，分别是 getDeviceId、httpPost、encrypt、decrypt，这 4 个函数分别代表了调用目标进程的 4 个 Objective-C 方法，然后再使用 rpc.exports 将这 4 个函数导出，代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getDeviceId</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">var</span> coreClass = ObjC.classes.coreClass.alloc();<br>        <span class="hljs-keyword">var</span> deviceId = coreClass[<span class="hljs-string">&#x27;- getDeviceId&#x27;</span>].call(coreClass);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;deviceId: &quot;</span> + deviceId.toString());<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;--------------------&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">httpPost</span>(<span class="hljs-params">inputurl</span>)</span>&#123;<br>        <span class="hljs-keyword">var</span> coreClass = ObjC.classes.coreClass;<br>        <span class="hljs-keyword">var</span> url = ObjC.classes.NSURL.URLWithString_(inputurl);<br>        <span class="hljs-keyword">var</span> retString =  coreClass.httpPost_(url);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;retString: &quot;</span> + retString);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;--------------------&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">encrypt</span>(<span class="hljs-params">inputstr, inputkey</span>)</span>&#123;<br>        <span class="hljs-keyword">var</span> coreClass = ObjC.classes.coreClass.alloc();<br>        <span class="hljs-keyword">var</span> str = ObjC.classes.NSString.stringWithString_(inputstr);<br><br>        <span class="hljs-comment">//NSData *data = [@&quot;data&quot; dataUsingEncoding:NSUTF8StringEncoding];</span><br>        <span class="hljs-keyword">var</span> data = str.dataUsingEncoding_(<span class="hljs-number">4</span>);<br>        <span class="hljs-keyword">var</span> key = ObjC.classes.NSString.stringWithString_(inputkey);<br><br>        <span class="hljs-keyword">var</span> encryptString = coreClass[<span class="hljs-string">&#x27;- encrypt::&#x27;</span>].call(coreClass, data, key);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;encryptString: &quot;</span> + encryptString);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;--------------------&quot;</span>);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">decrypt</span>(<span class="hljs-params">inputstr, inputkey</span>)</span>&#123;<br>        <span class="hljs-keyword">var</span> coreClass = ObjC.classes.coreClass.alloc();<br>        <span class="hljs-keyword">var</span> str = ObjC.classes.NSString.stringWithString_(inputstr);<br>        <span class="hljs-keyword">var</span> key = ObjC.classes.NSString.stringWithString_(inputkey);<br>        <span class="hljs-keyword">var</span> decryptString = coreClass[<span class="hljs-string">&#x27;- decrypt::&#x27;</span>].call(coreClass, str, key);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;decryptString: &quot;</span> + decryptString);<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;--------------------&quot;</span>);<br>&#125;<br><br><span class="hljs-comment">//getDeviceId();</span><br><span class="hljs-comment">//httpPost(&quot;http://www.ioshacker.net&quot;);</span><br><span class="hljs-comment">//encrypt(&quot;123&quot;, &quot;456&quot;);</span><br><span class="hljs-comment">//decrypt(&quot;123&quot;, &quot;456&quot;);</span><br><br><span class="hljs-comment">// 导出RPC函数</span><br>rpc.exports = &#123;<br>    <span class="hljs-attr">deviceid</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>&#123;<br>        getDeviceId();<br>    &#125;,<br>    <span class="hljs-attr">httppost</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">urlstr</span>) </span>&#123;<br>        httpPost(urlstr);<br>    &#125;,<br>    <span class="hljs-attr">encrypt</span>: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">inputstr, inputkey</span>) </span>&#123;<br>        encrypt(inputstr, inputkey);<br>    &#125;,<br>    <span class="hljs-attr">decrypt</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">inputstr, inputkey</span>) </span>&#123;<br>        decrypt(inputstr, inputkey);<br>    &#125;,<br>&#125;;<br></code></pre></td></tr></table></figure>

<p>接着我们再编写 python 代码，首先调用 get_usb_device().attach 附加到目标进程，附加成功会返回一个 Session 实例，然后读取 call.js 文件里的内容，这里的内容就是上面我们编写的 JS 代码，然后调用 session.create_script 创建脚本，再调用 load 加载脚本，最后调用 script.exports 获取 JS 导出的 RPC 函数，此时就可以调用 RPC 函数，代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># -*- coding: utf-8 -*-</span><br><span class="hljs-keyword">import</span> codecs<br><span class="hljs-keyword">import</span> frida<br><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>        <span class="hljs-comment">#附加到目标进程</span><br>        session = frida.get_usb_device().attach(<span class="hljs-string">u&#x27;CrackMe&#x27;</span>)<br><br>        <span class="hljs-comment">#读取JS脚本</span><br>        <span class="hljs-keyword">with</span> codecs.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./call.js&#x27;</span>, <span class="hljs-string">&#x27;r&#x27;</span>, <span class="hljs-string">&#x27;utf-8&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>            source = f.read()<br><br>        script = session.create_script(source)<br>        script.load()<br><br>        rpc = script.exports<br><br>        <span class="hljs-comment">#调用导出的函数</span><br>        rpc.deviceid()<br>        rpc.httpPost(<span class="hljs-string">&quot;http://www.ioshacker.net&quot;</span>)<br>        rpc.encrypt(<span class="hljs-string">&quot;123&quot;</span>, <span class="hljs-string">&quot;456&quot;</span>)<br>        rpc.decrypt(<span class="hljs-string">&quot;123&quot;</span>, <span class="hljs-string">&quot;456&quot;</span>)<br>        session.detach()    <br></code></pre></td></tr></table></figure>

<p>上面我们讲到了如何将 Objective-C 方法导出给 Python 使用，那如何导出 C 函数呢？比如调用 NSHomeDirectory 这个系统提供的函数，知道它所在的模块是 Foundation，找到它的地址在 JS 脚本里就可以调用，然后在 rpc.exports 里添加一个导出函数，这样 Python 就可以调用了。代码如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getHomeDir</span>(<span class="hljs-params"></span>)</span>&#123;<br>        <span class="hljs-keyword">var</span> NSHomeDirectory = <span class="hljs-keyword">new</span> NativeFunction(ptr(Module.findExportByName(<span class="hljs-string">&quot;Foundation&quot;</span>, <span class="hljs-string">&quot;NSHomeDirectory&quot;</span>)), <span class="hljs-string">&#x27;pointer&#x27;</span>, []);<br>        <span class="hljs-keyword">var</span> path = <span class="hljs-keyword">new</span> ObjC.Object(NSHomeDirectory());<br>        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;homeDir: &#x27;</span> + path);<br>&#125;<br><br><span class="hljs-comment">// 导出RPC函数</span><br>rpc.exports = &#123;<br>    <span class="hljs-comment">//......</span><br>    <span class="hljs-attr">homedir</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;<br>            getHomeDir();<br>    &#125;<br>&#125;;<br></code></pre></td></tr></table></figure>




<h2 id="b2s-and-s2b"><a href="#b2s-and-s2b" class="headerlink" title="b2s and s2b"></a>b2s and s2b</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs js">    <span class="hljs-comment">//b2s</span><br>  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">b2s</span>(<span class="hljs-params">array</span>) </span>&#123;<br>        <span class="hljs-keyword">var</span> result = <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; array.length; i++) &#123;<br>            result += <span class="hljs-built_in">String</span>.fromCharCode(modulus(array[i], <span class="hljs-number">256</span>));<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">modulus</span>(<span class="hljs-params">x, n</span>) </span>&#123;<br>        <span class="hljs-keyword">return</span> ((x % n) + n) % n;<br>    &#125;<br>    <br><span class="hljs-comment">//s2b</span><br><br><span class="hljs-keyword">var</span> StringClass=Java.use(<span class="hljs-string">&quot;java.lang.String&quot;</span>);<br><span class="hljs-keyword">var</span> b2sString = b2s(<span class="hljs-string">&#x27;字节数组&#x27;</span>)<br><span class="hljs-built_in">console</span>.log(b2sString)<br><span class="hljs-keyword">var</span> jstring  = StringClass.$new(b2sString)<br><span class="hljs-keyword">var</span> jbyte  =  jstring.getBytes(<span class="hljs-string">&quot;UTF-8&quot;</span>)<br><br></code></pre></td></tr></table></figure>

<h2 id="插件化-hook"><a href="#插件化-hook" class="headerlink" title="插件化 hook"></a>插件化 hook</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">foo</span>(<span class="hljs-params">clz</span>)</span>&#123;<br>    <span class="hljs-built_in">console</span>.log(clz)<br>&#125;<br>Java.perform(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;<br>    Java.choose(<span class="hljs-string">&quot;dalvik.system.PathClassLoader&quot;</span>,&#123;<br>        <span class="hljs-attr">onMatch</span>: <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">instance</span>)</span>&#123;<br>            <span class="hljs-built_in">console</span>.log(instance)<br>            <span class="hljs-built_in">console</span>.log(Java.ClassFactory)<br>            <span class="hljs-keyword">var</span> factory = Java.ClassFactory.get(instance)<br>            <span class="hljs-keyword">try</span>&#123;<br>                <span class="hljs-keyword">var</span> myClass = factory.use(<span class="hljs-string">&quot;myClass&quot;</span>)<br>                foo(myClass)<br>                <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;stop&quot;</span><br>            &#125;<span class="hljs-keyword">catch</span>(e)&#123;<br>                <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;next&quot;</span>)<br>                <span class="hljs-built_in">console</span>.log(e)<br>            &#125;<br>        &#125;,<br>        <span class="hljs-attr">onComplete</span>:<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;<br>            <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;Done&quot;</span>)<br>        &#125;<br>    &#125;)<br>&#125;)<br></code></pre></td></tr></table></figure>


<h2 id="创建字节数组"><a href="#创建字节数组" class="headerlink" title="创建字节数组"></a>创建字节数组</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> myArray=<span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(<span class="hljs-number">1024</span>);<br><span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span><br><span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; myArray.length; i++) &#123;<br>    myArray[i]= <span class="hljs-number">0x0</span>;<br>&#125;<br><span class="hljs-keyword">var</span> buffer = Java.array(<span class="hljs-string">&#x27;byte&#x27;</span>,myArray);<br></code></pre></td></tr></table></figure>


<h2 id="打印字节数组"><a href="#打印字节数组" class="headerlink" title="打印字节数组"></a>打印字节数组</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> size = <span class="hljs-number">100</span>;  <span class="hljs-comment">//字节数组长度</span><br><span class="hljs-keyword">var</span> bytearr=  Java.array(<span class="hljs-string">&quot;byte&quot;</span>,arg1); <span class="hljs-comment">//方便for循环</span><br><span class="hljs-keyword">var</span> content = <span class="hljs-string">&quot;&quot;</span>;<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>;i&lt;size;i++)&#123;<br>    content = content + <span class="hljs-built_in">String</span>.fromCharCode(bytearr[i]);<br>&#125;<br><span class="hljs-built_in">console</span>.log(content)<br></code></pre></td></tr></table></figure>


<h2 id="load-dex打印对象"><a href="#load-dex打印对象" class="headerlink" title="load dex打印对象"></a>load dex打印对象</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs js">Java.openClassFile(<span class="hljs-string">&quot;xxxxx.dex&quot;</span>).load();<br><span class="hljs-keyword">const</span>  gson = Java.use(<span class="hljs-string">&quot;com.xxxx.xxxx&quot;</span>);<br><span class="hljs-built_in">console</span>.log(gson.$new().toJson(xxxx));<br></code></pre></td></tr></table></figure>

<h2 id="打印堆栈"><a href="#打印堆栈" class="headerlink" title="打印堆栈"></a>打印堆栈</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-built_in">console</span>.log(Java.use(<span class="hljs-string">&quot;android.util.Log&quot;</span>).getStackTraceString(Java.use(<span class="hljs-string">&quot;java.lang.Throwable&quot;</span>).$new()));<br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-built_in">console</span>.log(<span class="hljs-string">&#x27;\tBacktrace:\n\t&#x27;</span> + Thread.backtrace(<span class="hljs-built_in">this</span>.context,Backtracer.FUZZY).map(DebugSymbol.fromAddress).join(<span class="hljs-string">&#x27;\n\t&#x27;</span>));<br></code></pre></td></tr></table></figure>



<h2 id="SUB方法主动调用"><a href="#SUB方法主动调用" class="headerlink" title="SUB方法主动调用"></a>SUB方法主动调用</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span>  <span class="hljs-title">hooksub</span>(<span class="hljs-params">content</span>) </span>&#123;<br><br>    <span class="hljs-keyword">var</span> offset = <span class="hljs-number">0x835</span>;  <span class="hljs-comment">//sub方法偏移</span><br>    <span class="hljs-keyword">var</span> nativeLibModule  = Process.getModuleByName(<span class="hljs-string">&quot;libnative-lib.so&quot;</span>);  <span class="hljs-comment">//获取so模块</span><br>    <span class="hljs-keyword">var</span> func_sub = nativeLibModule.base.add(offset);  <span class="hljs-comment">//获取sub方法内存地址</span><br>    <span class="hljs-keyword">var</span> arg0 = Memory.alloc(<span class="hljs-number">10</span>);   <span class="hljs-comment">//申请内存</span><br>    ptr(arg0).writeUtf8String(content);  <span class="hljs-comment">//写入自定义内容</span><br>    <span class="hljs-keyword">var</span> sub_method = <span class="hljs-keyword">new</span> NativeFunction(func_sub,<span class="hljs-string">&#x27;pointer&#x27;</span>,[<span class="hljs-string">&#x27;pointer&#x27;</span>]);  <span class="hljs-comment">//新建该方法，pointer为返回值（指针类型），[&#x27;pointer&#x27;]为入参（指针类型）</span><br>    <span class="hljs-keyword">var</span> result = sub_method(arg0)  <span class="hljs-comment">//调用该方法</span><br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;result&quot;</span>,hexdump(result)); <br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="SO导出方法-主动调用"><a href="#SO导出方法-主动调用" class="headerlink" title="SO导出方法-主动调用"></a>SO导出方法-主动调用</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-comment">// char* cncrypt(char* data,  int num)</span><br><span class="hljs-comment">// NativeFunction(address, returnType, argTypes[, abi])</span><br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hookMethod</span>(<span class="hljs-params">str_data, n_num</span>) </span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-keyword">var</span> soName = <span class="hljs-string">&quot;libnative-lib.so&quot;</span>;    <span class="hljs-comment">//要hook的so名</span><br>    <span class="hljs-keyword">var</span> funcName = <span class="hljs-string">&quot;encrypt&quot;</span>;          <span class="hljs-comment">//要hook的函数名</span><br>    <br>    <span class="hljs-comment">//获取函数的地址</span><br>    <span class="hljs-keyword">var</span> n_addr_func = Module.findExportByName(soName , funcName);<br>    <br><br>    <span class="hljs-keyword">var</span> func_c_enc = <span class="hljs-keyword">new</span> NativeFunction(n_addr_func , <span class="hljs-string">&#x27;pointer&#x27;</span>, [<span class="hljs-string">&#x27;pointer&#x27;</span>, <span class="hljs-string">&#x27;int&#x27;</span>]);<br>    <br>    <span class="hljs-comment">//调用frida的api申请空间 填入字符串</span><br>    <span class="hljs-keyword">var</span> str_data_arg = Memory.allocUtf8String(str_data);<br>    <br>     <span class="hljs-comment">//调用so层的c函数</span><br>    <span class="hljs-keyword">var</span> p_str_ret = func_c_enc(str_data_arg, n_num);<br>    <br>    <span class="hljs-comment">//读取字符串  </span><br>    <span class="hljs-keyword">var</span> str_ret = Memory.readCString(p_str_ret);<br>    <span class="hljs-keyword">return</span> str_ret;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>NativeFunction中frida支持的数据类型和abi</p>
<h3 id="SUPPORTED-TYPES"><a href="#SUPPORTED-TYPES" class="headerlink" title="SUPPORTED TYPES"></a>SUPPORTED TYPES</h3><ul>
<li>void</li>
<li>pointer</li>
<li>int</li>
<li>uint</li>
<li>long</li>
<li>ulong</li>
<li>char</li>
<li>uchar</li>
<li>size_t</li>
<li>ssize_t</li>
<li>float</li>
<li>double</li>
<li>int8</li>
<li>uint8</li>
<li>int16</li>
<li>uint16</li>
<li>int32</li>
<li>uint32</li>
<li>int64</li>
<li>uint64</li>
<li>bool</li>
</ul>
<h3 id="SUPPORTED-ABIS"><a href="#SUPPORTED-ABIS" class="headerlink" title="SUPPORTED ABIS"></a>SUPPORTED ABIS</h3><ul>
<li>default</li>
<li>Windows 32-bit:<ul>
<li>sysv</li>
<li>stdcall</li>
<li>thiscall</li>
<li>fastcall</li>
<li>mscdecl</li>
</ul>
</li>
<li>Windows 64-bit:<ul>
<li>win64</li>
</ul>
</li>
<li>UNIX x86:<ul>
<li>sysv</li>
<li>unix64</li>
</ul>
</li>
<li>UNIX ARM:<ul>
<li>sysv</li>
<li>vfp</li>
</ul>
</li>
</ul>
<h2 id="keypatch"><a href="#keypatch" class="headerlink" title="keypatch"></a>keypatch</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dis</span>(<span class="hljs-params">address,number</span>) </span>&#123;<br>    <span class="hljs-built_in">console</span>.log(<span class="hljs-string">&quot;\n&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; number; i++) &#123;<br>        <span class="hljs-keyword">var</span> ins = Instruction.parse(address);<br>        <span class="hljs-built_in">console</span>.error(<span class="hljs-string">&quot;address:&quot;</span> + address + <span class="hljs-string">&quot; dis:&quot;</span> + ins.toString());<br>        address = ins.next;<br>    &#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nopKill</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">//nop kill</span><br>    <span class="hljs-keyword">var</span> libnativemodule = Process.getModuleByName(<span class="hljs-string">&quot;libnative-lib.so&quot;</span>);<br>    <span class="hljs-keyword">var</span> base = libnativemodule.base;<br>    Memory.patchCode(base.add(<span class="hljs-number">0x1564</span>),<span class="hljs-number">4</span>,<span class="hljs-function"><span class="hljs-params">patchaddr</span> =&gt;</span>&#123;<br>       <span class="hljs-keyword">var</span>  arm64Writer =   <span class="hljs-keyword">new</span> Arm64Writer(patchaddr);<br>       arm64Writer.putNop();<br>       arm64Writer.flush();<br>    &#125;)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">editTbnz</span>(<span class="hljs-params"></span>) </span>&#123;<br><br>     <span class="hljs-comment">// Tbnz =&gt; Tbz</span><br>     <span class="hljs-keyword">var</span> libnativemodule = Process.getModuleByName(<span class="hljs-string">&quot;libnative-lib.so&quot;</span>);<br>     <span class="hljs-keyword">var</span> base = libnativemodule.base;<br>     Memory.protect(base.add(<span class="hljs-number">0x150C</span>), <span class="hljs-number">4</span>, <span class="hljs-string">&#x27;rwx&#x27;</span>);<br>     base.add(<span class="hljs-number">0x150C</span>).writeByteArray([<span class="hljs-number">0xD1</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x00</span>, <span class="hljs-number">0x36</span>]);<br><br><br><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">main</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-comment">// hook();</span><br>    <span class="hljs-keyword">var</span> libnativemodule = Process.getModuleByName(<span class="hljs-string">&quot;libnative-lib.so&quot;</span>);<br>    <span class="hljs-keyword">var</span> base = libnativemodule.base;<br>    dis(base.add(<span class="hljs-number">0x150C</span>),<span class="hljs-number">30</span>);<br>    <span class="hljs-comment">//nopKill();</span><br>    <span class="hljs-comment">//editTbnz();</span><br>&#125;<br><br>setImmediate(main);<br></code></pre></td></tr></table></figure>



















<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><ul>
<li><a target="_blank" rel="noopener" href="https://frida.re/">官网</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/frida/frida/releases">github</a></li>
<li><a target="_blank" rel="noopener" href="https://frida.re/docs/javascript-api">javascript-api</a></li>
</ul>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/101401252">frida api介绍</a></li>
<li><a target="_blank" rel="noopener" href="http://www.ioshacker.net/">IOS逆向论坛</a></li>
</ul>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/frida/">frida</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/android/">android</a>
                    
                      <a class="hover-with-bg" href="/tags/frida/">frida</a>
                    
                      <a class="hover-with-bg" href="/tags/hook/">hook</a>
                    
                  </div>
                
              </div>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2021/08/25/frida-gadget/">
                        <span class="hidden-mobile">frida gadget</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.3/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.1/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.8/dist/clipboard.min.js" ></script>



  <script  src="/js/local-search.js" ></script>




















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
